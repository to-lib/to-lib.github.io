---
sidebar_position: 25
title: æ ‘çŠ¶æ•°ç»„ï¼ˆFenwick Treeï¼‰
---

# æ ‘çŠ¶æ•°ç»„ï¼ˆFenwick Treeï¼‰

æ ‘çŠ¶æ•°ç»„ï¼ˆFenwick Tree / Binary Indexed Tree, BITï¼‰ç”¨äºç»´æŠ¤ä¸€ä¸ªæ•°ç»„çš„å‰ç¼€ä¿¡æ¯ï¼Œæ”¯æŒï¼š

- `add(i, delta)`ï¼šå•ç‚¹å¢é‡æ›´æ–°
- `sum(i)`ï¼šæŸ¥è¯¢å‰ç¼€å’Œ `a[1..i]`

å®ƒçš„æ ¸å¿ƒä¼˜åŠ¿æ˜¯æŠŠâ€œå‰ç¼€æŸ¥è¯¢ + å•ç‚¹æ›´æ–°â€éƒ½åšåˆ° `O(log n)`ï¼Œå®ç°ä¹Ÿæ¯”çº¿æ®µæ ‘æ›´è½»é‡ã€‚

## ğŸ“Œ é€‚ç”¨åœºæ™¯

- å•ç‚¹æ›´æ–° + åŒºé—´æ±‚å’Œï¼ˆæˆ–æ±‚æœ€å¤§å€¼ç­‰å¯é€†/å¯ç»„åˆä¿¡æ¯ï¼‰
- é¢‘ç¹ä¿®æ”¹æ•°ç»„å…ƒç´ ï¼ŒåŒæ—¶éœ€è¦å¿«é€Ÿå¾—åˆ°å‰ç¼€/åŒºé—´ç»Ÿè®¡
- å…¸å‹é¢˜ï¼šåŠ¨æ€å‰ç¼€å’Œã€é€†åºå¯¹ã€åŠ¨æ€é¢‘æ¬¡ç»Ÿè®¡ã€ç¦»æ•£åŒ–åè®¡æ•°

## ğŸ§  lowbit ä¸ç»“æ„å«ä¹‰

å®šä¹‰ï¼š

- `lowbit(x) = x & (-x)`ï¼šå–å‡º `x` çš„äºŒè¿›åˆ¶æœ€ä½ä½çš„ 1 æ‰€ä»£è¡¨çš„å€¼ã€‚

æ ‘çŠ¶æ•°ç»„ç”¨ 1-based ä¸‹æ ‡ï¼Œ`tree[i]` ç®¡ç†ä¸€ä¸ªé•¿åº¦ä¸º `lowbit(i)` çš„åŒºé—´ï¼š

- `tree[i]` è¦†ç›– `(i - lowbit(i) + 1 .. i)`

## âœ… Java 8 æ¨¡æ¿ï¼ˆå‰ç¼€å’Œï¼‰

```java
class FenwickTree {
    private final int n;
    private final long[] tree;

    public FenwickTree(int n) {
        this.n = n;
        this.tree = new long[n + 1];
    }

    private int lowbit(int x) {
        return x & -x;
    }

    // å•ç‚¹åŠ ï¼ša[idx] += delta
    public void add(int idx, long delta) {
        for (int i = idx; i <= n; i += lowbit(i)) {
            tree[i] += delta;
        }
    }

    // å‰ç¼€å’Œï¼šsum(a[1..idx])
    public long sum(int idx) {
        long res = 0;
        for (int i = idx; i > 0; i -= lowbit(i)) {
            res += tree[i];
        }
        return res;
    }

    // åŒºé—´å’Œï¼šsum(a[l..r])
    public long rangeSum(int l, int r) {
        if (l > r) return 0;
        return sum(r) - sum(l - 1);
    }
}
```

## ğŸ¯ å¸¸è§æ‰©å±•

### 1) åŠ¨æ€æ•°ç»„åˆå§‹åŒ–

å¦‚æœä½ æœ‰åˆå§‹æ•°ç»„ `a[1..n]`ï¼Œå¯ä»¥é€ä¸ª `add(i, a[i])` æ„å»ºã€‚

### 2) é€†åºå¯¹ / ç»Ÿè®¡â€œå°äºç­‰äº x çš„ä¸ªæ•°â€

å¸¸è§å¥—è·¯ï¼š

- å¯¹å€¼åŸŸåšç¦»æ•£åŒ–ï¼ˆæŠŠå€¼æ˜ å°„åˆ° `1..m`ï¼‰
- ä»å·¦åˆ°å³æˆ–ä»å³åˆ°å·¦æ‰«æ
- ç”¨ BIT ç»´æŠ¤å·²å‡ºç°å…ƒç´ çš„é¢‘æ¬¡

ç¤ºä¾‹ï¼ˆä»å·¦åˆ°å³ç»Ÿè®¡â€œå‰é¢æœ‰å¤šå°‘ä¸ªæ¯”å½“å‰å¤§â€ï¼‰ï¼š

- `seen = i - 1`
- `le = bit.sum(rank)`ï¼ˆ<= å½“å‰çš„æ•°é‡ï¼‰
- `greater = seen - le`

### 3) åŒºé—´åŠ  + å•ç‚¹æŸ¥ï¼ˆå·®åˆ† BITï¼‰

å¦‚æœä½ è¦æ”¯æŒï¼š

- åŒºé—´ `[l, r]` å…¨éƒ¨åŠ  `delta`
- æŸ¥è¯¢æŸä¸ªç‚¹ `a[i]`

å¯ä»¥ç»´æŠ¤å·®åˆ†æ•°ç»„ `d` çš„ BITï¼š

- `rangeAdd(l, r, delta)`ï¼š`add(l, delta)`, `add(r+1, -delta)`
- `get(i)`ï¼š`sum(i)`

## âœ… å¤æ‚åº¦

- `add`ï¼š`O(log n)`
- `sum` / `rangeSum`ï¼š`O(log n)`
- ç©ºé—´ï¼š`O(n)`

## ğŸ’¡ å¸¸è§å‘

- ä¸‹æ ‡ä» 1 å¼€å§‹ï¼šå¦‚æœä½ çš„åŸæ•°ç»„æ˜¯ 0-basedï¼Œéœ€è¦æ•´ä½“ `+1` æ˜ å°„ã€‚
- ç”¨ `int` å¯èƒ½æº¢å‡ºï¼šæ±‚å’Œå»ºè®®ç”¨ `long`ã€‚
- åªæœ‰â€œå‰ç¼€å¯æ‹†åˆ†â€çš„ä¿¡æ¯é€‚åˆ BITï¼šæ¯”å¦‚å’Œã€é¢‘æ¬¡ã€å¼‚æˆ–ç­‰ï¼›å¤æ‚åŒºé—´ä¿¡æ¯æ›´é€‚åˆçº¿æ®µæ ‘ã€‚
