"use strict";(globalThis.webpackChunkto_lib_github_io=globalThis.webpackChunkto_lib_github_io||[]).push([[9967],{48885:(n,e,l)=>{l.d(e,{R:()=>a,x:()=>t});var r=l(99378);const s={},i=r.createContext(s);function a(n){const e=r.useContext(i);return r.useMemo(function(){return"function"==typeof n?n(e):{...e,...n}},[e,n])}function t(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(s):n.components||s:a(n.components),r.createElement(i.Provider,{value:e},n.children)}},87365:(n,e,l)=>{l.r(e),l.d(e,{assets:()=>c,contentTitle:()=>t,default:()=>u,frontMatter:()=>a,metadata:()=>r,toc:()=>d});const r=JSON.parse('{"id":"rust/macros","title":"\u5b8f\u7f16\u7a0b","description":"\u5b8f\u662f Rust \u7684\u5143\u7f16\u7a0b\u5de5\u5177,\u5141\u8bb8\u4f60\u7f16\u5199\u751f\u6210\u4ee3\u7801\u7684\u4ee3\u7801\u3002Rust \u6709\u4e24\u79cd\u5b8f:\u58f0\u660e\u5b8f\u548c\u8fc7\u7a0b\u5b8f\u3002","source":"@site/docs/rust/macros.md","sourceDirName":"rust","slug":"/rust/macros","permalink":"/docs/rust/macros","draft":false,"unlisted":false,"editUrl":"https://github.com/to-lib/to-lib.github.io/tree/main/docs/rust/macros.md","tags":[],"version":"current","sidebarPosition":12,"frontMatter":{"sidebar_position":12,"title":"\u5b8f\u7f16\u7a0b"},"sidebar":"rust","previous":{"title":"\u6d4b\u8bd5","permalink":"/docs/rust/testing"},"next":{"title":"Rust \u6700\u4f73\u5b9e\u8df5","permalink":"/docs/rust/best-practices"}}');var s=l(22714),i=l(48885);const a={sidebar_position:12,title:"\u5b8f\u7f16\u7a0b"},t="\u5b8f\u7f16\u7a0b",c={},d=[{value:"\u5b8f\u6982\u8ff0",id:"\u5b8f\u6982\u8ff0",level:2},{value:"\u5b8f vs \u51fd\u6570",id:"\u5b8f-vs-\u51fd\u6570",level:3},{value:"\u5b8f\u7684\u4f18\u52bf",id:"\u5b8f\u7684\u4f18\u52bf",level:3},{value:"\u58f0\u660e\u5b8f macro_rules",id:"\u58f0\u660e\u5b8f-macro_rules",level:2},{value:"\u57fa\u7840\u8bed\u6cd5",id:"\u57fa\u7840\u8bed\u6cd5",level:3},{value:"\u5e26\u53c2\u6570\u7684\u5b8f",id:"\u5e26\u53c2\u6570\u7684\u5b8f",level:3},{value:"\u6a21\u5f0f\u5339\u914d",id:"\u6a21\u5f0f\u5339\u914d",level:3},{value:"\u6307\u793a\u7b26",id:"\u6307\u793a\u7b26",level:3},{value:"\u91cd\u590d",id:"\u91cd\u590d",level:3},{value:"\u591a\u4e2a\u5206\u652f",id:"\u591a\u4e2a\u5206\u652f",level:3},{value:"\u5b9e\u7528\u58f0\u660e\u5b8f\u793a\u4f8b",id:"\u5b9e\u7528\u58f0\u660e\u5b8f\u793a\u4f8b",level:2},{value:"HashMap \u521d\u59cb\u5316\u5b8f",id:"hashmap-\u521d\u59cb\u5316\u5b8f",level:3},{value:"\u8ba1\u7b97\u6700\u5c0f\u503c\u5b8f",id:"\u8ba1\u7b97\u6700\u5c0f\u503c\u5b8f",level:3},{value:"\u6d4b\u8bd5\u5b8f",id:"\u6d4b\u8bd5\u5b8f",level:3},{value:"\u8fc7\u7a0b\u5b8f",id:"\u8fc7\u7a0b\u5b8f",level:2},{value:"\u521b\u5efa\u8fc7\u7a0b\u5b8f\u9879\u76ee",id:"\u521b\u5efa\u8fc7\u7a0b\u5b8f\u9879\u76ee",level:3},{value:"\u6d3e\u751f\u5b8f",id:"\u6d3e\u751f\u5b8f",level:2},{value:"\u5b9e\u73b0 derive \u5b8f",id:"\u5b9e\u73b0-derive-\u5b8f",level:3},{value:"\u4f7f\u7528\u6d3e\u751f\u5b8f",id:"\u4f7f\u7528\u6d3e\u751f\u5b8f",level:3},{value:"Builder \u6a21\u5f0f\u6d3e\u751f\u5b8f",id:"builder-\u6a21\u5f0f\u6d3e\u751f\u5b8f",level:3},{value:"\u5c5e\u6027\u5b8f",id:"\u5c5e\u6027\u5b8f",level:2},{value:"\u5b9a\u4e49\u5c5e\u6027\u5b8f",id:"\u5b9a\u4e49\u5c5e\u6027\u5b8f",level:3},{value:"\u4f7f\u7528\u5c5e\u6027\u5b8f",id:"\u4f7f\u7528\u5c5e\u6027\u5b8f",level:3},{value:"\u51fd\u6570\u5f0f\u8fc7\u7a0b\u5b8f",id:"\u51fd\u6570\u5f0f\u8fc7\u7a0b\u5b8f",level:2},{value:"\u5b9a\u4e49\u51fd\u6570\u5f0f\u5b8f",id:"\u5b9a\u4e49\u51fd\u6570\u5f0f\u5b8f",level:3},{value:"\u4f7f\u7528\u51fd\u6570\u5f0f\u5b8f",id:"\u4f7f\u7528\u51fd\u6570\u5f0f\u5b8f",level:3},{value:"\u5b8f\u8c03\u8bd5",id:"\u5b8f\u8c03\u8bd5",level:2},{value:"\u4f7f\u7528 cargo expand",id:"\u4f7f\u7528-cargo-expand",level:3},{value:"\u4f7f\u7528 trace_macros",id:"\u4f7f\u7528-trace_macros",level:3},{value:"\u4f7f\u7528 log_syntax",id:"\u4f7f\u7528-log_syntax",level:3},{value:"\u5e38\u7528\u5b8f\u793a\u4f8b",id:"\u5e38\u7528\u5b8f\u793a\u4f8b",level:2},{value:"\u679a\u4e3e\u904d\u5386\u5b8f",id:"\u679a\u4e3e\u904d\u5386\u5b8f",level:3},{value:"\u9519\u8bef\u5904\u7406\u5b8f",id:"\u9519\u8bef\u5904\u7406\u5b8f",level:3},{value:"\u6700\u4f73\u5b9e\u8df5",id:"\u6700\u4f73\u5b9e\u8df5",level:2},{value:"1. \u4fdd\u6301\u5b8f\u7b80\u5355",id:"1-\u4fdd\u6301\u5b8f\u7b80\u5355",level:3},{value:"2. \u63d0\u4f9b\u6e05\u6670\u7684\u9519\u8bef\u6d88\u606f",id:"2-\u63d0\u4f9b\u6e05\u6670\u7684\u9519\u8bef\u6d88\u606f",level:3},{value:"3. \u6587\u6863\u5316\u5b8f",id:"3-\u6587\u6863\u5316\u5b8f",level:3},{value:"4. \u4f7f\u7528 <code>#[macro_export]</code>",id:"4-\u4f7f\u7528-macro_export",level:3},{value:"\u603b\u7ed3",id:"\u603b\u7ed3",level:2}];function o(n){const e={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...n.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(e.header,{children:(0,s.jsx)(e.h1,{id:"\u5b8f\u7f16\u7a0b",children:"\u5b8f\u7f16\u7a0b"})}),"\n",(0,s.jsx)(e.p,{children:"\u5b8f\u662f Rust \u7684\u5143\u7f16\u7a0b\u5de5\u5177,\u5141\u8bb8\u4f60\u7f16\u5199\u751f\u6210\u4ee3\u7801\u7684\u4ee3\u7801\u3002Rust \u6709\u4e24\u79cd\u5b8f:\u58f0\u660e\u5b8f\u548c\u8fc7\u7a0b\u5b8f\u3002"}),"\n",(0,s.jsx)(e.h2,{id:"\u5b8f\u6982\u8ff0",children:"\u5b8f\u6982\u8ff0"}),"\n",(0,s.jsx)(e.h3,{id:"\u5b8f-vs-\u51fd\u6570",children:"\u5b8f vs \u51fd\u6570"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-rust",children:"// \u51fd\u6570:\u8fd0\u884c\u65f6\u8c03\u7528\nfn add(a: i32, b: i32) -> i32 {\n    a + b\n}\n\n// \u5b8f:\u7f16\u8bd1\u65f6\u5c55\u5f00\nmacro_rules! add_macro {\n    ($a:expr, $b:expr) => {\n        $a + $b\n    };\n}\n\nfn main() {\n    let result1 = add(1, 2);\n    let result2 = add_macro!(1, 2);\n}\n"})}),"\n",(0,s.jsx)(e.h3,{id:"\u5b8f\u7684\u4f18\u52bf",children:"\u5b8f\u7684\u4f18\u52bf"}),"\n",(0,s.jsxs)(e.ol,{children:["\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.strong,{children:"\u53ef\u53d8\u53c2\u6570"})," - \u63a5\u53d7\u4efb\u610f\u6570\u91cf\u7684\u53c2\u6570"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.strong,{children:"\u7f16\u8bd1\u65f6\u5c55\u5f00"})," - \u5728\u7f16\u8bd1\u671f\u751f\u6210\u4ee3\u7801"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.strong,{children:"\u5143\u7f16\u7a0b"})," - \u51cf\u5c11\u6837\u677f\u4ee3\u7801"]}),"\n"]}),"\n",(0,s.jsx)(e.h2,{id:"\u58f0\u660e\u5b8f-macro_rules",children:"\u58f0\u660e\u5b8f macro_rules"}),"\n",(0,s.jsx)(e.h3,{id:"\u57fa\u7840\u8bed\u6cd5",children:"\u57fa\u7840\u8bed\u6cd5"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-rust",children:'macro_rules! say_hello {\n    () => {\n        println!("Hello!");\n    };\n}\n\nfn main() {\n    say_hello!();\n}\n'})}),"\n",(0,s.jsx)(e.h3,{id:"\u5e26\u53c2\u6570\u7684\u5b8f",children:"\u5e26\u53c2\u6570\u7684\u5b8f"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-rust",children:'macro_rules! create_function {\n    ($func_name:ident) => {\n        fn $func_name() {\n            println!("\u51fd\u6570 {:?} \u88ab\u8c03\u7528", stringify!($func_name));\n        }\n    };\n}\n\ncreate_function!(foo);\ncreate_function!(bar);\n\nfn main() {\n    foo();\n    bar();\n}\n'})}),"\n",(0,s.jsx)(e.h3,{id:"\u6a21\u5f0f\u5339\u914d",children:"\u6a21\u5f0f\u5339\u914d"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-rust",children:'macro_rules! calculate {\n    (eval $e:expr) => {\n        {\n            let val = $e;\n            println!("{} = {}", stringify!($e), val);\n        }\n    };\n}\n\nfn main() {\n    calculate!(eval 1 + 2);\n    calculate!(eval (1 + 2) * 3);\n}\n'})}),"\n",(0,s.jsx)(e.h3,{id:"\u6307\u793a\u7b26",children:"\u6307\u793a\u7b26"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-rust",children:'macro_rules! types {\n    // expr: \u8868\u8fbe\u5f0f\n    ($e:expr) => { println!("expression: {}", $e); };\n}\n\nmacro_rules! items {\n    // ident: \u6807\u8bc6\u7b26\n    ($i:ident) => { let $i = 42; };\n}\n\nmacro_rules! patterns {\n    // ty: \u7c7b\u578b\n    ($t:ty) => {\n        fn type_name() -> &\'static str {\n            stringify!($t)\n        }\n    };\n}\n'})}),"\n",(0,s.jsx)(e.p,{children:"\u5e38\u7528\u6307\u793a\u7b26:"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.code,{children:"expr"})," - \u8868\u8fbe\u5f0f"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.code,{children:"ident"})," - \u6807\u8bc6\u7b26"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.code,{children:"ty"})," - \u7c7b\u578b"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.code,{children:"pat"})," - \u6a21\u5f0f"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.code,{children:"stmt"})," - \u8bed\u53e5"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.code,{children:"block"})," - \u4ee3\u7801\u5757"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.code,{children:"item"})," - \u9879(\u51fd\u6570\u3001\u7ed3\u6784\u4f53\u7b49)"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.code,{children:"literal"})," - \u5b57\u9762\u91cf"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.code,{children:"tt"})," - token tree"]}),"\n"]}),"\n",(0,s.jsx)(e.h3,{id:"\u91cd\u590d",children:"\u91cd\u590d"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-rust",children:'macro_rules! vec_of_strings {\n    ($($x:expr),*) => {\n        {\n            let mut temp_vec = Vec::new();\n            $(\n                temp_vec.push($x.to_string());\n            )*\n            temp_vec\n        }\n    };\n}\n\nfn main() {\n    let v = vec_of_strings!("a", "b", "c");\n    println!("{:?}", v);\n}\n'})}),"\n",(0,s.jsx)(e.h3,{id:"\u591a\u4e2a\u5206\u652f",children:"\u591a\u4e2a\u5206\u652f"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-rust",children:'macro_rules! test {\n    // \u65e0\u53c2\u6570\n    () => {\n        println!("\u65e0\u53c2\u6570");\n    };\n    \n    // \u5355\u4e2a\u53c2\u6570\n    ($x:expr) => {\n        println!("\u5355\u4e2a\u53c2\u6570: {}", $x);\n    };\n    \n    // \u591a\u4e2a\u53c2\u6570\n    ($x:expr, $y:expr) => {\n        println!("\u4e24\u4e2a\u53c2\u6570: {}, {}", $x, $y);\n    };\n}\n\nfn main() {\n    test!();\n    test!(1);\n    test!(1, 2);\n}\n'})}),"\n",(0,s.jsx)(e.h2,{id:"\u5b9e\u7528\u58f0\u660e\u5b8f\u793a\u4f8b",children:"\u5b9e\u7528\u58f0\u660e\u5b8f\u793a\u4f8b"}),"\n",(0,s.jsx)(e.h3,{id:"hashmap-\u521d\u59cb\u5316\u5b8f",children:"HashMap \u521d\u59cb\u5316\u5b8f"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-rust",children:'macro_rules! hashmap {\n    ($($key:expr => $value:expr),* $(,)?) => {\n        {\n            let mut map = ::std::collections::HashMap::new();\n            $(\n                map.insert($key, $value);\n            )*\n            map\n        }\n    };\n}\n\nfn main() {\n    let map = hashmap! {\n        "key1" => "value1",\n        "key2" => "value2",\n    };\n    println!("{:?}", map);\n}\n'})}),"\n",(0,s.jsx)(e.h3,{id:"\u8ba1\u7b97\u6700\u5c0f\u503c\u5b8f",children:"\u8ba1\u7b97\u6700\u5c0f\u503c\u5b8f"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-rust",children:'macro_rules! min {\n    ($x:expr) => ($x);\n    ($x:expr, $($y:expr),+) => {\n        std::cmp::min($x, min!($($y),+))\n    };\n}\n\nfn main() {\n    println!("{}", min!(1));\n    println!("{}", min!(1, 2));\n    println!("{}", min!(5, 2 * 3, 4));\n}\n'})}),"\n",(0,s.jsx)(e.h3,{id:"\u6d4b\u8bd5\u5b8f",children:"\u6d4b\u8bd5\u5b8f"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-rust",children:"macro_rules! test_case {\n    ($name:ident, $input:expr, $expected:expr) => {\n        #[test]\n        fn $name() {\n            assert_eq!(my_function($input), $expected);\n        }\n    };\n}\n\nfn my_function(x: i32) -> i32 {\n    x * 2\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    \n    test_case!(test_zero, 0, 0);\n    test_case!(test_one, 1, 2);\n    test_case!(test_five, 5, 10);\n}\n"})}),"\n",(0,s.jsx)(e.h2,{id:"\u8fc7\u7a0b\u5b8f",children:"\u8fc7\u7a0b\u5b8f"}),"\n",(0,s.jsx)(e.p,{children:"\u8fc7\u7a0b\u5b8f\u6709\u4e09\u79cd\u7c7b\u578b:"}),"\n",(0,s.jsxs)(e.ol,{children:["\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.strong,{children:"\u6d3e\u751f\u5b8f(Derive)"})," - ",(0,s.jsx)(e.code,{children:"#[derive(MyMacro)]"})]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.strong,{children:"\u5c5e\u6027\u5b8f"})," - ",(0,s.jsx)(e.code,{children:"#[my_attribute]"})]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.strong,{children:"\u51fd\u6570\u5f0f\u8fc7\u7a0b\u5b8f"})," - ",(0,s.jsx)(e.code,{children:"my_macro!()"})]}),"\n"]}),"\n",(0,s.jsx)(e.h3,{id:"\u521b\u5efa\u8fc7\u7a0b\u5b8f\u9879\u76ee",children:"\u521b\u5efa\u8fc7\u7a0b\u5b8f\u9879\u76ee"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-bash",children:"cargo new my_macro --lib\n"})}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-toml",children:'# Cargo.toml\n[lib]\nproc-macro = true\n\n[dependencies]\nsyn = "2.0"\nquote = "1.0"\nproc-macro2 = "1.0"\n'})}),"\n",(0,s.jsx)(e.h2,{id:"\u6d3e\u751f\u5b8f",children:"\u6d3e\u751f\u5b8f"}),"\n",(0,s.jsx)(e.h3,{id:"\u5b9e\u73b0-derive-\u5b8f",children:"\u5b9e\u73b0 derive \u5b8f"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-rust",children:'// my_macro/src/lib.rs\nuse proc_macro::TokenStream;\nuse quote::quote;\nuse syn;\n\n#[proc_macro_derive(HelloMacro)]\npub fn hello_macro_derive(input: TokenStream) -> TokenStream {\n    let ast = syn::parse(input).unwrap();\n    impl_hello_macro(&ast)\n}\n\nfn impl_hello_macro(ast: &syn::DeriveInput) -> TokenStream {\n    let name = &ast.ident;\n    let gen = quote! {\n        impl HelloMacro for #name {\n            fn hello_macro() {\n                println!("Hello, Macro! My name is {}!", stringify!(#name));\n            }\n        }\n    };\n    gen.into()\n}\n'})}),"\n",(0,s.jsx)(e.h3,{id:"\u4f7f\u7528\u6d3e\u751f\u5b8f",children:"\u4f7f\u7528\u6d3e\u751f\u5b8f"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-rust",children:"// \u4f7f\u7528\u5b8f\u7684\u9879\u76ee\nuse my_macro::HelloMacro;\n\ntrait HelloMacro {\n    fn hello_macro();\n}\n\n#[derive(HelloMacro)]\nstruct Pancakes;\n\nfn main() {\n    Pancakes::hello_macro();\n}\n"})}),"\n",(0,s.jsx)(e.h3,{id:"builder-\u6a21\u5f0f\u6d3e\u751f\u5b8f",children:"Builder \u6a21\u5f0f\u6d3e\u751f\u5b8f"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-rust",children:'use proc_macro::TokenStream;\nuse quote::quote;\nuse syn::{parse_macro_input, DeriveInput};\n\n#[proc_macro_derive(Builder)]\npub fn derive_builder(input: TokenStream) -> TokenStream {\n    let input = parse_macro_input!(input as DeriveInput);\n    let name = &input.ident;\n    let builder_name = format!("{}Builder", name);\n    let builder_ident = syn::Ident::new(&builder_name, name.span());\n    \n    let fields = if let syn::Data::Struct(syn::DataStruct {\n        fields: syn::Fields::Named(syn::FieldsNamed { ref named, .. }),\n        ..\n    }) = input.data\n    {\n        named\n    } else {\n        unimplemented!();\n    };\n    \n    let builder_fields = fields.iter().map(|f| {\n        let name = &f.ident;\n        let ty = &f.ty;\n        quote! { #name: Option<#ty> }\n    });\n    \n    let methods = fields.iter().map(|f| {\n        let name = &f.ident;\n        let ty = &f.ty;\n        quote! {\n            pub fn #name(&mut self, #name: #ty) -> &mut Self {\n                self.#name = Some(#name);\n                self\n            }\n        }\n    });\n    \n    let build_fields = fields.iter().map(|f| {\n        let name = &f.ident;\n        quote! {\n            #name: self.#name.take().unwrap()\n        }\n    });\n    \n    let expanded = quote! {\n        pub struct #builder_ident {\n            #(#builder_fields,)*\n        }\n        \n        impl #builder_ident {\n            #(#methods)*\n            \n            pub fn build(&mut self) -> #name {\n                #name {\n                    #(#build_fields,)*\n                }\n            }\n        }\n        \n        impl #name {\n            pub fn builder() -> #builder_ident {\n                #builder_ident {\n                    #(#name: None,)*\n                }\n            }\n        }\n    };\n    \n    TokenStream::from(expanded)\n}\n'})}),"\n",(0,s.jsx)(e.h2,{id:"\u5c5e\u6027\u5b8f",children:"\u5c5e\u6027\u5b8f"}),"\n",(0,s.jsx)(e.h3,{id:"\u5b9a\u4e49\u5c5e\u6027\u5b8f",children:"\u5b9a\u4e49\u5c5e\u6027\u5b8f"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-rust",children:"use proc_macro::TokenStream;\nuse quote::quote;\nuse syn::{parse_macro_input, ItemFn};\n\n#[proc_macro_attribute]\npub fn route(attr: TokenStream, item: TokenStream) -> TokenStream {\n    let input_fn = parse_macro_input!(item as ItemFn);\n    let fn_name = &input_fn.sig.ident;\n    let path = attr.to_string();\n    \n    let expanded = quote! {\n        #input_fn\n        \n        inventory::submit! {\n            Route {\n                path: #path,\n                handler: #fn_name,\n            }\n        }\n    };\n    \n    TokenStream::from(expanded)\n}\n"})}),"\n",(0,s.jsx)(e.h3,{id:"\u4f7f\u7528\u5c5e\u6027\u5b8f",children:"\u4f7f\u7528\u5c5e\u6027\u5b8f"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-rust",children:'#[route("/users")]\nfn get_users() {\n    println!("Getting users");\n}\n\n#[route("/posts")]\nfn get_posts() {\n    println!("Getting posts");\n}\n'})}),"\n",(0,s.jsx)(e.h2,{id:"\u51fd\u6570\u5f0f\u8fc7\u7a0b\u5b8f",children:"\u51fd\u6570\u5f0f\u8fc7\u7a0b\u5b8f"}),"\n",(0,s.jsx)(e.h3,{id:"\u5b9a\u4e49\u51fd\u6570\u5f0f\u5b8f",children:"\u5b9a\u4e49\u51fd\u6570\u5f0f\u5b8f"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-rust",children:'use proc_macro::TokenStream;\n\n#[proc_macro]\npub fn sql(input: TokenStream) -> TokenStream {\n    let sql_query = input.to_string();\n    \n    // \u5904\u7406 SQL \u67e5\u8be2\n    let output = format!("execute_query(\\"{}\\")", sql_query);\n    \n    output.parse().unwrap()\n}\n'})}),"\n",(0,s.jsx)(e.h3,{id:"\u4f7f\u7528\u51fd\u6570\u5f0f\u5b8f",children:"\u4f7f\u7528\u51fd\u6570\u5f0f\u5b8f"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-rust",children:"use my_macro::sql;\n\nfn main() {\n    sql!(SELECT * FROM users WHERE id = 1);\n}\n"})}),"\n",(0,s.jsx)(e.h2,{id:"\u5b8f\u8c03\u8bd5",children:"\u5b8f\u8c03\u8bd5"}),"\n",(0,s.jsx)(e.h3,{id:"\u4f7f\u7528-cargo-expand",children:"\u4f7f\u7528 cargo expand"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-bash",children:"# \u5b89\u88c5\ncargo install cargo-expand\n\n# \u5c55\u5f00\u5b8f\ncargo expand\n\n# \u5c55\u5f00\u7279\u5b9a\u6a21\u5757\ncargo expand my_module\n"})}),"\n",(0,s.jsx)(e.h3,{id:"\u4f7f\u7528-trace_macros",children:"\u4f7f\u7528 trace_macros"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-rust",children:"#![feature(trace_macros)]\n\nfn main() {\n    trace_macros!(true);\n    let v = vec![1, 2, 3];\n    trace_macros!(false);\n}\n"})}),"\n",(0,s.jsx)(e.h3,{id:"\u4f7f\u7528-log_syntax",children:"\u4f7f\u7528 log_syntax"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-rust",children:"#![feature(log_syntax)]\n\nmacro_rules! example {\n    () => {\n        log_syntax!(Hello, world!);\n    };\n}\n\nfn main() {\n    example!();\n}\n"})}),"\n",(0,s.jsx)(e.h2,{id:"\u5e38\u7528\u5b8f\u793a\u4f8b",children:"\u5e38\u7528\u5b8f\u793a\u4f8b"}),"\n",(0,s.jsx)(e.h3,{id:"\u679a\u4e3e\u904d\u5386\u5b8f",children:"\u679a\u4e3e\u904d\u5386\u5b8f"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-rust",children:'macro_rules! enum_iterator {\n    ($name:ident { $($variant:ident),* $(,)? }) => {\n        #[derive(Debug, Clone, Copy, PartialEq, Eq)]\n        enum $name {\n            $($variant),*\n        }\n        \n        impl $name {\n            fn variants() -> &\'static [$name] {\n                &[$($name::$variant),*]\n            }\n        }\n    };\n}\n\nenum_iterator!(Color {\n    Red,\n    Green,\n    Blue,\n});\n\nfn main() {\n    for color in Color::variants() {\n        println!("{:?}", color);\n    }\n}\n'})}),"\n",(0,s.jsx)(e.h3,{id:"\u9519\u8bef\u5904\u7406\u5b8f",children:"\u9519\u8bef\u5904\u7406\u5b8f"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-rust",children:"macro_rules! try_option {\n    ($expr:expr) => {\n        match $expr {\n            Some(val) => val,\n            None => return None,\n        }\n    };\n}\n\nfn divide(a: i32, b: i32) -> Option<i32> {\n    if b == 0 {\n        return None;\n    }\n    Some(a / b)\n}\n\nfn calculate() -> Option<i32> {\n    let x = try_option!(divide(10, 2));\n    let y = try_option!(divide(20, 4));\n    Some(x + y)\n}\n"})}),"\n",(0,s.jsx)(e.h2,{id:"\u6700\u4f73\u5b9e\u8df5",children:"\u6700\u4f73\u5b9e\u8df5"}),"\n",(0,s.jsx)(e.h3,{id:"1-\u4fdd\u6301\u5b8f\u7b80\u5355",children:"1. \u4fdd\u6301\u5b8f\u7b80\u5355"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-rust",children:"// \u597d:\u7b80\u5355\u660e\u4e86\nmacro_rules! double {\n    ($x:expr) => {\n        $x * 2\n    };\n}\n\n// \u907f\u514d:\u8fc7\u4e8e\u590d\u6742\n// macro_rules! complex {\n//     (\u5f88\u591a\u590d\u6742\u7684\u6a21\u5f0f\u5339\u914d...)\n// }\n"})}),"\n",(0,s.jsx)(e.h3,{id:"2-\u63d0\u4f9b\u6e05\u6670\u7684\u9519\u8bef\u6d88\u606f",children:"2. \u63d0\u4f9b\u6e05\u6670\u7684\u9519\u8bef\u6d88\u606f"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-rust",children:'macro_rules! check_range {\n    ($val:expr, $min:expr, $max:expr) => {\n        {\n            let v = $val;\n            if v < $min || v > $max {\n                panic!(\n                    "\u503c {} \u8d85\u51fa\u8303\u56f4 [{}, {}]",\n                    v, $min, $max\n                );\n            }\n            v\n        }\n    };\n}\n'})}),"\n",(0,s.jsx)(e.h3,{id:"3-\u6587\u6863\u5316\u5b8f",children:"3. \u6587\u6863\u5316\u5b8f"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-rust",children:'/// \u521b\u5efa\u4e00\u4e2a HashMap \u5e76\u521d\u59cb\u5316\u952e\u503c\u5bf9\n///\n/// # Examples\n///\n/// ```\n/// let map = hashmap! {\n///     "key1" => 1,\n///     "key2" => 2,\n/// };\n/// ```\n#[macro_export]\nmacro_rules! hashmap {\n    // \u5b9e\u73b0...\n}\n'})}),"\n",(0,s.jsxs)(e.h3,{id:"4-\u4f7f\u7528-macro_export",children:["4. \u4f7f\u7528 ",(0,s.jsx)(e.code,{children:"#[macro_export]"})]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-rust",children:'#[macro_export]\nmacro_rules! public_macro {\n    () => {\n        println!("This macro is public");\n    };\n}\n'})}),"\n",(0,s.jsx)(e.h2,{id:"\u603b\u7ed3",children:"\u603b\u7ed3"}),"\n",(0,s.jsx)(e.p,{children:"\u672c\u6587\u8be6\u7ec6\u4ecb\u7ecd\u4e86 Rust \u7684\u5b8f\u7f16\u7a0b:"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"\u2705 \u58f0\u660e\u5b8f macro_rules!"}),"\n",(0,s.jsx)(e.li,{children:"\u2705 \u8fc7\u7a0b\u5b8f(\u6d3e\u751f\u3001\u5c5e\u6027\u3001\u51fd\u6570\u5f0f)"}),"\n",(0,s.jsx)(e.li,{children:"\u2705 \u5b8f\u6307\u793a\u7b26\u548c\u91cd\u590d"}),"\n",(0,s.jsx)(e.li,{children:"\u2705 \u5b9e\u7528\u5b8f\u793a\u4f8b"}),"\n",(0,s.jsx)(e.li,{children:"\u2705 \u5b8f\u8c03\u8bd5\u6280\u5de7"}),"\n",(0,s.jsx)(e.li,{children:"\u2705 \u6700\u4f73\u5b9e\u8df5"}),"\n"]}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"\u5173\u952e\u8981\u70b9:"})}),"\n",(0,s.jsxs)(e.ol,{children:["\n",(0,s.jsx)(e.li,{children:"\u5b8f\u5728\u7f16\u8bd1\u65f6\u5c55\u5f00,\u51cf\u5c11\u8fd0\u884c\u65f6\u5f00\u9500"}),"\n",(0,s.jsx)(e.li,{children:"\u58f0\u660e\u5b8f\u7528\u4e8e\u7b80\u5355\u7684\u4ee3\u7801\u751f\u6210"}),"\n",(0,s.jsx)(e.li,{children:"\u8fc7\u7a0b\u5b8f\u63d0\u4f9b\u66f4\u5f3a\u5927\u7684\u5143\u7f16\u7a0b\u80fd\u529b"}),"\n",(0,s.jsx)(e.li,{children:"\u4f7f\u7528 cargo expand \u8c03\u8bd5\u5b8f"}),"\n",(0,s.jsx)(e.li,{children:"\u4fdd\u6301\u5b8f\u7b80\u5355,\u63d0\u4f9b\u6e05\u6670\u7684\u6587\u6863"}),"\n"]}),"\n",(0,s.jsxs)(e.p,{children:["\u638c\u63e1\u5b8f\u7f16\u7a0b\u540e,\u7ee7\u7eed\u5b66\u4e60 ",(0,s.jsx)(e.a,{href:"./unsafe-rust",children:"\u4e0d\u5b89\u5168 Rust"})," \u6216 ",(0,s.jsx)(e.a,{href:"./best-practices",children:"\u6700\u4f73\u5b9e\u8df5"}),"\u3002"]})]})}function u(n={}){const{wrapper:e}={...(0,i.R)(),...n.components};return e?(0,s.jsx)(e,{...n,children:(0,s.jsx)(o,{...n})}):o(n)}}}]);