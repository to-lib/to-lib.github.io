"use strict";(globalThis.webpackChunkto_lib_github_io=globalThis.webpackChunkto_lib_github_io||[]).push([[81632],{48885:(n,e,t)=>{t.d(e,{R:()=>r,x:()=>d});var l=t(99378);const i={},s=l.createContext(i);function r(n){const e=l.useContext(s);return l.useMemo(function(){return"function"==typeof n?n(e):{...e,...n}},[e,n])}function d(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(i):n.components||i:r(n.components),l.createElement(s.Provider,{value:e},n.children)}},57969:(n,e,t)=>{t.r(e),t.d(e,{assets:()=>a,contentTitle:()=>d,default:()=>p,frontMatter:()=>r,metadata:()=>l,toc:()=>c});const l=JSON.parse('{"id":"cpp/memory-management","title":"\u5185\u5b58\u7ba1\u7406","description":"C++ \u63d0\u4f9b\u4e86\u5f3a\u5927\u7684\u5185\u5b58\u7ba1\u7406\u673a\u5236\uff0c\u4ece\u624b\u52a8 new/delete \u5230\u73b0\u4ee3\u667a\u80fd\u6307\u9488\u3002","source":"@site/docs/cpp/memory-management.md","sourceDirName":"cpp","slug":"/cpp/memory-management","permalink":"/docs/cpp/memory-management","draft":false,"unlisted":false,"editUrl":"https://github.com/to-lib/to-lib.github.io/tree/main/docs/cpp/memory-management.md","tags":[],"version":"current","sidebarPosition":7,"frontMatter":{"sidebar_position":7,"title":"\u5185\u5b58\u7ba1\u7406"},"sidebar":"cpp","previous":{"title":"\u6587\u4ef6 I/O","permalink":"/docs/cpp/file-io"},"next":{"title":"\u7c7b\u548c\u5bf9\u8c61","permalink":"/docs/cpp/classes-objects"}}');var i=t(22714),s=t(48885);const r={sidebar_position:7,title:"\u5185\u5b58\u7ba1\u7406"},d="C++ \u5185\u5b58\u7ba1\u7406",a={},c=[{value:"\ud83e\uddf1 \u5185\u5b58\u533a\u57df",id:"-\u5185\u5b58\u533a\u57df",level:2},{value:"\ud83d\udce6 new \u548c delete",id:"-new-\u548c-delete",level:2},{value:"\ud83d\udee1\ufe0f RAII \u539f\u5219",id:"\ufe0f-raii-\u539f\u5219",level:2},{value:"\ud83d\udd10 \u667a\u80fd\u6307\u9488",id:"-\u667a\u80fd\u6307\u9488",level:2},{value:"unique_ptr",id:"unique_ptr",level:3},{value:"shared_ptr",id:"shared_ptr",level:3},{value:"weak_ptr",id:"weak_ptr",level:3},{value:"\u26a0\ufe0f \u5e38\u89c1\u95ee\u9898",id:"\ufe0f-\u5e38\u89c1\u95ee\u9898",level:2},{value:"\u5185\u5b58\u6cc4\u6f0f",id:"\u5185\u5b58\u6cc4\u6f0f",level:3},{value:"\u60ac\u7a7a\u6307\u9488",id:"\u60ac\u7a7a\u6307\u9488",level:3},{value:"\u53cc\u91cd\u91ca\u653e",id:"\u53cc\u91cd\u91ca\u653e",level:3},{value:"\u26a1 \u6700\u4f73\u5b9e\u8df5",id:"-\u6700\u4f73\u5b9e\u8df5",level:2}];function o(n){const e={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",mermaid:"mermaid",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.R)(),...n.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(e.header,{children:(0,i.jsx)(e.h1,{id:"c-\u5185\u5b58\u7ba1\u7406",children:"C++ \u5185\u5b58\u7ba1\u7406"})}),"\n",(0,i.jsx)(e.p,{children:"C++ \u63d0\u4f9b\u4e86\u5f3a\u5927\u7684\u5185\u5b58\u7ba1\u7406\u673a\u5236\uff0c\u4ece\u624b\u52a8 new/delete \u5230\u73b0\u4ee3\u667a\u80fd\u6307\u9488\u3002"}),"\n",(0,i.jsx)(e.h2,{id:"-\u5185\u5b58\u533a\u57df",children:"\ud83e\uddf1 \u5185\u5b58\u533a\u57df"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.strong,{children:"\u6808 (Stack)"}),": \u5c40\u90e8\u53d8\u91cf\uff0c\u81ea\u52a8\u7ba1\u7406"]}),"\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.strong,{children:"\u5806 (Heap)"}),": \u52a8\u6001\u5206\u914d\uff0c\u9700\u624b\u52a8\u7ba1\u7406"]}),"\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.strong,{children:"\u5168\u5c40/\u9759\u6001\u533a"}),": \u5168\u5c40\u53d8\u91cf\u548c\u9759\u6001\u53d8\u91cf"]}),"\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.strong,{children:"\u4ee3\u7801\u533a"}),": \u7a0b\u5e8f\u4ee3\u7801"]}),"\n"]}),"\n",(0,i.jsx)(e.mermaid,{value:'block-beta\n    columns 1\n    block:stack\n        label("Stack (High Memory)")\n        note("Local Variables, Function Calls")\n    end\n    space\n    block:heap\n        label("Heap (Low Memory)")\n        note("Dynamic Allocation (new/malloc)")\n    end\n    block:data\n        label("Global/Static Data")\n    end\n    block:code\n        label("Text/Code Segment")\n    end\n\n    style stack fill:#f99,stroke:#333\n    style heap fill:#99f,stroke:#333\n    style data fill:#ff9,stroke:#333\n    style code fill:#9f9,stroke:#333'}),"\n",(0,i.jsx)(e.h2,{id:"-new-\u548c-delete",children:"\ud83d\udce6 new \u548c delete"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-cpp",children:'#include <iostream>\n\nint main() {\n    // \u5206\u914d\u5355\u4e2a\u5bf9\u8c61\n    int* ptr = new int(42);\n    std::cout << *ptr << std::endl;\n    delete ptr;\n    ptr = nullptr;  // \u907f\u514d\u60ac\u7a7a\u6307\u9488\n\n    // \u5206\u914d\u6570\u7ec4\n    int* arr = new int[5]{1, 2, 3, 4, 5};\n    for (int i = 0; i < 5; i++) {\n        std::cout << arr[i] << " ";\n    }\n    delete[] arr;  // \u6ce8\u610f []\n\n    // \u5206\u914d\u5bf9\u8c61\n    class MyClass {\n    public:\n        MyClass() { std::cout << "\u6784\u9020" << std::endl; }\n        ~MyClass() { std::cout << "\u6790\u6784" << std::endl; }\n    };\n\n    MyClass* obj = new MyClass();\n    delete obj;\n\n    return 0;\n}\n'})}),"\n",(0,i.jsx)(e.h2,{id:"\ufe0f-raii-\u539f\u5219",children:"\ud83d\udee1\ufe0f RAII \u539f\u5219"}),"\n",(0,i.jsx)(e.p,{children:"Resource Acquisition Is Initialization\uff08\u8d44\u6e90\u83b7\u53d6\u5373\u521d\u59cb\u5316\uff09\uff1a"}),"\n",(0,i.jsx)(e.mermaid,{value:"sequenceDiagram\n    participant Code as User Code\n    participant Res as Resource (RAII Object)\n\n    Code->>Res: Constructor (Acquire Resource)\n    activate Res\n    Note right of Res: Resource is valid\n    Code->>Res: Perform Operations\n    Code->>Res: ...\n    deactivate Res\n    Res--\x3e>Code: Destructor (Release Resource)\n    Note right of Res: End of Scope"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-cpp",children:'#include <fstream>\n#include <mutex>\n\nclass FileHandler {\nprivate:\n    std::ofstream file;\n\npublic:\n    FileHandler(const std::string& filename) {\n        file.open(filename);\n    }\n\n    ~FileHandler() {\n        if (file.is_open()) {\n            file.close();  // \u81ea\u52a8\u5173\u95ed\n        }\n    }\n\n    void write(const std::string& data) {\n        file << data;\n    }\n};\n\nvoid example() {\n    FileHandler fh("test.txt");\n    fh.write("Hello");\n}  // \u79bb\u5f00\u4f5c\u7528\u57df\u81ea\u52a8\u5173\u95ed\u6587\u4ef6\n\n// \u4f7f\u7528 lock_guard \u7ba1\u7406\u4e92\u65a5\u9501\nstd::mutex mtx;\nvoid threadSafe() {\n    std::lock_guard<std::mutex> lock(mtx);\n    // \u4e34\u754c\u533a\u4ee3\u7801\n}  // \u81ea\u52a8\u89e3\u9501\n'})}),"\n",(0,i.jsx)(e.h2,{id:"-\u667a\u80fd\u6307\u9488",children:"\ud83d\udd10 \u667a\u80fd\u6307\u9488"}),"\n",(0,i.jsx)(e.h3,{id:"unique_ptr",children:"unique_ptr"}),"\n",(0,i.jsx)(e.p,{children:"\u72ec\u5360\u6240\u6709\u6743\uff0c\u4e0d\u80fd\u62f7\u8d1d\uff1a"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-cpp",children:"#include <memory>\n\nint main() {\n    // \u521b\u5efa\n    auto ptr = std::make_unique<int>(42);\n    std::unique_ptr<int[]> arr = std::make_unique<int[]>(5);\n\n    // \u4f7f\u7528\n    std::cout << *ptr << std::endl;\n\n    // \u8f6c\u79fb\u6240\u6709\u6743\n    auto ptr2 = std::move(ptr);\n    // ptr \u73b0\u5728\u4e3a\u7a7a\n\n    // \u91ca\u653e\u6240\u6709\u6743\n    int* raw = ptr2.release();\n    delete raw;\n\n    // \u91cd\u7f6e\n    ptr2.reset(new int(100));\n    ptr2.reset();  // \u91ca\u653e\u5e76\u7f6e\u7a7a\n\n    return 0;\n}\n"})}),"\n",(0,i.jsx)(e.h3,{id:"shared_ptr",children:"shared_ptr"}),"\n",(0,i.jsx)(e.p,{children:"\u5171\u4eab\u6240\u6709\u6743\uff0c\u5f15\u7528\u8ba1\u6570\uff1a"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-cpp",children:'#include <memory>\n\nint main() {\n    auto ptr1 = std::make_shared<int>(42);\n    std::cout << "Count: " << ptr1.use_count() << std::endl;  // 1\n\n    {\n        auto ptr2 = ptr1;  // \u5171\u4eab\u6240\u6709\u6743\n        std::cout << "Count: " << ptr1.use_count() << std::endl;  // 2\n    }\n\n    std::cout << "Count: " << ptr1.use_count() << std::endl;  // 1\n\n    return 0;\n}\n'})}),"\n",(0,i.jsx)(e.h3,{id:"weak_ptr",children:"weak_ptr"}),"\n",(0,i.jsx)(e.p,{children:"\u5f31\u5f15\u7528\uff0c\u4e0d\u589e\u52a0\u5f15\u7528\u8ba1\u6570\uff1a"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-cpp",children:"#include <memory>\n\nint main() {\n    auto shared = std::make_shared<int>(42);\n    std::weak_ptr<int> weak = shared;\n\n    // \u4f7f\u7528\u524d\u68c0\u67e5\u5e76\u9501\u5b9a\n    if (auto locked = weak.lock()) {\n        std::cout << *locked << std::endl;\n    }\n\n    // \u68c0\u67e5\u662f\u5426\u8fc7\u671f\n    if (!weak.expired()) {\n        // \u5bf9\u8c61\u4ecd\u7136\u5b58\u5728\n    }\n\n    return 0;\n}\n"})}),"\n",(0,i.jsx)(e.h2,{id:"\ufe0f-\u5e38\u89c1\u95ee\u9898",children:"\u26a0\ufe0f \u5e38\u89c1\u95ee\u9898"}),"\n",(0,i.jsx)(e.h3,{id:"\u5185\u5b58\u6cc4\u6f0f",children:"\u5185\u5b58\u6cc4\u6f0f"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-cpp",children:"void leak() {\n    int* ptr = new int(42);\n    return;  // \u5fd8\u8bb0 delete\n}\n\n// \u89e3\u51b3\uff1a\u4f7f\u7528\u667a\u80fd\u6307\u9488\nvoid noLeak() {\n    auto ptr = std::make_unique<int>(42);\n}  // \u81ea\u52a8\u91ca\u653e\n"})}),"\n",(0,i.jsx)(e.h3,{id:"\u60ac\u7a7a\u6307\u9488",children:"\u60ac\u7a7a\u6307\u9488"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-cpp",children:"int* ptr;\n{\n    int x = 10;\n    ptr = &x;\n}\n// ptr \u73b0\u5728\u662f\u60ac\u7a7a\u6307\u9488\n\n// \u89e3\u51b3\uff1a\u4f7f\u7528\u667a\u80fd\u6307\u9488\u6216\u786e\u4fdd\u751f\u547d\u5468\u671f\n"})}),"\n",(0,i.jsx)(e.h3,{id:"\u53cc\u91cd\u91ca\u653e",children:"\u53cc\u91cd\u91ca\u653e"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-cpp",children:"int* ptr = new int(42);\ndelete ptr;\ndelete ptr;  // \u9519\u8bef\uff01\n\n// \u89e3\u51b3\uff1adelete \u540e\u7f6e\u7a7a\uff0c\u6216\u4f7f\u7528\u667a\u80fd\u6307\u9488\nptr = nullptr;\n"})}),"\n",(0,i.jsx)(e.h2,{id:"-\u6700\u4f73\u5b9e\u8df5",children:"\u26a1 \u6700\u4f73\u5b9e\u8df5"}),"\n",(0,i.jsxs)(e.ol,{children:["\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.strong,{children:"\u4f18\u5148\u4f7f\u7528\u667a\u80fd\u6307\u9488"})," - \u907f\u514d\u624b\u52a8\u7ba1\u7406"]}),"\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.strong,{children:"\u4f7f\u7528 make_unique/make_shared"})," - \u66f4\u5b89\u5168\u9ad8\u6548"]}),"\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.strong,{children:"\u9075\u5faa RAII"})," - \u8d44\u6e90\u5728\u6784\u9020\u65f6\u83b7\u53d6\uff0c\u6790\u6784\u65f6\u91ca\u653e"]}),"\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.strong,{children:"\u907f\u514d\u88f8\u6307\u9488\u6240\u6709\u6743"})," - \u88f8\u6307\u9488\u4ec5\u7528\u4e8e\u975e\u6240\u6709\u6743\u573a\u666f"]}),"\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.strong,{children:"delete \u540e\u7f6e\u7a7a"})," - \u5982\u679c\u5fc5\u987b\u4f7f\u7528\u88f8\u6307\u9488"]}),"\n"]})]})}function p(n={}){const{wrapper:e}={...(0,s.R)(),...n.components};return e?(0,i.jsx)(e,{...n,children:(0,i.jsx)(o,{...n})}):o(n)}}}]);