"use strict";(globalThis.webpackChunkto_lib_github_io=globalThis.webpackChunkto_lib_github_io||[]).push([[709],{33529:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>a,contentTitle:()=>i,default:()=>p,frontMatter:()=>c,metadata:()=>l,toc:()=>t});const l=JSON.parse('{"id":"postgres/backup-recovery","title":"\u5907\u4efd\u4e0e\u6062\u590d","description":"\u6570\u636e\u5907\u4efd\u662f\u4fdd\u969c\u6570\u636e\u5b89\u5168\u7684\u91cd\u8981\u63aa\u65bd\u3002\u672c\u6587\u4ecb\u7ecd PostgreSQL \u7684\u5907\u4efd\u548c\u6062\u590d\u7b56\u7565\u3002","source":"@site/docs/postgres/backup-recovery.md","sourceDirName":"postgres","slug":"/postgres/backup-recovery","permalink":"/docs/postgres/backup-recovery","draft":false,"unlisted":false,"editUrl":"https://github.com/to-lib/to-lib.github.io/tree/main/docs/postgres/backup-recovery.md","tags":[],"version":"current","sidebarPosition":8,"frontMatter":{"sidebar_position":8,"title":"\u5907\u4efd\u4e0e\u6062\u590d"},"sidebar":"postgres","previous":{"title":"\u6027\u80fd\u4f18\u5316","permalink":"/docs/postgres/performance-optimization"},"next":{"title":"\u6700\u4f73\u5b9e\u8df5","permalink":"/docs/postgres/best-practices"}}');var d=s(22714),r=s(48885);const c={sidebar_position:8,title:"\u5907\u4efd\u4e0e\u6062\u590d"},i="PostgreSQL \u5907\u4efd\u4e0e\u6062\u590d",a={},t=[{value:"\ud83d\udce6 \u5907\u4efd\u7c7b\u578b",id:"-\u5907\u4efd\u7c7b\u578b",level:2},{value:"1. \u903b\u8f91\u5907\u4efd",id:"1-\u903b\u8f91\u5907\u4efd",level:3},{value:"2. \u7269\u7406\u5907\u4efd",id:"2-\u7269\u7406\u5907\u4efd",level:3},{value:"\ud83d\udee0\ufe0f \u903b\u8f91\u5907\u4efd\u5de5\u5177",id:"\ufe0f-\u903b\u8f91\u5907\u4efd\u5de5\u5177",level:2},{value:"pg_dump - \u5907\u4efd\u5355\u4e2a\u6570\u636e\u5e93",id:"pg_dump---\u5907\u4efd\u5355\u4e2a\u6570\u636e\u5e93",level:3},{value:"pg_dumpall - \u5907\u4efd\u6240\u6709\u6570\u636e\u5e93",id:"pg_dumpall---\u5907\u4efd\u6240\u6709\u6570\u636e\u5e93",level:3},{value:"\ud83d\udd04 \u6062\u590d\u6570\u636e",id:"-\u6062\u590d\u6570\u636e",level:2},{value:"psql - \u6062\u590d SQL \u6587\u4ef6",id:"psql---\u6062\u590d-sql-\u6587\u4ef6",level:3},{value:"pg_restore - \u6062\u590d\u81ea\u5b9a\u4e49\u683c\u5f0f",id:"pg_restore---\u6062\u590d\u81ea\u5b9a\u4e49\u683c\u5f0f",level:3},{value:"\ud83d\udcbe \u7269\u7406\u5907\u4efd",id:"-\u7269\u7406\u5907\u4efd",level:2},{value:"1. \u6587\u4ef6\u7cfb\u7edf\u7ea7\u5907\u4efd",id:"1-\u6587\u4ef6\u7cfb\u7edf\u7ea7\u5907\u4efd",level:3},{value:"2. pg_basebackup - \u5728\u7ebf\u7269\u7406\u5907\u4efd",id:"2-pg_basebackup---\u5728\u7ebf\u7269\u7406\u5907\u4efd",level:3},{value:"\u6062\u590d\u7269\u7406\u5907\u4efd",id:"\u6062\u590d\u7269\u7406\u5907\u4efd",level:3},{value:"\ud83d\udd01 \u6301\u7eed\u5f52\u6863\u548c\u65f6\u95f4\u70b9\u6062\u590d\uff08PITR\uff09",id:"-\u6301\u7eed\u5f52\u6863\u548c\u65f6\u95f4\u70b9\u6062\u590dpitr",level:2},{value:"1. \u914d\u7f6e WAL \u5f52\u6863",id:"1-\u914d\u7f6e-wal-\u5f52\u6863",level:3},{value:"2. \u57fa\u7840\u5907\u4efd",id:"2-\u57fa\u7840\u5907\u4efd",level:3},{value:"3. \u6062\u590d\u5230\u7279\u5b9a\u65f6\u95f4\u70b9",id:"3-\u6062\u590d\u5230\u7279\u5b9a\u65f6\u95f4\u70b9",level:3},{value:"\ud83d\udcc5 \u81ea\u52a8\u5316\u5907\u4efd",id:"-\u81ea\u52a8\u5316\u5907\u4efd",level:2},{value:"Cron \u5b9a\u65f6\u4efb\u52a1",id:"cron-\u5b9a\u65f6\u4efb\u52a1",level:3},{value:"\u5907\u4efd\u811a\u672c",id:"\u5907\u4efd\u811a\u672c",level:3},{value:"\ud83e\uddea \u9a8c\u8bc1\u5907\u4efd",id:"-\u9a8c\u8bc1\u5907\u4efd",level:2},{value:"1. \u6d4b\u8bd5\u6062\u590d",id:"1-\u6d4b\u8bd5\u6062\u590d",level:3},{value:"2. \u5907\u4efd\u5b8c\u6574\u6027\u68c0\u67e5",id:"2-\u5907\u4efd\u5b8c\u6574\u6027\u68c0\u67e5",level:3},{value:"\ud83d\udca1 \u6700\u4f73\u5b9e\u8df5",id:"-\u6700\u4f73\u5b9e\u8df5",level:2},{value:"1. 3-2-1 \u5907\u4efd\u7b56\u7565",id:"1-3-2-1-\u5907\u4efd\u7b56\u7565",level:3},{value:"2. \u5b9a\u671f\u6d4b\u8bd5\u6062\u590d",id:"2-\u5b9a\u671f\u6d4b\u8bd5\u6062\u590d",level:3},{value:"3. \u76d1\u63a7\u5907\u4efd\u72b6\u6001",id:"3-\u76d1\u63a7\u5907\u4efd\u72b6\u6001",level:3},{value:"4. \u52a0\u5bc6\u5907\u4efd",id:"4-\u52a0\u5bc6\u5907\u4efd",level:3},{value:"\ud83d\udcca \u5907\u4efd\u7b56\u7565\u5bf9\u6bd4",id:"-\u5907\u4efd\u7b56\u7565\u5bf9\u6bd4",level:2},{value:"\ud83d\udd0d \u6545\u969c\u6062\u590d\u573a\u666f",id:"-\u6545\u969c\u6062\u590d\u573a\u666f",level:2},{value:"1. \u8bef\u5220\u9664\u6570\u636e",id:"1-\u8bef\u5220\u9664\u6570\u636e",level:3},{value:"2. \u6570\u636e\u635f\u574f",id:"2-\u6570\u636e\u635f\u574f",level:3},{value:"3. \u786c\u4ef6\u6545\u969c",id:"3-\u786c\u4ef6\u6545\u969c",level:3},{value:"\ud83d\udcda \u76f8\u5173\u8d44\u6e90",id:"-\u76f8\u5173\u8d44\u6e90",level:2}];function h(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,r.R)(),...e.components};return(0,d.jsxs)(d.Fragment,{children:[(0,d.jsx)(n.header,{children:(0,d.jsx)(n.h1,{id:"postgresql-\u5907\u4efd\u4e0e\u6062\u590d",children:"PostgreSQL \u5907\u4efd\u4e0e\u6062\u590d"})}),"\n",(0,d.jsx)(n.p,{children:"\u6570\u636e\u5907\u4efd\u662f\u4fdd\u969c\u6570\u636e\u5b89\u5168\u7684\u91cd\u8981\u63aa\u65bd\u3002\u672c\u6587\u4ecb\u7ecd PostgreSQL \u7684\u5907\u4efd\u548c\u6062\u590d\u7b56\u7565\u3002"}),"\n",(0,d.jsx)(n.h2,{id:"-\u5907\u4efd\u7c7b\u578b",children:"\ud83d\udce6 \u5907\u4efd\u7c7b\u578b"}),"\n",(0,d.jsx)(n.h3,{id:"1-\u903b\u8f91\u5907\u4efd",children:"1. \u903b\u8f91\u5907\u4efd"}),"\n",(0,d.jsx)(n.p,{children:"\u5bfc\u51fa SQL \u8bed\u53e5\u6216\u6570\u636e\u6587\u4ef6\u3002"}),"\n",(0,d.jsx)(n.p,{children:(0,d.jsx)(n.strong,{children:"\u4f18\u70b9\uff1a"})}),"\n",(0,d.jsxs)(n.ul,{children:["\n",(0,d.jsx)(n.li,{children:"\u53ef\u8bfb\u6027\u5f3a"}),"\n",(0,d.jsx)(n.li,{children:"\u53ef\u8de8\u7248\u672c\u6062\u590d"}),"\n",(0,d.jsx)(n.li,{children:"\u53ef\u9009\u62e9\u6027\u5907\u4efd"}),"\n"]}),"\n",(0,d.jsx)(n.p,{children:(0,d.jsx)(n.strong,{children:"\u7f3a\u70b9\uff1a"})}),"\n",(0,d.jsxs)(n.ul,{children:["\n",(0,d.jsx)(n.li,{children:"\u5907\u4efd/\u6062\u590d\u6162"}),"\n",(0,d.jsx)(n.li,{children:"\u6587\u4ef6\u8f83\u5927"}),"\n"]}),"\n",(0,d.jsx)(n.h3,{id:"2-\u7269\u7406\u5907\u4efd",children:"2. \u7269\u7406\u5907\u4efd"}),"\n",(0,d.jsx)(n.p,{children:"\u76f4\u63a5\u590d\u5236\u6570\u636e\u6587\u4ef6\u3002"}),"\n",(0,d.jsx)(n.p,{children:(0,d.jsx)(n.strong,{children:"\u4f18\u70b9\uff1a"})}),"\n",(0,d.jsxs)(n.ul,{children:["\n",(0,d.jsx)(n.li,{children:"\u901f\u5ea6\u5feb"}),"\n",(0,d.jsx)(n.li,{children:"\u6587\u4ef6\u8f83\u5c0f"}),"\n"]}),"\n",(0,d.jsx)(n.p,{children:(0,d.jsx)(n.strong,{children:"\u7f3a\u70b9\uff1a"})}),"\n",(0,d.jsxs)(n.ul,{children:["\n",(0,d.jsx)(n.li,{children:"\u4e0d\u53ef\u8de8\u7248\u672c"}),"\n",(0,d.jsx)(n.li,{children:"\u5fc5\u987b\u5b8c\u6574\u5907\u4efd"}),"\n"]}),"\n",(0,d.jsx)(n.h2,{id:"\ufe0f-\u903b\u8f91\u5907\u4efd\u5de5\u5177",children:"\ud83d\udee0\ufe0f \u903b\u8f91\u5907\u4efd\u5de5\u5177"}),"\n",(0,d.jsx)(n.h3,{id:"pg_dump---\u5907\u4efd\u5355\u4e2a\u6570\u636e\u5e93",children:"pg_dump - \u5907\u4efd\u5355\u4e2a\u6570\u636e\u5e93"}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-bash",children:"# \u57fa\u672c\u5907\u4efd\npg_dump mydb > mydb_backup.sql\n\n# \u6307\u5b9a\u4e3b\u673a\u548c\u7528\u6237\npg_dump -h localhost -U postgres mydb > backup.sql\n\n# \u81ea\u5b9a\u4e49\u683c\u5f0f\uff08\u538b\u7f29\uff0c\u63a8\u8350\uff09\npg_dump -Fc mydb > mydb_backup.dump\n\n# \u76ee\u5f55\u683c\u5f0f\uff08\u5e76\u884c\u5907\u4efd\uff09\npg_dump -Fd mydb -f mydb_backup_dir -j 4\n\n# \u4ec5\u5907\u4efd\u6570\u636e\uff08\u4e0d\u5305\u62ec\u7ed3\u6784\uff09\npg_dump --data-only mydb > data.sql\n\n# \u4ec5\u5907\u4efd\u7ed3\u6784\npg_dump --schema-only mydb > schema.sql\n\n# \u5907\u4efd\u7279\u5b9a\u8868\npg_dump -t users -t orders mydb > tables.sql\n"})}),"\n",(0,d.jsx)(n.h3,{id:"pg_dumpall---\u5907\u4efd\u6240\u6709\u6570\u636e\u5e93",children:"pg_dumpall - \u5907\u4efd\u6240\u6709\u6570\u636e\u5e93"}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-bash",children:"# \u5907\u4efd\u6240\u6709\u6570\u636e\u5e93\npg_dumpall > all_databases.sql\n\n# \u4ec5\u5907\u4efd\u5168\u5c40\u5bf9\u8c61\uff08\u89d2\u8272\u3001\u8868\u7a7a\u95f4\uff09\npg_dumpall --globals-only > globals.sql\n\n# \u4ec5\u5907\u4efd\u89d2\u8272\npg_dumpall --roles-only > roles.sql\n"})}),"\n",(0,d.jsx)(n.h2,{id:"-\u6062\u590d\u6570\u636e",children:"\ud83d\udd04 \u6062\u590d\u6570\u636e"}),"\n",(0,d.jsx)(n.h3,{id:"psql---\u6062\u590d-sql-\u6587\u4ef6",children:"psql - \u6062\u590d SQL \u6587\u4ef6"}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-bash",children:"# \u6062\u590d SQL \u5907\u4efd\npsql mydb < mydb_backup.sql\n\n# \u521b\u5efa\u6570\u636e\u5e93\u5e76\u6062\u590d\ncreatedb mydb\npsql mydb < mydb_backup.sql\n\n# \u6307\u5b9a\u4e3b\u673a\u548c\u7528\u6237\npsql -h localhost -U postgres mydb < backup.sql\n"})}),"\n",(0,d.jsx)(n.h3,{id:"pg_restore---\u6062\u590d\u81ea\u5b9a\u4e49\u683c\u5f0f",children:"pg_restore - \u6062\u590d\u81ea\u5b9a\u4e49\u683c\u5f0f"}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-bash",children:"# \u6062\u590d\u81ea\u5b9a\u4e49\u683c\u5f0f\u5907\u4efd\npg_restore -d mydb mydb_backup.dump\n\n# \u5e76\u884c\u6062\u590d\npg_restore -d mydb -j 4 mydb_backup.dump\n\n# \u4ec5\u6062\u590d\u6570\u636e\npg_restore --data-only -d mydb backup.dump\n\n# \u4ec5\u6062\u590d\u7279\u5b9a\u8868\npg_restore -t users -d mydb backup.dump\n\n# \u5148\u6e05\u7406\u518d\u6062\u590d\npg_restore --clean -d mydb backup.dump\n"})}),"\n",(0,d.jsx)(n.h2,{id:"-\u7269\u7406\u5907\u4efd",children:"\ud83d\udcbe \u7269\u7406\u5907\u4efd"}),"\n",(0,d.jsx)(n.h3,{id:"1-\u6587\u4ef6\u7cfb\u7edf\u7ea7\u5907\u4efd",children:"1. \u6587\u4ef6\u7cfb\u7edf\u7ea7\u5907\u4efd"}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-bash",children:"# \u505c\u6b62 PostgreSQL\nsudo systemctl stop postgresql\n\n# \u590d\u5236\u6570\u636e\u76ee\u5f55\nsudo cp -r /var/lib/postgresql/15/main /backup/pg_data_backup\n\n# \u542f\u52a8 PostgreSQL\nsudo systemctl start postgresql\n"})}),"\n",(0,d.jsx)(n.h3,{id:"2-pg_basebackup---\u5728\u7ebf\u7269\u7406\u5907\u4efd",children:"2. pg_basebackup - \u5728\u7ebf\u7269\u7406\u5907\u4efd"}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-bash",children:"# \u57fa\u7840\u5907\u4efd\npg_basebackup -D /backup/pg_base -Ft -z -P\n\n# \u53c2\u6570\u8bf4\u660e\uff1a\n# -D: \u5907\u4efd\u76ee\u5f55\n# -Ft: tar \u683c\u5f0f\n# -z: \u538b\u7f29\n# -P: \u663e\u793a\u8fdb\u5ea6\n\n# \u6d41\u5f0f\u5907\u4efd\npg_basebackup -D /backup/pg_base -Xs -P\n\n# WAL \u5f52\u6863\u5907\u4efd\npg_basebackup -D /backup/pg_base -X fetch -P\n"})}),"\n",(0,d.jsx)(n.h3,{id:"\u6062\u590d\u7269\u7406\u5907\u4efd",children:"\u6062\u590d\u7269\u7406\u5907\u4efd"}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-bash",children:"# \u505c\u6b62 PostgreSQL\nsudo systemctl stop postgresql\n\n# \u6e05\u7a7a\u6570\u636e\u76ee\u5f55\nsudo rm -rf /var/lib/postgresql/15/main/*\n\n# \u89e3\u538b\u5907\u4efd\nsudo tar -xzf /backup/base.tar.gz -C /var/lib/postgresql/15/main/\n\n# \u4fee\u590d\u6743\u9650\nsudo chown -R postgres:postgres /var/lib/postgresql/15/main\n\n# \u542f\u52a8 PostgreSQL\nsudo systemctl start postgresql\n"})}),"\n",(0,d.jsx)(n.h2,{id:"-\u6301\u7eed\u5f52\u6863\u548c\u65f6\u95f4\u70b9\u6062\u590dpitr",children:"\ud83d\udd01 \u6301\u7eed\u5f52\u6863\u548c\u65f6\u95f4\u70b9\u6062\u590d\uff08PITR\uff09"}),"\n",(0,d.jsx)(n.h3,{id:"1-\u914d\u7f6e-wal-\u5f52\u6863",children:"1. \u914d\u7f6e WAL \u5f52\u6863"}),"\n",(0,d.jsxs)(n.p,{children:["\u7f16\u8f91 ",(0,d.jsx)(n.code,{children:"postgresql.conf"}),"\uff1a"]}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-conf",children:"# \u542f\u7528\u5f52\u6863\nwal_level = replica\narchive_mode = on\narchive_command = 'cp %p /archive/%f'\n\n# \u6216\u4f7f\u7528 rsync\narchive_command = 'rsync -a %p /backup/archive/%f'\n"})}),"\n",(0,d.jsx)(n.p,{children:"\u91cd\u542f PostgreSQL\uff1a"}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-bash",children:"sudo systemctl restart postgresql\n"})}),"\n",(0,d.jsx)(n.h3,{id:"2-\u57fa\u7840\u5907\u4efd",children:"2. \u57fa\u7840\u5907\u4efd"}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-bash",children:"pg_basebackup -D /backup/base -Ft -z -P\n"})}),"\n",(0,d.jsx)(n.h3,{id:"3-\u6062\u590d\u5230\u7279\u5b9a\u65f6\u95f4\u70b9",children:"3. \u6062\u590d\u5230\u7279\u5b9a\u65f6\u95f4\u70b9"}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-bash",children:"# \u505c\u6b62 PostgreSQL\nsudo systemctl stop postgresql\n\n# \u6062\u590d\u57fa\u7840\u5907\u4efd\ncd /var/lib/postgresql/15/main\nsudo tar -xzf /backup/base/base.tar.gz\n\n# \u521b\u5efa recovery.conf\uff08PostgreSQL 12+\u4f7f\u7528 recovery.signal\uff09\nsudo touch recovery.signal\n\n# \u914d\u7f6e\u6062\u590d\u53c2\u6570\uff08postgresql.auto.conf\uff09\nrestore_command = 'cp /archive/%f %p'\nrecovery_target_time = '2024-01-15 14:30:00'\n\n# \u542f\u52a8 PostgreSQL\nsudo systemctl start postgresql\n\n# \u67e5\u770b\u6062\u590d\u72b6\u6001\nsudo tail -f /var/log/postgresql/postgresql-15-main.log\n"})}),"\n",(0,d.jsx)(n.h2,{id:"-\u81ea\u52a8\u5316\u5907\u4efd",children:"\ud83d\udcc5 \u81ea\u52a8\u5316\u5907\u4efd"}),"\n",(0,d.jsx)(n.h3,{id:"cron-\u5b9a\u65f6\u4efb\u52a1",children:"Cron \u5b9a\u65f6\u4efb\u52a1"}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-bash",children:'# \u7f16\u8f91 crontab\ncrontab -e\n\n# \u6bcf\u5929\u51cc\u6668 2 \u70b9\u5907\u4efd\n0 2 * * * /usr/bin/pg_dump -Fc mydb > /backup/mydb_$(date +\\%Y\\%m\\%d).dump\n\n# \u6e05\u7406 7 \u5929\u524d\u7684\u5907\u4efd\n0 3 * * * find /backup -name "*.dump" -mtime +7 -delete\n'})}),"\n",(0,d.jsx)(n.h3,{id:"\u5907\u4efd\u811a\u672c",children:"\u5907\u4efd\u811a\u672c"}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-bash",children:'#!/bin/bash\n\n# backup.sh\nBACKUP_DIR="/backup"\nTIMESTAMP=$(date +%Y%m%d_%H%M%S)\nDB_NAME="mydb"\n\n# \u521b\u5efa\u5907\u4efd\npg_dump -Fc $DB_NAME > $BACKUP_DIR/${DB_NAME}_${TIMESTAMP}.dump\n\n# \u68c0\u67e5\u5907\u4efd\u662f\u5426\u6210\u529f\nif [ $? -eq 0 ]; then\n    echo "Backup successful: ${DB_NAME}_${TIMESTAMP}.dump"\n\n    # \u6e05\u7406 7 \u5929\u524d\u7684\u5907\u4efd\n    find $BACKUP_DIR -name "${DB_NAME}_*.dump" -mtime +7 -delete\nelse\n    echo "Backup failed!" >&2\n    exit 1\nfi\n'})}),"\n",(0,d.jsx)(n.h2,{id:"-\u9a8c\u8bc1\u5907\u4efd",children:"\ud83e\uddea \u9a8c\u8bc1\u5907\u4efd"}),"\n",(0,d.jsx)(n.h3,{id:"1-\u6d4b\u8bd5\u6062\u590d",children:"1. \u6d4b\u8bd5\u6062\u590d"}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-bash",children:'# \u521b\u5efa\u6d4b\u8bd5\u6570\u636e\u5e93\ncreatedb test_restore\n\n# \u6062\u590d\u5907\u4efd\npg_restore -d test_restore backup.dump\n\n# \u9a8c\u8bc1\u6570\u636e\npsql test_restore -c "SELECT COUNT(*) FROM users;"\n\n# \u5220\u9664\u6d4b\u8bd5\u6570\u636e\u5e93\ndropdb test_restore\n'})}),"\n",(0,d.jsx)(n.h3,{id:"2-\u5907\u4efd\u5b8c\u6574\u6027\u68c0\u67e5",children:"2. \u5907\u4efd\u5b8c\u6574\u6027\u68c0\u67e5"}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-bash",children:"# \u68c0\u67e5\u5907\u4efd\u6587\u4ef6\npg_restore --list backup.dump\n\n# \u9a8c\u8bc1\u5907\u4efd\u5185\u5bb9\npg_restore --schema-only backup.dump | less\n"})}),"\n",(0,d.jsx)(n.h2,{id:"-\u6700\u4f73\u5b9e\u8df5",children:"\ud83d\udca1 \u6700\u4f73\u5b9e\u8df5"}),"\n",(0,d.jsx)(n.h3,{id:"1-3-2-1-\u5907\u4efd\u7b56\u7565",children:"1. 3-2-1 \u5907\u4efd\u7b56\u7565"}),"\n",(0,d.jsxs)(n.ul,{children:["\n",(0,d.jsxs)(n.li,{children:[(0,d.jsx)(n.strong,{children:"3"})," \u4efd\u6570\u636e\u526f\u672c"]}),"\n",(0,d.jsxs)(n.li,{children:[(0,d.jsx)(n.strong,{children:"2"})," \u79cd\u4e0d\u540c\u5b58\u50a8\u4ecb\u8d28"]}),"\n",(0,d.jsxs)(n.li,{children:[(0,d.jsx)(n.strong,{children:"1"})," \u4efd\u5f02\u5730\u5907\u4efd"]}),"\n"]}),"\n",(0,d.jsx)(n.h3,{id:"2-\u5b9a\u671f\u6d4b\u8bd5\u6062\u590d",children:"2. \u5b9a\u671f\u6d4b\u8bd5\u6062\u590d"}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-bash",children:"# \u6bcf\u6708\u6d4b\u8bd5\u6062\u590d\u6d41\u7a0b\n0 0 1 * * /path/to/test_restore.sh\n"})}),"\n",(0,d.jsx)(n.h3,{id:"3-\u76d1\u63a7\u5907\u4efd\u72b6\u6001",children:"3. \u76d1\u63a7\u5907\u4efd\u72b6\u6001"}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-sql",children:"-- \u68c0\u67e5\u6700\u540e\u4e00\u6b21\u6210\u529f\u7684\u5f52\u6863\u65f6\u95f4\nSELECT *\nFROM pg_stat_archiver;\n"})}),"\n",(0,d.jsx)(n.h3,{id:"4-\u52a0\u5bc6\u5907\u4efd",children:"4. \u52a0\u5bc6\u5907\u4efd"}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-bash",children:"# \u4f7f\u7528 GPG \u52a0\u5bc6\npg_dump mydb | gzip | gpg -e -r your@email.com > backup.sql.gz.gpg\n\n# \u89e3\u5bc6\u6062\u590d\ngpg -d backup.sql.gz.gpg | gunzip | psql mydb\n"})}),"\n",(0,d.jsx)(n.h2,{id:"-\u5907\u4efd\u7b56\u7565\u5bf9\u6bd4",children:"\ud83d\udcca \u5907\u4efd\u7b56\u7565\u5bf9\u6bd4"}),"\n",(0,d.jsxs)(n.table,{children:[(0,d.jsx)(n.thead,{children:(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.th,{children:"\u7b56\u7565"}),(0,d.jsx)(n.th,{children:"\u9891\u7387"}),(0,d.jsx)(n.th,{children:"\u4fdd\u7559\u671f"}),(0,d.jsx)(n.th,{children:"\u9002\u7528\u573a\u666f"})]})}),(0,d.jsxs)(n.tbody,{children:[(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.td,{children:"\u5b8c\u6574\u5907\u4efd"}),(0,d.jsx)(n.td,{children:"\u6bcf\u5468"}),(0,d.jsx)(n.td,{children:"4 \u5468"}),(0,d.jsx)(n.td,{children:"\u5927\u578b\u6570\u636e\u5e93"})]}),(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.td,{children:"\u589e\u91cf\u5907\u4efd"}),(0,d.jsx)(n.td,{children:"\u6bcf\u5929"}),(0,d.jsx)(n.td,{children:"7 \u5929"}),(0,d.jsx)(n.td,{children:"\u53d8\u5316\u9891\u7e41\u7684\u6570\u636e"})]}),(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.td,{children:"WAL \u5f52\u6863"}),(0,d.jsx)(n.td,{children:"\u5b9e\u65f6"}),(0,d.jsx)(n.td,{children:"\u6839\u636e\u9700\u6c42"}),(0,d.jsx)(n.td,{children:"\u9700\u8981\u65f6\u95f4\u70b9\u6062\u590d"})]}),(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.td,{children:"\u5feb\u7167"}),(0,d.jsx)(n.td,{children:"\u6bcf\u5c0f\u65f6"}),(0,d.jsx)(n.td,{children:"24 \u5c0f\u65f6"}),(0,d.jsx)(n.td,{children:"\u4e91\u73af\u5883"})]})]})]}),"\n",(0,d.jsx)(n.h2,{id:"-\u6545\u969c\u6062\u590d\u573a\u666f",children:"\ud83d\udd0d \u6545\u969c\u6062\u590d\u573a\u666f"}),"\n",(0,d.jsx)(n.h3,{id:"1-\u8bef\u5220\u9664\u6570\u636e",children:"1. \u8bef\u5220\u9664\u6570\u636e"}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-sql",children:"-- \u4f7f\u7528\u65f6\u95f4\u70b9\u6062\u590d\u5230\u5220\u9664\u4e4b\u524d\nrecovery_target_time = '2024-01-15 13:59:00'\n"})}),"\n",(0,d.jsx)(n.h3,{id:"2-\u6570\u636e\u635f\u574f",children:"2. \u6570\u636e\u635f\u574f"}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-bash",children:"# \u4f7f\u7528\u6700\u65b0\u7684\u5907\u4efd\u6062\u590d\npg_restore -d mydb latest_backup.dump\n"})}),"\n",(0,d.jsx)(n.h3,{id:"3-\u786c\u4ef6\u6545\u969c",children:"3. \u786c\u4ef6\u6545\u969c"}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-bash",children:"# \u5728\u65b0\u670d\u52a1\u5668\u4e0a\u6062\u590d\n# 1. \u5b89\u88c5 PostgreSQL\n# 2. \u6062\u590d\u57fa\u7840\u5907\u4efd\n# 3. \u5e94\u7528 WAL \u65e5\u5fd7\n"})}),"\n",(0,d.jsx)(n.h2,{id:"-\u76f8\u5173\u8d44\u6e90",children:"\ud83d\udcda \u76f8\u5173\u8d44\u6e90"}),"\n",(0,d.jsxs)(n.ul,{children:["\n",(0,d.jsxs)(n.li,{children:[(0,d.jsx)(n.a,{href:"./performance-optimization",children:"\u6027\u80fd\u4f18\u5316"})," - \u4f18\u5316\u5907\u4efd\u6027\u80fd"]}),"\n",(0,d.jsxs)(n.li,{children:[(0,d.jsx)(n.a,{href:"./replication",children:"\u9ad8\u53ef\u7528"})," - \u4e3b\u4ece\u590d\u5236"]}),"\n",(0,d.jsxs)(n.li,{children:[(0,d.jsx)(n.a,{href:"./security",children:"\u5b89\u5168\u7ba1\u7406"})," - \u5907\u4efd\u52a0\u5bc6"]}),"\n"]}),"\n",(0,d.jsxs)(n.p,{children:["\u4e0b\u4e00\u8282\uff1a",(0,d.jsx)(n.a,{href:"./quick-reference",children:"\u5feb\u901f\u53c2\u8003"})]})]})}function p(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,d.jsx)(n,{...e,children:(0,d.jsx)(h,{...e})}):h(e)}},48885:(e,n,s)=>{s.d(n,{R:()=>c,x:()=>i});var l=s(99378);const d={},r=l.createContext(d);function c(e){const n=l.useContext(r);return l.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function i(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(d):e.components||d:c(e.components),l.createElement(r.Provider,{value:n},e.children)}}}]);