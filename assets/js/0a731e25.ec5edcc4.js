"use strict";(globalThis.webpackChunkto_lib_github_io=globalThis.webpackChunkto_lib_github_io||[]).push([[6257],{48885:(e,n,r)=>{r.d(n,{R:()=>a,x:()=>t});var l=r(99378);const i={},s=l.createContext(i);function a(e){const n=l.useContext(s);return l.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function t(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:a(e.components),l.createElement(s.Provider,{value:n},e.children)}},93882:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>c,contentTitle:()=>t,default:()=>u,frontMatter:()=>a,metadata:()=>l,toc:()=>d});const l=JSON.parse('{"id":"microservices/service-governance","title":"\u670d\u52a1\u6cbb\u7406","description":"\u5fae\u670d\u52a1\u670d\u52a1\u6cbb\u7406 - \u6ce8\u518c\u53d1\u73b0\u3001\u914d\u7f6e\u4e2d\u5fc3\u3001\u8d1f\u8f7d\u5747\u8861\u3001\u9650\u6d41\u7194\u65ad","source":"@site/docs/microservices/service-governance.md","sourceDirName":"microservices","slug":"/microservices/service-governance","permalink":"/docs/microservices/service-governance","draft":false,"unlisted":false,"editUrl":"https://github.com/to-lib/to-lib.github.io/tree/main/docs/microservices/service-governance.md","tags":[],"version":"current","sidebarPosition":4,"frontMatter":{"sidebar_position":4,"title":"\u670d\u52a1\u6cbb\u7406","description":"\u5fae\u670d\u52a1\u670d\u52a1\u6cbb\u7406 - \u6ce8\u518c\u53d1\u73b0\u3001\u914d\u7f6e\u4e2d\u5fc3\u3001\u8d1f\u8f7d\u5747\u8861\u3001\u9650\u6d41\u7194\u65ad"},"sidebar":"microservices","previous":{"title":"\u8bbe\u8ba1\u6a21\u5f0f","permalink":"/docs/microservices/design-patterns"},"next":{"title":"\u90e8\u7f72\u4e0e\u8fd0\u7ef4","permalink":"/docs/microservices/deployment"}}');var i=r(22714),s=r(48885);const a={sidebar_position:4,title:"\u670d\u52a1\u6cbb\u7406",description:"\u5fae\u670d\u52a1\u670d\u52a1\u6cbb\u7406 - \u6ce8\u518c\u53d1\u73b0\u3001\u914d\u7f6e\u4e2d\u5fc3\u3001\u8d1f\u8f7d\u5747\u8861\u3001\u9650\u6d41\u7194\u65ad"},t="\u670d\u52a1\u6cbb\u7406",c={},d=[{value:"\u670d\u52a1\u6ce8\u518c\u4e0e\u53d1\u73b0",id:"\u670d\u52a1\u6ce8\u518c\u4e0e\u53d1\u73b0",level:2},{value:"Nacos",id:"nacos",level:3},{value:"\u5feb\u901f\u5f00\u59cb",id:"\u5feb\u901f\u5f00\u59cb",level:4},{value:"Spring Cloud \u96c6\u6210",id:"spring-cloud-\u96c6\u6210",level:4},{value:"Consul",id:"consul",level:3},{value:"\u670d\u52a1\u53d1\u73b0\u5ba2\u6237\u7aef",id:"\u670d\u52a1\u53d1\u73b0\u5ba2\u6237\u7aef",level:3},{value:"\u914d\u7f6e\u4e2d\u5fc3",id:"\u914d\u7f6e\u4e2d\u5fc3",level:2},{value:"Nacos Config",id:"nacos-config",level:3},{value:"Apollo",id:"apollo",level:3},{value:"\u8d1f\u8f7d\u5747\u8861",id:"\u8d1f\u8f7d\u5747\u8861",level:2},{value:"\u8d1f\u8f7d\u5747\u8861\u7b56\u7565",id:"\u8d1f\u8f7d\u5747\u8861\u7b56\u7565",level:3},{value:"Spring Cloud LoadBalancer",id:"spring-cloud-loadbalancer",level:3},{value:"Ribbon \u914d\u7f6e\uff08\u65e7\u7248\u672c\uff09",id:"ribbon-\u914d\u7f6e\u65e7\u7248\u672c",level:3},{value:"\u9650\u6d41",id:"\u9650\u6d41",level:2},{value:"\u9650\u6d41\u7b97\u6cd5",id:"\u9650\u6d41\u7b97\u6cd5",level:3},{value:"Sentinel \u9650\u6d41",id:"sentinel-\u9650\u6d41",level:3},{value:"\u7194\u65ad\u964d\u7ea7",id:"\u7194\u65ad\u964d\u7ea7",level:2},{value:"Sentinel \u7194\u65ad",id:"sentinel-\u7194\u65ad",level:3},{value:"Resilience4j \u7194\u65ad",id:"resilience4j-\u7194\u65ad",level:3},{value:"\u670d\u52a1\u6cbb\u7406\u6700\u4f73\u5b9e\u8df5",id:"\u670d\u52a1\u6cbb\u7406\u6700\u4f73\u5b9e\u8df5",level:2},{value:"\u5065\u5eb7\u68c0\u67e5",id:"\u5065\u5eb7\u68c0\u67e5",level:3},{value:"\u4f18\u96c5\u505c\u673a",id:"\u4f18\u96c5\u505c\u673a",level:3}];function o(e){const n={code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",mermaid:"mermaid",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",...(0,s.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"\u670d\u52a1\u6cbb\u7406",children:"\u670d\u52a1\u6cbb\u7406"})}),"\n",(0,i.jsx)(n.h2,{id:"\u670d\u52a1\u6ce8\u518c\u4e0e\u53d1\u73b0",children:"\u670d\u52a1\u6ce8\u518c\u4e0e\u53d1\u73b0"}),"\n",(0,i.jsx)(n.h3,{id:"nacos",children:"Nacos"}),"\n",(0,i.jsx)(n.p,{children:"Nacos \u662f\u963f\u91cc\u5df4\u5df4\u5f00\u6e90\u7684\u670d\u52a1\u53d1\u73b0\u548c\u914d\u7f6e\u7ba1\u7406\u5e73\u53f0\u3002"}),"\n",(0,i.jsx)(n.h4,{id:"\u5feb\u901f\u5f00\u59cb",children:"\u5feb\u901f\u5f00\u59cb"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"# \u542f\u52a8 Nacos\uff08\u5355\u673a\u6a21\u5f0f\uff09\ndocker run -d --name nacos \\\n  -e MODE=standalone \\\n  -p 8848:8848 \\\n  nacos/nacos-server:latest\n"})}),"\n",(0,i.jsx)(n.h4,{id:"spring-cloud-\u96c6\u6210",children:"Spring Cloud \u96c6\u6210"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-xml",children:"\x3c!-- pom.xml --\x3e\n<dependency>\n    <groupId>com.alibaba.cloud</groupId>\n    <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>\n</dependency>\n"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"# application.yml\nspring:\n  application:\n    name: user-service\n  cloud:\n    nacos:\n      discovery:\n        server-addr: localhost:8848\n        namespace: dev\n        group: DEFAULT_GROUP\n        cluster-name: BJ\n"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:"@SpringBootApplication\n@EnableDiscoveryClient\npublic class UserServiceApplication {\n    public static void main(String[] args) {\n        SpringApplication.run(UserServiceApplication.class, args);\n    }\n}\n"})}),"\n",(0,i.jsx)(n.h3,{id:"consul",children:"Consul"}),"\n",(0,i.jsx)(n.p,{children:"Consul \u662f HashiCorp \u5f00\u6e90\u7684\u670d\u52a1\u7f51\u683c\u89e3\u51b3\u65b9\u6848\u3002"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"# application.yml\nspring:\n  cloud:\n    consul:\n      host: localhost\n      port: 8500\n      discovery:\n        service-name: ${spring.application.name}\n        health-check-path: /actuator/health\n        health-check-interval: 10s\n"})}),"\n",(0,i.jsx)(n.h3,{id:"\u670d\u52a1\u53d1\u73b0\u5ba2\u6237\u7aef",children:"\u670d\u52a1\u53d1\u73b0\u5ba2\u6237\u7aef"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:'// \u4f7f\u7528 DiscoveryClient\n@Service\npublic class ServiceDiscoveryExample {\n    \n    @Autowired\n    private DiscoveryClient discoveryClient;\n    \n    public List<ServiceInstance> getInstances(String serviceName) {\n        return discoveryClient.getInstances(serviceName);\n    }\n    \n    public String getServiceUrl(String serviceName) {\n        List<ServiceInstance> instances = discoveryClient.getInstances(serviceName);\n        if (instances.isEmpty()) {\n            throw new RuntimeException("No instances available");\n        }\n        ServiceInstance instance = instances.get(0);\n        return instance.getUri().toString();\n    }\n}\n\n// \u4f7f\u7528 OpenFeign\n@FeignClient(name = "user-service")\npublic interface UserClient {\n    \n    @GetMapping("/api/users/{id}")\n    User getUser(@PathVariable("id") Long id);\n    \n    @PostMapping("/api/users")\n    User createUser(@RequestBody UserDTO dto);\n}\n'})}),"\n",(0,i.jsx)(n.h2,{id:"\u914d\u7f6e\u4e2d\u5fc3",children:"\u914d\u7f6e\u4e2d\u5fc3"}),"\n",(0,i.jsx)(n.h3,{id:"nacos-config",children:"Nacos Config"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-xml",children:"<dependency>\n    <groupId>com.alibaba.cloud</groupId>\n    <artifactId>spring-cloud-starter-alibaba-nacos-config</artifactId>\n</dependency>\n"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"# bootstrap.yml\nspring:\n  application:\n    name: user-service\n  cloud:\n    nacos:\n      config:\n        server-addr: localhost:8848\n        namespace: dev\n        group: DEFAULT_GROUP\n        file-extension: yaml\n        shared-configs:\n          - data-id: common.yaml\n            group: DEFAULT_GROUP\n            refresh: true\n"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:'// \u52a8\u6001\u5237\u65b0\u914d\u7f6e\n@RestController\n@RefreshScope\npublic class ConfigController {\n    \n    @Value("${app.feature.enabled:false}")\n    private boolean featureEnabled;\n    \n    @GetMapping("/config")\n    public Map<String, Object> getConfig() {\n        return Map.of("featureEnabled", featureEnabled);\n    }\n}\n\n// \u76d1\u542c\u914d\u7f6e\u53d8\u5316\n@Component\npublic class ConfigChangeListener {\n    \n    @NacosConfigListener(dataId = "user-service.yaml", groupId = "DEFAULT_GROUP")\n    public void onConfigChange(String config) {\n        log.info("\u914d\u7f6e\u53d1\u751f\u53d8\u5316: {}", config);\n    }\n}\n'})}),"\n",(0,i.jsx)(n.h3,{id:"apollo",children:"Apollo"}),"\n",(0,i.jsx)(n.p,{children:"Apollo \u662f\u643a\u7a0b\u5f00\u6e90\u7684\u914d\u7f6e\u7ba1\u7406\u4e2d\u5fc3\u3002"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"# application.yml\napollo:\n  meta: http://localhost:8080\n  bootstrap:\n    enabled: true\n    namespaces: application,common\n"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:'@Configuration\n@EnableApolloConfig\npublic class ApolloConfig {\n    \n    @ApolloConfig\n    private Config config;\n    \n    @ApolloConfigChangeListener\n    public void onChange(ConfigChangeEvent event) {\n        for (String key : event.changedKeys()) {\n            ConfigChange change = event.getChange(key);\n            log.info("\u914d\u7f6e\u53d8\u66f4 - key: {}, old: {}, new: {}", \n                key, change.getOldValue(), change.getNewValue());\n        }\n    }\n}\n'})}),"\n",(0,i.jsx)(n.h2,{id:"\u8d1f\u8f7d\u5747\u8861",children:"\u8d1f\u8f7d\u5747\u8861"}),"\n",(0,i.jsx)(n.h3,{id:"\u8d1f\u8f7d\u5747\u8861\u7b56\u7565",children:"\u8d1f\u8f7d\u5747\u8861\u7b56\u7565"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"\u7b56\u7565"}),(0,i.jsx)(n.th,{children:"\u8bf4\u660e"}),(0,i.jsx)(n.th,{children:"\u9002\u7528\u573a\u666f"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"\u8f6e\u8be2\uff08Round Robin\uff09"})}),(0,i.jsx)(n.td,{children:"\u4f9d\u6b21\u5206\u914d\u8bf7\u6c42"}),(0,i.jsx)(n.td,{children:"\u670d\u52a1\u5668\u6027\u80fd\u76f8\u8fd1"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"\u52a0\u6743\u8f6e\u8be2"})}),(0,i.jsx)(n.td,{children:"\u6309\u6743\u91cd\u5206\u914d"}),(0,i.jsx)(n.td,{children:"\u670d\u52a1\u5668\u6027\u80fd\u4e0d\u540c"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"\u968f\u673a"})}),(0,i.jsx)(n.td,{children:"\u968f\u673a\u9009\u62e9"}),(0,i.jsx)(n.td,{children:"\u7b80\u5355\u573a\u666f"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"\u6700\u5c11\u8fde\u63a5"})}),(0,i.jsx)(n.td,{children:"\u9009\u62e9\u8fde\u63a5\u6570\u6700\u5c11\u7684"}),(0,i.jsx)(n.td,{children:"\u957f\u8fde\u63a5\u573a\u666f"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"\u4e00\u81f4\u6027\u54c8\u5e0c"})}),(0,i.jsx)(n.td,{children:"\u76f8\u540c\u8bf7\u6c42\u5230\u76f8\u540c\u670d\u52a1\u5668"}),(0,i.jsx)(n.td,{children:"\u9700\u8981\u4f1a\u8bdd\u4fdd\u6301"})]})]})]}),"\n",(0,i.jsx)(n.h3,{id:"spring-cloud-loadbalancer",children:"Spring Cloud LoadBalancer"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:'// \u81ea\u5b9a\u4e49\u8d1f\u8f7d\u5747\u8861\u7b56\u7565\n@Configuration\npublic class LoadBalancerConfig {\n    \n    @Bean\n    public ReactorLoadBalancer<ServiceInstance> randomLoadBalancer(\n            Environment environment,\n            LoadBalancerClientFactory clientFactory) {\n        String name = environment.getProperty(LoadBalancerClientFactory.PROPERTY_NAME);\n        return new RandomLoadBalancer(\n            clientFactory.getLazyProvider(name, ServiceInstanceListSupplier.class),\n            name\n        );\n    }\n}\n\n// \u4f7f\u7528 @LoadBalanced\n@Configuration\npublic class RestTemplateConfig {\n    \n    @Bean\n    @LoadBalanced\n    public RestTemplate restTemplate() {\n        return new RestTemplate();\n    }\n}\n\n@Service\npublic class OrderService {\n    \n    @Autowired\n    private RestTemplate restTemplate;\n    \n    public User getUser(Long userId) {\n        // \u81ea\u52a8\u8d1f\u8f7d\u5747\u8861\n        return restTemplate.getForObject(\n            "http://user-service/api/users/" + userId,\n            User.class\n        );\n    }\n}\n'})}),"\n",(0,i.jsx)(n.h3,{id:"ribbon-\u914d\u7f6e\u65e7\u7248\u672c",children:"Ribbon \u914d\u7f6e\uff08\u65e7\u7248\u672c\uff09"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"user-service:\n  ribbon:\n    NFLoadBalancerRuleClassName: com.netflix.loadbalancer.WeightedResponseTimeRule\n    ConnectTimeout: 1000\n    ReadTimeout: 3000\n    MaxAutoRetries: 1\n    MaxAutoRetriesNextServer: 2\n"})}),"\n",(0,i.jsx)(n.h2,{id:"\u9650\u6d41",children:"\u9650\u6d41"}),"\n",(0,i.jsx)(n.h3,{id:"\u9650\u6d41\u7b97\u6cd5",children:"\u9650\u6d41\u7b97\u6cd5"}),"\n",(0,i.jsx)(n.mermaid,{value:"graph LR\n    subgraph \u4ee4\u724c\u6876\n        A[\u8bf7\u6c42] --\x3e B{\u6709\u4ee4\u724c?}\n        B --\x3e|\u662f| C[\u5904\u7406\u8bf7\u6c42]\n        B --\x3e|\u5426| D[\u62d2\u7edd/\u7b49\u5f85]\n        E[\u5b9a\u65f6\u6dfb\u52a0\u4ee4\u724c] --\x3e F[\u4ee4\u724c\u6876]\n    end"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"\u7b97\u6cd5"}),(0,i.jsx)(n.th,{children:"\u8bf4\u660e"}),(0,i.jsx)(n.th,{children:"\u7279\u70b9"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"\u8ba1\u6570\u5668"})}),(0,i.jsx)(n.td,{children:"\u56fa\u5b9a\u7a97\u53e3\u8ba1\u6570"}),(0,i.jsx)(n.td,{children:"\u7b80\u5355\uff0c\u6709\u4e34\u754c\u95ee\u9898"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"\u6ed1\u52a8\u7a97\u53e3"})}),(0,i.jsx)(n.td,{children:"\u6ed1\u52a8\u65f6\u95f4\u7a97\u53e3"}),(0,i.jsx)(n.td,{children:"\u5e73\u6ed1\uff0c\u8f83\u590d\u6742"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"\u6f0f\u6876"})}),(0,i.jsx)(n.td,{children:"\u56fa\u5b9a\u901f\u7387\u5904\u7406"}),(0,i.jsx)(n.td,{children:"\u5e73\u6ed1\u8f93\u51fa"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"\u4ee4\u724c\u6876"})}),(0,i.jsx)(n.td,{children:"\u4ee4\u724c\u63a7\u5236\u901f\u7387"}),(0,i.jsx)(n.td,{children:"\u5141\u8bb8\u7a81\u53d1\u6d41\u91cf"})]})]})]}),"\n",(0,i.jsx)(n.h3,{id:"sentinel-\u9650\u6d41",children:"Sentinel \u9650\u6d41"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-xml",children:"<dependency>\n    <groupId>com.alibaba.cloud</groupId>\n    <artifactId>spring-cloud-starter-alibaba-sentinel</artifactId>\n</dependency>\n"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:'// \u4f7f\u7528\u6ce8\u89e3\n@RestController\npublic class UserController {\n    \n    @GetMapping("/users/{id}")\n    @SentinelResource(value = "getUser", \n        blockHandler = "getUserBlockHandler",\n        fallback = "getUserFallback")\n    public User getUser(@PathVariable Long id) {\n        return userService.findById(id);\n    }\n    \n    // \u9650\u6d41\u5904\u7406\n    public User getUserBlockHandler(Long id, BlockException e) {\n        return new User(id, "\u9650\u6d41\u7528\u6237", "\u8bf7\u6c42\u88ab\u9650\u6d41");\n    }\n    \n    // \u964d\u7ea7\u5904\u7406\n    public User getUserFallback(Long id, Throwable t) {\n        return new User(id, "\u964d\u7ea7\u7528\u6237", "\u670d\u52a1\u964d\u7ea7");\n    }\n}\n\n// \u7f16\u7a0b\u5f0f\u914d\u7f6e\n@PostConstruct\npublic void initFlowRules() {\n    List<FlowRule> rules = new ArrayList<>();\n    \n    FlowRule rule = new FlowRule();\n    rule.setResource("getUser");\n    rule.setGrade(RuleConstant.FLOW_GRADE_QPS);\n    rule.setCount(100);  // QPS \u9650\u5236\n    rule.setControlBehavior(RuleConstant.CONTROL_BEHAVIOR_WARM_UP);\n    rule.setWarmUpPeriodSec(10);\n    \n    rules.add(rule);\n    FlowRuleManager.loadRules(rules);\n}\n'})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"# application.yml\nspring:\n  cloud:\n    sentinel:\n      transport:\n        dashboard: localhost:8080\n      datasource:\n        flow:\n          nacos:\n            server-addr: localhost:8848\n            dataId: ${spring.application.name}-flow-rules\n            groupId: SENTINEL_GROUP\n            rule-type: flow\n"})}),"\n",(0,i.jsx)(n.h2,{id:"\u7194\u65ad\u964d\u7ea7",children:"\u7194\u65ad\u964d\u7ea7"}),"\n",(0,i.jsx)(n.h3,{id:"sentinel-\u7194\u65ad",children:"Sentinel \u7194\u65ad"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:'// \u7194\u65ad\u89c4\u5219\u914d\u7f6e\n@PostConstruct\npublic void initDegradeRules() {\n    List<DegradeRule> rules = new ArrayList<>();\n    \n    DegradeRule rule = new DegradeRule();\n    rule.setResource("getUser");\n    rule.setGrade(CircuitBreakerStrategy.SLOW_REQUEST_RATIO.getType());\n    rule.setCount(0.5);  // \u6162\u8c03\u7528\u6bd4\u4f8b\u9608\u503c\n    rule.setTimeWindow(30);  // \u7194\u65ad\u65f6\u957f\uff08\u79d2\uff09\n    rule.setMinRequestAmount(5);  // \u6700\u5c0f\u8bf7\u6c42\u6570\n    rule.setStatIntervalMs(10000);  // \u7edf\u8ba1\u65f6\u957f\n    rule.setSlowRatioThreshold(0.5);  // \u6162\u8c03\u7528\u6bd4\u4f8b\n    \n    rules.add(rule);\n    DegradeRuleManager.loadRules(rules);\n}\n'})}),"\n",(0,i.jsx)(n.h3,{id:"resilience4j-\u7194\u65ad",children:"Resilience4j \u7194\u65ad"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"resilience4j:\n  circuitbreaker:\n    instances:\n      userService:\n        registerHealthIndicator: true\n        slidingWindowSize: 10\n        minimumNumberOfCalls: 5\n        failureRateThreshold: 50\n        waitDurationInOpenState: 30s\n        permittedNumberOfCallsInHalfOpenState: 3\n        slowCallRateThreshold: 100\n        slowCallDurationThreshold: 2s\n  \n  retry:\n    instances:\n      userService:\n        maxAttempts: 3\n        waitDuration: 1s\n        retryExceptions:\n          - java.io.IOException\n  \n  ratelimiter:\n    instances:\n      userService:\n        limitForPeriod: 10\n        limitRefreshPeriod: 1s\n        timeoutDuration: 500ms\n"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:'@Service\npublic class UserService {\n    \n    @CircuitBreaker(name = "userService", fallbackMethod = "fallback")\n    @Retry(name = "userService")\n    @RateLimiter(name = "userService")\n    public User getUser(Long id) {\n        return userClient.getUser(id);\n    }\n    \n    public User fallback(Long id, Exception e) {\n        log.warn("\u670d\u52a1\u964d\u7ea7: {}", e.getMessage());\n        return new User(id, "\u964d\u7ea7\u7528\u6237", "\u670d\u52a1\u6682\u65f6\u4e0d\u53ef\u7528");\n    }\n}\n'})}),"\n",(0,i.jsx)(n.h2,{id:"\u670d\u52a1\u6cbb\u7406\u6700\u4f73\u5b9e\u8df5",children:"\u670d\u52a1\u6cbb\u7406\u6700\u4f73\u5b9e\u8df5"}),"\n",(0,i.jsx)(n.h3,{id:"\u5065\u5eb7\u68c0\u67e5",children:"\u5065\u5eb7\u68c0\u67e5"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:'@Component\npublic class CustomHealthIndicator implements HealthIndicator {\n    \n    @Override\n    public Health health() {\n        // \u68c0\u67e5\u4f9d\u8d56\u670d\u52a1\n        boolean dbHealthy = checkDatabase();\n        boolean redisHealthy = checkRedis();\n        \n        if (dbHealthy && redisHealthy) {\n            return Health.up()\n                .withDetail("database", "UP")\n                .withDetail("redis", "UP")\n                .build();\n        }\n        \n        return Health.down()\n            .withDetail("database", dbHealthy ? "UP" : "DOWN")\n            .withDetail("redis", redisHealthy ? "UP" : "DOWN")\n            .build();\n    }\n}\n'})}),"\n",(0,i.jsx)(n.h3,{id:"\u4f18\u96c5\u505c\u673a",children:"\u4f18\u96c5\u505c\u673a"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"# application.yml\nserver:\n  shutdown: graceful\n\nspring:\n  lifecycle:\n    timeout-per-shutdown-phase: 30s\n"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:'@Component\npublic class GracefulShutdown implements ApplicationListener<ContextClosedEvent> {\n    \n    @Override\n    public void onApplicationEvent(ContextClosedEvent event) {\n        log.info("\u5f00\u59cb\u4f18\u96c5\u505c\u673a...");\n        // 1. \u4ece\u6ce8\u518c\u4e2d\u5fc3\u6ce8\u9500\n        // 2. \u7b49\u5f85\u6b63\u5728\u5904\u7406\u7684\u8bf7\u6c42\u5b8c\u6210\n        // 3. \u5173\u95ed\u8fde\u63a5\u6c60\n        log.info("\u4f18\u96c5\u505c\u673a\u5b8c\u6210");\n    }\n}\n'})})]})}function u(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(o,{...e})}):o(e)}}}]);