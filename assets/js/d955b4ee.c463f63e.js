"use strict";(globalThis.webpackChunkto_lib_github_io=globalThis.webpackChunkto_lib_github_io||[]).push([[10488],{48450:(n,e,r)=>{r.r(e),r.d(e,{assets:()=>c,contentTitle:()=>a,default:()=>h,frontMatter:()=>s,metadata:()=>i,toc:()=>o});const i=JSON.parse('{"id":"docker/image-internals","title":"\u955c\u50cf\u539f\u7406","description":"Docker \u955c\u50cf\u5c42\u539f\u7406\u3001Union FS \u4e0e Copy-on-Write \u673a\u5236","source":"@site/docs/docker/image-internals.md","sourceDirName":"docker","slug":"/docker/image-internals","permalink":"/docs/docker/image-internals","draft":false,"unlisted":false,"editUrl":"https://github.com/to-lib/to-lib.github.io/tree/main/docs/docker/image-internals.md","tags":[],"version":"current","sidebarPosition":18,"frontMatter":{"sidebar_position":18,"title":"\u955c\u50cf\u539f\u7406","description":"Docker \u955c\u50cf\u5c42\u539f\u7406\u3001Union FS \u4e0e Copy-on-Write \u673a\u5236"}}');var l=r(22714),d=r(48885);const s={sidebar_position:18,title:"\u955c\u50cf\u539f\u7406",description:"Docker \u955c\u50cf\u5c42\u539f\u7406\u3001Union FS \u4e0e Copy-on-Write \u673a\u5236"},a="\u955c\u50cf\u539f\u7406",c={},o=[{value:"\u955c\u50cf\u5c42\u7ed3\u6784",id:"\u955c\u50cf\u5c42\u7ed3\u6784",level:2},{value:"\u67e5\u770b\u955c\u50cf\u5c42",id:"\u67e5\u770b\u955c\u50cf\u5c42",level:3},{value:"Union File System",id:"union-file-system",level:2},{value:"\u5b58\u50a8\u9a71\u52a8\u7c7b\u578b",id:"\u5b58\u50a8\u9a71\u52a8\u7c7b\u578b",level:3},{value:"\u67e5\u770b\u5f53\u524d\u5b58\u50a8\u9a71\u52a8",id:"\u67e5\u770b\u5f53\u524d\u5b58\u50a8\u9a71\u52a8",level:3},{value:"overlay2 \u5de5\u4f5c\u539f\u7406",id:"overlay2-\u5de5\u4f5c\u539f\u7406",level:3},{value:"\u67e5\u770b overlay2 \u76ee\u5f55\u7ed3\u6784",id:"\u67e5\u770b-overlay2-\u76ee\u5f55\u7ed3\u6784",level:3},{value:"Copy-on-Write (CoW)",id:"copy-on-write-cow",level:2},{value:"CoW \u5de5\u4f5c\u6d41\u7a0b",id:"cow-\u5de5\u4f5c\u6d41\u7a0b",level:3},{value:"\u9a8c\u8bc1 CoW \u884c\u4e3a",id:"\u9a8c\u8bc1-cow-\u884c\u4e3a",level:3},{value:"Whiteout \u6587\u4ef6",id:"whiteout-\u6587\u4ef6",level:3},{value:"\u955c\u50cf\u5185\u5bb9\u5bfb\u5740",id:"\u955c\u50cf\u5185\u5bb9\u5bfb\u5740",level:2},{value:"\u955c\u50cf ID \u4e0e Digest",id:"\u955c\u50cf-id-\u4e0e-digest",level:3},{value:"\u5c42\u7684\u5185\u5bb9\u5bfb\u5740",id:"\u5c42\u7684\u5185\u5bb9\u5bfb\u5740",level:3},{value:"\u955c\u50cf\u7626\u8eab",id:"\u955c\u50cf\u7626\u8eab",level:2},{value:"\u4f7f\u7528 dive \u5206\u6790\u955c\u50cf",id:"\u4f7f\u7528-dive-\u5206\u6790\u955c\u50cf",level:3},{value:"\u5e38\u89c1\u7626\u8eab\u6280\u5de7",id:"\u5e38\u89c1\u7626\u8eab\u6280\u5de7",level:3},{value:"\u4f7f\u7528 docker-slim",id:"\u4f7f\u7528-docker-slim",level:3},{value:"Distroless \u955c\u50cf",id:"distroless-\u955c\u50cf",level:3},{value:"\u955c\u50cf\u5c42\u4f18\u5316",id:"\u955c\u50cf\u5c42\u4f18\u5316",level:2},{value:"\u5229\u7528\u6784\u5efa\u7f13\u5b58",id:"\u5229\u7528\u6784\u5efa\u7f13\u5b58",level:3},{value:"\u51cf\u5c11\u5c42\u6570",id:"\u51cf\u5c11\u5c42\u6570",level:3},{value:"\u907f\u514d\u5728\u955c\u50cf\u4e2d\u5b58\u50a8\u654f\u611f\u4fe1\u606f",id:"\u907f\u514d\u5728\u955c\u50cf\u4e2d\u5b58\u50a8\u654f\u611f\u4fe1\u606f",level:3},{value:"\u955c\u50cf\u5b58\u50a8\u7ba1\u7406",id:"\u955c\u50cf\u5b58\u50a8\u7ba1\u7406",level:2}];function t(n){const e={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,d.R)(),...n.components};return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(e.header,{children:(0,l.jsx)(e.h1,{id:"\u955c\u50cf\u539f\u7406",children:"\u955c\u50cf\u539f\u7406"})}),"\n",(0,l.jsx)(e.p,{children:"\u6df1\u5165\u7406\u89e3 Docker \u955c\u50cf\u7684\u5185\u90e8\u7ed3\u6784\u548c\u5de5\u4f5c\u539f\u7406\u3002"}),"\n",(0,l.jsx)(e.h2,{id:"\u955c\u50cf\u5c42\u7ed3\u6784",children:"\u955c\u50cf\u5c42\u7ed3\u6784"}),"\n",(0,l.jsx)(e.p,{children:"Docker \u955c\u50cf\u7531\u591a\u4e2a\u53ea\u8bfb\u5c42\uff08Layer\uff09\u7ec4\u6210\uff0c\u6bcf\u4e00\u5c42\u4ee3\u8868 Dockerfile \u4e2d\u7684\u4e00\u6761\u6307\u4ee4\u3002"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{children:"\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502         Container Layer (R/W)       \u2502  \u2190 \u5bb9\u5668\u53ef\u5199\u5c42\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502         Layer 4: CMD                \u2502  \u2190 \u53ea\u8bfb\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502         Layer 3: COPY app           \u2502  \u2190 \u53ea\u8bfb\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502         Layer 2: RUN npm install    \u2502  \u2190 \u53ea\u8bfb\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502         Layer 1: FROM node:18       \u2502  \u2190 \u53ea\u8bfb\uff08\u57fa\u7840\u955c\u50cf\uff09\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"})}),"\n",(0,l.jsx)(e.h3,{id:"\u67e5\u770b\u955c\u50cf\u5c42",children:"\u67e5\u770b\u955c\u50cf\u5c42"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-bash",children:"# \u67e5\u770b\u955c\u50cf\u5386\u53f2\uff08\u6bcf\u5c42\u5bf9\u5e94\u4e00\u6761\u6307\u4ee4\uff09\ndocker history nginx\n\n# \u8be6\u7ec6\u67e5\u770b\u955c\u50cf\u5c42\ndocker inspect nginx --format '{{json .RootFS.Layers}}' | jq\n\n# \u67e5\u770b\u955c\u50cf\u5927\u5c0f\u5206\u5e03\ndocker history nginx --format \"{{.Size}}\\t{{.CreatedBy}}\"\n"})}),"\n",(0,l.jsx)(e.h2,{id:"union-file-system",children:"Union File System"}),"\n",(0,l.jsx)(e.p,{children:"Union FS \u5141\u8bb8\u5c06\u591a\u4e2a\u76ee\u5f55\uff08\u5c42\uff09\u8054\u5408\u6302\u8f7d\u5230\u540c\u4e00\u4e2a\u6302\u8f7d\u70b9\uff0c\u5448\u73b0\u4e3a\u7edf\u4e00\u7684\u6587\u4ef6\u7cfb\u7edf\u89c6\u56fe\u3002"}),"\n",(0,l.jsx)(e.h3,{id:"\u5b58\u50a8\u9a71\u52a8\u7c7b\u578b",children:"\u5b58\u50a8\u9a71\u52a8\u7c7b\u578b"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,l.jsxs)(e.table,{children:[(0,l.jsx)(e.thead,{children:(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.th,{children:"\u9a71\u52a8"}),(0,l.jsx)(e.th,{children:"\u8bf4\u660e"}),(0,l.jsx)(e.th,{children:"\u9002\u7528\u573a\u666f"})]})}),(0,l.jsxs)(e.tbody,{children:[(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:(0,l.jsx)(e.strong,{children:"overlay2"})}),(0,l.jsx)(e.td,{children:"\u63a8\u8350\uff0c\u6027\u80fd\u6700\u4f73"}),(0,l.jsx)(e.td,{children:"Linux 4.0+"})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:(0,l.jsx)(e.strong,{children:"fuse-overlayfs"})}),(0,l.jsx)(e.td,{children:"\u7528\u4e8e rootless \u6a21\u5f0f"}),(0,l.jsx)(e.td,{children:"\u65e0 root \u6743\u9650"})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:(0,l.jsx)(e.strong,{children:"btrfs"})}),(0,l.jsx)(e.td,{children:"\u9700\u8981 btrfs \u6587\u4ef6\u7cfb\u7edf"}),(0,l.jsx)(e.td,{children:"\u4f7f\u7528 btrfs \u7684\u7cfb\u7edf"})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:(0,l.jsx)(e.strong,{children:"zfs"})}),(0,l.jsx)(e.td,{children:"\u9700\u8981 zfs \u6587\u4ef6\u7cfb\u7edf"}),(0,l.jsx)(e.td,{children:"\u4f7f\u7528 zfs \u7684\u7cfb\u7edf"})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:(0,l.jsx)(e.strong,{children:"vfs"})}),(0,l.jsx)(e.td,{children:"\u65e0 CoW\uff0c\u4ec5\u7528\u4e8e\u6d4b\u8bd5"}),(0,l.jsx)(e.td,{children:"\u8c03\u8bd5\u7528\u9014"})]})]})]}),"\n",(0,l.jsx)(e.h3,{id:"\u67e5\u770b\u5f53\u524d\u5b58\u50a8\u9a71\u52a8",children:"\u67e5\u770b\u5f53\u524d\u5b58\u50a8\u9a71\u52a8"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-bash",children:'docker info | grep "Storage Driver"\n# Storage Driver: overlay2\n'})}),"\n",(0,l.jsx)(e.h3,{id:"overlay2-\u5de5\u4f5c\u539f\u7406",children:"overlay2 \u5de5\u4f5c\u539f\u7406"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{children:"\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502              Merged View (\u5bb9\u5668\u770b\u5230\u7684)            \u2502\n\u2502  /app/index.js  /etc/nginx.conf  /var/log/...  \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                        \u25b2\n                        \u2502 Union Mount\n        \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n        \u2502               \u2502               \u2502\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u250c\u2500\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2510 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502   UpperDir    \u2502 \u2502  WorkDir  \u2502 \u2502   LowerDir    \u2502\n\u2502   (\u53ef\u5199\u5c42)     \u2502 \u2502  (\u5de5\u4f5c\u533a)  \u2502 \u2502   (\u53ea\u8bfb\u5c42)    \u2502\n\u2502 /var/lib/...  \u2502 \u2502           \u2502 \u2502 layer1+layer2 \u2502\n\u2502 /diff         \u2502 \u2502           \u2502 \u2502    +layer3    \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"})}),"\n",(0,l.jsx)(e.h3,{id:"\u67e5\u770b-overlay2-\u76ee\u5f55\u7ed3\u6784",children:"\u67e5\u770b overlay2 \u76ee\u5f55\u7ed3\u6784"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-bash",children:'# \u67e5\u770b\u955c\u50cf\u5b58\u50a8\u4f4d\u7f6e\nls /var/lib/docker/overlay2/\n\n# \u67e5\u770b\u7279\u5b9a\u5bb9\u5668\u7684 overlay \u6302\u8f7d\ndocker inspect container_name --format \'{{json .GraphDriver.Data}}\' | jq\n\n# \u8f93\u51fa\u793a\u4f8b\n{\n  "LowerDir": "/var/lib/docker/overlay2/abc.../diff:/var/lib/docker/overlay2/def.../diff",\n  "MergedDir": "/var/lib/docker/overlay2/xyz.../merged",\n  "UpperDir": "/var/lib/docker/overlay2/xyz.../diff",\n  "WorkDir": "/var/lib/docker/overlay2/xyz.../work"\n}\n'})}),"\n",(0,l.jsx)(e.h2,{id:"copy-on-write-cow",children:"Copy-on-Write (CoW)"}),"\n",(0,l.jsx)(e.p,{children:"CoW \u673a\u5236\u786e\u4fdd\u53ea\u6709\u5728\u6587\u4ef6\u88ab\u4fee\u6539\u65f6\u624d\u4f1a\u590d\u5236\u5230\u53ef\u5199\u5c42\u3002"}),"\n",(0,l.jsx)(e.h3,{id:"cow-\u5de5\u4f5c\u6d41\u7a0b",children:"CoW \u5de5\u4f5c\u6d41\u7a0b"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{children:"\u8bfb\u53d6\u6587\u4ef6:\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 \u5bb9\u5668\u8bfb\u53d6    \u2502 \u2192 \u4ece\u6700\u4e0a\u5c42\u5f00\u59cb\u67e5\u627e \u2192 \u627e\u5230\u540e\u76f4\u63a5\u8bfb\u53d6\n\u2502 /etc/hosts  \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\n\u4fee\u6539\u6587\u4ef6:\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 \u5bb9\u5668\u4fee\u6539    \u2502 \u2192 \u4ece\u53ea\u8bfb\u5c42\u590d\u5236\u5230\u53ef\u5199\u5c42 \u2192 \u5728\u53ef\u5199\u5c42\u4fee\u6539\n\u2502 /etc/hosts  \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\n\u5220\u9664\u6587\u4ef6:\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 \u5bb9\u5668\u5220\u9664    \u2502 \u2192 \u5728\u53ef\u5199\u5c42\u521b\u5efa whiteout \u6587\u4ef6 \u2192 \u906e\u76d6\u4e0b\u5c42\u6587\u4ef6\n\u2502 /etc/hosts  \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"})}),"\n",(0,l.jsx)(e.h3,{id:"\u9a8c\u8bc1-cow-\u884c\u4e3a",children:"\u9a8c\u8bc1 CoW \u884c\u4e3a"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-bash",children:"# \u521b\u5efa\u5bb9\u5668\ndocker run -d --name test nginx\n\n# \u67e5\u770b\u521d\u59cb\u53ef\u5199\u5c42\u5927\u5c0f\ndocker ps -s\n# SIZE: 0B (virtual 187MB)\n\n# \u5728\u5bb9\u5668\u4e2d\u521b\u5efa\u6587\u4ef6\ndocker exec test dd if=/dev/zero of=/test.img bs=1M count=100\n\n# \u518d\u6b21\u67e5\u770b\u5927\u5c0f\ndocker ps -s\n# SIZE: 105MB (virtual 292MB)\n\n# \u67e5\u770b\u53ef\u5199\u5c42\u5185\u5bb9\ndocker diff test\n# C /\n# A /test.img\n"})}),"\n",(0,l.jsx)(e.h3,{id:"whiteout-\u6587\u4ef6",children:"Whiteout \u6587\u4ef6"}),"\n",(0,l.jsx)(e.p,{children:"\u5220\u9664\u6587\u4ef6\u65f6\uff0coverlay2 \u4f7f\u7528 whiteout \u6587\u4ef6\u6807\u8bb0\u5220\u9664\u3002"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-bash",children:"# \u5728\u5bb9\u5668\u4e2d\u5220\u9664\u6587\u4ef6\ndocker exec test rm /etc/nginx/nginx.conf\n\n# \u67e5\u770b\u53d8\u66f4\ndocker diff test\n# D /etc/nginx/nginx.conf\n\n# \u5728 upperdir \u4e2d\u4f1a\u770b\u5230 whiteout \u6587\u4ef6\n# \u6587\u4ef6\u540d\u683c\u5f0f: .wh.<filename>\n"})}),"\n",(0,l.jsx)(e.h2,{id:"\u955c\u50cf\u5185\u5bb9\u5bfb\u5740",children:"\u955c\u50cf\u5185\u5bb9\u5bfb\u5740"}),"\n",(0,l.jsx)(e.p,{children:"Docker \u4f7f\u7528\u5185\u5bb9\u5bfb\u5740\u5b58\u50a8\uff08Content-Addressable Storage\uff09\u3002"}),"\n",(0,l.jsx)(e.h3,{id:"\u955c\u50cf-id-\u4e0e-digest",children:"\u955c\u50cf ID \u4e0e Digest"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-bash",children:"# \u955c\u50cf ID\uff08\u672c\u5730\u6807\u8bc6\uff09\ndocker images --digests nginx\n# REPOSITORY  TAG     DIGEST                                                                    IMAGE ID\n# nginx       latest  sha256:abc123...                                                          def456...\n\n# Digest \u662f\u955c\u50cf\u5185\u5bb9\u7684 SHA256 \u54c8\u5e0c\n# \u76f8\u540c\u5185\u5bb9\u7684\u955c\u50cf\u5728\u4efb\u4f55\u5730\u65b9\u90fd\u6709\u76f8\u540c\u7684 digest\n"})}),"\n",(0,l.jsx)(e.h3,{id:"\u5c42\u7684\u5185\u5bb9\u5bfb\u5740",children:"\u5c42\u7684\u5185\u5bb9\u5bfb\u5740"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-bash",children:'# \u67e5\u770b\u955c\u50cf\u5c42\u7684 digest\ndocker inspect nginx --format \'{{json .RootFS.Layers}}\' | jq\n# [\n#   "sha256:aaa...",\n#   "sha256:bbb...",\n#   "sha256:ccc..."\n# ]\n\n# \u76f8\u540c\u7684\u5c42\u5728\u4e0d\u540c\u955c\u50cf\u95f4\u5171\u4eab\n'})}),"\n",(0,l.jsx)(e.h2,{id:"\u955c\u50cf\u7626\u8eab",children:"\u955c\u50cf\u7626\u8eab"}),"\n",(0,l.jsx)(e.h3,{id:"\u4f7f\u7528-dive-\u5206\u6790\u955c\u50cf",children:"\u4f7f\u7528 dive \u5206\u6790\u955c\u50cf"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-bash",children:"# \u5b89\u88c5 dive\nbrew install dive  # macOS\n# \u6216\ndocker run --rm -it \\\n  -v /var/run/docker.sock:/var/run/docker.sock \\\n  wagoodman/dive:latest myimage:tag\n\n# \u5206\u6790\u955c\u50cf\ndive myimage:tag\n"})}),"\n",(0,l.jsx)(e.p,{children:"dive \u754c\u9762\u8bf4\u660e\uff1a"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u5de6\u4fa7\uff1a\u955c\u50cf\u5c42\u5217\u8868\u548c\u5927\u5c0f"}),"\n",(0,l.jsx)(e.li,{children:"\u53f3\u4fa7\uff1a\u6bcf\u5c42\u7684\u6587\u4ef6\u53d8\u66f4"}),"\n",(0,l.jsx)(e.li,{children:"\u5e95\u90e8\uff1a\u955c\u50cf\u6548\u7387\u8bc4\u5206"}),"\n"]}),"\n",(0,l.jsx)(e.h3,{id:"\u5e38\u89c1\u7626\u8eab\u6280\u5de7",children:"\u5e38\u89c1\u7626\u8eab\u6280\u5de7"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-dockerfile",children:"# 1. \u4f7f\u7528 Alpine \u57fa\u7840\u955c\u50cf\nFROM node:18-alpine  # ~50MB vs node:18 ~350MB\n\n# 2. \u591a\u9636\u6bb5\u6784\u5efa\nFROM node:18 AS builder\nWORKDIR /app\nCOPY package*.json ./\nRUN npm ci\nCOPY . .\nRUN npm run build\n\nFROM node:18-alpine\nCOPY --from=builder /app/dist ./dist\nCOPY --from=builder /app/node_modules ./node_modules\n\n# 3. \u5408\u5e76 RUN \u6307\u4ee4\u5e76\u6e05\u7406\u7f13\u5b58\nRUN apt-get update && \\\n    apt-get install -y --no-install-recommends curl && \\\n    rm -rf /var/lib/apt/lists/*\n\n# 4. \u4f7f\u7528 .dockerignore\n# .dockerignore\nnode_modules\n.git\n*.md\nDockerfile\n\n# 5. \u53ea\u590d\u5236\u5fc5\u8981\u6587\u4ef6\nCOPY package*.json ./\nCOPY src/ ./src/\n# \u800c\u4e0d\u662f COPY . .\n"})}),"\n",(0,l.jsx)(e.h3,{id:"\u4f7f\u7528-docker-slim",children:"\u4f7f\u7528 docker-slim"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-bash",children:"# \u5b89\u88c5 docker-slim\nbrew install docker-slim  # macOS\n\n# \u5206\u6790\u955c\u50cf\ndocker-slim xray myimage:tag\n\n# \u81ea\u52a8\u7626\u8eab\uff08\u4f1a\u8fd0\u884c\u5bb9\u5668\u8fdb\u884c\u5206\u6790\uff09\ndocker-slim build myimage:tag\n\n# \u6307\u5b9a\u8981\u4fdd\u7559\u7684\u8def\u5f84\ndocker-slim build --include-path=/app --include-path=/etc myimage:tag\n"})}),"\n",(0,l.jsx)(e.h3,{id:"distroless-\u955c\u50cf",children:"Distroless \u955c\u50cf"}),"\n",(0,l.jsx)(e.p,{children:"Google \u63d0\u4f9b\u7684\u6700\u5c0f\u5316\u955c\u50cf\uff0c\u53ea\u5305\u542b\u5e94\u7528\u8fd0\u884c\u65f6\u3002"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-dockerfile",children:'# Java \u5e94\u7528\nFROM gcr.io/distroless/java17-debian11\nCOPY target/app.jar /app.jar\nCMD ["app.jar"]\n\n# Node.js \u5e94\u7528\nFROM gcr.io/distroless/nodejs18-debian11\nCOPY --from=builder /app/dist /app\nWORKDIR /app\nCMD ["index.js"]\n\n# \u9759\u6001\u4e8c\u8fdb\u5236\nFROM gcr.io/distroless/static-debian11\nCOPY myapp /\nCMD ["/myapp"]\n'})}),"\n",(0,l.jsx)(e.h2,{id:"\u955c\u50cf\u5c42\u4f18\u5316",children:"\u955c\u50cf\u5c42\u4f18\u5316"}),"\n",(0,l.jsx)(e.h3,{id:"\u5229\u7528\u6784\u5efa\u7f13\u5b58",children:"\u5229\u7528\u6784\u5efa\u7f13\u5b58"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-dockerfile",children:"# \u2705 \u597d\u7684\u505a\u6cd5\uff1a\u4f9d\u8d56\u6587\u4ef6\u5148\u590d\u5236\nCOPY package.json package-lock.json ./\nRUN npm ci\nCOPY . .\n\n# \u274c \u4e0d\u597d\u7684\u505a\u6cd5\uff1a\u6bcf\u6b21\u4ee3\u7801\u53d8\u66f4\u90fd\u91cd\u65b0\u5b89\u88c5\u4f9d\u8d56\nCOPY . .\nRUN npm ci\n"})}),"\n",(0,l.jsx)(e.h3,{id:"\u51cf\u5c11\u5c42\u6570",children:"\u51cf\u5c11\u5c42\u6570"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-dockerfile",children:"# \u274c \u591a\u4e2a RUN \u6307\u4ee4\nRUN apt-get update\nRUN apt-get install -y curl\nRUN apt-get install -y wget\nRUN rm -rf /var/lib/apt/lists/*\n\n# \u2705 \u5408\u5e76\u4e3a\u4e00\u4e2a RUN\nRUN apt-get update && \\\n    apt-get install -y curl wget && \\\n    rm -rf /var/lib/apt/lists/*\n"})}),"\n",(0,l.jsx)(e.h3,{id:"\u907f\u514d\u5728\u955c\u50cf\u4e2d\u5b58\u50a8\u654f\u611f\u4fe1\u606f",children:"\u907f\u514d\u5728\u955c\u50cf\u4e2d\u5b58\u50a8\u654f\u611f\u4fe1\u606f"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-dockerfile",children:"# \u274c \u9519\u8bef\uff1a\u5bc6\u94a5\u4f1a\u4fdd\u7559\u5728\u955c\u50cf\u5c42\u4e2d\nCOPY .npmrc /root/.npmrc\nRUN npm ci\nRUN rm /root/.npmrc  # \u5220\u9664\u4e5f\u6ca1\u7528\uff0c\u5df2\u7ecf\u5728\u4e4b\u524d\u7684\u5c42\u4e2d\u4e86\n\n# \u2705 \u6b63\u786e\uff1a\u4f7f\u7528 BuildKit secrets\n# syntax=docker/dockerfile:1\nRUN --mount=type=secret,id=npmrc,target=/root/.npmrc npm ci\n"})}),"\n",(0,l.jsx)(e.h2,{id:"\u955c\u50cf\u5b58\u50a8\u7ba1\u7406",children:"\u955c\u50cf\u5b58\u50a8\u7ba1\u7406"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-bash",children:'# \u67e5\u770b\u955c\u50cf\u5360\u7528\u7a7a\u95f4\ndocker system df\ndocker system df -v\n\n# \u6e05\u7406\u60ac\u7a7a\u955c\u50cf\uff08\u65e0\u6807\u7b7e\u7684\u4e2d\u95f4\u5c42\uff09\ndocker image prune\n\n# \u6e05\u7406\u6240\u6709\u672a\u4f7f\u7528\u955c\u50cf\ndocker image prune -a\n\n# \u6e05\u7406\u6307\u5b9a\u65f6\u95f4\u524d\u7684\u955c\u50cf\ndocker image prune -a --filter "until=24h"\n\n# \u5bfc\u51fa\u955c\u50cf\uff08\u5305\u542b\u6240\u6709\u5c42\uff09\ndocker save myimage:tag -o myimage.tar\n\n# \u67e5\u770b\u5bfc\u51fa\u7684\u955c\u50cf\u7ed3\u6784\ntar -tvf myimage.tar\n'})})]})}function h(n={}){const{wrapper:e}={...(0,d.R)(),...n.components};return e?(0,l.jsx)(e,{...n,children:(0,l.jsx)(t,{...n})}):t(n)}},48885:(n,e,r)=>{r.d(e,{R:()=>s,x:()=>a});var i=r(99378);const l={},d=i.createContext(l);function s(n){const e=i.useContext(d);return i.useMemo(function(){return"function"==typeof n?n(e):{...e,...n}},[e,n])}function a(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(l):n.components||l:s(n.components),i.createElement(d.Provider,{value:e},n.children)}}}]);