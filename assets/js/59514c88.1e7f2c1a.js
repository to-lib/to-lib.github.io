"use strict";(globalThis.webpackChunkto_lib_github_io=globalThis.webpackChunkto_lib_github_io||[]).push([[61356],{33312:(n,e,o)=>{o.r(e),o.d(e,{assets:()=>i,contentTitle:()=>c,default:()=>t,frontMatter:()=>l,metadata:()=>s,toc:()=>a});const s=JSON.parse('{"id":"docker/compose","title":"Docker Compose","description":"Docker Compose \u591a\u5bb9\u5668\u7f16\u6392\u8be6\u89e3","source":"@site/docs/docker/compose.md","sourceDirName":"docker","slug":"/docker/compose","permalink":"/docs/docker/compose","draft":false,"unlisted":false,"editUrl":"https://github.com/to-lib/to-lib.github.io/tree/main/docs/docker/compose.md","tags":[],"version":"current","sidebarPosition":5,"frontMatter":{"sidebar_position":5,"title":"Docker Compose","description":"Docker Compose \u591a\u5bb9\u5668\u7f16\u6392\u8be6\u89e3"},"sidebar":"docker","previous":{"title":"Dockerfile \u7f16\u5199","permalink":"/docs/docker/dockerfile"},"next":{"title":"\u6570\u636e\u6301\u4e45\u5316","permalink":"/docs/docker/volumes"}}');var r=o(22714),d=o(48885);const l={sidebar_position:5,title:"Docker Compose",description:"Docker Compose \u591a\u5bb9\u5668\u7f16\u6392\u8be6\u89e3"},c="Docker Compose",i={},a=[{value:"\u5b89\u88c5",id:"\u5b89\u88c5",level:2},{value:"Linux",id:"linux",level:3},{value:"macOS/Windows",id:"macoswindows",level:3},{value:"\u57fa\u672c\u7ed3\u6784",id:"\u57fa\u672c\u7ed3\u6784",level:2},{value:"\u5e38\u7528\u914d\u7f6e",id:"\u5e38\u7528\u914d\u7f6e",level:2},{value:"\u670d\u52a1\u914d\u7f6e",id:"\u670d\u52a1\u914d\u7f6e",level:3},{value:"\u5065\u5eb7\u68c0\u67e5",id:"\u5065\u5eb7\u68c0\u67e5",level:3},{value:"\u8d44\u6e90\u9650\u5236",id:"\u8d44\u6e90\u9650\u5236",level:3},{value:"\u7f51\u7edc\u914d\u7f6e",id:"\u7f51\u7edc\u914d\u7f6e",level:3},{value:"\u5377\u914d\u7f6e",id:"\u5377\u914d\u7f6e",level:3},{value:"\u5b9e\u7528\u793a\u4f8b",id:"\u5b9e\u7528\u793a\u4f8b",level:2},{value:"Web \u5e94\u7528 + \u6570\u636e\u5e93",id:"web-\u5e94\u7528--\u6570\u636e\u5e93",level:3},{value:"Nginx \u53cd\u5411\u4ee3\u7406",id:"nginx-\u53cd\u5411\u4ee3\u7406",level:3},{value:"\u5f00\u53d1\u73af\u5883",id:"\u5f00\u53d1\u73af\u5883",level:3},{value:"\u5e38\u7528\u547d\u4ee4",id:"\u5e38\u7528\u547d\u4ee4",level:2},{value:"\u73af\u5883\u53d8\u91cf",id:"\u73af\u5883\u53d8\u91cf",level:2},{value:".env \u6587\u4ef6",id:"env-\u6587\u4ef6",level:3},{value:"\u5728 compose \u6587\u4ef6\u4e2d\u4f7f\u7528",id:"\u5728-compose-\u6587\u4ef6\u4e2d\u4f7f\u7528",level:3},{value:"\u591a\u73af\u5883\u914d\u7f6e",id:"\u591a\u73af\u5883\u914d\u7f6e",level:2},{value:"docker-compose.override.yml",id:"docker-composeoverrideyml",level:3},{value:"\u751f\u4ea7\u73af\u5883",id:"\u751f\u4ea7\u73af\u5883",level:3}];function p(n){const e={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",p:"p",pre:"pre",...(0,d.R)(),...n.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(e.header,{children:(0,r.jsx)(e.h1,{id:"docker-compose",children:"Docker Compose"})}),"\n",(0,r.jsx)(e.p,{children:"Docker Compose \u662f\u4e00\u4e2a\u7528\u4e8e\u5b9a\u4e49\u548c\u8fd0\u884c\u591a\u5bb9\u5668 Docker \u5e94\u7528\u7a0b\u5e8f\u7684\u5de5\u5177\u3002"}),"\n",(0,r.jsx)(e.h2,{id:"\u5b89\u88c5",children:"\u5b89\u88c5"}),"\n",(0,r.jsx)(e.h3,{id:"linux",children:"Linux"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-bash",children:"# \u4f7f\u7528 Docker \u63d2\u4ef6\uff08\u63a8\u8350\uff09\nsudo apt-get install docker-compose-plugin\n\n# \u9a8c\u8bc1\u5b89\u88c5\ndocker compose version\n"})}),"\n",(0,r.jsx)(e.h3,{id:"macoswindows",children:"macOS/Windows"}),"\n",(0,r.jsx)(e.p,{children:"Docker Desktop \u5df2\u5305\u542b Docker Compose\u3002"}),"\n",(0,r.jsx)(e.h2,{id:"\u57fa\u672c\u7ed3\u6784",children:"\u57fa\u672c\u7ed3\u6784"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-yaml",children:'# docker-compose.yml\nversion: "3.8"\n\nservices:\n  web:\n    image: nginx:alpine\n    ports:\n      - "80:80"\n    volumes:\n      - ./html:/usr/share/nginx/html\n    networks:\n      - webnet\n\n  db:\n    image: mysql:8.0\n    environment:\n      MYSQL_ROOT_PASSWORD: secret\n    volumes:\n      - db-data:/var/lib/mysql\n    networks:\n      - webnet\n\nvolumes:\n  db-data:\n\nnetworks:\n  webnet:\n'})}),"\n",(0,r.jsx)(e.h2,{id:"\u5e38\u7528\u914d\u7f6e",children:"\u5e38\u7528\u914d\u7f6e"}),"\n",(0,r.jsx)(e.h3,{id:"\u670d\u52a1\u914d\u7f6e",children:"\u670d\u52a1\u914d\u7f6e"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-yaml",children:'services:\n  app:\n    # \u4f7f\u7528\u955c\u50cf\n    image: node:18-alpine\n\n    # \u6216\u6784\u5efa\u955c\u50cf\n    build:\n      context: .\n      dockerfile: Dockerfile\n      args:\n        NODE_ENV: production\n\n    # \u5bb9\u5668\u540d\u79f0\n    container_name: my-app\n\n    # \u91cd\u542f\u7b56\u7565\n    restart: always # no, on-failure, unless-stopped\n\n    # \u7aef\u53e3\u6620\u5c04\n    ports:\n      - "3000:3000"\n      - "127.0.0.1:3001:3001"\n\n    # \u73af\u5883\u53d8\u91cf\n    environment:\n      - NODE_ENV=production\n      - DB_HOST=db\n\n    # \u4ece\u6587\u4ef6\u52a0\u8f7d\u73af\u5883\u53d8\u91cf\n    env_file:\n      - .env\n      - .env.local\n\n    # \u6302\u8f7d\u5377\n    volumes:\n      - ./src:/app/src\n      - node_modules:/app/node_modules\n\n    # \u4f9d\u8d56\u5173\u7cfb\n    depends_on:\n      - db\n      - redis\n\n    # \u7f51\u7edc\n    networks:\n      - frontend\n      - backend\n\n    # \u547d\u4ee4\n    command: npm start\n\n    # \u5165\u53e3\u70b9\n    entrypoint: ["docker-entrypoint.sh"]\n\n    # \u5de5\u4f5c\u76ee\u5f55\n    working_dir: /app\n\n    # \u7528\u6237\n    user: "1000:1000"\n'})}),"\n",(0,r.jsx)(e.h3,{id:"\u5065\u5eb7\u68c0\u67e5",children:"\u5065\u5eb7\u68c0\u67e5"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-yaml",children:'services:\n  web:\n    image: nginx\n    healthcheck:\n      test: ["CMD", "curl", "-f", "http://localhost/"]\n      interval: 30s\n      timeout: 10s\n      retries: 3\n      start_period: 40s\n'})}),"\n",(0,r.jsx)(e.h3,{id:"\u8d44\u6e90\u9650\u5236",children:"\u8d44\u6e90\u9650\u5236"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-yaml",children:'services:\n  app:\n    image: node:18\n    deploy:\n      resources:\n        limits:\n          cpus: "0.5"\n          memory: 512M\n        reservations:\n          cpus: "0.25"\n          memory: 256M\n'})}),"\n",(0,r.jsx)(e.h3,{id:"\u7f51\u7edc\u914d\u7f6e",children:"\u7f51\u7edc\u914d\u7f6e"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-yaml",children:"services:\n  web:\n    networks:\n      frontend:\n        ipv4_address: 172.16.238.10\n      backend:\n\nnetworks:\n  frontend:\n    driver: bridge\n    ipam:\n      config:\n        - subnet: 172.16.238.0/24\n  backend:\n    driver: bridge\n"})}),"\n",(0,r.jsx)(e.h3,{id:"\u5377\u914d\u7f6e",children:"\u5377\u914d\u7f6e"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-yaml",children:"volumes:\n  # \u547d\u540d\u5377\n  db-data:\n    driver: local\n\n  # \u4f7f\u7528\u9a71\u52a8\u9009\u9879\n  logs:\n    driver: local\n    driver_opts:\n      type: none\n      device: /var/log/app\n      o: bind\n\nservices:\n  db:\n    volumes:\n      # \u547d\u540d\u5377\n      - db-data:/var/lib/mysql\n      # \u7ed1\u5b9a\u6302\u8f7d\n      - ./config:/etc/mysql/conf.d\n      # \u53ea\u8bfb\n      - ./static:/app/static:ro\n"})}),"\n",(0,r.jsx)(e.h2,{id:"\u5b9e\u7528\u793a\u4f8b",children:"\u5b9e\u7528\u793a\u4f8b"}),"\n",(0,r.jsx)(e.h3,{id:"web-\u5e94\u7528--\u6570\u636e\u5e93",children:"Web \u5e94\u7528 + \u6570\u636e\u5e93"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-yaml",children:'version: "3.8"\n\nservices:\n  app:\n    build: .\n    ports:\n      - "3000:3000"\n    environment:\n      - DATABASE_URL=postgres://user:pass@db:5432/mydb\n    depends_on:\n      db:\n        condition: service_healthy\n\n  db:\n    image: postgres:15\n    environment:\n      POSTGRES_USER: user\n      POSTGRES_PASSWORD: pass\n      POSTGRES_DB: mydb\n    volumes:\n      - postgres-data:/var/lib/postgresql/data\n    healthcheck:\n      test: ["CMD-SHELL", "pg_isready -U user -d mydb"]\n      interval: 10s\n      timeout: 5s\n      retries: 5\n\nvolumes:\n  postgres-data:\n'})}),"\n",(0,r.jsx)(e.h3,{id:"nginx-\u53cd\u5411\u4ee3\u7406",children:"Nginx \u53cd\u5411\u4ee3\u7406"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-yaml",children:'version: "3.8"\n\nservices:\n  nginx:\n    image: nginx:alpine\n    ports:\n      - "80:80"\n      - "443:443"\n    volumes:\n      - ./nginx.conf:/etc/nginx/nginx.conf:ro\n      - ./ssl:/etc/nginx/ssl:ro\n    depends_on:\n      - app\n\n  app:\n    build: .\n    expose:\n      - "3000"\n'})}),"\n",(0,r.jsx)(e.h3,{id:"\u5f00\u53d1\u73af\u5883",children:"\u5f00\u53d1\u73af\u5883"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-yaml",children:'version: "3.8"\n\nservices:\n  app:\n    build:\n      context: .\n      target: development\n    volumes:\n      - .:/app\n      - node_modules:/app/node_modules\n    ports:\n      - "3000:3000"\n    environment:\n      - NODE_ENV=development\n    command: npm run dev\n\n  db:\n    image: mysql:8.0\n    ports:\n      - "3306:3306"\n    environment:\n      MYSQL_ROOT_PASSWORD: root\n      MYSQL_DATABASE: dev_db\n    volumes:\n      - mysql-data:/var/lib/mysql\n\n  redis:\n    image: redis:alpine\n    ports:\n      - "6379:6379"\n\nvolumes:\n  node_modules:\n  mysql-data:\n'})}),"\n",(0,r.jsx)(e.h2,{id:"\u5e38\u7528\u547d\u4ee4",children:"\u5e38\u7528\u547d\u4ee4"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-bash",children:"# \u542f\u52a8\u670d\u52a1\ndocker compose up\n\n# \u540e\u53f0\u542f\u52a8\ndocker compose up -d\n\n# \u6307\u5b9a\u914d\u7f6e\u6587\u4ef6\ndocker compose -f docker-compose.prod.yml up -d\n\n# \u6784\u5efa\u955c\u50cf\ndocker compose build\n\n# \u4e0d\u4f7f\u7528\u7f13\u5b58\u6784\u5efa\ndocker compose build --no-cache\n\n# \u67e5\u770b\u670d\u52a1\u72b6\u6001\ndocker compose ps\n\n# \u67e5\u770b\u65e5\u5fd7\ndocker compose logs\n\n# \u5b9e\u65f6\u67e5\u770b\u65e5\u5fd7\ndocker compose logs -f\n\n# \u67e5\u770b\u7279\u5b9a\u670d\u52a1\u65e5\u5fd7\ndocker compose logs app\n\n# \u505c\u6b62\u670d\u52a1\ndocker compose stop\n\n# \u505c\u6b62\u5e76\u5220\u9664\u5bb9\u5668\ndocker compose down\n\n# \u5220\u9664\u5377\ndocker compose down -v\n\n# \u5220\u9664\u955c\u50cf\ndocker compose down --rmi all\n\n# \u91cd\u542f\u670d\u52a1\ndocker compose restart\n\n# \u6267\u884c\u547d\u4ee4\ndocker compose exec app bash\n\n# \u8fd0\u884c\u4e00\u6b21\u6027\u547d\u4ee4\ndocker compose run --rm app npm test\n\n# \u6269\u5c55\u670d\u52a1\ndocker compose up -d --scale app=3\n"})}),"\n",(0,r.jsx)(e.h2,{id:"\u73af\u5883\u53d8\u91cf",children:"\u73af\u5883\u53d8\u91cf"}),"\n",(0,r.jsx)(e.h3,{id:"env-\u6587\u4ef6",children:".env \u6587\u4ef6"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-plaintext",children:"# .env\nCOMPOSE_PROJECT_NAME=myproject\nDB_PASSWORD=secret123\nAPP_PORT=3000\n"})}),"\n",(0,r.jsx)(e.h3,{id:"\u5728-compose-\u6587\u4ef6\u4e2d\u4f7f\u7528",children:"\u5728 compose \u6587\u4ef6\u4e2d\u4f7f\u7528"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-yaml",children:'services:\n  app:\n    ports:\n      - "${APP_PORT:-3000}:3000"\n    environment:\n      - DB_PASSWORD=${DB_PASSWORD}\n'})}),"\n",(0,r.jsx)(e.h2,{id:"\u591a\u73af\u5883\u914d\u7f6e",children:"\u591a\u73af\u5883\u914d\u7f6e"}),"\n",(0,r.jsx)(e.h3,{id:"docker-composeoverrideyml",children:"docker-compose.override.yml"}),"\n",(0,r.jsx)(e.p,{children:"\u5f00\u53d1\u73af\u5883\u81ea\u52a8\u52a0\u8f7d\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-yaml",children:"# docker-compose.yml - \u57fa\u7840\u914d\u7f6e\nservices:\n  app:\n    image: myapp:latest\n\n# docker-compose.override.yml - \u5f00\u53d1\u914d\u7f6e\uff08\u81ea\u52a8\u52a0\u8f7d\uff09\nservices:\n  app:\n    build: .\n    volumes:\n      - .:/app\n"})}),"\n",(0,r.jsx)(e.h3,{id:"\u751f\u4ea7\u73af\u5883",children:"\u751f\u4ea7\u73af\u5883"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-yaml",children:"# docker-compose.prod.yml\nservices:\n  app:\n    image: myapp:${VERSION:-latest}\n    restart: always\n    deploy:\n      replicas: 3\n"})}),"\n",(0,r.jsx)(e.p,{children:"\u542f\u52a8\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-bash",children:"docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d\n"})})]})}function t(n={}){const{wrapper:e}={...(0,d.R)(),...n.components};return e?(0,r.jsx)(e,{...n,children:(0,r.jsx)(p,{...n})}):p(n)}},48885:(n,e,o)=>{o.d(e,{R:()=>l,x:()=>c});var s=o(99378);const r={},d=s.createContext(r);function l(n){const e=s.useContext(d);return s.useMemo(function(){return"function"==typeof n?n(e):{...e,...n}},[e,n])}function c(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(r):n.components||r:l(n.components),s.createElement(d.Provider,{value:e},n.children)}}}]);