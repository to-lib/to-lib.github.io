"use strict";(globalThis.webpackChunkto_lib_github_io=globalThis.webpackChunkto_lib_github_io||[]).push([[83307],{48885:(e,n,r)=>{r.d(n,{R:()=>t,x:()=>a});var l=r(99378);const s={},i=l.createContext(s);function t(e){const n=l.useContext(i);return l.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:t(e.components),l.createElement(i.Provider,{value:n},e.children)}},89892:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>d,contentTitle:()=>a,default:()=>o,frontMatter:()=>t,metadata:()=>l,toc:()=>c});const l=JSON.parse('{"id":"mysql/high-availability","title":"\u9ad8\u53ef\u7528\u67b6\u6784","description":"[!TIP] > \u4e1a\u52a1\u8fde\u7eed\u6027\u4fdd\u969c: \u9ad8\u53ef\u7528\u67b6\u6784\u662f\u4fdd\u8bc1 MySQL \u670d\u52a1\u7a33\u5b9a\u8fd0\u884c\u7684\u5173\u952e\u3002\u672c\u6587\u4ecb\u7ecd\u5e38\u89c1\u7684\u9ad8\u53ef\u7528\u65b9\u6848\u548c\u6700\u4f73\u5b9e\u8df5\u3002","source":"@site/docs/mysql/high-availability.md","sourceDirName":"mysql","slug":"/mysql/high-availability","permalink":"/docs/mysql/high-availability","draft":false,"unlisted":false,"editUrl":"https://github.com/to-lib/to-lib.github.io/tree/main/docs/mysql/high-availability.md","tags":[],"version":"current","sidebarPosition":14,"frontMatter":{"sidebar_position":14,"title":"\u9ad8\u53ef\u7528\u67b6\u6784"},"sidebar":"mysql","previous":{"title":"\u4e3b\u4ece\u590d\u5236","permalink":"/docs/mysql/replication"},"next":{"title":"\u5907\u4efd\u4e0e\u6062\u590d","permalink":"/docs/mysql/backup-recovery"}}');var s=r(22714),i=r(48885);const t={sidebar_position:14,title:"\u9ad8\u53ef\u7528\u67b6\u6784"},a="MySQL \u9ad8\u53ef\u7528\u67b6\u6784",d={},c=[{value:"\u9ad8\u53ef\u7528\u6982\u8ff0",id:"\u9ad8\u53ef\u7528\u6982\u8ff0",level:2},{value:"\u53ef\u7528\u6027\u6307\u6807",id:"\u53ef\u7528\u6027\u6307\u6807",level:3},{value:"\u9ad8\u53ef\u7528\u65b9\u6848\u5bf9\u6bd4",id:"\u9ad8\u53ef\u7528\u65b9\u6848\u5bf9\u6bd4",level:3},{value:"\u4e3b\u4ece\u590d\u5236\u67b6\u6784",id:"\u4e3b\u4ece\u590d\u5236\u67b6\u6784",level:2},{value:"\u57fa\u672c\u67b6\u6784",id:"\u57fa\u672c\u67b6\u6784",level:3},{value:"\u914d\u7f6e\u793a\u4f8b",id:"\u914d\u7f6e\u793a\u4f8b",level:3},{value:"\u4f18\u7f3a\u70b9",id:"\u4f18\u7f3a\u70b9",level:3},{value:"MHA\uff08Master High Availability\uff09",id:"mhamaster-high-availability",level:2},{value:"\u67b6\u6784\u6982\u8ff0",id:"\u67b6\u6784\u6982\u8ff0",level:3},{value:"\u6838\u5fc3\u7ec4\u4ef6",id:"\u6838\u5fc3\u7ec4\u4ef6",level:3},{value:"\u5b89\u88c5\u914d\u7f6e",id:"\u5b89\u88c5\u914d\u7f6e",level:3},{value:"\u6545\u969c\u5207\u6362",id:"\u6545\u969c\u5207\u6362",level:3},{value:"MySQL Group Replication\uff08MGR\uff09",id:"mysql-group-replicationmgr",level:2},{value:"\u67b6\u6784\u6982\u8ff0",id:"\u67b6\u6784\u6982\u8ff0-1",level:3},{value:"\u914d\u7f6e\u5355\u4e3b\u6a21\u5f0f",id:"\u914d\u7f6e\u5355\u4e3b\u6a21\u5f0f",level:3},{value:"\u542f\u52a8 MGR",id:"\u542f\u52a8-mgr",level:3},{value:"MGR \u4f18\u7f3a\u70b9",id:"mgr-\u4f18\u7f3a\u70b9",level:3},{value:"\u8bfb\u5199\u5206\u79bb",id:"\u8bfb\u5199\u5206\u79bb",level:2},{value:"\u67b6\u6784\u8bbe\u8ba1",id:"\u67b6\u6784\u8bbe\u8ba1",level:3},{value:"ProxySQL \u914d\u7f6e",id:"proxysql-\u914d\u7f6e",level:3},{value:"\u5e94\u7528\u5c42\u5b9e\u73b0",id:"\u5e94\u7528\u5c42\u5b9e\u73b0",level:3},{value:"VIP \u6f02\u79fb",id:"vip-\u6f02\u79fb",level:2},{value:"Keepalived \u914d\u7f6e",id:"keepalived-\u914d\u7f6e",level:3},{value:"\u5065\u5eb7\u68c0\u67e5\u811a\u672c",id:"\u5065\u5eb7\u68c0\u67e5\u811a\u672c",level:3},{value:"Kubernetes \u90e8\u7f72",id:"kubernetes-\u90e8\u7f72",level:2},{value:"StatefulSet \u914d\u7f6e",id:"statefulset-\u914d\u7f6e",level:3},{value:"MySQL Operator",id:"mysql-operator",level:3},{value:"\u6700\u4f73\u5b9e\u8df5",id:"\u6700\u4f73\u5b9e\u8df5",level:2},{value:"\u65b9\u6848\u9009\u578b\u5efa\u8bae",id:"\u65b9\u6848\u9009\u578b\u5efa\u8bae",level:2},{value:"\u603b\u7ed3",id:"\u603b\u7ed3",level:2}];function h(e){const n={a:"a",blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,i.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"mysql-\u9ad8\u53ef\u7528\u67b6\u6784",children:"MySQL \u9ad8\u53ef\u7528\u67b6\u6784"})}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsxs)(n.p,{children:["[!TIP] > ",(0,s.jsx)(n.strong,{children:"\u4e1a\u52a1\u8fde\u7eed\u6027\u4fdd\u969c"}),": \u9ad8\u53ef\u7528\u67b6\u6784\u662f\u4fdd\u8bc1 MySQL \u670d\u52a1\u7a33\u5b9a\u8fd0\u884c\u7684\u5173\u952e\u3002\u672c\u6587\u4ecb\u7ecd\u5e38\u89c1\u7684\u9ad8\u53ef\u7528\u65b9\u6848\u548c\u6700\u4f73\u5b9e\u8df5\u3002"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"\u9ad8\u53ef\u7528\u6982\u8ff0",children:"\u9ad8\u53ef\u7528\u6982\u8ff0"}),"\n",(0,s.jsx)(n.h3,{id:"\u53ef\u7528\u6027\u6307\u6807",children:"\u53ef\u7528\u6027\u6307\u6807"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"\u53ef\u7528\u6027"}),(0,s.jsx)(n.th,{children:"\u5e74\u505c\u673a\u65f6\u95f4"}),(0,s.jsx)(n.th,{children:"\u63cf\u8ff0"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"99%"}),(0,s.jsx)(n.td,{children:"3.65 \u5929"}),(0,s.jsx)(n.td,{children:"1 \u4e2a 9"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"99.9%"}),(0,s.jsx)(n.td,{children:"8.76 \u5c0f\u65f6"}),(0,s.jsx)(n.td,{children:"3 \u4e2a 9"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"99.99%"}),(0,s.jsx)(n.td,{children:"52.6 \u5206\u949f"}),(0,s.jsx)(n.td,{children:"4 \u4e2a 9"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"99.999%"}),(0,s.jsx)(n.td,{children:"5.26 \u5206\u949f"}),(0,s.jsx)(n.td,{children:"5 \u4e2a 9"})]})]})]}),"\n",(0,s.jsx)(n.h3,{id:"\u9ad8\u53ef\u7528\u65b9\u6848\u5bf9\u6bd4",children:"\u9ad8\u53ef\u7528\u65b9\u6848\u5bf9\u6bd4"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"\u65b9\u6848"}),(0,s.jsx)(n.th,{children:"\u6570\u636e\u4e00\u81f4\u6027"}),(0,s.jsx)(n.th,{children:"\u81ea\u52a8\u5207\u6362"}),(0,s.jsx)(n.th,{children:"\u590d\u6742\u5ea6"}),(0,s.jsx)(n.th,{children:"\u9002\u7528\u573a\u666f"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"\u4e3b\u4ece\u590d\u5236"}),(0,s.jsx)(n.td,{children:"\u6700\u7ec8\u4e00\u81f4"}),(0,s.jsx)(n.td,{children:"\u5426"}),(0,s.jsx)(n.td,{children:"\u4f4e"}),(0,s.jsx)(n.td,{children:"\u8bfb\u5199\u5206\u79bb"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"MHA"}),(0,s.jsx)(n.td,{children:"\u8f83\u597d"}),(0,s.jsx)(n.td,{children:"\u662f"}),(0,s.jsx)(n.td,{children:"\u4e2d"}),(0,s.jsx)(n.td,{children:"\u4e2d\u5c0f\u578b"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"MGR"}),(0,s.jsx)(n.td,{children:"\u5f3a\u4e00\u81f4"}),(0,s.jsx)(n.td,{children:"\u662f"}),(0,s.jsx)(n.td,{children:"\u9ad8"}),(0,s.jsx)(n.td,{children:"\u91d1\u878d\u7ea7"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Galera"}),(0,s.jsx)(n.td,{children:"\u5f3a\u4e00\u81f4"}),(0,s.jsx)(n.td,{children:"\u662f"}),(0,s.jsx)(n.td,{children:"\u9ad8"}),(0,s.jsx)(n.td,{children:"\u591a\u4e3b\u5199\u5165"})]})]})]}),"\n",(0,s.jsx)(n.h2,{id:"\u4e3b\u4ece\u590d\u5236\u67b6\u6784",children:"\u4e3b\u4ece\u590d\u5236\u67b6\u6784"}),"\n",(0,s.jsx)(n.h3,{id:"\u57fa\u672c\u67b6\u6784",children:"\u57fa\u672c\u67b6\u6784"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"    [\u4e3b\u5e93]\n      \u2502\n      \u251c\u2500\u2500 [\u4ece\u5e931] - \u8bfb\n      \u251c\u2500\u2500 [\u4ece\u5e932] - \u8bfb\n      \u2514\u2500\u2500 [\u4ece\u5e933] - \u5907\u4efd\n"})}),"\n",(0,s.jsx)(n.h3,{id:"\u914d\u7f6e\u793a\u4f8b",children:"\u914d\u7f6e\u793a\u4f8b"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"-- \u4e3b\u5e93\u914d\u7f6e (my.cnf)\n[mysqld]\nserver-id = 1\nlog-bin = mysql-bin\ngtid-mode = ON\nenforce-gtid-consistency = ON\n\n-- \u4ece\u5e93\u914d\u7f6e\n[mysqld]\nserver-id = 2\nrelay-log = mysql-relay-bin\nlog-slave-updates = 1\nread-only = 1\ngtid-mode = ON\nenforce-gtid-consistency = ON\n"})}),"\n",(0,s.jsx)(n.h3,{id:"\u4f18\u7f3a\u70b9",children:"\u4f18\u7f3a\u70b9"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"\u4f18\u70b9"}),"\uff1a"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"\u2705 \u5b9e\u73b0\u7b80\u5355"}),"\n",(0,s.jsx)(n.li,{children:"\u2705 \u8bfb\u5199\u5206\u79bb"}),"\n",(0,s.jsx)(n.li,{children:"\u2705 \u6570\u636e\u5907\u4efd"}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"\u7f3a\u70b9"}),"\uff1a"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"\u274c \u4e0d\u80fd\u81ea\u52a8\u6545\u969c\u5207\u6362"}),"\n",(0,s.jsx)(n.li,{children:"\u274c \u4e3b\u5e93\u5355\u70b9\u6545\u969c"}),"\n",(0,s.jsx)(n.li,{children:"\u274c \u5b58\u5728\u590d\u5236\u5ef6\u8fdf"}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"mhamaster-high-availability",children:"MHA\uff08Master High Availability\uff09"}),"\n",(0,s.jsx)(n.h3,{id:"\u67b6\u6784\u6982\u8ff0",children:"\u67b6\u6784\u6982\u8ff0"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"         [MHA Manager]\n              \u2502\n    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n    \u25bc         \u25bc         \u25bc\n[Master]  [Slave1]  [Slave2]\n    \u2502         \u25b2         \u25b2\n    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n         \u590d\u5236\u5173\u7cfb\n"})}),"\n",(0,s.jsx)(n.h3,{id:"\u6838\u5fc3\u7ec4\u4ef6",children:"\u6838\u5fc3\u7ec4\u4ef6"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"MHA Manager"})," - \u7ba1\u7406\u8282\u70b9\uff0c\u76d1\u63a7\u548c\u6545\u969c\u5207\u6362"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"MHA Node"})," - \u6570\u636e\u8282\u70b9\uff0c\u5b89\u88c5\u5728\u6240\u6709 MySQL \u670d\u52a1\u5668"]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"\u5b89\u88c5\u914d\u7f6e",children:"\u5b89\u88c5\u914d\u7f6e"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"# 1. \u5b89\u88c5 MHA Node\uff08\u6240\u6709 MySQL \u670d\u52a1\u5668\uff09\nyum install perl-DBD-MySQL\nrpm -ivh mha4mysql-node-*.rpm\n\n# 2. \u5b89\u88c5 MHA Manager\uff08\u7ba1\u7406\u8282\u70b9\uff09\nrpm -ivh mha4mysql-manager-*.rpm\n\n# 3. \u914d\u7f6e\u6587\u4ef6 /etc/mha/app1.cnf\n[server default]\nmanager_log=/var/log/mha/app1/manager.log\nmanager_workdir=/var/log/mha/app1\nmaster_binlog_dir=/var/lib/mysql\npassword=password\nping_interval=1\nrepl_password=repl_password\nrepl_user=repl\nssh_user=root\nuser=root\n\n[server1]\ncandidate_master=1\nhostname=192.168.1.100\n\n[server2]\ncandidate_master=1\nhostname=192.168.1.101\n\n[server3]\nhostname=192.168.1.102\nno_master=1\n"})}),"\n",(0,s.jsx)(n.h3,{id:"\u6545\u969c\u5207\u6362",children:"\u6545\u969c\u5207\u6362"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"# \u624b\u52a8\u5207\u6362\nmasterha_master_switch --conf=/etc/mha/app1.cnf \\\n    --master_state=alive \\\n    --new_master_host=192.168.1.101\n\n# \u81ea\u52a8\u6545\u969c\u68c0\u6d4b\u548c\u5207\u6362\nmasterha_manager --conf=/etc/mha/app1.cnf &\n"})}),"\n",(0,s.jsx)(n.h2,{id:"mysql-group-replicationmgr",children:"MySQL Group Replication\uff08MGR\uff09"}),"\n",(0,s.jsx)(n.h3,{id:"\u67b6\u6784\u6982\u8ff0-1",children:"\u67b6\u6784\u6982\u8ff0"}),"\n",(0,s.jsx)(n.p,{children:"\u57fa\u4e8e Paxos \u534f\u8bae\u7684\u7ec4\u590d\u5236\uff0c\u652f\u6301\u591a\u4e3b\u6216\u5355\u4e3b\u6a21\u5f0f\u3002"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n    \u2502   Group Replication \u2502\n    \u2502     (Paxos)         \u2502\n    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n        \u2502     \u2502     \u2502\n    [Node1] [Node2] [Node3]\n      RW      RW      RW\n"})}),"\n",(0,s.jsx)(n.h3,{id:"\u914d\u7f6e\u5355\u4e3b\u6a21\u5f0f",children:"\u914d\u7f6e\u5355\u4e3b\u6a21\u5f0f"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ini",children:'# my.cnf\n[mysqld]\nserver-id = 1\ngtid-mode = ON\nenforce-gtid-consistency = ON\nbinlog-checksum = NONE\nlog-bin = mysql-bin\nlog-slave-updates = ON\nbinlog-format = ROW\nmaster-info-repository = TABLE\nrelay-log-info-repository = TABLE\n\n# Group Replication \u914d\u7f6e\nplugin-load-add = group_replication.so\ngroup_replication_group_name = "aaaaaaaa-bbbb-cccc-dddd-eeeeeeeeeeee"\ngroup_replication_start_on_boot = OFF\ngroup_replication_local_address = "192.168.1.100:33061"\ngroup_replication_group_seeds = "192.168.1.100:33061,192.168.1.101:33061,192.168.1.102:33061"\ngroup_replication_bootstrap_group = OFF\ngroup_replication_single_primary_mode = ON\n'})}),"\n",(0,s.jsx)(n.h3,{id:"\u542f\u52a8-mgr",children:"\u542f\u52a8 MGR"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"-- \u521b\u5efa\u590d\u5236\u7528\u6237\nCREATE USER 'repl'@'%' IDENTIFIED BY 'password';\nGRANT REPLICATION SLAVE ON *.* TO 'repl'@'%';\nGRANT BACKUP_ADMIN ON *.* TO 'repl'@'%';\nFLUSH PRIVILEGES;\n\n-- \u914d\u7f6e\u590d\u5236\u901a\u9053\nCHANGE REPLICATION SOURCE TO SOURCE_USER='repl', SOURCE_PASSWORD='password'\nFOR CHANNEL 'group_replication_recovery';\n\n-- \u5f15\u5bfc\u7b2c\u4e00\u4e2a\u8282\u70b9\nSET GLOBAL group_replication_bootstrap_group = ON;\nSTART GROUP_REPLICATION;\nSET GLOBAL group_replication_bootstrap_group = OFF;\n\n-- \u5176\u4ed6\u8282\u70b9\u52a0\u5165\nSTART GROUP_REPLICATION;\n\n-- \u67e5\u770b\u6210\u5458\nSELECT * FROM performance_schema.replication_group_members;\n"})}),"\n",(0,s.jsx)(n.h3,{id:"mgr-\u4f18\u7f3a\u70b9",children:"MGR \u4f18\u7f3a\u70b9"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"\u4f18\u70b9"}),"\uff1a"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"\u2705 \u6570\u636e\u5f3a\u4e00\u81f4\u6027"}),"\n",(0,s.jsx)(n.li,{children:"\u2705 \u81ea\u52a8\u6545\u969c\u5207\u6362"}),"\n",(0,s.jsx)(n.li,{children:"\u2705 \u5f39\u6027\u6269\u7f29\u5bb9"}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"\u7f3a\u70b9"}),"\uff1a"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"\u274c \u7f51\u7edc\u8981\u6c42\u9ad8"}),"\n",(0,s.jsx)(n.li,{children:"\u274c \u914d\u7f6e\u590d\u6742"}),"\n",(0,s.jsx)(n.li,{children:"\u274c \u5e76\u53d1\u5199\u6027\u80fd\u53d7\u9650"}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"\u8bfb\u5199\u5206\u79bb",children:"\u8bfb\u5199\u5206\u79bb"}),"\n",(0,s.jsx)(n.h3,{id:"\u67b6\u6784\u8bbe\u8ba1",children:"\u67b6\u6784\u8bbe\u8ba1"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"         [\u5e94\u7528\u5c42]\n            \u2502\n     \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n     \u25bc             \u25bc\n  [\u5199\u5165]        [\u8bfb\u53d6]\n     \u2502             \u2502\n     \u25bc             \u25bc\n  [\u4e3b\u5e93]       [\u8d1f\u8f7d\u5747\u8861]\n     \u2502         \u250c\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2510\n     \u2502         \u25bc       \u25bc\n     \u2514\u2500\u2500\u2500\u2500> [\u4ece\u5e931] [\u4ece\u5e932]\n"})}),"\n",(0,s.jsx)(n.h3,{id:"proxysql-\u914d\u7f6e",children:"ProxySQL \u914d\u7f6e"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"-- \u5b89\u88c5 ProxySQL\nyum install proxysql\n\n-- \u914d\u7f6e\u540e\u7aef\u670d\u52a1\u5668\nINSERT INTO mysql_servers(hostgroup_id, hostname, port) VALUES (10, '192.168.1.100', 3306);  -- \u4e3b\u5e93\nINSERT INTO mysql_servers(hostgroup_id, hostname, port) VALUES (20, '192.168.1.101', 3306);  -- \u4ece\u5e93\nINSERT INTO mysql_servers(hostgroup_id, hostname, port) VALUES (20, '192.168.1.102', 3306);  -- \u4ece\u5e93\n\n-- \u914d\u7f6e\u8bfb\u5199\u5206\u79bb\u89c4\u5219\nINSERT INTO mysql_query_rules(rule_id, match_pattern, destination_hostgroup, apply)\nVALUES (1, '^SELECT', 20, 1);\n\nINSERT INTO mysql_query_rules(rule_id, match_pattern, destination_hostgroup, apply)\nVALUES (2, '.*', 10, 1);\n\n-- \u52a0\u8f7d\u914d\u7f6e\nLOAD MYSQL SERVERS TO RUNTIME;\nLOAD MYSQL QUERY RULES TO RUNTIME;\nSAVE MYSQL SERVERS TO DISK;\nSAVE MYSQL QUERY RULES TO DISK;\n"})}),"\n",(0,s.jsx)(n.h3,{id:"\u5e94\u7528\u5c42\u5b9e\u73b0",children:"\u5e94\u7528\u5c42\u5b9e\u73b0"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-java",children:'// Spring Boot \u8bfb\u5199\u5206\u79bb\u914d\u7f6e\n@Configuration\npublic class DataSourceConfig {\n\n    @Bean\n    @ConfigurationProperties("spring.datasource.master")\n    public DataSource masterDataSource() {\n        return DataSourceBuilder.create().build();\n    }\n\n    @Bean\n    @ConfigurationProperties("spring.datasource.slave")\n    public DataSource slaveDataSource() {\n        return DataSourceBuilder.create().build();\n    }\n\n    @Bean\n    public DataSource routingDataSource() {\n        Map<Object, Object> targetDataSources = new HashMap<>();\n        targetDataSources.put("master", masterDataSource());\n        targetDataSources.put("slave", slaveDataSource());\n\n        RoutingDataSource routingDataSource = new RoutingDataSource();\n        routingDataSource.setTargetDataSources(targetDataSources);\n        routingDataSource.setDefaultTargetDataSource(masterDataSource());\n        return routingDataSource;\n    }\n}\n\n// \u8def\u7531\u6570\u636e\u6e90\npublic class RoutingDataSource extends AbstractRoutingDataSource {\n    @Override\n    protected Object determineCurrentLookupKey() {\n        return TransactionSynchronizationManager.isCurrentTransactionReadOnly()\n            ? "slave" : "master";\n    }\n}\n'})}),"\n",(0,s.jsx)(n.h2,{id:"vip-\u6f02\u79fb",children:"VIP \u6f02\u79fb"}),"\n",(0,s.jsx)(n.h3,{id:"keepalived-\u914d\u7f6e",children:"Keepalived \u914d\u7f6e"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-conf",children:'# /etc/keepalived/keepalived.conf\uff08\u4e3b\u5e93\uff09\nvrrp_script check_mysql {\n    script "/etc/keepalived/check_mysql.sh"\n    interval 2\n    weight -20\n}\n\nvrrp_instance VI_1 {\n    state MASTER\n    interface eth0\n    virtual_router_id 51\n    priority 100\n    advert_int 1\n\n    authentication {\n        auth_type PASS\n        auth_pass 1111\n    }\n\n    virtual_ipaddress {\n        192.168.1.200\n    }\n\n    track_script {\n        check_mysql\n    }\n}\n'})}),"\n",(0,s.jsx)(n.h3,{id:"\u5065\u5eb7\u68c0\u67e5\u811a\u672c",children:"\u5065\u5eb7\u68c0\u67e5\u811a\u672c"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:'#!/bin/bash\n# /etc/keepalived/check_mysql.sh\n\nMYSQL_HOST="127.0.0.1"\nMYSQL_USER="monitor"\nMYSQL_PASSWORD="password"\n\nmysql -h $MYSQL_HOST -u $MYSQL_USER -p$MYSQL_PASSWORD -e "SELECT 1" > /dev/null 2>&1\n\nif [ $? -eq 0 ]; then\n    exit 0\nelse\n    exit 1\nfi\n'})}),"\n",(0,s.jsx)(n.h2,{id:"kubernetes-\u90e8\u7f72",children:"Kubernetes \u90e8\u7f72"}),"\n",(0,s.jsx)(n.h3,{id:"statefulset-\u914d\u7f6e",children:"StatefulSet \u914d\u7f6e"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:'apiVersion: apps/v1\nkind: StatefulSet\nmetadata:\n  name: mysql\nspec:\n  serviceName: mysql\n  replicas: 3\n  selector:\n    matchLabels:\n      app: mysql\n  template:\n    metadata:\n      labels:\n        app: mysql\n    spec:\n      containers:\n        - name: mysql\n          image: mysql:8.0\n          env:\n            - name: MYSQL_ROOT_PASSWORD\n              valueFrom:\n                secretKeyRef:\n                  name: mysql-secret\n                  key: password\n          ports:\n            - containerPort: 3306\n          volumeMounts:\n            - name: data\n              mountPath: /var/lib/mysql\n  volumeClaimTemplates:\n    - metadata:\n        name: data\n      spec:\n        accessModes: ["ReadWriteOnce"]\n        resources:\n          requests:\n            storage: 100Gi\n'})}),"\n",(0,s.jsx)(n.h3,{id:"mysql-operator",children:"MySQL Operator"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:"# \u4f7f\u7528 MySQL Operator \u7b80\u5316\u7ba1\u7406\napiVersion: mysql.oracle.com/v2\nkind: InnoDBCluster\nmetadata:\n  name: mycluster\nspec:\n  secretName: mysql-secret\n  tlsUseSelfSigned: true\n  instances: 3\n  router:\n    instances: 2\n"})}),"\n",(0,s.jsx)(n.h2,{id:"\u6700\u4f73\u5b9e\u8df5",children:"\u6700\u4f73\u5b9e\u8df5"}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsxs)(n.p,{children:["[!IMPORTANT] > ",(0,s.jsx)(n.strong,{children:"\u9ad8\u53ef\u7528\u6700\u4f73\u5b9e\u8df5"}),":"]}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"\u2705 \u6839\u636e\u4e1a\u52a1\u9700\u6c42\u9009\u62e9\u5408\u9002\u7684\u65b9\u6848"}),"\n",(0,s.jsx)(n.li,{children:"\u2705 \u4f7f\u7528 GTID \u7b80\u5316\u6545\u969c\u5207\u6362"}),"\n",(0,s.jsx)(n.li,{children:"\u2705 \u5b9e\u73b0\u8bfb\u5199\u5206\u79bb\u5206\u62c5\u4e3b\u5e93\u538b\u529b"}),"\n",(0,s.jsx)(n.li,{children:"\u2705 \u76d1\u63a7\u590d\u5236\u5ef6\u8fdf\u548c\u6570\u636e\u4e00\u81f4\u6027"}),"\n",(0,s.jsx)(n.li,{children:"\u2705 \u5b9a\u671f\u8fdb\u884c\u6545\u969c\u6f14\u7ec3"}),"\n",(0,s.jsx)(n.li,{children:"\u2705 \u914d\u7f6e\u81ea\u52a8\u6545\u969c\u544a\u8b66"}),"\n",(0,s.jsx)(n.li,{children:"\u2705 \u51c6\u5907\u6545\u969c\u5207\u6362\u624b\u518c"}),"\n",(0,s.jsx)(n.li,{children:"\u274c \u907f\u514d\u8de8\u673a\u623f\u540c\u6b65\u590d\u5236"}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"\u65b9\u6848\u9009\u578b\u5efa\u8bae",children:"\u65b9\u6848\u9009\u578b\u5efa\u8bae"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"\u573a\u666f"}),(0,s.jsx)(n.th,{children:"\u63a8\u8350\u65b9\u6848"}),(0,s.jsx)(n.th,{children:"\u8bf4\u660e"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"\u5c0f\u578b\u5e94\u7528"}),(0,s.jsx)(n.td,{children:"\u4e3b\u4ece\u590d\u5236 + Keepalived"}),(0,s.jsx)(n.td,{children:"\u7b80\u5355\u6613\u7ef4\u62a4"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"\u4e2d\u578b\u5e94\u7528"}),(0,s.jsx)(n.td,{children:"MHA + \u8bfb\u5199\u5206\u79bb"}),(0,s.jsx)(n.td,{children:"\u5e73\u8861\u6210\u672c\u548c\u53ef\u7528\u6027"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"\u5927\u578b\u5e94\u7528"}),(0,s.jsx)(n.td,{children:"MGR + ProxySQL"}),(0,s.jsx)(n.td,{children:"\u9ad8\u53ef\u7528\u3001\u81ea\u52a8\u5207\u6362"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"\u91d1\u878d\u7ea7"}),(0,s.jsx)(n.td,{children:"MGR \u5f3a\u4e00\u81f4\u6a21\u5f0f"}),(0,s.jsx)(n.td,{children:"\u6570\u636e\u96f6\u4e22\u5931"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"\u4e91\u539f\u751f"}),(0,s.jsx)(n.td,{children:"MySQL Operator"}),(0,s.jsx)(n.td,{children:"\u5bb9\u5668\u5316\u90e8\u7f72"})]})]})]}),"\n",(0,s.jsx)(n.h2,{id:"\u603b\u7ed3",children:"\u603b\u7ed3"}),"\n",(0,s.jsx)(n.p,{children:"\u672c\u6587\u4ecb\u7ecd\u4e86 MySQL \u9ad8\u53ef\u7528\u67b6\u6784\uff1a"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"\u2705 \u53ef\u7528\u6027\u6307\u6807\u548c\u65b9\u6848\u5bf9\u6bd4"}),"\n",(0,s.jsx)(n.li,{children:"\u2705 \u4e3b\u4ece\u590d\u5236\u67b6\u6784"}),"\n",(0,s.jsx)(n.li,{children:"\u2705 MHA \u9ad8\u53ef\u7528\u65b9\u6848"}),"\n",(0,s.jsx)(n.li,{children:"\u2705 MGR \u7ec4\u590d\u5236"}),"\n",(0,s.jsx)(n.li,{children:"\u2705 \u8bfb\u5199\u5206\u79bb\u5b9e\u73b0"}),"\n",(0,s.jsx)(n.li,{children:"\u2705 VIP \u6f02\u79fb\u914d\u7f6e"}),"\n",(0,s.jsx)(n.li,{children:"\u2705 Kubernetes \u90e8\u7f72"}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["\u7ee7\u7eed\u5b66\u4e60 ",(0,s.jsx)(n.a,{href:"/docs/mysql/replication",children:"\u4e3b\u4ece\u590d\u5236"})," \u548c ",(0,s.jsx)(n.a,{href:"/docs/mysql/backup-recovery",children:"\u5907\u4efd\u6062\u590d"}),"\uff01"]})]})}function o(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(h,{...e})}):h(e)}}}]);