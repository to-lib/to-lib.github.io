"use strict";(globalThis.webpackChunkto_lib_github_io=globalThis.webpackChunkto_lib_github_io||[]).push([[94434],{48885:(e,n,r)=>{r.d(n,{R:()=>d,x:()=>l});var i=r(99378);const t={},s=i.createContext(t);function d(e){const n=i.useContext(s);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:d(e.components),i.createElement(s.Provider,{value:n},e.children)}},67116:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>a,contentTitle:()=>l,default:()=>h,frontMatter:()=>d,metadata:()=>i,toc:()=>c});const i=JSON.parse('{"id":"microservices/design-patterns","title":"\u8bbe\u8ba1\u6a21\u5f0f","description":"\u5fae\u670d\u52a1\u67b6\u6784\u5e38\u7528\u8bbe\u8ba1\u6a21\u5f0f - API \u7f51\u5173\u3001\u670d\u52a1\u7f51\u683c\u3001\u65ad\u8def\u5668\u3001Saga\u3001CQRS","source":"@site/docs/microservices/design-patterns.md","sourceDirName":"microservices","slug":"/microservices/design-patterns","permalink":"/docs/microservices/design-patterns","draft":false,"unlisted":false,"editUrl":"https://github.com/to-lib/to-lib.github.io/tree/main/docs/microservices/design-patterns.md","tags":[],"version":"current","sidebarPosition":3,"frontMatter":{"sidebar_position":3,"title":"\u8bbe\u8ba1\u6a21\u5f0f","description":"\u5fae\u670d\u52a1\u67b6\u6784\u5e38\u7528\u8bbe\u8ba1\u6a21\u5f0f - API \u7f51\u5173\u3001\u670d\u52a1\u7f51\u683c\u3001\u65ad\u8def\u5668\u3001Saga\u3001CQRS"},"sidebar":"microservices","previous":{"title":"\u6838\u5fc3\u6982\u5ff5","permalink":"/docs/microservices/core-concepts"},"next":{"title":"\u670d\u52a1\u6cbb\u7406","permalink":"/docs/microservices/service-governance"}}');var t=r(22714),s=r(48885);const d={sidebar_position:3,title:"\u8bbe\u8ba1\u6a21\u5f0f",description:"\u5fae\u670d\u52a1\u67b6\u6784\u5e38\u7528\u8bbe\u8ba1\u6a21\u5f0f - API \u7f51\u5173\u3001\u670d\u52a1\u7f51\u683c\u3001\u65ad\u8def\u5668\u3001Saga\u3001CQRS"},l="\u5fae\u670d\u52a1\u8bbe\u8ba1\u6a21\u5f0f",a={},c=[{value:"API \u7f51\u5173\u6a21\u5f0f",id:"api-\u7f51\u5173\u6a21\u5f0f",level:2},{value:"\u6982\u8ff0",id:"\u6982\u8ff0",level:3},{value:"\u6838\u5fc3\u529f\u80fd",id:"\u6838\u5fc3\u529f\u80fd",level:3},{value:"Spring Cloud Gateway \u793a\u4f8b",id:"spring-cloud-gateway-\u793a\u4f8b",level:3},{value:"\u670d\u52a1\u7f51\u683c\uff08Service Mesh\uff09",id:"\u670d\u52a1\u7f51\u683cservice-mesh",level:2},{value:"\u6982\u8ff0",id:"\u6982\u8ff0-1",level:3},{value:"Istio \u67b6\u6784",id:"istio-\u67b6\u6784",level:3},{value:"\u6d41\u91cf\u7ba1\u7406\u793a\u4f8b",id:"\u6d41\u91cf\u7ba1\u7406\u793a\u4f8b",level:3},{value:"\u65ad\u8def\u5668\u6a21\u5f0f\uff08Circuit Breaker\uff09",id:"\u65ad\u8def\u5668\u6a21\u5f0fcircuit-breaker",level:2},{value:"\u6982\u8ff0",id:"\u6982\u8ff0-2",level:3},{value:"\u65ad\u8def\u5668\u72b6\u6001",id:"\u65ad\u8def\u5668\u72b6\u6001",level:3},{value:"Resilience4j \u5b9e\u73b0",id:"resilience4j-\u5b9e\u73b0",level:3},{value:"Saga \u6a21\u5f0f",id:"saga-\u6a21\u5f0f",level:2},{value:"\u6982\u8ff0",id:"\u6982\u8ff0-3",level:3},{value:"\u5b9e\u73b0\u65b9\u5f0f",id:"\u5b9e\u73b0\u65b9\u5f0f",level:3},{value:"\u7f16\u6392\u5f0f\uff08Choreography\uff09",id:"\u7f16\u6392\u5f0fchoreography",level:4},{value:"\u534f\u8c03\u5f0f\uff08Orchestration\uff09",id:"\u534f\u8c03\u5f0forchestration",level:4},{value:"CQRS \u548c\u4e8b\u4ef6\u6eaf\u6e90",id:"cqrs-\u548c\u4e8b\u4ef6\u6eaf\u6e90",level:2},{value:"CQRS\uff08\u547d\u4ee4\u67e5\u8be2\u804c\u8d23\u5206\u79bb\uff09",id:"cqrs\u547d\u4ee4\u67e5\u8be2\u804c\u8d23\u5206\u79bb",level:3},{value:"\u4e8b\u4ef6\u6eaf\u6e90\uff08Event Sourcing\uff09",id:"\u4e8b\u4ef6\u6eaf\u6e90event-sourcing",level:3},{value:"\u6a21\u5f0f\u5bf9\u6bd4",id:"\u6a21\u5f0f\u5bf9\u6bd4",level:3}];function o(e){const n={code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",mermaid:"mermaid",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",...(0,s.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.header,{children:(0,t.jsx)(n.h1,{id:"\u5fae\u670d\u52a1\u8bbe\u8ba1\u6a21\u5f0f",children:"\u5fae\u670d\u52a1\u8bbe\u8ba1\u6a21\u5f0f"})}),"\n",(0,t.jsx)(n.h2,{id:"api-\u7f51\u5173\u6a21\u5f0f",children:"API \u7f51\u5173\u6a21\u5f0f"}),"\n",(0,t.jsx)(n.h3,{id:"\u6982\u8ff0",children:"\u6982\u8ff0"}),"\n",(0,t.jsx)(n.p,{children:"API \u7f51\u5173\u662f\u5fae\u670d\u52a1\u67b6\u6784\u7684\u5165\u53e3\u70b9\uff0c\u8d1f\u8d23\u8bf7\u6c42\u8def\u7531\u3001\u8ba4\u8bc1\u6388\u6743\u3001\u9650\u6d41\u7194\u65ad\u7b49\u529f\u80fd\u3002"}),"\n",(0,t.jsx)(n.mermaid,{value:"graph TB\n    Client[\u5ba2\u6237\u7aef] --\x3e Gateway[API \u7f51\u5173]\n    \n    Gateway --\x3e Auth[\u8ba4\u8bc1\u6388\u6743]\n    Gateway --\x3e RateLimit[\u9650\u6d41]\n    Gateway --\x3e Route[\u8def\u7531]\n    \n    Route --\x3e Service1[\u7528\u6237\u670d\u52a1]\n    Route --\x3e Service2[\u8ba2\u5355\u670d\u52a1]\n    Route --\x3e Service3[\u5546\u54c1\u670d\u52a1]\n    \n    style Gateway fill:#e3f2fd"}),"\n",(0,t.jsx)(n.h3,{id:"\u6838\u5fc3\u529f\u80fd",children:"\u6838\u5fc3\u529f\u80fd"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"\u529f\u80fd"}),(0,t.jsx)(n.th,{children:"\u8bf4\u660e"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.strong,{children:"\u8bf7\u6c42\u8def\u7531"})}),(0,t.jsx)(n.td,{children:"\u6839\u636e\u8def\u5f84\u5c06\u8bf7\u6c42\u8f6c\u53d1\u5230\u5bf9\u5e94\u670d\u52a1"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.strong,{children:"\u8d1f\u8f7d\u5747\u8861"})}),(0,t.jsx)(n.td,{children:"\u5728\u591a\u4e2a\u670d\u52a1\u5b9e\u4f8b\u95f4\u5206\u53d1\u8bf7\u6c42"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.strong,{children:"\u8ba4\u8bc1\u6388\u6743"})}),(0,t.jsx)(n.td,{children:"\u7edf\u4e00\u7684\u8eab\u4efd\u9a8c\u8bc1\u548c\u6743\u9650\u63a7\u5236"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.strong,{children:"\u9650\u6d41\u7194\u65ad"})}),(0,t.jsx)(n.td,{children:"\u4fdd\u62a4\u540e\u7aef\u670d\u52a1\u514d\u53d7\u8fc7\u8f7d"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.strong,{children:"\u534f\u8bae\u8f6c\u6362"})}),(0,t.jsx)(n.td,{children:"HTTP/gRPC/WebSocket \u8f6c\u6362"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.strong,{children:"\u8bf7\u6c42\u805a\u5408"})}),(0,t.jsx)(n.td,{children:"\u5408\u5e76\u591a\u4e2a\u670d\u52a1\u7684\u54cd\u5e94"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.strong,{children:"\u65e5\u5fd7\u76d1\u63a7"})}),(0,t.jsx)(n.td,{children:"\u7edf\u4e00\u7684\u8bbf\u95ee\u65e5\u5fd7\u548c\u76d1\u63a7"})]})]})]}),"\n",(0,t.jsx)(n.h3,{id:"spring-cloud-gateway-\u793a\u4f8b",children:"Spring Cloud Gateway \u793a\u4f8b"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"# application.yml\nspring:\n  cloud:\n    gateway:\n      routes:\n        - id: user-service\n          uri: lb://user-service\n          predicates:\n            - Path=/api/users/**\n          filters:\n            - StripPrefix=1\n            - name: RequestRateLimiter\n              args:\n                redis-rate-limiter.replenishRate: 10\n                redis-rate-limiter.burstCapacity: 20\n        \n        - id: order-service\n          uri: lb://order-service\n          predicates:\n            - Path=/api/orders/**\n          filters:\n            - StripPrefix=1\n"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:'// \u81ea\u5b9a\u4e49\u5168\u5c40\u8fc7\u6ee4\u5668\n@Component\npublic class AuthFilter implements GlobalFilter, Ordered {\n    \n    @Override\n    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {\n        String token = exchange.getRequest().getHeaders().getFirst("Authorization");\n        \n        if (token == null || !validateToken(token)) {\n            exchange.getResponse().setStatusCode(HttpStatus.UNAUTHORIZED);\n            return exchange.getResponse().setComplete();\n        }\n        \n        return chain.filter(exchange);\n    }\n    \n    @Override\n    public int getOrder() {\n        return -100;\n    }\n}\n'})}),"\n",(0,t.jsx)(n.h2,{id:"\u670d\u52a1\u7f51\u683cservice-mesh",children:"\u670d\u52a1\u7f51\u683c\uff08Service Mesh\uff09"}),"\n",(0,t.jsx)(n.h3,{id:"\u6982\u8ff0-1",children:"\u6982\u8ff0"}),"\n",(0,t.jsx)(n.p,{children:"\u670d\u52a1\u7f51\u683c\u662f\u4e00\u4e2a\u4e13\u95e8\u5904\u7406\u670d\u52a1\u95f4\u901a\u4fe1\u7684\u57fa\u7840\u8bbe\u65bd\u5c42\uff0c\u901a\u8fc7 Sidecar \u4ee3\u7406\u5b9e\u73b0\u6d41\u91cf\u7ba1\u7406\u3001\u5b89\u5168\u548c\u53ef\u89c2\u6d4b\u6027\u3002"}),"\n",(0,t.jsx)(n.mermaid,{value:"graph TB\n    subgraph Pod A\n        A[\u670d\u52a1 A] <--\x3e PA[Sidecar Proxy]\n    end\n    \n    subgraph Pod B\n        B[\u670d\u52a1 B] <--\x3e PB[Sidecar Proxy]\n    end\n    \n    PA <--\x3e|mTLS| PB\n    \n    CP[\u63a7\u5236\u5e73\u9762] --\x3e PA\n    CP --\x3e PB\n    \n    style PA fill:#fff3e0\n    style PB fill:#fff3e0\n    style CP fill:#e8f5e9"}),"\n",(0,t.jsx)(n.h3,{id:"istio-\u67b6\u6784",children:"Istio \u67b6\u6784"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"\u7ec4\u4ef6"}),(0,t.jsx)(n.th,{children:"\u529f\u80fd"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.strong,{children:"Envoy"})}),(0,t.jsx)(n.td,{children:"\u6570\u636e\u5e73\u9762\u4ee3\u7406\uff0c\u5904\u7406\u6240\u6709\u7f51\u7edc\u6d41\u91cf"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.strong,{children:"Istiod"})}),(0,t.jsx)(n.td,{children:"\u63a7\u5236\u5e73\u9762\uff0c\u7ba1\u7406\u914d\u7f6e\u548c\u8bc1\u4e66"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.strong,{children:"Pilot"})}),(0,t.jsx)(n.td,{children:"\u670d\u52a1\u53d1\u73b0\u548c\u6d41\u91cf\u7ba1\u7406"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.strong,{children:"Citadel"})}),(0,t.jsx)(n.td,{children:"\u8bc1\u4e66\u7ba1\u7406\u548c mTLS"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.strong,{children:"Galley"})}),(0,t.jsx)(n.td,{children:"\u914d\u7f6e\u9a8c\u8bc1\u548c\u5206\u53d1"})]})]})]}),"\n",(0,t.jsx)(n.h3,{id:"\u6d41\u91cf\u7ba1\u7406\u793a\u4f8b",children:"\u6d41\u91cf\u7ba1\u7406\u793a\u4f8b"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:'# VirtualService - \u6d41\u91cf\u8def\u7531\napiVersion: networking.istio.io/v1beta1\nkind: VirtualService\nmetadata:\n  name: user-service\nspec:\n  hosts:\n    - user-service\n  http:\n    - match:\n        - headers:\n            x-version:\n              exact: "v2"\n      route:\n        - destination:\n            host: user-service\n            subset: v2\n    - route:\n        - destination:\n            host: user-service\n            subset: v1\n          weight: 90\n        - destination:\n            host: user-service\n            subset: v2\n          weight: 10\n\n---\n# DestinationRule - \u76ee\u6807\u89c4\u5219\napiVersion: networking.istio.io/v1beta1\nkind: DestinationRule\nmetadata:\n  name: user-service\nspec:\n  host: user-service\n  trafficPolicy:\n    connectionPool:\n      tcp:\n        maxConnections: 100\n      http:\n        h2UpgradePolicy: UPGRADE\n  subsets:\n    - name: v1\n      labels:\n        version: v1\n    - name: v2\n      labels:\n        version: v2\n'})}),"\n",(0,t.jsx)(n.h2,{id:"\u65ad\u8def\u5668\u6a21\u5f0fcircuit-breaker",children:"\u65ad\u8def\u5668\u6a21\u5f0f\uff08Circuit Breaker\uff09"}),"\n",(0,t.jsx)(n.h3,{id:"\u6982\u8ff0-2",children:"\u6982\u8ff0"}),"\n",(0,t.jsx)(n.p,{children:"\u65ad\u8def\u5668\u6a21\u5f0f\u7528\u4e8e\u9632\u6b62\u7ea7\u8054\u6545\u969c\uff0c\u5f53\u670d\u52a1\u8c03\u7528\u5931\u8d25\u7387\u8fbe\u5230\u9608\u503c\u65f6\uff0c\u65ad\u8def\u5668\u6253\u5f00\uff0c\u5feb\u901f\u5931\u8d25\u800c\u4e0d\u662f\u7b49\u5f85\u8d85\u65f6\u3002"}),"\n",(0,t.jsx)(n.mermaid,{value:"stateDiagram-v2\n    [*] --\x3e Closed\n    Closed --\x3e Open: \u5931\u8d25\u7387\u8d85\u8fc7\u9608\u503c\n    Open --\x3e HalfOpen: \u7b49\u5f85\u8d85\u65f6\n    HalfOpen --\x3e Closed: \u63a2\u6d4b\u6210\u529f\n    HalfOpen --\x3e Open: \u63a2\u6d4b\u5931\u8d25"}),"\n",(0,t.jsx)(n.h3,{id:"\u65ad\u8def\u5668\u72b6\u6001",children:"\u65ad\u8def\u5668\u72b6\u6001"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"\u72b6\u6001"}),(0,t.jsx)(n.th,{children:"\u8bf4\u660e"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.strong,{children:"Closed"})}),(0,t.jsx)(n.td,{children:"\u6b63\u5e38\u72b6\u6001\uff0c\u8bf7\u6c42\u6b63\u5e38\u901a\u8fc7"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.strong,{children:"Open"})}),(0,t.jsx)(n.td,{children:"\u7194\u65ad\u72b6\u6001\uff0c\u8bf7\u6c42\u5feb\u901f\u5931\u8d25"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.strong,{children:"Half-Open"})}),(0,t.jsx)(n.td,{children:"\u534a\u5f00\u72b6\u6001\uff0c\u5141\u8bb8\u90e8\u5206\u8bf7\u6c42\u63a2\u6d4b"})]})]})]}),"\n",(0,t.jsx)(n.h3,{id:"resilience4j-\u5b9e\u73b0",children:"Resilience4j \u5b9e\u73b0"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:'// \u914d\u7f6e\u65ad\u8def\u5668\n@Configuration\npublic class CircuitBreakerConfig {\n    \n    @Bean\n    public CircuitBreakerRegistry circuitBreakerRegistry() {\n        CircuitBreakerConfig config = CircuitBreakerConfig.custom()\n            .failureRateThreshold(50)           // \u5931\u8d25\u7387\u9608\u503c 50%\n            .waitDurationInOpenState(Duration.ofSeconds(30))  // \u7194\u65ad\u7b49\u5f85\u65f6\u95f4\n            .slidingWindowSize(10)              // \u6ed1\u52a8\u7a97\u53e3\u5927\u5c0f\n            .minimumNumberOfCalls(5)            // \u6700\u5c0f\u8c03\u7528\u6b21\u6570\n            .build();\n        \n        return CircuitBreakerRegistry.of(config);\n    }\n}\n\n// \u4f7f\u7528\u65ad\u8def\u5668\n@Service\npublic class OrderService {\n    \n    private final CircuitBreaker circuitBreaker;\n    private final UserClient userClient;\n    \n    public OrderService(CircuitBreakerRegistry registry, UserClient userClient) {\n        this.circuitBreaker = registry.circuitBreaker("userService");\n        this.userClient = userClient;\n    }\n    \n    public User getUser(Long userId) {\n        return circuitBreaker.executeSupplier(() -> userClient.getUser(userId));\n    }\n    \n    // \u4f7f\u7528\u6ce8\u89e3\u65b9\u5f0f\n    @CircuitBreaker(name = "userService", fallbackMethod = "getUserFallback")\n    public User getUserWithAnnotation(Long userId) {\n        return userClient.getUser(userId);\n    }\n    \n    public User getUserFallback(Long userId, Exception e) {\n        return new User(userId, "Unknown", "\u964d\u7ea7\u7528\u6237");\n    }\n}\n'})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"# application.yml\nresilience4j:\n  circuitbreaker:\n    instances:\n      userService:\n        registerHealthIndicator: true\n        slidingWindowSize: 10\n        minimumNumberOfCalls: 5\n        failureRateThreshold: 50\n        waitDurationInOpenState: 30s\n        permittedNumberOfCallsInHalfOpenState: 3\n"})}),"\n",(0,t.jsx)(n.h2,{id:"saga-\u6a21\u5f0f",children:"Saga \u6a21\u5f0f"}),"\n",(0,t.jsx)(n.h3,{id:"\u6982\u8ff0-3",children:"\u6982\u8ff0"}),"\n",(0,t.jsx)(n.p,{children:"Saga \u6a21\u5f0f\u7528\u4e8e\u7ba1\u7406\u5206\u5e03\u5f0f\u4e8b\u52a1\uff0c\u5c06\u957f\u4e8b\u52a1\u62c6\u5206\u4e3a\u591a\u4e2a\u672c\u5730\u4e8b\u52a1\uff0c\u901a\u8fc7\u8865\u507f\u673a\u5236\u4fdd\u8bc1\u6700\u7ec8\u4e00\u81f4\u6027\u3002"}),"\n",(0,t.jsx)(n.mermaid,{value:"sequenceDiagram\n    participant O as \u8ba2\u5355\u670d\u52a1\n    participant I as \u5e93\u5b58\u670d\u52a1\n    participant P as \u652f\u4ed8\u670d\u52a1\n    \n    O->>O: 1. \u521b\u5efa\u8ba2\u5355\n    O->>I: 2. \u6263\u51cf\u5e93\u5b58\n    I--\x3e>O: \u5e93\u5b58\u6263\u51cf\u6210\u529f\n    O->>P: 3. \u6267\u884c\u652f\u4ed8\n    P--\x3e>O: \u652f\u4ed8\u5931\u8d25\n    O->>I: 4. \u8865\u507f\uff1a\u6062\u590d\u5e93\u5b58\n    O->>O: 5. \u8865\u507f\uff1a\u53d6\u6d88\u8ba2\u5355"}),"\n",(0,t.jsx)(n.h3,{id:"\u5b9e\u73b0\u65b9\u5f0f",children:"\u5b9e\u73b0\u65b9\u5f0f"}),"\n",(0,t.jsx)(n.h4,{id:"\u7f16\u6392\u5f0fchoreography",children:"\u7f16\u6392\u5f0f\uff08Choreography\uff09"}),"\n",(0,t.jsx)(n.p,{children:"\u670d\u52a1\u901a\u8fc7\u4e8b\u4ef6\u76f8\u4e92\u534f\u8c03\uff0c\u65e0\u4e2d\u5fc3\u534f\u8c03\u8005\uff1a"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:"// \u8ba2\u5355\u670d\u52a1 - \u53d1\u5e03\u4e8b\u4ef6\n@Service\npublic class OrderService {\n    \n    @Autowired\n    private ApplicationEventPublisher eventPublisher;\n    \n    @Transactional\n    public Order createOrder(OrderDTO dto) {\n        Order order = orderRepository.save(new Order(dto));\n        eventPublisher.publishEvent(new OrderCreatedEvent(order));\n        return order;\n    }\n    \n    @EventListener\n    public void handlePaymentFailed(PaymentFailedEvent event) {\n        // \u8865\u507f\uff1a\u53d6\u6d88\u8ba2\u5355\n        Order order = orderRepository.findById(event.getOrderId()).orElseThrow();\n        order.setStatus(OrderStatus.CANCELLED);\n        orderRepository.save(order);\n    }\n}\n\n// \u5e93\u5b58\u670d\u52a1 - \u76d1\u542c\u4e8b\u4ef6\n@Service\npublic class InventoryService {\n    \n    @EventListener\n    public void handleOrderCreated(OrderCreatedEvent event) {\n        try {\n            deductInventory(event.getItems());\n            eventPublisher.publishEvent(new InventoryDeductedEvent(event.getOrderId()));\n        } catch (Exception e) {\n            eventPublisher.publishEvent(new InventoryDeductFailedEvent(event.getOrderId()));\n        }\n    }\n}\n"})}),"\n",(0,t.jsx)(n.h4,{id:"\u534f\u8c03\u5f0forchestration",children:"\u534f\u8c03\u5f0f\uff08Orchestration\uff09"}),"\n",(0,t.jsx)(n.p,{children:"\u4f7f\u7528\u4e2d\u5fc3\u534f\u8c03\u8005\u7ba1\u7406 Saga \u6d41\u7a0b\uff1a"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:"// Saga \u534f\u8c03\u8005\n@Service\npublic class OrderSagaOrchestrator {\n    \n    public void createOrderSaga(OrderDTO dto) {\n        SagaBuilder.create()\n            .step(orderService::createOrder)\n            .compensate(orderService::cancelOrder)\n            .step(inventoryService::deductInventory)\n            .compensate(inventoryService::restoreInventory)\n            .step(paymentService::processPayment)\n            .compensate(paymentService::refund)\n            .execute(dto);\n    }\n}\n"})}),"\n",(0,t.jsx)(n.h2,{id:"cqrs-\u548c\u4e8b\u4ef6\u6eaf\u6e90",children:"CQRS \u548c\u4e8b\u4ef6\u6eaf\u6e90"}),"\n",(0,t.jsx)(n.h3,{id:"cqrs\u547d\u4ee4\u67e5\u8be2\u804c\u8d23\u5206\u79bb",children:"CQRS\uff08\u547d\u4ee4\u67e5\u8be2\u804c\u8d23\u5206\u79bb\uff09"}),"\n",(0,t.jsx)(n.p,{children:"\u5c06\u8bfb\u64cd\u4f5c\u548c\u5199\u64cd\u4f5c\u5206\u79bb\u5230\u4e0d\u540c\u7684\u6a21\u578b\uff1a"}),"\n",(0,t.jsx)(n.mermaid,{value:"graph TB\n    Client[\u5ba2\u6237\u7aef]\n    \n    Client --\x3e|\u547d\u4ee4| CmdAPI[\u547d\u4ee4 API]\n    Client --\x3e|\u67e5\u8be2| QueryAPI[\u67e5\u8be2 API]\n    \n    CmdAPI --\x3e CmdHandler[\u547d\u4ee4\u5904\u7406\u5668]\n    CmdHandler --\x3e WriteDB[(\u5199\u6570\u636e\u5e93)]\n    \n    WriteDB --\x3e|\u540c\u6b65| ReadDB[(\u8bfb\u6570\u636e\u5e93)]\n    \n    QueryAPI --\x3e QueryHandler[\u67e5\u8be2\u5904\u7406\u5668]\n    QueryHandler --\x3e ReadDB\n    \n    style CmdAPI fill:#ffcdd2\n    style QueryAPI fill:#c8e6c9"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:"// \u547d\u4ee4\u6a21\u578b\n@Service\npublic class OrderCommandService {\n    \n    @Autowired\n    private OrderRepository orderRepository;\n    \n    @Autowired\n    private EventPublisher eventPublisher;\n    \n    @Transactional\n    public void createOrder(CreateOrderCommand command) {\n        Order order = new Order(command);\n        orderRepository.save(order);\n        eventPublisher.publish(new OrderCreatedEvent(order));\n    }\n}\n\n// \u67e5\u8be2\u6a21\u578b\n@Service\npublic class OrderQueryService {\n    \n    @Autowired\n    private OrderReadRepository readRepository;\n    \n    public OrderDTO getOrder(Long orderId) {\n        return readRepository.findById(orderId)\n            .map(this::toDTO)\n            .orElseThrow();\n    }\n    \n    public List<OrderDTO> getOrdersByUser(Long userId) {\n        return readRepository.findByUserId(userId)\n            .stream()\n            .map(this::toDTO)\n            .collect(Collectors.toList());\n    }\n}\n"})}),"\n",(0,t.jsx)(n.h3,{id:"\u4e8b\u4ef6\u6eaf\u6e90event-sourcing",children:"\u4e8b\u4ef6\u6eaf\u6e90\uff08Event Sourcing\uff09"}),"\n",(0,t.jsx)(n.p,{children:"\u5c06\u72b6\u6001\u53d8\u5316\u5b58\u50a8\u4e3a\u4e8b\u4ef6\u5e8f\u5217\uff0c\u901a\u8fc7\u91cd\u653e\u4e8b\u4ef6\u6062\u590d\u72b6\u6001\uff1a"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:'// \u4e8b\u4ef6\u5b58\u50a8\npublic interface EventStore {\n    void save(String aggregateId, List<DomainEvent> events);\n    List<DomainEvent> load(String aggregateId);\n}\n\n// \u805a\u5408\u6839\npublic class Order {\n    private String id;\n    private OrderStatus status;\n    private List<OrderItem> items;\n    private List<DomainEvent> uncommittedEvents = new ArrayList<>();\n    \n    // \u4ece\u4e8b\u4ef6\u91cd\u5efa\u72b6\u6001\n    public static Order fromEvents(List<DomainEvent> events) {\n        Order order = new Order();\n        events.forEach(order::apply);\n        return order;\n    }\n    \n    // \u5e94\u7528\u4e8b\u4ef6\n    private void apply(DomainEvent event) {\n        if (event instanceof OrderCreatedEvent) {\n            this.id = ((OrderCreatedEvent) event).getOrderId();\n            this.status = OrderStatus.CREATED;\n            this.items = ((OrderCreatedEvent) event).getItems();\n        } else if (event instanceof OrderPaidEvent) {\n            this.status = OrderStatus.PAID;\n        }\n    }\n    \n    // \u4e1a\u52a1\u64cd\u4f5c\u4ea7\u751f\u4e8b\u4ef6\n    public void pay() {\n        if (status != OrderStatus.CREATED) {\n            throw new IllegalStateException("\u8ba2\u5355\u72b6\u6001\u4e0d\u5141\u8bb8\u652f\u4ed8");\n        }\n        OrderPaidEvent event = new OrderPaidEvent(this.id);\n        apply(event);\n        uncommittedEvents.add(event);\n    }\n}\n'})}),"\n",(0,t.jsx)(n.h3,{id:"\u6a21\u5f0f\u5bf9\u6bd4",children:"\u6a21\u5f0f\u5bf9\u6bd4"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"\u6a21\u5f0f"}),(0,t.jsx)(n.th,{children:"\u4f18\u70b9"}),(0,t.jsx)(n.th,{children:"\u7f3a\u70b9"}),(0,t.jsx)(n.th,{children:"\u9002\u7528\u573a\u666f"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.strong,{children:"CQRS"})}),(0,t.jsx)(n.td,{children:"\u8bfb\u5199\u5206\u79bb\u4f18\u5316\u3001\u72ec\u7acb\u6269\u5c55"}),(0,t.jsx)(n.td,{children:"\u590d\u6742\u5ea6\u589e\u52a0\u3001\u6570\u636e\u540c\u6b65\u5ef6\u8fdf"}),(0,t.jsx)(n.td,{children:"\u8bfb\u5199\u6bd4\u4f8b\u60ac\u6b8a"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.strong,{children:"\u4e8b\u4ef6\u6eaf\u6e90"})}),(0,t.jsx)(n.td,{children:"\u5b8c\u6574\u5ba1\u8ba1\u65e5\u5fd7\u3001\u65f6\u95f4\u65c5\u884c"}),(0,t.jsx)(n.td,{children:"\u67e5\u8be2\u590d\u6742\u3001\u5b58\u50a8\u589e\u957f"}),(0,t.jsx)(n.td,{children:"\u9700\u8981\u5ba1\u8ba1\u8ffd\u8e2a"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.strong,{children:"CQRS + ES"})}),(0,t.jsx)(n.td,{children:"\u7ed3\u5408\u4e24\u8005\u4f18\u70b9"}),(0,t.jsx)(n.td,{children:"\u590d\u6742\u5ea6\u6700\u9ad8"}),(0,t.jsx)(n.td,{children:"\u590d\u6742\u4e1a\u52a1\u7cfb\u7edf"})]})]})]})]})}function h(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(o,{...e})}):o(e)}}}]);