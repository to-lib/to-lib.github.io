"use strict";(globalThis.webpackChunkto_lib_github_io=globalThis.webpackChunkto_lib_github_io||[]).push([[51773],{2183:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>d,contentTitle:()=>a,default:()=>p,frontMatter:()=>i,metadata:()=>t,toc:()=>c});const t=JSON.parse('{"id":"docker/dev-experience","title":"\u5f00\u53d1\u8005\u4f53\u9a8c","description":"Dev Containers\u3001Docker Desktop \u66ff\u4ee3\u54c1\u4e0e Testcontainers","source":"@site/docs/docker/dev-experience.md","sourceDirName":"docker","slug":"/docker/dev-experience","permalink":"/docs/docker/dev-experience","draft":false,"unlisted":false,"editUrl":"https://github.com/to-lib/to-lib.github.io/tree/main/docs/docker/dev-experience.md","tags":[],"version":"current","sidebarPosition":25,"frontMatter":{"sidebar_position":25,"title":"\u5f00\u53d1\u8005\u4f53\u9a8c","description":"Dev Containers\u3001Docker Desktop \u66ff\u4ee3\u54c1\u4e0e Testcontainers"},"sidebar":"docker","previous":{"title":"\u6392\u969c\u6307\u5357","permalink":"/docs/docker/troubleshooting"},"next":{"title":"CI/CD \u96c6\u6210","permalink":"/docs/docker/cicd"}}');var r=s(22714),o=s(48885);const i={sidebar_position:25,title:"\u5f00\u53d1\u8005\u4f53\u9a8c",description:"Dev Containers\u3001Docker Desktop \u66ff\u4ee3\u54c1\u4e0e Testcontainers"},a="\u5f00\u53d1\u8005\u4f53\u9a8c",d={},c=[{value:"Dev Containers",id:"dev-containers",level:2},{value:"\u57fa\u7840\u914d\u7f6e",id:"\u57fa\u7840\u914d\u7f6e",level:3},{value:"\u4f7f\u7528 Dockerfile",id:"\u4f7f\u7528-dockerfile",level:3},{value:"\u4f7f\u7528 Docker Compose",id:"\u4f7f\u7528-docker-compose",level:3},{value:"Docker Desktop \u66ff\u4ee3\u54c1",id:"docker-desktop-\u66ff\u4ee3\u54c1",level:2},{value:"Colima (macOS/Linux)",id:"colima-macoslinux",level:3},{value:"Rancher Desktop (\u8de8\u5e73\u53f0)",id:"rancher-desktop-\u8de8\u5e73\u53f0",level:3},{value:"OrbStack (macOS)",id:"orbstack-macos",level:3},{value:"Podman (\u8de8\u5e73\u53f0)",id:"podman-\u8de8\u5e73\u53f0",level:3},{value:"\u5bf9\u6bd4",id:"\u5bf9\u6bd4",level:3},{value:"Testcontainers",id:"testcontainers",level:2},{value:"Java (JUnit 5)",id:"java-junit-5",level:3},{value:"Node.js (Jest)",id:"nodejs-jest",level:3},{value:"Go",id:"go",level:3},{value:"Python (pytest)",id:"python-pytest",level:3},{value:"\u672c\u5730\u5f00\u53d1\u6700\u4f73\u5b9e\u8df5",id:"\u672c\u5730\u5f00\u53d1\u6700\u4f73\u5b9e\u8df5",level:2},{value:"\u5f00\u53d1\u73af\u5883 Docker Compose",id:"\u5f00\u53d1\u73af\u5883-docker-compose",level:3},{value:"\u70ed\u91cd\u8f7d\u914d\u7f6e",id:"\u70ed\u91cd\u8f7d\u914d\u7f6e",level:3},{value:"Makefile \u7b80\u5316\u547d\u4ee4",id:"makefile-\u7b80\u5316\u547d\u4ee4",level:3}];function l(e){const n={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",p:"p",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",...(0,o.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"\u5f00\u53d1\u8005\u4f53\u9a8c",children:"\u5f00\u53d1\u8005\u4f53\u9a8c"})}),"\n",(0,r.jsx)(n.p,{children:"\u63d0\u5347 Docker \u5f00\u53d1\u4f53\u9a8c\u7684\u5de5\u5177\u548c\u6700\u4f73\u5b9e\u8df5\u3002"}),"\n",(0,r.jsx)(n.h2,{id:"dev-containers",children:"Dev Containers"}),"\n",(0,r.jsx)(n.p,{children:"VS Code Dev Containers \u5141\u8bb8\u5728\u5bb9\u5668\u4e2d\u8fdb\u884c\u5f00\u53d1\uff0c\u786e\u4fdd\u5f00\u53d1\u73af\u5883\u4e00\u81f4\u6027\u3002"}),"\n",(0,r.jsx)(n.h3,{id:"\u57fa\u7840\u914d\u7f6e",children:"\u57fa\u7840\u914d\u7f6e"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'// .devcontainer/devcontainer.json\n{\n  "name": "Node.js Development",\n  "image": "mcr.microsoft.com/devcontainers/javascript-node:18",\n  "features": {\n    "ghcr.io/devcontainers/features/docker-in-docker:2": {}\n  },\n  "customizations": {\n    "vscode": {\n      "extensions": [\n        "dbaeumer.vscode-eslint",\n        "esbenp.prettier-vscode"\n      ],\n      "settings": {\n        "editor.formatOnSave": true\n      }\n    }\n  },\n  "forwardPorts": [3000],\n  "postCreateCommand": "npm install",\n  "remoteUser": "node"\n}\n'})}),"\n",(0,r.jsx)(n.h3,{id:"\u4f7f\u7528-dockerfile",children:"\u4f7f\u7528 Dockerfile"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'// .devcontainer/devcontainer.json\n{\n  "name": "Custom Dev Container",\n  "build": {\n    "dockerfile": "Dockerfile",\n    "context": ".."\n  },\n  "mounts": [\n    "source=${localWorkspaceFolder},target=/workspace,type=bind"\n  ],\n  "workspaceFolder": "/workspace"\n}\n'})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-dockerfile",children:"# .devcontainer/Dockerfile\nFROM mcr.microsoft.com/devcontainers/base:ubuntu\n\nRUN apt-get update && apt-get install -y \\\n    curl \\\n    git \\\n    vim \\\n    && rm -rf /var/lib/apt/lists/*\n\n# \u5b89\u88c5 Node.js\nRUN curl -fsSL https://deb.nodesource.com/setup_18.x | bash - \\\n    && apt-get install -y nodejs\n\nUSER vscode\n"})}),"\n",(0,r.jsx)(n.h3,{id:"\u4f7f\u7528-docker-compose",children:"\u4f7f\u7528 Docker Compose"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'// .devcontainer/devcontainer.json\n{\n  "name": "Full Stack Dev",\n  "dockerComposeFile": "docker-compose.yml",\n  "service": "app",\n  "workspaceFolder": "/workspace",\n  "shutdownAction": "stopCompose"\n}\n'})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"# .devcontainer/docker-compose.yml\nservices:\n  app:\n    build:\n      context: .\n      dockerfile: Dockerfile\n    volumes:\n      - ..:/workspace:cached\n    command: sleep infinity\n\n  db:\n    image: postgres:15\n    environment:\n      POSTGRES_PASSWORD: postgres\n\n  redis:\n    image: redis:alpine\n"})}),"\n",(0,r.jsx)(n.h2,{id:"docker-desktop-\u66ff\u4ee3\u54c1",children:"Docker Desktop \u66ff\u4ee3\u54c1"}),"\n",(0,r.jsx)(n.h3,{id:"colima-macoslinux",children:"Colima (macOS/Linux)"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"# \u5b89\u88c5\nbrew install colima docker\n\n# \u542f\u52a8\uff08\u9ed8\u8ba4\u914d\u7f6e\uff09\ncolima start\n\n# \u81ea\u5b9a\u4e49\u8d44\u6e90\ncolima start --cpu 4 --memory 8 --disk 100\n\n# \u4f7f\u7528 containerd \u8fd0\u884c\u65f6\ncolima start --runtime containerd\n\n# \u542f\u7528 Kubernetes\ncolima start --kubernetes\n\n# \u67e5\u770b\u72b6\u6001\ncolima status\n\n# \u505c\u6b62\ncolima stop\n"})}),"\n",(0,r.jsx)(n.h3,{id:"rancher-desktop-\u8de8\u5e73\u53f0",children:"Rancher Desktop (\u8de8\u5e73\u53f0)"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"# macOS \u5b89\u88c5\nbrew install --cask rancher\n\n# \u7279\u70b9\uff1a\n# - \u652f\u6301 containerd \u548c dockerd\n# - \u5185\u7f6e Kubernetes\n# - \u56fe\u5f62\u754c\u9762\u7ba1\u7406\n# - \u652f\u6301 Windows/macOS/Linux\n"})}),"\n",(0,r.jsx)(n.h3,{id:"orbstack-macos",children:"OrbStack (macOS)"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"# \u5b89\u88c5\nbrew install --cask orbstack\n\n# \u7279\u70b9\uff1a\n# - \u6781\u5feb\u7684\u542f\u52a8\u901f\u5ea6\n# - \u4f4e\u8d44\u6e90\u5360\u7528\n# - \u539f\u751f macOS \u96c6\u6210\n# - \u652f\u6301 Linux \u865a\u62df\u673a\n"})}),"\n",(0,r.jsx)(n.h3,{id:"podman-\u8de8\u5e73\u53f0",children:"Podman (\u8de8\u5e73\u53f0)"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"# macOS \u5b89\u88c5\nbrew install podman\n\n# \u521d\u59cb\u5316\u865a\u62df\u673a\npodman machine init\npodman machine start\n\n# \u4f7f\u7528\uff08\u547d\u4ee4\u517c\u5bb9 Docker\uff09\npodman run -d -p 80:80 nginx\npodman ps\npodman images\n\n# \u8bbe\u7f6e\u522b\u540d\nalias docker=podman\n"})}),"\n",(0,r.jsx)(n.h3,{id:"\u5bf9\u6bd4",children:"\u5bf9\u6bd4"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"\u5de5\u5177"}),(0,r.jsx)(n.th,{children:"\u5e73\u53f0"}),(0,r.jsx)(n.th,{children:"\u8d44\u6e90\u5360\u7528"}),(0,r.jsx)(n.th,{children:"Kubernetes"}),(0,r.jsx)(n.th,{children:"\u7279\u70b9"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"Docker Desktop"}),(0,r.jsx)(n.td,{children:"\u5168\u5e73\u53f0"}),(0,r.jsx)(n.td,{children:"\u9ad8"}),(0,r.jsx)(n.td,{children:"\u652f\u6301"}),(0,r.jsx)(n.td,{children:"\u5b98\u65b9\uff0c\u529f\u80fd\u5168\u9762"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"Colima"}),(0,r.jsx)(n.td,{children:"macOS/Linux"}),(0,r.jsx)(n.td,{children:"\u4f4e"}),(0,r.jsx)(n.td,{children:"\u652f\u6301"}),(0,r.jsx)(n.td,{children:"\u8f7b\u91cf\uff0c\u547d\u4ee4\u884c"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"Rancher Desktop"}),(0,r.jsx)(n.td,{children:"\u5168\u5e73\u53f0"}),(0,r.jsx)(n.td,{children:"\u4e2d"}),(0,r.jsx)(n.td,{children:"\u652f\u6301"}),(0,r.jsx)(n.td,{children:"GUI\uff0c\u591a\u8fd0\u884c\u65f6"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"OrbStack"}),(0,r.jsx)(n.td,{children:"macOS"}),(0,r.jsx)(n.td,{children:"\u6781\u4f4e"}),(0,r.jsx)(n.td,{children:"\u652f\u6301"}),(0,r.jsx)(n.td,{children:"\u6700\u5feb\uff0c\u539f\u751f\u96c6\u6210"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"Podman"}),(0,r.jsx)(n.td,{children:"\u5168\u5e73\u53f0"}),(0,r.jsx)(n.td,{children:"\u4f4e"}),(0,r.jsx)(n.td,{children:"\u4e0d\u652f\u6301"}),(0,r.jsx)(n.td,{children:"\u65e0\u5b88\u62a4\u8fdb\u7a0b"})]})]})]}),"\n",(0,r.jsx)(n.h2,{id:"testcontainers",children:"Testcontainers"}),"\n",(0,r.jsx)(n.p,{children:"\u5728\u96c6\u6210\u6d4b\u8bd5\u4e2d\u4f7f\u7528\u771f\u5b9e\u7684\u5bb9\u5668\u5316\u4f9d\u8d56\u3002"}),"\n",(0,r.jsx)(n.h3,{id:"java-junit-5",children:"Java (JUnit 5)"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:'@Testcontainers\nclass UserServiceTest {\n\n    @Container\n    static PostgreSQLContainer<?> postgres = new PostgreSQLContainer<>("postgres:15")\n        .withDatabaseName("testdb")\n        .withUsername("test")\n        .withPassword("test");\n\n    @Container\n    static GenericContainer<?> redis = new GenericContainer<>("redis:alpine")\n        .withExposedPorts(6379);\n\n    @DynamicPropertySource\n    static void configureProperties(DynamicPropertyRegistry registry) {\n        registry.add("spring.datasource.url", postgres::getJdbcUrl);\n        registry.add("spring.datasource.username", postgres::getUsername);\n        registry.add("spring.datasource.password", postgres::getPassword);\n        registry.add("spring.redis.host", redis::getHost);\n        registry.add("spring.redis.port", () -> redis.getMappedPort(6379));\n    }\n\n    @Test\n    void testUserCreation() {\n        // \u6d4b\u8bd5\u4ee3\u7801\n    }\n}\n'})}),"\n",(0,r.jsx)(n.h3,{id:"nodejs-jest",children:"Node.js (Jest)"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:'const { GenericContainer, Wait } = require("testcontainers");\n\ndescribe("User Service", () => {\n  let postgresContainer;\n  let redisContainer;\n\n  beforeAll(async () => {\n    postgresContainer = await new GenericContainer("postgres:15")\n      .withEnvironment({\n        POSTGRES_DB: "testdb",\n        POSTGRES_USER: "test",\n        POSTGRES_PASSWORD: "test"\n      })\n      .withExposedPorts(5432)\n      .withWaitStrategy(Wait.forLogMessage(/ready to accept connections/))\n      .start();\n\n    redisContainer = await new GenericContainer("redis:alpine")\n      .withExposedPorts(6379)\n      .start();\n\n    process.env.DATABASE_URL = `postgresql://test:test@${postgresContainer.getHost()}:${postgresContainer.getMappedPort(5432)}/testdb`;\n    process.env.REDIS_URL = `redis://${redisContainer.getHost()}:${redisContainer.getMappedPort(6379)}`;\n  }, 60000);\n\n  afterAll(async () => {\n    await postgresContainer?.stop();\n    await redisContainer?.stop();\n  });\n\n  test("should create user", async () => {\n    // \u6d4b\u8bd5\u4ee3\u7801\n  });\n});\n'})}),"\n",(0,r.jsx)(n.h3,{id:"go",children:"Go"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-go",children:'package main\n\nimport (\n    "context"\n    "testing"\n    "github.com/testcontainers/testcontainers-go"\n    "github.com/testcontainers/testcontainers-go/wait"\n)\n\nfunc TestUserService(t *testing.T) {\n    ctx := context.Background()\n\n    // \u542f\u52a8 PostgreSQL \u5bb9\u5668\n    postgresC, err := testcontainers.GenericContainer(ctx, testcontainers.GenericContainerRequest{\n        ContainerRequest: testcontainers.ContainerRequest{\n            Image:        "postgres:15",\n            ExposedPorts: []string{"5432/tcp"},\n            Env: map[string]string{\n                "POSTGRES_DB":       "testdb",\n                "POSTGRES_USER":     "test",\n                "POSTGRES_PASSWORD": "test",\n            },\n            WaitingFor: wait.ForLog("ready to accept connections"),\n        },\n        Started: true,\n    })\n    if err != nil {\n        t.Fatal(err)\n    }\n    defer postgresC.Terminate(ctx)\n\n    host, _ := postgresC.Host(ctx)\n    port, _ := postgresC.MappedPort(ctx, "5432")\n\n    // \u4f7f\u7528 host \u548c port \u8fde\u63a5\u6570\u636e\u5e93\u8fdb\u884c\u6d4b\u8bd5\n}\n'})}),"\n",(0,r.jsx)(n.h3,{id:"python-pytest",children:"Python (pytest)"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'import pytest\nfrom testcontainers.postgres import PostgresContainer\nfrom testcontainers.redis import RedisContainer\n\n@pytest.fixture(scope="session")\ndef postgres():\n    with PostgresContainer("postgres:15") as postgres:\n        yield postgres\n\n@pytest.fixture(scope="session")\ndef redis():\n    with RedisContainer("redis:alpine") as redis:\n        yield redis\n\ndef test_user_creation(postgres, redis):\n    # \u83b7\u53d6\u8fde\u63a5\u4fe1\u606f\n    db_url = postgres.get_connection_url()\n    redis_host = redis.get_container_host_ip()\n    redis_port = redis.get_exposed_port(6379)\n\n    # \u6d4b\u8bd5\u4ee3\u7801\n    assert True\n'})}),"\n",(0,r.jsx)(n.h2,{id:"\u672c\u5730\u5f00\u53d1\u6700\u4f73\u5b9e\u8df5",children:"\u672c\u5730\u5f00\u53d1\u6700\u4f73\u5b9e\u8df5"}),"\n",(0,r.jsx)(n.h3,{id:"\u5f00\u53d1\u73af\u5883-docker-compose",children:"\u5f00\u53d1\u73af\u5883 Docker Compose"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:'# docker-compose.dev.yml\nservices:\n  app:\n    build:\n      context: .\n      target: development\n    volumes:\n      - .:/app\n      - node_modules:/app/node_modules\n    ports:\n      - "3000:3000"\n      - "9229:9229"  # \u8c03\u8bd5\u7aef\u53e3\n    environment:\n      - NODE_ENV=development\n    command: npm run dev\n\n  db:\n    image: postgres:15\n    ports:\n      - "5432:5432"\n    environment:\n      POSTGRES_PASSWORD: dev\n    volumes:\n      - postgres-data:/var/lib/postgresql/data\n      - ./init.sql:/docker-entrypoint-initdb.d/init.sql\n\n  redis:\n    image: redis:alpine\n    ports:\n      - "6379:6379"\n\n  mailhog:\n    image: mailhog/mailhog\n    ports:\n      - "1025:1025"  # SMTP\n      - "8025:8025"  # Web UI\n\nvolumes:\n  node_modules:\n  postgres-data:\n'})}),"\n",(0,r.jsx)(n.h3,{id:"\u70ed\u91cd\u8f7d\u914d\u7f6e",children:"\u70ed\u91cd\u8f7d\u914d\u7f6e"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-dockerfile",children:'# Dockerfile\nFROM node:18-alpine AS development\nWORKDIR /app\nCOPY package*.json ./\nRUN npm install\n# \u4e0d\u590d\u5236\u6e90\u4ee3\u7801\uff0c\u901a\u8fc7 volume \u6302\u8f7d\nCMD ["npm", "run", "dev"]\n\nFROM node:18-alpine AS production\nWORKDIR /app\nCOPY package*.json ./\nRUN npm ci --only=production\nCOPY . .\nRUN npm run build\nCMD ["npm", "start"]\n'})}),"\n",(0,r.jsx)(n.h3,{id:"makefile-\u7b80\u5316\u547d\u4ee4",children:"Makefile \u7b80\u5316\u547d\u4ee4"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-makefile",children:".PHONY: dev build test clean\n\ndev:\n\tdocker compose -f docker-compose.dev.yml up\n\nbuild:\n\tdocker compose build\n\ntest:\n\tdocker compose -f docker-compose.test.yml up --abort-on-container-exit\n\nclean:\n\tdocker compose down -v\n\tdocker system prune -f\n\nlogs:\n\tdocker compose logs -f\n\nshell:\n\tdocker compose exec app sh\n"})})]})}function p(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(l,{...e})}):l(e)}},48885:(e,n,s)=>{s.d(n,{R:()=>i,x:()=>a});var t=s(99378);const r={},o=t.createContext(r);function i(e){const n=t.useContext(o);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:i(e.components),t.createElement(o.Provider,{value:n},e.children)}}}]);