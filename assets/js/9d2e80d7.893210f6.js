"use strict";(globalThis.webpackChunkto_lib_github_io=globalThis.webpackChunkto_lib_github_io||[]).push([[50176],{13802:(n,e,r)=>{r.r(e),r.d(e,{assets:()=>c,contentTitle:()=>o,default:()=>h,frontMatter:()=>s,metadata:()=>t,toc:()=>l});const t=JSON.parse('{"id":"frontend/advanced/monitoring","title":"\u524d\u7aef\u76d1\u63a7","description":"[!TIP]","source":"@site/docs/frontend/advanced/monitoring.md","sourceDirName":"frontend/advanced","slug":"/frontend/advanced/monitoring","permalink":"/docs/frontend/advanced/monitoring","draft":false,"unlisted":false,"editUrl":"https://github.com/to-lib/to-lib.github.io/tree/main/docs/frontend/advanced/monitoring.md","tags":[],"version":"current","sidebarPosition":4,"frontMatter":{"sidebar_position":4,"title":"\u524d\u7aef\u76d1\u63a7"}}');var i=r(22714),a=r(48885);const s={sidebar_position:4,title:"\u524d\u7aef\u76d1\u63a7"},o="\u524d\u7aef\u76d1\u63a7",c={},l=[{value:"\ud83c\udfaf \u76d1\u63a7\u7c7b\u578b",id:"-\u76d1\u63a7\u7c7b\u578b",level:2},{value:"\ud83d\udce6 \u9519\u8bef\u76d1\u63a7",id:"-\u9519\u8bef\u76d1\u63a7",level:2},{value:"JavaScript \u9519\u8bef",id:"javascript-\u9519\u8bef",level:3},{value:"React \u9519\u8bef\u8fb9\u754c",id:"react-\u9519\u8bef\u8fb9\u754c",level:3},{value:"\u8d44\u6e90\u52a0\u8f7d\u9519\u8bef",id:"\u8d44\u6e90\u52a0\u8f7d\u9519\u8bef",level:3},{value:"\u63a5\u53e3\u9519\u8bef",id:"\u63a5\u53e3\u9519\u8bef",level:3},{value:"\u26a1 \u6027\u80fd\u76d1\u63a7",id:"-\u6027\u80fd\u76d1\u63a7",level:2},{value:"Core Web Vitals",id:"core-web-vitals",level:3},{value:"Performance API",id:"performance-api",level:3},{value:"\u957f\u4efb\u52a1\u76d1\u63a7",id:"\u957f\u4efb\u52a1\u76d1\u63a7",level:3},{value:"\ud83d\udc46 \u7528\u6237\u884c\u4e3a\u76d1\u63a7",id:"-\u7528\u6237\u884c\u4e3a\u76d1\u63a7",level:2},{value:"\u70b9\u51fb\u57cb\u70b9",id:"\u70b9\u51fb\u57cb\u70b9",level:3},{value:"PV/UV \u7edf\u8ba1",id:"pvuv-\u7edf\u8ba1",level:3},{value:"\u7528\u6237\u8f68\u8ff9",id:"\u7528\u6237\u8f68\u8ff9",level:3},{value:"\ud83d\udcca \u6570\u636e\u4e0a\u62a5",id:"-\u6570\u636e\u4e0a\u62a5",level:2},{value:"Beacon API",id:"beacon-api",level:3},{value:"\u6279\u91cf\u4e0a\u62a5",id:"\u6279\u91cf\u4e0a\u62a5",level:3},{value:"\ud83d\udd27 \u76d1\u63a7\u5e73\u53f0",id:"-\u76d1\u63a7\u5e73\u53f0",level:2},{value:"\u5f00\u6e90\u65b9\u6848",id:"\u5f00\u6e90\u65b9\u6848",level:3},{value:"\u5546\u4e1a\u65b9\u6848",id:"\u5546\u4e1a\u65b9\u6848",level:3},{value:"\ud83d\udca1 \u6700\u4f73\u5b9e\u8df5",id:"-\u6700\u4f73\u5b9e\u8df5",level:2},{value:"\ud83d\udd17 \u76f8\u5173\u8d44\u6e90",id:"-\u76f8\u5173\u8d44\u6e90",level:2}];function d(n){const e={a:"a",blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",mermaid:"mermaid",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,a.R)(),...n.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(e.header,{children:(0,i.jsx)(e.h1,{id:"\u524d\u7aef\u76d1\u63a7",children:"\u524d\u7aef\u76d1\u63a7"})}),"\n",(0,i.jsxs)(e.blockquote,{children:["\n",(0,i.jsx)(e.p,{children:"[!TIP]\n\u524d\u7aef\u76d1\u63a7\u5e2e\u52a9\u6211\u4eec\u4e86\u89e3\u7ebf\u4e0a\u5e94\u7528\u7684\u771f\u5b9e\u8868\u73b0\uff0c\u53ca\u65f6\u53d1\u73b0\u95ee\u9898\u5e76\u4f18\u5316\u4f53\u9a8c\u3002"}),"\n"]}),"\n",(0,i.jsx)(e.h2,{id:"-\u76d1\u63a7\u7c7b\u578b",children:"\ud83c\udfaf \u76d1\u63a7\u7c7b\u578b"}),"\n",(0,i.jsx)(e.mermaid,{value:"graph LR\n    A[\u524d\u7aef\u76d1\u63a7] --\x3e B[\u9519\u8bef\u76d1\u63a7]\n    A --\x3e C[\u6027\u80fd\u76d1\u63a7]\n    A --\x3e D[\u7528\u6237\u884c\u4e3a]\n    A --\x3e E[\u4e1a\u52a1\u76d1\u63a7]"}),"\n",(0,i.jsx)(e.h2,{id:"-\u9519\u8bef\u76d1\u63a7",children:"\ud83d\udce6 \u9519\u8bef\u76d1\u63a7"}),"\n",(0,i.jsx)(e.h3,{id:"javascript-\u9519\u8bef",children:"JavaScript \u9519\u8bef"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-javascript",children:'// \u5168\u5c40\u9519\u8bef\u6355\u83b7\nwindow.onerror = function (message, source, lineno, colno, error) {\n  reportError({\n    type: "js_error",\n    message,\n    source,\n    lineno,\n    colno,\n    stack: error?.stack,\n  });\n  return false; // \u4e0d\u963b\u6b62\u9ed8\u8ba4\u5904\u7406\n};\n\n// Promise \u672a\u6355\u83b7\u9519\u8bef\nwindow.addEventListener("unhandledrejection", (event) => {\n  reportError({\n    type: "promise_error",\n    reason: event.reason,\n  });\n});\n'})}),"\n",(0,i.jsx)(e.h3,{id:"react-\u9519\u8bef\u8fb9\u754c",children:"React \u9519\u8bef\u8fb9\u754c"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-jsx",children:'class ErrorBoundary extends React.Component {\n  state = { hasError: false };\n\n  static getDerivedStateFromError(error) {\n    return { hasError: true };\n  }\n\n  componentDidCatch(error, errorInfo) {\n    reportError({\n      type: "react_error",\n      error: error.message,\n      stack: error.stack,\n      componentStack: errorInfo.componentStack,\n    });\n  }\n\n  render() {\n    if (this.state.hasError) {\n      return <h1>\u51fa\u9519\u4e86</h1>;\n    }\n    return this.props.children;\n  }\n}\n'})}),"\n",(0,i.jsx)(e.h3,{id:"\u8d44\u6e90\u52a0\u8f7d\u9519\u8bef",children:"\u8d44\u6e90\u52a0\u8f7d\u9519\u8bef"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-javascript",children:'window.addEventListener(\n  "error",\n  (event) => {\n    const target = event.target;\n\n    if (target.tagName === "IMG" || target.tagName === "SCRIPT") {\n      reportError({\n        type: "resource_error",\n        tagName: target.tagName,\n        src: target.src || target.href,\n      });\n    }\n  },\n  true\n); // \u6355\u83b7\u9636\u6bb5\n'})}),"\n",(0,i.jsx)(e.h3,{id:"\u63a5\u53e3\u9519\u8bef",children:"\u63a5\u53e3\u9519\u8bef"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-javascript",children:'// \u5c01\u88c5 fetch\nconst originalFetch = window.fetch;\n\nwindow.fetch = async function (...args) {\n  const startTime = Date.now();\n\n  try {\n    const response = await originalFetch.apply(this, args);\n\n    if (!response.ok) {\n      reportError({\n        type: "api_error",\n        url: args[0],\n        status: response.status,\n        duration: Date.now() - startTime,\n      });\n    }\n\n    return response;\n  } catch (error) {\n    reportError({\n      type: "network_error",\n      url: args[0],\n      error: error.message,\n    });\n    throw error;\n  }\n};\n'})}),"\n",(0,i.jsx)(e.h2,{id:"-\u6027\u80fd\u76d1\u63a7",children:"\u26a1 \u6027\u80fd\u76d1\u63a7"}),"\n",(0,i.jsx)(e.h3,{id:"core-web-vitals",children:"Core Web Vitals"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-javascript",children:"// \u4f7f\u7528 web-vitals \u5e93\nimport { getLCP, getFID, getCLS, getFCP, getTTFB } from \"web-vitals\";\n\nfunction reportMetric(metric) {\n  console.log(metric.name, metric.value);\n\n  sendToAnalytics({\n    name: metric.name,\n    value: metric.value,\n    rating: metric.rating, // 'good' | 'needs-improvement' | 'poor'\n  });\n}\n\ngetLCP(reportMetric);\ngetFID(reportMetric);\ngetCLS(reportMetric);\ngetFCP(reportMetric);\ngetTTFB(reportMetric);\n"})}),"\n",(0,i.jsx)(e.h3,{id:"performance-api",children:"Performance API"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-javascript",children:'// \u9875\u9762\u52a0\u8f7d\u6027\u80fd\nwindow.addEventListener("load", () => {\n  const timing = performance.timing;\n\n  const metrics = {\n    // DNS \u67e5\u8be2\n    dns: timing.domainLookupEnd - timing.domainLookupStart,\n    // TCP \u8fde\u63a5\n    tcp: timing.connectEnd - timing.connectStart,\n    // \u8bf7\u6c42\u54cd\u5e94\n    request: timing.responseEnd - timing.requestStart,\n    // DOM \u89e3\u6790\n    dom: timing.domComplete - timing.domInteractive,\n    // \u9875\u9762\u52a0\u8f7d\n    load: timing.loadEventEnd - timing.navigationStart,\n    // \u9996\u6b21\u6e32\u67d3\n    fp: timing.responseStart - timing.navigationStart,\n  };\n\n  reportPerformance(metrics);\n});\n\n// \u4f7f\u7528 PerformanceObserver\nconst observer = new PerformanceObserver((list) => {\n  for (const entry of list.getEntries()) {\n    console.log(entry.name, entry.duration);\n  }\n});\n\nobserver.observe({ entryTypes: ["resource", "paint", "longtask"] });\n'})}),"\n",(0,i.jsx)(e.h3,{id:"\u957f\u4efb\u52a1\u76d1\u63a7",children:"\u957f\u4efb\u52a1\u76d1\u63a7"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-javascript",children:'const observer = new PerformanceObserver((list) => {\n  for (const entry of list.getEntries()) {\n    if (entry.duration > 50) {\n      reportPerformance({\n        type: "longtask",\n        duration: entry.duration,\n        startTime: entry.startTime,\n      });\n    }\n  }\n});\n\nobserver.observe({ entryTypes: ["longtask"] });\n'})}),"\n",(0,i.jsx)(e.h2,{id:"-\u7528\u6237\u884c\u4e3a\u76d1\u63a7",children:"\ud83d\udc46 \u7528\u6237\u884c\u4e3a\u76d1\u63a7"}),"\n",(0,i.jsx)(e.h3,{id:"\u70b9\u51fb\u57cb\u70b9",children:"\u70b9\u51fb\u57cb\u70b9"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-javascript",children:'document.addEventListener("click", (event) => {\n  const target = event.target.closest("[data-track]");\n\n  if (target) {\n    const trackData = target.dataset.track;\n\n    reportEvent({\n      type: "click",\n      data: JSON.parse(trackData),\n      path: getXPath(target),\n      timestamp: Date.now(),\n    });\n  }\n});\n\n// \u4f7f\u7528\n<button data-track=\'{"name": "buy_button", "page": "product"}\'>\u8d2d\u4e70</button>;\n'})}),"\n",(0,i.jsx)(e.h3,{id:"pvuv-\u7edf\u8ba1",children:"PV/UV \u7edf\u8ba1"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-javascript",children:'// \u9875\u9762\u8bbf\u95ee\nfunction reportPV() {\n  const pvData = {\n    type: "pv",\n    url: location.href,\n    referrer: document.referrer,\n    title: document.title,\n    timestamp: Date.now(),\n    // \u7528\u6237\u6807\u8bc6\n    uid: getUID(),\n  };\n\n  sendToAnalytics(pvData);\n}\n\n// SPA \u8def\u7531\u53d8\u5316\nwindow.addEventListener("popstate", reportPV);\n\n// \u6216\u76d1\u542c history\nconst originalPushState = history.pushState;\nhistory.pushState = function (...args) {\n  originalPushState.apply(this, args);\n  reportPV();\n};\n'})}),"\n",(0,i.jsx)(e.h3,{id:"\u7528\u6237\u8f68\u8ff9",children:"\u7528\u6237\u8f68\u8ff9"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-javascript",children:'class UserTracker {\n  trail = [];\n\n  init() {\n    // \u8bb0\u5f55\u70b9\u51fb\n    document.addEventListener("click", (e) => {\n      this.trail.push({\n        type: "click",\n        target: this.getSelector(e.target),\n        time: Date.now(),\n      });\n    });\n\n    // \u8bb0\u5f55\u9875\u9762\u5207\u6362\n    window.addEventListener("beforeunload", () => {\n      this.report();\n    });\n  }\n\n  getSelector(el) {\n    // \u751f\u6210\u5143\u7d20\u9009\u62e9\u5668\n    return el.id || el.className || el.tagName;\n  }\n\n  report() {\n    sendToAnalytics({\n      type: "trail",\n      data: this.trail,\n    });\n  }\n}\n'})}),"\n",(0,i.jsx)(e.h2,{id:"-\u6570\u636e\u4e0a\u62a5",children:"\ud83d\udcca \u6570\u636e\u4e0a\u62a5"}),"\n",(0,i.jsx)(e.h3,{id:"beacon-api",children:"Beacon API"}),"\n",(0,i.jsx)(e.p,{children:"\u9875\u9762\u5173\u95ed\u65f6\u53ef\u9760\u4e0a\u62a5\u3002"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-javascript",children:'function sendBeacon(data) {\n  const blob = new Blob([JSON.stringify(data)], { type: "application/json" });\n  navigator.sendBeacon("/api/analytics", blob);\n}\n\nwindow.addEventListener("visibilitychange", () => {\n  if (document.visibilityState === "hidden") {\n    sendBeacon(pendingData);\n  }\n});\n'})}),"\n",(0,i.jsx)(e.h3,{id:"\u6279\u91cf\u4e0a\u62a5",children:"\u6279\u91cf\u4e0a\u62a5"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-javascript",children:'class Reporter {\n  queue = [];\n  maxSize = 10;\n  interval = 5000;\n\n  constructor() {\n    setInterval(() => this.flush(), this.interval);\n  }\n\n  add(data) {\n    this.queue.push(data);\n\n    if (this.queue.length >= this.maxSize) {\n      this.flush();\n    }\n  }\n\n  flush() {\n    if (this.queue.length === 0) return;\n\n    const data = this.queue.splice(0, this.maxSize);\n\n    fetch("/api/analytics", {\n      method: "POST",\n      body: JSON.stringify(data),\n      keepalive: true, // \u9875\u9762\u5173\u95ed\u540e\u7ee7\u7eed\u8bf7\u6c42\n    });\n  }\n}\n'})}),"\n",(0,i.jsx)(e.h2,{id:"-\u76d1\u63a7\u5e73\u53f0",children:"\ud83d\udd27 \u76d1\u63a7\u5e73\u53f0"}),"\n",(0,i.jsx)(e.h3,{id:"\u5f00\u6e90\u65b9\u6848",children:"\u5f00\u6e90\u65b9\u6848"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,i.jsxs)(e.table,{children:[(0,i.jsx)(e.thead,{children:(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.th,{children:"\u5de5\u5177"}),(0,i.jsx)(e.th,{children:"\u7279\u70b9"})]})}),(0,i.jsxs)(e.tbody,{children:[(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:"Sentry"}),(0,i.jsx)(e.td,{children:"\u9519\u8bef\u76d1\u63a7\uff0c\u529f\u80fd\u5f3a\u5927"})]}),(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:"Grafana"}),(0,i.jsx)(e.td,{children:"\u53ef\u89c6\u5316\uff0c\u7075\u6d3b\u914d\u7f6e"})]}),(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:"Prometheus"}),(0,i.jsx)(e.td,{children:"\u65f6\u5e8f\u6570\u636e\uff0c\u544a\u8b66"})]})]})]}),"\n",(0,i.jsx)(e.h3,{id:"\u5546\u4e1a\u65b9\u6848",children:"\u5546\u4e1a\u65b9\u6848"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"\u963f\u91cc ARMS"}),"\n",(0,i.jsx)(e.li,{children:"\u817e\u8baf RUM"}),"\n",(0,i.jsx)(e.li,{children:"\u5b57\u8282 Datadog"}),"\n"]}),"\n",(0,i.jsx)(e.h2,{id:"-\u6700\u4f73\u5b9e\u8df5",children:"\ud83d\udca1 \u6700\u4f73\u5b9e\u8df5"}),"\n",(0,i.jsxs)(e.ol,{children:["\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.strong,{children:"\u91c7\u6837\u4e0a\u62a5"})," - \u9ad8\u6d41\u91cf\u65f6\u6309\u6bd4\u4f8b\u91c7\u6837"]}),"\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.strong,{children:"\u9519\u8bef\u805a\u5408"})," - \u76f8\u540c\u9519\u8bef\u5408\u5e76\u4e0a\u62a5"]}),"\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.strong,{children:"\u654f\u611f\u4fe1\u606f\u8131\u654f"})," - \u4e0d\u4e0a\u62a5\u7528\u6237\u9690\u79c1\u6570\u636e"]}),"\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.strong,{children:"\u6027\u80fd\u5f00\u9500\u6700\u5c0f"})," - \u76d1\u63a7\u672c\u8eab\u4e0d\u80fd\u5f71\u54cd\u6027\u80fd"]}),"\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.strong,{children:"\u8bbe\u7f6e\u544a\u8b66"})," - \u5f02\u5e38\u65f6\u53ca\u65f6\u901a\u77e5"]}),"\n"]}),"\n",(0,i.jsx)(e.h2,{id:"-\u76f8\u5173\u8d44\u6e90",children:"\ud83d\udd17 \u76f8\u5173\u8d44\u6e90"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:(0,i.jsx)(e.a,{href:"/docs/frontend/advanced/performance",children:"\u6027\u80fd\u4f18\u5316"})}),"\n",(0,i.jsx)(e.li,{children:(0,i.jsx)(e.a,{href:"/docs/frontend/javascript/error-handling",children:"\u9519\u8bef\u5904\u7406"})}),"\n"]}),"\n",(0,i.jsx)(e.hr,{}),"\n",(0,i.jsxs)(e.p,{children:[(0,i.jsx)(e.strong,{children:"\u606d\u559c\uff01"})," \u4f60\u5df2\u5b8c\u6210\u524d\u7aef\u8fdb\u9636\u5b66\u4e60\u3002\u7ee7\u7eed\u63a2\u7d22 ",(0,i.jsx)(e.a,{href:"/docs/react",children:"React"})," \u6784\u5efa\u73b0\u4ee3\u5e94\u7528\uff01"]})]})}function h(n={}){const{wrapper:e}={...(0,a.R)(),...n.components};return e?(0,i.jsx)(e,{...n,children:(0,i.jsx)(d,{...n})}):d(n)}},48885:(n,e,r)=>{r.d(e,{R:()=>s,x:()=>o});var t=r(99378);const i={},a=t.createContext(i);function s(n){const e=t.useContext(a);return t.useMemo(function(){return"function"==typeof n?n(e):{...e,...n}},[e,n])}function o(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(i):n.components||i:s(n.components),t.createElement(a.Provider,{value:e},n.children)}}}]);