"use strict";(globalThis.webpackChunkto_lib_github_io=globalThis.webpackChunkto_lib_github_io||[]).push([[66460],{48885:(n,e,r)=>{r.d(e,{R:()=>d,x:()=>t});var s=r(99378);const c={},i=s.createContext(c);function d(n){const e=s.useContext(i);return s.useMemo(function(){return"function"==typeof n?n(e):{...e,...n}},[e,n])}function t(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(c):n.components||c:d(n.components),s.createElement(i.Provider,{value:e},n.children)}},92881:(n,e,r)=>{r.r(e),r.d(e,{assets:()=>o,contentTitle:()=>t,default:()=>h,frontMatter:()=>d,metadata:()=>s,toc:()=>l});const s=JSON.parse('{"id":"docker/container-runtime","title":"\u5bb9\u5668\u8fd0\u884c\u65f6","description":"Docker \u5e95\u5c42\u8fd0\u884c\u65f6\u539f\u7406 - containerd\u3001runc \u4e0e OCI \u6807\u51c6","source":"@site/docs/docker/container-runtime.md","sourceDirName":"docker","slug":"/docker/container-runtime","permalink":"/docs/docker/container-runtime","draft":false,"unlisted":false,"editUrl":"https://github.com/to-lib/to-lib.github.io/tree/main/docs/docker/container-runtime.md","tags":[],"version":"current","sidebarPosition":17,"frontMatter":{"sidebar_position":17,"title":"\u5bb9\u5668\u8fd0\u884c\u65f6","description":"Docker \u5e95\u5c42\u8fd0\u884c\u65f6\u539f\u7406 - containerd\u3001runc \u4e0e OCI \u6807\u51c6"},"sidebar":"docker","previous":{"title":"\u5b58\u50a8\u8fdb\u9636","permalink":"/docs/docker/storage-drivers"},"next":{"title":"\u591a\u67b6\u6784\u955c\u50cf","permalink":"/docs/docker/multi-arch"}}');var c=r(22714),i=r(48885);const d={sidebar_position:17,title:"\u5bb9\u5668\u8fd0\u884c\u65f6",description:"Docker \u5e95\u5c42\u8fd0\u884c\u65f6\u539f\u7406 - containerd\u3001runc \u4e0e OCI \u6807\u51c6"},t="\u5bb9\u5668\u8fd0\u884c\u65f6",o={},l=[{value:"\u67b6\u6784\u6982\u89c8",id:"\u67b6\u6784\u6982\u89c8",level:2},{value:"OCI \u6807\u51c6",id:"oci-\u6807\u51c6",level:2},{value:"OCI \u955c\u50cf\u89c4\u8303",id:"oci-\u955c\u50cf\u89c4\u8303",level:3},{value:"OCI \u8fd0\u884c\u65f6\u89c4\u8303",id:"oci-\u8fd0\u884c\u65f6\u89c4\u8303",level:3},{value:"containerd",id:"containerd",level:2},{value:"\u67b6\u6784\u7ec4\u4ef6",id:"\u67b6\u6784\u7ec4\u4ef6",level:3},{value:"\u76f4\u63a5\u4f7f\u7528 containerd",id:"\u76f4\u63a5\u4f7f\u7528-containerd",level:3},{value:"nerdctl - containerd \u7684 Docker \u517c\u5bb9 CLI",id:"nerdctl---containerd-\u7684-docker-\u517c\u5bb9-cli",level:3},{value:"runc",id:"runc",level:2},{value:"\u624b\u52a8\u4f7f\u7528 runc",id:"\u624b\u52a8\u4f7f\u7528-runc",level:3},{value:"runc spec \u751f\u6210\u7684\u914d\u7f6e",id:"runc-spec-\u751f\u6210\u7684\u914d\u7f6e",level:3},{value:"cgroups v2",id:"cgroups-v2",level:2},{value:"cgroups v1 vs v2",id:"cgroups-v1-vs-v2",level:3},{value:"\u68c0\u67e5 cgroups \u7248\u672c",id:"\u68c0\u67e5-cgroups-\u7248\u672c",level:3},{value:"cgroups v2 \u8d44\u6e90\u63a7\u5236",id:"cgroups-v2-\u8d44\u6e90\u63a7\u5236",level:3},{value:"Docker \u4e2d\u7684 cgroups",id:"docker-\u4e2d\u7684-cgroups",level:3},{value:"Linux Namespaces",id:"linux-namespaces",level:2},{value:"Namespace \u7c7b\u578b",id:"namespace-\u7c7b\u578b",level:3},{value:"\u67e5\u770b\u5bb9\u5668 Namespaces",id:"\u67e5\u770b\u5bb9\u5668-namespaces",level:3},{value:"\u5176\u4ed6 OCI \u8fd0\u884c\u65f6",id:"\u5176\u4ed6-oci-\u8fd0\u884c\u65f6",level:2},{value:"gVisor (runsc)",id:"gvisor-runsc",level:3},{value:"Kata Containers",id:"kata-containers",level:3},{value:"\u8fd0\u884c\u65f6\u5bf9\u6bd4",id:"\u8fd0\u884c\u65f6\u5bf9\u6bd4",level:3},{value:"\u8c03\u8bd5\u8fd0\u884c\u65f6",id:"\u8c03\u8bd5\u8fd0\u884c\u65f6",level:2}];function a(n){const e={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",...(0,i.R)(),...n.components};return(0,c.jsxs)(c.Fragment,{children:[(0,c.jsx)(e.header,{children:(0,c.jsx)(e.h1,{id:"\u5bb9\u5668\u8fd0\u884c\u65f6",children:"\u5bb9\u5668\u8fd0\u884c\u65f6"})}),"\n",(0,c.jsx)(e.p,{children:"\u7406\u89e3 Docker \u5e95\u5c42\u7684\u5bb9\u5668\u8fd0\u884c\u65f6\u67b6\u6784\uff0c\u6709\u52a9\u4e8e\u6df1\u5165\u638c\u63e1\u5bb9\u5668\u6280\u672f\u539f\u7406\u3002"}),"\n",(0,c.jsx)(e.h2,{id:"\u67b6\u6784\u6982\u89c8",children:"\u67b6\u6784\u6982\u89c8"}),"\n",(0,c.jsx)(e.pre,{children:(0,c.jsx)(e.code,{children:"\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                  Docker CLI                      \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                      \u2502 REST API\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502               Docker Daemon (dockerd)            \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510    \u2502\n\u2502  \u2502         Image Management                 \u2502    \u2502\n\u2502  \u2502         Network Management               \u2502    \u2502\n\u2502  \u2502         Volume Management                \u2502    \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518    \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                      \u2502 gRPC\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                  containerd                      \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510    \u2502\n\u2502  \u2502 Images   \u2502 \u2502Containers\u2502 \u2502   Snapshots  \u2502    \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518    \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                      \u2502 OCI Runtime Spec\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                    runc                          \u2502\n\u2502         (OCI Runtime Implementation)             \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                      \u2502\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502              Linux Kernel                        \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510    \u2502\n\u2502  \u2502 Namespaces\u2502 \u2502 cgroups  \u2502 \u2502   seccomp    \u2502    \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518    \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"})}),"\n",(0,c.jsx)(e.h2,{id:"oci-\u6807\u51c6",children:"OCI \u6807\u51c6"}),"\n",(0,c.jsx)(e.p,{children:"OCI (Open Container Initiative) \u5b9a\u4e49\u4e86\u5bb9\u5668\u7684\u5f00\u653e\u6807\u51c6\u3002"}),"\n",(0,c.jsx)(e.h3,{id:"oci-\u955c\u50cf\u89c4\u8303",children:"OCI \u955c\u50cf\u89c4\u8303"}),"\n",(0,c.jsx)(e.pre,{children:(0,c.jsx)(e.code,{className:"language-json",children:'// \u955c\u50cf manifest \u793a\u4f8b\n{\n  "schemaVersion": 2,\n  "mediaType": "application/vnd.oci.image.manifest.v1+json",\n  "config": {\n    "mediaType": "application/vnd.oci.image.config.v1+json",\n    "digest": "sha256:abc123...",\n    "size": 7023\n  },\n  "layers": [\n    {\n      "mediaType": "application/vnd.oci.image.layer.v1.tar+gzip",\n      "digest": "sha256:def456...",\n      "size": 32654\n    }\n  ]\n}\n'})}),"\n",(0,c.jsx)(e.h3,{id:"oci-\u8fd0\u884c\u65f6\u89c4\u8303",children:"OCI \u8fd0\u884c\u65f6\u89c4\u8303"}),"\n",(0,c.jsx)(e.pre,{children:(0,c.jsx)(e.code,{className:"language-json",children:'// config.json - \u5bb9\u5668\u8fd0\u884c\u65f6\u914d\u7f6e\n{\n  "ociVersion": "1.0.2",\n  "process": {\n    "terminal": true,\n    "user": { "uid": 0, "gid": 0 },\n    "args": ["sh"],\n    "env": ["PATH=/usr/bin:/bin"],\n    "cwd": "/"\n  },\n  "root": {\n    "path": "rootfs",\n    "readonly": true\n  },\n  "hostname": "container",\n  "linux": {\n    "namespaces": [\n      { "type": "pid" },\n      { "type": "network" },\n      { "type": "ipc" },\n      { "type": "uts" },\n      { "type": "mount" }\n    ]\n  }\n}\n'})}),"\n",(0,c.jsx)(e.h2,{id:"containerd",children:"containerd"}),"\n",(0,c.jsx)(e.p,{children:"containerd \u662f\u5de5\u4e1a\u7ea7\u5bb9\u5668\u8fd0\u884c\u65f6\uff0c\u8d1f\u8d23\u955c\u50cf\u4f20\u8f93\u3001\u5bb9\u5668\u6267\u884c\u3001\u5b58\u50a8\u548c\u7f51\u7edc\u3002"}),"\n",(0,c.jsx)(e.h3,{id:"\u67b6\u6784\u7ec4\u4ef6",children:"\u67b6\u6784\u7ec4\u4ef6"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,c.jsxs)(e.table,{children:[(0,c.jsx)(e.thead,{children:(0,c.jsxs)(e.tr,{children:[(0,c.jsx)(e.th,{children:"\u7ec4\u4ef6"}),(0,c.jsx)(e.th,{children:"\u529f\u80fd"})]})}),(0,c.jsxs)(e.tbody,{children:[(0,c.jsxs)(e.tr,{children:[(0,c.jsx)(e.td,{children:(0,c.jsx)(e.strong,{children:"Content Store"})}),(0,c.jsx)(e.td,{children:"\u5b58\u50a8\u955c\u50cf\u5c42\u5185\u5bb9"})]}),(0,c.jsxs)(e.tr,{children:[(0,c.jsx)(e.td,{children:(0,c.jsx)(e.strong,{children:"Snapshotter"})}),(0,c.jsx)(e.td,{children:"\u7ba1\u7406\u6587\u4ef6\u7cfb\u7edf\u5feb\u7167"})]}),(0,c.jsxs)(e.tr,{children:[(0,c.jsx)(e.td,{children:(0,c.jsx)(e.strong,{children:"Runtime"})}),(0,c.jsx)(e.td,{children:"\u5bb9\u5668\u751f\u547d\u5468\u671f\u7ba1\u7406"})]}),(0,c.jsxs)(e.tr,{children:[(0,c.jsx)(e.td,{children:(0,c.jsx)(e.strong,{children:"Metadata Store"})}),(0,c.jsx)(e.td,{children:"\u5b58\u50a8\u5bb9\u5668\u5143\u6570\u636e"})]})]})]}),"\n",(0,c.jsx)(e.h3,{id:"\u76f4\u63a5\u4f7f\u7528-containerd",children:"\u76f4\u63a5\u4f7f\u7528 containerd"}),"\n",(0,c.jsx)(e.pre,{children:(0,c.jsx)(e.code,{className:"language-bash",children:"# \u4f7f\u7528 ctr \u547d\u4ee4\u884c\u5de5\u5177\n# \u62c9\u53d6\u955c\u50cf\nctr images pull docker.io/library/nginx:latest\n\n# \u5217\u51fa\u955c\u50cf\nctr images ls\n\n# \u8fd0\u884c\u5bb9\u5668\nctr run -d docker.io/library/nginx:latest nginx\n\n# \u5217\u51fa\u5bb9\u5668\nctr containers ls\n\n# \u67e5\u770b\u4efb\u52a1\uff08\u8fd0\u884c\u4e2d\u7684\u5bb9\u5668\uff09\nctr tasks ls\n\n# \u8fdb\u5165\u5bb9\u5668\nctr tasks exec --exec-id shell nginx sh\n"})}),"\n",(0,c.jsx)(e.h3,{id:"nerdctl---containerd-\u7684-docker-\u517c\u5bb9-cli",children:"nerdctl - containerd \u7684 Docker \u517c\u5bb9 CLI"}),"\n",(0,c.jsx)(e.pre,{children:(0,c.jsx)(e.code,{className:"language-bash",children:"# \u5b89\u88c5 nerdctl\nbrew install nerdctl  # macOS\n# \u6216\u4ece GitHub \u4e0b\u8f7d\n\n# \u4f7f\u7528\u65b9\u5f0f\u4e0e docker \u547d\u4ee4\u517c\u5bb9\nnerdctl run -d -p 80:80 nginx\nnerdctl ps\nnerdctl images\nnerdctl compose up -d\n"})}),"\n",(0,c.jsx)(e.h2,{id:"runc",children:"runc"}),"\n",(0,c.jsx)(e.p,{children:"runc \u662f OCI \u8fd0\u884c\u65f6\u89c4\u8303\u7684\u53c2\u8003\u5b9e\u73b0\uff0c\u8d1f\u8d23\u5b9e\u9645\u521b\u5efa\u548c\u8fd0\u884c\u5bb9\u5668\u3002"}),"\n",(0,c.jsx)(e.h3,{id:"\u624b\u52a8\u4f7f\u7528-runc",children:"\u624b\u52a8\u4f7f\u7528 runc"}),"\n",(0,c.jsx)(e.pre,{children:(0,c.jsx)(e.code,{className:"language-bash",children:"# \u521b\u5efa\u5bb9\u5668 bundle\nmkdir -p mycontainer/rootfs\n\n# \u5bfc\u51fa\u955c\u50cf\u6587\u4ef6\u7cfb\u7edf\ndocker export $(docker create busybox) | tar -C mycontainer/rootfs -xf -\n\n# \u751f\u6210\u8fd0\u884c\u65f6\u914d\u7f6e\ncd mycontainer\nrunc spec\n\n# \u8fd0\u884c\u5bb9\u5668\nsudo runc run mycontainer\n\n# \u5217\u51fa\u5bb9\u5668\nsudo runc list\n\n# \u5220\u9664\u5bb9\u5668\nsudo runc delete mycontainer\n"})}),"\n",(0,c.jsx)(e.h3,{id:"runc-spec-\u751f\u6210\u7684\u914d\u7f6e",children:"runc spec \u751f\u6210\u7684\u914d\u7f6e"}),"\n",(0,c.jsx)(e.pre,{children:(0,c.jsx)(e.code,{className:"language-json",children:'{\n  "ociVersion": "1.0.2",\n  "process": {\n    "terminal": true,\n    "user": { "uid": 0, "gid": 0 },\n    "args": ["sh"],\n    "env": [\n      "PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin",\n      "TERM=xterm"\n    ],\n    "cwd": "/",\n    "capabilities": {\n      "bounding": ["CAP_AUDIT_WRITE", "CAP_KILL", "CAP_NET_BIND_SERVICE"],\n      "effective": ["CAP_AUDIT_WRITE", "CAP_KILL", "CAP_NET_BIND_SERVICE"]\n    },\n    "rlimits": [\n      { "type": "RLIMIT_NOFILE", "hard": 1024, "soft": 1024 }\n    ]\n  },\n  "root": {\n    "path": "rootfs",\n    "readonly": true\n  },\n  "linux": {\n    "resources": {\n      "memory": { "limit": 536870912 },\n      "cpu": { "shares": 1024 }\n    },\n    "namespaces": [\n      { "type": "pid" },\n      { "type": "network" },\n      { "type": "ipc" },\n      { "type": "uts" },\n      { "type": "mount" },\n      { "type": "cgroup" }\n    ],\n    "maskedPaths": [\n      "/proc/acpi",\n      "/proc/kcore",\n      "/sys/firmware"\n    ],\n    "readonlyPaths": [\n      "/proc/bus",\n      "/proc/fs",\n      "/proc/irq"\n    ]\n  }\n}\n'})}),"\n",(0,c.jsx)(e.h2,{id:"cgroups-v2",children:"cgroups v2"}),"\n",(0,c.jsx)(e.p,{children:"cgroups (Control Groups) \u7528\u4e8e\u9650\u5236\u3001\u8bb0\u5f55\u548c\u9694\u79bb\u8fdb\u7a0b\u7ec4\u7684\u8d44\u6e90\u4f7f\u7528\u3002"}),"\n",(0,c.jsx)(e.h3,{id:"cgroups-v1-vs-v2",children:"cgroups v1 vs v2"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,c.jsxs)(e.table,{children:[(0,c.jsx)(e.thead,{children:(0,c.jsxs)(e.tr,{children:[(0,c.jsx)(e.th,{children:"\u7279\u6027"}),(0,c.jsx)(e.th,{children:"cgroups v1"}),(0,c.jsx)(e.th,{children:"cgroups v2"})]})}),(0,c.jsxs)(e.tbody,{children:[(0,c.jsxs)(e.tr,{children:[(0,c.jsx)(e.td,{children:"\u5c42\u7ea7\u7ed3\u6784"}),(0,c.jsx)(e.td,{children:"\u591a\u5c42\u7ea7\uff08\u6bcf\u4e2a\u63a7\u5236\u5668\u72ec\u7acb\uff09"}),(0,c.jsx)(e.td,{children:"\u7edf\u4e00\u5c42\u7ea7"})]}),(0,c.jsxs)(e.tr,{children:[(0,c.jsx)(e.td,{children:"\u8d44\u6e90\u63a7\u5236"}),(0,c.jsx)(e.td,{children:"\u5206\u6563\u5728\u4e0d\u540c\u5b50\u7cfb\u7edf"}),(0,c.jsx)(e.td,{children:"\u7edf\u4e00\u63a5\u53e3"})]}),(0,c.jsxs)(e.tr,{children:[(0,c.jsx)(e.td,{children:"\u7ebf\u7a0b\u652f\u6301"}),(0,c.jsx)(e.td,{children:"\u6709\u9650"}),(0,c.jsx)(e.td,{children:"\u5b8c\u6574\u652f\u6301"})]}),(0,c.jsxs)(e.tr,{children:[(0,c.jsx)(e.td,{children:"\u538b\u529b\u76d1\u63a7"}),(0,c.jsx)(e.td,{children:"\u65e0"}),(0,c.jsx)(e.td,{children:"PSI (Pressure Stall Information)"})]})]})]}),"\n",(0,c.jsx)(e.h3,{id:"\u68c0\u67e5-cgroups-\u7248\u672c",children:"\u68c0\u67e5 cgroups \u7248\u672c"}),"\n",(0,c.jsx)(e.pre,{children:(0,c.jsx)(e.code,{className:"language-bash",children:"# \u68c0\u67e5\u7cfb\u7edf\u4f7f\u7528\u7684 cgroups \u7248\u672c\nmount | grep cgroup\n\n# cgroups v2 \u8f93\u51fa\n# cgroup2 on /sys/fs/cgroup type cgroup2\n\n# cgroups v1 \u8f93\u51fa\n# cgroup on /sys/fs/cgroup/memory type cgroup\n"})}),"\n",(0,c.jsx)(e.h3,{id:"cgroups-v2-\u8d44\u6e90\u63a7\u5236",children:"cgroups v2 \u8d44\u6e90\u63a7\u5236"}),"\n",(0,c.jsx)(e.pre,{children:(0,c.jsx)(e.code,{className:"language-bash",children:'# \u67e5\u770b cgroup \u63a7\u5236\u5668\ncat /sys/fs/cgroup/cgroup.controllers\n# cpu io memory pids\n\n# \u521b\u5efa cgroup\nsudo mkdir /sys/fs/cgroup/mygroup\n\n# \u542f\u7528\u63a7\u5236\u5668\necho "+cpu +memory +io" | sudo tee /sys/fs/cgroup/mygroup/cgroup.subtree_control\n\n# \u8bbe\u7f6e\u5185\u5b58\u9650\u5236\necho "536870912" | sudo tee /sys/fs/cgroup/mygroup/memory.max\n\n# \u8bbe\u7f6e CPU \u9650\u5236 (50% of one CPU)\necho "50000 100000" | sudo tee /sys/fs/cgroup/mygroup/cpu.max\n\n# \u5c06\u8fdb\u7a0b\u52a0\u5165 cgroup\necho $PID | sudo tee /sys/fs/cgroup/mygroup/cgroup.procs\n'})}),"\n",(0,c.jsx)(e.h3,{id:"docker-\u4e2d\u7684-cgroups",children:"Docker \u4e2d\u7684 cgroups"}),"\n",(0,c.jsx)(e.pre,{children:(0,c.jsx)(e.code,{className:"language-bash",children:'# \u67e5\u770b\u5bb9\u5668\u7684 cgroup\ndocker inspect --format \'{{.HostConfig.CgroupParent}}\' container_name\n\n# \u67e5\u770b\u5bb9\u5668\u8d44\u6e90\u9650\u5236\ncat /sys/fs/cgroup/docker/<container_id>/memory.max\ncat /sys/fs/cgroup/docker/<container_id>/cpu.max\n\n# \u914d\u7f6e Docker \u4f7f\u7528 cgroups v2\n# /etc/docker/daemon.json\n{\n  "default-cgroupns-mode": "private",\n  "cgroup-parent": "docker.slice"\n}\n'})}),"\n",(0,c.jsx)(e.h2,{id:"linux-namespaces",children:"Linux Namespaces"}),"\n",(0,c.jsx)(e.p,{children:"Namespaces \u63d0\u4f9b\u8fdb\u7a0b\u7ea7\u522b\u7684\u9694\u79bb\u3002"}),"\n",(0,c.jsx)(e.h3,{id:"namespace-\u7c7b\u578b",children:"Namespace \u7c7b\u578b"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,c.jsxs)(e.table,{children:[(0,c.jsx)(e.thead,{children:(0,c.jsxs)(e.tr,{children:[(0,c.jsx)(e.th,{children:"Namespace"}),(0,c.jsx)(e.th,{children:"\u9694\u79bb\u5185\u5bb9"}),(0,c.jsx)(e.th,{children:"\u6807\u5fd7"})]})}),(0,c.jsxs)(e.tbody,{children:[(0,c.jsxs)(e.tr,{children:[(0,c.jsx)(e.td,{children:(0,c.jsx)(e.strong,{children:"Mount"})}),(0,c.jsx)(e.td,{children:"\u6587\u4ef6\u7cfb\u7edf\u6302\u8f7d\u70b9"}),(0,c.jsx)(e.td,{children:"CLONE_NEWNS"})]}),(0,c.jsxs)(e.tr,{children:[(0,c.jsx)(e.td,{children:(0,c.jsx)(e.strong,{children:"UTS"})}),(0,c.jsx)(e.td,{children:"\u4e3b\u673a\u540d\u548c\u57df\u540d"}),(0,c.jsx)(e.td,{children:"CLONE_NEWUTS"})]}),(0,c.jsxs)(e.tr,{children:[(0,c.jsx)(e.td,{children:(0,c.jsx)(e.strong,{children:"IPC"})}),(0,c.jsx)(e.td,{children:"\u8fdb\u7a0b\u95f4\u901a\u4fe1"}),(0,c.jsx)(e.td,{children:"CLONE_NEWIPC"})]}),(0,c.jsxs)(e.tr,{children:[(0,c.jsx)(e.td,{children:(0,c.jsx)(e.strong,{children:"PID"})}),(0,c.jsx)(e.td,{children:"\u8fdb\u7a0b ID"}),(0,c.jsx)(e.td,{children:"CLONE_NEWPID"})]}),(0,c.jsxs)(e.tr,{children:[(0,c.jsx)(e.td,{children:(0,c.jsx)(e.strong,{children:"Network"})}),(0,c.jsx)(e.td,{children:"\u7f51\u7edc\u8bbe\u5907\u3001\u7aef\u53e3"}),(0,c.jsx)(e.td,{children:"CLONE_NEWNET"})]}),(0,c.jsxs)(e.tr,{children:[(0,c.jsx)(e.td,{children:(0,c.jsx)(e.strong,{children:"User"})}),(0,c.jsx)(e.td,{children:"\u7528\u6237\u548c\u7ec4 ID"}),(0,c.jsx)(e.td,{children:"CLONE_NEWUSER"})]}),(0,c.jsxs)(e.tr,{children:[(0,c.jsx)(e.td,{children:(0,c.jsx)(e.strong,{children:"Cgroup"})}),(0,c.jsx)(e.td,{children:"Cgroup \u6839\u76ee\u5f55"}),(0,c.jsx)(e.td,{children:"CLONE_NEWCGROUP"})]})]})]}),"\n",(0,c.jsx)(e.h3,{id:"\u67e5\u770b\u5bb9\u5668-namespaces",children:"\u67e5\u770b\u5bb9\u5668 Namespaces"}),"\n",(0,c.jsx)(e.pre,{children:(0,c.jsx)(e.code,{className:"language-bash",children:"# \u83b7\u53d6\u5bb9\u5668 PID\nPID=$(docker inspect --format '{{.State.Pid}}' container_name)\n\n# \u67e5\u770b namespaces\nls -la /proc/$PID/ns/\n\n# \u8fdb\u5165\u5bb9\u5668 namespace\nsudo nsenter -t $PID -n ip addr  # \u7f51\u7edc namespace\nsudo nsenter -t $PID -m ls /     # \u6302\u8f7d namespace\nsudo nsenter -t $PID -p -r ps    # PID namespace\n"})}),"\n",(0,c.jsx)(e.h2,{id:"\u5176\u4ed6-oci-\u8fd0\u884c\u65f6",children:"\u5176\u4ed6 OCI \u8fd0\u884c\u65f6"}),"\n",(0,c.jsx)(e.h3,{id:"gvisor-runsc",children:"gVisor (runsc)"}),"\n",(0,c.jsx)(e.p,{children:"Google \u5f00\u53d1\u7684\u7528\u6237\u6001\u5185\u6838\uff0c\u63d0\u4f9b\u66f4\u5f3a\u7684\u9694\u79bb\u3002"}),"\n",(0,c.jsx)(e.pre,{children:(0,c.jsx)(e.code,{className:"language-bash",children:'# \u5b89\u88c5 gVisor\ncurl -fsSL https://gvisor.dev/archive.key | sudo gpg --dearmor -o /usr/share/keyrings/gvisor-archive-keyring.gpg\necho "deb [arch=amd64 signed-by=/usr/share/keyrings/gvisor-archive-keyring.gpg] https://storage.googleapis.com/gvisor/releases release main" | sudo tee /etc/apt/sources.list.d/gvisor.list\nsudo apt-get update && sudo apt-get install -y runsc\n\n# \u914d\u7f6e Docker \u4f7f\u7528 gVisor\n# /etc/docker/daemon.json\n{\n  "runtimes": {\n    "runsc": {\n      "path": "/usr/bin/runsc"\n    }\n  }\n}\n\n# \u4f7f\u7528 gVisor \u8fd0\u884c\u5bb9\u5668\ndocker run --runtime=runsc nginx\n'})}),"\n",(0,c.jsx)(e.h3,{id:"kata-containers",children:"Kata Containers"}),"\n",(0,c.jsx)(e.p,{children:"\u4f7f\u7528\u8f7b\u91cf\u7ea7\u865a\u62df\u673a\u63d0\u4f9b\u5f3a\u9694\u79bb\u3002"}),"\n",(0,c.jsx)(e.pre,{children:(0,c.jsx)(e.code,{className:"language-bash",children:'# \u914d\u7f6e Docker \u4f7f\u7528 Kata\n{\n  "runtimes": {\n    "kata": {\n      "path": "/usr/bin/kata-runtime"\n    }\n  }\n}\n\n# \u4f7f\u7528 Kata \u8fd0\u884c\u5bb9\u5668\ndocker run --runtime=kata nginx\n'})}),"\n",(0,c.jsx)(e.h3,{id:"\u8fd0\u884c\u65f6\u5bf9\u6bd4",children:"\u8fd0\u884c\u65f6\u5bf9\u6bd4"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,c.jsxs)(e.table,{children:[(0,c.jsx)(e.thead,{children:(0,c.jsxs)(e.tr,{children:[(0,c.jsx)(e.th,{children:"\u8fd0\u884c\u65f6"}),(0,c.jsx)(e.th,{children:"\u9694\u79bb\u7ea7\u522b"}),(0,c.jsx)(e.th,{children:"\u6027\u80fd"}),(0,c.jsx)(e.th,{children:"\u517c\u5bb9\u6027"}),(0,c.jsx)(e.th,{children:"\u4f7f\u7528\u573a\u666f"})]})}),(0,c.jsxs)(e.tbody,{children:[(0,c.jsxs)(e.tr,{children:[(0,c.jsx)(e.td,{children:(0,c.jsx)(e.strong,{children:"runc"})}),(0,c.jsx)(e.td,{children:"\u8fdb\u7a0b\u7ea7"}),(0,c.jsx)(e.td,{children:"\u6700\u9ad8"}),(0,c.jsx)(e.td,{children:"\u6700\u597d"}),(0,c.jsx)(e.td,{children:"\u9ed8\u8ba4\u9009\u62e9"})]}),(0,c.jsxs)(e.tr,{children:[(0,c.jsx)(e.td,{children:(0,c.jsx)(e.strong,{children:"gVisor"})}),(0,c.jsx)(e.td,{children:"\u7528\u6237\u6001\u5185\u6838"}),(0,c.jsx)(e.td,{children:"\u4e2d\u7b49"}),(0,c.jsx)(e.td,{children:"\u826f\u597d"}),(0,c.jsx)(e.td,{children:"\u591a\u79df\u6237\u73af\u5883"})]}),(0,c.jsxs)(e.tr,{children:[(0,c.jsx)(e.td,{children:(0,c.jsx)(e.strong,{children:"Kata"})}),(0,c.jsx)(e.td,{children:"\u865a\u62df\u673a\u7ea7"}),(0,c.jsx)(e.td,{children:"\u8f83\u4f4e"}),(0,c.jsx)(e.td,{children:"\u826f\u597d"}),(0,c.jsx)(e.td,{children:"\u9ad8\u5b89\u5168\u9700\u6c42"})]})]})]}),"\n",(0,c.jsx)(e.h2,{id:"\u8c03\u8bd5\u8fd0\u884c\u65f6",children:"\u8c03\u8bd5\u8fd0\u884c\u65f6"}),"\n",(0,c.jsx)(e.pre,{children:(0,c.jsx)(e.code,{className:"language-bash",children:"# \u67e5\u770b Docker \u8fd0\u884c\u65f6\u4fe1\u606f\ndocker info | grep -i runtime\n\n# \u67e5\u770b containerd \u72b6\u6001\nsudo systemctl status containerd\nsudo ctr version\n\n# \u67e5\u770b containerd \u65e5\u5fd7\nsudo journalctl -u containerd -f\n\n# \u8c03\u8bd5\u5bb9\u5668\u521b\u5efa\u8fc7\u7a0b\ndocker run --rm -it --runtime=runc \\\n  --log-driver=json-file \\\n  alpine sh\n"})})]})}function h(n={}){const{wrapper:e}={...(0,i.R)(),...n.components};return e?(0,c.jsx)(e,{...n,children:(0,c.jsx)(a,{...n})}):a(n)}}}]);