"use strict";(globalThis.webpackChunkto_lib_github_io=globalThis.webpackChunkto_lib_github_io||[]).push([[4319],{48885:(e,n,s)=>{s.d(n,{R:()=>i,x:()=>c});var l=s(99378);const r={},d=l.createContext(r);function i(e){const n=l.useContext(d);return l.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:i(e.components),l.createElement(d.Provider,{value:n},e.children)}},70947:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>a,contentTitle:()=>c,default:()=>h,frontMatter:()=>i,metadata:()=>l,toc:()=>t});const l=JSON.parse('{"id":"postgres/security","title":"\u5b89\u5168\u7ba1\u7406","description":"\u6570\u636e\u5e93\u5b89\u5168\u662f\u4fdd\u62a4\u654f\u611f\u6570\u636e\u7684\u5173\u952e\uff0c\u5305\u62ec\u7528\u6237\u7ba1\u7406\u3001\u6743\u9650\u63a7\u5236\u3001\u8fde\u63a5\u52a0\u5bc6\u7b49\u65b9\u9762\u3002","source":"@site/docs/postgres/security.md","sourceDirName":"postgres","slug":"/postgres/security","permalink":"/docs/postgres/security","draft":false,"unlisted":false,"editUrl":"https://github.com/to-lib/to-lib.github.io/tree/main/docs/postgres/security.md","tags":[],"version":"current","sidebarPosition":15,"frontMatter":{"sidebar_position":15,"title":"\u5b89\u5168\u7ba1\u7406"},"sidebar":"postgres","previous":{"title":"\u5907\u4efd\u4e0e\u6062\u590d","permalink":"/docs/postgres/backup-recovery"},"next":{"title":"\u6700\u4f73\u5b9e\u8df5","permalink":"/docs/postgres/best-practices"}}');var r=s(22714),d=s(48885);const i={sidebar_position:15,title:"\u5b89\u5168\u7ba1\u7406"},c="PostgreSQL \u5b89\u5168\u7ba1\u7406",a={},t=[{value:"\ud83d\udc64 \u7528\u6237\u548c\u89d2\u8272\u7ba1\u7406",id:"-\u7528\u6237\u548c\u89d2\u8272\u7ba1\u7406",level:2},{value:"\u521b\u5efa\u7528\u6237/\u89d2\u8272",id:"\u521b\u5efa\u7528\u6237\u89d2\u8272",level:3},{value:"\u7528\u6237\u5c5e\u6027",id:"\u7528\u6237\u5c5e\u6027",level:3},{value:"\u89d2\u8272\u7ee7\u627f",id:"\u89d2\u8272\u7ee7\u627f",level:3},{value:"\ud83d\udd10 \u6743\u9650\u63a7\u5236",id:"-\u6743\u9650\u63a7\u5236",level:2},{value:"\u6570\u636e\u5e93\u6743\u9650",id:"\u6570\u636e\u5e93\u6743\u9650",level:3},{value:"\u6a21\u5f0f\u6743\u9650",id:"\u6a21\u5f0f\u6743\u9650",level:3},{value:"\u8868\u6743\u9650",id:"\u8868\u6743\u9650",level:3},{value:"\u5217\u7ea7\u6743\u9650",id:"\u5217\u7ea7\u6743\u9650",level:3},{value:"\u884c\u7ea7\u5b89\u5168\uff08RLS\uff09",id:"\u884c\u7ea7\u5b89\u5168rls",level:3},{value:"\ud83d\udd12 \u8fde\u63a5\u5b89\u5168",id:"-\u8fde\u63a5\u5b89\u5168",level:2},{value:"pg_hba.conf \u914d\u7f6e",id:"pg_hbaconf-\u914d\u7f6e",level:3},{value:"\u8ba4\u8bc1\u65b9\u5f0f",id:"\u8ba4\u8bc1\u65b9\u5f0f",level:3},{value:"\u4fee\u6539\u9ed8\u8ba4\u52a0\u5bc6\u65b9\u5f0f",id:"\u4fee\u6539\u9ed8\u8ba4\u52a0\u5bc6\u65b9\u5f0f",level:3},{value:"\ud83d\udd10 SSL/TLS \u52a0\u5bc6",id:"-ssltls-\u52a0\u5bc6",level:2},{value:"\u751f\u6210\u8bc1\u4e66",id:"\u751f\u6210\u8bc1\u4e66",level:3},{value:"\u914d\u7f6e SSL",id:"\u914d\u7f6e-ssl",level:3},{value:"\u5f3a\u5236 SSL \u8fde\u63a5",id:"\u5f3a\u5236-ssl-\u8fde\u63a5",level:3},{value:"\u5ba2\u6237\u7aef\u8fde\u63a5",id:"\u5ba2\u6237\u7aef\u8fde\u63a5",level:3},{value:"\ud83d\udcdd \u5ba1\u8ba1\u65e5\u5fd7",id:"-\u5ba1\u8ba1\u65e5\u5fd7",level:2},{value:"\u542f\u7528\u65e5\u5fd7",id:"\u542f\u7528\u65e5\u5fd7",level:3},{value:"pgAudit \u6269\u5c55",id:"pgaudit-\u6269\u5c55",level:3},{value:"\ud83d\udee1\ufe0f \u5b89\u5168\u6700\u4f73\u5b9e\u8df5",id:"\ufe0f-\u5b89\u5168\u6700\u4f73\u5b9e\u8df5",level:2},{value:"\ud83d\udcca \u5b89\u5168\u68c0\u67e5",id:"-\u5b89\u5168\u68c0\u67e5",level:2},{value:"\ud83d\udcda \u76f8\u5173\u8d44\u6e90",id:"-\u76f8\u5173\u8d44\u6e90",level:2}];function o(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,d.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"postgresql-\u5b89\u5168\u7ba1\u7406",children:"PostgreSQL \u5b89\u5168\u7ba1\u7406"})}),"\n",(0,r.jsx)(n.p,{children:"\u6570\u636e\u5e93\u5b89\u5168\u662f\u4fdd\u62a4\u654f\u611f\u6570\u636e\u7684\u5173\u952e\uff0c\u5305\u62ec\u7528\u6237\u7ba1\u7406\u3001\u6743\u9650\u63a7\u5236\u3001\u8fde\u63a5\u52a0\u5bc6\u7b49\u65b9\u9762\u3002"}),"\n",(0,r.jsx)(n.h2,{id:"-\u7528\u6237\u548c\u89d2\u8272\u7ba1\u7406",children:"\ud83d\udc64 \u7528\u6237\u548c\u89d2\u8272\u7ba1\u7406"}),"\n",(0,r.jsx)(n.h3,{id:"\u521b\u5efa\u7528\u6237\u89d2\u8272",children:"\u521b\u5efa\u7528\u6237/\u89d2\u8272"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"-- \u521b\u5efa\u7528\u6237\uff08\u5e26\u767b\u5f55\u6743\u9650\u7684\u89d2\u8272\uff09\nCREATE USER myuser WITH PASSWORD 'secure_password';\n\n-- \u521b\u5efa\u89d2\u8272\uff08\u65e0\u767b\u5f55\u6743\u9650\uff09\nCREATE ROLE myrole;\n\n-- \u5e26\u66f4\u591a\u9009\u9879\nCREATE USER admin WITH\n    PASSWORD 'admin_pass'\n    SUPERUSER\n    CREATEDB\n    CREATEROLE\n    VALID UNTIL '2025-12-31';\n"})}),"\n",(0,r.jsx)(n.h3,{id:"\u7528\u6237\u5c5e\u6027",children:"\u7528\u6237\u5c5e\u6027"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"-- \u4fee\u6539\u5bc6\u7801\nALTER USER myuser WITH PASSWORD 'new_password';\n\n-- \u8bbe\u7f6e\u8fc7\u671f\u65f6\u95f4\nALTER USER myuser VALID UNTIL '2025-06-30';\n\n-- \u6388\u4e88/\u64a4\u9500\u6743\u9650\nALTER USER myuser CREATEDB;\nALTER USER myuser NOCREATEDB;\n\n-- \u5220\u9664\u7528\u6237\nDROP USER myuser;\n"})}),"\n",(0,r.jsx)(n.h3,{id:"\u89d2\u8272\u7ee7\u627f",children:"\u89d2\u8272\u7ee7\u627f"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"-- \u521b\u5efa\u89d2\u8272\u7ec4\nCREATE ROLE readonly;\nCREATE ROLE readwrite;\n\n-- \u6388\u4e88\u89d2\u8272\nGRANT readonly TO myuser;\nGRANT readwrite TO admin_user;\n\n-- \u8bbe\u7f6e\u9ed8\u8ba4\u89d2\u8272\nSET ROLE readonly;\nRESET ROLE;\n"})}),"\n",(0,r.jsx)(n.h2,{id:"-\u6743\u9650\u63a7\u5236",children:"\ud83d\udd10 \u6743\u9650\u63a7\u5236"}),"\n",(0,r.jsx)(n.h3,{id:"\u6570\u636e\u5e93\u6743\u9650",children:"\u6570\u636e\u5e93\u6743\u9650"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"-- \u6388\u4e88\u8fde\u63a5\u6743\u9650\nGRANT CONNECT ON DATABASE mydb TO myuser;\n\n-- \u6388\u4e88\u521b\u5efa\u6a21\u5f0f\u6743\u9650\nGRANT CREATE ON DATABASE mydb TO myuser;\n\n-- \u64a4\u9500\u6743\u9650\nREVOKE CONNECT ON DATABASE mydb FROM myuser;\n"})}),"\n",(0,r.jsx)(n.h3,{id:"\u6a21\u5f0f\u6743\u9650",children:"\u6a21\u5f0f\u6743\u9650"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"-- \u6388\u4e88\u6a21\u5f0f\u4f7f\u7528\u6743\u9650\nGRANT USAGE ON SCHEMA public TO myuser;\n\n-- \u6388\u4e88\u521b\u5efa\u5bf9\u8c61\u6743\u9650\nGRANT CREATE ON SCHEMA public TO myuser;\n"})}),"\n",(0,r.jsx)(n.h3,{id:"\u8868\u6743\u9650",children:"\u8868\u6743\u9650"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"-- \u6388\u4e88\u5355\u8868\u6743\u9650\nGRANT SELECT ON users TO myuser;\nGRANT INSERT, UPDATE, DELETE ON users TO myuser;\nGRANT ALL PRIVILEGES ON users TO admin_user;\n\n-- \u6388\u4e88\u6240\u6709\u8868\u6743\u9650\nGRANT SELECT ON ALL TABLES IN SCHEMA public TO readonly;\n\n-- \u8bbe\u7f6e\u9ed8\u8ba4\u6743\u9650\uff08\u672a\u6765\u521b\u5efa\u7684\u8868\uff09\nALTER DEFAULT PRIVILEGES IN SCHEMA public\nGRANT SELECT ON TABLES TO readonly;\n"})}),"\n",(0,r.jsx)(n.h3,{id:"\u5217\u7ea7\u6743\u9650",children:"\u5217\u7ea7\u6743\u9650"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"-- \u53ea\u5141\u8bb8\u67e5\u770b\u7279\u5b9a\u5217\nGRANT SELECT (id, name, email) ON users TO myuser;\n\n-- \u53ea\u5141\u8bb8\u66f4\u65b0\u7279\u5b9a\u5217\nGRANT UPDATE (email, phone) ON users TO myuser;\n"})}),"\n",(0,r.jsx)(n.h3,{id:"\u884c\u7ea7\u5b89\u5168rls",children:"\u884c\u7ea7\u5b89\u5168\uff08RLS\uff09"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"-- \u542f\u7528\u884c\u7ea7\u5b89\u5168\nALTER TABLE orders ENABLE ROW LEVEL SECURITY;\n\n-- \u521b\u5efa\u7b56\u7565\nCREATE POLICY user_orders ON orders\n    FOR ALL\n    TO myuser\n    USING (user_id = current_user_id());\n\n-- \u521b\u5efa\u53ea\u8bfb\u7b56\u7565\nCREATE POLICY read_own_orders ON orders\n    FOR SELECT\n    USING (user_id = current_user_id());\n\n-- \u5220\u9664\u7b56\u7565\nDROP POLICY user_orders ON orders;\n"})}),"\n",(0,r.jsx)(n.h2,{id:"-\u8fde\u63a5\u5b89\u5168",children:"\ud83d\udd12 \u8fde\u63a5\u5b89\u5168"}),"\n",(0,r.jsx)(n.h3,{id:"pg_hbaconf-\u914d\u7f6e",children:"pg_hba.conf \u914d\u7f6e"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-conf",children:"# TYPE  DATABASE  USER  ADDRESS        METHOD\n\n# \u672c\u5730\u8fde\u63a5\nlocal   all       postgres               peer\nlocal   all       all                    md5\n\n# IPv4 \u8fde\u63a5\nhost    all       all    127.0.0.1/32   scram-sha-256\nhost    all       all    10.0.0.0/8     scram-sha-256\n\n# IPv6 \u8fde\u63a5\nhost    all       all    ::1/128        scram-sha-256\n\n# SSL \u8fde\u63a5\nhostssl all       all    0.0.0.0/0      scram-sha-256\n\n# \u62d2\u7edd\u7279\u5b9a\u7528\u6237\nhost    all       baduser 0.0.0.0/0     reject\n"})}),"\n",(0,r.jsx)(n.h3,{id:"\u8ba4\u8bc1\u65b9\u5f0f",children:"\u8ba4\u8bc1\u65b9\u5f0f"}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"\u65b9\u5f0f"}),(0,r.jsx)(n.th,{children:"\u63cf\u8ff0"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.strong,{children:"trust"})}),(0,r.jsx)(n.td,{children:"\u65e0\u9700\u5bc6\u7801\uff08\u4e0d\u63a8\u8350\uff09"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.strong,{children:"md5"})}),(0,r.jsx)(n.td,{children:"MD5 \u5bc6\u7801\u52a0\u5bc6"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.strong,{children:"scram-sha-256"})}),(0,r.jsx)(n.td,{children:"\u66f4\u5b89\u5168\u7684\u52a0\u5bc6\uff08\u63a8\u8350\uff09"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.strong,{children:"peer"})}),(0,r.jsx)(n.td,{children:"\u64cd\u4f5c\u7cfb\u7edf\u7528\u6237\u9a8c\u8bc1"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.strong,{children:"cert"})}),(0,r.jsx)(n.td,{children:"SSL \u8bc1\u4e66\u9a8c\u8bc1"})]})]})]}),"\n",(0,r.jsx)(n.h3,{id:"\u4fee\u6539\u9ed8\u8ba4\u52a0\u5bc6\u65b9\u5f0f",children:"\u4fee\u6539\u9ed8\u8ba4\u52a0\u5bc6\u65b9\u5f0f"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-conf",children:"# postgresql.conf\npassword_encryption = scram-sha-256\n"})}),"\n",(0,r.jsx)(n.h2,{id:"-ssltls-\u52a0\u5bc6",children:"\ud83d\udd10 SSL/TLS \u52a0\u5bc6"}),"\n",(0,r.jsx)(n.h3,{id:"\u751f\u6210\u8bc1\u4e66",children:"\u751f\u6210\u8bc1\u4e66"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"# \u751f\u6210\u79c1\u94a5\nopenssl genrsa -out server.key 2048\n\n# \u751f\u6210\u8bc1\u4e66\nopenssl req -new -key server.key -out server.csr\nopenssl x509 -req -days 365 -in server.csr -signkey server.key -out server.crt\n\n# \u8bbe\u7f6e\u6743\u9650\nchmod 600 server.key\nchown postgres:postgres server.key server.crt\n"})}),"\n",(0,r.jsx)(n.h3,{id:"\u914d\u7f6e-ssl",children:"\u914d\u7f6e SSL"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-conf",children:"# postgresql.conf\nssl = on\nssl_cert_file = '/var/lib/postgresql/server.crt'\nssl_key_file = '/var/lib/postgresql/server.key'\nssl_ca_file = '/var/lib/postgresql/ca.crt'  # \u53ef\u9009\n"})}),"\n",(0,r.jsx)(n.h3,{id:"\u5f3a\u5236-ssl-\u8fde\u63a5",children:"\u5f3a\u5236 SSL \u8fde\u63a5"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-conf",children:"# pg_hba.conf\nhostssl all all 0.0.0.0/0 scram-sha-256\n"})}),"\n",(0,r.jsx)(n.h3,{id:"\u5ba2\u6237\u7aef\u8fde\u63a5",children:"\u5ba2\u6237\u7aef\u8fde\u63a5"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:'psql "host=server sslmode=require dbname=mydb user=myuser"\n'})}),"\n",(0,r.jsx)(n.h2,{id:"-\u5ba1\u8ba1\u65e5\u5fd7",children:"\ud83d\udcdd \u5ba1\u8ba1\u65e5\u5fd7"}),"\n",(0,r.jsx)(n.h3,{id:"\u542f\u7528\u65e5\u5fd7",children:"\u542f\u7528\u65e5\u5fd7"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-conf",children:"# postgresql.conf\nlogging_collector = on\nlog_directory = '/var/log/postgresql'\nlog_filename = 'postgresql-%Y-%m-%d.log'\nlog_rotation_age = 1d\nlog_rotation_size = 100MB\n\n# \u8bb0\u5f55\u5185\u5bb9\nlog_connections = on\nlog_disconnections = on\nlog_statement = 'all'  # none, ddl, mod, all\nlog_duration = on\n"})}),"\n",(0,r.jsx)(n.h3,{id:"pgaudit-\u6269\u5c55",children:"pgAudit \u6269\u5c55"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"-- \u5b89\u88c5\u6269\u5c55\nCREATE EXTENSION pgaudit;\n\n-- \u914d\u7f6e\u5ba1\u8ba1\n-- postgresql.conf\npgaudit.log = 'read, write, ddl'\n"})}),"\n",(0,r.jsx)(n.h2,{id:"\ufe0f-\u5b89\u5168\u6700\u4f73\u5b9e\u8df5",children:"\ud83d\udee1\ufe0f \u5b89\u5168\u6700\u4f73\u5b9e\u8df5"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.strong,{children:"\u4f7f\u7528\u5f3a\u5bc6\u7801\u548c scram-sha-256"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.strong,{children:"\u542f\u7528 SSL \u52a0\u5bc6\u8fde\u63a5"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.strong,{children:"\u9650\u5236\u7f51\u7edc\u8bbf\u95ee\uff08pg_hba.conf\uff09"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.strong,{children:"\u4f7f\u7528\u6700\u5c0f\u6743\u9650\u539f\u5219"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.strong,{children:"\u5b9a\u671f\u8f6e\u6362\u5bc6\u7801"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.strong,{children:"\u542f\u7528\u5ba1\u8ba1\u65e5\u5fd7"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.strong,{children:"\u4f7f\u7528\u884c\u7ea7\u5b89\u5168\u7b56\u7565"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.strong,{children:"\u5b9a\u671f\u5907\u4efd"})}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"-\u5b89\u5168\u68c0\u67e5",children:"\ud83d\udcca \u5b89\u5168\u68c0\u67e5"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"-- \u67e5\u770b\u7528\u6237\u6743\u9650\nSELECT grantee, privilege_type\nFROM information_schema.role_table_grants\nWHERE table_name = 'users';\n\n-- \u67e5\u770b\u7528\u6237\u5c5e\u6027\nSELECT usename, usecreatedb, usesuper\nFROM pg_user;\n\n-- \u67e5\u770b\u6d3b\u52a8\u8fde\u63a5\nSELECT usename, client_addr, ssl\nFROM pg_stat_activity;\n"})}),"\n",(0,r.jsx)(n.h2,{id:"-\u76f8\u5173\u8d44\u6e90",children:"\ud83d\udcda \u76f8\u5173\u8d44\u6e90"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"/docs/postgres/basic-concepts",children:"\u57fa\u7840\u6982\u5ff5"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"/docs/postgres/faq",children:"\u5e38\u89c1\u95ee\u9898"})}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,d.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(o,{...e})}):o(e)}}}]);