"use strict";(globalThis.webpackChunkto_lib_github_io=globalThis.webpackChunkto_lib_github_io||[]).push([[86638],{48885:(e,n,i)=>{i.d(n,{R:()=>a,x:()=>s});var t=i(99378);const l={},r=t.createContext(l);function a(e){const n=t.useContext(r);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function s(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(l):e.components||l:a(e.components),t.createElement(r.Provider,{value:n},e.children)}},55489:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>o,contentTitle:()=>s,default:()=>d,frontMatter:()=>a,metadata:()=>t,toc:()=>c});const t=JSON.parse('{"id":"springboot/file-upload","title":"\u6587\u4ef6\u4e0a\u4f20\u4e0b\u8f7d","description":"[!TIP]","source":"@site/docs/springboot/file-upload.md","sourceDirName":"springboot","slug":"/springboot/file-upload","permalink":"/docs/springboot/file-upload","draft":false,"unlisted":false,"editUrl":"https://github.com/to-lib/to-lib.github.io/tree/main/docs/springboot/file-upload.md","tags":[],"version":"current","sidebarPosition":21,"frontMatter":{"sidebar_position":21},"sidebar":"springboot","previous":{"title":"WebSocket \u5b9e\u65f6\u901a\u4fe1","permalink":"/docs/springboot/websocket"},"next":{"title":"\u56fd\u9645\u5316 (i18n)","permalink":"/docs/springboot/i18n"}}');var l=i(22714),r=i(48885);const a={sidebar_position:21},s="\u6587\u4ef6\u4e0a\u4f20\u4e0b\u8f7d",o={},c=[{value:"\u6587\u4ef6\u4e0a\u4f20",id:"\u6587\u4ef6\u4e0a\u4f20",level:2},{value:"\u57fa\u672c\u914d\u7f6e",id:"\u57fa\u672c\u914d\u7f6e",level:3},{value:"\u5355\u6587\u4ef6\u4e0a\u4f20",id:"\u5355\u6587\u4ef6\u4e0a\u4f20",level:3},{value:"\u591a\u6587\u4ef6\u4e0a\u4f20",id:"\u591a\u6587\u4ef6\u4e0a\u4f20",level:3},{value:"\u6587\u4ef6\u4e0b\u8f7d",id:"\u6587\u4ef6\u4e0b\u8f7d",level:2},{value:"\u57fa\u672c\u4e0b\u8f7d",id:"\u57fa\u672c\u4e0b\u8f7d",level:3},{value:"\u6d41\u5f0f\u4e0b\u8f7d\u5927\u6587\u4ef6",id:"\u6d41\u5f0f\u4e0b\u8f7d\u5927\u6587\u4ef6",level:3},{value:"\u6587\u4ef6\u7ba1\u7406\u670d\u52a1",id:"\u6587\u4ef6\u7ba1\u7406\u670d\u52a1",level:2},{value:"\u56fe\u7247\u4e0a\u4f20\u4e0e\u538b\u7f29",id:"\u56fe\u7247\u4e0a\u4f20\u4e0e\u538b\u7f29",level:2},{value:"\u4e91\u5b58\u50a8\u96c6\u6210\uff08\u963f\u91cc\u4e91 OSS\uff09",id:"\u4e91\u5b58\u50a8\u96c6\u6210\u963f\u91cc\u4e91-oss",level:2},{value:"\u6700\u4f73\u5b9e\u8df5",id:"\u6700\u4f73\u5b9e\u8df5",level:2},{value:"\u603b\u7ed3",id:"\u603b\u7ed3",level:2}];function p(e){const n={a:"a",blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(n.header,{children:(0,l.jsx)(n.h1,{id:"\u6587\u4ef6\u4e0a\u4f20\u4e0b\u8f7d",children:"\u6587\u4ef6\u4e0a\u4f20\u4e0b\u8f7d"})}),"\n",(0,l.jsxs)(n.blockquote,{children:["\n",(0,l.jsxs)(n.p,{children:["[!TIP]\n",(0,l.jsx)(n.strong,{children:"\u6587\u4ef6\u5904\u7406\u8981\u70b9"}),": \u5408\u7406\u9650\u5236\u6587\u4ef6\u5927\u5c0f\u548c\u7c7b\u578b\u3001\u4f7f\u7528\u6d41\u5f0f\u5904\u7406\u5927\u6587\u4ef6\u3001\u9009\u62e9\u5408\u9002\u7684\u5b58\u50a8\u65b9\u6848\uff08\u672c\u5730\u5b58\u50a8 vs \u4e91\u5b58\u50a8\uff09\u3002"]}),"\n"]}),"\n",(0,l.jsx)(n.h2,{id:"\u6587\u4ef6\u4e0a\u4f20",children:"\u6587\u4ef6\u4e0a\u4f20"}),"\n",(0,l.jsx)(n.h3,{id:"\u57fa\u672c\u914d\u7f6e",children:"\u57fa\u672c\u914d\u7f6e"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-yaml",children:"spring:\n  servlet:\n    multipart:\n      enabled: true\n      max-file-size: 10MB      # \u5355\u4e2a\u6587\u4ef6\u6700\u5927\u5927\u5c0f\n      max-request-size: 50MB   # \u6574\u4e2a\u8bf7\u6c42\u6700\u5927\u5927\u5c0f\n      file-size-threshold: 2KB # \u6587\u4ef6\u5199\u5165\u78c1\u76d8\u7684\u9608\u503c\n"})}),"\n",(0,l.jsx)(n.h3,{id:"\u5355\u6587\u4ef6\u4e0a\u4f20",children:"\u5355\u6587\u4ef6\u4e0a\u4f20"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:'@RestController\n@RequestMapping("/api/files")\npublic class FileUploadController {\n    \n    @Value("${file.upload.dir:/tmp/uploads}")\n    private String uploadDir;\n    \n    @PostMapping("/upload")\n    public ResponseEntity<FileUploadResponse> uploadFile(\n            @RequestParam("file") MultipartFile file) {\n        \n        // \u9a8c\u8bc1\u6587\u4ef6\n        if (file.isEmpty()) {\n            throw new IllegalArgumentException("\u6587\u4ef6\u4e0d\u80fd\u4e3a\u7a7a");\n        }\n        \n        // \u9a8c\u8bc1\u6587\u4ef6\u7c7b\u578b\n        String contentType = file.getContentType();\n        if (!isValidFileType(contentType)) {\n            throw new IllegalArgumentException("\u4e0d\u652f\u6301\u7684\u6587\u4ef6\u7c7b\u578b");\n        }\n        \n        try {\n            // \u751f\u6210\u552f\u4e00\u6587\u4ef6\u540d\n            String originalFilename = file.getOriginalFilename();\n            String extension = FilenameUtils.getExtension(originalFilename);\n            String newFilename = UUID.randomUUID().toString() + "." + extension;\n            \n            // \u521b\u5efa\u4e0a\u4f20\u76ee\u5f55\n            Path uploadPath = Paths.get(uploadDir);\n            if (!Files.exists(uploadPath)) {\n                Files.createDirectories(uploadPath);\n            }\n            \n            // \u4fdd\u5b58\u6587\u4ef6\n            Path filePath = uploadPath.resolve(newFilename);\n            Files.copy(file.getInputStream(), filePath, \n                StandardCopyOption.REPLACE_EXISTING);\n            \n            // \u6784\u5efa\u54cd\u5e94\n            FileUploadResponse response = FileUploadResponse.builder()\n                .filename(newFilename)\n                .originalFilename(originalFilename)\n                .size(file.getSize())\n                .contentType(contentType)\n                .uploadTime(LocalDateTime.now())\n                .url("/api/files/download/" + newFilename)\n                .build();\n            \n            return ResponseEntity.ok(response);\n            \n        } catch (IOException e) {\n            throw new RuntimeException("\u6587\u4ef6\u4e0a\u4f20\u5931\u8d25", e);\n        }\n    }\n    \n    private boolean isValidFileType(String contentType) {\n        List<String> allowedTypes = Arrays.asList(\n            "image/jpeg", "image/png", "image/gif",\n            "application/pdf", "text/plain"\n        );\n        return allowedTypes.contains(contentType);\n    }\n}\n'})}),"\n",(0,l.jsx)(n.h3,{id:"\u591a\u6587\u4ef6\u4e0a\u4f20",children:"\u591a\u6587\u4ef6\u4e0a\u4f20"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:'@PostMapping("/upload/multiple")\npublic ResponseEntity<List<FileUploadResponse>> uploadMultipleFiles(\n        @RequestParam("files") MultipartFile[] files) {\n    \n    List<FileUploadResponse> responses = new ArrayList<>();\n    \n    for (MultipartFile file : files) {\n        if (!file.isEmpty()) {\n            FileUploadResponse response = saveFile(file);\n            responses.add(response);\n        }\n    }\n    \n    return ResponseEntity.ok(responses);\n}\n'})}),"\n",(0,l.jsx)(n.h2,{id:"\u6587\u4ef6\u4e0b\u8f7d",children:"\u6587\u4ef6\u4e0b\u8f7d"}),"\n",(0,l.jsx)(n.h3,{id:"\u57fa\u672c\u4e0b\u8f7d",children:"\u57fa\u672c\u4e0b\u8f7d"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:'@GetMapping("/download/{filename}")\npublic ResponseEntity<Resource> downloadFile(@PathVariable String filename) {\n    try {\n        Path filePath = Paths.get(uploadDir).resolve(filename).normalize();\n        Resource resource = new UrlResource(filePath.toUri());\n        \n        if (!resource.exists()) {\n            throw new ResourceNotFoundException("\u6587\u4ef6\u4e0d\u5b58\u5728: " + filename);\n        }\n        \n        // \u83b7\u53d6\u6587\u4ef6\u7684 Content-Type\n        String contentType = Files.probeContentType(filePath);\n        if (contentType == null) {\n            contentType = "application/octet-stream";\n        }\n        \n        return ResponseEntity.ok()\n            .contentType(MediaType.parseMediaType(contentType))\n            .header(HttpHeaders.CONTENT_DISPOSITION, \n                "attachment; filename=\\"" + resource.getFilename() + "\\"")\n            .body(resource);\n            \n    } catch (IOException e) {\n        throw new RuntimeException("\u6587\u4ef6\u4e0b\u8f7d\u5931\u8d25", e);\n    }\n}\n'})}),"\n",(0,l.jsx)(n.h3,{id:"\u6d41\u5f0f\u4e0b\u8f7d\u5927\u6587\u4ef6",children:"\u6d41\u5f0f\u4e0b\u8f7d\u5927\u6587\u4ef6"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:'@GetMapping("/download/large/{filename}")\npublic void downloadLargeFile(@PathVariable String filename, \n                              HttpServletResponse response) {\n    try {\n        Path filePath = Paths.get(uploadDir).resolve(filename);\n        \n        response.setContentType("application/octet-stream");\n        response.setHeader(HttpHeaders.CONTENT_DISPOSITION,\n            "attachment; filename=\\"" + filename + "\\"");\n        response.setContentLengthLong(Files.size(filePath));\n        \n        // \u4f7f\u7528\u6d41\u5f0f\u4f20\u8f93\n        try (InputStream inputStream = Files.newInputStream(filePath);\n             OutputStream outputStream = response.getOutputStream()) {\n            \n            byte[] buffer = new byte[8192];\n            int bytesRead;\n            while ((bytesRead = inputStream.read(buffer)) != -1) {\n                outputStream.write(buffer, 0, bytesRead);\n            }\n            outputStream.flush();\n        }\n        \n    } catch (IOException e) {\n        throw new RuntimeException("\u6587\u4ef6\u4e0b\u8f7d\u5931\u8d25", e);\n    }\n}\n'})}),"\n",(0,l.jsx)(n.h2,{id:"\u6587\u4ef6\u7ba1\u7406\u670d\u52a1",children:"\u6587\u4ef6\u7ba1\u7406\u670d\u52a1"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:'@Service\npublic class FileStorageService {\n    \n    @Value("${file.upload.dir}")\n    private Path uploadPath;\n    \n    @PostConstruct\n    public void init() {\n        try {\n            Files.createDirectories(uploadPath);\n        } catch (IOException e) {\n            throw new RuntimeException("\u65e0\u6cd5\u521b\u5efa\u4e0a\u4f20\u76ee\u5f55", e);\n        }\n    }\n    \n    public String store(MultipartFile file) {\n        String filename = StringUtils.cleanPath(file.getOriginalFilename());\n        \n        try {\n            if (file.isEmpty()) {\n                throw new RuntimeException("\u5b58\u50a8\u5931\u8d25\uff1a\u6587\u4ef6\u4e3a\u7a7a " + filename);\n            }\n            \n            if (filename.contains("..")) {\n                throw new RuntimeException("\u975e\u6cd5\u8def\u5f84 " + filename);\n            }\n            \n            String storedFilename = UUID.randomUUID().toString() + \n                "_" + filename;\n            \n            try (InputStream inputStream = file.getInputStream()) {\n                Files.copy(inputStream, uploadPath.resolve(storedFilename),\n                    StandardCopyOption.REPLACE_EXISTING);\n            }\n            \n            return storedFilename;\n            \n        } catch (IOException e) {\n            throw new RuntimeException("\u5b58\u50a8\u6587\u4ef6\u5931\u8d25 " + filename, e);\n        }\n    }\n    \n    public Resource loadAsResource(String filename) {\n        try {\n            Path file = uploadPath.resolve(filename);\n            Resource resource = new UrlResource(file.toUri());\n            \n            if (resource.exists() || resource.isReadable()) {\n                return resource;\n            } else {\n                throw new RuntimeException("\u6587\u4ef6\u4e0d\u5b58\u5728\u6216\u4e0d\u53ef\u8bfb: " + filename);\n            }\n        } catch (MalformedURLException e) {\n            throw new RuntimeException("\u6587\u4ef6\u4e0d\u5b58\u5728 " + filename, e);\n        }\n    }\n    \n    public void delete(String filename) {\n        try {\n            Path file = uploadPath.resolve(filename);\n            Files.deleteIfExists(file);\n        } catch (IOException e) {\n            throw new RuntimeException("\u5220\u9664\u6587\u4ef6\u5931\u8d25 " + filename, e);\n        }\n    }\n}\n'})}),"\n",(0,l.jsx)(n.h2,{id:"\u56fe\u7247\u4e0a\u4f20\u4e0e\u538b\u7f29",children:"\u56fe\u7247\u4e0a\u4f20\u4e0e\u538b\u7f29"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:'@Service\npublic class ImageService {\n    \n    public String uploadAndCompressImage(MultipartFile file) throws IOException {\n        // \u8bfb\u53d6\u56fe\u7247\n        BufferedImage originalImage = ImageIO.read(file.getInputStream());\n        \n        // \u538b\u7f29\u56fe\u7247\n        BufferedImage compressedImage = compressImage(originalImage, 0.7f);\n        \n        // \u4fdd\u5b58\u538b\u7f29\u540e\u7684\u56fe\u7247\n        String filename = UUID.randomUUID().toString() + ".jpg";\n        Path outputPath = Paths.get(uploadDir, filename);\n        ImageIO.write(compressedImage, "jpg", outputPath.toFile());\n        \n        return filename;\n    }\n    \n    private BufferedImage compressImage(BufferedImage image, float quality) {\n        int width = image.getWidth();\n        int height = image.getHeight();\n        \n        // \u5982\u679c\u56fe\u7247\u592a\u5927\uff0c\u7f29\u5c0f\u5c3a\u5bf8\n        if (width > 1920 || height > 1080) {\n            double scale = Math.min(1920.0 / width, 1080.0 / height);\n            width = (int) (width * scale);\n            height = (int) (height * scale);\n            \n            BufferedImage resized = new BufferedImage(\n                width, height, BufferedImage.TYPE_INT_RGB);\n            Graphics2D g = resized.createGraphics();\n            g.setRenderingHint(RenderingHints.KEY_INTERPOLATION,\n                RenderingHints.VALUE_INTERPOLATION_BILINEAR);\n            g.drawImage(image, 0, 0, width, height, null);\n            g.dispose();\n            \n            return resized;\n        }\n        \n        return image;\n    }\n}\n'})}),"\n",(0,l.jsx)(n.h2,{id:"\u4e91\u5b58\u50a8\u96c6\u6210\u963f\u91cc\u4e91-oss",children:"\u4e91\u5b58\u50a8\u96c6\u6210\uff08\u963f\u91cc\u4e91 OSS\uff09"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:'@Service\npublic class OSSFileService {\n    \n    @Value("${aliyun.oss.endpoint}")\n    private String endpoint;\n    \n    @Value("${aliyun.oss.accessKeyId}")\n    private String accessKeyId;\n    \n    @Value("${aliyun.oss.accessKeySecret}")\n    private String accessKeySecret;\n    \n    @Value("${aliyun.oss.bucketName}")\n    private String bucketName;\n    \n    private OSS ossClient;\n    \n    @PostConstruct\n    public void init() {\n        ossClient = new OSSClientBuilder().build(\n            endpoint, accessKeyId, accessKeySecret);\n    }\n    \n    public String upload(MultipartFile file) {\n        String filename = UUID.randomUUID().toString() + \n            "_" + file.getOriginalFilename();\n        \n        try {\n            ossClient.putObject(bucketName, filename, \n                file.getInputStream());\n            \n            return "https://" + bucketName + "." + endpoint + "/" + filename;\n        } catch (IOException e) {\n            throw new RuntimeException("\u4e0a\u4f20OSS\u5931\u8d25", e);\n        }\n    }\n    \n    @PreDestroy\n    public void destroy() {\n        if (ossClient != null) {\n            ossClient.shutdown();\n        }\n    }\n}\n'})}),"\n",(0,l.jsx)(n.h2,{id:"\u6700\u4f73\u5b9e\u8df5",children:"\u6700\u4f73\u5b9e\u8df5"}),"\n",(0,l.jsxs)(n.blockquote,{children:["\n",(0,l.jsxs)(n.p,{children:["[!IMPORTANT]\n",(0,l.jsx)(n.strong,{children:"\u6587\u4ef6\u4e0a\u4f20\u5b89\u5168\u5efa\u8bae"}),"\uff1a"]}),"\n",(0,l.jsxs)(n.ol,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"\u9a8c\u8bc1\u6587\u4ef6\u7c7b\u578b"})," - \u68c0\u67e5 MIME \u7c7b\u578b\u548c\u6587\u4ef6\u6269\u5c55\u540d"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"\u9650\u5236\u6587\u4ef6\u5927\u5c0f"})," - \u9632\u6b62\u78c1\u76d8\u6491\u7206"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"\u91cd\u547d\u540d\u6587\u4ef6"})," - \u4f7f\u7528 UUID \u907f\u514d\u51b2\u7a81\u548c\u5b89\u5168\u95ee\u9898"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"\u626b\u63cf\u75c5\u6bd2"})," - \u96c6\u6210\u6740\u6bd2\u8f6f\u4ef6"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"\u5b58\u50a8\u9694\u79bb"})," - \u4e0d\u8981\u5b58\u50a8\u5728 Web \u6839\u76ee\u5f55"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"\u8bbf\u95ee\u63a7\u5236"})," - \u6839\u636e\u9700\u6c42\u63a7\u5236\u6587\u4ef6\u8bbf\u95ee\u6743\u9650"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.h2,{id:"\u603b\u7ed3",children:"\u603b\u7ed3"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"MultipartFile"})," - Spring \u63d0\u4f9b\u7684\u6587\u4ef6\u4e0a\u4f20\u63a5\u53e3"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"Resource"})," - \u6587\u4ef6\u4e0b\u8f7d\u8d44\u6e90\u62bd\u8c61"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"\u6d41\u5f0f\u5904\u7406"})," - \u5904\u7406\u5927\u6587\u4ef6\u907f\u514d\u5185\u5b58\u6ea2\u51fa"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"\u4e91\u5b58\u50a8"})," - \u751f\u4ea7\u73af\u5883\u63a8\u8350\u4f7f\u7528\u4e91\u5b58\u50a8\u670d\u52a1"]}),"\n"]}),"\n",(0,l.jsxs)(n.p,{children:["\u4e0b\u4e00\u6b65\u5b66\u4e60 ",(0,l.jsx)(n.a,{href:"/docs/springboot/i18n",children:"\u56fd\u9645\u5316"}),"\u3002"]})]})}function d(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,l.jsx)(n,{...e,children:(0,l.jsx)(p,{...e})}):p(e)}}}]);