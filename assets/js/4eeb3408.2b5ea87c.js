"use strict";(globalThis.webpackChunkto_lib_github_io=globalThis.webpackChunkto_lib_github_io||[]).push([[42398],{32950:(n,e,s)=>{s.r(e),s.d(e,{assets:()=>r,contentTitle:()=>o,default:()=>d,frontMatter:()=>c,metadata:()=>t,toc:()=>u});const t=JSON.parse('{"id":"docker/cicd","title":"CI/CD \u96c6\u6210","description":"GitHub Actions\u3001GitLab CI \u4e0e Docker \u81ea\u52a8\u5316\u6784\u5efa\u53d1\u5e03","source":"@site/docs/docker/cicd.md","sourceDirName":"docker","slug":"/docker/cicd","permalink":"/docs/docker/cicd","draft":false,"unlisted":false,"editUrl":"https://github.com/to-lib/to-lib.github.io/tree/main/docs/docker/cicd.md","tags":[],"version":"current","sidebarPosition":23,"frontMatter":{"sidebar_position":23,"title":"CI/CD \u96c6\u6210","description":"GitHub Actions\u3001GitLab CI \u4e0e Docker \u81ea\u52a8\u5316\u6784\u5efa\u53d1\u5e03"}}');var a=s(22714),i=s(48885);const c={sidebar_position:23,title:"CI/CD \u96c6\u6210",description:"GitHub Actions\u3001GitLab CI \u4e0e Docker \u81ea\u52a8\u5316\u6784\u5efa\u53d1\u5e03"},o="CI/CD \u96c6\u6210",r={},u=[{value:"GitHub Actions",id:"github-actions",level:2},{value:"\u57fa\u7840\u6784\u5efa\u4e0e\u63a8\u9001",id:"\u57fa\u7840\u6784\u5efa\u4e0e\u63a8\u9001",level:3},{value:"\u591a\u67b6\u6784\u6784\u5efa",id:"\u591a\u67b6\u6784\u6784\u5efa",level:3},{value:"\u5b89\u5168\u626b\u63cf",id:"\u5b89\u5168\u626b\u63cf",level:3},{value:"GitLab CI",id:"gitlab-ci",level:2},{value:"\u57fa\u7840\u914d\u7f6e",id:"\u57fa\u7840\u914d\u7f6e",level:3},{value:"\u591a\u67b6\u6784\u6784\u5efa",id:"\u591a\u67b6\u6784\u6784\u5efa-1",level:3},{value:"\u955c\u50cf\u7248\u672c\u7b56\u7565",id:"\u955c\u50cf\u7248\u672c\u7b56\u7565",level:2},{value:"\u8bed\u4e49\u5316\u7248\u672c",id:"\u8bed\u4e49\u5316\u7248\u672c",level:3},{value:"Git SHA \u6807\u7b7e",id:"git-sha-\u6807\u7b7e",level:3},{value:"\u65e5\u671f\u6807\u7b7e",id:"\u65e5\u671f\u6807\u7b7e",level:3},{value:"\u6784\u5efa\u7f13\u5b58\u4f18\u5316",id:"\u6784\u5efa\u7f13\u5b58\u4f18\u5316",level:2},{value:"GitHub Actions \u7f13\u5b58",id:"github-actions-\u7f13\u5b58",level:3},{value:"Registry \u7f13\u5b58",id:"registry-\u7f13\u5b58",level:3},{value:"\u672c\u5730\u7f13\u5b58",id:"\u672c\u5730\u7f13\u5b58",level:3},{value:"\u90e8\u7f72\u7b56\u7565",id:"\u90e8\u7f72\u7b56\u7565",level:2},{value:"\u6eda\u52a8\u66f4\u65b0",id:"\u6eda\u52a8\u66f4\u65b0",level:3},{value:"Docker Compose \u90e8\u7f72",id:"docker-compose-\u90e8\u7f72",level:3},{value:"\u5b8c\u6574\u793a\u4f8b",id:"\u5b8c\u6574\u793a\u4f8b",level:2}];function l(n){const e={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",p:"p",pre:"pre",...(0,i.R)(),...n.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(e.header,{children:(0,a.jsx)(e.h1,{id:"cicd-\u96c6\u6210",children:"CI/CD \u96c6\u6210"})}),"\n",(0,a.jsx)(e.p,{children:"\u5c06 Docker \u96c6\u6210\u5230\u6301\u7eed\u96c6\u6210\u548c\u6301\u7eed\u90e8\u7f72\u6d41\u6c34\u7ebf\u4e2d\u3002"}),"\n",(0,a.jsx)(e.h2,{id:"github-actions",children:"GitHub Actions"}),"\n",(0,a.jsx)(e.h3,{id:"\u57fa\u7840\u6784\u5efa\u4e0e\u63a8\u9001",children:"\u57fa\u7840\u6784\u5efa\u4e0e\u63a8\u9001"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-yaml",children:"# .github/workflows/docker.yml\nname: Docker Build\n\non:\n  push:\n    branches: [main]\n  pull_request:\n    branches: [main]\n\njobs:\n  build:\n    runs-on: ubuntu-latest\n    steps:\n      - uses: actions/checkout@v4\n\n      - name: Set up Docker Buildx\n        uses: docker/setup-buildx-action@v3\n\n      - name: Login to Docker Hub\n        uses: docker/login-action@v3\n        with:\n          username: ${{ secrets.DOCKERHUB_USERNAME }}\n          password: ${{ secrets.DOCKERHUB_TOKEN }}\n\n      - name: Build and Push\n        uses: docker/build-push-action@v5\n        with:\n          context: .\n          push: ${{ github.event_name != 'pull_request' }}\n          tags: |\n            myuser/myapp:latest\n            myuser/myapp:${{ github.sha }}\n          cache-from: type=gha\n          cache-to: type=gha,mode=max\n"})}),"\n",(0,a.jsx)(e.h3,{id:"\u591a\u67b6\u6784\u6784\u5efa",children:"\u591a\u67b6\u6784\u6784\u5efa"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-yaml",children:'name: Multi-Arch Build\n\non:\n  push:\n    tags: ["v*"]\n\njobs:\n  build:\n    runs-on: ubuntu-latest\n    steps:\n      - uses: actions/checkout@v4\n\n      - name: Set up QEMU\n        uses: docker/setup-qemu-action@v3\n\n      - name: Set up Docker Buildx\n        uses: docker/setup-buildx-action@v3\n\n      - name: Login to GHCR\n        uses: docker/login-action@v3\n        with:\n          registry: ghcr.io\n          username: ${{ github.actor }}\n          password: ${{ secrets.GITHUB_TOKEN }}\n\n      - name: Extract metadata\n        id: meta\n        uses: docker/metadata-action@v5\n        with:\n          images: ghcr.io/${{ github.repository }}\n          tags: |\n            type=semver,pattern={{version}}\n            type=semver,pattern={{major}}.{{minor}}\n            type=sha\n\n      - name: Build and Push\n        uses: docker/build-push-action@v5\n        with:\n          context: .\n          platforms: linux/amd64,linux/arm64\n          push: true\n          tags: ${{ steps.meta.outputs.tags }}\n          labels: ${{ steps.meta.outputs.labels }}\n'})}),"\n",(0,a.jsx)(e.h3,{id:"\u5b89\u5168\u626b\u63cf",children:"\u5b89\u5168\u626b\u63cf"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-yaml",children:"name: Security Scan\n\non:\n  push:\n    branches: [main]\n\njobs:\n  scan:\n    runs-on: ubuntu-latest\n    steps:\n      - uses: actions/checkout@v4\n\n      - name: Build Image\n        run: docker build -t myapp:scan .\n\n      - name: Run Trivy Scan\n        uses: aquasecurity/trivy-action@master\n        with:\n          image-ref: myapp:scan\n          format: sarif\n          output: trivy-results.sarif\n\n      - name: Upload Scan Results\n        uses: github/codeql-action/upload-sarif@v2\n        with:\n          sarif_file: trivy-results.sarif\n"})}),"\n",(0,a.jsx)(e.h2,{id:"gitlab-ci",children:"GitLab CI"}),"\n",(0,a.jsx)(e.h3,{id:"\u57fa\u7840\u914d\u7f6e",children:"\u57fa\u7840\u914d\u7f6e"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-yaml",children:"# .gitlab-ci.yml\nstages:\n  - build\n  - test\n  - deploy\n\nvariables:\n  DOCKER_IMAGE: $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA\n\nbuild:\n  stage: build\n  image: docker:24\n  services:\n    - docker:24-dind\n  variables:\n    DOCKER_BUILDKIT: 1\n  before_script:\n    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY\n  script:\n    - docker build\n        --cache-from $CI_REGISTRY_IMAGE:latest\n        --tag $DOCKER_IMAGE\n        --tag $CI_REGISTRY_IMAGE:latest\n        .\n    - docker push $DOCKER_IMAGE\n    - docker push $CI_REGISTRY_IMAGE:latest\n\ntest:\n  stage: test\n  image: $DOCKER_IMAGE\n  script:\n    - npm test\n\ndeploy:\n  stage: deploy\n  image: docker:24\n  only:\n    - main\n  script:\n    - docker pull $DOCKER_IMAGE\n    - docker tag $DOCKER_IMAGE $CI_REGISTRY_IMAGE:production\n    - docker push $CI_REGISTRY_IMAGE:production\n"})}),"\n",(0,a.jsx)(e.h3,{id:"\u591a\u67b6\u6784\u6784\u5efa-1",children:"\u591a\u67b6\u6784\u6784\u5efa"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-yaml",children:"build-multiarch:\n  stage: build\n  image: docker:24\n  services:\n    - docker:24-dind\n  variables:\n    DOCKER_BUILDKIT: 1\n  before_script:\n    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY\n    - docker buildx create --use\n  script:\n    - docker buildx build\n        --platform linux/amd64,linux/arm64\n        --push\n        --tag $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA\n        --tag $CI_REGISTRY_IMAGE:latest\n        .\n"})}),"\n",(0,a.jsx)(e.h2,{id:"\u955c\u50cf\u7248\u672c\u7b56\u7565",children:"\u955c\u50cf\u7248\u672c\u7b56\u7565"}),"\n",(0,a.jsx)(e.h3,{id:"\u8bed\u4e49\u5316\u7248\u672c",children:"\u8bed\u4e49\u5316\u7248\u672c"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-yaml",children:'# \u6839\u636e Git tag \u751f\u6210\u7248\u672c\n- name: Extract version\n  id: version\n  run: |\n    if [[ $GITHUB_REF == refs/tags/v* ]]; then\n      VERSION=${GITHUB_REF#refs/tags/v}\n      echo "version=$VERSION" >> $GITHUB_OUTPUT\n      echo "major=${VERSION%%.*}" >> $GITHUB_OUTPUT\n    fi\n\n- name: Build and Push\n  uses: docker/build-push-action@v5\n  with:\n    tags: |\n      myapp:${{ steps.version.outputs.version }}\n      myapp:${{ steps.version.outputs.major }}\n      myapp:latest\n'})}),"\n",(0,a.jsx)(e.h3,{id:"git-sha-\u6807\u7b7e",children:"Git SHA \u6807\u7b7e"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-yaml",children:"tags: |\n  myapp:${{ github.sha }}\n  myapp:${{ github.ref_name }}-${{ github.run_number }}\n"})}),"\n",(0,a.jsx)(e.h3,{id:"\u65e5\u671f\u6807\u7b7e",children:"\u65e5\u671f\u6807\u7b7e"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-yaml",children:"- name: Get date\n  id: date\n  run: echo \"date=$(date +'%Y%m%d')\" >> $GITHUB_OUTPUT\n\n- name: Build\n  with:\n    tags: myapp:${{ steps.date.outputs.date }}\n"})}),"\n",(0,a.jsx)(e.h2,{id:"\u6784\u5efa\u7f13\u5b58\u4f18\u5316",children:"\u6784\u5efa\u7f13\u5b58\u4f18\u5316"}),"\n",(0,a.jsx)(e.h3,{id:"github-actions-\u7f13\u5b58",children:"GitHub Actions \u7f13\u5b58"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-yaml",children:"- name: Build and Push\n  uses: docker/build-push-action@v5\n  with:\n    context: .\n    push: true\n    tags: myapp:latest\n    cache-from: type=gha\n    cache-to: type=gha,mode=max\n"})}),"\n",(0,a.jsx)(e.h3,{id:"registry-\u7f13\u5b58",children:"Registry \u7f13\u5b58"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-yaml",children:"- name: Build and Push\n  uses: docker/build-push-action@v5\n  with:\n    context: .\n    push: true\n    tags: myapp:latest\n    cache-from: type=registry,ref=myapp:buildcache\n    cache-to: type=registry,ref=myapp:buildcache,mode=max\n"})}),"\n",(0,a.jsx)(e.h3,{id:"\u672c\u5730\u7f13\u5b58",children:"\u672c\u5730\u7f13\u5b58"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-yaml",children:"- name: Cache Docker layers\n  uses: actions/cache@v3\n  with:\n    path: /tmp/.buildx-cache\n    key: ${{ runner.os }}-buildx-${{ github.sha }}\n    restore-keys: |\n      ${{ runner.os }}-buildx-\n\n- name: Build\n  uses: docker/build-push-action@v5\n  with:\n    cache-from: type=local,src=/tmp/.buildx-cache\n    cache-to: type=local,dest=/tmp/.buildx-cache-new,mode=max\n\n- name: Move cache\n  run: |\n    rm -rf /tmp/.buildx-cache\n    mv /tmp/.buildx-cache-new /tmp/.buildx-cache\n"})}),"\n",(0,a.jsx)(e.h2,{id:"\u90e8\u7f72\u7b56\u7565",children:"\u90e8\u7f72\u7b56\u7565"}),"\n",(0,a.jsx)(e.h3,{id:"\u6eda\u52a8\u66f4\u65b0",children:"\u6eda\u52a8\u66f4\u65b0"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-yaml",children:"deploy:\n  runs-on: ubuntu-latest\n  steps:\n    - name: Deploy to server\n      uses: appleboy/ssh-action@master\n      with:\n        host: ${{ secrets.SERVER_HOST }}\n        username: ${{ secrets.SERVER_USER }}\n        key: ${{ secrets.SSH_KEY }}\n        script: |\n          docker pull myapp:${{ github.sha }}\n          docker service update --image myapp:${{ github.sha }} myapp\n"})}),"\n",(0,a.jsx)(e.h3,{id:"docker-compose-\u90e8\u7f72",children:"Docker Compose \u90e8\u7f72"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-yaml",children:'deploy:\n  runs-on: ubuntu-latest\n  steps:\n    - uses: actions/checkout@v4\n\n    - name: Copy files to server\n      uses: appleboy/scp-action@master\n      with:\n        host: ${{ secrets.SERVER_HOST }}\n        username: ${{ secrets.SERVER_USER }}\n        key: ${{ secrets.SSH_KEY }}\n        source: "docker-compose.yml"\n        target: "/app"\n\n    - name: Deploy\n      uses: appleboy/ssh-action@master\n      with:\n        host: ${{ secrets.SERVER_HOST }}\n        username: ${{ secrets.SERVER_USER }}\n        key: ${{ secrets.SSH_KEY }}\n        script: |\n          cd /app\n          docker compose pull\n          docker compose up -d\n'})}),"\n",(0,a.jsx)(e.h2,{id:"\u5b8c\u6574\u793a\u4f8b",children:"\u5b8c\u6574\u793a\u4f8b"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-yaml",children:"# .github/workflows/ci-cd.yml\nname: CI/CD Pipeline\n\non:\n  push:\n    branches: [main, develop]\n    tags: [\"v*\"]\n  pull_request:\n    branches: [main]\n\nenv:\n  REGISTRY: ghcr.io\n  IMAGE_NAME: ${{ github.repository }}\n\njobs:\n  test:\n    runs-on: ubuntu-latest\n    steps:\n      - uses: actions/checkout@v4\n      - name: Run tests\n        run: |\n          docker compose -f docker-compose.test.yml up --build --abort-on-container-exit\n          docker compose -f docker-compose.test.yml down\n\n  build:\n    needs: test\n    runs-on: ubuntu-latest\n    permissions:\n      contents: read\n      packages: write\n    outputs:\n      tags: ${{ steps.meta.outputs.tags }}\n    steps:\n      - uses: actions/checkout@v4\n\n      - name: Set up Docker Buildx\n        uses: docker/setup-buildx-action@v3\n\n      - name: Login to GHCR\n        uses: docker/login-action@v3\n        with:\n          registry: ${{ env.REGISTRY }}\n          username: ${{ github.actor }}\n          password: ${{ secrets.GITHUB_TOKEN }}\n\n      - name: Extract metadata\n        id: meta\n        uses: docker/metadata-action@v5\n        with:\n          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}\n\n      - name: Build and Push\n        uses: docker/build-push-action@v5\n        with:\n          context: .\n          push: ${{ github.event_name != 'pull_request' }}\n          tags: ${{ steps.meta.outputs.tags }}\n          labels: ${{ steps.meta.outputs.labels }}\n          cache-from: type=gha\n          cache-to: type=gha,mode=max\n\n  deploy-staging:\n    needs: build\n    if: github.ref == 'refs/heads/develop'\n    runs-on: ubuntu-latest\n    environment: staging\n    steps:\n      - name: Deploy to staging\n        run: echo \"Deploy to staging...\"\n\n  deploy-production:\n    needs: build\n    if: startsWith(github.ref, 'refs/tags/v')\n    runs-on: ubuntu-latest\n    environment: production\n    steps:\n      - name: Deploy to production\n        run: echo \"Deploy to production...\"\n"})})]})}function d(n={}){const{wrapper:e}={...(0,i.R)(),...n.components};return e?(0,a.jsx)(e,{...n,children:(0,a.jsx)(l,{...n})}):l(n)}},48885:(n,e,s)=>{s.d(e,{R:()=>c,x:()=>o});var t=s(99378);const a={},i=t.createContext(a);function c(n){const e=t.useContext(i);return t.useMemo(function(){return"function"==typeof n?n(e):{...e,...n}},[e,n])}function o(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(a):n.components||a:c(n.components),t.createElement(i.Provider,{value:e},n.children)}}}]);