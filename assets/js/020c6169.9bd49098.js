"use strict";(globalThis.webpackChunkto_lib_github_io=globalThis.webpackChunkto_lib_github_io||[]).push([[2538],{37430:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>c,contentTitle:()=>l,default:()=>h,frontMatter:()=>i,metadata:()=>r,toc:()=>a});const r=JSON.parse('{"id":"rocketmq/producer","title":"\u751f\u4ea7\u8005\u8be6\u89e3","description":"\u6df1\u5165\u5b66\u4e60 RocketMQ \u751f\u4ea7\u8005 API","source":"@site/docs/rocketmq/producer.md","sourceDirName":"rocketmq","slug":"/rocketmq/producer","permalink":"/docs/rocketmq/producer","draft":false,"unlisted":false,"editUrl":"https://github.com/to-lib/to-lib.github.io/tree/main/docs/rocketmq/producer.md","tags":[],"version":"current","sidebarPosition":5,"frontMatter":{"sidebar_position":5,"title":"\u751f\u4ea7\u8005\u8be6\u89e3","description":"\u6df1\u5165\u5b66\u4e60 RocketMQ \u751f\u4ea7\u8005 API"},"sidebar":"rocketmq","previous":{"title":"\u6d88\u606f\u7c7b\u578b","permalink":"/docs/rocketmq/message-types"},"next":{"title":"\u6d88\u8d39\u8005\u8be6\u89e3","permalink":"/docs/rocketmq/consumer"}}');var t=s(22714),d=s(48885);const i={sidebar_position:5,title:"\u751f\u4ea7\u8005\u8be6\u89e3",description:"\u6df1\u5165\u5b66\u4e60 RocketMQ \u751f\u4ea7\u8005 API"},l="RocketMQ \u751f\u4ea7\u8005\u8be6\u89e3",c={},a=[{value:"\u751f\u4ea7\u8005\u6982\u8ff0",id:"\u751f\u4ea7\u8005\u6982\u8ff0",level:2},{value:"\u751f\u4ea7\u8005\u7c7b\u578b",id:"\u751f\u4ea7\u8005\u7c7b\u578b",level:2},{value:"\u57fa\u672c\u914d\u7f6e",id:"\u57fa\u672c\u914d\u7f6e",level:2},{value:"\u53d1\u9001\u6d88\u606f\u7684\u65b9\u5f0f",id:"\u53d1\u9001\u6d88\u606f\u7684\u65b9\u5f0f",level:2},{value:"1. \u540c\u6b65\u53d1\u9001",id:"1-\u540c\u6b65\u53d1\u9001",level:3},{value:"2. \u5f02\u6b65\u53d1\u9001",id:"2-\u5f02\u6b65\u53d1\u9001",level:3},{value:"3. \u5355\u5411\u53d1\u9001",id:"3-\u5355\u5411\u53d1\u9001",level:3},{value:"\u53d1\u9001\u65b9\u5f0f\u5bf9\u6bd4",id:"\u53d1\u9001\u65b9\u5f0f\u5bf9\u6bd4",level:3},{value:"\u6d88\u606f\u5c5e\u6027",id:"\u6d88\u606f\u5c5e\u6027",level:2},{value:"\u8bbe\u7f6e\u6d88\u606f\u5c5e\u6027",id:"\u8bbe\u7f6e\u6d88\u606f\u5c5e\u6027",level:3},{value:"\u5ef6\u8fdf\u7ea7\u522b\u5bf9\u7167\u8868",id:"\u5ef6\u8fdf\u7ea7\u522b\u5bf9\u7167\u8868",level:3},{value:"\u6279\u91cf\u53d1\u9001",id:"\u6279\u91cf\u53d1\u9001",level:2},{value:"\u6d88\u606f\u5206\u5272\u5668",id:"\u6d88\u606f\u5206\u5272\u5668",level:3},{value:"\u987a\u5e8f\u6d88\u606f",id:"\u987a\u5e8f\u6d88\u606f",level:2},{value:"\u4e8b\u52a1\u6d88\u606f",id:"\u4e8b\u52a1\u6d88\u606f",level:2},{value:"\u4e8b\u52a1\u6d88\u606f\u6d41\u7a0b",id:"\u4e8b\u52a1\u6d88\u606f\u6d41\u7a0b",level:3},{value:"\u5ef6\u8fdf\u6d88\u606f",id:"\u5ef6\u8fdf\u6d88\u606f",level:2},{value:"\u6d88\u606f\u8fc7\u6ee4",id:"\u6d88\u606f\u8fc7\u6ee4",level:2},{value:"Tag \u8fc7\u6ee4",id:"tag-\u8fc7\u6ee4",level:3},{value:"SQL92 \u8fc7\u6ee4",id:"sql92-\u8fc7\u6ee4",level:3},{value:"\u91cd\u8bd5\u673a\u5236",id:"\u91cd\u8bd5\u673a\u5236",level:2},{value:"\u914d\u7f6e\u91cd\u8bd5",id:"\u914d\u7f6e\u91cd\u8bd5",level:3},{value:"\u624b\u52a8\u91cd\u8bd5",id:"\u624b\u52a8\u91cd\u8bd5",level:3},{value:"\u6700\u4f73\u5b9e\u8df5",id:"\u6700\u4f73\u5b9e\u8df5",level:2},{value:"1. \u5408\u7406\u8bbe\u7f6e\u8d85\u65f6\u65f6\u95f4",id:"1-\u5408\u7406\u8bbe\u7f6e\u8d85\u65f6\u65f6\u95f4",level:3},{value:"2. \u4f7f\u7528\u5f02\u6b65\u53d1\u9001\u63d0\u9ad8\u6027\u80fd",id:"2-\u4f7f\u7528\u5f02\u6b65\u53d1\u9001\u63d0\u9ad8\u6027\u80fd",level:3},{value:"3. \u6b63\u786e\u5173\u95ed\u751f\u4ea7\u8005",id:"3-\u6b63\u786e\u5173\u95ed\u751f\u4ea7\u8005",level:3},{value:"4. \u6d88\u606f Key \u8bbe\u8ba1",id:"4-\u6d88\u606f-key-\u8bbe\u8ba1",level:3},{value:"\u4e0b\u4e00\u6b65",id:"\u4e0b\u4e00\u6b65",level:2},{value:"\u53c2\u8003\u8d44\u6599",id:"\u53c2\u8003\u8d44\u6599",level:2}];function o(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",mermaid:"mermaid",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,d.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.header,{children:(0,t.jsx)(n.h1,{id:"rocketmq-\u751f\u4ea7\u8005\u8be6\u89e3",children:"RocketMQ \u751f\u4ea7\u8005\u8be6\u89e3"})}),"\n",(0,t.jsx)(n.h2,{id:"\u751f\u4ea7\u8005\u6982\u8ff0",children:"\u751f\u4ea7\u8005\u6982\u8ff0"}),"\n",(0,t.jsx)(n.p,{children:"RocketMQ Producer \u8d1f\u8d23\u5c06\u6d88\u606f\u53d1\u5e03\u5230 Broker\u3002\u751f\u4ea7\u8005\u53ef\u4ee5\u53d1\u9001\u591a\u79cd\u7c7b\u578b\u7684\u6d88\u606f\uff0c\u652f\u6301\u540c\u6b65\u3001\u5f02\u6b65\u548c\u5355\u5411\u53d1\u9001\u6a21\u5f0f\u3002"}),"\n",(0,t.jsx)(n.h2,{id:"\u751f\u4ea7\u8005\u7c7b\u578b",children:"\u751f\u4ea7\u8005\u7c7b\u578b"}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"\u7c7b\u578b"}),(0,t.jsx)(n.th,{children:"\u7c7b\u540d"}),(0,t.jsx)(n.th,{children:"\u7279\u70b9"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"\u666e\u901a\u751f\u4ea7\u8005"}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"DefaultMQProducer"})}),(0,t.jsx)(n.td,{children:"\u6700\u5e38\u7528\uff0c\u652f\u6301\u591a\u79cd\u53d1\u9001\u65b9\u5f0f"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"\u4e8b\u52a1\u751f\u4ea7\u8005"}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"TransactionMQProducer"})}),(0,t.jsx)(n.td,{children:"\u652f\u6301\u4e8b\u52a1\u6d88\u606f"})]})]})]}),"\n",(0,t.jsx)(n.h2,{id:"\u57fa\u672c\u914d\u7f6e",children:"\u57fa\u672c\u914d\u7f6e"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:'DefaultMQProducer producer = new DefaultMQProducer("ProducerGroup");\n\n// \u5fc5\u9700\u914d\u7f6e\nproducer.setNamesrvAddr("localhost:9876");\n\n// \u53ef\u9009\u914d\u7f6e\nproducer.setSendMsgTimeout(3000);           // \u53d1\u9001\u8d85\u65f6\u65f6\u95f4\nproducer.setRetryTimesWhenSendFailed(2);    // \u540c\u6b65\u53d1\u9001\u5931\u8d25\u91cd\u8bd5\u6b21\u6570\nproducer.setRetryTimesWhenSendAsyncFailed(2); // \u5f02\u6b65\u53d1\u9001\u5931\u8d25\u91cd\u8bd5\u6b21\u6570\nproducer.setMaxMessageSize(4 * 1024 * 1024); // \u6700\u5927\u6d88\u606f\u5927\u5c0f 4MB\nproducer.setCompressMsgBodyOverHowmuch(4096); // \u538b\u7f29\u9608\u503c\n\nproducer.start();\n'})}),"\n",(0,t.jsx)(n.h2,{id:"\u53d1\u9001\u6d88\u606f\u7684\u65b9\u5f0f",children:"\u53d1\u9001\u6d88\u606f\u7684\u65b9\u5f0f"}),"\n",(0,t.jsx)(n.h3,{id:"1-\u540c\u6b65\u53d1\u9001",children:"1. \u540c\u6b65\u53d1\u9001"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:'public SendResult syncSend() throws Exception {\n    Message msg = new Message("TopicTest", "TagA", "Hello RocketMQ".getBytes());\n\n    // \u540c\u6b65\u53d1\u9001\uff0c\u7b49\u5f85 Broker \u54cd\u5e94\n    SendResult result = producer.send(msg);\n\n    System.out.printf("\u53d1\u9001\u7ed3\u679c: %s, msgId: %s%n",\n        result.getSendStatus(), result.getMsgId());\n\n    return result;\n}\n'})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"\u53d1\u9001\u72b6\u6001\u8bf4\u660e\uff1a"})}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"\u72b6\u6001"}),(0,t.jsx)(n.th,{children:"\u8bf4\u660e"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"SEND_OK"})}),(0,t.jsx)(n.td,{children:"\u53d1\u9001\u6210\u529f"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"FLUSH_DISK_TIMEOUT"})}),(0,t.jsx)(n.td,{children:"\u5237\u76d8\u8d85\u65f6\uff08\u540c\u6b65\u5237\u76d8\u65f6\uff09"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"FLUSH_SLAVE_TIMEOUT"})}),(0,t.jsx)(n.td,{children:"\u540c\u6b65\u5230 Slave \u8d85\u65f6"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"SLAVE_NOT_AVAILABLE"})}),(0,t.jsx)(n.td,{children:"Slave \u4e0d\u53ef\u7528"})]})]})]}),"\n",(0,t.jsx)(n.h3,{id:"2-\u5f02\u6b65\u53d1\u9001",children:"2. \u5f02\u6b65\u53d1\u9001"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:'public void asyncSend() throws Exception {\n    Message msg = new Message("TopicTest", "TagA", "Hello RocketMQ".getBytes());\n\n    producer.send(msg, new SendCallback() {\n        @Override\n        public void onSuccess(SendResult result) {\n            System.out.printf("\u53d1\u9001\u6210\u529f: %s%n", result.getMsgId());\n        }\n\n        @Override\n        public void onException(Throwable e) {\n            System.err.println("\u53d1\u9001\u5931\u8d25: " + e.getMessage());\n        }\n    });\n}\n'})}),"\n",(0,t.jsx)(n.h3,{id:"3-\u5355\u5411\u53d1\u9001",children:"3. \u5355\u5411\u53d1\u9001"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:'public void onewaySend() throws Exception {\n    Message msg = new Message("TopicTest", "TagA", "Hello RocketMQ".getBytes());\n\n    // \u4e0d\u7b49\u5f85\u54cd\u5e94\uff0c\u6700\u9ad8\u6027\u80fd\n    producer.sendOneway(msg);\n}\n'})}),"\n",(0,t.jsx)(n.h3,{id:"\u53d1\u9001\u65b9\u5f0f\u5bf9\u6bd4",children:"\u53d1\u9001\u65b9\u5f0f\u5bf9\u6bd4"}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"\u65b9\u5f0f"}),(0,t.jsx)(n.th,{children:"\u53ef\u9760\u6027"}),(0,t.jsx)(n.th,{children:"\u6027\u80fd"}),(0,t.jsx)(n.th,{children:"\u4f7f\u7528\u573a\u666f"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"\u540c\u6b65\u53d1\u9001"}),(0,t.jsx)(n.td,{children:"\u9ad8"}),(0,t.jsx)(n.td,{children:"\u4f4e"}),(0,t.jsx)(n.td,{children:"\u91cd\u8981\u6d88\u606f\u3001\u9700\u8981\u786e\u8ba4"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"\u5f02\u6b65\u53d1\u9001"}),(0,t.jsx)(n.td,{children:"\u9ad8"}),(0,t.jsx)(n.td,{children:"\u4e2d"}),(0,t.jsx)(n.td,{children:"\u5bf9\u54cd\u5e94\u65f6\u95f4\u654f\u611f"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"\u5355\u5411\u53d1\u9001"}),(0,t.jsx)(n.td,{children:"\u4f4e"}),(0,t.jsx)(n.td,{children:"\u9ad8"}),(0,t.jsx)(n.td,{children:"\u65e5\u5fd7\u6536\u96c6\u3001\u4e0d\u5173\u5fc3\u7ed3\u679c"})]})]})]}),"\n",(0,t.jsx)(n.h2,{id:"\u6d88\u606f\u5c5e\u6027",children:"\u6d88\u606f\u5c5e\u6027"}),"\n",(0,t.jsx)(n.h3,{id:"\u8bbe\u7f6e\u6d88\u606f\u5c5e\u6027",children:"\u8bbe\u7f6e\u6d88\u606f\u5c5e\u6027"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:'Message msg = new Message("TopicTest", "TagA", "Hello".getBytes());\n\n// \u8bbe\u7f6e Key\uff08\u7528\u4e8e\u6d88\u606f\u67e5\u8be2\uff09\nmsg.setKeys("ORDER_12345");\n\n// \u8bbe\u7f6e\u5ef6\u8fdf\u7ea7\u522b\nmsg.setDelayTimeLevel(3);  // \u5ef6\u8fdf 10 \u79d2\n\n// \u8bbe\u7f6e\u81ea\u5b9a\u4e49\u5c5e\u6027\nmsg.putUserProperty("orderId", "12345");\nmsg.putUserProperty("userId", "user001");\n'})}),"\n",(0,t.jsx)(n.h3,{id:"\u5ef6\u8fdf\u7ea7\u522b\u5bf9\u7167\u8868",children:"\u5ef6\u8fdf\u7ea7\u522b\u5bf9\u7167\u8868"}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"\u7ea7\u522b"}),(0,t.jsx)(n.th,{children:"\u5ef6\u8fdf\u65f6\u95f4"}),(0,t.jsx)(n.th,{children:"\u7ea7\u522b"}),(0,t.jsx)(n.th,{children:"\u5ef6\u8fdf\u65f6\u95f4"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"1"}),(0,t.jsx)(n.td,{children:"1s"}),(0,t.jsx)(n.td,{children:"10"}),(0,t.jsx)(n.td,{children:"6min"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"2"}),(0,t.jsx)(n.td,{children:"5s"}),(0,t.jsx)(n.td,{children:"11"}),(0,t.jsx)(n.td,{children:"7min"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"3"}),(0,t.jsx)(n.td,{children:"10s"}),(0,t.jsx)(n.td,{children:"12"}),(0,t.jsx)(n.td,{children:"8min"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"4"}),(0,t.jsx)(n.td,{children:"30s"}),(0,t.jsx)(n.td,{children:"13"}),(0,t.jsx)(n.td,{children:"9min"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"5"}),(0,t.jsx)(n.td,{children:"1min"}),(0,t.jsx)(n.td,{children:"14"}),(0,t.jsx)(n.td,{children:"10min"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"6"}),(0,t.jsx)(n.td,{children:"2min"}),(0,t.jsx)(n.td,{children:"15"}),(0,t.jsx)(n.td,{children:"20min"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"7"}),(0,t.jsx)(n.td,{children:"3min"}),(0,t.jsx)(n.td,{children:"16"}),(0,t.jsx)(n.td,{children:"30min"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"8"}),(0,t.jsx)(n.td,{children:"4min"}),(0,t.jsx)(n.td,{children:"17"}),(0,t.jsx)(n.td,{children:"1h"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"9"}),(0,t.jsx)(n.td,{children:"5min"}),(0,t.jsx)(n.td,{children:"18"}),(0,t.jsx)(n.td,{children:"2h"})]})]})]}),"\n",(0,t.jsx)(n.h2,{id:"\u6279\u91cf\u53d1\u9001",children:"\u6279\u91cf\u53d1\u9001"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:'public void batchSend() throws Exception {\n    List<Message> messages = new ArrayList<>();\n\n    for (int i = 0; i < 100; i++) {\n        messages.add(new Message("TopicTest", "TagA",\n            ("Message " + i).getBytes()));\n    }\n\n    // \u6279\u91cf\u53d1\u9001\uff08\u6ce8\u610f\uff1a\u6d88\u606f\u603b\u5927\u5c0f\u4e0d\u80fd\u8d85\u8fc7 4MB\uff09\n    SendResult result = producer.send(messages);\n    System.out.println("\u6279\u91cf\u53d1\u9001\u7ed3\u679c: " + result.getSendStatus());\n}\n'})}),"\n",(0,t.jsx)(n.h3,{id:"\u6d88\u606f\u5206\u5272\u5668",children:"\u6d88\u606f\u5206\u5272\u5668"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:"public class ListSplitter implements Iterator<List<Message>> {\n    private final int SIZE_LIMIT = 1024 * 1024 * 4; // 4MB\n    private final List<Message> messages;\n    private int currIndex;\n\n    public ListSplitter(List<Message> messages) {\n        this.messages = messages;\n    }\n\n    @Override\n    public boolean hasNext() {\n        return currIndex < messages.size();\n    }\n\n    @Override\n    public List<Message> next() {\n        int nextIndex = currIndex;\n        int totalSize = 0;\n\n        for (; nextIndex < messages.size(); nextIndex++) {\n            Message msg = messages.get(nextIndex);\n            int msgSize = msg.getBody().length + msg.getTopic().length();\n\n            if (totalSize + msgSize > SIZE_LIMIT) {\n                break;\n            }\n            totalSize += msgSize;\n        }\n\n        List<Message> subList = messages.subList(currIndex, nextIndex);\n        currIndex = nextIndex;\n        return subList;\n    }\n}\n\n// \u4f7f\u7528\u5206\u5272\u5668\nListSplitter splitter = new ListSplitter(messages);\nwhile (splitter.hasNext()) {\n    List<Message> batch = splitter.next();\n    producer.send(batch);\n}\n"})}),"\n",(0,t.jsx)(n.h2,{id:"\u987a\u5e8f\u6d88\u606f",children:"\u987a\u5e8f\u6d88\u606f"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:'public void sendOrderly() throws Exception {\n    String[] tags = {"create", "pay", "ship", "receive"};\n\n    for (int orderId = 0; orderId < 10; orderId++) {\n        for (String tag : tags) {\n            Message msg = new Message("OrderTopic", tag,\n                String.format("Order %d: %s", orderId, tag).getBytes());\n\n            // \u6839\u636e orderId \u9009\u62e9 Queue\uff0c\u4fdd\u8bc1\u540c\u4e00\u8ba2\u5355\u7684\u6d88\u606f\u53d1\u5230\u540c\u4e00\u4e2a Queue\n            SendResult result = producer.send(msg, (mqs, message, arg) -> {\n                int id = (int) arg;\n                int index = id % mqs.size();\n                return mqs.get(index);\n            }, orderId);\n\n            System.out.printf("Order %d, %s: %s%n",\n                orderId, tag, result.getSendStatus());\n        }\n    }\n}\n'})}),"\n",(0,t.jsx)(n.h2,{id:"\u4e8b\u52a1\u6d88\u606f",children:"\u4e8b\u52a1\u6d88\u606f"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:'public class TransactionProducerDemo {\n    public static void main(String[] args) throws Exception {\n        TransactionMQProducer producer = new TransactionMQProducer("TransactionGroup");\n        producer.setNamesrvAddr("localhost:9876");\n\n        // \u8bbe\u7f6e\u4e8b\u52a1\u76d1\u542c\u5668\n        producer.setTransactionListener(new TransactionListener() {\n            @Override\n            public LocalTransactionState executeLocalTransaction(Message msg, Object arg) {\n                // \u6267\u884c\u672c\u5730\u4e8b\u52a1\n                try {\n                    // \u6a21\u62df\u4e1a\u52a1\u64cd\u4f5c\n                    String orderId = msg.getUserProperty("orderId");\n                    System.out.println("\u6267\u884c\u672c\u5730\u4e8b\u52a1: " + orderId);\n\n                    // \u4e1a\u52a1\u6210\u529f\n                    return LocalTransactionState.COMMIT_MESSAGE;\n                } catch (Exception e) {\n                    // \u4e1a\u52a1\u5931\u8d25\n                    return LocalTransactionState.ROLLBACK_MESSAGE;\n                }\n            }\n\n            @Override\n            public LocalTransactionState checkLocalTransaction(MessageExt msg) {\n                // \u56de\u67e5\u672c\u5730\u4e8b\u52a1\u72b6\u6001\n                String orderId = msg.getUserProperty("orderId");\n                System.out.println("\u56de\u67e5\u4e8b\u52a1\u72b6\u6001: " + orderId);\n\n                // \u67e5\u8be2\u6570\u636e\u5e93\u5224\u65ad\u4e8b\u52a1\u662f\u5426\u6210\u529f\n                boolean success = checkOrderStatus(orderId);\n\n                if (success) {\n                    return LocalTransactionState.COMMIT_MESSAGE;\n                } else {\n                    return LocalTransactionState.ROLLBACK_MESSAGE;\n                }\n            }\n\n            private boolean checkOrderStatus(String orderId) {\n                // \u5b9e\u9645\u5e94\u67e5\u8be2\u6570\u636e\u5e93\n                return true;\n            }\n        });\n\n        producer.start();\n\n        // \u53d1\u9001\u4e8b\u52a1\u6d88\u606f\n        Message msg = new Message("TransactionTopic", "TagA", "Transaction Message".getBytes());\n        msg.putUserProperty("orderId", "ORDER_001");\n\n        TransactionSendResult result = producer.sendMessageInTransaction(msg, null);\n        System.out.println("\u4e8b\u52a1\u6d88\u606f\u53d1\u9001\u7ed3\u679c: " + result.getSendStatus());\n    }\n}\n'})}),"\n",(0,t.jsx)(n.h3,{id:"\u4e8b\u52a1\u6d88\u606f\u6d41\u7a0b",children:"\u4e8b\u52a1\u6d88\u606f\u6d41\u7a0b"}),"\n",(0,t.jsx)(n.mermaid,{value:"sequenceDiagram\n    participant P as Producer\n    participant B as Broker\n    participant L as \u672c\u5730\u4e8b\u52a1\n\n    P->>B: 1. \u53d1\u9001\u534a\u6d88\u606f(Half Message)\n    B--\x3e>P: 2. \u8fd4\u56de\u53d1\u9001\u7ed3\u679c\n    P->>L: 3. \u6267\u884c\u672c\u5730\u4e8b\u52a1\n    L--\x3e>P: 4. \u8fd4\u56de\u4e8b\u52a1\u72b6\u6001\n    P->>B: 5. \u63d0\u4ea4/\u56de\u6eda\u6d88\u606f\n\n    Note over B,P: \u5982\u679c\u7b2c5\u6b65\u672a\u6267\u884c\n    B->>P: 6. \u56de\u67e5\u4e8b\u52a1\u72b6\u6001\n    P->>L: 7. \u68c0\u67e5\u672c\u5730\u4e8b\u52a1\n    L--\x3e>P: 8. \u8fd4\u56de\u4e8b\u52a1\u72b6\u6001\n    P->>B: 9. \u518d\u6b21\u63d0\u4ea4/\u56de\u6eda"}),"\n",(0,t.jsx)(n.h2,{id:"\u5ef6\u8fdf\u6d88\u606f",children:"\u5ef6\u8fdf\u6d88\u606f"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:'public void sendDelayMessage() throws Exception {\n    Message msg = new Message("TopicTest", "TagA", "Delay Message".getBytes());\n\n    // \u8bbe\u7f6e\u5ef6\u8fdf\u7ea7\u522b 3 = 10 \u79d2\n    msg.setDelayTimeLevel(3);\n\n    SendResult result = producer.send(msg);\n    System.out.println("\u5ef6\u8fdf\u6d88\u606f\u53d1\u9001\u6210\u529f: " + result.getMsgId());\n}\n'})}),"\n",(0,t.jsx)(n.h2,{id:"\u6d88\u606f\u8fc7\u6ee4",children:"\u6d88\u606f\u8fc7\u6ee4"}),"\n",(0,t.jsx)(n.h3,{id:"tag-\u8fc7\u6ee4",children:"Tag \u8fc7\u6ee4"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:'// \u53d1\u9001\u5e26 Tag \u7684\u6d88\u606f\nMessage msg1 = new Message("FilterTopic", "TagA", "Message A".getBytes());\nMessage msg2 = new Message("FilterTopic", "TagB", "Message B".getBytes());\nMessage msg3 = new Message("FilterTopic", "TagC", "Message C".getBytes());\n'})}),"\n",(0,t.jsx)(n.h3,{id:"sql92-\u8fc7\u6ee4",children:"SQL92 \u8fc7\u6ee4"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:'// \u53d1\u9001\u5e26\u5c5e\u6027\u7684\u6d88\u606f\nMessage msg = new Message("FilterTopic", "TagA", "SQL Filter Message".getBytes());\nmsg.putUserProperty("age", "18");\nmsg.putUserProperty("name", "zhangsan");\nmsg.putUserProperty("price", "100.5");\n\nproducer.send(msg);\n'})}),"\n",(0,t.jsx)(n.h2,{id:"\u91cd\u8bd5\u673a\u5236",children:"\u91cd\u8bd5\u673a\u5236"}),"\n",(0,t.jsx)(n.h3,{id:"\u914d\u7f6e\u91cd\u8bd5",children:"\u914d\u7f6e\u91cd\u8bd5"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:"// \u540c\u6b65\u53d1\u9001\u91cd\u8bd5\u6b21\u6570\uff08\u9ed8\u8ba4 2 \u6b21\uff09\nproducer.setRetryTimesWhenSendFailed(3);\n\n// \u5f02\u6b65\u53d1\u9001\u91cd\u8bd5\u6b21\u6570\uff08\u9ed8\u8ba4 2 \u6b21\uff09\nproducer.setRetryTimesWhenSendAsyncFailed(3);\n\n// \u53d1\u9001\u5931\u8d25\u662f\u5426\u91cd\u8bd5\u5176\u4ed6 Broker\nproducer.setRetryAnotherBrokerWhenNotStoreOK(true);\n"})}),"\n",(0,t.jsx)(n.h3,{id:"\u624b\u52a8\u91cd\u8bd5",children:"\u624b\u52a8\u91cd\u8bd5"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:'public void sendWithRetry(Message msg, int maxRetries) {\n    int retryCount = 0;\n    SendResult result = null;\n\n    while (retryCount < maxRetries) {\n        try {\n            result = producer.send(msg);\n            if (result.getSendStatus() == SendStatus.SEND_OK) {\n                System.out.println("\u53d1\u9001\u6210\u529f: " + result.getMsgId());\n                return;\n            }\n        } catch (Exception e) {\n            retryCount++;\n            System.err.printf("\u53d1\u9001\u5931\u8d25\uff0c\u91cd\u8bd5 %d/%d%n", retryCount, maxRetries);\n\n            try {\n                Thread.sleep(1000 * retryCount);\n            } catch (InterruptedException ie) {\n                Thread.currentThread().interrupt();\n            }\n        }\n    }\n\n    throw new RuntimeException("\u6d88\u606f\u53d1\u9001\u5931\u8d25\uff0c\u5df2\u91cd\u8bd5 " + maxRetries + " \u6b21");\n}\n'})}),"\n",(0,t.jsx)(n.h2,{id:"\u6700\u4f73\u5b9e\u8df5",children:"\u6700\u4f73\u5b9e\u8df5"}),"\n",(0,t.jsx)(n.h3,{id:"1-\u5408\u7406\u8bbe\u7f6e\u8d85\u65f6\u65f6\u95f4",children:"1. \u5408\u7406\u8bbe\u7f6e\u8d85\u65f6\u65f6\u95f4"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:"// \u6839\u636e\u7f51\u7edc\u60c5\u51b5\u8bbe\u7f6e\nproducer.setSendMsgTimeout(5000);\n"})}),"\n",(0,t.jsx)(n.h3,{id:"2-\u4f7f\u7528\u5f02\u6b65\u53d1\u9001\u63d0\u9ad8\u6027\u80fd",children:"2. \u4f7f\u7528\u5f02\u6b65\u53d1\u9001\u63d0\u9ad8\u6027\u80fd"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:"// \u9ad8\u541e\u5410\u91cf\u573a\u666f\nCountDownLatch latch = new CountDownLatch(messageCount);\n\nfor (int i = 0; i < messageCount; i++) {\n    producer.send(msg, new SendCallback() {\n        @Override\n        public void onSuccess(SendResult result) {\n            latch.countDown();\n        }\n\n        @Override\n        public void onException(Throwable e) {\n            latch.countDown();\n            // \u8bb0\u5f55\u5931\u8d25\u6d88\u606f\n        }\n    });\n}\n\nlatch.await();\n"})}),"\n",(0,t.jsx)(n.h3,{id:"3-\u6b63\u786e\u5173\u95ed\u751f\u4ea7\u8005",children:"3. \u6b63\u786e\u5173\u95ed\u751f\u4ea7\u8005"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:"try {\n    // \u53d1\u9001\u6d88\u606f\n} finally {\n    producer.shutdown();\n}\n"})}),"\n",(0,t.jsx)(n.h3,{id:"4-\u6d88\u606f-key-\u8bbe\u8ba1",children:"4. \u6d88\u606f Key \u8bbe\u8ba1"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:'// \u4f7f\u7528\u4e1a\u52a1\u552f\u4e00\u6807\u8bc6\u4f5c\u4e3a Key\nmsg.setKeys("ORDER_" + orderId);\n\n// \u591a\u4e2a Key \u4f7f\u7528\u7a7a\u683c\u5206\u9694\nmsg.setKeys("ORDER_001 USER_123");\n'})}),"\n",(0,t.jsx)(n.h2,{id:"\u4e0b\u4e00\u6b65",children:"\u4e0b\u4e00\u6b65"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["\ud83d\udcca ",(0,t.jsx)(n.a,{href:"/docs/rocketmq/consumer",children:"\u6d88\u8d39\u8005\u8be6\u89e3"})," - \u5b66\u4e60\u6d88\u606f\u6d88\u8d39"]}),"\n",(0,t.jsxs)(n.li,{children:["\ud83d\udd04 ",(0,t.jsx)(n.a,{href:"/docs/rocketmq/message-types",children:"\u6d88\u606f\u7c7b\u578b"})," - \u4e86\u89e3\u5404\u79cd\u6d88\u606f\u7c7b\u578b"]}),"\n",(0,t.jsxs)(n.li,{children:["\ud83d\udccb ",(0,t.jsx)(n.a,{href:"/docs/rocketmq/quick-reference",children:"\u5feb\u901f\u53c2\u8003"})," - \u5e38\u7528 API \u901f\u67e5"]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"\u53c2\u8003\u8d44\u6599",children:"\u53c2\u8003\u8d44\u6599"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://rocketmq.apache.org/docs/producer/",children:"RocketMQ Producer \u5b98\u65b9\u6587\u6863"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://rocketmq.apache.org/docs/bestPractice/",children:"RocketMQ \u6700\u4f73\u5b9e\u8df5"})}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,d.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(o,{...e})}):o(e)}},48885:(e,n,s)=>{s.d(n,{R:()=>i,x:()=>l});var r=s(99378);const t={},d=r.createContext(t);function i(e){const n=r.useContext(d);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:i(e.components),r.createElement(d.Provider,{value:n},e.children)}}}]);