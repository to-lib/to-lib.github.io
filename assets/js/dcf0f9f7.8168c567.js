"use strict";(globalThis.webpackChunkto_lib_github_io=globalThis.webpackChunkto_lib_github_io||[]).push([[1136],{1982:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>c,contentTitle:()=>l,default:()=>u,frontMatter:()=>s,metadata:()=>a,toc:()=>o});const a=JSON.parse('{"id":"rabbitmq/spring-integration","title":"Spring \u96c6\u6210","description":"RabbitMQ \u4e0e Spring/Spring Boot \u96c6\u6210\u8be6\u89e3","source":"@site/docs/rabbitmq/spring-integration.md","sourceDirName":"rabbitmq","slug":"/rabbitmq/spring-integration","permalink":"/docs/rabbitmq/spring-integration","draft":false,"unlisted":false,"editUrl":"https://github.com/to-lib/to-lib.github.io/tree/main/docs/rabbitmq/spring-integration.md","tags":[],"version":"current","sidebarPosition":12,"frontMatter":{"sidebar_position":12,"title":"Spring \u96c6\u6210","description":"RabbitMQ \u4e0e Spring/Spring Boot \u96c6\u6210\u8be6\u89e3"},"sidebar":"rabbitmq","previous":{"title":"\u5b89\u5168\u914d\u7f6e","permalink":"/docs/rabbitmq/security"},"next":{"title":"\u5feb\u901f\u53c2\u8003","permalink":"/docs/rabbitmq/quick-reference"}}');var t=r(22714),i=r(48885);const s={sidebar_position:12,title:"Spring \u96c6\u6210",description:"RabbitMQ \u4e0e Spring/Spring Boot \u96c6\u6210\u8be6\u89e3"},l="RabbitMQ Spring \u96c6\u6210",c={},o=[{value:"\u6982\u8ff0",id:"\u6982\u8ff0",level:2},{value:"\u5feb\u901f\u5f00\u59cb",id:"\u5feb\u901f\u5f00\u59cb",level:2},{value:"\u6dfb\u52a0\u4f9d\u8d56",id:"\u6dfb\u52a0\u4f9d\u8d56",level:3},{value:"\u57fa\u7840\u914d\u7f6e",id:"\u57fa\u7840\u914d\u7f6e",level:3},{value:"RabbitTemplate",id:"rabbittemplate",level:2},{value:"\u57fa\u672c\u4f7f\u7528",id:"\u57fa\u672c\u4f7f\u7528",level:3},{value:"\u53d1\u9001\u5bf9\u8c61",id:"\u53d1\u9001\u5bf9\u8c61",level:3},{value:"\u6d88\u606f\u5c5e\u6027\u8bbe\u7f6e",id:"\u6d88\u606f\u5c5e\u6027\u8bbe\u7f6e",level:3},{value:"@RabbitListener",id:"rabbitlistener",level:2},{value:"\u57fa\u672c\u6d88\u8d39",id:"\u57fa\u672c\u6d88\u8d39",level:3},{value:"\u63a5\u6536\u5bf9\u8c61",id:"\u63a5\u6536\u5bf9\u8c61",level:3},{value:"\u83b7\u53d6\u6d88\u606f\u8be6\u60c5",id:"\u83b7\u53d6\u6d88\u606f\u8be6\u60c5",level:3},{value:"\u81ea\u52a8\u58f0\u660e\u961f\u5217",id:"\u81ea\u52a8\u58f0\u660e\u961f\u5217",level:3},{value:"\u5e76\u53d1\u6d88\u8d39",id:"\u5e76\u53d1\u6d88\u8d39",level:3},{value:"\u6d88\u606f\u786e\u8ba4",id:"\u6d88\u606f\u786e\u8ba4",level:2},{value:"\u914d\u7f6e\u786e\u8ba4\u6a21\u5f0f",id:"\u914d\u7f6e\u786e\u8ba4\u6a21\u5f0f",level:3},{value:"\u624b\u52a8\u786e\u8ba4",id:"\u624b\u52a8\u786e\u8ba4",level:3},{value:"\u53d1\u5e03\u786e\u8ba4",id:"\u53d1\u5e03\u786e\u8ba4",level:3},{value:"\u914d\u7f6e\u7c7b",id:"\u914d\u7f6e\u7c7b",level:2},{value:"\u961f\u5217\u548c\u4ea4\u6362\u673a\u58f0\u660e",id:"\u961f\u5217\u548c\u4ea4\u6362\u673a\u58f0\u660e",level:3},{value:"\u6b7b\u4fe1\u961f\u5217\u914d\u7f6e",id:"\u6b7b\u4fe1\u961f\u5217\u914d\u7f6e",level:3},{value:"JSON \u5e8f\u5217\u5316\u914d\u7f6e",id:"json-\u5e8f\u5217\u5316\u914d\u7f6e",level:3},{value:"\u91cd\u8bd5\u673a\u5236",id:"\u91cd\u8bd5\u673a\u5236",level:2},{value:"\u6d88\u8d39\u8005\u91cd\u8bd5",id:"\u6d88\u8d39\u8005\u91cd\u8bd5",level:3},{value:"\u81ea\u5b9a\u4e49\u91cd\u8bd5\u7b56\u7565",id:"\u81ea\u5b9a\u4e49\u91cd\u8bd5\u7b56\u7565",level:3},{value:"\u9519\u8bef\u5904\u7406",id:"\u9519\u8bef\u5904\u7406",level:3},{value:"Spring Cloud Stream",id:"spring-cloud-stream",level:2},{value:"\u6dfb\u52a0\u4f9d\u8d56",id:"\u6dfb\u52a0\u4f9d\u8d56-1",level:3},{value:"\u51fd\u6570\u5f0f\u7f16\u7a0b\u6a21\u578b",id:"\u51fd\u6570\u5f0f\u7f16\u7a0b\u6a21\u578b",level:3},{value:"\u53d1\u9001\u6d88\u606f",id:"\u53d1\u9001\u6d88\u606f",level:3},{value:"\u9ad8\u7ea7\u914d\u7f6e",id:"\u9ad8\u7ea7\u914d\u7f6e",level:2},{value:"\u5b8c\u6574\u914d\u7f6e\u793a\u4f8b",id:"\u5b8c\u6574\u914d\u7f6e\u793a\u4f8b",level:3},{value:"\u591a RabbitMQ \u5b9e\u4f8b",id:"\u591a-rabbitmq-\u5b9e\u4f8b",level:3},{value:"\u6700\u4f73\u5b9e\u8df5",id:"\u6700\u4f73\u5b9e\u8df5",level:2},{value:"\u6d88\u606f\u8bbe\u8ba1",id:"\u6d88\u606f\u8bbe\u8ba1",level:3},{value:"\u5e42\u7b49\u6027\u5904\u7406",id:"\u5e42\u7b49\u6027\u5904\u7406",level:3},{value:"\u53c2\u8003\u8d44\u6599",id:"\u53c2\u8003\u8d44\u6599",level:2}];function d(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",ul:"ul",...(0,i.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.header,{children:(0,t.jsx)(n.h1,{id:"rabbitmq-spring-\u96c6\u6210",children:"RabbitMQ Spring \u96c6\u6210"})}),"\n",(0,t.jsx)(n.h2,{id:"\u6982\u8ff0",children:"\u6982\u8ff0"}),"\n",(0,t.jsx)(n.p,{children:"Spring AMQP \u63d0\u4f9b\u4e86\u5bf9 RabbitMQ \u7684\u5168\u9762\u652f\u6301\uff0c\u7b80\u5316\u4e86\u6d88\u606f\u53d1\u9001\u3001\u63a5\u6536\u548c\u914d\u7f6e\u3002\u672c\u6587\u8be6\u7ec6\u4ecb\u7ecd Spring Boot \u4e2d RabbitMQ \u7684\u96c6\u6210\u4f7f\u7528\u3002"}),"\n",(0,t.jsx)(n.h2,{id:"\u5feb\u901f\u5f00\u59cb",children:"\u5feb\u901f\u5f00\u59cb"}),"\n",(0,t.jsx)(n.h3,{id:"\u6dfb\u52a0\u4f9d\u8d56",children:"\u6dfb\u52a0\u4f9d\u8d56"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-xml",children:"<dependency>\n    <groupId>org.springframework.boot</groupId>\n    <artifactId>spring-boot-starter-amqp</artifactId>\n</dependency>\n"})}),"\n",(0,t.jsx)(n.h3,{id:"\u57fa\u7840\u914d\u7f6e",children:"\u57fa\u7840\u914d\u7f6e"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"# application.yml\nspring:\n  rabbitmq:\n    host: localhost\n    port: 5672\n    username: guest\n    password: guest\n    virtual-host: /\n"})}),"\n",(0,t.jsx)(n.h2,{id:"rabbittemplate",children:"RabbitTemplate"}),"\n",(0,t.jsx)(n.h3,{id:"\u57fa\u672c\u4f7f\u7528",children:"\u57fa\u672c\u4f7f\u7528"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:'@Service\npublic class MessageService {\n\n    @Autowired\n    private RabbitTemplate rabbitTemplate;\n\n    // \u53d1\u9001\u5230\u961f\u5217\n    public void sendToQueue(String message) {\n        rabbitTemplate.convertAndSend("myQueue", message);\n    }\n\n    // \u53d1\u9001\u5230\u4ea4\u6362\u673a\n    public void sendToExchange(String message) {\n        rabbitTemplate.convertAndSend("myExchange", "routingKey", message);\n    }\n\n    // \u53d1\u9001\u5e76\u63a5\u6536\u54cd\u5e94\uff08RPC\uff09\n    public String sendAndReceive(String message) {\n        return (String) rabbitTemplate.convertSendAndReceive("rpcQueue", message);\n    }\n}\n'})}),"\n",(0,t.jsx)(n.h3,{id:"\u53d1\u9001\u5bf9\u8c61",children:"\u53d1\u9001\u5bf9\u8c61"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:'@Data\n@AllArgsConstructor\npublic class Order {\n    private String orderId;\n    private String userId;\n    private BigDecimal amount;\n}\n\n@Service\npublic class OrderService {\n\n    @Autowired\n    private RabbitTemplate rabbitTemplate;\n\n    public void sendOrder(Order order) {\n        // \u81ea\u52a8\u5e8f\u5217\u5316\u4e3a JSON\n        rabbitTemplate.convertAndSend("order.exchange", "order.created", order);\n    }\n}\n'})}),"\n",(0,t.jsx)(n.h3,{id:"\u6d88\u606f\u5c5e\u6027\u8bbe\u7f6e",children:"\u6d88\u606f\u5c5e\u6027\u8bbe\u7f6e"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:'@Service\npublic class AdvancedMessageService {\n\n    @Autowired\n    private RabbitTemplate rabbitTemplate;\n\n    public void sendWithProperties(String message) {\n        rabbitTemplate.convertAndSend("exchange", "key", message, msg -> {\n            MessageProperties props = msg.getMessageProperties();\n            props.setMessageId(UUID.randomUUID().toString());\n            props.setTimestamp(new Date());\n            props.setExpiration("60000");  // 60\u79d2\u8fc7\u671f\n            props.setPriority(5);\n            props.setHeader("custom-header", "value");\n            return msg;\n        });\n    }\n\n    // \u53d1\u9001\u5ef6\u8fdf\u6d88\u606f\uff08\u9700\u8981\u5ef6\u8fdf\u63d2\u4ef6\uff09\n    public void sendDelayedMessage(String message, int delayMs) {\n        rabbitTemplate.convertAndSend("delayed.exchange", "delayed", message, msg -> {\n            msg.getMessageProperties().setDelay(delayMs);\n            return msg;\n        });\n    }\n}\n'})}),"\n",(0,t.jsx)(n.h2,{id:"rabbitlistener",children:"@RabbitListener"}),"\n",(0,t.jsx)(n.h3,{id:"\u57fa\u672c\u6d88\u8d39",children:"\u57fa\u672c\u6d88\u8d39"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:'@Component\npublic class MessageConsumer {\n\n    @RabbitListener(queues = "myQueue")\n    public void receive(String message) {\n        System.out.println("\u6536\u5230\u6d88\u606f: " + message);\n    }\n}\n'})}),"\n",(0,t.jsx)(n.h3,{id:"\u63a5\u6536\u5bf9\u8c61",children:"\u63a5\u6536\u5bf9\u8c61"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:'@Component\npublic class OrderConsumer {\n\n    @RabbitListener(queues = "orderQueue")\n    public void receiveOrder(Order order) {\n        System.out.println("\u6536\u5230\u8ba2\u5355: " + order.getOrderId());\n    }\n}\n'})}),"\n",(0,t.jsx)(n.h3,{id:"\u83b7\u53d6\u6d88\u606f\u8be6\u60c5",children:"\u83b7\u53d6\u6d88\u606f\u8be6\u60c5"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:'@Component\npublic class DetailedConsumer {\n\n    @RabbitListener(queues = "myQueue")\n    public void receive(Message message, Channel channel,\n                        @Header(AmqpHeaders.DELIVERY_TAG) long tag) {\n        try {\n            String body = new String(message.getBody());\n            String messageId = message.getMessageProperties().getMessageId();\n\n            System.out.println("\u6d88\u606fID: " + messageId);\n            System.out.println("\u6d88\u606f\u5185\u5bb9: " + body);\n\n            // \u624b\u52a8\u786e\u8ba4\n            channel.basicAck(tag, false);\n\n        } catch (Exception e) {\n            try {\n                // \u62d2\u7edd\u5e76\u91cd\u65b0\u5165\u961f\n                channel.basicNack(tag, false, true);\n            } catch (IOException ex) {\n                ex.printStackTrace();\n            }\n        }\n    }\n}\n'})}),"\n",(0,t.jsx)(n.h3,{id:"\u81ea\u52a8\u58f0\u660e\u961f\u5217",children:"\u81ea\u52a8\u58f0\u660e\u961f\u5217"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:'@Component\npublic class AutoDeclareConsumer {\n\n    @RabbitListener(bindings = @QueueBinding(\n        value = @Queue(value = "auto.queue", durable = "true"),\n        exchange = @Exchange(value = "auto.exchange", type = ExchangeTypes.DIRECT),\n        key = "auto.key"\n    ))\n    public void receive(String message) {\n        System.out.println("\u6536\u5230: " + message);\n    }\n}\n'})}),"\n",(0,t.jsx)(n.h3,{id:"\u5e76\u53d1\u6d88\u8d39",children:"\u5e76\u53d1\u6d88\u8d39"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:'@Component\npublic class ConcurrentConsumer {\n\n    // \u56fa\u5b9a\u5e76\u53d1\u6570\n    @RabbitListener(queues = "concurrentQueue", concurrency = "5")\n    public void receive(String message) {\n        System.out.println(Thread.currentThread().getName() + " \u6536\u5230: " + message);\n    }\n\n    // \u52a8\u6001\u5e76\u53d1\u6570\uff08\u6700\u5c0f3\uff0c\u6700\u592710\uff09\n    @RabbitListener(queues = "dynamicQueue", concurrency = "3-10")\n    public void receiveDynamic(String message) {\n        System.out.println("\u52a8\u6001\u6d88\u8d39: " + message);\n    }\n}\n'})}),"\n",(0,t.jsx)(n.h2,{id:"\u6d88\u606f\u786e\u8ba4",children:"\u6d88\u606f\u786e\u8ba4"}),"\n",(0,t.jsx)(n.h3,{id:"\u914d\u7f6e\u786e\u8ba4\u6a21\u5f0f",children:"\u914d\u7f6e\u786e\u8ba4\u6a21\u5f0f"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"spring:\n  rabbitmq:\n    listener:\n      simple:\n        acknowledge-mode: manual # manual, auto, none\n        prefetch: 10 # \u9884\u53d6\u6570\u91cf\n"})}),"\n",(0,t.jsx)(n.h3,{id:"\u624b\u52a8\u786e\u8ba4",children:"\u624b\u52a8\u786e\u8ba4"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:'@Component\npublic class ManualAckConsumer {\n\n    @RabbitListener(queues = "ackQueue")\n    public void receive(Message message, Channel channel,\n                        @Header(AmqpHeaders.DELIVERY_TAG) long tag) {\n        try {\n            processMessage(message);\n\n            // \u786e\u8ba4\u6210\u529f\n            channel.basicAck(tag, false);\n\n        } catch (RecoverableException e) {\n            // \u53ef\u6062\u590d\uff0c\u91cd\u65b0\u5165\u961f\n            channel.basicNack(tag, false, true);\n\n        } catch (Exception e) {\n            // \u4e0d\u53ef\u6062\u590d\uff0c\u53d1\u9001\u5230\u6b7b\u4fe1\n            channel.basicNack(tag, false, false);\n        }\n    }\n}\n'})}),"\n",(0,t.jsx)(n.h3,{id:"\u53d1\u5e03\u786e\u8ba4",children:"\u53d1\u5e03\u786e\u8ba4"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"spring:\n  rabbitmq:\n    publisher-confirm-type: correlated # none, simple, correlated\n    publisher-returns: true\n"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:'@Configuration\npublic class RabbitConfirmConfig {\n\n    @Bean\n    public RabbitTemplate rabbitTemplate(ConnectionFactory connectionFactory) {\n        RabbitTemplate template = new RabbitTemplate(connectionFactory);\n\n        // \u53d1\u5e03\u786e\u8ba4\u56de\u8c03\n        template.setConfirmCallback((correlationData, ack, cause) -> {\n            if (ack) {\n                System.out.println("\u6d88\u606f\u53d1\u9001\u6210\u529f: " + correlationData.getId());\n            } else {\n                System.out.println("\u6d88\u606f\u53d1\u9001\u5931\u8d25: " + cause);\n                // \u91cd\u8bd5\u6216\u8bb0\u5f55\n            }\n        });\n\n        // \u6d88\u606f\u8fd4\u56de\u56de\u8c03\uff08\u65e0\u6cd5\u8def\u7531\u65f6\uff09\n        template.setReturnsCallback(returned -> {\n            System.out.println("\u6d88\u606f\u88ab\u9000\u56de: " + returned.getMessage());\n            System.out.println("\u9000\u56de\u539f\u56e0: " + returned.getReplyText());\n        });\n\n        template.setMandatory(true);\n\n        return template;\n    }\n}\n'})}),"\n",(0,t.jsx)(n.h2,{id:"\u914d\u7f6e\u7c7b",children:"\u914d\u7f6e\u7c7b"}),"\n",(0,t.jsx)(n.h3,{id:"\u961f\u5217\u548c\u4ea4\u6362\u673a\u58f0\u660e",children:"\u961f\u5217\u548c\u4ea4\u6362\u673a\u58f0\u660e"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:'@Configuration\npublic class RabbitConfig {\n\n    // \u58f0\u660e\u961f\u5217\n    @Bean\n    public Queue orderQueue() {\n        return QueueBuilder.durable("order.queue")\n            .withArgument("x-message-ttl", 60000)\n            .withArgument("x-dead-letter-exchange", "dlx.exchange")\n            .withArgument("x-dead-letter-routing-key", "dlx.order")\n            .build();\n    }\n\n    // \u58f0\u660e\u4ea4\u6362\u673a\n    @Bean\n    public DirectExchange orderExchange() {\n        return ExchangeBuilder.directExchange("order.exchange")\n            .durable(true)\n            .build();\n    }\n\n    // \u7ed1\u5b9a\n    @Bean\n    public Binding orderBinding(Queue orderQueue, DirectExchange orderExchange) {\n        return BindingBuilder.bind(orderQueue)\n            .to(orderExchange)\n            .with("order.key");\n    }\n\n    // Topic \u4ea4\u6362\u673a\n    @Bean\n    public TopicExchange topicExchange() {\n        return new TopicExchange("topic.exchange");\n    }\n\n    // Fanout \u4ea4\u6362\u673a\n    @Bean\n    public FanoutExchange fanoutExchange() {\n        return new FanoutExchange("fanout.exchange");\n    }\n}\n'})}),"\n",(0,t.jsx)(n.h3,{id:"\u6b7b\u4fe1\u961f\u5217\u914d\u7f6e",children:"\u6b7b\u4fe1\u961f\u5217\u914d\u7f6e"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:'@Configuration\npublic class DeadLetterConfig {\n\n    @Bean\n    public Queue dlxQueue() {\n        return new Queue("dlx.queue", true);\n    }\n\n    @Bean\n    public DirectExchange dlxExchange() {\n        return new DirectExchange("dlx.exchange");\n    }\n\n    @Bean\n    public Binding dlxBinding() {\n        return BindingBuilder.bind(dlxQueue())\n            .to(dlxExchange())\n            .with("dlx.#");\n    }\n\n    @Bean\n    public Queue businessQueue() {\n        return QueueBuilder.durable("business.queue")\n            .withArgument("x-dead-letter-exchange", "dlx.exchange")\n            .withArgument("x-dead-letter-routing-key", "dlx.business")\n            .build();\n    }\n}\n'})}),"\n",(0,t.jsx)(n.h3,{id:"json-\u5e8f\u5217\u5316\u914d\u7f6e",children:"JSON \u5e8f\u5217\u5316\u914d\u7f6e"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:"@Configuration\npublic class MessageConverterConfig {\n\n    @Bean\n    public MessageConverter jsonMessageConverter() {\n        return new Jackson2JsonMessageConverter();\n    }\n\n    @Bean\n    public RabbitTemplate rabbitTemplate(ConnectionFactory connectionFactory,\n                                         MessageConverter jsonMessageConverter) {\n        RabbitTemplate template = new RabbitTemplate(connectionFactory);\n        template.setMessageConverter(jsonMessageConverter);\n        return template;\n    }\n}\n"})}),"\n",(0,t.jsx)(n.h2,{id:"\u91cd\u8bd5\u673a\u5236",children:"\u91cd\u8bd5\u673a\u5236"}),"\n",(0,t.jsx)(n.h3,{id:"\u6d88\u8d39\u8005\u91cd\u8bd5",children:"\u6d88\u8d39\u8005\u91cd\u8bd5"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"spring:\n  rabbitmq:\n    listener:\n      simple:\n        retry:\n          enabled: true\n          initial-interval: 1000ms\n          max-attempts: 3\n          multiplier: 2.0\n          max-interval: 10000ms\n"})}),"\n",(0,t.jsx)(n.h3,{id:"\u81ea\u5b9a\u4e49\u91cd\u8bd5\u7b56\u7565",children:"\u81ea\u5b9a\u4e49\u91cd\u8bd5\u7b56\u7565"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:"@Configuration\npublic class RetryConfig {\n\n    @Bean\n    public SimpleRabbitListenerContainerFactory rabbitListenerContainerFactory(\n            ConnectionFactory connectionFactory) {\n\n        SimpleRabbitListenerContainerFactory factory =\n            new SimpleRabbitListenerContainerFactory();\n        factory.setConnectionFactory(connectionFactory);\n\n        // \u914d\u7f6e\u91cd\u8bd5\u6a21\u677f\n        RetryTemplate retryTemplate = new RetryTemplate();\n        ExponentialBackOffPolicy backOffPolicy = new ExponentialBackOffPolicy();\n        backOffPolicy.setInitialInterval(1000);\n        backOffPolicy.setMultiplier(2.0);\n        backOffPolicy.setMaxInterval(10000);\n        retryTemplate.setBackOffPolicy(backOffPolicy);\n\n        // \u91cd\u8bd5\u6b21\u6570\n        SimpleRetryPolicy retryPolicy = new SimpleRetryPolicy();\n        retryPolicy.setMaxAttempts(3);\n        retryTemplate.setRetryPolicy(retryPolicy);\n\n        factory.setRetryTemplate(retryTemplate);\n\n        // \u91cd\u8bd5\u8017\u5c3d\u540e\u53d1\u9001\u5230\u6b7b\u4fe1\n        factory.setDefaultRequeueRejected(false);\n\n        return factory;\n    }\n}\n"})}),"\n",(0,t.jsx)(n.h3,{id:"\u9519\u8bef\u5904\u7406",children:"\u9519\u8bef\u5904\u7406"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:'@Configuration\npublic class ErrorHandlerConfig {\n\n    @Bean\n    public SimpleRabbitListenerContainerFactory rabbitListenerContainerFactory(\n            ConnectionFactory connectionFactory) {\n\n        SimpleRabbitListenerContainerFactory factory =\n            new SimpleRabbitListenerContainerFactory();\n        factory.setConnectionFactory(connectionFactory);\n\n        // \u81ea\u5b9a\u4e49\u9519\u8bef\u5904\u7406\u5668\n        factory.setErrorHandler(throwable -> {\n            log.error("\u6d88\u606f\u5904\u7406\u5931\u8d25", throwable);\n            // \u53d1\u9001\u544a\u8b66\u3001\u8bb0\u5f55\u65e5\u5fd7\u7b49\n        });\n\n        return factory;\n    }\n}\n'})}),"\n",(0,t.jsx)(n.h2,{id:"spring-cloud-stream",children:"Spring Cloud Stream"}),"\n",(0,t.jsx)(n.h3,{id:"\u6dfb\u52a0\u4f9d\u8d56-1",children:"\u6dfb\u52a0\u4f9d\u8d56"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-xml",children:"<dependency>\n    <groupId>org.springframework.cloud</groupId>\n    <artifactId>spring-cloud-starter-stream-rabbit</artifactId>\n</dependency>\n"})}),"\n",(0,t.jsx)(n.h3,{id:"\u51fd\u6570\u5f0f\u7f16\u7a0b\u6a21\u578b",children:"\u51fd\u6570\u5f0f\u7f16\u7a0b\u6a21\u578b"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"spring:\n  cloud:\n    stream:\n      bindings:\n        orderInput-in-0:\n          destination: order-topic\n          group: order-group\n        orderOutput-out-0:\n          destination: order-result\n      rabbit:\n        bindings:\n          orderInput-in-0:\n            consumer:\n              acknowledge-mode: MANUAL\n"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:'@Configuration\npublic class StreamConfig {\n\n    @Bean\n    public Consumer<Order> orderInput() {\n        return order -> {\n            System.out.println("\u6536\u5230\u8ba2\u5355: " + order.getOrderId());\n            processOrder(order);\n        };\n    }\n\n    @Bean\n    public Supplier<OrderResult> orderOutput() {\n        return () -> new OrderResult("order-123", "SUCCESS");\n    }\n\n    @Bean\n    public Function<Order, OrderResult> orderProcessor() {\n        return order -> {\n            // \u5904\u7406\u8ba2\u5355\u5e76\u8fd4\u56de\u7ed3\u679c\n            return new OrderResult(order.getOrderId(), "PROCESSED");\n        };\n    }\n}\n'})}),"\n",(0,t.jsx)(n.h3,{id:"\u53d1\u9001\u6d88\u606f",children:"\u53d1\u9001\u6d88\u606f"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:'@Service\npublic class StreamMessageService {\n\n    @Autowired\n    private StreamBridge streamBridge;\n\n    public void sendOrder(Order order) {\n        streamBridge.send("orderOutput-out-0", order);\n    }\n}\n'})}),"\n",(0,t.jsx)(n.h2,{id:"\u9ad8\u7ea7\u914d\u7f6e",children:"\u9ad8\u7ea7\u914d\u7f6e"}),"\n",(0,t.jsx)(n.h3,{id:"\u5b8c\u6574\u914d\u7f6e\u793a\u4f8b",children:"\u5b8c\u6574\u914d\u7f6e\u793a\u4f8b"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"spring:\n  rabbitmq:\n    host: ${RABBITMQ_HOST:localhost}\n    port: ${RABBITMQ_PORT:5672}\n    username: ${RABBITMQ_USERNAME:guest}\n    password: ${RABBITMQ_PASSWORD:guest}\n    virtual-host: /\n\n    # \u8fde\u63a5\u914d\u7f6e\n    connection-timeout: 30000\n    requested-heartbeat: 60\n\n    # \u53d1\u5e03\u786e\u8ba4\n    publisher-confirm-type: correlated\n    publisher-returns: true\n\n    # \u6d88\u8d39\u8005\u914d\u7f6e\n    listener:\n      simple:\n        acknowledge-mode: manual\n        prefetch: 10\n        concurrency: 5\n        max-concurrency: 20\n        default-requeue-rejected: false\n        retry:\n          enabled: true\n          initial-interval: 1000\n          max-attempts: 3\n          multiplier: 2\n          max-interval: 10000\n\n    # \u7f13\u5b58\u914d\u7f6e\n    cache:\n      channel:\n        size: 25\n        checkout-timeout: 1000\n      connection:\n        size: 1\n        mode: CHANNEL\n\n    # SSL \u914d\u7f6e\n    ssl:\n      enabled: false\n      # key-store: classpath:client.p12\n      # key-store-password: password\n"})}),"\n",(0,t.jsx)(n.h3,{id:"\u591a-rabbitmq-\u5b9e\u4f8b",children:"\u591a RabbitMQ \u5b9e\u4f8b"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:'@Configuration\npublic class MultiRabbitConfig {\n\n    @Primary\n    @Bean\n    public ConnectionFactory primaryConnectionFactory() {\n        CachingConnectionFactory factory = new CachingConnectionFactory();\n        factory.setHost("primary-rabbit");\n        factory.setPort(5672);\n        factory.setUsername("guest");\n        factory.setPassword("guest");\n        return factory;\n    }\n\n    @Bean\n    public ConnectionFactory secondaryConnectionFactory() {\n        CachingConnectionFactory factory = new CachingConnectionFactory();\n        factory.setHost("secondary-rabbit");\n        factory.setPort(5672);\n        factory.setUsername("guest");\n        factory.setPassword("guest");\n        return factory;\n    }\n\n    @Primary\n    @Bean\n    public RabbitTemplate primaryRabbitTemplate(\n            @Qualifier("primaryConnectionFactory") ConnectionFactory cf) {\n        return new RabbitTemplate(cf);\n    }\n\n    @Bean\n    public RabbitTemplate secondaryRabbitTemplate(\n            @Qualifier("secondaryConnectionFactory") ConnectionFactory cf) {\n        return new RabbitTemplate(cf);\n    }\n}\n'})}),"\n",(0,t.jsx)(n.h2,{id:"\u6700\u4f73\u5b9e\u8df5",children:"\u6700\u4f73\u5b9e\u8df5"}),"\n",(0,t.jsx)(n.h3,{id:"\u6d88\u606f\u8bbe\u8ba1",children:"\u6d88\u606f\u8bbe\u8ba1"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:'@Data\npublic class MessageWrapper<T> {\n    private String messageId;\n    private String messageType;\n    private LocalDateTime timestamp;\n    private String version;\n    private T payload;\n    private Map<String, String> metadata;\n\n    public static <T> MessageWrapper<T> of(String type, T payload) {\n        MessageWrapper<T> wrapper = new MessageWrapper<>();\n        wrapper.setMessageId(UUID.randomUUID().toString());\n        wrapper.setMessageType(type);\n        wrapper.setTimestamp(LocalDateTime.now());\n        wrapper.setVersion("1.0");\n        wrapper.setPayload(payload);\n        wrapper.setMetadata(new HashMap<>());\n        return wrapper;\n    }\n}\n'})}),"\n",(0,t.jsx)(n.h3,{id:"\u5e42\u7b49\u6027\u5904\u7406",children:"\u5e42\u7b49\u6027\u5904\u7406"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:'@Service\npublic class IdempotentConsumer {\n\n    @Autowired\n    private StringRedisTemplate redisTemplate;\n\n    @RabbitListener(queues = "orderQueue")\n    public void handleOrder(Message message, Channel channel,\n                            @Header(AmqpHeaders.DELIVERY_TAG) long tag) throws IOException {\n        String messageId = message.getMessageProperties().getMessageId();\n        String key = "processed:" + messageId;\n\n        try {\n            // \u5e42\u7b49\u6027\u68c0\u67e5\n            Boolean isNew = redisTemplate.opsForValue()\n                .setIfAbsent(key, "1", Duration.ofHours(24));\n\n            if (Boolean.FALSE.equals(isNew)) {\n                channel.basicAck(tag, false);\n                return;\n            }\n\n            // \u5904\u7406\u4e1a\u52a1\n            processOrder(message);\n\n            channel.basicAck(tag, false);\n\n        } catch (Exception e) {\n            redisTemplate.delete(key);\n            channel.basicNack(tag, false, true);\n        }\n    }\n}\n'})}),"\n",(0,t.jsx)(n.h2,{id:"\u53c2\u8003\u8d44\u6599",children:"\u53c2\u8003\u8d44\u6599"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://docs.spring.io/spring-amqp/docs/current/reference/html/",children:"Spring AMQP \u5b98\u65b9\u6587\u6863"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://docs.spring.io/spring-cloud-stream-binder-rabbit/docs/current/reference/html/",children:"Spring Cloud Stream RabbitMQ Binder"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://docs.spring.io/spring-boot/docs/current/reference/html/application-properties.html#application-properties.integration.spring.rabbitmq",children:"Spring Boot RabbitMQ \u914d\u7f6e"})}),"\n"]})]})}function u(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}},48885:(e,n,r)=>{r.d(n,{R:()=>s,x:()=>l});var a=r(99378);const t={},i=a.createContext(t);function s(e){const n=a.useContext(i);return a.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:s(e.components),a.createElement(i.Provider,{value:n},e.children)}}}]);