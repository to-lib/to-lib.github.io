"use strict";(globalThis.webpackChunkto_lib_github_io=globalThis.webpackChunkto_lib_github_io||[]).push([[88958],{46012:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>d,contentTitle:()=>i,default:()=>p,frontMatter:()=>o,metadata:()=>t,toc:()=>c});const t=JSON.parse('{"id":"nginx/reverse-proxy","title":"\u53cd\u5411\u4ee3\u7406","description":"Nginx \u53cd\u5411\u4ee3\u7406\u914d\u7f6e\u8be6\u89e3","source":"@site/docs/nginx/reverse-proxy.md","sourceDirName":"nginx","slug":"/nginx/reverse-proxy","permalink":"/docs/nginx/reverse-proxy","draft":false,"unlisted":false,"editUrl":"https://github.com/to-lib/to-lib.github.io/tree/main/docs/nginx/reverse-proxy.md","tags":[],"version":"current","sidebarPosition":5,"frontMatter":{"sidebar_position":5,"title":"\u53cd\u5411\u4ee3\u7406","description":"Nginx \u53cd\u5411\u4ee3\u7406\u914d\u7f6e\u8be6\u89e3"},"sidebar":"nginx","previous":{"title":"\u9759\u6001\u6587\u4ef6\u670d\u52a1","permalink":"/docs/nginx/static-files"},"next":{"title":"\u8d1f\u8f7d\u5747\u8861","permalink":"/docs/nginx/load-balancing"}}');var s=r(22714),a=r(48885);const o={sidebar_position:5,title:"\u53cd\u5411\u4ee3\u7406",description:"Nginx \u53cd\u5411\u4ee3\u7406\u914d\u7f6e\u8be6\u89e3"},i="\u53cd\u5411\u4ee3\u7406",d={},c=[{value:"\u4ee3\u7406\u6982\u8ff0",id:"\u4ee3\u7406\u6982\u8ff0",level:2},{value:"\u6b63\u5411\u4ee3\u7406 vs \u53cd\u5411\u4ee3\u7406",id:"\u6b63\u5411\u4ee3\u7406-vs-\u53cd\u5411\u4ee3\u7406",level:3},{value:"\u53cd\u5411\u4ee3\u7406\u67b6\u6784",id:"\u53cd\u5411\u4ee3\u7406\u67b6\u6784",level:3},{value:"\u57fa\u672c\u914d\u7f6e",id:"\u57fa\u672c\u914d\u7f6e",level:2},{value:"Proxy \u6307\u4ee4\u8be6\u89e3",id:"proxy-\u6307\u4ee4\u8be6\u89e3",level:2},{value:"WebSocket \u4ee3\u7406",id:"websocket-\u4ee3\u7406",level:2},{value:"gRPC \u4ee3\u7406",id:"grpc-\u4ee3\u7406",level:2},{value:"Upstream \u914d\u7f6e",id:"upstream-\u914d\u7f6e",level:2},{value:"\u4ee3\u7406\u7f13\u5b58",id:"\u4ee3\u7406\u7f13\u5b58",level:2},{value:"\u4f20\u9012\u771f\u5b9e IP",id:"\u4f20\u9012\u771f\u5b9e-ip",level:2},{value:"\u591a\u7ea7\u4ee3\u7406\u914d\u7f6e",id:"\u591a\u7ea7\u4ee3\u7406\u914d\u7f6e",level:2},{value:"\u6545\u969c\u8f6c\u79fb\u914d\u7f6e",id:"\u6545\u969c\u8f6c\u79fb\u914d\u7f6e",level:2},{value:"\u4ee3\u7406\u5230 Unix Socket",id:"\u4ee3\u7406\u5230-unix-socket",level:2},{value:"\u52a8\u6001\u540e\u7aef\u9009\u62e9",id:"\u52a8\u6001\u540e\u7aef\u9009\u62e9",level:2},{value:"\u5b8c\u6574\u914d\u7f6e\u793a\u4f8b",id:"\u5b8c\u6574\u914d\u7f6e\u793a\u4f8b",level:2}];function l(e){const n={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",mermaid:"mermaid",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",...(0,a.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"\u53cd\u5411\u4ee3\u7406",children:"\u53cd\u5411\u4ee3\u7406"})}),"\n",(0,s.jsx)(n.h2,{id:"\u4ee3\u7406\u6982\u8ff0",children:"\u4ee3\u7406\u6982\u8ff0"}),"\n",(0,s.jsx)(n.h3,{id:"\u6b63\u5411\u4ee3\u7406-vs-\u53cd\u5411\u4ee3\u7406",children:"\u6b63\u5411\u4ee3\u7406 vs \u53cd\u5411\u4ee3\u7406"}),"\n",(0,s.jsx)(n.mermaid,{value:'graph LR\n    subgraph "\u6b63\u5411\u4ee3\u7406"\n        C1[\u5ba2\u6237\u7aef] --\x3e P1[\u4ee3\u7406\u670d\u52a1\u5668] --\x3e S1[\u4e92\u8054\u7f51]\n    end\n\n    subgraph "\u53cd\u5411\u4ee3\u7406"\n        C2[\u4e92\u8054\u7f51] --\x3e P2[Nginx] --\x3e S2[\u540e\u7aef\u670d\u52a1\u5668]\n    end'}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"\u7279\u6027"}),(0,s.jsx)(n.th,{children:"\u6b63\u5411\u4ee3\u7406"}),(0,s.jsx)(n.th,{children:"\u53cd\u5411\u4ee3\u7406"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"\u4ee3\u7406\u5bf9\u8c61"}),(0,s.jsx)(n.td,{children:"\u5ba2\u6237\u7aef"}),(0,s.jsx)(n.td,{children:"\u670d\u52a1\u7aef"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"\u5ba2\u6237\u7aef\u611f\u77e5"}),(0,s.jsx)(n.td,{children:"\u77e5\u9053\u4ee3\u7406\u5b58\u5728"}),(0,s.jsx)(n.td,{children:"\u4e0d\u77e5\u9053\u4ee3\u7406\u5b58\u5728"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"\u5178\u578b\u7528\u9014"}),(0,s.jsx)(n.td,{children:"\u7ffb\u5899\u3001\u7f13\u5b58"}),(0,s.jsx)(n.td,{children:"\u8d1f\u8f7d\u5747\u8861\u3001\u9690\u85cf\u540e\u7aef"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"\u914d\u7f6e\u4f4d\u7f6e"}),(0,s.jsx)(n.td,{children:"\u5ba2\u6237\u7aef"}),(0,s.jsx)(n.td,{children:"\u670d\u52a1\u7aef"})]})]})]}),"\n",(0,s.jsx)(n.h3,{id:"\u53cd\u5411\u4ee3\u7406\u67b6\u6784",children:"\u53cd\u5411\u4ee3\u7406\u67b6\u6784"}),"\n",(0,s.jsx)(n.mermaid,{value:"graph TD\n    Client[\u5ba2\u6237\u7aef] --\x3e Nginx[Nginx \u53cd\u5411\u4ee3\u7406]\n    Nginx --\x3e |/api| Backend1[API \u670d\u52a1\u5668]\n    Nginx --\x3e |/static| Backend2[\u9759\u6001\u8d44\u6e90\u670d\u52a1\u5668]\n    Nginx --\x3e |/ws| Backend3[WebSocket \u670d\u52a1\u5668]\n\n    style Nginx fill:#009639,color:#fff"}),"\n",(0,s.jsx)(n.h2,{id:"\u57fa\u672c\u914d\u7f6e",children:"\u57fa\u672c\u914d\u7f6e"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-nginx",children:"server {\n    listen 80;\n    server_name api.example.com;\n\n    location / {\n        proxy_pass http://localhost:3000;\n        proxy_set_header Host $host;\n        proxy_set_header X-Real-IP $remote_addr;\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n    }\n}\n"})}),"\n",(0,s.jsx)(n.h2,{id:"proxy-\u6307\u4ee4\u8be6\u89e3",children:"Proxy \u6307\u4ee4\u8be6\u89e3"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-nginx",children:"location /api/ {\n    proxy_pass http://backend:8080/;\n\n    # \u8bf7\u6c42\u5934\u8bbe\u7f6e\n    proxy_set_header Host $host;\n    proxy_set_header X-Real-IP $remote_addr;\n    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n    proxy_set_header X-Forwarded-Proto $scheme;\n\n    # \u8d85\u65f6\u8bbe\u7f6e\n    proxy_connect_timeout 60s;\n    proxy_send_timeout 60s;\n    proxy_read_timeout 60s;\n\n    # \u7f13\u51b2\u8bbe\u7f6e\n    proxy_buffering on;\n    proxy_buffer_size 4k;\n    proxy_buffers 8 32k;\n\n    # HTTP \u7248\u672c\n    proxy_http_version 1.1;\n}\n"})}),"\n",(0,s.jsx)(n.h2,{id:"websocket-\u4ee3\u7406",children:"WebSocket \u4ee3\u7406"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-nginx",children:"map $http_upgrade $connection_upgrade {\n    default upgrade;\n    '' close;\n}\n\nlocation /ws/ {\n    proxy_pass http://websocket_server;\n    proxy_http_version 1.1;\n    proxy_set_header Upgrade $http_upgrade;\n    proxy_set_header Connection $connection_upgrade;\n    proxy_set_header Host $host;\n    proxy_set_header X-Real-IP $remote_addr;\n    proxy_read_timeout 3600s;  # \u957f\u8fde\u63a5\u4fdd\u6301\n    proxy_send_timeout 3600s;\n}\n"})}),"\n",(0,s.jsx)(n.h2,{id:"grpc-\u4ee3\u7406",children:"gRPC \u4ee3\u7406"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-nginx",children:"# \u9700\u8981 Nginx 1.13.10+\nupstream grpc_backend {\n    server 127.0.0.1:50051;\n    keepalive 20;\n}\n\nserver {\n    listen 443 ssl http2;\n    server_name grpc.example.com;\n\n    ssl_certificate /path/to/cert.pem;\n    ssl_certificate_key /path/to/key.pem;\n\n    location / {\n        grpc_pass grpc://grpc_backend;\n\n        # \u9519\u8bef\u5904\u7406\n        error_page 502 = /error502grpc;\n    }\n\n    location = /error502grpc {\n        internal;\n        default_type application/grpc;\n        add_header grpc-status 14;\n        add_header content-length 0;\n        return 204;\n    }\n}\n\n# gRPC-Web \u4ee3\u7406\nlocation /grpc-web/ {\n    grpc_pass grpc://grpc_backend;\n\n    # \u652f\u6301 gRPC-Web \u534f\u8bae\n    if ($request_method = 'OPTIONS') {\n        add_header Access-Control-Allow-Origin '*';\n        add_header Access-Control-Allow-Methods 'GET, POST, OPTIONS';\n        add_header Access-Control-Allow-Headers 'DNT,X-CustomHeader,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Content-Transfer-Encoding,Custom-Header-1,X-Accept-Content-Transfer-Encoding,X-Accept-Response-Streaming,X-User-Agent,X-Grpc-Web';\n        return 204;\n    }\n}\n"})}),"\n",(0,s.jsx)(n.h2,{id:"upstream-\u914d\u7f6e",children:"Upstream \u914d\u7f6e"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-nginx",children:'upstream backend {\n    server 192.168.1.10:8080;\n    server 192.168.1.11:8080;\n    keepalive 32;\n}\n\nserver {\n    location / {\n        proxy_pass http://backend;\n        proxy_http_version 1.1;\n        proxy_set_header Connection "";\n    }\n}\n'})}),"\n",(0,s.jsx)(n.h2,{id:"\u4ee3\u7406\u7f13\u5b58",children:"\u4ee3\u7406\u7f13\u5b58"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-nginx",children:"# \u5b9a\u4e49\u7f13\u5b58\u8def\u5f84\nproxy_cache_path /var/cache/nginx\n    levels=1:2\n    keys_zone=my_cache:10m\n    max_size=1g\n    inactive=60m\n    use_temp_path=off;\n\nlocation /api/ {\n    proxy_pass http://backend;\n    proxy_cache my_cache;\n\n    # \u7f13\u5b58\u6709\u6548\u671f\n    proxy_cache_valid 200 10m;\n    proxy_cache_valid 404 1m;\n\n    # \u7f13\u5b58 key\n    proxy_cache_key $scheme$proxy_host$request_uri;\n\n    # \u6dfb\u52a0\u7f13\u5b58\u72b6\u6001\u5934\n    add_header X-Cache-Status $upstream_cache_status;\n\n    # \u7ed5\u8fc7\u7f13\u5b58\u6761\u4ef6\n    proxy_cache_bypass $cookie_nocache $arg_nocache;\n}\n"})}),"\n",(0,s.jsx)(n.h2,{id:"\u4f20\u9012\u771f\u5b9e-ip",children:"\u4f20\u9012\u771f\u5b9e IP"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-nginx",children:"# \u8bbe\u7f6e\u4fe1\u4efb\u7684\u4ee3\u7406\nset_real_ip_from 10.0.0.0/8;\nset_real_ip_from 172.16.0.0/12;\nset_real_ip_from 192.168.0.0/16;\n\n# \u4ece\u54ea\u4e2a\u5934\u83b7\u53d6\u771f\u5b9e IP\nreal_ip_header X-Forwarded-For;\n\n# \u591a\u5c42\u4ee3\u7406\u65f6\u9012\u5f52\u67e5\u627e\nreal_ip_recursive on;\n"})}),"\n",(0,s.jsx)(n.h2,{id:"\u591a\u7ea7\u4ee3\u7406\u914d\u7f6e",children:"\u591a\u7ea7\u4ee3\u7406\u914d\u7f6e"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-nginx",children:"# \u7b2c\u4e00\u5c42\u4ee3\u7406\uff08\u8fb9\u7f18\uff09\nserver {\n    listen 80;\n    server_name edge.example.com;\n\n    location / {\n        proxy_pass http://origin.example.com;\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n        proxy_set_header X-Real-IP $remote_addr;\n        proxy_set_header X-Forwarded-Host $host;\n        proxy_set_header X-Forwarded-Proto $scheme;\n    }\n}\n\n# \u7b2c\u4e8c\u5c42\u4ee3\u7406\uff08\u6e90\u7ad9\uff09\nserver {\n    listen 80;\n    server_name origin.example.com;\n\n    # \u4fe1\u4efb\u7b2c\u4e00\u5c42\u4ee3\u7406\n    set_real_ip_from 10.0.0.0/8;\n    real_ip_header X-Real-IP;\n\n    location / {\n        proxy_pass http://backend;\n        proxy_set_header Host $host;\n    }\n}\n"})}),"\n",(0,s.jsx)(n.h2,{id:"\u6545\u969c\u8f6c\u79fb\u914d\u7f6e",children:"\u6545\u969c\u8f6c\u79fb\u914d\u7f6e"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-nginx",children:"upstream backend {\n    server 10.0.0.1:8080 weight=5 max_fails=3 fail_timeout=30s;\n    server 10.0.0.2:8080 weight=5 max_fails=3 fail_timeout=30s;\n    server 10.0.0.3:8080 backup;  # \u5907\u7528\u670d\u52a1\u5668\n}\n\nserver {\n    location / {\n        proxy_pass http://backend;\n\n        # \u6545\u969c\u8f6c\u79fb\u6761\u4ef6\n        proxy_next_upstream error timeout http_500 http_502 http_503 http_504;\n\n        # \u6700\u5927\u91cd\u8bd5\u6b21\u6570\n        proxy_next_upstream_tries 3;\n\n        # \u91cd\u8bd5\u8d85\u65f6\u65f6\u95f4\n        proxy_next_upstream_timeout 10s;\n\n        # \u8fde\u63a5\u5931\u8d25\u65f6\u7684\u54cd\u5e94\n        proxy_intercept_errors on;\n        error_page 502 503 504 /fallback.html;\n    }\n\n    location = /fallback.html {\n        root /var/www/error;\n        internal;\n    }\n}\n"})}),"\n",(0,s.jsx)(n.h2,{id:"\u4ee3\u7406\u5230-unix-socket",children:"\u4ee3\u7406\u5230 Unix Socket"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-nginx",children:"upstream php {\n    server unix:/var/run/php/php-fpm.sock;\n}\n\nlocation ~ \\.php$ {\n    fastcgi_pass php;\n    fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;\n    include fastcgi_params;\n}\n"})}),"\n",(0,s.jsx)(n.h2,{id:"\u52a8\u6001\u540e\u7aef\u9009\u62e9",children:"\u52a8\u6001\u540e\u7aef\u9009\u62e9"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-nginx",children:'# \u6839\u636e\u8bf7\u6c42\u5934\u9009\u62e9\u540e\u7aef\nmap $http_x_backend $backend_server {\n    default backend_a;\n    "beta"  backend_b;\n}\n\nupstream backend_a {\n    server 10.0.0.1:8080;\n}\n\nupstream backend_b {\n    server 10.0.0.2:8080;\n}\n\nserver {\n    location / {\n        proxy_pass http://$backend_server;\n    }\n}\n'})}),"\n",(0,s.jsx)(n.h2,{id:"\u5b8c\u6574\u914d\u7f6e\u793a\u4f8b",children:"\u5b8c\u6574\u914d\u7f6e\u793a\u4f8b"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-nginx",children:'upstream api_backend {\n    least_conn;\n    server 10.0.0.1:8080 weight=5 max_fails=3 fail_timeout=30s;\n    server 10.0.0.2:8080 weight=3 max_fails=3 fail_timeout=30s;\n    server 10.0.0.3:8080 backup;\n    keepalive 32;\n}\n\nserver {\n    listen 80;\n    server_name api.example.com;\n    return 301 https://$host$request_uri;\n}\n\nserver {\n    listen 443 ssl http2;\n    server_name api.example.com;\n\n    ssl_certificate /etc/nginx/ssl/cert.pem;\n    ssl_certificate_key /etc/nginx/ssl/key.pem;\n\n    # \u5b89\u5168\u5934\n    add_header X-Frame-Options DENY;\n    add_header X-Content-Type-Options nosniff;\n\n    location / {\n        proxy_pass http://api_backend;\n        proxy_http_version 1.1;\n        proxy_set_header Host $host;\n        proxy_set_header X-Real-IP $remote_addr;\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n        proxy_set_header X-Forwarded-Proto $scheme;\n        proxy_set_header Connection "";\n\n        proxy_connect_timeout 5s;\n        proxy_send_timeout 60s;\n        proxy_read_timeout 60s;\n\n        proxy_next_upstream error timeout http_500 http_502 http_503;\n        proxy_next_upstream_tries 2;\n    }\n}\n'})})]})}function p(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(l,{...e})}):l(e)}},48885:(e,n,r)=>{r.d(n,{R:()=>o,x:()=>i});var t=r(99378);const s={},a=t.createContext(s);function o(e){const n=t.useContext(a);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function i(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:o(e.components),t.createElement(a.Provider,{value:n},e.children)}}}]);