"use strict";(globalThis.webpackChunkto_lib_github_io=globalThis.webpackChunkto_lib_github_io||[]).push([[5567],{8405:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>d,contentTitle:()=>t,default:()=>h,frontMatter:()=>s,metadata:()=>i,toc:()=>o});const i=JSON.parse('{"id":"flink/deployment","title":"\u90e8\u7f72\u4e0e\u8fd0\u7ef4","description":"Flink \u96c6\u7fa4\u90e8\u7f72\u4e0e\u8fd0\u7ef4\u6307\u5357","source":"@site/docs/flink/deployment.md","sourceDirName":"flink","slug":"/flink/deployment","permalink":"/docs/flink/deployment","draft":false,"unlisted":false,"editUrl":"https://github.com/to-lib/to-lib.github.io/tree/main/docs/flink/deployment.md","tags":[],"version":"current","sidebarPosition":14,"frontMatter":{"sidebar_position":14,"title":"\u90e8\u7f72\u4e0e\u8fd0\u7ef4","description":"Flink \u96c6\u7fa4\u90e8\u7f72\u4e0e\u8fd0\u7ef4\u6307\u5357"},"sidebar":"flink","previous":{"title":"Flink CDC","permalink":"/docs/flink/flink-cdc"},"next":{"title":"\u76d1\u63a7\u4e0e\u8fd0\u7ef4","permalink":"/docs/flink/monitoring"}}');var l=r(22714),a=r(48885);const s={sidebar_position:14,title:"\u90e8\u7f72\u4e0e\u8fd0\u7ef4",description:"Flink \u96c6\u7fa4\u90e8\u7f72\u4e0e\u8fd0\u7ef4\u6307\u5357"},t="Flink \u90e8\u7f72\u4e0e\u8fd0\u7ef4",d={},o=[{value:"\u90e8\u7f72\u6a21\u5f0f",id:"\u90e8\u7f72\u6a21\u5f0f",level:2},{value:"Standalone \u6a21\u5f0f",id:"standalone-\u6a21\u5f0f",level:3},{value:"YARN \u6a21\u5f0f",id:"yarn-\u6a21\u5f0f",level:3},{value:"Kubernetes \u6a21\u5f0f",id:"kubernetes-\u6a21\u5f0f",level:3},{value:"\u9ad8\u53ef\u7528\u914d\u7f6e",id:"\u9ad8\u53ef\u7528\u914d\u7f6e",level:2},{value:"ZooKeeper HA",id:"zookeeper-ha",level:3},{value:"Kubernetes HA",id:"kubernetes-ha",level:3},{value:"\u5185\u5b58\u914d\u7f6e",id:"\u5185\u5b58\u914d\u7f6e",level:2},{value:"TaskManager \u5185\u5b58",id:"taskmanager-\u5185\u5b58",level:3},{value:"JobManager \u5185\u5b58",id:"jobmanager-\u5185\u5b58",level:3},{value:"\u76d1\u63a7\u914d\u7f6e",id:"\u76d1\u63a7\u914d\u7f6e",level:2},{value:"Metrics Reporter",id:"metrics-reporter",level:3},{value:"\u91cd\u8981\u76d1\u63a7\u6307\u6807",id:"\u91cd\u8981\u76d1\u63a7\u6307\u6807",level:3},{value:"\u65e5\u5fd7\u914d\u7f6e",id:"\u65e5\u5fd7\u914d\u7f6e",level:2},{value:"log4j2.properties",id:"log4j2properties",level:3},{value:"\u5e38\u7528\u8fd0\u7ef4\u547d\u4ee4",id:"\u5e38\u7528\u8fd0\u7ef4\u547d\u4ee4",level:2},{value:"\u4f5c\u4e1a\u7ba1\u7406",id:"\u4f5c\u4e1a\u7ba1\u7406",level:3},{value:"\u96c6\u7fa4\u72b6\u6001",id:"\u96c6\u7fa4\u72b6\u6001",level:3},{value:"\u6545\u969c\u6392\u67e5",id:"\u6545\u969c\u6392\u67e5",level:2},{value:"\u5e38\u89c1\u95ee\u9898",id:"\u5e38\u89c1\u95ee\u9898",level:3},{value:"\u65e5\u5fd7\u5206\u6790",id:"\u65e5\u5fd7\u5206\u6790",level:3},{value:"\u4e0b\u4e00\u6b65",id:"\u4e0b\u4e00\u6b65",level:2}];function c(e){const n={a:"a",blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,a.R)(),...e.components};return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(n.header,{children:(0,l.jsx)(n.h1,{id:"flink-\u90e8\u7f72\u4e0e\u8fd0\u7ef4",children:"Flink \u90e8\u7f72\u4e0e\u8fd0\u7ef4"})}),"\n",(0,l.jsxs)(n.blockquote,{children:["\n",(0,l.jsx)(n.p,{children:"\u9002\u7528\u7248\u672c\uff1aApache Flink v2.2.0"}),"\n"]}),"\n",(0,l.jsx)(n.h2,{id:"\u90e8\u7f72\u6a21\u5f0f",children:"\u90e8\u7f72\u6a21\u5f0f"}),"\n",(0,l.jsx)(n.h3,{id:"standalone-\u6a21\u5f0f",children:"Standalone \u6a21\u5f0f"}),"\n",(0,l.jsx)(n.p,{children:"\u72ec\u7acb\u96c6\u7fa4\u90e8\u7f72\uff0c\u9002\u5408\u5f00\u53d1\u6d4b\u8bd5\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"# \u542f\u52a8\u96c6\u7fa4\n./bin/start-cluster.sh\n\n# \u63d0\u4ea4\u4f5c\u4e1a\n./bin/flink run myJob.jar\n\n# \u505c\u6b62\u96c6\u7fa4\n./bin/stop-cluster.sh\n"})}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:"\u914d\u7f6e flink-conf.yaml"}),"\uff1a"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-yaml",children:"jobmanager.rpc.address: master-node\njobmanager.rpc.port: 6123\njobmanager.memory.process.size: 1600m\ntaskmanager.memory.process.size: 4096m\ntaskmanager.numberOfTaskSlots: 4\nparallelism.default: 2\n"})}),"\n",(0,l.jsx)(n.h3,{id:"yarn-\u6a21\u5f0f",children:"YARN \u6a21\u5f0f"}),"\n",(0,l.jsx)(n.p,{children:"\u5728 Hadoop YARN \u4e0a\u8fd0\u884c Flink\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"# Session \u6a21\u5f0f\uff1a\u9884\u542f\u52a8\u96c6\u7fa4\n./bin/yarn-session.sh -n 4 -jm 1024m -tm 4096m -s 2\n\n# Per-Job \u6a21\u5f0f\uff1a\u6bcf\u4e2a\u4f5c\u4e1a\u72ec\u7acb\u96c6\u7fa4\n./bin/flink run -m yarn-cluster -yjm 1024m -ytm 4096m myJob.jar\n\n# Application \u6a21\u5f0f\uff08\u63a8\u8350\uff09\n./bin/flink run-application -t yarn-application myJob.jar\n"})}),"\n",(0,l.jsx)(n.h3,{id:"kubernetes-\u6a21\u5f0f",children:"Kubernetes \u6a21\u5f0f"}),"\n",(0,l.jsx)(n.p,{children:"\u4f7f\u7528 Kubernetes \u90e8\u7f72 Flink\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-yaml",children:"# flink-configuration-configmap.yaml\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: flink-config\ndata:\n  flink-conf.yaml: |\n    jobmanager.rpc.address: flink-jobmanager\n    taskmanager.numberOfTaskSlots: 2\n    blob.server.port: 6124\n    jobmanager.rpc.port: 6123\n"})}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-yaml",children:'# flink-jobmanager-deployment.yaml\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: flink-jobmanager\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: flink\n      component: jobmanager\n  template:\n    spec:\n      containers:\n        - name: jobmanager\n          image: flink:2.2.0\n          args: ["jobmanager"]\n          ports:\n            - containerPort: 6123\n            - containerPort: 8081\n          env:\n            - name: FLINK_PROPERTIES\n              value: |\n                jobmanager.rpc.address: flink-jobmanager\n'})}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:"Kubernetes \u90e8\u7f72\u547d\u4ee4"}),"\uff1a"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"# Native Kubernetes\n./bin/flink run-application \\\n    --target kubernetes-application \\\n    -Dkubernetes.cluster-id=my-flink-cluster \\\n    -Dkubernetes.container.image=my-flink-image:latest \\\n    local:///opt/flink/usrlib/my-flink-job.jar\n"})}),"\n",(0,l.jsx)(n.h2,{id:"\u9ad8\u53ef\u7528\u914d\u7f6e",children:"\u9ad8\u53ef\u7528\u914d\u7f6e"}),"\n",(0,l.jsx)(n.h3,{id:"zookeeper-ha",children:"ZooKeeper HA"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-yaml",children:"# flink-conf.yaml\nhigh-availability: zookeeper\nhigh-availability.storageDir: hdfs:///flink/ha\nhigh-availability.zookeeper.quorum: zk1:2181,zk2:2181,zk3:2181\nhigh-availability.zookeeper.path.root: /flink\nhigh-availability.cluster-id: /cluster-1\n"})}),"\n",(0,l.jsx)(n.h3,{id:"kubernetes-ha",children:"Kubernetes HA"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-yaml",children:"high-availability: kubernetes\nhigh-availability.storageDir: s3://bucket/flink/ha\nkubernetes.cluster-id: my-cluster\n"})}),"\n",(0,l.jsx)(n.h2,{id:"\u5185\u5b58\u914d\u7f6e",children:"\u5185\u5b58\u914d\u7f6e"}),"\n",(0,l.jsx)(n.h3,{id:"taskmanager-\u5185\u5b58",children:"TaskManager \u5185\u5b58"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-yaml",children:"# \u8fdb\u7a0b\u603b\u5185\u5b58\ntaskmanager.memory.process.size: 4096m\n\n# Flink \u5185\u5b58\ntaskmanager.memory.flink.size: 3072m\n\n# \u6846\u67b6\u5806\u5185\u5b58\ntaskmanager.memory.framework.heap.size: 128m\n\n# \u4efb\u52a1\u5806\u5185\u5b58\ntaskmanager.memory.task.heap.size: 1024m\n\n# \u6258\u7ba1\u5185\u5b58\uff08\u7528\u4e8e RocksDB \u7b49\uff09\ntaskmanager.memory.managed.size: 512m\n\n# \u7f51\u7edc\u5185\u5b58\ntaskmanager.memory.network.min: 64m\ntaskmanager.memory.network.max: 1024m\n"})}),"\n",(0,l.jsx)(n.h3,{id:"jobmanager-\u5185\u5b58",children:"JobManager \u5185\u5b58"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-yaml",children:"jobmanager.memory.process.size: 1600m\njobmanager.memory.heap.size: 1024m\n"})}),"\n",(0,l.jsx)(n.h2,{id:"\u76d1\u63a7\u914d\u7f6e",children:"\u76d1\u63a7\u914d\u7f6e"}),"\n",(0,l.jsx)(n.h3,{id:"metrics-reporter",children:"Metrics Reporter"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-yaml",children:"# Prometheus\nmetrics.reporter.promgateway.factory.class: org.apache.flink.metrics.prometheus.PrometheusPushGatewayReporterFactory\nmetrics.reporter.promgateway.host: prometheus-gateway\nmetrics.reporter.promgateway.port: 9091\nmetrics.reporter.promgateway.interval: 60 SECONDS\n\n# InfluxDB\nmetrics.reporter.influxdb.factory.class: org.apache.flink.metrics.influxdb.InfluxdbReporterFactory\nmetrics.reporter.influxdb.host: influxdb\nmetrics.reporter.influxdb.port: 8086\nmetrics.reporter.influxdb.db: flink\n"})}),"\n",(0,l.jsx)(n.h3,{id:"\u91cd\u8981\u76d1\u63a7\u6307\u6807",children:"\u91cd\u8981\u76d1\u63a7\u6307\u6807"}),"\n",(0,l.jsxs)(n.table,{children:[(0,l.jsx)(n.thead,{children:(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.th,{children:"\u6307\u6807"}),(0,l.jsx)(n.th,{children:"\u63cf\u8ff0"}),(0,l.jsx)(n.th,{children:"\u544a\u8b66\u9608\u503c"})]})}),(0,l.jsxs)(n.tbody,{children:[(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:(0,l.jsx)(n.code,{children:"numRecordsInPerSecond"})}),(0,l.jsx)(n.td,{children:"\u8f93\u5165\u541e\u5410\u91cf"}),(0,l.jsx)(n.td,{children:"\u6839\u636e\u4e1a\u52a1"})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:(0,l.jsx)(n.code,{children:"numRecordsOutPerSecond"})}),(0,l.jsx)(n.td,{children:"\u8f93\u51fa\u541e\u5410\u91cf"}),(0,l.jsx)(n.td,{children:"\u6839\u636e\u4e1a\u52a1"})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:(0,l.jsx)(n.code,{children:"currentInputWatermark"})}),(0,l.jsx)(n.td,{children:"\u5f53\u524d\u6c34\u5370"}),(0,l.jsx)(n.td,{children:"\u5ef6\u8fdf\u8fc7\u5927\u544a\u8b66"})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:(0,l.jsx)(n.code,{children:"lastCheckpointDuration"})}),(0,l.jsx)(n.td,{children:"\u68c0\u67e5\u70b9\u8017\u65f6"}),(0,l.jsx)(n.td,{children:"> 5min"})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:(0,l.jsx)(n.code,{children:"lastCheckpointSize"})}),(0,l.jsx)(n.td,{children:"\u68c0\u67e5\u70b9\u5927\u5c0f"}),(0,l.jsx)(n.td,{children:"\u589e\u957f\u8fc7\u5feb"})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:(0,l.jsx)(n.code,{children:"fullRestarts"})}),(0,l.jsx)(n.td,{children:"\u5168\u91cf\u91cd\u542f\u6b21\u6570"}),(0,l.jsx)(n.td,{children:"> 0"})]})]})]}),"\n",(0,l.jsx)(n.h2,{id:"\u65e5\u5fd7\u914d\u7f6e",children:"\u65e5\u5fd7\u914d\u7f6e"}),"\n",(0,l.jsx)(n.h3,{id:"log4j2properties",children:"log4j2.properties"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-properties",children:"rootLogger.level = INFO\nrootLogger.appenderRef.file.ref = MainAppender\n\nappender.main.name = MainAppender\nappender.main.type = RollingFile\nappender.main.fileName = ${sys:log.file}\nappender.main.filePattern = ${sys:log.file}.%i\nappender.main.layout.type = PatternLayout\nappender.main.layout.pattern = %d{yyyy-MM-dd HH:mm:ss,SSS} %-5p %-60c %x - %m%n\nappender.main.policies.type = Policies\nappender.main.policies.size.type = SizeBasedTriggeringPolicy\nappender.main.policies.size.size = 100MB\n"})}),"\n",(0,l.jsx)(n.h2,{id:"\u5e38\u7528\u8fd0\u7ef4\u547d\u4ee4",children:"\u5e38\u7528\u8fd0\u7ef4\u547d\u4ee4"}),"\n",(0,l.jsx)(n.h3,{id:"\u4f5c\u4e1a\u7ba1\u7406",children:"\u4f5c\u4e1a\u7ba1\u7406"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"# \u5217\u51fa\u4f5c\u4e1a\nflink list\n\n# \u53d6\u6d88\u4f5c\u4e1a\nflink cancel <jobId>\n\n# \u4ece\u4fdd\u5b58\u70b9\u6062\u590d\nflink run -s <savepointPath> myJob.jar\n\n# \u89e6\u53d1\u4fdd\u5b58\u70b9\nflink savepoint <jobId> <savepointDir>\n\n# \u4fee\u6539\u5e76\u884c\u5ea6\uff08\u9700\u8981\u4fdd\u5b58\u70b9\uff09\nflink modify <jobId> -p 8\n"})}),"\n",(0,l.jsx)(n.h3,{id:"\u96c6\u7fa4\u72b6\u6001",children:"\u96c6\u7fa4\u72b6\u6001"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"# \u67e5\u770b TaskManager\ncurl http://localhost:8081/taskmanagers\n\n# \u67e5\u770b\u4f5c\u4e1a\u8be6\u60c5\ncurl http://localhost:8081/jobs/<jobId>\n\n# \u67e5\u770b\u68c0\u67e5\u70b9\u7edf\u8ba1\ncurl http://localhost:8081/jobs/<jobId>/checkpoints\n"})}),"\n",(0,l.jsx)(n.h2,{id:"\u6545\u969c\u6392\u67e5",children:"\u6545\u969c\u6392\u67e5"}),"\n",(0,l.jsx)(n.h3,{id:"\u5e38\u89c1\u95ee\u9898",children:"\u5e38\u89c1\u95ee\u9898"}),"\n",(0,l.jsxs)(n.table,{children:[(0,l.jsx)(n.thead,{children:(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.th,{children:"\u95ee\u9898"}),(0,l.jsx)(n.th,{children:"\u53ef\u80fd\u539f\u56e0"}),(0,l.jsx)(n.th,{children:"\u89e3\u51b3\u65b9\u6848"})]})}),(0,l.jsxs)(n.tbody,{children:[(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:"OOM \u9519\u8bef"}),(0,l.jsx)(n.td,{children:"\u5185\u5b58\u914d\u7f6e\u4e0d\u8db3"}),(0,l.jsx)(n.td,{children:"\u589e\u52a0\u5806\u5185\u5b58\u6216\u6258\u7ba1\u5185\u5b58"})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:"\u68c0\u67e5\u70b9\u8d85\u65f6"}),(0,l.jsx)(n.td,{children:"\u72b6\u6001\u8fc7\u5927/\u7f51\u7edc\u6162"}),(0,l.jsx)(n.td,{children:"\u4f7f\u7528\u589e\u91cf\u68c0\u67e5\u70b9"})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:"\u80cc\u538b\u4e25\u91cd"}),(0,l.jsx)(n.td,{children:"\u4e0b\u6e38\u5904\u7406\u6162"}),(0,l.jsx)(n.td,{children:"\u4f18\u5316\u7b97\u5b50/\u589e\u52a0\u5e76\u884c\u5ea6"})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:"\u6570\u636e\u503e\u659c"}),(0,l.jsx)(n.td,{children:"Key \u5206\u5e03\u4e0d\u5747"}),(0,l.jsx)(n.td,{children:"\u6dfb\u52a0\u968f\u673a\u524d\u7f00"})]})]})]}),"\n",(0,l.jsx)(n.h3,{id:"\u65e5\u5fd7\u5206\u6790",children:"\u65e5\u5fd7\u5206\u6790"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:'# \u67e5\u770b JobManager \u65e5\u5fd7\ntail -f log/flink-*-jobmanager-*.log\n\n# \u67e5\u770b TaskManager \u65e5\u5fd7\ntail -f log/flink-*-taskmanager-*.log\n\n# \u641c\u7d22\u5f02\u5e38\ngrep -i "exception" log/*.log\n'})}),"\n",(0,l.jsx)(n.h2,{id:"\u4e0b\u4e00\u6b65",children:"\u4e0b\u4e00\u6b65"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\ud83d\ude80 ",(0,l.jsx)(n.a,{href:"/docs/flink/performance-optimization",children:"\u6027\u80fd\u4f18\u5316"})," - \u8c03\u4f18\u6307\u5357"]}),"\n",(0,l.jsxs)(n.li,{children:["\ud83d\udccb ",(0,l.jsx)(n.a,{href:"/docs/flink/best-practices",children:"\u6700\u4f73\u5b9e\u8df5"})," - \u5f00\u53d1\u89c4\u8303"]}),"\n",(0,l.jsxs)(n.li,{children:["\u2753 ",(0,l.jsx)(n.a,{href:"/docs/flink/faq",children:"\u5e38\u89c1\u95ee\u9898"})," - FAQ"]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,l.jsx)(n,{...e,children:(0,l.jsx)(c,{...e})}):c(e)}},48885:(e,n,r)=>{r.d(n,{R:()=>s,x:()=>t});var i=r(99378);const l={},a=i.createContext(l);function s(e){const n=i.useContext(a);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function t(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(l):e.components||l:s(e.components),i.createElement(a.Provider,{value:n},e.children)}}}]);