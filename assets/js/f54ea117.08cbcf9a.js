"use strict";(globalThis.webpackChunkto_lib_github_io=globalThis.webpackChunkto_lib_github_io||[]).push([[463],{27866:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>a,contentTitle:()=>c,default:()=>o,frontMatter:()=>d,metadata:()=>l,toc:()=>t});const l=JSON.parse('{"id":"springcloud/sleuth","title":"Sleuth \u94fe\u8def\u8ffd\u8e2a","description":"[!TIP] > \u5206\u5e03\u5f0f\u8ffd\u8e2a: Spring Cloud Sleuth \u4e3a\u5206\u5e03\u5f0f\u7cfb\u7edf\u63d0\u4f9b\u94fe\u8def\u8ffd\u8e2a\u529f\u80fd\uff0c\u5e2e\u52a9\u7406\u89e3\u670d\u52a1\u95f4\u7684\u8c03\u7528\u5173\u7cfb\u548c\u6027\u80fd\u74f6\u9888\u3002","source":"@site/docs/springcloud/sleuth.md","sourceDirName":"springcloud","slug":"/springcloud/sleuth","permalink":"/docs/springcloud/sleuth","draft":false,"unlisted":false,"editUrl":"https://github.com/to-lib/to-lib.github.io/tree/main/docs/springcloud/sleuth.md","tags":[],"version":"current","sidebarPosition":9,"frontMatter":{"title":"Sleuth \u94fe\u8def\u8ffd\u8e2a","sidebar_label":"Sleuth","sidebar_position":9},"sidebar":"springcloud","previous":{"title":"Hystrix","permalink":"/docs/springcloud/hystrix"},"next":{"title":"Micrometer Tracing","permalink":"/docs/springcloud/micrometer-tracing"}}');var i=r(22714),s=r(48885);const d={title:"Sleuth \u94fe\u8def\u8ffd\u8e2a",sidebar_label:"Sleuth",sidebar_position:9},c="Sleuth \u94fe\u8def\u8ffd\u8e2a",a={},t=[{value:"1. Sleuth \u7b80\u4ecb",id:"1-sleuth-\u7b80\u4ecb",level:2},{value:"\u4ec0\u4e48\u662f Sleuth\uff1f",id:"\u4ec0\u4e48\u662f-sleuth",level:3},{value:"\u89e3\u51b3\u7684\u95ee\u9898",id:"\u89e3\u51b3\u7684\u95ee\u9898",level:3},{value:"\u6838\u5fc3\u6982\u5ff5",id:"\u6838\u5fc3\u6982\u5ff5",level:3},{value:"2. \u5feb\u901f\u5f00\u59cb",id:"2-\u5feb\u901f\u5f00\u59cb",level:2},{value:"\u6dfb\u52a0\u4f9d\u8d56",id:"\u6dfb\u52a0\u4f9d\u8d56",level:3},{value:"\u81ea\u52a8\u914d\u7f6e",id:"\u81ea\u52a8\u914d\u7f6e",level:3},{value:"\u67e5\u770b\u65e5\u5fd7",id:"\u67e5\u770b\u65e5\u5fd7",level:3},{value:"3. \u96c6\u6210 Zipkin",id:"3-\u96c6\u6210-zipkin",level:2},{value:"\u4ec0\u4e48\u662f Zipkin\uff1f",id:"\u4ec0\u4e48\u662f-zipkin",level:3},{value:"\u542f\u52a8 Zipkin Server",id:"\u542f\u52a8-zipkin-server",level:3},{value:"\u6dfb\u52a0\u4f9d\u8d56",id:"\u6dfb\u52a0\u4f9d\u8d56-1",level:3},{value:"\u914d\u7f6e",id:"\u914d\u7f6e",level:3},{value:"4. \u8ffd\u8e2a\u4fe1\u606f\u4f20\u9012",id:"4-\u8ffd\u8e2a\u4fe1\u606f\u4f20\u9012",level:2},{value:"HTTP \u8bf7\u6c42\uff08\u81ea\u52a8\uff09",id:"http-\u8bf7\u6c42\u81ea\u52a8",level:3},{value:"\u6d88\u606f\u961f\u5217\uff08RabbitMQ/Kafka\uff09",id:"\u6d88\u606f\u961f\u5217rabbitmqkafka",level:3},{value:"\u624b\u52a8\u4f20\u9012\uff08\u5f02\u6b65\u7ebf\u7a0b\uff09",id:"\u624b\u52a8\u4f20\u9012\u5f02\u6b65\u7ebf\u7a0b",level:3},{value:"5. \u81ea\u5b9a\u4e49 Span",id:"5-\u81ea\u5b9a\u4e49-span",level:2},{value:"\u521b\u5efa\u65b0 Span",id:"\u521b\u5efa\u65b0-span",level:3},{value:"\u4f7f\u7528\u6ce8\u89e3",id:"\u4f7f\u7528\u6ce8\u89e3",level:3},{value:"6. \u91c7\u6837\u7b56\u7565",id:"6-\u91c7\u6837\u7b56\u7565",level:2},{value:"\u56fa\u5b9a\u91c7\u6837\u7387",id:"\u56fa\u5b9a\u91c7\u6837\u7387",level:3},{value:"\u57fa\u4e8e\u901f\u7387\u7684\u91c7\u6837",id:"\u57fa\u4e8e\u901f\u7387\u7684\u91c7\u6837",level:3},{value:"\u81ea\u5b9a\u4e49\u91c7\u6837\u5668",id:"\u81ea\u5b9a\u4e49\u91c7\u6837\u5668",level:3},{value:"7. \u6570\u636e\u5b58\u50a8",id:"7-\u6570\u636e\u5b58\u50a8",level:2},{value:"\u5185\u5b58\u5b58\u50a8\uff08\u9ed8\u8ba4\uff09",id:"\u5185\u5b58\u5b58\u50a8\u9ed8\u8ba4",level:3},{value:"MySQL \u5b58\u50a8",id:"mysql-\u5b58\u50a8",level:3},{value:"Elasticsearch \u5b58\u50a8",id:"elasticsearch-\u5b58\u50a8",level:3},{value:"8. \u4e0e\u65e5\u5fd7\u7cfb\u7edf\u96c6\u6210",id:"8-\u4e0e\u65e5\u5fd7\u7cfb\u7edf\u96c6\u6210",level:2},{value:"Logback \u96c6\u6210",id:"logback-\u96c6\u6210",level:3},{value:"MDC \u4e0a\u4e0b\u6587",id:"mdc-\u4e0a\u4e0b\u6587",level:3},{value:"9. \u6027\u80fd\u5206\u6790",id:"9-\u6027\u80fd\u5206\u6790",level:2},{value:"\u67e5\u627e\u6162\u670d\u52a1",id:"\u67e5\u627e\u6162\u670d\u52a1",level:3},{value:"\u4f9d\u8d56\u5173\u7cfb\u5206\u6790",id:"\u4f9d\u8d56\u5173\u7cfb\u5206\u6790",level:3},{value:"10. \u4e0e\u5176\u4ed6\u8ffd\u8e2a\u7cfb\u7edf\u96c6\u6210",id:"10-\u4e0e\u5176\u4ed6\u8ffd\u8e2a\u7cfb\u7edf\u96c6\u6210",level:2},{value:"Brave",id:"brave",level:3},{value:"OpenTelemetry",id:"opentelemetry",level:3},{value:"Jaeger",id:"jaeger",level:3},{value:"11. \u5b9e\u6218\u793a\u4f8b",id:"11-\u5b9e\u6218\u793a\u4f8b",level:2},{value:"\u5b8c\u6574\u94fe\u8def\u8ffd\u8e2a",id:"\u5b8c\u6574\u94fe\u8def\u8ffd\u8e2a",level:3},{value:"12. \u6700\u4f73\u5b9e\u8df5",id:"12-\u6700\u4f73\u5b9e\u8df5",level:2},{value:"\u91c7\u6837\u7387\u914d\u7f6e",id:"\u91c7\u6837\u7387\u914d\u7f6e",level:3},{value:"Span \u547d\u540d",id:"span-\u547d\u540d",level:3},{value:"\u6807\u7b7e\u4f7f\u7528",id:"\u6807\u7b7e\u4f7f\u7528",level:3},{value:"\u5f02\u5e38\u8bb0\u5f55",id:"\u5f02\u5e38\u8bb0\u5f55",level:3},{value:"13. \u76d1\u63a7\u4e0e\u544a\u8b66",id:"13-\u76d1\u63a7\u4e0e\u544a\u8b66",level:2},{value:"\u5173\u952e\u6307\u6807",id:"\u5173\u952e\u6307\u6807",level:3},{value:"\u544a\u8b66\u89c4\u5219",id:"\u544a\u8b66\u89c4\u5219",level:3},{value:"14. \u5e38\u89c1\u95ee\u9898",id:"14-\u5e38\u89c1\u95ee\u9898",level:2},{value:"TraceId \u4e22\u5931",id:"traceid-\u4e22\u5931",level:3},{value:"\u6027\u80fd\u5f71\u54cd",id:"\u6027\u80fd\u5f71\u54cd",level:3},{value:"\u6570\u636e\u91cf\u8fc7\u5927",id:"\u6570\u636e\u91cf\u8fc7\u5927",level:3},{value:"15. \u603b\u7ed3",id:"15-\u603b\u7ed3",level:2}];function h(e){const n={a:"a",blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,s.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"sleuth-\u94fe\u8def\u8ffd\u8e2a",children:"Sleuth \u94fe\u8def\u8ffd\u8e2a"})}),"\n",(0,i.jsxs)(n.blockquote,{children:["\n",(0,i.jsxs)(n.p,{children:["[!TIP] > ",(0,i.jsx)(n.strong,{children:"\u5206\u5e03\u5f0f\u8ffd\u8e2a"}),": Spring Cloud Sleuth \u4e3a\u5206\u5e03\u5f0f\u7cfb\u7edf\u63d0\u4f9b\u94fe\u8def\u8ffd\u8e2a\u529f\u80fd\uff0c\u5e2e\u52a9\u7406\u89e3\u670d\u52a1\u95f4\u7684\u8c03\u7528\u5173\u7cfb\u548c\u6027\u80fd\u74f6\u9888\u3002"]}),"\n"]}),"\n",(0,i.jsxs)(n.blockquote,{children:["\n",(0,i.jsxs)(n.p,{children:["[!IMPORTANT]\n",(0,i.jsx)(n.strong,{children:"\u7248\u672c\u8bf4\u660e"}),"\uff1a\u5982\u679c\u4f60\u7684\u9879\u76ee\u662f ",(0,i.jsx)(n.strong,{children:"Spring Boot 3.x / Spring Cloud 2023.x"}),"\uff0c\u8bf7\u4f18\u5148\u4f7f\u7528 ",(0,i.jsx)(n.strong,{children:"Micrometer Tracing"}),"\uff08Sleuth \u5df2\u505c\u6b62\u6f14\u8fdb\uff09\u3002\u53c2\u8003\uff1a"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"/docs/springcloud/micrometer-tracing",children:"Micrometer Tracing \u94fe\u8def\u8ffd\u8e2a"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"/docs/springcloud/zipkin",children:"Zipkin \u8ffd\u8e2a"})}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"1-sleuth-\u7b80\u4ecb",children:"1. Sleuth \u7b80\u4ecb"}),"\n",(0,i.jsx)(n.h3,{id:"\u4ec0\u4e48\u662f-sleuth",children:"\u4ec0\u4e48\u662f Sleuth\uff1f"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Spring Cloud Sleuth"})," \u662f Spring Cloud \u7684\u5206\u5e03\u5f0f\u94fe\u8def\u8ffd\u8e2a\u89e3\u51b3\u65b9\u6848\uff0c\u517c\u5bb9 Zipkin\u3001HTrace \u7b49\u8ffd\u8e2a\u7cfb\u7edf\u3002"]}),"\n",(0,i.jsx)(n.h3,{id:"\u89e3\u51b3\u7684\u95ee\u9898",children:"\u89e3\u51b3\u7684\u95ee\u9898"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"\u7528\u6237\u8bf7\u6c42 \u2192 Gateway \u2192 \u8ba2\u5355\u670d\u52a1 \u2192 \u7528\u6237\u670d\u52a1 \u2192 \u6570\u636e\u5e93\n                             \u2193\n                          \u5e93\u5b58\u670d\u52a1 \u2192 \u6570\u636e\u5e93\n                             \u2193\n                          \u652f\u4ed8\u670d\u52a1 \u2192 \u7b2c\u4e09\u65b9\u652f\u4ed8\n"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"\u5982\u4f55\u8ffd\u8e2a\u4e00\u4e2a\u8bf7\u6c42\u7684\u5b8c\u6574\u94fe\u8def\uff1f"}),"\n",(0,i.jsx)(n.li,{children:"\u54ea\u4e2a\u670d\u52a1\u51fa\u73b0\u4e86\u6027\u80fd\u95ee\u9898\uff1f"}),"\n",(0,i.jsx)(n.li,{children:"\u670d\u52a1\u95f4\u7684\u4f9d\u8d56\u5173\u7cfb\u662f\u4ec0\u4e48\uff1f"}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"\u6838\u5fc3\u6982\u5ff5",children:"\u6838\u5fc3\u6982\u5ff5"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Trace"})," - \u4e00\u6b21\u5b8c\u6574\u7684\u8bf7\u6c42\u94fe\u8def\uff0c\u5305\u542b\u591a\u4e2a Span"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Span"})," - \u4e00\u4e2a\u670d\u52a1\u8c03\u7528\uff0c\u662f Trace \u7684\u57fa\u672c\u5355\u4f4d"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Trace ID"})," - \u5168\u5c40\u552f\u4e00\u7684\u8ffd\u8e2a ID"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Span ID"})," - \u5f53\u524d Span \u7684 ID"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Parent ID"})," - \u7236 Span \u7684 ID"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"2-\u5feb\u901f\u5f00\u59cb",children:"2. \u5feb\u901f\u5f00\u59cb"}),"\n",(0,i.jsx)(n.h3,{id:"\u6dfb\u52a0\u4f9d\u8d56",children:"\u6dfb\u52a0\u4f9d\u8d56"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-xml",children:"<dependency>\n    <groupId>org.springframework.cloud</groupId>\n    <artifactId>spring-cloud-starter-sleuth</artifactId>\n</dependency>\n"})}),"\n",(0,i.jsx)(n.h3,{id:"\u81ea\u52a8\u914d\u7f6e",children:"\u81ea\u52a8\u914d\u7f6e"}),"\n",(0,i.jsx)(n.p,{children:"Sleuth \u4f1a\u81ea\u52a8\uff1a"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"\u4e3a\u6bcf\u4e2a\u8bf7\u6c42\u751f\u6210 Trace ID"}),"\n",(0,i.jsx)(n.li,{children:"\u5728\u65e5\u5fd7\u4e2d\u6dfb\u52a0\u8ffd\u8e2a\u4fe1\u606f"}),"\n",(0,i.jsx)(n.li,{children:"\u5728\u670d\u52a1\u95f4\u4f20\u9012\u8ffd\u8e2a\u4fe1\u606f"}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"\u67e5\u770b\u65e5\u5fd7",children:"\u67e5\u770b\u65e5\u5fd7"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"[\u670d\u52a1\u540d,TraceId,SpanId,\u662f\u5426\u8f93\u51fa\u5230\u8ffd\u8e2a\u7cfb\u7edf]\n[order-service,f8a9c5d2b1e3a456,a1b2c3d4e5f6g7h8,true] \u5904\u7406\u8ba2\u5355\u8bf7\u6c42\n"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"\u670d\u52a1\u540d"}),": order-service"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"TraceId"}),": f8a9c5d2b1e3a456"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"SpanId"}),": a1b2c3d4e5f6g7h8"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"\u662f\u5426\u8f93\u51fa"}),": true"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"3-\u96c6\u6210-zipkin",children:"3. \u96c6\u6210 Zipkin"}),"\n",(0,i.jsx)(n.h3,{id:"\u4ec0\u4e48\u662f-zipkin",children:"\u4ec0\u4e48\u662f Zipkin\uff1f"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Zipkin"})," \u662f\u4e00\u4e2a\u5206\u5e03\u5f0f\u8ffd\u8e2a\u7cfb\u7edf\uff0c\u7528\u4e8e\u6536\u96c6\u3001\u5b58\u50a8\u548c\u5c55\u793a\u8ffd\u8e2a\u6570\u636e\u3002"]}),"\n",(0,i.jsx)(n.h3,{id:"\u542f\u52a8-zipkin-server",children:"\u542f\u52a8 Zipkin Server"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"# \u4e0b\u8f7d Zipkin\ncurl -sSL https://zipkin.io/quickstart.sh | bash -s\n\n# \u542f\u52a8\njava -jar zipkin.jar\n"})}),"\n",(0,i.jsxs)(n.p,{children:["\u8bbf\u95ee\uff1a",(0,i.jsx)(n.code,{children:"http://localhost:9411"})]}),"\n",(0,i.jsx)(n.h3,{id:"\u6dfb\u52a0\u4f9d\u8d56-1",children:"\u6dfb\u52a0\u4f9d\u8d56"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-xml",children:"<dependency>\n    <groupId>org.springframework.cloud</groupId>\n    <artifactId>spring-cloud-starter-zipkin</artifactId>\n</dependency>\n"})}),"\n",(0,i.jsx)(n.h3,{id:"\u914d\u7f6e",children:"\u914d\u7f6e"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"spring:\n  application:\n    name: order-service\n  zipkin:\n    # Zipkin \u670d\u52a1\u5730\u5740\n    base-url: http://localhost:9411\n    # \u53d1\u9001\u65b9\u5f0f\uff1aweb(HTTP) \u6216 rabbit(RabbitMQ)\n    sender:\n      type: web\n  sleuth:\n    sampler:\n      # \u91c7\u6837\u7387\uff080.0-1.0\uff09\n      probability: 1.0\n"})}),"\n",(0,i.jsx)(n.h2,{id:"4-\u8ffd\u8e2a\u4fe1\u606f\u4f20\u9012",children:"4. \u8ffd\u8e2a\u4fe1\u606f\u4f20\u9012"}),"\n",(0,i.jsx)(n.h3,{id:"http-\u8bf7\u6c42\u81ea\u52a8",children:"HTTP \u8bf7\u6c42\uff08\u81ea\u52a8\uff09"}),"\n",(0,i.jsx)(n.p,{children:"Sleuth \u4f1a\u81ea\u52a8\u5728 HTTP \u8bf7\u6c42\u5934\u4e2d\u6dfb\u52a0\u8ffd\u8e2a\u4fe1\u606f\uff1a"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"X-B3-TraceId: f8a9c5d2b1e3a456\nX-B3-SpanId: a1b2c3d4e5f6g7h8\nX-B3-ParentSpanId: 1234567890abcdef\nX-B3-Sampled: 1\n"})}),"\n",(0,i.jsx)(n.h3,{id:"\u6d88\u606f\u961f\u5217rabbitmqkafka",children:"\u6d88\u606f\u961f\u5217\uff08RabbitMQ/Kafka\uff09"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-xml",children:"<dependency>\n    <groupId>org.springframework.cloud</groupId>\n    <artifactId>spring-cloud-sleuth-zipkin</artifactId>\n</dependency>\n<dependency>\n    <groupId>org.springframework.amqp</groupId>\n    <artifactId>spring-rabbit</artifactId>\n</dependency>\n"})}),"\n",(0,i.jsx)(n.p,{children:"Sleuth \u4f1a\u81ea\u52a8\u5728\u6d88\u606f\u5934\u4e2d\u4f20\u9012\u8ffd\u8e2a\u4fe1\u606f\u3002"}),"\n",(0,i.jsx)(n.h3,{id:"\u624b\u52a8\u4f20\u9012\u5f02\u6b65\u7ebf\u7a0b",children:"\u624b\u52a8\u4f20\u9012\uff08\u5f02\u6b65\u7ebf\u7a0b\uff09"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:'@Service\npublic class OrderService {\n\n    @Autowired\n    private Tracer tracer;\n\n    @Autowired\n    private ExecutorService executorService;\n\n    public void processOrder() {\n        // \u83b7\u53d6\u5f53\u524d Span\n        Span span = tracer.currentSpan();\n\n        executorService.submit(() -> {\n            // \u5728\u65b0\u7ebf\u7a0b\u4e2d\u7ee7\u7eed\u8ffd\u8e2a\n            try (Tracer.SpanInScope ws = tracer.withSpanInScope(span)) {\n                // \u4e1a\u52a1\u903b\u8f91\n                System.out.println("\u5904\u7406\u8ba2\u5355");\n            }\n        });\n    }\n}\n'})}),"\n",(0,i.jsx)(n.h2,{id:"5-\u81ea\u5b9a\u4e49-span",children:"5. \u81ea\u5b9a\u4e49 Span"}),"\n",(0,i.jsx)(n.h3,{id:"\u521b\u5efa\u65b0-span",children:"\u521b\u5efa\u65b0 Span"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:'@Service\npublic class UserService {\n\n    @Autowired\n    private Tracer tracer;\n\n    public User getUser(Long id) {\n        // \u521b\u5efa\u65b0 Span\n        Span span = tracer.nextSpan().name("getUser").start();\n\n        try (Tracer.SpanInScope ws = tracer.withSpanInScope(span)) {\n            // \u6dfb\u52a0\u6807\u7b7e\n            span.tag("userId", String.valueOf(id));\n            span.tag("method", "GET");\n\n            // \u6dfb\u52a0\u4e8b\u4ef6\n            span.event("\u67e5\u8be2\u6570\u636e\u5e93");\n\n            // \u4e1a\u52a1\u903b\u8f91\n            User user = userRepository.findById(id);\n\n            span.event("\u67e5\u8be2\u5b8c\u6210");\n\n            return user;\n        } finally {\n            span.end();\n        }\n    }\n}\n'})}),"\n",(0,i.jsx)(n.h3,{id:"\u4f7f\u7528\u6ce8\u89e3",children:"\u4f7f\u7528\u6ce8\u89e3"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:'@Service\npublic class OrderService {\n\n    @NewSpan(name = "createOrder")\n    public Order createOrder(OrderRequest request) {\n        // \u4e1a\u52a1\u903b\u8f91\n        return new Order();\n    }\n\n    @ContinueSpan\n    public void updateOrder(@SpanTag("orderId") Long id, Order order) {\n        // \u4e1a\u52a1\u903b\u8f91\n    }\n}\n'})}),"\n",(0,i.jsx)(n.h2,{id:"6-\u91c7\u6837\u7b56\u7565",children:"6. \u91c7\u6837\u7b56\u7565"}),"\n",(0,i.jsx)(n.h3,{id:"\u56fa\u5b9a\u91c7\u6837\u7387",children:"\u56fa\u5b9a\u91c7\u6837\u7387"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"spring:\n  sleuth:\n    sampler:\n      # \u91c7\u6837\u7387\uff1a1.0 \u8868\u793a 100%\uff0c0.1 \u8868\u793a 10%\n      probability: 0.1\n"})}),"\n",(0,i.jsx)(n.h3,{id:"\u57fa\u4e8e\u901f\u7387\u7684\u91c7\u6837",children:"\u57fa\u4e8e\u901f\u7387\u7684\u91c7\u6837"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"spring:\n  sleuth:\n    sampler:\n      # \u6bcf\u79d2\u91c7\u6837\u7684\u8bf7\u6c42\u6570\n      rate: 10\n"})}),"\n",(0,i.jsx)(n.h3,{id:"\u81ea\u5b9a\u4e49\u91c7\u6837\u5668",children:"\u81ea\u5b9a\u4e49\u91c7\u6837\u5668"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:'@Configuration\npublic class SamplerConfig {\n\n    @Bean\n    public Sampler customSampler() {\n        return new Sampler() {\n            @Override\n            public boolean isSampled(long traceId) {\n                // \u81ea\u5b9a\u4e49\u91c7\u6837\u903b\u8f91\n                // \u4f8b\u5982\uff1a\u53ea\u91c7\u6837\u7279\u5b9a\u7528\u6237\u7684\u8bf7\u6c42\n                return shouldSample();\n            }\n\n            private boolean shouldSample() {\n                // \u4ece\u8bf7\u6c42\u4e0a\u4e0b\u6587\u83b7\u53d6\u7528\u6237\u4fe1\u606f\n                String userId = UserContext.getUserId();\n                return "admin".equals(userId);\n            }\n        };\n    }\n}\n'})}),"\n",(0,i.jsx)(n.h2,{id:"7-\u6570\u636e\u5b58\u50a8",children:"7. \u6570\u636e\u5b58\u50a8"}),"\n",(0,i.jsx)(n.h3,{id:"\u5185\u5b58\u5b58\u50a8\u9ed8\u8ba4",children:"\u5185\u5b58\u5b58\u50a8\uff08\u9ed8\u8ba4\uff09"}),"\n",(0,i.jsx)(n.p,{children:"\u9002\u5408\u5f00\u53d1\u73af\u5883\uff0c\u91cd\u542f\u540e\u6570\u636e\u4e22\u5931\u3002"}),"\n",(0,i.jsx)(n.h3,{id:"mysql-\u5b58\u50a8",children:"MySQL \u5b58\u50a8"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"# Zipkin Server \u914d\u7f6e\nstorage:\n  type: mysql\n  mysql:\n    host: localhost\n    port: 3306\n    username: root\n    password: password\n    db: zipkin\n"})}),"\n",(0,i.jsx)(n.h3,{id:"elasticsearch-\u5b58\u50a8",children:"Elasticsearch \u5b58\u50a8"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"# Zipkin Server \u914d\u7f6e\nstorage:\n  type: elasticsearch\n  elasticsearch:\n    hosts: http://localhost:9200\n    index: zipkin\n"})}),"\n",(0,i.jsx)(n.h2,{id:"8-\u4e0e\u65e5\u5fd7\u7cfb\u7edf\u96c6\u6210",children:"8. \u4e0e\u65e5\u5fd7\u7cfb\u7edf\u96c6\u6210"}),"\n",(0,i.jsx)(n.h3,{id:"logback-\u96c6\u6210",children:"Logback \u96c6\u6210"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-xml",children:'\x3c!-- logback-spring.xml --\x3e\n<configuration>\n    <include resource="org/springframework/boot/logging/logback/defaults.xml"/>\n\n    <springProperty scope="context" name="springAppName" source="spring.application.name"/>\n\n    <appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender">\n        <encoder>\n            <pattern>\n                %d{yyyy-MM-dd HH:mm:ss.SSS} [${springAppName},%X{traceId},%X{spanId}] %-5level %logger{36} - %msg%n\n            </pattern>\n        </encoder>\n    </appender>\n\n    <root level="INFO">\n        <appender-ref ref="CONSOLE"/>\n    </root>\n</configuration>\n'})}),"\n",(0,i.jsx)(n.h3,{id:"mdc-\u4e0a\u4e0b\u6587",children:"MDC \u4e0a\u4e0b\u6587"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:'@Service\npublic class OrderService {\n\n    private static final Logger log = LoggerFactory.getLogger(OrderService.class);\n\n    public void createOrder() {\n        // Sleuth \u4f1a\u81ea\u52a8\u5c06 traceId \u548c spanId \u653e\u5165 MDC\n        log.info("\u521b\u5efa\u8ba2\u5355"); // \u65e5\u5fd7\u4f1a\u5305\u542b traceId \u548c spanId\n    }\n}\n'})}),"\n",(0,i.jsx)(n.h2,{id:"9-\u6027\u80fd\u5206\u6790",children:"9. \u6027\u80fd\u5206\u6790"}),"\n",(0,i.jsx)(n.h3,{id:"\u67e5\u627e\u6162\u670d\u52a1",children:"\u67e5\u627e\u6162\u670d\u52a1"}),"\n",(0,i.jsx)(n.p,{children:"\u901a\u8fc7 Zipkin UI \u53ef\u4ee5\uff1a"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"\u67e5\u770b\u5b8c\u6574\u7684\u8c03\u7528\u94fe\u8def"}),"\n",(0,i.jsx)(n.li,{children:"\u5206\u6790\u6bcf\u4e2a\u670d\u52a1\u7684\u8017\u65f6"}),"\n",(0,i.jsx)(n.li,{children:"\u627e\u51fa\u6027\u80fd\u74f6\u9888"}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"\u4f9d\u8d56\u5173\u7cfb\u5206\u6790",children:"\u4f9d\u8d56\u5173\u7cfb\u5206\u6790"}),"\n",(0,i.jsx)(n.p,{children:"Zipkin \u7684 Dependencies \u9875\u9762\u5c55\u793a\uff1a"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"\u670d\u52a1\u95f4\u7684\u8c03\u7528\u5173\u7cfb"}),"\n",(0,i.jsx)(n.li,{children:"\u8c03\u7528\u9891\u7387"}),"\n",(0,i.jsx)(n.li,{children:"\u9519\u8bef\u7387"}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"10-\u4e0e\u5176\u4ed6\u8ffd\u8e2a\u7cfb\u7edf\u96c6\u6210",children:"10. \u4e0e\u5176\u4ed6\u8ffd\u8e2a\u7cfb\u7edf\u96c6\u6210"}),"\n",(0,i.jsx)(n.h3,{id:"brave",children:"Brave"}),"\n",(0,i.jsx)(n.p,{children:"Sleuth \u5e95\u5c42\u4f7f\u7528 Brave \u5b9e\u73b0\u8ffd\u8e2a\uff1a"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:"@Autowired\nprivate Tracer tracer;\n\n@Autowired\nprivate brave.Tracer braveTracer;\n"})}),"\n",(0,i.jsx)(n.h3,{id:"opentelemetry",children:"OpenTelemetry"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-xml",children:"<dependency>\n    <groupId>io.opentelemetry</groupId>\n    <artifactId>opentelemetry-spring-boot-starter</artifactId>\n</dependency>\n"})}),"\n",(0,i.jsx)(n.h3,{id:"jaeger",children:"Jaeger"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-xml",children:"<dependency>\n    <groupId>io.opentracing.contrib</groupId>\n    <artifactId>opentracing-spring-jaeger-cloud-starter</artifactId>\n</dependency>\n"})}),"\n",(0,i.jsx)(n.h2,{id:"11-\u5b9e\u6218\u793a\u4f8b",children:"11. \u5b9e\u6218\u793a\u4f8b"}),"\n",(0,i.jsx)(n.h3,{id:"\u5b8c\u6574\u94fe\u8def\u8ffd\u8e2a",children:"\u5b8c\u6574\u94fe\u8def\u8ffd\u8e2a"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:'// Gateway\n@RestController\npublic class GatewayController {\n    @GetMapping("/api/orders/{id}")\n    public Order getOrder(@PathVariable Long id) {\n        // Sleuth \u81ea\u52a8\u751f\u6210 TraceId\n        return orderClient.getOrder(id);\n    }\n}\n\n// Order Service\n@Service\npublic class OrderService {\n\n    @Autowired\n    private UserClient userClient;\n\n    @Autowired\n    private InventoryClient inventoryClient;\n\n    @NewSpan("getOrder")\n    public Order getOrder(Long id) {\n        Order order = orderRepository.findById(id);\n\n        // \u8c03\u7528\u7528\u6237\u670d\u52a1\uff08\u81ea\u52a8\u5173\u8054\u5230\u540c\u4e00\u4e2a Trace\uff09\n        User user = userClient.getUser(order.getUserId());\n\n        // \u8c03\u7528\u5e93\u5b58\u670d\u52a1\n        Inventory inventory = inventoryClient.getInventory(order.getProductId());\n\n        return order;\n    }\n}\n'})}),"\n",(0,i.jsx)(n.p,{children:"\u5728 Zipkin \u4e2d\u53ef\u4ee5\u770b\u5230\u5b8c\u6574\u7684\u8c03\u7528\u94fe\uff1a"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"Gateway (100ms)\n  \u2514\u2500 Order Service (80ms)\n       \u251c\u2500 User Service (30ms)\n       \u2514\u2500 Inventory Service (50ms)\n"})}),"\n",(0,i.jsx)(n.h2,{id:"12-\u6700\u4f73\u5b9e\u8df5",children:"12. \u6700\u4f73\u5b9e\u8df5"}),"\n",(0,i.jsx)(n.h3,{id:"\u91c7\u6837\u7387\u914d\u7f6e",children:"\u91c7\u6837\u7387\u914d\u7f6e"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"\u751f\u4ea7\u73af\u5883"}),": 0.01 - 0.1\uff081%-10%\uff09"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"\u6d4b\u8bd5\u73af\u5883"}),": 0.5 - 1.0\uff0850%-100%\uff09"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"\u5f00\u53d1\u73af\u5883"}),": 1.0\uff08100%\uff09"]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"span-\u547d\u540d",children:"Span \u547d\u540d"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"\u4f7f\u7528\u6709\u610f\u4e49\u7684\u540d\u79f0"}),"\n",(0,i.jsxs)(n.li,{children:["\u5305\u542b\u64cd\u4f5c\u7c7b\u578b\uff1a",(0,i.jsx)(n.code,{children:"getUserById"}),", ",(0,i.jsx)(n.code,{children:"createOrder"})]}),"\n",(0,i.jsxs)(n.li,{children:["\u907f\u514d\u4f7f\u7528\u52a8\u6001\u503c\uff1a\u274c ",(0,i.jsx)(n.code,{children:"getUser_123"})]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"\u6807\u7b7e\u4f7f\u7528",children:"\u6807\u7b7e\u4f7f\u7528"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:'span.tag("http.method", "GET");\nspan.tag("http.path", "/api/users/1");\nspan.tag("http.status_code", "200");\nspan.tag("userId", "123");\n'})}),"\n",(0,i.jsx)(n.h3,{id:"\u5f02\u5e38\u8bb0\u5f55",children:"\u5f02\u5e38\u8bb0\u5f55"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:'try {\n    // \u4e1a\u52a1\u903b\u8f91\n} catch (Exception e) {\n    span.tag("error", "true");\n    span.tag("error.message", e.getMessage());\n    throw e;\n}\n'})}),"\n",(0,i.jsx)(n.h2,{id:"13-\u76d1\u63a7\u4e0e\u544a\u8b66",children:"13. \u76d1\u63a7\u4e0e\u544a\u8b66"}),"\n",(0,i.jsx)(n.h3,{id:"\u5173\u952e\u6307\u6807",children:"\u5173\u952e\u6307\u6807"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"\u54cd\u5e94\u65f6\u95f4"})," - P50, P95, P99"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"\u9519\u8bef\u7387"})," - \u5404\u670d\u52a1\u7684\u9519\u8bef\u7387"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"\u8c03\u7528\u91cf"})," - \u5404\u670d\u52a1\u7684 QPS"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"\u4f9d\u8d56\u5173\u7cfb"})," - \u670d\u52a1\u95f4\u7684\u4f9d\u8d56\u56fe"]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"\u544a\u8b66\u89c4\u5219",children:"\u544a\u8b66\u89c4\u5219"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"\u54cd\u5e94\u65f6\u95f4\u8d85\u8fc7\u9608\u503c"}),"\n",(0,i.jsx)(n.li,{children:"\u9519\u8bef\u7387\u8d85\u8fc7\u9608\u503c"}),"\n",(0,i.jsx)(n.li,{children:"\u670d\u52a1\u4e0d\u53ef\u7528"}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"14-\u5e38\u89c1\u95ee\u9898",children:"14. \u5e38\u89c1\u95ee\u9898"}),"\n",(0,i.jsx)(n.h3,{id:"traceid-\u4e22\u5931",children:"TraceId \u4e22\u5931"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"\u539f\u56e0"}),":"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"\u5f02\u6b65\u7ebf\u7a0b\u672a\u4f20\u9012\u4e0a\u4e0b\u6587"}),"\n",(0,i.jsx)(n.li,{children:"\u4f7f\u7528\u4e86\u4e0d\u652f\u6301\u7684 HTTP \u5ba2\u6237\u7aef"}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"\u89e3\u51b3"}),":"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\u4f7f\u7528 ",(0,i.jsx)(n.code,{children:"tracer.withSpanInScope()"})]}),"\n",(0,i.jsx)(n.li,{children:"\u4f7f\u7528 Sleuth \u652f\u6301\u7684\u5ba2\u6237\u7aef"}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"\u6027\u80fd\u5f71\u54cd",children:"\u6027\u80fd\u5f71\u54cd"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"\u4f18\u5316"}),":"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"\u964d\u4f4e\u91c7\u6837\u7387"}),"\n",(0,i.jsx)(n.li,{children:"\u4f7f\u7528\u5f02\u6b65\u53d1\u9001"}),"\n",(0,i.jsx)(n.li,{children:"\u4f7f\u7528\u6d88\u606f\u961f\u5217\u4f20\u8f93\u6570\u636e"}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"\u6570\u636e\u91cf\u8fc7\u5927",children:"\u6570\u636e\u91cf\u8fc7\u5927"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"\u89e3\u51b3"}),":"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"\u964d\u4f4e\u91c7\u6837\u7387"}),"\n",(0,i.jsx)(n.li,{children:"\u8bbe\u7f6e\u6570\u636e\u4fdd\u7559\u65f6\u95f4"}),"\n",(0,i.jsx)(n.li,{children:"\u4f7f\u7528 Elasticsearch \u5b58\u50a8"}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"15-\u603b\u7ed3",children:"15. \u603b\u7ed3"}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"\u529f\u80fd"}),(0,i.jsx)(n.th,{children:"\u8bf4\u660e"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"\u94fe\u8def\u8ffd\u8e2a"}),(0,i.jsx)(n.td,{children:"\u8ffd\u8e2a\u8bf7\u6c42\u7684\u5b8c\u6574\u8c03\u7528\u94fe"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"\u6027\u80fd\u5206\u6790"}),(0,i.jsx)(n.td,{children:"\u5206\u6790\u670d\u52a1\u54cd\u5e94\u65f6\u95f4"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"\u4f9d\u8d56\u5173\u7cfb"}),(0,i.jsx)(n.td,{children:"\u5c55\u793a\u670d\u52a1\u95f4\u7684\u4f9d\u8d56"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"\u65e5\u5fd7\u5173\u8054"}),(0,i.jsx)(n.td,{children:"\u5c06\u65e5\u5fd7\u4e0e\u8ffd\u8e2a\u5173\u8054"})]})]})]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"\u5173\u952e\u8981\u70b9"}),"\uff1a"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Sleuth \u63d0\u4f9b\u81ea\u52a8\u5316\u7684\u94fe\u8def\u8ffd\u8e2a"}),"\n",(0,i.jsx)(n.li,{children:"\u96c6\u6210 Zipkin \u53ef\u89c6\u5316\u8ffd\u8e2a\u6570\u636e"}),"\n",(0,i.jsx)(n.li,{children:"\u5408\u7406\u8bbe\u7f6e\u91c7\u6837\u7387\u5e73\u8861\u6027\u80fd\u548c\u76d1\u63a7"}),"\n",(0,i.jsx)(n.li,{children:"\u4f7f\u7528\u8ffd\u8e2a\u6570\u636e\u5206\u6790\u6027\u80fd\u74f6\u9888"}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"\u4e0b\u4e00\u6b65"}),"\uff1a\u63a2\u7d22 ",(0,i.jsx)(n.a,{href:"/docs/springcloud-alibaba",children:"Spring Cloud Alibaba"})]})]})}function o(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(h,{...e})}):h(e)}},48885:(e,n,r)=>{r.d(n,{R:()=>d,x:()=>c});var l=r(99378);const i={},s=l.createContext(i);function d(e){const n=l.useContext(s);return l.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:d(e.components),l.createElement(s.Provider,{value:n},e.children)}}}]);