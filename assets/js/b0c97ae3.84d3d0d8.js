"use strict";(globalThis.webpackChunkto_lib_github_io=globalThis.webpackChunkto_lib_github_io||[]).push([[81753],{29102:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>o,contentTitle:()=>d,default:()=>c,frontMatter:()=>l,metadata:()=>r,toc:()=>i});const r=JSON.parse('{"id":"ai/model-merging","title":"\ud83d\udd00 \u6a21\u578b\u5408\u5e76","description":"\u6a21\u578b\u5408\u5e76\uff08Model Merging\uff09\u662f\u5c06\u591a\u4e2a\u5fae\u8c03\u6a21\u578b\u7684\u80fd\u529b\u7ec4\u5408\u5230\u4e00\u4e2a\u6a21\u578b\u4e2d\u7684\u6280\u672f\uff0c\u65e0\u9700\u989d\u5916\u8bad\u7ec3\u5373\u53ef\u83b7\u5f97\u591a\u79cd\u80fd\u529b\u3002","source":"@site/docs/ai/model-merging.md","sourceDirName":"ai","slug":"/ai/model-merging","permalink":"/docs/ai/model-merging","draft":false,"unlisted":false,"editUrl":"https://github.com/to-lib/to-lib.github.io/tree/main/docs/ai/model-merging.md","tags":[],"version":"current","sidebarPosition":38,"frontMatter":{"sidebar_position":38,"title":"\ud83d\udd00 \u6a21\u578b\u5408\u5e76"}}');var s=t(22714),a=t(48885);const l={sidebar_position:38,title:"\ud83d\udd00 \u6a21\u578b\u5408\u5e76"},d="\u6a21\u578b\u5408\u5e76",o={},i=[{value:"\u4e3a\u4ec0\u4e48\u8981\u5408\u5e76\u6a21\u578b\uff1f",id:"\u4e3a\u4ec0\u4e48\u8981\u5408\u5e76\u6a21\u578b",level:2},{value:"\u5408\u5e76\u65b9\u6cd5",id:"\u5408\u5e76\u65b9\u6cd5",level:2},{value:"\u4f7f\u7528 mergekit",id:"\u4f7f\u7528-mergekit",level:2},{value:"\u7ebf\u6027\u5408\u5e76",id:"\u7ebf\u6027\u5408\u5e76",level:3},{value:"SLERP \u5408\u5e76",id:"slerp-\u5408\u5e76",level:3},{value:"TIES \u5408\u5e76",id:"ties-\u5408\u5e76",level:3},{value:"DARE \u5408\u5e76",id:"dare-\u5408\u5e76",level:3},{value:"Python \u5b9e\u73b0",id:"python-\u5b9e\u73b0",level:2},{value:"\u7ebf\u6027\u5408\u5e76",id:"\u7ebf\u6027\u5408\u5e76-1",level:3},{value:"SLERP \u5408\u5e76",id:"slerp-\u5408\u5e76-1",level:3},{value:"Task Arithmetic",id:"task-arithmetic",level:3},{value:"LoRA \u5408\u5e76",id:"lora-\u5408\u5e76",level:2},{value:"\u5408\u5e76\u6548\u679c\u8bc4\u4f30",id:"\u5408\u5e76\u6548\u679c\u8bc4\u4f30",level:2},{value:"\u6700\u4f73\u5b9e\u8df5",id:"\u6700\u4f73\u5b9e\u8df5",level:2},{value:"\u5ef6\u4f38\u9605\u8bfb",id:"\u5ef6\u4f38\u9605\u8bfb",level:2}];function h(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,a.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"\u6a21\u578b\u5408\u5e76",children:"\u6a21\u578b\u5408\u5e76"})}),"\n",(0,s.jsx)(n.p,{children:"\u6a21\u578b\u5408\u5e76\uff08Model Merging\uff09\u662f\u5c06\u591a\u4e2a\u5fae\u8c03\u6a21\u578b\u7684\u80fd\u529b\u7ec4\u5408\u5230\u4e00\u4e2a\u6a21\u578b\u4e2d\u7684\u6280\u672f\uff0c\u65e0\u9700\u989d\u5916\u8bad\u7ec3\u5373\u53ef\u83b7\u5f97\u591a\u79cd\u80fd\u529b\u3002"}),"\n",(0,s.jsx)(n.h2,{id:"\u4e3a\u4ec0\u4e48\u8981\u5408\u5e76\u6a21\u578b",children:"\u4e3a\u4ec0\u4e48\u8981\u5408\u5e76\u6a21\u578b\uff1f"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"\u6a21\u578b A\uff08\u64c5\u957f\u4ee3\u7801\uff09\u2500\u2500\u2510\n\u6a21\u578b B\uff08\u64c5\u957f\u6570\u5b66\uff09\u2500\u2500\u253c\u2500\u2500> \u5408\u5e76 \u2500\u2500> \u65b0\u6a21\u578b\uff08\u4ee3\u7801+\u6570\u5b66+\u5199\u4f5c\uff09\n\u6a21\u578b C\uff08\u64c5\u957f\u5199\u4f5c\uff09\u2500\u2500\u2518\n"})}),"\n",(0,s.jsx)(n.h2,{id:"\u5408\u5e76\u65b9\u6cd5",children:"\u5408\u5e76\u65b9\u6cd5"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"\u65b9\u6cd5"}),(0,s.jsx)(n.th,{children:"\u539f\u7406"}),(0,s.jsx)(n.th,{children:"\u6548\u679c"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Linear"}),(0,s.jsx)(n.td,{children:"\u7ebf\u6027\u63d2\u503c"}),(0,s.jsx)(n.td,{children:"\u7b80\u5355\u6709\u6548"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"SLERP"}),(0,s.jsx)(n.td,{children:"\u7403\u9762\u63d2\u503c"}),(0,s.jsx)(n.td,{children:"\u66f4\u5e73\u6ed1"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"TIES"}),(0,s.jsx)(n.td,{children:"\u4fee\u526a+\u5408\u5e76"}),(0,s.jsx)(n.td,{children:"\u51cf\u5c11\u51b2\u7a81"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"DARE"}),(0,s.jsx)(n.td,{children:"\u968f\u673a\u4e22\u5f03+\u7f29\u653e"}),(0,s.jsx)(n.td,{children:"\u4fdd\u7559\u591a\u6837\u6027"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Task Arithmetic"}),(0,s.jsx)(n.td,{children:"\u4efb\u52a1\u5411\u91cf\u8fd0\u7b97"}),(0,s.jsx)(n.td,{children:"\u7075\u6d3b\u7ec4\u5408"})]})]})]}),"\n",(0,s.jsx)(n.h2,{id:"\u4f7f\u7528-mergekit",children:"\u4f7f\u7528 mergekit"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"pip install mergekit\n"})}),"\n",(0,s.jsx)(n.h3,{id:"\u7ebf\u6027\u5408\u5e76",children:"\u7ebf\u6027\u5408\u5e76"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:"# merge_config.yaml\nmerge_method: linear\nslices:\n  - sources:\n      - model: model_a\n        layer_range: [0, 32]\n      - model: model_b\n        layer_range: [0, 32]\n    merge_method: linear\nparameters:\n  weight: 0.5  # \u5404 50%\nbase_model: model_a\ndtype: float16\n"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"mergekit-yaml merge_config.yaml ./merged_model\n"})}),"\n",(0,s.jsx)(n.h3,{id:"slerp-\u5408\u5e76",children:"SLERP \u5408\u5e76"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:"merge_method: slerp\nslices:\n  - sources:\n      - model: model_a\n        layer_range: [0, 32]\n      - model: model_b\n        layer_range: [0, 32]\nparameters:\n  t: 0.5  # \u63d2\u503c\u53c2\u6570\nbase_model: model_a\ndtype: float16\n"})}),"\n",(0,s.jsx)(n.h3,{id:"ties-\u5408\u5e76",children:"TIES \u5408\u5e76"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:"merge_method: ties\nslices:\n  - sources:\n      - model: model_a\n        layer_range: [0, 32]\n        parameters:\n          density: 0.5  # \u4fdd\u7559 50% \u7684\u53c2\u6570\n          weight: 1.0\n      - model: model_b\n        layer_range: [0, 32]\n        parameters:\n          density: 0.5\n          weight: 1.0\nbase_model: base_model\ndtype: float16\n"})}),"\n",(0,s.jsx)(n.h3,{id:"dare-\u5408\u5e76",children:"DARE \u5408\u5e76"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:"merge_method: dare_ties\nslices:\n  - sources:\n      - model: model_a\n        layer_range: [0, 32]\n        parameters:\n          density: 0.5\n          weight: 1.0\n      - model: model_b\n        layer_range: [0, 32]\n        parameters:\n          density: 0.5\n          weight: 1.0\nbase_model: base_model\ndtype: float16\n"})}),"\n",(0,s.jsx)(n.h2,{id:"python-\u5b9e\u73b0",children:"Python \u5b9e\u73b0"}),"\n",(0,s.jsx)(n.h3,{id:"\u7ebf\u6027\u5408\u5e76-1",children:"\u7ebf\u6027\u5408\u5e76"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:'import torch\nfrom transformers import AutoModelForCausalLM\n\ndef linear_merge(model_a_path: str, model_b_path: str, alpha: float = 0.5):\n    """\u7ebf\u6027\u5408\u5e76\u4e24\u4e2a\u6a21\u578b"""\n    model_a = AutoModelForCausalLM.from_pretrained(model_a_path)\n    model_b = AutoModelForCausalLM.from_pretrained(model_b_path)\n    \n    merged_state_dict = {}\n    \n    for key in model_a.state_dict().keys():\n        merged_state_dict[key] = (\n            alpha * model_a.state_dict()[key] +\n            (1 - alpha) * model_b.state_dict()[key]\n        )\n    \n    model_a.load_state_dict(merged_state_dict)\n    return model_a\n\n# \u4f7f\u7528\nmerged = linear_merge("model_a", "model_b", alpha=0.6)\nmerged.save_pretrained("./merged_model")\n'})}),"\n",(0,s.jsx)(n.h3,{id:"slerp-\u5408\u5e76-1",children:"SLERP \u5408\u5e76"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:'import torch\nimport numpy as np\n\ndef slerp(t: float, v0: torch.Tensor, v1: torch.Tensor, eps: float = 1e-8):\n    """\u7403\u9762\u7ebf\u6027\u63d2\u503c"""\n    v0_norm = v0 / (torch.norm(v0) + eps)\n    v1_norm = v1 / (torch.norm(v1) + eps)\n    \n    dot = torch.sum(v0_norm * v1_norm)\n    dot = torch.clamp(dot, -1, 1)\n    \n    theta = torch.acos(dot)\n    sin_theta = torch.sin(theta)\n    \n    if sin_theta < eps:\n        return (1 - t) * v0 + t * v1\n    \n    s0 = torch.sin((1 - t) * theta) / sin_theta\n    s1 = torch.sin(t * theta) / sin_theta\n    \n    return s0 * v0 + s1 * v1\n\ndef slerp_merge(model_a_path: str, model_b_path: str, t: float = 0.5):\n    """SLERP \u5408\u5e76"""\n    model_a = AutoModelForCausalLM.from_pretrained(model_a_path)\n    model_b = AutoModelForCausalLM.from_pretrained(model_b_path)\n    \n    merged_state_dict = {}\n    \n    for key in model_a.state_dict().keys():\n        merged_state_dict[key] = slerp(\n            t,\n            model_a.state_dict()[key].float(),\n            model_b.state_dict()[key].float()\n        ).to(model_a.state_dict()[key].dtype)\n    \n    model_a.load_state_dict(merged_state_dict)\n    return model_a\n'})}),"\n",(0,s.jsx)(n.h3,{id:"task-arithmetic",children:"Task Arithmetic"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:'def task_arithmetic_merge(\n    base_model_path: str,\n    task_models: list[tuple[str, float]]  # [(model_path, weight), ...]\n):\n    """\u4efb\u52a1\u5411\u91cf\u7b97\u672f\u5408\u5e76"""\n    base = AutoModelForCausalLM.from_pretrained(base_model_path)\n    base_state = base.state_dict()\n    \n    # \u8ba1\u7b97\u4efb\u52a1\u5411\u91cf\u5e76\u52a0\u6743\u6c42\u548c\n    task_vector_sum = {key: torch.zeros_like(val) for key, val in base_state.items()}\n    \n    for model_path, weight in task_models:\n        model = AutoModelForCausalLM.from_pretrained(model_path)\n        model_state = model.state_dict()\n        \n        for key in base_state.keys():\n            # \u4efb\u52a1\u5411\u91cf = \u5fae\u8c03\u6a21\u578b - \u57fa\u7840\u6a21\u578b\n            task_vector = model_state[key] - base_state[key]\n            task_vector_sum[key] += weight * task_vector\n    \n    # \u5408\u5e76\uff1a\u57fa\u7840\u6a21\u578b + \u4efb\u52a1\u5411\u91cf\u548c\n    merged_state = {}\n    for key in base_state.keys():\n        merged_state[key] = base_state[key] + task_vector_sum[key]\n    \n    base.load_state_dict(merged_state)\n    return base\n\n# \u4f7f\u7528\nmerged = task_arithmetic_merge(\n    "base_model",\n    [\n        ("code_model", 0.5),\n        ("math_model", 0.3),\n        ("writing_model", 0.2)\n    ]\n)\n'})}),"\n",(0,s.jsx)(n.h2,{id:"lora-\u5408\u5e76",children:"LoRA \u5408\u5e76"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:'from peft import PeftModel\n\ndef merge_lora_adapters(base_model_path: str, lora_paths: list[str]):\n    """\u5408\u5e76\u591a\u4e2a LoRA \u9002\u914d\u5668"""\n    base = AutoModelForCausalLM.from_pretrained(base_model_path)\n    \n    for lora_path in lora_paths:\n        base = PeftModel.from_pretrained(base, lora_path)\n        base = base.merge_and_unload()\n    \n    return base\n'})}),"\n",(0,s.jsx)(n.h2,{id:"\u5408\u5e76\u6548\u679c\u8bc4\u4f30",children:"\u5408\u5e76\u6548\u679c\u8bc4\u4f30"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:'def evaluate_merged_model(model, test_sets: dict):\n    """\u8bc4\u4f30\u5408\u5e76\u6a21\u578b\u5728\u5404\u4efb\u52a1\u4e0a\u7684\u8868\u73b0"""\n    results = {}\n    \n    for task_name, test_data in test_sets.items():\n        score = evaluate_task(model, test_data)\n        results[task_name] = score\n    \n    return results\n\n# \u6bd4\u8f83\u5408\u5e76\u524d\u540e\noriginal_scores = {\n    "code": evaluate_task(code_model, code_test),\n    "math": evaluate_task(math_model, math_test)\n}\n\nmerged_scores = evaluate_merged_model(merged_model, {\n    "code": code_test,\n    "math": math_test\n})\n\nprint("\u539f\u59cb\u6a21\u578b:", original_scores)\nprint("\u5408\u5e76\u6a21\u578b:", merged_scores)\n'})}),"\n",(0,s.jsx)(n.h2,{id:"\u6700\u4f73\u5b9e\u8df5",children:"\u6700\u4f73\u5b9e\u8df5"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"\u9009\u62e9\u517c\u5bb9\u6a21\u578b"}),"\uff1a\u76f8\u540c\u67b6\u6784\u3001\u76f8\u540c\u57fa\u7840\u6a21\u578b"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"\u8c03\u6574\u6743\u91cd"}),"\uff1a\u6839\u636e\u4efb\u52a1\u91cd\u8981\u6027\u8c03\u6574\u5408\u5e76\u6743\u91cd"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"\u8bc4\u4f30\u9a8c\u8bc1"}),"\uff1a\u5408\u5e76\u540e\u5728\u5404\u4efb\u52a1\u4e0a\u8bc4\u4f30"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"TIES/DARE \u4f18\u5148"}),"\uff1a\u6bd4\u7b80\u5355\u7ebf\u6027\u5408\u5e76\u6548\u679c\u66f4\u597d"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"\u8fed\u4ee3\u4f18\u5316"}),"\uff1a\u5c1d\u8bd5\u4e0d\u540c\u53c2\u6570\u627e\u5230\u6700\u4f73\u7ec4\u5408"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"\u5ef6\u4f38\u9605\u8bfb",children:"\u5ef6\u4f38\u9605\u8bfb"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://github.com/arcee-ai/mergekit",children:"mergekit"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://arxiv.org/abs/2306.01708",children:"TIES Paper"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://arxiv.org/abs/2311.03099",children:"DARE Paper"})}),"\n"]})]})}function c(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(h,{...e})}):h(e)}},48885:(e,n,t)=>{t.d(n,{R:()=>l,x:()=>d});var r=t(99378);const s={},a=r.createContext(s);function l(e){const n=r.useContext(a);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function d(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:l(e.components),r.createElement(a.Provider,{value:n},e.children)}}}]);