"use strict";(globalThis.webpackChunkto_lib_github_io=globalThis.webpackChunkto_lib_github_io||[]).push([[98977],{26239:(n,e,r)=>{r.r(e),r.d(e,{assets:()=>l,contentTitle:()=>d,default:()=>h,frontMatter:()=>c,metadata:()=>t,toc:()=>a});const t=JSON.parse('{"id":"interview/java-senior/concurrency","title":"\u9ad8\u7ea7\u5e76\u53d1\u7f16\u7a0b","description":"6. \u8be6\u7ec6\u89e3\u91ca AQS\uff08AbstractQueuedSynchronizer\uff09\u7684\u539f\u7406","source":"@site/docs/interview/java-senior/concurrency.md","sourceDirName":"interview/java-senior","slug":"/interview/java-senior/concurrency","permalink":"/docs/interview/java-senior/concurrency","draft":false,"unlisted":false,"editUrl":"https://github.com/to-lib/to-lib.github.io/tree/main/docs/interview/java-senior/concurrency.md","tags":[],"version":"current","sidebarPosition":3,"frontMatter":{"sidebar_position":3,"title":"\u9ad8\u7ea7\u5e76\u53d1\u7f16\u7a0b"},"sidebar":"interview","previous":{"title":"JVM \u6df1\u5ea6","permalink":"/docs/interview/java-senior/jvm"},"next":{"title":"\u6027\u80fd\u8c03\u4f18","permalink":"/docs/interview/java-senior/performance"}}');var i=r(22714),s=r(48885);const c={sidebar_position:3,title:"\u9ad8\u7ea7\u5e76\u53d1\u7f16\u7a0b"},d="\ud83c\udfaf \u9ad8\u7ea7\u5e76\u53d1\u7f16\u7a0b\uff08\u9ad8\u7ea7\uff09",l={},a=[{value:"6. \u8be6\u7ec6\u89e3\u91ca AQS\uff08AbstractQueuedSynchronizer\uff09\u7684\u539f\u7406",id:"6-\u8be6\u7ec6\u89e3\u91ca-aqsabstractqueuedsynchronizer\u7684\u539f\u7406",level:2},{value:"7. \u7ebf\u7a0b\u6c60\u6838\u5fc3\u53c2\u6570\u5982\u4f55\u914d\u7f6e\uff1f\u5982\u4f55\u76d1\u63a7\u7ebf\u7a0b\u6c60\u72b6\u6001\uff1f",id:"7-\u7ebf\u7a0b\u6c60\u6838\u5fc3\u53c2\u6570\u5982\u4f55\u914d\u7f6e\u5982\u4f55\u76d1\u63a7\u7ebf\u7a0b\u6c60\u72b6\u6001",level:2},{value:"8. synchronized \u9501\u5347\u7ea7\u8fc7\u7a0b\u662f\u600e\u6837\u7684\uff1f",id:"8-synchronized-\u9501\u5347\u7ea7\u8fc7\u7a0b\u662f\u600e\u6837\u7684",level:2},{value:"9. CAS \u539f\u7406\u662f\u4ec0\u4e48\uff1fABA \u95ee\u9898\u5982\u4f55\u89e3\u51b3\uff1f",id:"9-cas-\u539f\u7406\u662f\u4ec0\u4e48aba-\u95ee\u9898\u5982\u4f55\u89e3\u51b3",level:2},{value:"10. \u5982\u4f55\u5b9e\u73b0\u4e00\u4e2a\u9ad8\u6027\u80fd\u7684\u751f\u4ea7\u8005\u6d88\u8d39\u8005\u6a21\u5f0f\uff1f",id:"10-\u5982\u4f55\u5b9e\u73b0\u4e00\u4e2a\u9ad8\u6027\u80fd\u7684\u751f\u4ea7\u8005\u6d88\u8d39\u8005\u6a21\u5f0f",level:2}];function o(n){const e={a:"a",code:"code",h1:"h1",h2:"h2",header:"header",hr:"hr",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",...(0,s.R)(),...n.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(e.header,{children:(0,i.jsx)(e.h1,{id:"-\u9ad8\u7ea7\u5e76\u53d1\u7f16\u7a0b\u9ad8\u7ea7",children:"\ud83c\udfaf \u9ad8\u7ea7\u5e76\u53d1\u7f16\u7a0b\uff08\u9ad8\u7ea7\uff09"})}),"\n",(0,i.jsx)(e.h2,{id:"6-\u8be6\u7ec6\u89e3\u91ca-aqsabstractqueuedsynchronizer\u7684\u539f\u7406",children:"6. \u8be6\u7ec6\u89e3\u91ca AQS\uff08AbstractQueuedSynchronizer\uff09\u7684\u539f\u7406"}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)(e.strong,{children:"\u7b54\u6848\u8981\u70b9\uff1a"})}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)(e.strong,{children:"AQS \u6838\u5fc3\u7ed3\u6784\uff1a"})}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-java",children:"public abstract class AbstractQueuedSynchronizer {\n    // \u540c\u6b65\u72b6\u6001\n    private volatile int state;\n    \n    // CLH \u961f\u5217\u5934\u5c3e\u8282\u70b9\n    private transient volatile Node head;\n    private transient volatile Node tail;\n    \n    // \u5185\u90e8\u8282\u70b9\u7c7b\n    static final class Node {\n        volatile int waitStatus;\n        volatile Node prev;\n        volatile Node next;\n        volatile Thread thread;\n    }\n}\n"})}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)(e.strong,{children:"AQS \u5de5\u4f5c\u539f\u7406\u56fe\uff1a"})}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{children:"\u83b7\u53d6\u9501\u5931\u8d25\u7684\u7ebf\u7a0b\u8fdb\u5165 CLH \u961f\u5217\u7b49\u5f85\n\n     head                                    tail\n       \u2502                                       \u2502\n       \u25bc                                       \u25bc\n    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2510    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2510    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2510    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n    \u2502 Node \u2502\u25c4\u2500\u2500\u25ba\u2502 Node \u2502\u25c4\u2500\u2500\u25ba\u2502 Node \u2502\u25c4\u2500\u2500\u25ba\u2502 Node \u2502\n    \u2502(\u6301\u9501)\u2502    \u2502(\u7b49\u5f85)\u2502    \u2502(\u7b49\u5f85)\u2502    \u2502(\u7b49\u5f85)\u2502\n    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2518    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2518    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2518    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"})}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)(e.strong,{children:"ReentrantLock \u83b7\u53d6\u9501\u6d41\u7a0b\uff1a"})}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-java",children:"// \u975e\u516c\u5e73\u9501\u83b7\u53d6\nfinal boolean nonfairTryAcquire(int acquires) {\n    final Thread current = Thread.currentThread();\n    int c = getState();\n    if (c == 0) {\n        // \u72b6\u6001\u4e3a0\uff0cCAS\u5c1d\u8bd5\u83b7\u53d6\u9501\n        if (compareAndSetState(0, acquires)) {\n            setExclusiveOwnerThread(current);\n            return true;\n        }\n    }\n    else if (current == getExclusiveOwnerThread()) {\n        // \u91cd\u5165\uff1a\u5f53\u524d\u7ebf\u7a0b\u5df2\u6301\u6709\u9501\n        int nextc = c + acquires;\n        setState(nextc);\n        return true;\n    }\n    return false;\n}\n"})}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)(e.strong,{children:"\u57fa\u4e8e AQS \u5b9e\u73b0\u81ea\u5b9a\u4e49\u540c\u6b65\u5668\uff1a"})}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-java",children:"public class SimpleLock {\n    private final Sync sync = new Sync();\n    \n    private static class Sync extends AbstractQueuedSynchronizer {\n        @Override\n        protected boolean tryAcquire(int arg) {\n            if (compareAndSetState(0, 1)) {\n                setExclusiveOwnerThread(Thread.currentThread());\n                return true;\n            }\n            return false;\n        }\n        \n        @Override\n        protected boolean tryRelease(int arg) {\n            setExclusiveOwnerThread(null);\n            setState(0);\n            return true;\n        }\n        \n        @Override\n        protected boolean isHeldExclusively() {\n            return getState() == 1;\n        }\n    }\n    \n    public void lock() { sync.acquire(1); }\n    public void unlock() { sync.release(1); }\n}\n"})}),"\n",(0,i.jsxs)(e.p,{children:[(0,i.jsx)(e.strong,{children:"\u5ef6\u4f38\uff1a"})," \u53c2\u8003 ",(0,i.jsx)(e.a,{href:"/docs/java/multithreading",children:"\u591a\u7ebf\u7a0b - JUC \u5de5\u5177\u7c7b"})]}),"\n",(0,i.jsx)(e.hr,{}),"\n",(0,i.jsx)(e.h2,{id:"7-\u7ebf\u7a0b\u6c60\u6838\u5fc3\u53c2\u6570\u5982\u4f55\u914d\u7f6e\u5982\u4f55\u76d1\u63a7\u7ebf\u7a0b\u6c60\u72b6\u6001",children:"7. \u7ebf\u7a0b\u6c60\u6838\u5fc3\u53c2\u6570\u5982\u4f55\u914d\u7f6e\uff1f\u5982\u4f55\u76d1\u63a7\u7ebf\u7a0b\u6c60\u72b6\u6001\uff1f"}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)(e.strong,{children:"\u7b54\u6848\u8981\u70b9\uff1a"})}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)(e.strong,{children:"\u7ebf\u7a0b\u6c60\u53c2\u6570\u914d\u7f6e\u539f\u5219\uff1a"})}),"\n",(0,i.jsxs)(e.table,{children:[(0,i.jsx)(e.thead,{children:(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.th,{children:"\u573a\u666f"}),(0,i.jsx)(e.th,{children:"corePoolSize"}),(0,i.jsx)(e.th,{children:"maximumPoolSize"}),(0,i.jsx)(e.th,{children:"\u961f\u5217"})]})}),(0,i.jsxs)(e.tbody,{children:[(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:(0,i.jsx)(e.strong,{children:"CPU \u5bc6\u96c6\u578b"})}),(0,i.jsx)(e.td,{children:"CPU \u6838\u5fc3\u6570"}),(0,i.jsx)(e.td,{children:"CPU \u6838\u5fc3\u6570"}),(0,i.jsx)(e.td,{children:"\u5c0f\u961f\u5217"})]}),(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:(0,i.jsx)(e.strong,{children:"IO \u5bc6\u96c6\u578b"})}),(0,i.jsx)(e.td,{children:"2 * CPU \u6838\u5fc3\u6570"}),(0,i.jsx)(e.td,{children:"2 * CPU \u6838\u5fc3\u6570"}),(0,i.jsx)(e.td,{children:"\u5927\u961f\u5217"})]}),(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:(0,i.jsx)(e.strong,{children:"\u6df7\u5408\u578b"})}),(0,i.jsx)(e.td,{children:"\u6839\u636e IO/CPU \u6bd4\u4f8b\u8c03\u6574"}),(0,i.jsx)(e.td,{children:"-"}),(0,i.jsx)(e.td,{children:"-"})]})]})]}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)(e.strong,{children:"\u7ebf\u7a0b\u6c60\u53c2\u6570\u8ba1\u7b97\u516c\u5f0f\uff1a"})}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{children:"\u7ebf\u7a0b\u6570 = CPU \u6838\u5fc3\u6570 * (1 + \u7b49\u5f85\u65f6\u95f4/\u8ba1\u7b97\u65f6\u95f4)\n\n\u4f8b\u5982\uff1a8\u6838CPU\uff0cIO\u7b49\u5f85\u65f6\u95f4\u662f\u8ba1\u7b97\u65f6\u95f4\u76842\u500d\n\u7ebf\u7a0b\u6570 = 8 * (1 + 2) = 24\n"})}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)(e.strong,{children:"\u751f\u4ea7\u73af\u5883\u7ebf\u7a0b\u6c60\u914d\u7f6e\u793a\u4f8b\uff1a"})}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-java",children:'@Configuration\npublic class ThreadPoolConfig {\n    \n    @Bean("businessThreadPool")\n    public ThreadPoolExecutor businessThreadPool() {\n        int coreSize = Runtime.getRuntime().availableProcessors();\n        \n        return new ThreadPoolExecutor(\n            coreSize,                              // \u6838\u5fc3\u7ebf\u7a0b\u6570\n            coreSize * 2,                          // \u6700\u5927\u7ebf\u7a0b\u6570\n            60L, TimeUnit.SECONDS,                 // \u7a7a\u95f2\u7ebf\u7a0b\u5b58\u6d3b\u65f6\u95f4\n            new LinkedBlockingQueue<>(1000),       // \u4efb\u52a1\u961f\u5217\n            new ThreadFactoryBuilder()\n                .setNameFormat("business-pool-%d")\n                .setUncaughtExceptionHandler((t, e) -> \n                    log.error("Thread {} error", t.getName(), e))\n                .build(),\n            new ThreadPoolExecutor.CallerRunsPolicy()  // \u62d2\u7edd\u7b56\u7565\n        );\n    }\n}\n'})}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)(e.strong,{children:"\u7ebf\u7a0b\u6c60\u76d1\u63a7\u65b9\u6848\uff1a"})}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-java",children:'@Scheduled(fixedRate = 60000)\npublic void monitorThreadPool() {\n    ThreadPoolExecutor executor = businessThreadPool;\n    \n    // \u6838\u5fc3\u6307\u6807\n    int poolSize = executor.getPoolSize();           // \u5f53\u524d\u7ebf\u7a0b\u6570\n    int activeCount = executor.getActiveCount();     // \u6d3b\u8dc3\u7ebf\u7a0b\u6570\n    int queueSize = executor.getQueue().size();      // \u961f\u5217\u4efb\u52a1\u6570\n    long completedCount = executor.getCompletedTaskCount();  // \u5df2\u5b8c\u6210\u4efb\u52a1\u6570\n    long taskCount = executor.getTaskCount();        // \u603b\u4efb\u52a1\u6570\n    \n    // \u544a\u8b66\u9608\u503c\n    double queueUsage = queueSize / 1000.0;\n    if (queueUsage > 0.8) {\n        log.warn("\u7ebf\u7a0b\u6c60\u961f\u5217\u4f7f\u7528\u7387\u8fc7\u9ad8: {}%", queueUsage * 100);\n    }\n    \n    // \u4e0a\u62a5\u76d1\u63a7\u6307\u6807\n    Metrics.gauge("threadpool.pool.size", poolSize);\n    Metrics.gauge("threadpool.active.count", activeCount);\n    Metrics.gauge("threadpool.queue.size", queueSize);\n}\n'})}),"\n",(0,i.jsxs)(e.p,{children:[(0,i.jsx)(e.strong,{children:"\u5ef6\u4f38\uff1a"})," \u53c2\u8003 ",(0,i.jsx)(e.a,{href:"/docs/java/multithreading#%E7%BA%BF%E7%A8%8B%E6%B1%A0",children:"\u591a\u7ebf\u7a0b - \u7ebf\u7a0b\u6c60"})]}),"\n",(0,i.jsx)(e.hr,{}),"\n",(0,i.jsx)(e.h2,{id:"8-synchronized-\u9501\u5347\u7ea7\u8fc7\u7a0b\u662f\u600e\u6837\u7684",children:"8. synchronized \u9501\u5347\u7ea7\u8fc7\u7a0b\u662f\u600e\u6837\u7684\uff1f"}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)(e.strong,{children:"\u7b54\u6848\u8981\u70b9\uff1a"})}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)(e.strong,{children:"\u9501\u72b6\u6001\u6f14\u8fdb\uff1a"})}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{children:"\u65e0\u9501 \u2192 \u504f\u5411\u9501 \u2192 \u8f7b\u91cf\u7ea7\u9501 \u2192 \u91cd\u91cf\u7ea7\u9501\n"})}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)(e.strong,{children:"\u5bf9\u8c61\u5934 Mark Word \u7ed3\u6784\uff0864\u4f4d\uff09\uff1a"})}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{children:"\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                        Mark Word (64 bits)                      \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 \u65e0\u9501    \u2502 unused:25 \u2502 hashcode:31 \u2502 unused:1 \u2502 age:4 \u2502 0 \u2502 01 \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 \u504f\u5411\u9501  \u2502 thread:54 \u2502 epoch:2 \u2502 unused:1 \u2502 age:4 \u2502 1 \u2502 01 \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 \u8f7b\u91cf\u7ea7\u9501\u2502 ptr_to_lock_record:62                      \u2502 00 \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 \u91cd\u91cf\u7ea7\u9501\u2502 ptr_to_heavyweight_monitor:62              \u2502 10 \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 GC\u6807\u8bb0  \u2502                                            \u2502 11 \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"})}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)(e.strong,{children:"\u9501\u5347\u7ea7\u8be6\u7ec6\u8fc7\u7a0b\uff1a"})}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-java",children:"public class LockEscalation {\n    private Object lock = new Object();\n    \n    public void method() {\n        synchronized (lock) {\n            // 1. \u9996\u6b21\u83b7\u53d6\uff1a\u504f\u5411\u9501\n            //    - \u68c0\u67e5 Mark Word \u662f\u5426\u4e3a\u53ef\u504f\u5411\u72b6\u6001\n            //    - CAS \u5c06\u7ebf\u7a0b ID \u5199\u5165 Mark Word\n            //    - \u540e\u7eed\u540c\u4e00\u7ebf\u7a0b\u8fdb\u5165\u65e0\u9700 CAS\n            \n            // 2. \u5176\u4ed6\u7ebf\u7a0b\u7ade\u4e89\uff1a\u5347\u7ea7\u4e3a\u8f7b\u91cf\u7ea7\u9501\n            //    - \u64a4\u9500\u504f\u5411\u9501\n            //    - \u5728\u6808\u5e27\u4e2d\u521b\u5efa Lock Record\n            //    - CAS \u5c06 Mark Word \u66ff\u6362\u4e3a Lock Record \u6307\u9488\n            \n            // 3. CAS \u81ea\u65cb\u5931\u8d25\uff1a\u5347\u7ea7\u4e3a\u91cd\u91cf\u7ea7\u9501\n            //    - \u81ea\u65cb\u8d85\u8fc7\u9608\u503c\uff08\u9ed8\u8ba410\u6b21\uff09\n            //    - \u81a8\u80c0\u4e3a Monitor \u5bf9\u8c61\n            //    - \u7ebf\u7a0b\u8fdb\u5165\u963b\u585e\u72b6\u6001\n        }\n    }\n}\n"})}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)(e.strong,{children:"JVM \u9501\u4f18\u5316\u53c2\u6570\uff1a"})}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-bash",children:"# \u504f\u5411\u9501\uff08JDK 15 \u9ed8\u8ba4\u5173\u95ed\uff09\n-XX:+UseBiasedLocking\n-XX:BiasedLockingStartupDelay=0\n\n# \u81ea\u65cb\u9501\n-XX:PreBlockSpin=10  # \u81ea\u65cb\u6b21\u6570\n\n# \u67e5\u770b\u9501\u4fe1\u606f\n-XX:+PrintSafepointStatistics\n"})}),"\n",(0,i.jsxs)(e.p,{children:[(0,i.jsx)(e.strong,{children:"\u5ef6\u4f38\uff1a"})," \u53c2\u8003 ",(0,i.jsx)(e.a,{href:"/docs/java/multithreading#%E7%BA%BF%E7%A8%8B%E5%90%8C%E6%AD%A5",children:"\u591a\u7ebf\u7a0b - \u7ebf\u7a0b\u540c\u6b65"})]}),"\n",(0,i.jsx)(e.hr,{}),"\n",(0,i.jsx)(e.h2,{id:"9-cas-\u539f\u7406\u662f\u4ec0\u4e48aba-\u95ee\u9898\u5982\u4f55\u89e3\u51b3",children:"9. CAS \u539f\u7406\u662f\u4ec0\u4e48\uff1fABA \u95ee\u9898\u5982\u4f55\u89e3\u51b3\uff1f"}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)(e.strong,{children:"\u7b54\u6848\u8981\u70b9\uff1a"})}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)(e.strong,{children:"CAS\uff08Compare And Swap\uff09\u539f\u7406\uff1a"})}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-java",children:"// CAS \u4f2a\u4ee3\u7801\nboolean compareAndSwap(V* address, V expectedValue, V newValue) {\n    if (*address == expectedValue) {\n        *address = newValue;\n        return true;\n    }\n    return false;\n}\n"})}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)(e.strong,{children:"Java \u4e2d\u7684 CAS \u5b9e\u73b0\uff1a"})}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-java",children:"public class CASDemo {\n    private AtomicInteger count = new AtomicInteger(0);\n    \n    public void increment() {\n        int oldValue, newValue;\n        do {\n            oldValue = count.get();\n            newValue = oldValue + 1;\n        } while (!count.compareAndSet(oldValue, newValue));\n    }\n}\n"})}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)(e.strong,{children:"ABA \u95ee\u9898\u793a\u4f8b\uff1a"})}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{children:"\u7ebf\u7a0b1\uff1a\u8bfb\u53d6\u503c A\n\u7ebf\u7a0b2\uff1a\u5c06 A \u6539\u4e3a B\n\u7ebf\u7a0b2\uff1a\u5c06 B \u6539\u56de A\n\u7ebf\u7a0b1\uff1aCAS \u6210\u529f\uff08\u4f46\u503c\u5df2\u88ab\u4fee\u6539\u8fc7\uff09\n"})}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)(e.strong,{children:"\u89e3\u51b3\u65b9\u6848 - AtomicStampedReference\uff1a"})}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-java",children:"public class ABADemo {\n    // \u4f7f\u7528\u7248\u672c\u53f7\u89e3\u51b3 ABA \u95ee\u9898\n    private AtomicStampedReference<Integer> ref = \n        new AtomicStampedReference<>(100, 0);\n    \n    public void update() {\n        int[] stampHolder = new int[1];\n        Integer value = ref.get(stampHolder);\n        int stamp = stampHolder[0];\n        \n        // CAS \u540c\u65f6\u6bd4\u8f83\u503c\u548c\u7248\u672c\u53f7\n        boolean success = ref.compareAndSet(\n            value,           // \u671f\u671b\u503c\n            value + 1,       // \u65b0\u503c\n            stamp,           // \u671f\u671b\u7248\u672c\u53f7\n            stamp + 1        // \u65b0\u7248\u672c\u53f7\n        );\n    }\n}\n"})}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)(e.strong,{children:"LongAdder \u4f18\u5316\u539f\u7406\uff1a"})}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-java",children:"// AtomicLong\uff1a\u6240\u6709\u7ebf\u7a0b\u7ade\u4e89\u540c\u4e00\u4e2a value\n// LongAdder\uff1a\u5206\u6563\u70ed\u70b9\uff0c\u51cf\u5c11\u7ade\u4e89\n\npublic class LongAdderDemo {\n    // \u9ad8\u5e76\u53d1\u573a\u666f\u63a8\u8350\u4f7f\u7528 LongAdder\n    private LongAdder counter = new LongAdder();\n    \n    public void increment() {\n        counter.increment();  // \u5185\u90e8\u5206\u6563\u5230\u591a\u4e2a Cell\n    }\n    \n    public long get() {\n        return counter.sum();  // \u6c47\u603b\u6240\u6709 Cell\n    }\n}\n"})}),"\n",(0,i.jsxs)(e.p,{children:[(0,i.jsx)(e.strong,{children:"\u5ef6\u4f38\uff1a"})," \u53c2\u8003 ",(0,i.jsx)(e.a,{href:"/docs/java/multithreading",children:"\u591a\u7ebf\u7a0b - \u539f\u5b50\u7c7b"})]}),"\n",(0,i.jsx)(e.hr,{}),"\n",(0,i.jsx)(e.h2,{id:"10-\u5982\u4f55\u5b9e\u73b0\u4e00\u4e2a\u9ad8\u6027\u80fd\u7684\u751f\u4ea7\u8005\u6d88\u8d39\u8005\u6a21\u5f0f",children:"10. \u5982\u4f55\u5b9e\u73b0\u4e00\u4e2a\u9ad8\u6027\u80fd\u7684\u751f\u4ea7\u8005\u6d88\u8d39\u8005\u6a21\u5f0f\uff1f"}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)(e.strong,{children:"\u7b54\u6848\u8981\u70b9\uff1a"})}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)(e.strong,{children:"\u65b9\u6848\u5bf9\u6bd4\uff1a"})}),"\n",(0,i.jsxs)(e.table,{children:[(0,i.jsx)(e.thead,{children:(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.th,{children:"\u65b9\u6848"}),(0,i.jsx)(e.th,{children:"\u4f18\u70b9"}),(0,i.jsx)(e.th,{children:"\u7f3a\u70b9"}),(0,i.jsx)(e.th,{children:"\u9002\u7528\u573a\u666f"})]})}),(0,i.jsxs)(e.tbody,{children:[(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:"wait/notify"}),(0,i.jsx)(e.td,{children:"\u7b80\u5355"}),(0,i.jsx)(e.td,{children:"\u6027\u80fd\u4e00\u822c"}),(0,i.jsx)(e.td,{children:"\u7b80\u5355\u573a\u666f"})]}),(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:"BlockingQueue"}),(0,i.jsx)(e.td,{children:"\u6613\u7528"}),(0,i.jsx)(e.td,{children:"\u6709\u9501\u5f00\u9500"}),(0,i.jsx)(e.td,{children:"\u4e00\u822c\u573a\u666f"})]}),(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:"Disruptor"}),(0,i.jsx)(e.td,{children:"\u6781\u9ad8\u6027\u80fd"}),(0,i.jsx)(e.td,{children:"\u590d\u6742"}),(0,i.jsx)(e.td,{children:"\u9ad8\u6027\u80fd\u573a\u666f"})]})]})]}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)(e.strong,{children:"BlockingQueue \u5b9e\u73b0\uff1a"})}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-java",children:"public class ProducerConsumer {\n    private final BlockingQueue<Task> queue = \n        new ArrayBlockingQueue<>(1000);\n    \n    // \u751f\u4ea7\u8005\n    class Producer implements Runnable {\n        @Override\n        public void run() {\n            while (true) {\n                Task task = createTask();\n                try {\n                    queue.put(task);  // \u961f\u5217\u6ee1\u65f6\u963b\u585e\n                } catch (InterruptedException e) {\n                    Thread.currentThread().interrupt();\n                    break;\n                }\n            }\n        }\n    }\n    \n    // \u6d88\u8d39\u8005\n    class Consumer implements Runnable {\n        @Override\n        public void run() {\n            while (true) {\n                try {\n                    Task task = queue.take();  // \u961f\u5217\u7a7a\u65f6\u963b\u585e\n                    process(task);\n                } catch (InterruptedException e) {\n                    Thread.currentThread().interrupt();\n                    break;\n                }\n            }\n        }\n    }\n}\n"})}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)(e.strong,{children:"Disruptor \u9ad8\u6027\u80fd\u5b9e\u73b0\uff1a"})}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-java",children:"public class DisruptorDemo {\n    \n    public static void main(String[] args) {\n        // \u521b\u5efa Disruptor\n        Disruptor<OrderEvent> disruptor = new Disruptor<>(\n            OrderEvent::new,\n            1024 * 1024,  // RingBuffer \u5927\u5c0f\uff0c\u5fc5\u987b\u662f2\u7684\u5e42\n            DaemonThreadFactory.INSTANCE,\n            ProducerType.MULTI,\n            new YieldingWaitStrategy()  // \u7b49\u5f85\u7b56\u7565\n        );\n        \n        // \u8bbe\u7f6e\u6d88\u8d39\u8005\n        disruptor.handleEventsWith(new OrderEventHandler());\n        \n        // \u542f\u52a8\n        RingBuffer<OrderEvent> ringBuffer = disruptor.start();\n        \n        // \u751f\u4ea7\u8005\u53d1\u5e03\u4e8b\u4ef6\n        long sequence = ringBuffer.next();\n        try {\n            OrderEvent event = ringBuffer.get(sequence);\n            event.setOrderId(12345L);\n        } finally {\n            ringBuffer.publish(sequence);\n        }\n    }\n}\n"})}),"\n",(0,i.jsxs)(e.p,{children:[(0,i.jsx)(e.strong,{children:"\u5ef6\u4f38\uff1a"})," \u53c2\u8003 ",(0,i.jsx)(e.a,{href:"/docs/java/multithreading",children:"\u591a\u7ebf\u7a0b - \u5e76\u53d1\u8bbe\u8ba1\u6a21\u5f0f"})]})]})}function h(n={}){const{wrapper:e}={...(0,s.R)(),...n.components};return e?(0,i.jsx)(e,{...n,children:(0,i.jsx)(o,{...n})}):o(n)}},48885:(n,e,r)=>{r.d(e,{R:()=>c,x:()=>d});var t=r(99378);const i={},s=t.createContext(i);function c(n){const e=t.useContext(s);return t.useMemo(function(){return"function"==typeof n?n(e):{...e,...n}},[e,n])}function d(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(i):n.components||i:c(n.components),t.createElement(s.Provider,{value:e},n.children)}}}]);