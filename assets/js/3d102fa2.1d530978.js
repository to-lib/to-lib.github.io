"use strict";(globalThis.webpackChunkto_lib_github_io=globalThis.webpackChunkto_lib_github_io||[]).push([[39920],{33268:(n,e,l)=>{l.r(e),l.d(e,{assets:()=>d,contentTitle:()=>t,default:()=>h,frontMatter:()=>a,metadata:()=>i,toc:()=>u});const i=JSON.parse('{"id":"rust/unsafe-rust","title":"\u4e0d\u5b89\u5168 Rust","description":"Rust \u7684\u6838\u5fc3\u662f\u5185\u5b58\u5b89\u5168,\u4f46\u6709\u65f6\u9700\u8981\u6267\u884c\u4e0d\u5b89\u5168\u64cd\u4f5c\u3002\u672c\u6587\u4ecb\u7ecd\u5982\u4f55\u6b63\u786e\u4f7f\u7528 unsafe \u5173\u952e\u5b57\u3002","source":"@site/docs/rust/unsafe-rust.md","sourceDirName":"rust","slug":"/rust/unsafe-rust","permalink":"/docs/rust/unsafe-rust","draft":false,"unlisted":false,"editUrl":"https://github.com/to-lib/to-lib.github.io/tree/main/docs/rust/unsafe-rust.md","tags":[],"version":"current","sidebarPosition":14,"frontMatter":{"sidebar_position":14,"title":"\u4e0d\u5b89\u5168 Rust"},"sidebar":"rust","previous":{"title":"\u5b8f\u7f16\u7a0b","permalink":"/docs/rust/macros"},"next":{"title":"\u5e95\u5c42\u539f\u7406","permalink":"/docs/rust/advanced-internals"}}');var s=l(22714),r=l(48885);const a={sidebar_position:14,title:"\u4e0d\u5b89\u5168 Rust"},t="\u4e0d\u5b89\u5168 Rust",d={},u=[{value:"\u4e3a\u4ec0\u4e48\u9700\u8981 Unsafe",id:"\u4e3a\u4ec0\u4e48\u9700\u8981-unsafe",level:2},{value:"\u5b89\u5168 vs \u4e0d\u5b89\u5168",id:"\u5b89\u5168-vs-\u4e0d\u5b89\u5168",level:3},{value:"Unsafe \u7684\u4f7f\u7528\u573a\u666f",id:"unsafe-\u7684\u4f7f\u7528\u573a\u666f",level:3},{value:"\u88f8\u6307\u9488",id:"\u88f8\u6307\u9488",level:2},{value:"\u521b\u5efa\u88f8\u6307\u9488",id:"\u521b\u5efa\u88f8\u6307\u9488",level:3},{value:"\u89e3\u5f15\u7528\u88f8\u6307\u9488",id:"\u89e3\u5f15\u7528\u88f8\u6307\u9488",level:3},{value:"\u88f8\u6307\u9488 vs \u5f15\u7528",id:"\u88f8\u6307\u9488-vs-\u5f15\u7528",level:3},{value:"\u4e0d\u5b89\u5168\u51fd\u6570\u548c\u65b9\u6cd5",id:"\u4e0d\u5b89\u5168\u51fd\u6570\u548c\u65b9\u6cd5",level:2},{value:"\u5b9a\u4e49\u4e0d\u5b89\u5168\u51fd\u6570",id:"\u5b9a\u4e49\u4e0d\u5b89\u5168\u51fd\u6570",level:3},{value:"\u5b89\u5168\u62bd\u8c61\u5c01\u88c5\u4e0d\u5b89\u5168\u4ee3\u7801",id:"\u5b89\u5168\u62bd\u8c61\u5c01\u88c5\u4e0d\u5b89\u5168\u4ee3\u7801",level:3},{value:"\u5916\u90e8\u51fd\u6570\u63a5\u53e3 (FFI)",id:"\u5916\u90e8\u51fd\u6570\u63a5\u53e3-ffi",level:2},{value:"\u8c03\u7528 C \u51fd\u6570",id:"\u8c03\u7528-c-\u51fd\u6570",level:3},{value:"\u4ece\u5176\u4ed6\u8bed\u8a00\u8c03\u7528 Rust",id:"\u4ece\u5176\u4ed6\u8bed\u8a00\u8c03\u7528-rust",level:3},{value:"\u4f7f\u7528 libc",id:"\u4f7f\u7528-libc",level:3},{value:"\u8bbf\u95ee\u6216\u4fee\u6539\u53ef\u53d8\u9759\u6001\u53d8\u91cf",id:"\u8bbf\u95ee\u6216\u4fee\u6539\u53ef\u53d8\u9759\u6001\u53d8\u91cf",level:2},{value:"\u9759\u6001\u53d8\u91cf",id:"\u9759\u6001\u53d8\u91cf",level:3},{value:"\u53ef\u53d8\u9759\u6001\u53d8\u91cf",id:"\u53ef\u53d8\u9759\u6001\u53d8\u91cf",level:3},{value:"\u5b9e\u73b0\u4e0d\u5b89\u5168 Trait",id:"\u5b9e\u73b0\u4e0d\u5b89\u5168-trait",level:2},{value:"\u5b9a\u4e49\u548c\u5b9e\u73b0\u4e0d\u5b89\u5168 Trait",id:"\u5b9a\u4e49\u548c\u5b9e\u73b0\u4e0d\u5b89\u5168-trait",level:3},{value:"Send \u548c Sync Trait",id:"send-\u548c-sync-trait",level:3},{value:"\u8054\u5408\u4f53 (Union)",id:"\u8054\u5408\u4f53-union",level:2},{value:"\u5b9a\u4e49\u548c\u4f7f\u7528 Union",id:"\u5b9a\u4e49\u548c\u4f7f\u7528-union",level:3},{value:"\u5185\u5b58\u64cd\u4f5c",id:"\u5185\u5b58\u64cd\u4f5c",level:2},{value:"\u624b\u52a8\u5206\u914d\u548c\u91ca\u653e\u5185\u5b58",id:"\u624b\u52a8\u5206\u914d\u548c\u91ca\u653e\u5185\u5b58",level:3},{value:"\u539f\u59cb\u6307\u9488\u8fd0\u7b97",id:"\u539f\u59cb\u6307\u9488\u8fd0\u7b97",level:3},{value:"Unsafe \u6700\u4f73\u5b9e\u8df5",id:"unsafe-\u6700\u4f73\u5b9e\u8df5",level:2},{value:"1. \u6700\u5c0f\u5316 Unsafe \u5757",id:"1-\u6700\u5c0f\u5316-unsafe-\u5757",level:3},{value:"2. \u63d0\u4f9b\u5b89\u5168\u62bd\u8c61",id:"2-\u63d0\u4f9b\u5b89\u5168\u62bd\u8c61",level:3},{value:"3. \u6587\u6863\u5316\u4e0d\u5b89\u5168\u6027",id:"3-\u6587\u6863\u5316\u4e0d\u5b89\u5168\u6027",level:3},{value:"4. \u4f7f\u7528\u7c7b\u578b\u7cfb\u7edf\u4fdd\u8bc1\u5b89\u5168",id:"4-\u4f7f\u7528\u7c7b\u578b\u7cfb\u7edf\u4fdd\u8bc1\u5b89\u5168",level:3},{value:"\u5e38\u89c1\u9677\u9631",id:"\u5e38\u89c1\u9677\u9631",level:2},{value:"\u60ac\u5782\u6307\u9488",id:"\u60ac\u5782\u6307\u9488",level:3},{value:"\u6570\u636e\u7ade\u4e89",id:"\u6570\u636e\u7ade\u4e89",level:3},{value:"\u672a\u521d\u59cb\u5316\u5185\u5b58",id:"\u672a\u521d\u59cb\u5316\u5185\u5b58",level:3},{value:"\u5de5\u5177\u548c\u9a8c\u8bc1",id:"\u5de5\u5177\u548c\u9a8c\u8bc1",level:2},{value:"Miri",id:"miri",level:3},{value:"Address Sanitizer",id:"address-sanitizer",level:3},{value:"\u4f7f\u7528 valgrind",id:"\u4f7f\u7528-valgrind",level:3},{value:"\u603b\u7ed3",id:"\u603b\u7ed3",level:2}];function c(n){const e={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...n.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(e.header,{children:(0,s.jsx)(e.h1,{id:"\u4e0d\u5b89\u5168-rust",children:"\u4e0d\u5b89\u5168 Rust"})}),"\n",(0,s.jsxs)(e.p,{children:["Rust \u7684\u6838\u5fc3\u662f\u5185\u5b58\u5b89\u5168,\u4f46\u6709\u65f6\u9700\u8981\u6267\u884c\u4e0d\u5b89\u5168\u64cd\u4f5c\u3002\u672c\u6587\u4ecb\u7ecd\u5982\u4f55\u6b63\u786e\u4f7f\u7528 ",(0,s.jsx)(e.code,{children:"unsafe"})," \u5173\u952e\u5b57\u3002"]}),"\n",(0,s.jsx)(e.h2,{id:"\u4e3a\u4ec0\u4e48\u9700\u8981-unsafe",children:"\u4e3a\u4ec0\u4e48\u9700\u8981 Unsafe"}),"\n",(0,s.jsx)(e.h3,{id:"\u5b89\u5168-vs-\u4e0d\u5b89\u5168",children:"\u5b89\u5168 vs \u4e0d\u5b89\u5168"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-rust",children:"// \u5b89\u5168\u4ee3\u7801\nfn safe_function() {\n    let mut v = vec![1, 2, 3];\n    v.push(4);\n}\n\n// \u4e0d\u5b89\u5168\u4ee3\u7801\nunsafe fn unsafe_function() {\n    // \u53ef\u4ee5\u6267\u884c\u4e0d\u5b89\u5168\u64cd\u4f5c\n}\n"})}),"\n",(0,s.jsx)(e.h3,{id:"unsafe-\u7684\u4f7f\u7528\u573a\u666f",children:"Unsafe \u7684\u4f7f\u7528\u573a\u666f"}),"\n",(0,s.jsxs)(e.ol,{children:["\n",(0,s.jsx)(e.li,{children:"\u89e3\u5f15\u7528\u88f8\u6307\u9488"}),"\n",(0,s.jsx)(e.li,{children:"\u8c03\u7528\u4e0d\u5b89\u5168\u51fd\u6570\u6216\u65b9\u6cd5"}),"\n",(0,s.jsx)(e.li,{children:"\u8bbf\u95ee\u6216\u4fee\u6539\u53ef\u53d8\u9759\u6001\u53d8\u91cf"}),"\n",(0,s.jsx)(e.li,{children:"\u5b9e\u73b0\u4e0d\u5b89\u5168 trait"}),"\n",(0,s.jsx)(e.li,{children:"\u8bbf\u95ee union \u7684\u5b57\u6bb5"}),"\n"]}),"\n",(0,s.jsx)(e.h2,{id:"\u88f8\u6307\u9488",children:"\u88f8\u6307\u9488"}),"\n",(0,s.jsx)(e.h3,{id:"\u521b\u5efa\u88f8\u6307\u9488",children:"\u521b\u5efa\u88f8\u6307\u9488"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-rust",children:'fn main() {\n    let mut num = 5;\n    \n    // \u521b\u5efa\u4e0d\u53ef\u53d8\u88f8\u6307\u9488\n    let r1 = &num as *const i32;\n    \n    // \u521b\u5efa\u53ef\u53d8\u88f8\u6307\u9488\n    let r2 = &mut num as *mut i32;\n    \n    // \u88f8\u6307\u9488\u53ef\u4ee5\u5728\u5b89\u5168\u4ee3\u7801\u4e2d\u521b\u5efa\n    println!("r1: {:p}", r1);\n    println!("r2: {:p}", r2);\n}\n'})}),"\n",(0,s.jsx)(e.h3,{id:"\u89e3\u5f15\u7528\u88f8\u6307\u9488",children:"\u89e3\u5f15\u7528\u88f8\u6307\u9488"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-rust",children:'fn main() {\n    let mut num = 5;\n    \n    let r1 = &num as *const i32;\n    let r2 = &mut num as *mut i32;\n    \n    // \u89e3\u5f15\u7528\u88f8\u6307\u9488\u9700\u8981 unsafe \u5757\n    unsafe {\n        println!("r1: {}", *r1);\n        println!("r2: {}", *r2);\n    }\n}\n'})}),"\n",(0,s.jsx)(e.h3,{id:"\u88f8\u6307\u9488-vs-\u5f15\u7528",children:"\u88f8\u6307\u9488 vs \u5f15\u7528"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-rust",children:'fn main() {\n    let mut num = 5;\n    \n    // \u53ef\u4ee5\u540c\u65f6\u521b\u5efa\u591a\u4e2a\u88f8\u6307\u9488\n    let r1 = &num as *const i32;\n    let r2 = &num as *const i32;\n    let r3 = &mut num as *mut i32;\n    \n    // \u88f8\u6307\u9488\u4e0d\u4fdd\u8bc1\u6307\u5411\u6709\u6548\u5185\u5b58\n    let address = 0x012345usize;\n    let r = address as *const i32;\n    \n    unsafe {\n        // \u53ef\u80fd\u5bfc\u81f4\u672a\u5b9a\u4e49\u884c\u4e3a\n        // println!("r: {}", *r);\n    }\n}\n'})}),"\n",(0,s.jsx)(e.h2,{id:"\u4e0d\u5b89\u5168\u51fd\u6570\u548c\u65b9\u6cd5",children:"\u4e0d\u5b89\u5168\u51fd\u6570\u548c\u65b9\u6cd5"}),"\n",(0,s.jsx)(e.h3,{id:"\u5b9a\u4e49\u4e0d\u5b89\u5168\u51fd\u6570",children:"\u5b9a\u4e49\u4e0d\u5b89\u5168\u51fd\u6570"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-rust",children:'unsafe fn dangerous() {\n    println!("\u6267\u884c\u5371\u9669\u64cd\u4f5c");\n}\n\nfn main() {\n    // \u8c03\u7528\u4e0d\u5b89\u5168\u51fd\u6570\u9700\u8981 unsafe \u5757\n    unsafe {\n        dangerous();\n    }\n}\n'})}),"\n",(0,s.jsx)(e.h3,{id:"\u5b89\u5168\u62bd\u8c61\u5c01\u88c5\u4e0d\u5b89\u5168\u4ee3\u7801",children:"\u5b89\u5168\u62bd\u8c61\u5c01\u88c5\u4e0d\u5b89\u5168\u4ee3\u7801"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-rust",children:'use std::slice;\n\nfn split_at_mut(slice: &mut [i32], mid: usize) -> (&mut [i32], &mut [i32]) {\n    let len = slice.len();\n    let ptr = slice.as_mut_ptr();\n    \n    assert!(mid <= len);\n    \n    unsafe {\n        (\n            slice::from_raw_parts_mut(ptr, mid),\n            slice::from_raw_parts_mut(ptr.add(mid), len - mid),\n        )\n    }\n}\n\nfn main() {\n    let mut v = vec![1, 2, 3, 4, 5, 6];\n    let (left, right) = split_at_mut(&mut v, 3);\n    \n    println!("\u5de6: {:?}", left);   // [1, 2, 3]\n    println!("\u53f3: {:?}", right);  // [4, 5, 6]\n}\n'})}),"\n",(0,s.jsx)(e.h2,{id:"\u5916\u90e8\u51fd\u6570\u63a5\u53e3-ffi",children:"\u5916\u90e8\u51fd\u6570\u63a5\u53e3 (FFI)"}),"\n",(0,s.jsx)(e.h3,{id:"\u8c03\u7528-c-\u51fd\u6570",children:"\u8c03\u7528 C \u51fd\u6570"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-rust",children:'extern "C" {\n    fn abs(input: i32) -> i32;\n}\n\nfn main() {\n    unsafe {\n        println!("C \u8bed\u8a00 abs(-3): {}", abs(-3));\n    }\n}\n'})}),"\n",(0,s.jsx)(e.h3,{id:"\u4ece\u5176\u4ed6\u8bed\u8a00\u8c03\u7528-rust",children:"\u4ece\u5176\u4ed6\u8bed\u8a00\u8c03\u7528 Rust"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-rust",children:'#[no_mangle]\npub extern "C" fn call_from_c() {\n    println!("\u4ece C \u8c03\u7528 Rust!");\n}\n\n#[no_mangle]\npub extern "C" fn add_numbers(a: i32, b: i32) -> i32 {\n    a + b\n}\n'})}),"\n",(0,s.jsx)(e.h3,{id:"\u4f7f\u7528-libc",children:"\u4f7f\u7528 libc"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-rust",children:'use std::ffi::CString;\nuse std::os::raw::c_char;\n\nextern "C" {\n    fn puts(s: *const c_char) -> i32;\n}\n\nfn main() {\n    let c_string = CString::new("Hello from Rust!").unwrap();\n    \n    unsafe {\n        puts(c_string.as_ptr());\n    }\n}\n'})}),"\n",(0,s.jsx)(e.h2,{id:"\u8bbf\u95ee\u6216\u4fee\u6539\u53ef\u53d8\u9759\u6001\u53d8\u91cf",children:"\u8bbf\u95ee\u6216\u4fee\u6539\u53ef\u53d8\u9759\u6001\u53d8\u91cf"}),"\n",(0,s.jsx)(e.h3,{id:"\u9759\u6001\u53d8\u91cf",children:"\u9759\u6001\u53d8\u91cf"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-rust",children:'static HELLO_WORLD: &str = "Hello, world!";\n\nfn main() {\n    println!("{}", HELLO_WORLD);\n}\n'})}),"\n",(0,s.jsx)(e.h3,{id:"\u53ef\u53d8\u9759\u6001\u53d8\u91cf",children:"\u53ef\u53d8\u9759\u6001\u53d8\u91cf"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-rust",children:'static mut COUNTER: u32 = 0;\n\nfn add_to_counter(inc: u32) {\n    unsafe {\n        COUNTER += inc;\n    }\n}\n\nfn main() {\n    add_to_counter(3);\n    \n    unsafe {\n        println!("COUNTER: {}", COUNTER);\n    }\n}\n'})}),"\n",(0,s.jsx)(e.h2,{id:"\u5b9e\u73b0\u4e0d\u5b89\u5168-trait",children:"\u5b9e\u73b0\u4e0d\u5b89\u5168 Trait"}),"\n",(0,s.jsx)(e.h3,{id:"\u5b9a\u4e49\u548c\u5b9e\u73b0\u4e0d\u5b89\u5168-trait",children:"\u5b9a\u4e49\u548c\u5b9e\u73b0\u4e0d\u5b89\u5168 Trait"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-rust",children:'unsafe trait Foo {\n    fn foo(&self);\n}\n\nstruct MyType;\n\nunsafe impl Foo for MyType {\n    fn foo(&self) {\n        println!("\u5b9e\u73b0\u4e0d\u5b89\u5168 trait");\n    }\n}\n\nfn main() {\n    let my = MyType;\n    my.foo();\n}\n'})}),"\n",(0,s.jsx)(e.h3,{id:"send-\u548c-sync-trait",children:"Send \u548c Sync Trait"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-rust",children:'// Send: \u53ef\u4ee5\u5728\u7ebf\u7a0b\u95f4\u8f6c\u79fb\u6240\u6709\u6743\n// Sync: \u53ef\u4ee5\u5728\u7ebf\u7a0b\u95f4\u5171\u4eab\u5f15\u7528\n\nuse std::rc::Rc;\n\n// Rc<T> \u4e0d\u662f Send \u6216 Sync\nfn example() {\n    let rc = Rc::new(5);\n    \n    // \u4ee5\u4e0b\u4ee3\u7801\u4f1a\u7f16\u8bd1\u9519\u8bef\n    // std::thread::spawn(move || {\n    //     println!("{}", rc);\n    // });\n}\n'})}),"\n",(0,s.jsx)(e.h2,{id:"\u8054\u5408\u4f53-union",children:"\u8054\u5408\u4f53 (Union)"}),"\n",(0,s.jsx)(e.h3,{id:"\u5b9a\u4e49\u548c\u4f7f\u7528-union",children:"\u5b9a\u4e49\u548c\u4f7f\u7528 Union"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-rust",children:'#[repr(C)]\nunion MyUnion {\n    f1: u32,\n    f2: f32,\n}\n\nfn main() {\n    let u = MyUnion { f1: 1 };\n    \n    unsafe {\n        println!("u.f1: {}", u.f1);\n        \n        // \u8bbf\u95ee f2 \u662f\u672a\u5b9a\u4e49\u884c\u4e3a\n        // println!("u.f2: {}", u.f2);\n    }\n}\n'})}),"\n",(0,s.jsx)(e.h2,{id:"\u5185\u5b58\u64cd\u4f5c",children:"\u5185\u5b58\u64cd\u4f5c"}),"\n",(0,s.jsx)(e.h3,{id:"\u624b\u52a8\u5206\u914d\u548c\u91ca\u653e\u5185\u5b58",children:"\u624b\u52a8\u5206\u914d\u548c\u91ca\u653e\u5185\u5b58"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-rust",children:'use std::alloc::{alloc, dealloc, Layout};\n\nfn main() {\n    unsafe {\n        let layout = Layout::from_size_align(4, 4).unwrap();\n        let ptr = alloc(layout);\n        \n        if ptr.is_null() {\n            panic!("\u5206\u914d\u5931\u8d25");\n        }\n        \n        // \u4f7f\u7528\u5185\u5b58\n        *ptr = 42;\n        println!("\u503c: {}", *ptr);\n        \n        // \u91ca\u653e\u5185\u5b58\n        dealloc(ptr, layout);\n    }\n}\n'})}),"\n",(0,s.jsx)(e.h3,{id:"\u539f\u59cb\u6307\u9488\u8fd0\u7b97",children:"\u539f\u59cb\u6307\u9488\u8fd0\u7b97"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-rust",children:'fn main() {\n    let arr = [1, 2, 3, 4, 5];\n    let ptr = arr.as_ptr();\n    \n    unsafe {\n        println!("\u7b2c0\u4e2a: {}", *ptr);\n        println!("\u7b2c1\u4e2a: {}", *ptr.add(1));\n        println!("\u7b2c2\u4e2a: {}", *ptr.add(2));\n        \n        // \u4f7f\u7528 offset\n        println!("offset(3): {}", *ptr.offset(3));\n    }\n}\n'})}),"\n",(0,s.jsx)(e.h2,{id:"unsafe-\u6700\u4f73\u5b9e\u8df5",children:"Unsafe \u6700\u4f73\u5b9e\u8df5"}),"\n",(0,s.jsx)(e.h3,{id:"1-\u6700\u5c0f\u5316-unsafe-\u5757",children:"1. \u6700\u5c0f\u5316 Unsafe \u5757"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-rust",children:'// \u4e0d\u597d:\u6574\u4e2a\u51fd\u6570\u90fd\u662f unsafe\nunsafe fn bad_example(ptr: *const i32) {\n    let value = *ptr;\n    println!("{}", value);\n    let x = 5 + 3;  // \u5b89\u5168\u64cd\u4f5c\u4e5f\u5728 unsafe \u4e2d\n}\n\n// \u597d:\u53ea\u5c06\u5fc5\u8981\u90e8\u5206\u653e\u5728 unsafe \u4e2d\nfn good_example(ptr: *const i32) {\n    let value = unsafe { *ptr };\n    println!("{}", value);\n    let x = 5 + 3;  // \u5b89\u5168\u64cd\u4f5c\u5728\u5916\u9762\n}\n'})}),"\n",(0,s.jsx)(e.h3,{id:"2-\u63d0\u4f9b\u5b89\u5168\u62bd\u8c61",children:"2. \u63d0\u4f9b\u5b89\u5168\u62bd\u8c61"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-rust",children:"pub struct SafeWrapper {\n    data: *mut i32,\n    len: usize,\n}\n\nimpl SafeWrapper {\n    pub fn new(data: Vec<i32>) -> Self {\n        let mut data = data;\n        let ptr = data.as_mut_ptr();\n        let len = data.len();\n        std::mem::forget(data);\n        \n        SafeWrapper { data: ptr, len }\n    }\n    \n    pub fn get(&self, index: usize) -> Option<i32> {\n        if index < self.len {\n            unsafe { Some(*self.data.add(index)) }\n        } else {\n            None\n        }\n    }\n}\n\nimpl Drop for SafeWrapper {\n    fn drop(&mut self) {\n        unsafe {\n            Vec::from_raw_parts(self.data, self.len, self.len);\n        }\n    }\n}\n"})}),"\n",(0,s.jsx)(e.h3,{id:"3-\u6587\u6863\u5316\u4e0d\u5b89\u5168\u6027",children:"3. \u6587\u6863\u5316\u4e0d\u5b89\u5168\u6027"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-rust",children:"/// # Safety\n///\n/// `ptr` \u5fc5\u987b\u6307\u5411\u6709\u6548\u7684 i32 \u503c\n/// `ptr` \u5fc5\u987b\u6b63\u786e\u5bf9\u9f50\n/// `ptr` \u6307\u5411\u7684\u503c\u5fc5\u987b\u521d\u59cb\u5316\nunsafe fn read_value(ptr: *const i32) -> i32 {\n    *ptr\n}\n"})}),"\n",(0,s.jsx)(e.h3,{id:"4-\u4f7f\u7528\u7c7b\u578b\u7cfb\u7edf\u4fdd\u8bc1\u5b89\u5168",children:"4. \u4f7f\u7528\u7c7b\u578b\u7cfb\u7edf\u4fdd\u8bc1\u5b89\u5168"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-rust",children:"use std::marker::PhantomData;\n\nstruct RawPtr<T> {\n    ptr: *const T,\n    _marker: PhantomData<T>,\n}\n\nimpl<T> RawPtr<T> {\n    unsafe fn new(ptr: *const T) -> Self {\n        RawPtr {\n            ptr,\n            _marker: PhantomData,\n        }\n    }\n    \n    unsafe fn as_ref(&self) -> &T {\n        &*self.ptr\n    }\n}\n"})}),"\n",(0,s.jsx)(e.h2,{id:"\u5e38\u89c1\u9677\u9631",children:"\u5e38\u89c1\u9677\u9631"}),"\n",(0,s.jsx)(e.h3,{id:"\u60ac\u5782\u6307\u9488",children:"\u60ac\u5782\u6307\u9488"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-rust",children:"fn dangle() -> *const i32 {\n    let x = 5;\n    &x as *const i32  // \u9519\u8bef:\u8fd4\u56de\u6307\u5411\u6808\u4e0a\u53d8\u91cf\u7684\u6307\u9488\n}\n\n// \u6b63\u786e\u65b9\u5f0f\nfn not_dangle() -> Box<i32> {\n    Box::new(5)\n}\n"})}),"\n",(0,s.jsx)(e.h3,{id:"\u6570\u636e\u7ade\u4e89",children:"\u6570\u636e\u7ade\u4e89"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-rust",children:"use std::thread;\n\nstatic mut SHARED: i32 = 0;\n\nfn main() {\n    // \u9519\u8bef:\u591a\u4e2a\u7ebf\u7a0b\u540c\u65f6\u8bbf\u95ee\u53ef\u53d8\u9759\u6001\u53d8\u91cf\n    let handle1 = thread::spawn(|| unsafe {\n        SHARED += 1;\n    });\n    \n    let handle2 = thread::spawn(|| unsafe {\n        SHARED += 1;\n    });\n    \n    handle1.join().unwrap();\n    handle2.join().unwrap();\n    \n    // \u7ed3\u679c\u4e0d\u786e\u5b9a!\n}\n"})}),"\n",(0,s.jsx)(e.h3,{id:"\u672a\u521d\u59cb\u5316\u5185\u5b58",children:"\u672a\u521d\u59cb\u5316\u5185\u5b58"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-rust",children:'fn main() {\n    let mut x: i32;\n    \n    // \u9519\u8bef:\u4f7f\u7528\u672a\u521d\u59cb\u5316\u7684\u53d8\u91cf\n    // println!("{}", x);\n    \n    unsafe {\n        let mut uninit: std::mem::MaybeUninit<i32> = std::mem::MaybeUninit::uninit();\n        // \u4f7f\u7528\u524d\u5fc5\u987b\u521d\u59cb\u5316\n        uninit.write(42);\n        let init = uninit.assume_init();\n        println!("{}", init);\n    }\n}\n'})}),"\n",(0,s.jsx)(e.h2,{id:"\u5de5\u5177\u548c\u9a8c\u8bc1",children:"\u5de5\u5177\u548c\u9a8c\u8bc1"}),"\n",(0,s.jsx)(e.h3,{id:"miri",children:"Miri"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-bash",children:"# \u5b89\u88c5 Miri\nrustup +nightly component add miri\n\n# \u8fd0\u884c Miri\ncargo +nightly miri test\n"})}),"\n",(0,s.jsx)(e.h3,{id:"address-sanitizer",children:"Address Sanitizer"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-bash",children:'# \u4f7f\u7528 AddressSanitizer\nRUSTFLAGS="-Z sanitizer=address" cargo +nightly run\n'})}),"\n",(0,s.jsx)(e.h3,{id:"\u4f7f\u7528-valgrind",children:"\u4f7f\u7528 valgrind"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-bash",children:"cargo build\nvalgrind --leak-check=full ./target/debug/your_program\n"})}),"\n",(0,s.jsx)(e.h2,{id:"\u603b\u7ed3",children:"\u603b\u7ed3"}),"\n",(0,s.jsx)(e.p,{children:"\u672c\u6587\u4ecb\u7ecd\u4e86 Rust \u7684\u4e0d\u5b89\u5168\u7279\u6027:"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"\u2705 unsafe \u5173\u952e\u5b57\u548c\u4f7f\u7528\u573a\u666f"}),"\n",(0,s.jsx)(e.li,{children:"\u2705 \u88f8\u6307\u9488:\u521b\u5efa\u3001\u89e3\u5f15\u7528\u3001\u8fd0\u7b97"}),"\n",(0,s.jsx)(e.li,{children:"\u2705 \u4e0d\u5b89\u5168\u51fd\u6570\u548c\u65b9\u6cd5"}),"\n",(0,s.jsx)(e.li,{children:"\u2705 FFI:\u8c03\u7528 C \u51fd\u6570,\u4ece C \u8c03\u7528 Rust"}),"\n",(0,s.jsx)(e.li,{children:"\u2705 \u53ef\u53d8\u9759\u6001\u53d8\u91cf"}),"\n",(0,s.jsx)(e.li,{children:"\u2705 \u4e0d\u5b89\u5168 trait \u5b9e\u73b0"}),"\n",(0,s.jsx)(e.li,{children:"\u2705 Union \u8054\u5408\u4f53"}),"\n",(0,s.jsx)(e.li,{children:"\u2705 \u5185\u5b58\u64cd\u4f5c:\u624b\u52a8\u5206\u914d/\u91ca\u653e"}),"\n",(0,s.jsx)(e.li,{children:"\u2705 \u6700\u4f73\u5b9e\u8df5\u548c\u5e38\u89c1\u9677\u9631"}),"\n",(0,s.jsxs)(e.li,{children:["\u2705 \u9a8c\u8bc1\u5de5\u5177",":Miri","\u3001ASan\u3001Valgrind"]}),"\n"]}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"\u5173\u952e\u539f\u5219:"})}),"\n",(0,s.jsxs)(e.ol,{children:["\n",(0,s.jsx)(e.li,{children:"\u53ea\u5728\u5fc5\u8981\u65f6\u4f7f\u7528 unsafe"}),"\n",(0,s.jsx)(e.li,{children:"\u6700\u5c0f\u5316 unsafe \u5757\u8303\u56f4"}),"\n",(0,s.jsx)(e.li,{children:"\u63d0\u4f9b\u5b89\u5168\u7684\u62bd\u8c61\u63a5\u53e3"}),"\n",(0,s.jsx)(e.li,{children:"\u8be6\u7ec6\u6587\u6863\u5316\u5b89\u5168\u8981\u6c42"}),"\n",(0,s.jsx)(e.li,{children:"\u4f7f\u7528\u5de5\u5177\u9a8c\u8bc1\u6b63\u786e\u6027"}),"\n"]}),"\n",(0,s.jsx)(e.p,{children:"\u606d\u559c!\u4f60\u5df2\u5b8c\u6210\u6240\u6709 Rust \u6587\u6863\u7684\u5b66\u4e60,\u638c\u63e1\u4e86\u4ece\u57fa\u7840\u5230\u9ad8\u7ea7\u7684\u5b8c\u6574\u77e5\u8bc6\u4f53\u7cfb!"})]})}function h(n={}){const{wrapper:e}={...(0,r.R)(),...n.components};return e?(0,s.jsx)(e,{...n,children:(0,s.jsx)(c,{...n})}):c(n)}},48885:(n,e,l)=>{l.d(e,{R:()=>a,x:()=>t});var i=l(99378);const s={},r=i.createContext(s);function a(n){const e=i.useContext(r);return i.useMemo(function(){return"function"==typeof n?n(e):{...e,...n}},[e,n])}function t(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(s):n.components||s:a(n.components),i.createElement(r.Provider,{value:e},n.children)}}}]);