"use strict";(globalThis.webpackChunkto_lib_github_io=globalThis.webpackChunkto_lib_github_io||[]).push([[88366],{19015:(e,n,a)=>{a.r(n),a.d(n,{assets:()=>d,contentTitle:()=>s,default:()=>u,frontMatter:()=>t,metadata:()=>r,toc:()=>o});const r=JSON.parse('{"id":"flink/table-sql","title":"Table API \u4e0e SQL","description":"Flink Table API \u548c SQL \u58f0\u660e\u5f0f\u6570\u636e\u5904\u7406","source":"@site/docs/flink/table-sql.md","sourceDirName":"flink","slug":"/flink/table-sql","permalink":"/docs/flink/table-sql","draft":false,"unlisted":false,"editUrl":"https://github.com/to-lib/to-lib.github.io/tree/main/docs/flink/table-sql.md","tags":[],"version":"current","sidebarPosition":6,"frontMatter":{"sidebar_position":6,"title":"Table API \u4e0e SQL","description":"Flink Table API \u548c SQL \u58f0\u660e\u5f0f\u6570\u636e\u5904\u7406"},"sidebar":"flink","previous":{"title":"DataStream API","permalink":"/docs/flink/datastream-api"},"next":{"title":"\u72b6\u6001\u7ba1\u7406","permalink":"/docs/flink/state-management"}}');var l=a(22714),i=a(48885);const t={sidebar_position:6,title:"Table API \u4e0e SQL",description:"Flink Table API \u548c SQL \u58f0\u660e\u5f0f\u6570\u636e\u5904\u7406"},s="Table API \u4e0e SQL",d={},o=[{value:"\u6982\u8ff0",id:"\u6982\u8ff0",level:2},{value:"\u73af\u5883\u914d\u7f6e",id:"\u73af\u5883\u914d\u7f6e",level:2},{value:"Maven \u4f9d\u8d56",id:"maven-\u4f9d\u8d56",level:3},{value:"\u521b\u5efa\u8868\u73af\u5883",id:"\u521b\u5efa\u8868\u73af\u5883",level:3},{value:"\u521b\u5efa\u8868",id:"\u521b\u5efa\u8868",level:2},{value:"\u4ece DataStream \u521b\u5efa",id:"\u4ece-datastream-\u521b\u5efa",level:3},{value:"\u4f7f\u7528 DDL \u521b\u5efa",id:"\u4f7f\u7528-ddl-\u521b\u5efa",level:3},{value:"Table API \u64cd\u4f5c",id:"table-api-\u64cd\u4f5c",level:2},{value:"\u57fa\u672c\u67e5\u8be2",id:"\u57fa\u672c\u67e5\u8be2",level:3},{value:"\u805a\u5408\u64cd\u4f5c",id:"\u805a\u5408\u64cd\u4f5c",level:3},{value:"\u8868\u8fde\u63a5",id:"\u8868\u8fde\u63a5",level:3},{value:"Flink SQL",id:"flink-sql",level:2},{value:"\u57fa\u672c\u67e5\u8be2",id:"\u57fa\u672c\u67e5\u8be2-1",level:3},{value:"\u7a97\u53e3\u67e5\u8be2",id:"\u7a97\u53e3\u67e5\u8be2",level:3},{value:"Top-N \u67e5\u8be2",id:"top-n-\u67e5\u8be2",level:3},{value:"Join \u64cd\u4f5c",id:"join-\u64cd\u4f5c",level:3},{value:"\u5185\u7f6e\u51fd\u6570",id:"\u5185\u7f6e\u51fd\u6570",level:2},{value:"\u5b57\u7b26\u4e32\u51fd\u6570",id:"\u5b57\u7b26\u4e32\u51fd\u6570",level:3},{value:"\u65f6\u95f4\u51fd\u6570",id:"\u65f6\u95f4\u51fd\u6570",level:3},{value:"\u805a\u5408\u51fd\u6570",id:"\u805a\u5408\u51fd\u6570",level:3},{value:"\u8fde\u63a5\u5668",id:"\u8fde\u63a5\u5668",level:2},{value:"Kafka \u8fde\u63a5\u5668",id:"kafka-\u8fde\u63a5\u5668",level:3},{value:"JDBC \u8fde\u63a5\u5668",id:"jdbc-\u8fde\u63a5\u5668",level:3},{value:"\u6587\u4ef6\u7cfb\u7edf\u8fde\u63a5\u5668",id:"\u6587\u4ef6\u7cfb\u7edf\u8fde\u63a5\u5668",level:3},{value:"\u7ed3\u679c\u8f93\u51fa",id:"\u7ed3\u679c\u8f93\u51fa",level:2},{value:"\u8f6c\u6362\u4e3a DataStream",id:"\u8f6c\u6362\u4e3a-datastream",level:3},{value:"\u8f93\u51fa\u5230 Sink",id:"\u8f93\u51fa\u5230-sink",level:3},{value:"\u4e0b\u4e00\u6b65",id:"\u4e0b\u4e00\u6b65",level:2}];function c(e){const n={a:"a",blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",ul:"ul",...(0,i.R)(),...e.components};return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(n.header,{children:(0,l.jsx)(n.h1,{id:"table-api-\u4e0e-sql",children:"Table API \u4e0e SQL"})}),"\n",(0,l.jsxs)(n.blockquote,{children:["\n",(0,l.jsx)(n.p,{children:"\u9002\u7528\u7248\u672c\uff1aApache Flink v2.2.0"}),"\n"]}),"\n",(0,l.jsx)(n.h2,{id:"\u6982\u8ff0",children:"\u6982\u8ff0"}),"\n",(0,l.jsx)(n.p,{children:"Flink Table API \u548c SQL \u63d0\u4f9b\u4e86\u7edf\u4e00\u7684\u58f0\u660e\u5f0f API\uff0c\u53ef\u4ee5\u7528\u7c7b\u4f3c\u5173\u7cfb\u578b\u6570\u636e\u5e93\u7684\u65b9\u5f0f\u5904\u7406\u6d41\u548c\u6279\u6570\u636e\u3002"}),"\n",(0,l.jsx)(n.h2,{id:"\u73af\u5883\u914d\u7f6e",children:"\u73af\u5883\u914d\u7f6e"}),"\n",(0,l.jsx)(n.h3,{id:"maven-\u4f9d\u8d56",children:"Maven \u4f9d\u8d56"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-xml",children:"<dependency>\n    <groupId>org.apache.flink</groupId>\n    <artifactId>flink-table-api-java-bridge</artifactId>\n    <version>${flink.version}</version>\n</dependency>\n<dependency>\n    <groupId>org.apache.flink</groupId>\n    <artifactId>flink-table-planner-loader</artifactId>\n    <version>${flink.version}</version>\n</dependency>\n"})}),"\n",(0,l.jsx)(n.h3,{id:"\u521b\u5efa\u8868\u73af\u5883",children:"\u521b\u5efa\u8868\u73af\u5883"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"// \u6d41\u5904\u7406\u8868\u73af\u5883\nStreamExecutionEnvironment env =\n    StreamExecutionEnvironment.getExecutionEnvironment();\nStreamTableEnvironment tableEnv = StreamTableEnvironment.create(env);\n\n// \u7eaf Table API \u73af\u5883\nEnvironmentSettings settings = EnvironmentSettings\n    .newInstance()\n    .inStreamingMode()\n    .build();\nTableEnvironment tableEnv = TableEnvironment.create(settings);\n"})}),"\n",(0,l.jsx)(n.h2,{id:"\u521b\u5efa\u8868",children:"\u521b\u5efa\u8868"}),"\n",(0,l.jsx)(n.h3,{id:"\u4ece-datastream-\u521b\u5efa",children:"\u4ece DataStream \u521b\u5efa"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:'// \u4ece POJO \u6d41\u521b\u5efa\nDataStream<User> userStream = ...;\nTable userTable = tableEnv.fromDataStream(userStream);\n\n// \u6307\u5b9a\u5217\u540d\nTable table = tableEnv.fromDataStream(\n    userStream,\n    $("id"), $("name"), $("age"), $("proctime").proctime()\n);\n'})}),"\n",(0,l.jsx)(n.h3,{id:"\u4f7f\u7528-ddl-\u521b\u5efa",children:"\u4f7f\u7528 DDL \u521b\u5efa"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:'tableEnv.executeSql(\n    "CREATE TABLE orders (" +\n    "   order_id STRING," +\n    "   user_id STRING," +\n    "   amount DECIMAL(10, 2)," +\n    "   order_time TIMESTAMP(3)," +\n    "   WATERMARK FOR order_time AS order_time - INTERVAL \'5\' SECOND" +\n    ") WITH (" +\n    "   \'connector\' = \'kafka\'," +\n    "   \'topic\' = \'orders\'," +\n    "   \'properties.bootstrap.servers\' = \'localhost:9092\'," +\n    "   \'format\' = \'json\'" +\n    ")"\n);\n'})}),"\n",(0,l.jsx)(n.h2,{id:"table-api-\u64cd\u4f5c",children:"Table API \u64cd\u4f5c"}),"\n",(0,l.jsx)(n.h3,{id:"\u57fa\u672c\u67e5\u8be2",children:"\u57fa\u672c\u67e5\u8be2"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:'Table orders = tableEnv.from("orders");\n\n// \u9009\u62e9\u5217\nTable result = orders.select($("order_id"), $("amount"));\n\n// \u8fc7\u6ee4\nTable filtered = orders.filter($("amount").isGreater(100));\n\n// \u522b\u540d\nTable aliased = orders\n    .select($("order_id").as("id"), $("amount").as("total"));\n'})}),"\n",(0,l.jsx)(n.h3,{id:"\u805a\u5408\u64cd\u4f5c",children:"\u805a\u5408\u64cd\u4f5c"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:'// \u7b80\u5355\u805a\u5408\nTable totals = orders\n    .groupBy($("user_id"))\n    .select($("user_id"), $("amount").sum().as("total_amount"));\n\n// \u7a97\u53e3\u805a\u5408\nTable windowedResult = orders\n    .window(Tumble.over(lit(1).hours()).on($("order_time")).as("w"))\n    .groupBy($("user_id"), $("w"))\n    .select(\n        $("user_id"),\n        $("w").start().as("window_start"),\n        $("w").end().as("window_end"),\n        $("amount").sum().as("total_amount")\n    );\n'})}),"\n",(0,l.jsx)(n.h3,{id:"\u8868\u8fde\u63a5",children:"\u8868\u8fde\u63a5"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:'Table orders = tableEnv.from("orders");\nTable users = tableEnv.from("users");\n\n// \u5185\u8fde\u63a5\nTable joined = orders\n    .join(users)\n    .where($("orders.user_id").isEqual($("users.id")))\n    .select($("order_id"), $("users.name"), $("amount"));\n\n// \u5de6\u5916\u8fde\u63a5\nTable leftJoined = orders\n    .leftOuterJoin(users, $("orders.user_id").isEqual($("users.id")))\n    .select($("order_id"), $("users.name"), $("amount"));\n'})}),"\n",(0,l.jsx)(n.h2,{id:"flink-sql",children:"Flink SQL"}),"\n",(0,l.jsx)(n.h3,{id:"\u57fa\u672c\u67e5\u8be2-1",children:"\u57fa\u672c\u67e5\u8be2"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:'// \u6267\u884c\u67e5\u8be2\nTable result = tableEnv.sqlQuery(\n    "SELECT user_id, SUM(amount) as total " +\n    "FROM orders " +\n    "GROUP BY user_id"\n);\n\n// \u6267\u884c DDL/DML\ntableEnv.executeSql("INSERT INTO output_table SELECT * FROM orders");\n'})}),"\n",(0,l.jsx)(n.h3,{id:"\u7a97\u53e3\u67e5\u8be2",children:"\u7a97\u53e3\u67e5\u8be2"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-sql",children:"-- \u6eda\u52a8\u7a97\u53e3\nSELECT\n    user_id,\n    TUMBLE_START(order_time, INTERVAL '1' HOUR) AS window_start,\n    TUMBLE_END(order_time, INTERVAL '1' HOUR) AS window_end,\n    SUM(amount) AS total_amount\nFROM orders\nGROUP BY user_id, TUMBLE(order_time, INTERVAL '1' HOUR);\n\n-- \u6ed1\u52a8\u7a97\u53e3\nSELECT\n    user_id,\n    HOP_START(order_time, INTERVAL '5' MINUTE, INTERVAL '1' HOUR) AS window_start,\n    SUM(amount) AS total_amount\nFROM orders\nGROUP BY user_id, HOP(order_time, INTERVAL '5' MINUTE, INTERVAL '1' HOUR);\n\n-- \u4f1a\u8bdd\u7a97\u53e3\nSELECT\n    user_id,\n    SESSION_START(order_time, INTERVAL '30' MINUTE) AS session_start,\n    COUNT(*) AS order_count\nFROM orders\nGROUP BY user_id, SESSION(order_time, INTERVAL '30' MINUTE);\n"})}),"\n",(0,l.jsx)(n.h3,{id:"top-n-\u67e5\u8be2",children:"Top-N \u67e5\u8be2"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-sql",children:"SELECT * FROM (\n    SELECT\n        user_id,\n        total_amount,\n        ROW_NUMBER() OVER (ORDER BY total_amount DESC) AS rank\n    FROM (\n        SELECT user_id, SUM(amount) AS total_amount\n        FROM orders\n        GROUP BY user_id\n    )\n) WHERE rank <= 10;\n"})}),"\n",(0,l.jsx)(n.h3,{id:"join-\u64cd\u4f5c",children:"Join \u64cd\u4f5c"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-sql",children:"-- \u5e38\u89c4 Join\nSELECT o.order_id, u.name, o.amount\nFROM orders o\nJOIN users u ON o.user_id = u.id;\n\n-- \u65f6\u95f4\u7a97\u53e3 Join\nSELECT o.order_id, p.payment_id, o.amount\nFROM orders o, payments p\nWHERE o.order_id = p.order_id\n  AND p.payment_time BETWEEN o.order_time AND o.order_time + INTERVAL '1' HOUR;\n\n-- Lookup Join\uff08\u7ef4\u8868\u5173\u8054\uff09\nSELECT o.order_id, p.product_name, o.amount\nFROM orders o\nJOIN products FOR SYSTEM_TIME AS OF o.order_time AS p\n  ON o.product_id = p.id;\n"})}),"\n",(0,l.jsx)(n.h2,{id:"\u5185\u7f6e\u51fd\u6570",children:"\u5185\u7f6e\u51fd\u6570"}),"\n",(0,l.jsx)(n.h3,{id:"\u5b57\u7b26\u4e32\u51fd\u6570",children:"\u5b57\u7b26\u4e32\u51fd\u6570"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-sql",children:"SELECT\n    UPPER(name) AS upper_name,\n    LOWER(name) AS lower_name,\n    CONCAT(first_name, ' ', last_name) AS full_name,\n    SUBSTRING(name, 1, 5) AS short_name\nFROM users;\n"})}),"\n",(0,l.jsx)(n.h3,{id:"\u65f6\u95f4\u51fd\u6570",children:"\u65f6\u95f4\u51fd\u6570"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-sql",children:"SELECT\n    order_time,\n    DATE_FORMAT(order_time, 'yyyy-MM-dd') AS date_str,\n    YEAR(order_time) AS year,\n    MONTH(order_time) AS month,\n    CURRENT_TIMESTAMP AS now\nFROM orders;\n"})}),"\n",(0,l.jsx)(n.h3,{id:"\u805a\u5408\u51fd\u6570",children:"\u805a\u5408\u51fd\u6570"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-sql",children:"SELECT\n    user_id,\n    COUNT(*) AS order_count,\n    SUM(amount) AS total_amount,\n    AVG(amount) AS avg_amount,\n    MIN(amount) AS min_amount,\n    MAX(amount) AS max_amount\nFROM orders\nGROUP BY user_id;\n"})}),"\n",(0,l.jsx)(n.h2,{id:"\u8fde\u63a5\u5668",children:"\u8fde\u63a5\u5668"}),"\n",(0,l.jsx)(n.h3,{id:"kafka-\u8fde\u63a5\u5668",children:"Kafka \u8fde\u63a5\u5668"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-sql",children:"CREATE TABLE kafka_source (\n    id STRING,\n    data STRING,\n    ts TIMESTAMP(3),\n    WATERMARK FOR ts AS ts - INTERVAL '5' SECOND\n) WITH (\n    'connector' = 'kafka',\n    'topic' = 'input-topic',\n    'properties.bootstrap.servers' = 'localhost:9092',\n    'properties.group.id' = 'my-group',\n    'scan.startup.mode' = 'earliest-offset',\n    'format' = 'json'\n);\n"})}),"\n",(0,l.jsx)(n.h3,{id:"jdbc-\u8fde\u63a5\u5668",children:"JDBC \u8fde\u63a5\u5668"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-sql",children:"CREATE TABLE jdbc_table (\n    id INT,\n    name STRING,\n    PRIMARY KEY (id) NOT ENFORCED\n) WITH (\n    'connector' = 'jdbc',\n    'url' = 'jdbc:mysql://localhost:3306/mydb',\n    'table-name' = 'users',\n    'username' = 'root',\n    'password' = 'password'\n);\n"})}),"\n",(0,l.jsx)(n.h3,{id:"\u6587\u4ef6\u7cfb\u7edf\u8fde\u63a5\u5668",children:"\u6587\u4ef6\u7cfb\u7edf\u8fde\u63a5\u5668"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-sql",children:"CREATE TABLE file_source (\n    id STRING,\n    name STRING,\n    dt STRING\n) PARTITIONED BY (dt) WITH (\n    'connector' = 'filesystem',\n    'path' = 'hdfs:///data/input',\n    'format' = 'parquet'\n);\n"})}),"\n",(0,l.jsx)(n.h2,{id:"\u7ed3\u679c\u8f93\u51fa",children:"\u7ed3\u679c\u8f93\u51fa"}),"\n",(0,l.jsx)(n.h3,{id:"\u8f6c\u6362\u4e3a-datastream",children:"\u8f6c\u6362\u4e3a DataStream"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:'Table resultTable = tableEnv.sqlQuery("SELECT * FROM orders");\n\n// \u8f6c\u6362\u4e3a DataStream\nDataStream<Row> resultStream = tableEnv.toDataStream(resultTable);\n\n// \u8f6c\u6362\u4e3a changelog \u6d41\uff08\u6709\u66f4\u65b0\u64cd\u4f5c\u65f6\uff09\nDataStream<Row> changelogStream = tableEnv.toChangelogStream(resultTable);\n'})}),"\n",(0,l.jsx)(n.h3,{id:"\u8f93\u51fa\u5230-sink",children:"\u8f93\u51fa\u5230 Sink"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:'tableEnv.executeSql(\n    "INSERT INTO output_table " +\n    "SELECT user_id, SUM(amount) FROM orders GROUP BY user_id"\n);\n'})}),"\n",(0,l.jsx)(n.h2,{id:"\u4e0b\u4e00\u6b65",children:"\u4e0b\u4e00\u6b65"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\ud83d\udcbb ",(0,l.jsx)(n.a,{href:"/docs/flink/datastream-api",children:"DataStream API"})," - \u5e95\u5c42\u6d41\u5904\u7406 API"]}),"\n",(0,l.jsxs)(n.li,{children:["\ud83d\udd27 ",(0,l.jsx)(n.a,{href:"/docs/flink/state-management",children:"\u72b6\u6001\u7ba1\u7406"})," - \u6709\u72b6\u6001\u8ba1\u7b97"]}),"\n",(0,l.jsxs)(n.li,{children:["\ud83d\ude80 ",(0,l.jsx)(n.a,{href:"/docs/flink/performance-optimization",children:"\u6027\u80fd\u4f18\u5316"})," - \u6027\u80fd\u8c03\u4f18\u6307\u5357"]}),"\n"]})]})}function u(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,l.jsx)(n,{...e,children:(0,l.jsx)(c,{...e})}):c(e)}},48885:(e,n,a)=>{a.d(n,{R:()=>t,x:()=>s});var r=a(99378);const l={},i=r.createContext(l);function t(e){const n=r.useContext(i);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function s(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(l):e.components||l:t(e.components),r.createElement(i.Provider,{value:n},e.children)}}}]);