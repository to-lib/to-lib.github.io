"use strict";(globalThis.webpackChunkto_lib_github_io=globalThis.webpackChunkto_lib_github_io||[]).push([[93832],{48885:(n,e,i)=>{i.d(e,{R:()=>s,x:()=>a});var r=i(99378);const d={},l=r.createContext(d);function s(n){const e=r.useContext(l);return r.useMemo(function(){return"function"==typeof n?n(e):{...e,...n}},[e,n])}function a(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(d):n.components||d:s(n.components),r.createElement(l.Provider,{value:e},n.children)}},66102:(n,e,i)=>{i.r(e),i.d(e,{assets:()=>t,contentTitle:()=>a,default:()=>h,frontMatter:()=>s,metadata:()=>r,toc:()=>c});const r=JSON.parse('{"id":"c/debugging","title":"\u8c03\u8bd5\u6280\u5de7","description":"\u638c\u63e1\u8c03\u8bd5\u6280\u5de7\uff0c\u5feb\u901f\u5b9a\u4f4d\u548c\u4fee\u590d\u95ee\u9898\u3002","source":"@site/docs/c/debugging.md","sourceDirName":"c","slug":"/c/debugging","permalink":"/docs/c/debugging","draft":false,"unlisted":false,"editUrl":"https://github.com/to-lib/to-lib.github.io/tree/main/docs/c/debugging.md","tags":[],"version":"current","sidebarPosition":21,"frontMatter":{"sidebar_position":21,"title":"\u8c03\u8bd5\u6280\u5de7"},"sidebar":"c","previous":{"title":"\u6807\u51c6\u5e93\u901f\u67e5","permalink":"/docs/c/stdlib-reference"},"next":{"title":"\u9762\u8bd5\u9898\u6c47\u603b","permalink":"/docs/c/interview-questions"}}');var d=i(22714),l=i(48885);const s={sidebar_position:21,title:"\u8c03\u8bd5\u6280\u5de7"},a="C \u8bed\u8a00\u8c03\u8bd5\u6280\u5de7",t={},c=[{value:"\u5e38\u89c1\u9519\u8bef\u7c7b\u578b",id:"\u5e38\u89c1\u9519\u8bef\u7c7b\u578b",level:2},{value:"\u6bb5\u9519\u8bef (Segmentation Fault)",id:"\u6bb5\u9519\u8bef-segmentation-fault",level:3},{value:"\u5185\u5b58\u6cc4\u6f0f",id:"\u5185\u5b58\u6cc4\u6f0f",level:3},{value:"\u672a\u521d\u59cb\u5316\u53d8\u91cf",id:"\u672a\u521d\u59cb\u5316\u53d8\u91cf",level:3},{value:"\u7f13\u51b2\u533a\u6ea2\u51fa",id:"\u7f13\u51b2\u533a\u6ea2\u51fa",level:3},{value:"GDB \u8c03\u8bd5\u5668",id:"gdb-\u8c03\u8bd5\u5668",level:2},{value:"\u57fa\u672c\u547d\u4ee4",id:"\u57fa\u672c\u547d\u4ee4",level:3},{value:"\u8c03\u8bd5\u5d29\u6e83",id:"\u8c03\u8bd5\u5d29\u6e83",level:3},{value:"Valgrind \u5185\u5b58\u68c0\u6d4b",id:"valgrind-\u5185\u5b58\u68c0\u6d4b",level:2},{value:"\u68c0\u6d4b\u5185\u5b58\u6cc4\u6f0f",id:"\u68c0\u6d4b\u5185\u5b58\u6cc4\u6f0f",level:3},{value:"\u68c0\u6d4b\u65e0\u6548\u8bbf\u95ee",id:"\u68c0\u6d4b\u65e0\u6548\u8bbf\u95ee",level:3},{value:"\u5e38\u89c1 Valgrind \u9519\u8bef",id:"\u5e38\u89c1-valgrind-\u9519\u8bef",level:3},{value:"\u6253\u5370\u8c03\u8bd5",id:"\u6253\u5370\u8c03\u8bd5",level:2},{value:"\u8c03\u8bd5\u5b8f",id:"\u8c03\u8bd5\u5b8f",level:3},{value:"\u5341\u516d\u8fdb\u5236\u8f6c\u50a8",id:"\u5341\u516d\u8fdb\u5236\u8f6c\u50a8",level:3},{value:"AddressSanitizer",id:"addresssanitizer",level:2},{value:"\u9759\u6001\u5206\u6790",id:"\u9759\u6001\u5206\u6790",level:2},{value:"\u8c03\u8bd5\u68c0\u67e5\u6e05\u5355",id:"\u8c03\u8bd5\u68c0\u67e5\u6e05\u5355",level:2},{value:"\u5b9e\u7528\u6280\u5de7",id:"\u5b9e\u7528\u6280\u5de7",level:2}];function o(n){const e={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",p:"p",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",...(0,l.R)(),...n.components};return(0,d.jsxs)(d.Fragment,{children:[(0,d.jsx)(e.header,{children:(0,d.jsx)(e.h1,{id:"c-\u8bed\u8a00\u8c03\u8bd5\u6280\u5de7",children:"C \u8bed\u8a00\u8c03\u8bd5\u6280\u5de7"})}),"\n",(0,d.jsx)(e.p,{children:"\u638c\u63e1\u8c03\u8bd5\u6280\u5de7\uff0c\u5feb\u901f\u5b9a\u4f4d\u548c\u4fee\u590d\u95ee\u9898\u3002"}),"\n",(0,d.jsx)(e.h2,{id:"\u5e38\u89c1\u9519\u8bef\u7c7b\u578b",children:"\u5e38\u89c1\u9519\u8bef\u7c7b\u578b"}),"\n",(0,d.jsx)(e.h3,{id:"\u6bb5\u9519\u8bef-segmentation-fault",children:"\u6bb5\u9519\u8bef (Segmentation Fault)"}),"\n",(0,d.jsx)(e.pre,{children:(0,d.jsx)(e.code,{className:"language-c",children:"// \u539f\u56e01: \u7a7a\u6307\u9488\u89e3\u5f15\u7528\nint *p = NULL;\n*p = 10;  // \u6bb5\u9519\u8bef\uff01\n\n// \u539f\u56e02: \u6570\u7ec4\u8d8a\u754c\nint arr[5];\narr[10] = 100;  // \u6bb5\u9519\u8bef\uff08\u53ef\u80fd\uff09\n\n// \u539f\u56e03: \u6808\u6ea2\u51fa\nvoid infinite_recursion(void) {\n    infinite_recursion();  // \u6808\u6ea2\u51fa\n}\n\n// \u539f\u56e04: \u91ca\u653e\u540e\u4f7f\u7528\nint *p = malloc(sizeof(int));\nfree(p);\n*p = 10;  // \u6bb5\u9519\u8bef\uff08\u53ef\u80fd\uff09\n"})}),"\n",(0,d.jsx)(e.h3,{id:"\u5185\u5b58\u6cc4\u6f0f",children:"\u5185\u5b58\u6cc4\u6f0f"}),"\n",(0,d.jsx)(e.pre,{children:(0,d.jsx)(e.code,{className:"language-c",children:"void memory_leak(void) {\n    int *p = malloc(100 * sizeof(int));\n    // \u5fd8\u8bb0 free(p)\n}  // \u5185\u5b58\u6cc4\u6f0f\uff01\n\n// \u4fee\u590d\nvoid no_leak(void) {\n    int *p = malloc(100 * sizeof(int));\n    // \u4f7f\u7528 p\n    free(p);\n}\n"})}),"\n",(0,d.jsx)(e.h3,{id:"\u672a\u521d\u59cb\u5316\u53d8\u91cf",children:"\u672a\u521d\u59cb\u5316\u53d8\u91cf"}),"\n",(0,d.jsx)(e.pre,{children:(0,d.jsx)(e.code,{className:"language-c",children:"int x;  // \u672a\u521d\u59cb\u5316\uff0c\u503c\u662f\u968f\u673a\u7684\nif (x > 0) {  // \u672a\u5b9a\u4e49\u884c\u4e3a\n    // ...\n}\n\n// \u4fee\u590d\nint x = 0;\n"})}),"\n",(0,d.jsx)(e.h3,{id:"\u7f13\u51b2\u533a\u6ea2\u51fa",children:"\u7f13\u51b2\u533a\u6ea2\u51fa"}),"\n",(0,d.jsx)(e.pre,{children:(0,d.jsx)(e.code,{className:"language-c",children:'char buf[10];\nstrcpy(buf, "This string is too long");  // \u6ea2\u51fa\uff01\n\n// \u4fee\u590d\nchar buf[10];\nstrncpy(buf, "This string is too long", sizeof(buf) - 1);\nbuf[sizeof(buf) - 1] = \'\\0\';\n'})}),"\n",(0,d.jsx)(e.h2,{id:"gdb-\u8c03\u8bd5\u5668",children:"GDB \u8c03\u8bd5\u5668"}),"\n",(0,d.jsx)(e.h3,{id:"\u57fa\u672c\u547d\u4ee4",children:"\u57fa\u672c\u547d\u4ee4"}),"\n",(0,d.jsx)(e.pre,{children:(0,d.jsx)(e.code,{className:"language-bash",children:"# \u7f16\u8bd1\u65f6\u52a0\u8c03\u8bd5\u4fe1\u606f\ngcc -g program.c -o program\n\n# \u542f\u52a8 GDB\ngdb ./program\n\n# \u5e38\u7528\u547d\u4ee4\n(gdb) run                 # \u8fd0\u884c\u7a0b\u5e8f\n(gdb) run arg1 arg2       # \u5e26\u53c2\u6570\u8fd0\u884c\n(gdb) break main          # \u5728 main \u8bbe\u65ad\u70b9\n(gdb) break file.c:20     # \u5728\u7b2c 20 \u884c\u8bbe\u65ad\u70b9\n(gdb) break func if x>10  # \u6761\u4ef6\u65ad\u70b9\n(gdb) info breakpoints    # \u67e5\u770b\u65ad\u70b9\n(gdb) delete 1            # \u5220\u9664\u65ad\u70b9 1\n(gdb) next                # \u5355\u6b65\uff08\u4e0d\u8fdb\u5165\u51fd\u6570\uff09\n(gdb) step                # \u5355\u6b65\uff08\u8fdb\u5165\u51fd\u6570\uff09\n(gdb) continue            # \u7ee7\u7eed\u6267\u884c\n(gdb) print x             # \u6253\u5370\u53d8\u91cf\n(gdb) print *arr@10       # \u6253\u5370\u6570\u7ec4\u524d 10 \u4e2a\u5143\u7d20\n(gdb) backtrace           # \u67e5\u770b\u8c03\u7528\u6808\n(gdb) frame 2             # \u5207\u6362\u5230\u6808\u5e27 2\n(gdb) list                # \u663e\u793a\u6e90\u7801\n(gdb) watch x             # \u76d1\u89c6\u53d8\u91cf\n(gdb) quit                # \u9000\u51fa\n"})}),"\n",(0,d.jsx)(e.h3,{id:"\u8c03\u8bd5\u5d29\u6e83",children:"\u8c03\u8bd5\u5d29\u6e83"}),"\n",(0,d.jsx)(e.pre,{children:(0,d.jsx)(e.code,{className:"language-bash",children:"# \u751f\u6210 core dump\nulimit -c unlimited\n./program  # \u5d29\u6e83\u540e\u751f\u6210 core \u6587\u4ef6\n\n# \u5206\u6790 core dump\ngdb ./program core\n(gdb) backtrace\n"})}),"\n",(0,d.jsx)(e.h2,{id:"valgrind-\u5185\u5b58\u68c0\u6d4b",children:"Valgrind \u5185\u5b58\u68c0\u6d4b"}),"\n",(0,d.jsx)(e.h3,{id:"\u68c0\u6d4b\u5185\u5b58\u6cc4\u6f0f",children:"\u68c0\u6d4b\u5185\u5b58\u6cc4\u6f0f"}),"\n",(0,d.jsx)(e.pre,{children:(0,d.jsx)(e.code,{className:"language-bash",children:"valgrind --leak-check=full ./program\n\n# \u8f93\u51fa\u793a\u4f8b\n==12345== LEAK SUMMARY:\n==12345==    definitely lost: 40 bytes in 1 blocks\n==12345==    indirectly lost: 0 bytes in 0 blocks\n"})}),"\n",(0,d.jsx)(e.h3,{id:"\u68c0\u6d4b\u65e0\u6548\u8bbf\u95ee",children:"\u68c0\u6d4b\u65e0\u6548\u8bbf\u95ee"}),"\n",(0,d.jsx)(e.pre,{children:(0,d.jsx)(e.code,{className:"language-bash",children:"valgrind --track-origins=yes ./program\n\n# \u68c0\u6d4b\u672a\u521d\u59cb\u5316\u5185\u5b58\u4f7f\u7528\n# \u68c0\u6d4b\u8d8a\u754c\u8bbf\u95ee\n# \u68c0\u6d4b\u91ca\u653e\u540e\u4f7f\u7528\n"})}),"\n",(0,d.jsx)(e.h3,{id:"\u5e38\u89c1-valgrind-\u9519\u8bef",children:"\u5e38\u89c1 Valgrind \u9519\u8bef"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,d.jsxs)(e.table,{children:[(0,d.jsx)(e.thead,{children:(0,d.jsxs)(e.tr,{children:[(0,d.jsx)(e.th,{children:"\u9519\u8bef\u7c7b\u578b"}),(0,d.jsx)(e.th,{children:"\u542b\u4e49"})]})}),(0,d.jsxs)(e.tbody,{children:[(0,d.jsxs)(e.tr,{children:[(0,d.jsx)(e.td,{children:"Invalid read/write"}),(0,d.jsx)(e.td,{children:"\u65e0\u6548\u5185\u5b58\u8bbf\u95ee"})]}),(0,d.jsxs)(e.tr,{children:[(0,d.jsx)(e.td,{children:"Use of uninitialised value"}),(0,d.jsx)(e.td,{children:"\u4f7f\u7528\u672a\u521d\u59cb\u5316\u53d8\u91cf"})]}),(0,d.jsxs)(e.tr,{children:[(0,d.jsx)(e.td,{children:"Conditional jump depends on uninitialised value"}),(0,d.jsx)(e.td,{children:"\u6761\u4ef6\u4f9d\u8d56\u672a\u521d\u59cb\u5316\u503c"})]}),(0,d.jsxs)(e.tr,{children:[(0,d.jsx)(e.td,{children:"Invalid free"}),(0,d.jsx)(e.td,{children:"\u65e0\u6548\u7684 free \u8c03\u7528"})]}),(0,d.jsxs)(e.tr,{children:[(0,d.jsx)(e.td,{children:"Mismatched free"}),(0,d.jsx)(e.td,{children:"malloc/free \u4e0d\u5339\u914d"})]})]})]}),"\n",(0,d.jsx)(e.h2,{id:"\u6253\u5370\u8c03\u8bd5",children:"\u6253\u5370\u8c03\u8bd5"}),"\n",(0,d.jsx)(e.h3,{id:"\u8c03\u8bd5\u5b8f",children:"\u8c03\u8bd5\u5b8f"}),"\n",(0,d.jsx)(e.pre,{children:(0,d.jsx)(e.code,{className:"language-c",children:'#include <stdio.h>\n\n#define DEBUG 1\n\n#if DEBUG\n    #define LOG(fmt, ...) \\\n        fprintf(stderr, "[%s:%d] " fmt "\\n", \\\n                __FILE__, __LINE__, ##__VA_ARGS__)\n    #define TRACE() \\\n        fprintf(stderr, "[TRACE] %s:%d %s()\\n", \\\n                __FILE__, __LINE__, __func__)\n#else\n    #define LOG(fmt, ...)\n    #define TRACE()\n#endif\n\nvoid process(int x) {\n    TRACE();\n    LOG("x = %d", x);\n}\n\nint main(void) {\n    LOG("\u7a0b\u5e8f\u542f\u52a8");\n    process(42);\n    LOG("\u7a0b\u5e8f\u7ed3\u675f");\n    return 0;\n}\n'})}),"\n",(0,d.jsx)(e.h3,{id:"\u5341\u516d\u8fdb\u5236\u8f6c\u50a8",children:"\u5341\u516d\u8fdb\u5236\u8f6c\u50a8"}),"\n",(0,d.jsx)(e.pre,{children:(0,d.jsx)(e.code,{className:"language-c",children:'void hex_dump(const void *data, size_t size) {\n    const unsigned char *p = data;\n    for (size_t i = 0; i < size; i++) {\n        printf("%02X ", p[i]);\n        if ((i + 1) % 16 == 0) printf("\\n");\n    }\n    printf("\\n");\n}\n\n// \u4f7f\u7528\nint arr[] = {1, 2, 3};\nhex_dump(arr, sizeof(arr));\n'})}),"\n",(0,d.jsx)(e.h2,{id:"addresssanitizer",children:"AddressSanitizer"}),"\n",(0,d.jsx)(e.pre,{children:(0,d.jsx)(e.code,{className:"language-bash",children:"# \u7f16\u8bd1\u65f6\u542f\u7528\ngcc -fsanitize=address -g program.c -o program\n\n# \u8fd0\u884c\u65f6\u81ea\u52a8\u68c0\u6d4b:\n# - \u5806\u7f13\u51b2\u533a\u6ea2\u51fa\n# - \u6808\u7f13\u51b2\u533a\u6ea2\u51fa\n# - \u5168\u5c40\u7f13\u51b2\u533a\u6ea2\u51fa\n# - \u91ca\u653e\u540e\u4f7f\u7528\n# - \u91cd\u590d\u91ca\u653e\n"})}),"\n",(0,d.jsx)(e.h2,{id:"\u9759\u6001\u5206\u6790",children:"\u9759\u6001\u5206\u6790"}),"\n",(0,d.jsx)(e.pre,{children:(0,d.jsx)(e.code,{className:"language-bash",children:"# GCC \u8b66\u544a\ngcc -Wall -Wextra -Werror program.c\n\n# Clang \u9759\u6001\u5206\u6790\nclang --analyze program.c\n\n# Cppcheck\ncppcheck --enable=all program.c\n"})}),"\n",(0,d.jsx)(e.h2,{id:"\u8c03\u8bd5\u68c0\u67e5\u6e05\u5355",children:"\u8c03\u8bd5\u68c0\u67e5\u6e05\u5355"}),"\n",(0,d.jsx)(e.pre,{children:(0,d.jsx)(e.code,{children:"\u25a1 \u7f16\u8bd1\u65f6\u5f00\u542f\u6240\u6709\u8b66\u544a (-Wall -Wextra)\n\u25a1 \u68c0\u67e5\u6240\u6709 malloc \u8fd4\u56de\u503c\n\u25a1 \u786e\u4fdd\u6bcf\u4e2a malloc \u5bf9\u5e94\u4e00\u4e2a free\n\u25a1 \u6570\u7ec4\u8bbf\u95ee\u68c0\u67e5\u8fb9\u754c\n\u25a1 \u6307\u9488\u4f7f\u7528\u524d\u68c0\u67e5 NULL\n\u25a1 \u5b57\u7b26\u4e32\u64cd\u4f5c\u4f7f\u7528\u5b89\u5168\u51fd\u6570 (strncpy, snprintf)\n\u25a1 \u521d\u59cb\u5316\u6240\u6709\u53d8\u91cf\n\u25a1 \u4f7f\u7528 Valgrind \u68c0\u6d4b\u5185\u5b58\u95ee\u9898\n\u25a1 \u4f7f\u7528 AddressSanitizer \u8fdb\u884c\u6d4b\u8bd5\n"})}),"\n",(0,d.jsx)(e.h2,{id:"\u5b9e\u7528\u6280\u5de7",children:"\u5b9e\u7528\u6280\u5de7"}),"\n",(0,d.jsx)(e.pre,{children:(0,d.jsx)(e.code,{className:"language-c",children:'// 1. \u65ad\u8a00\u68c0\u67e5\n#include <assert.h>\nassert(ptr != NULL);\nassert(index < size);\n\n// 2. \u5b89\u5168\u7684\u5185\u5b58\u5206\u914d\nvoid *safe_malloc(size_t size) {\n    void *p = malloc(size);\n    if (p == NULL) {\n        fprintf(stderr, "\u5185\u5b58\u5206\u914d\u5931\u8d25\\n");\n        exit(1);\n    }\n    return p;\n}\n\n// 3. \u8fb9\u754c\u68c0\u67e5\u7684\u6570\u7ec4\u8bbf\u95ee\nint safe_get(int *arr, int size, int index) {\n    assert(index >= 0 && index < size);\n    return arr[index];\n}\n\n// 4. \u91ca\u653e\u540e\u7f6e\u7a7a\n#define SAFE_FREE(p) do { free(p); p = NULL; } while(0)\n'})}),"\n",(0,d.jsx)(e.p,{children:"\u719f\u7ec3\u638c\u63e1\u8c03\u8bd5\u6280\u5de7\uff0c\u8ba9 bug \u65e0\u5904\u53ef\u85cf\uff01\ud83d\udd0d"})]})}function h(n={}){const{wrapper:e}={...(0,l.R)(),...n.components};return e?(0,d.jsx)(e,{...n,children:(0,d.jsx)(o,{...n})}):o(n)}}}]);