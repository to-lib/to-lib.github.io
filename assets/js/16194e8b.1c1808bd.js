"use strict";(globalThis.webpackChunkto_lib_github_io=globalThis.webpackChunkto_lib_github_io||[]).push([[4231],{48885:(e,n,r)=>{r.d(n,{R:()=>c,x:()=>i});var s=r(99378);const l={},d=s.createContext(l);function c(e){const n=s.useContext(d);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function i(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(l):e.components||l:c(e.components),s.createElement(d.Provider,{value:n},e.children)}},69192:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>t,contentTitle:()=>i,default:()=>u,frontMatter:()=>c,metadata:()=>s,toc:()=>o});const s=JSON.parse('{"id":"rocketmq/best-practices","title":"\u6700\u4f73\u5b9e\u8df5","description":"RocketMQ \u751f\u4ea7\u73af\u5883\u6700\u4f73\u5b9e\u8df5\u6307\u5357","source":"@site/docs/rocketmq/best-practices.md","sourceDirName":"rocketmq","slug":"/rocketmq/best-practices","permalink":"/docs/rocketmq/best-practices","draft":false,"unlisted":false,"editUrl":"https://github.com/to-lib/to-lib.github.io/tree/main/docs/rocketmq/best-practices.md","tags":[],"version":"current","sidebarPosition":11,"frontMatter":{"sidebar_position":11,"title":"\u6700\u4f73\u5b9e\u8df5","description":"RocketMQ \u751f\u4ea7\u73af\u5883\u6700\u4f73\u5b9e\u8df5\u6307\u5357"},"sidebar":"rocketmq","previous":{"title":"\u6392\u969c\u624b\u518c","permalink":"/docs/rocketmq/troubleshooting"},"next":{"title":"\u5feb\u901f\u53c2\u8003","permalink":"/docs/rocketmq/quick-reference"}}');var l=r(22714),d=r(48885);const c={sidebar_position:11,title:"\u6700\u4f73\u5b9e\u8df5",description:"RocketMQ \u751f\u4ea7\u73af\u5883\u6700\u4f73\u5b9e\u8df5\u6307\u5357"},i="RocketMQ \u6700\u4f73\u5b9e\u8df5",t={},o=[{value:"\u751f\u4ea7\u8005\u6700\u4f73\u5b9e\u8df5",id:"\u751f\u4ea7\u8005\u6700\u4f73\u5b9e\u8df5",level:2},{value:"1. \u5408\u7406\u8bbe\u7f6e Producer Group",id:"1-\u5408\u7406\u8bbe\u7f6e-producer-group",level:3},{value:"2. \u9009\u62e9\u5408\u9002\u7684\u53d1\u9001\u65b9\u5f0f",id:"2-\u9009\u62e9\u5408\u9002\u7684\u53d1\u9001\u65b9\u5f0f",level:3},{value:"3. \u6d88\u606f Key \u8bbe\u8ba1",id:"3-\u6d88\u606f-key-\u8bbe\u8ba1",level:3},{value:"4. \u6d88\u606f\u4f53\u8bbe\u8ba1",id:"4-\u6d88\u606f\u4f53\u8bbe\u8ba1",level:3},{value:"5. \u91cd\u8bd5\u4e0e\u8d85\u65f6\u914d\u7f6e",id:"5-\u91cd\u8bd5\u4e0e\u8d85\u65f6\u914d\u7f6e",level:3},{value:"\u6d88\u8d39\u8005\u6700\u4f73\u5b9e\u8df5",id:"\u6d88\u8d39\u8005\u6700\u4f73\u5b9e\u8df5",level:2},{value:"1. \u6d88\u8d39\u5e42\u7b49\u6027",id:"1-\u6d88\u8d39\u5e42\u7b49\u6027",level:3},{value:"2. \u6d88\u8d39\u7ebf\u7a0b\u6c60\u914d\u7f6e",id:"2-\u6d88\u8d39\u7ebf\u7a0b\u6c60\u914d\u7f6e",level:3},{value:"3. \u6d88\u8d39\u5931\u8d25\u5904\u7406",id:"3-\u6d88\u8d39\u5931\u8d25\u5904\u7406",level:3},{value:"4. \u6d88\u8d39\u4f4d\u70b9\u7ba1\u7406",id:"4-\u6d88\u8d39\u4f4d\u70b9\u7ba1\u7406",level:3},{value:"5. \u4f18\u96c5\u505c\u673a",id:"5-\u4f18\u96c5\u505c\u673a",level:3},{value:"Topic \u8bbe\u8ba1\u89c4\u8303",id:"topic-\u8bbe\u8ba1\u89c4\u8303",level:2},{value:"1. \u547d\u540d\u89c4\u8303",id:"1-\u547d\u540d\u89c4\u8303",level:3},{value:"2. Topic vs Tag \u9009\u62e9",id:"2-topic-vs-tag-\u9009\u62e9",level:3},{value:"3. Queue \u6570\u91cf\u89c4\u5212",id:"3-queue-\u6570\u91cf\u89c4\u5212",level:3},{value:"\u9ad8\u53ef\u7528\u90e8\u7f72\u5efa\u8bae",id:"\u9ad8\u53ef\u7528\u90e8\u7f72\u5efa\u8bae",level:2},{value:"1. NameServer \u90e8\u7f72",id:"1-nameserver-\u90e8\u7f72",level:3},{value:"2. Broker \u90e8\u7f72",id:"2-broker-\u90e8\u7f72",level:3},{value:"3. \u5ba2\u6237\u7aef\u5bb9\u9519",id:"3-\u5ba2\u6237\u7aef\u5bb9\u9519",level:3},{value:"\u5e38\u89c1\u9677\u9631\u4e0e\u907f\u514d",id:"\u5e38\u89c1\u9677\u9631\u4e0e\u907f\u514d",level:2},{value:"1. \u6d88\u606f\u5806\u79ef",id:"1-\u6d88\u606f\u5806\u79ef",level:3},{value:"2. \u6d88\u606f\u4e22\u5931",id:"2-\u6d88\u606f\u4e22\u5931",level:3},{value:"3. \u6d88\u606f\u91cd\u590d",id:"3-\u6d88\u606f\u91cd\u590d",level:3},{value:"4. \u987a\u5e8f\u6d88\u606f\u6d88\u8d39\u5361\u4f4f",id:"4-\u987a\u5e8f\u6d88\u606f\u6d88\u8d39\u5361\u4f4f",level:3},{value:"5. \u4e8b\u52a1\u6d88\u606f\u56de\u67e5\u5931\u8d25",id:"5-\u4e8b\u52a1\u6d88\u606f\u56de\u67e5\u5931\u8d25",level:3},{value:"\u5b89\u5168\u914d\u7f6e",id:"\u5b89\u5168\u914d\u7f6e",level:2},{value:"1. ACL \u8bbf\u95ee\u63a7\u5236",id:"1-acl-\u8bbf\u95ee\u63a7\u5236",level:3},{value:"2. \u5ba2\u6237\u7aef\u914d\u7f6e",id:"2-\u5ba2\u6237\u7aef\u914d\u7f6e",level:3},{value:"\u65e5\u5fd7\u4e0e\u76d1\u63a7",id:"\u65e5\u5fd7\u4e0e\u76d1\u63a7",level:2},{value:"1. \u5173\u952e\u65e5\u5fd7\u914d\u7f6e",id:"1-\u5173\u952e\u65e5\u5fd7\u914d\u7f6e",level:3},{value:"2. \u4e1a\u52a1\u65e5\u5fd7",id:"2-\u4e1a\u52a1\u65e5\u5fd7",level:3},{value:"\u4e0b\u4e00\u6b65",id:"\u4e0b\u4e00\u6b65",level:2},{value:"\u53c2\u8003\u8d44\u6599",id:"\u53c2\u8003\u8d44\u6599",level:2}];function a(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,d.R)(),...e.components};return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(n.header,{children:(0,l.jsx)(n.h1,{id:"rocketmq-\u6700\u4f73\u5b9e\u8df5",children:"RocketMQ \u6700\u4f73\u5b9e\u8df5"})}),"\n",(0,l.jsx)(n.p,{children:"\u672c\u6587\u6863\u603b\u7ed3\u4e86 RocketMQ \u5728\u751f\u4ea7\u73af\u5883\u4e2d\u7684\u6700\u4f73\u5b9e\u8df5\uff0c\u5e2e\u52a9\u4f60\u6784\u5efa\u9ad8\u53ef\u7528\u3001\u9ad8\u6027\u80fd\u7684\u6d88\u606f\u7cfb\u7edf\u3002"}),"\n",(0,l.jsx)(n.h2,{id:"\u751f\u4ea7\u8005\u6700\u4f73\u5b9e\u8df5",children:"\u751f\u4ea7\u8005\u6700\u4f73\u5b9e\u8df5"}),"\n",(0,l.jsx)(n.h3,{id:"1-\u5408\u7406\u8bbe\u7f6e-producer-group",children:"1. \u5408\u7406\u8bbe\u7f6e Producer Group"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:'// \u540c\u4e00\u4e2a\u5e94\u7528\u4f7f\u7528\u540c\u4e00\u4e2a ProducerGroup\nDefaultMQProducer producer = new DefaultMQProducer("OrderService_Producer");\n\n// \u4e0d\u8981\u6bcf\u6b21\u53d1\u9001\u90fd\u521b\u5efa\u65b0\u7684\u751f\u4ea7\u8005\n// \u274c \u9519\u8bef\u793a\u4f8b\nfor (int i = 0; i < 1000; i++) {\n    DefaultMQProducer producer = new DefaultMQProducer("Group_" + i);\n    producer.start();\n    producer.send(msg);\n    producer.shutdown();  // \u9891\u7e41\u521b\u5efa\u9500\u6bc1\n}\n\n// \u2705 \u6b63\u786e\u793a\u4f8b\nDefaultMQProducer producer = new DefaultMQProducer("OrderService_Producer");\nproducer.start();\nfor (int i = 0; i < 1000; i++) {\n    producer.send(msg);\n}\n'})}),"\n",(0,l.jsx)(n.h3,{id:"2-\u9009\u62e9\u5408\u9002\u7684\u53d1\u9001\u65b9\u5f0f",children:"2. \u9009\u62e9\u5408\u9002\u7684\u53d1\u9001\u65b9\u5f0f"}),"\n",(0,l.jsxs)(n.table,{children:[(0,l.jsx)(n.thead,{children:(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.th,{children:"\u53d1\u9001\u65b9\u5f0f"}),(0,l.jsx)(n.th,{children:"\u9002\u7528\u573a\u666f"}),(0,l.jsx)(n.th,{children:"\u793a\u4f8b"})]})}),(0,l.jsxs)(n.tbody,{children:[(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:"\u540c\u6b65\u53d1\u9001"}),(0,l.jsx)(n.td,{children:"\u91cd\u8981\u6d88\u606f\uff0c\u9700\u8981\u786e\u8ba4\u7ed3\u679c"}),(0,l.jsx)(n.td,{children:"\u8ba2\u5355\u3001\u652f\u4ed8"})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:"\u5f02\u6b65\u53d1\u9001"}),(0,l.jsx)(n.td,{children:"\u54cd\u5e94\u65f6\u95f4\u654f\u611f\uff0c\u5141\u8bb8\u56de\u8c03\u5904\u7406"}),(0,l.jsx)(n.td,{children:"\u901a\u77e5\u3001\u65e5\u5fd7"})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:"\u5355\u5411\u53d1\u9001"}),(0,l.jsx)(n.td,{children:"\u4e0d\u5173\u5fc3\u53d1\u9001\u7ed3\u679c"}),(0,l.jsx)(n.td,{children:"\u65e5\u5fd7\u91c7\u96c6"})]})]})]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"// \u91cd\u8981\u4e1a\u52a1\u4f7f\u7528\u540c\u6b65\u53d1\u9001\nSendResult result = producer.send(msg);\nif (result.getSendStatus() == SendStatus.SEND_OK) {\n    // \u5904\u7406\u6210\u529f\u903b\u8f91\n}\n\n// \u9ad8\u541e\u5410\u573a\u666f\u4f7f\u7528\u5f02\u6b65\u53d1\u9001\nproducer.send(msg, new SendCallback() {\n    @Override\n    public void onSuccess(SendResult result) {\n        // \u5f02\u6b65\u5904\u7406\u6210\u529f\n    }\n    @Override\n    public void onException(Throwable e) {\n        // \u8bb0\u5f55\u5931\u8d25\uff0c\u540e\u7eed\u91cd\u8bd5\n        saveFailedMessage(msg);\n    }\n});\n"})}),"\n",(0,l.jsx)(n.h3,{id:"3-\u6d88\u606f-key-\u8bbe\u8ba1",children:"3. \u6d88\u606f Key \u8bbe\u8ba1"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:'// \u2705 \u4f7f\u7528\u6709\u610f\u4e49\u7684\u4e1a\u52a1 Key\nmsg.setKeys("ORDER_" + orderId);\n\n// \u2705 \u591a\u4e2a Key \u7528\u7a7a\u683c\u5206\u9694\nmsg.setKeys("ORDER_123 USER_456 PRODUCT_789");\n\n// \u274c \u907f\u514d\u4f7f\u7528\u65e0\u610f\u4e49\u7684 Key\nmsg.setKeys(UUID.randomUUID().toString());\n'})}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.strong,{children:"Key \u7684\u4f5c\u7528\uff1a"})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"\u6d88\u606f\u67e5\u8be2\u548c\u8ffd\u8e2a"}),"\n",(0,l.jsx)(n.li,{children:"\u987a\u5e8f\u6d88\u606f\u7684\u8def\u7531\u4f9d\u636e"}),"\n",(0,l.jsx)(n.li,{children:"\u6545\u969c\u6392\u67e5\u7684\u5173\u952e\u7ebf\u7d22"}),"\n"]}),"\n",(0,l.jsx)(n.h3,{id:"4-\u6d88\u606f\u4f53\u8bbe\u8ba1",children:"4. \u6d88\u606f\u4f53\u8bbe\u8ba1"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"// \u2705 \u4f7f\u7528\u7d27\u51d1\u7684\u5e8f\u5217\u5316\u683c\u5f0f\n// JSON\uff08\u53ef\u8bfb\u6027\u597d\uff09\u6216 Protobuf\uff08\u6027\u80fd\u597d\uff09\nString json = JSON.toJSONString(order);\nmsg.setBody(json.getBytes(StandardCharsets.UTF_8));\n\n// \u2705 \u63a7\u5236\u6d88\u606f\u5927\u5c0f\uff08\u5efa\u8bae < 1MB\uff09\nif (body.length > 1024 * 1024) {\n    // \u8003\u8651\u5206\u7247\u6216\u5b58\u50a8\u5230 OSS\n    String fileUrl = uploadToOSS(largeData);\n    msg.setBody(fileUrl.getBytes());\n}\n"})}),"\n",(0,l.jsx)(n.h3,{id:"5-\u91cd\u8bd5\u4e0e\u8d85\u65f6\u914d\u7f6e",children:"5. \u91cd\u8bd5\u4e0e\u8d85\u65f6\u914d\u7f6e"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"// \u53d1\u9001\u8d85\u65f6\uff08\u6839\u636e\u7f51\u7edc\u60c5\u51b5\u8c03\u6574\uff09\nproducer.setSendMsgTimeout(5000);\n\n// \u540c\u6b65\u53d1\u9001\u91cd\u8bd5\u6b21\u6570\nproducer.setRetryTimesWhenSendFailed(3);\n\n// \u5f02\u6b65\u53d1\u9001\u91cd\u8bd5\u6b21\u6570\nproducer.setRetryTimesWhenSendAsyncFailed(3);\n\n// \u53d1\u9001\u5931\u8d25\u65f6\u5207\u6362 Broker\nproducer.setRetryAnotherBrokerWhenNotStoreOK(true);\n"})}),"\n",(0,l.jsx)(n.h2,{id:"\u6d88\u8d39\u8005\u6700\u4f73\u5b9e\u8df5",children:"\u6d88\u8d39\u8005\u6700\u4f73\u5b9e\u8df5"}),"\n",(0,l.jsx)(n.h3,{id:"1-\u6d88\u8d39\u5e42\u7b49\u6027",children:"1. \u6d88\u8d39\u5e42\u7b49\u6027"}),"\n",(0,l.jsx)(n.p,{children:"\u6d88\u606f\u53ef\u80fd\u91cd\u590d\u6295\u9012\uff0c\u5fc5\u987b\u5b9e\u73b0\u5e42\u7b49\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:'// \u65b9\u6cd51\uff1a\u6570\u636e\u5e93\u552f\u4e00\u952e\n@Transactional\npublic void processOrder(String orderId) {\n    try {\n        orderDao.insert(order);  // \u552f\u4e00\u952e\u51b2\u7a81\u4f1a\u629b\u5f02\u5e38\n    } catch (DuplicateKeyException e) {\n        log.info("\u8ba2\u5355\u5df2\u5904\u7406: {}", orderId);\n        return;\n    }\n}\n\n// \u65b9\u6cd52\uff1aRedis \u53bb\u91cd\npublic boolean tryConsume(String msgId) {\n    Boolean success = redis.opsForValue()\n        .setIfAbsent("consumed:" + msgId, "1", 24, TimeUnit.HOURS);\n    return Boolean.TRUE.equals(success);\n}\n\n// \u65b9\u6cd53\uff1a\u4e1a\u52a1\u72b6\u6001\u68c0\u67e5\npublic void processPayment(String orderId) {\n    Order order = orderDao.findById(orderId);\n    if (order.getStatus() == OrderStatus.PAID) {\n        log.info("\u8ba2\u5355\u5df2\u652f\u4ed8: {}", orderId);\n        return;\n    }\n    // \u5904\u7406\u652f\u4ed8\u903b\u8f91\n}\n'})}),"\n",(0,l.jsx)(n.h3,{id:"2-\u6d88\u8d39\u7ebf\u7a0b\u6c60\u914d\u7f6e",children:"2. \u6d88\u8d39\u7ebf\u7a0b\u6c60\u914d\u7f6e"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"// \u6839\u636e\u4e1a\u52a1\u7279\u70b9\u914d\u7f6e\u7ebf\u7a0b\u6570\n// CPU \u5bc6\u96c6\u578b\uff1a\u7ebf\u7a0b\u6570 = CPU \u6838\u5fc3\u6570 + 1\n// IO \u5bc6\u96c6\u578b\uff1a\u7ebf\u7a0b\u6570 = CPU \u6838\u5fc3\u6570 * 2\n\nconsumer.setConsumeThreadMin(20);\nconsumer.setConsumeThreadMax(64);\n\n// \u6bcf\u6b21\u6d88\u8d39\u7684\u6d88\u606f\u6570\u91cf\nconsumer.setConsumeMessageBatchMaxSize(1);  // \u9ed8\u8ba4 1\n\n// \u6279\u91cf\u6d88\u8d39\u573a\u666f\nconsumer.setConsumeMessageBatchMaxSize(10);\n"})}),"\n",(0,l.jsx)(n.h3,{id:"3-\u6d88\u8d39\u5931\u8d25\u5904\u7406",children:"3. \u6d88\u8d39\u5931\u8d25\u5904\u7406"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:'consumer.registerMessageListener((MessageListenerConcurrently) (msgs, context) -> {\n    for (MessageExt msg : msgs) {\n        int reconsumeTimes = msg.getReconsumeTimes();\n\n        // \u591a\u6b21\u91cd\u8bd5\u5931\u8d25\uff0c\u4eba\u5de5\u4ecb\u5165\n        if (reconsumeTimes >= 3) {\n            log.error("\u6d88\u8d39\u5931\u8d25\u8d85\u8fc73\u6b21: {}", msg.getMsgId());\n            saveToDeadLetterDB(msg);  // \u4fdd\u5b58\u5230\u6570\u636e\u5e93\n            alertService.send("\u6d88\u606f\u6d88\u8d39\u5931\u8d25\u544a\u8b66", msg);\n            return ConsumeConcurrentlyStatus.CONSUME_SUCCESS;  // \u4e0d\u518d\u91cd\u8bd5\n        }\n\n        try {\n            processMessage(msg);\n        } catch (Exception e) {\n            log.error("\u6d88\u8d39\u5931\u8d25\uff0c\u5c06\u91cd\u8bd5", e);\n            return ConsumeConcurrentlyStatus.RECONSUME_LATER;\n        }\n    }\n    return ConsumeConcurrentlyStatus.CONSUME_SUCCESS;\n});\n'})}),"\n",(0,l.jsx)(n.h3,{id:"4-\u6d88\u8d39\u4f4d\u70b9\u7ba1\u7406",children:"4. \u6d88\u8d39\u4f4d\u70b9\u7ba1\u7406"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:'// \u9996\u6b21\u6d88\u8d39\u4f4d\u7f6e\n// CONSUME_FROM_LAST_OFFSET: \u4ece\u6700\u65b0\u6d88\u606f\u5f00\u59cb\uff08\u63a8\u8350\uff09\n// CONSUME_FROM_FIRST_OFFSET: \u4ece\u5934\u5f00\u59cb\nconsumer.setConsumeFromWhere(ConsumeFromWhere.CONSUME_FROM_LAST_OFFSET);\n\n// \u6307\u5b9a\u65f6\u95f4\u5f00\u59cb\u6d88\u8d39\nconsumer.setConsumeFromWhere(ConsumeFromWhere.CONSUME_FROM_TIMESTAMP);\nconsumer.setConsumeTimestamp("20240101120000");\n'})}),"\n",(0,l.jsx)(n.h3,{id:"5-\u4f18\u96c5\u505c\u673a",children:"5. \u4f18\u96c5\u505c\u673a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:'// \u6dfb\u52a0\u5173\u95ed\u94a9\u5b50\nRuntime.getRuntime().addShutdownHook(new Thread(() -> {\n    log.info("\u6b63\u5728\u5173\u95ed\u6d88\u8d39\u8005...");\n    consumer.shutdown();\n    log.info("\u6d88\u8d39\u8005\u5df2\u5173\u95ed");\n}));\n\n// Spring Boot \u4e2d\u4f7f\u7528 @PreDestroy\n@PreDestroy\npublic void destroy() {\n    consumer.shutdown();\n}\n'})}),"\n",(0,l.jsx)(n.h2,{id:"topic-\u8bbe\u8ba1\u89c4\u8303",children:"Topic \u8bbe\u8ba1\u89c4\u8303"}),"\n",(0,l.jsx)(n.h3,{id:"1-\u547d\u540d\u89c4\u8303",children:"1. \u547d\u540d\u89c4\u8303"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{children:"# \u683c\u5f0f\uff1a\u4e1a\u52a1\u57df_\u5e94\u7528\u540d_\u529f\u80fd_\u73af\u5883\norder_service_create_prod\npayment_service_callback_dev\n\n# \u907f\u514d\u4f7f\u7528\nTopicTest          # \u65e0\u610f\u4e49\nmyTopic            # \u4e0d\u89c4\u8303\norder-create       # \u4f7f\u7528\u4e0b\u5212\u7ebf\u800c\u975e\u8fde\u5b57\u7b26\n"})}),"\n",(0,l.jsx)(n.h3,{id:"2-topic-vs-tag-\u9009\u62e9",children:"2. Topic vs Tag \u9009\u62e9"}),"\n",(0,l.jsxs)(n.table,{children:[(0,l.jsx)(n.thead,{children:(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.th,{children:"\u573a\u666f"}),(0,l.jsx)(n.th,{children:"\u5efa\u8bae"})]})}),(0,l.jsxs)(n.tbody,{children:[(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:"\u5b8c\u5168\u4e0d\u540c\u7684\u4e1a\u52a1"}),(0,l.jsx)(n.td,{children:"\u4f7f\u7528\u4e0d\u540c Topic"})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:"\u540c\u4e00\u4e1a\u52a1\u4e0d\u540c\u7c7b\u578b"}),(0,l.jsx)(n.td,{children:"\u4f7f\u7528\u4e0d\u540c Tag"})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:"\u9700\u8981\u9694\u79bb\u7684\u6570\u636e"}),(0,l.jsx)(n.td,{children:"\u4f7f\u7528\u4e0d\u540c Topic"})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:"\u4ec5\u9700\u8fc7\u6ee4\u7684\u6570\u636e"}),(0,l.jsx)(n.td,{children:"\u4f7f\u7528\u4e0d\u540c Tag"})]})]})]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:'// \u2705 \u8ba2\u5355\u7684\u4e0d\u540c\u72b6\u6001\u4f7f\u7528 Tag\nMessage createMsg = new Message("OrderTopic", "create", body);\nMessage payMsg = new Message("OrderTopic", "pay", body);\nMessage shipMsg = new Message("OrderTopic", "ship", body);\n\n// \u2705 \u4e0d\u540c\u4e1a\u52a1\u4f7f\u7528\u4e0d\u540c Topic\nMessage orderMsg = new Message("OrderTopic", "create", body);\nMessage paymentMsg = new Message("PaymentTopic", "success", body);\n'})}),"\n",(0,l.jsx)(n.h3,{id:"3-queue-\u6570\u91cf\u89c4\u5212",children:"3. Queue \u6570\u91cf\u89c4\u5212"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"# Queue \u6570\u91cf >= \u6d88\u8d39\u8005\u5b9e\u4f8b\u6570\n# \u5efa\u8bae\uff1aQueue \u6570\u91cf = \u6d88\u8d39\u8005\u5b9e\u4f8b\u6570 * 2\uff08\u9884\u7559\u6269\u5c55\u7a7a\u95f4\uff09\n\n# \u521b\u5efa Topic \u65f6\u6307\u5b9a Queue \u6570\u91cf\nsh bin/mqadmin updateTopic -n localhost:9876 -t OrderTopic -r 8 -w 8\n"})}),"\n",(0,l.jsx)(n.h2,{id:"\u9ad8\u53ef\u7528\u90e8\u7f72\u5efa\u8bae",children:"\u9ad8\u53ef\u7528\u90e8\u7f72\u5efa\u8bae"}),"\n",(0,l.jsx)(n.h3,{id:"1-nameserver-\u90e8\u7f72",children:"1. NameServer \u90e8\u7f72"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"# \u81f3\u5c11\u90e8\u7f72 2 \u4e2a NameServer\n# \u5404\u8282\u70b9\u914d\u7f6e\u76f8\u540c\uff0c\u65e0\u72b6\u6001\n\n# \u751f\u4ea7\u8005/\u6d88\u8d39\u8005\u914d\u7f6e\u591a\u4e2a NameServer\nnamesrvAddr=192.168.1.1:9876;192.168.1.2:9876\n"})}),"\n",(0,l.jsx)(n.h3,{id:"2-broker-\u90e8\u7f72",children:"2. Broker \u90e8\u7f72"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{children:"# \u63a8\u8350\uff1a2 Master + 2 Slave \u67b6\u6784\nBroker-a-master (192.168.1.1)\n  \u2514\u2500\u2500 Broker-a-slave (192.168.1.2)\nBroker-b-master (192.168.1.3)\n  \u2514\u2500\u2500 Broker-b-slave (192.168.1.4)\n"})}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.strong,{children:"Broker \u914d\u7f6e\u5efa\u8bae\uff1a"})}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-properties",children:"# broker.conf\nbrokerClusterName=DefaultCluster\nbrokerName=broker-a\nbrokerId=0\nnamesrvAddr=192.168.1.1:9876;192.168.1.2:9876\n\n# \u540c\u6b65\u5237\u76d8\uff08\u91d1\u878d\u573a\u666f\uff09\nflushDiskType=SYNC_FLUSH\n\n# \u540c\u6b65\u590d\u5236\uff08\u9ad8\u53ef\u9760\uff09\nbrokerRole=SYNC_MASTER\n\n# \u6d88\u606f\u4fdd\u7559\u65f6\u95f4\uff08\u5c0f\u65f6\uff09\nfileReservedTime=72\n\n# \u5220\u9664\u8fc7\u671f\u6587\u4ef6\u65f6\u95f4\u70b9\ndeleteWhen=04\n"})}),"\n",(0,l.jsx)(n.h3,{id:"3-\u5ba2\u6237\u7aef\u5bb9\u9519",children:"3. \u5ba2\u6237\u7aef\u5bb9\u9519"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"// \u751f\u4ea7\u8005\u5bb9\u9519\nproducer.setRetryTimesWhenSendFailed(3);\nproducer.setRetryAnotherBrokerWhenNotStoreOK(true);\n\n// \u6d88\u8d39\u8005\u5bb9\u9519\nconsumer.setMaxReconsumeTimes(16);\n"})}),"\n",(0,l.jsx)(n.h2,{id:"\u5e38\u89c1\u9677\u9631\u4e0e\u907f\u514d",children:"\u5e38\u89c1\u9677\u9631\u4e0e\u907f\u514d"}),"\n",(0,l.jsx)(n.h3,{id:"1-\u6d88\u606f\u5806\u79ef",children:"1. \u6d88\u606f\u5806\u79ef"}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:"\u539f\u56e0\uff1a"})," \u6d88\u8d39\u901f\u5ea6 < \u751f\u4ea7\u901f\u5ea6"]}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.strong,{children:"\u89e3\u51b3\uff1a"})}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"// \u589e\u52a0\u6d88\u8d39\u8005\u5b9e\u4f8b\uff08\u4e0d\u8d85\u8fc7 Queue \u6570\u91cf\uff09\n// \u589e\u52a0\u6d88\u8d39\u7ebf\u7a0b\nconsumer.setConsumeThreadMax(64);\n\n// \u6279\u91cf\u6d88\u8d39\nconsumer.setConsumeMessageBatchMaxSize(10);\n"})}),"\n",(0,l.jsx)(n.h3,{id:"2-\u6d88\u606f\u4e22\u5931",children:"2. \u6d88\u606f\u4e22\u5931"}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:"\u539f\u56e0\uff1a"})," \u5f02\u6b65\u5237\u76d8 + \u5f02\u6b65\u590d\u5236"]}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.strong,{children:"\u89e3\u51b3\uff1a"})}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-properties",children:"# \u540c\u6b65\u5237\u76d8\nflushDiskType=SYNC_FLUSH\n\n# \u540c\u6b65\u590d\u5236\nbrokerRole=SYNC_MASTER\n"})}),"\n",(0,l.jsx)(n.h3,{id:"3-\u6d88\u606f\u91cd\u590d",children:"3. \u6d88\u606f\u91cd\u590d"}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:"\u539f\u56e0\uff1a"})," \u7f51\u7edc\u6296\u52a8\u5bfc\u81f4\u91cd\u590d\u6295\u9012"]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:"\u89e3\u51b3\uff1a"})," \u6d88\u8d39\u7aef\u5b9e\u73b0\u5e42\u7b49\uff08\u89c1\u4e0a\u6587\uff09"]}),"\n",(0,l.jsx)(n.h3,{id:"4-\u987a\u5e8f\u6d88\u606f\u6d88\u8d39\u5361\u4f4f",children:"4. \u987a\u5e8f\u6d88\u606f\u6d88\u8d39\u5361\u4f4f"}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:"\u539f\u56e0\uff1a"})," \u987a\u5e8f\u6d88\u8d39\u65f6\u67d0\u6761\u6d88\u606f\u6301\u7eed\u5931\u8d25"]}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.strong,{children:"\u89e3\u51b3\uff1a"})}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"consumer.registerMessageListener((MessageListenerOrderly) (msgs, ctx) -> {\n    for (MessageExt msg : msgs) {\n        if (msg.getReconsumeTimes() >= 3) {\n            // \u8bb0\u5f55\u540e\u8df3\u8fc7\uff0c\u907f\u514d\u5361\u4f4f\u961f\u5217\n            logFailedMessage(msg);\n            return ConsumeOrderlyStatus.SUCCESS;\n        }\n        // \u6b63\u5e38\u5904\u7406\n    }\n    return ConsumeOrderlyStatus.SUCCESS;\n});\n"})}),"\n",(0,l.jsx)(n.h3,{id:"5-\u4e8b\u52a1\u6d88\u606f\u56de\u67e5\u5931\u8d25",children:"5. \u4e8b\u52a1\u6d88\u606f\u56de\u67e5\u5931\u8d25"}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:"\u539f\u56e0\uff1a"})," \u56de\u67e5\u903b\u8f91\u5f02\u5e38\u6216\u672c\u5730\u4e8b\u52a1\u72b6\u6001\u4e22\u5931"]}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.strong,{children:"\u89e3\u51b3\uff1a"})}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:'// \u4f7f\u7528\u672c\u5730\u4e8b\u52a1\u8868\u8bb0\u5f55\u72b6\u6001\nCREATE TABLE transaction_log (\n    tx_id VARCHAR(64) PRIMARY KEY,\n    status VARCHAR(16),\n    create_time TIMESTAMP\n);\n\n// \u56de\u67e5\u65f6\u67e5\u8be2\u4e8b\u52a1\u8868\n@Override\npublic LocalTransactionState checkLocalTransaction(MessageExt msg) {\n    String txId = msg.getTransactionId();\n    TransactionLog log = txLogDao.findByTxId(txId);\n\n    if (log == null) {\n        return LocalTransactionState.UNKNOW;\n    }\n    return "COMMITTED".equals(log.getStatus())\n        ? LocalTransactionState.COMMIT_MESSAGE\n        : LocalTransactionState.ROLLBACK_MESSAGE;\n}\n'})}),"\n",(0,l.jsx)(n.h2,{id:"\u5b89\u5168\u914d\u7f6e",children:"\u5b89\u5168\u914d\u7f6e"}),"\n",(0,l.jsx)(n.h3,{id:"1-acl-\u8bbf\u95ee\u63a7\u5236",children:"1. ACL \u8bbf\u95ee\u63a7\u5236"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-properties",children:"# broker.conf\naclEnable=true\n\n# plain_acl.yml\naccounts:\n  - accessKey: admin\n    secretKey: admin123\n    admin: true\n  - accessKey: producer\n    secretKey: producer123\n    defaultTopicPerm: PUB\n  - accessKey: consumer\n    secretKey: consumer123\n    defaultTopicPerm: SUB\n"})}),"\n",(0,l.jsx)(n.h3,{id:"2-\u5ba2\u6237\u7aef\u914d\u7f6e",children:"2. \u5ba2\u6237\u7aef\u914d\u7f6e"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:'// \u751f\u4ea7\u8005\nDefaultMQProducer producer = new DefaultMQProducer("ProducerGroup",\n    new AclClientRPCHook(new SessionCredentials("producer", "producer123")));\n\n// \u6d88\u8d39\u8005\nDefaultMQPushConsumer consumer = new DefaultMQPushConsumer("ConsumerGroup",\n    new AclClientRPCHook(new SessionCredentials("consumer", "consumer123")));\n'})}),"\n",(0,l.jsx)(n.h2,{id:"\u65e5\u5fd7\u4e0e\u76d1\u63a7",children:"\u65e5\u5fd7\u4e0e\u76d1\u63a7"}),"\n",(0,l.jsx)(n.h3,{id:"1-\u5173\u952e\u65e5\u5fd7\u914d\u7f6e",children:"1. \u5173\u952e\u65e5\u5fd7\u914d\u7f6e"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-xml",children:'\x3c!-- logback.xml --\x3e\n<logger name="RocketmqClient" level="WARN"/>\n<logger name="RocketmqRemoting" level="WARN"/>\n<logger name="RocketmqCommon" level="WARN"/>\n'})}),"\n",(0,l.jsx)(n.h3,{id:"2-\u4e1a\u52a1\u65e5\u5fd7",children:"2. \u4e1a\u52a1\u65e5\u5fd7"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:'// \u53d1\u9001\u65f6\u8bb0\u5f55\nSendResult result = producer.send(msg);\nlog.info("\u53d1\u9001\u6d88\u606f: topic={}, msgId={}, status={}",\n    msg.getTopic(), result.getMsgId(), result.getSendStatus());\n\n// \u6d88\u8d39\u65f6\u8bb0\u5f55\nlog.info("\u6d88\u8d39\u6d88\u606f: topic={}, msgId={}, reconsumeTimes={}",\n    msg.getTopic(), msg.getMsgId(), msg.getReconsumeTimes());\n'})}),"\n",(0,l.jsx)(n.h2,{id:"\u4e0b\u4e00\u6b65",children:"\u4e0b\u4e00\u6b65"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\ud83c\udfd7\ufe0f ",(0,l.jsx)(n.a,{href:"/docs/rocketmq/cluster-management",children:"\u96c6\u7fa4\u7ba1\u7406"})," - \u6df1\u5165\u4e86\u89e3\u96c6\u7fa4\u90e8\u7f72"]}),"\n",(0,l.jsxs)(n.li,{children:["\u26a1 ",(0,l.jsx)(n.a,{href:"/docs/rocketmq/performance-optimization",children:"\u6027\u80fd\u4f18\u5316"})," - \u63d0\u5347\u7cfb\u7edf\u6027\u80fd"]}),"\n",(0,l.jsxs)(n.li,{children:["\ud83d\udcca ",(0,l.jsx)(n.a,{href:"/docs/rocketmq/monitoring",children:"\u76d1\u63a7\u8fd0\u7ef4"})," - \u5efa\u8bbe\u76d1\u63a7\u4f53\u7cfb"]}),"\n"]}),"\n",(0,l.jsx)(n.h2,{id:"\u53c2\u8003\u8d44\u6599",children:"\u53c2\u8003\u8d44\u6599"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.a,{href:"https://rocketmq.apache.org/docs/bestPractice/",children:"RocketMQ \u5b98\u65b9\u6700\u4f73\u5b9e\u8df5"})}),"\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.a,{href:"https://help.aliyun.com/document_detail/29532.html",children:"\u963f\u91cc\u4e91 RocketMQ \u5b9e\u8df5"})}),"\n"]})]})}function u(e={}){const{wrapper:n}={...(0,d.R)(),...e.components};return n?(0,l.jsx)(n,{...e,children:(0,l.jsx)(a,{...e})}):a(e)}}}]);