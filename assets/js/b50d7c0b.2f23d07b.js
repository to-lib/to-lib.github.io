"use strict";(globalThis.webpackChunkto_lib_github_io=globalThis.webpackChunkto_lib_github_io||[]).push([[18960],{48885:(e,n,r)=>{r.d(n,{R:()=>i,x:()=>o});var t=r(99378);const a={},s=t.createContext(a);function i(e){const n=t.useContext(s);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:i(e.components),t.createElement(s.Provider,{value:n},e.children)}},71189:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>l,contentTitle:()=>o,default:()=>u,frontMatter:()=>i,metadata:()=>t,toc:()=>d});const t=JSON.parse('{"id":"kafka/kafka-streams","title":"Kafka Streams","description":"Kafka Streams \u6d41\u5904\u7406\u5e93\u4f7f\u7528\u6307\u5357","source":"@site/docs/kafka/kafka-streams.md","sourceDirName":"kafka","slug":"/kafka/kafka-streams","permalink":"/docs/kafka/kafka-streams","draft":false,"unlisted":false,"editUrl":"https://github.com/to-lib/to-lib.github.io/tree/main/docs/kafka/kafka-streams.md","tags":[],"version":"current","sidebarPosition":15,"frontMatter":{"sidebar_position":15,"title":"Kafka Streams","description":"Kafka Streams \u6d41\u5904\u7406\u5e93\u4f7f\u7528\u6307\u5357"},"sidebar":"kafka","previous":{"title":"Kafka Connect","permalink":"/docs/kafka/kafka-connect"},"next":{"title":"\u5b89\u5168\u914d\u7f6e","permalink":"/docs/kafka/security"}}');var a=r(22714),s=r(48885);const i={sidebar_position:15,title:"Kafka Streams",description:"Kafka Streams \u6d41\u5904\u7406\u5e93\u4f7f\u7528\u6307\u5357"},o="Kafka Streams",l={},d=[{value:"\u6982\u8ff0",id:"\u6982\u8ff0",level:2},{value:"\u6838\u5fc3\u7279\u70b9",id:"\u6838\u5fc3\u7279\u70b9",level:3},{value:"\u5feb\u901f\u5f00\u59cb",id:"\u5feb\u901f\u5f00\u59cb",level:2},{value:"Maven \u4f9d\u8d56",id:"maven-\u4f9d\u8d56",level:3},{value:"\u57fa\u672c\u793a\u4f8b",id:"\u57fa\u672c\u793a\u4f8b",level:3},{value:"\u6838\u5fc3\u6982\u5ff5",id:"\u6838\u5fc3\u6982\u5ff5",level:2},{value:"KStream",id:"kstream",level:3},{value:"KTable",id:"ktable",level:3},{value:"GlobalKTable",id:"globalktable",level:3},{value:"\u65e0\u72b6\u6001\u64cd\u4f5c",id:"\u65e0\u72b6\u6001\u64cd\u4f5c",level:2},{value:"\u8fc7\u6ee4\u548c\u6620\u5c04",id:"\u8fc7\u6ee4\u548c\u6620\u5c04",level:3},{value:"\u6241\u5e73\u5316\u548c\u5206\u652f",id:"\u6241\u5e73\u5316\u548c\u5206\u652f",level:3},{value:"\u6709\u72b6\u6001\u64cd\u4f5c",id:"\u6709\u72b6\u6001\u64cd\u4f5c",level:2},{value:"\u805a\u5408",id:"\u805a\u5408",level:3},{value:"\u7a97\u53e3\u64cd\u4f5c",id:"\u7a97\u53e3\u64cd\u4f5c",level:3},{value:"\u8fde\u63a5\u64cd\u4f5c",id:"\u8fde\u63a5\u64cd\u4f5c",level:3},{value:"\u72b6\u6001\u5b58\u50a8",id:"\u72b6\u6001\u5b58\u50a8",level:2},{value:"\u5185\u7f6e\u72b6\u6001\u5b58\u50a8",id:"\u5185\u7f6e\u72b6\u6001\u5b58\u50a8",level:3},{value:"\u4ea4\u4e92\u5f0f\u67e5\u8be2",id:"\u4ea4\u4e92\u5f0f\u67e5\u8be2",level:3},{value:"Processor API",id:"processor-api",level:2},{value:"\u81ea\u5b9a\u4e49\u5904\u7406\u5668",id:"\u81ea\u5b9a\u4e49\u5904\u7406\u5668",level:3},{value:"\u4f7f\u7528 Processor",id:"\u4f7f\u7528-processor",level:3},{value:"\u7cbe\u786e\u4e00\u6b21\u8bed\u4e49",id:"\u7cbe\u786e\u4e00\u6b21\u8bed\u4e49",level:2},{value:"\u914d\u7f6e",id:"\u914d\u7f6e",level:3},{value:"\u5de5\u4f5c\u539f\u7406",id:"\u5de5\u4f5c\u539f\u7406",level:3},{value:"\u9519\u8bef\u5904\u7406",id:"\u9519\u8bef\u5904\u7406",level:2},{value:"\u53cd\u5e8f\u5217\u5316\u9519\u8bef",id:"\u53cd\u5e8f\u5217\u5316\u9519\u8bef",level:3},{value:"\u751f\u4ea7\u9519\u8bef",id:"\u751f\u4ea7\u9519\u8bef",level:3},{value:"\u6d4b\u8bd5",id:"\u6d4b\u8bd5",level:2},{value:"TopologyTestDriver",id:"topologytestdriver",level:3},{value:"\u76d1\u63a7",id:"\u76d1\u63a7",level:2},{value:"\u5173\u952e\u6307\u6807",id:"\u5173\u952e\u6307\u6807",level:3},{value:"JMX \u76d1\u63a7",id:"jmx-\u76d1\u63a7",level:3},{value:"\u6700\u4f73\u5b9e\u8df5",id:"\u6700\u4f73\u5b9e\u8df5",level:2},{value:"\u914d\u7f6e\u4f18\u5316",id:"\u914d\u7f6e\u4f18\u5316",level:3},{value:"\u5bb9\u9519\u4e0e\u6062\u590d",id:"\u5bb9\u9519\u4e0e\u6062\u590d",level:3},{value:"\u53c2\u8003\u8d44\u6599",id:"\u53c2\u8003\u8d44\u6599",level:2}];function c(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",mermaid:"mermaid",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,s.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.header,{children:(0,a.jsx)(n.h1,{id:"kafka-streams",children:"Kafka Streams"})}),"\n",(0,a.jsx)(n.h2,{id:"\u6982\u8ff0",children:"\u6982\u8ff0"}),"\n",(0,a.jsx)(n.p,{children:"Kafka Streams \u662f\u6784\u5efa\u5728 Kafka \u4e4b\u4e0a\u7684\u6d41\u5904\u7406\u5e93\uff0c\u7528\u4e8e\u6784\u5efa\u5b9e\u65f6\u6570\u636e\u5904\u7406\u5e94\u7528\u3002"}),"\n",(0,a.jsx)(n.mermaid,{value:"graph LR\n    IT[\u8f93\u5165 Topic] --\x3e KS[Kafka Streams \u5e94\u7528]\n    KS --\x3e OT[\u8f93\u51fa Topic]\n    KS --\x3e SS[(\u72b6\u6001\u5b58\u50a8)]\n\n    style KS fill:#2e7d32,color:#fff"}),"\n",(0,a.jsx)(n.h3,{id:"\u6838\u5fc3\u7279\u70b9",children:"\u6838\u5fc3\u7279\u70b9"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"\u8f7b\u91cf\u7ea7"}),"\uff1a\u53ea\u662f\u4e00\u4e2a Java \u5e93\uff0c\u65e0\u9700\u96c6\u7fa4"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"\u5bb9\u9519"}),"\uff1a\u81ea\u52a8\u5904\u7406\u6545\u969c\u6062\u590d"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"\u53ef\u6269\u5c55"}),"\uff1a\u901a\u8fc7\u589e\u52a0\u5b9e\u4f8b\u6c34\u5e73\u6269\u5c55"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"\u7cbe\u786e\u4e00\u6b21"}),"\uff1a\u652f\u6301 Exactly-Once \u8bed\u4e49"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"\u6709\u72b6\u6001\u5904\u7406"}),"\uff1a\u5185\u7f6e\u72b6\u6001\u5b58\u50a8"]}),"\n"]}),"\n",(0,a.jsx)(n.h2,{id:"\u5feb\u901f\u5f00\u59cb",children:"\u5feb\u901f\u5f00\u59cb"}),"\n",(0,a.jsx)(n.h3,{id:"maven-\u4f9d\u8d56",children:"Maven \u4f9d\u8d56"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-xml",children:"<dependency>\n    <groupId>org.apache.kafka</groupId>\n    <artifactId>kafka-streams</artifactId>\n    <version>3.6.0</version>\n</dependency>\n"})}),"\n",(0,a.jsx)(n.h3,{id:"\u57fa\u672c\u793a\u4f8b",children:"\u57fa\u672c\u793a\u4f8b"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-java",children:'Properties props = new Properties();\nprops.put(StreamsConfig.APPLICATION_ID_CONFIG, "my-streams-app");\nprops.put(StreamsConfig.BOOTSTRAP_SERVERS_CONFIG, "localhost:9092");\nprops.put(StreamsConfig.DEFAULT_KEY_SERDE_CLASS_CONFIG, Serdes.String().getClass());\nprops.put(StreamsConfig.DEFAULT_VALUE_SERDE_CLASS_CONFIG, Serdes.String().getClass());\n\n// \u6784\u5efa\u5904\u7406\u62d3\u6251\nStreamsBuilder builder = new StreamsBuilder();\nKStream<String, String> source = builder.stream("input-topic");\n\nsource\n    .filter((key, value) -> value.length() > 5)\n    .mapValues(value -> value.toUpperCase())\n    .to("output-topic");\n\n// \u542f\u52a8\u5e94\u7528\nKafkaStreams streams = new KafkaStreams(builder.build(), props);\nstreams.start();\n\n// \u4f18\u96c5\u5173\u95ed\nRuntime.getRuntime().addShutdownHook(new Thread(streams::close));\n'})}),"\n",(0,a.jsx)(n.h2,{id:"\u6838\u5fc3\u6982\u5ff5",children:"\u6838\u5fc3\u6982\u5ff5"}),"\n",(0,a.jsx)(n.h3,{id:"kstream",children:"KStream"}),"\n",(0,a.jsx)(n.p,{children:"\u4e0d\u53ef\u53d8\u7684\u8bb0\u5f55\u6d41\uff0c\u4ee3\u8868\u65e0\u9650\u7684\u6570\u636e\u6d41\uff1a"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-java",children:'// \u521b\u5efa KStream\nKStream<String, String> stream = builder.stream("orders");\n\n// \u65e0\u72b6\u6001\u8f6c\u6362\nstream\n    .filter((key, value) -> value != null)           // \u8fc7\u6ee4\n    .map((key, value) -> KeyValue.pair(               // \u6620\u5c04\n        key.toUpperCase(),\n        value.toLowerCase()\n    ))\n    .flatMapValues(value -> Arrays.asList(            // \u6241\u5e73\u5316\n        value.split(",")\n    ))\n    .peek((key, value) -> log.info("Key: {}", key))   // \u8c03\u8bd5\n    .to("processed-orders");                          // \u8f93\u51fa\n'})}),"\n",(0,a.jsx)(n.h3,{id:"ktable",children:"KTable"}),"\n",(0,a.jsx)(n.p,{children:"\u53d8\u66f4\u65e5\u5fd7\u6d41\uff0c\u4ee3\u8868\u53ef\u66f4\u65b0\u7684\u952e\u503c\u8868\uff1a"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-java",children:'// \u521b\u5efa KTable\nKTable<String, Long> table = builder.table("user-balances");\n\n// \u6216\u4ece KStream \u8f6c\u6362\nKTable<String, Long> counts = stream\n    .groupByKey()\n    .count();\n\n// KTable \u64cd\u4f5c\ntable\n    .filter((key, value) -> value > 100)\n    .mapValues(value -> value * 2)\n    .toStream()\n    .to("high-balances");\n'})}),"\n",(0,a.jsx)(n.h3,{id:"globalktable",children:"GlobalKTable"}),"\n",(0,a.jsx)(n.p,{children:"\u5168\u5c40\u72b6\u6001\u8868\uff0c\u6bcf\u4e2a\u5b9e\u4f8b\u90fd\u6709\u5b8c\u6574\u526f\u672c\uff1a"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-java",children:'// \u521b\u5efa GlobalKTable\uff08\u7528\u4e8e\u5e7f\u64ad\u6570\u636e\uff09\nGlobalKTable<String, String> countries = builder.globalTable("countries");\n\n// \u4e0e KStream \u8fde\u63a5\nstream.join(countries,\n    (streamKey, streamValue) -> streamKey,  // \u9009\u62e9\u8fde\u63a5\u952e\n    (streamValue, tableValue) -> streamValue + " - " + tableValue\n);\n'})}),"\n",(0,a.jsx)(n.h2,{id:"\u65e0\u72b6\u6001\u64cd\u4f5c",children:"\u65e0\u72b6\u6001\u64cd\u4f5c"}),"\n",(0,a.jsx)(n.h3,{id:"\u8fc7\u6ee4\u548c\u6620\u5c04",children:"\u8fc7\u6ee4\u548c\u6620\u5c04"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-java",children:'KStream<String, Order> orders = builder.stream("orders");\n\n// \u8fc7\u6ee4\nKStream<String, Order> validOrders = orders\n    .filter((key, order) -> order.getAmount() > 0);\n\n// \u6620\u5c04\u952e\u503c\nKStream<String, OrderSummary> summaries = orders\n    .map((key, order) -> KeyValue.pair(\n        order.getUserId(),\n        new OrderSummary(order.getId(), order.getAmount())\n    ));\n\n// \u4ec5\u6620\u5c04\u503c\nKStream<String, Double> amounts = orders\n    .mapValues(Order::getAmount);\n'})}),"\n",(0,a.jsx)(n.h3,{id:"\u6241\u5e73\u5316\u548c\u5206\u652f",children:"\u6241\u5e73\u5316\u548c\u5206\u652f"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-java",children:'// \u6241\u5e73\u5316\nKStream<String, String> words = lines\n    .flatMapValues(line -> Arrays.asList(line.split("\\\\s+")));\n\n// \u5206\u652f\uff08Kafka 2.8+\uff09\nMap<String, KStream<String, Order>> branches = orders\n    .split(Named.as("branch-"))\n    .branch((key, order) -> order.getAmount() > 1000, Branched.as("large"))\n    .branch((key, order) -> order.getAmount() > 100, Branched.as("medium"))\n    .defaultBranch(Branched.as("small"));\n\nKStream<String, Order> largeOrders = branches.get("branch-large");\n'})}),"\n",(0,a.jsx)(n.h2,{id:"\u6709\u72b6\u6001\u64cd\u4f5c",children:"\u6709\u72b6\u6001\u64cd\u4f5c"}),"\n",(0,a.jsx)(n.h3,{id:"\u805a\u5408",children:"\u805a\u5408"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-java",children:"// \u6309\u952e\u5206\u7ec4\nKGroupedStream<String, Order> grouped = orders.groupByKey();\n\n// \u8ba1\u6570\nKTable<String, Long> orderCounts = grouped.count();\n\n// \u6c42\u548c\nKTable<String, Double> totalAmounts = grouped.aggregate(\n    () -> 0.0,                                    // \u521d\u59cb\u503c\n    (key, order, total) -> total + order.getAmount(),  // \u805a\u5408\u903b\u8f91\n    Materialized.with(Serdes.String(), Serdes.Double())\n);\n\n// reduce\nKTable<String, Order> maxOrders = grouped.reduce(\n    (order1, order2) ->\n        order1.getAmount() > order2.getAmount() ? order1 : order2\n);\n"})}),"\n",(0,a.jsx)(n.h3,{id:"\u7a97\u53e3\u64cd\u4f5c",children:"\u7a97\u53e3\u64cd\u4f5c"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-java",children:'// \u6eda\u52a8\u7a97\u53e3\uff08Tumbling Window\uff09\nKTable<Windowed<String>, Long> tumblingCounts = orders\n    .groupByKey()\n    .windowedBy(TimeWindows.ofSizeWithNoGrace(Duration.ofMinutes(5)))\n    .count();\n\n// \u6ed1\u52a8\u7a97\u53e3\uff08Hopping Window\uff09\nKTable<Windowed<String>, Long> hoppingCounts = orders\n    .groupByKey()\n    .windowedBy(TimeWindows.ofSizeAndGrace(\n        Duration.ofMinutes(5),   // \u7a97\u53e3\u5927\u5c0f\n        Duration.ofMinutes(1)    // \u5bb9\u5fcd\u5ef6\u8fdf\n    ).advanceBy(Duration.ofMinutes(1)))  // \u6ed1\u52a8\u95f4\u9694\n    .count();\n\n// \u4f1a\u8bdd\u7a97\u53e3\uff08Session Window\uff09\nKTable<Windowed<String>, Long> sessionCounts = orders\n    .groupByKey()\n    .windowedBy(SessionWindows.ofInactivityGapWithNoGrace(Duration.ofMinutes(30)))\n    .count();\n\n// \u5904\u7406\u7a97\u53e3\u7ed3\u679c\ntumblingCounts\n    .toStream()\n    .map((windowedKey, count) -> {\n        String key = windowedKey.key();\n        long windowStart = windowedKey.window().start();\n        return KeyValue.pair(key, String.format("%s: %d (window: %d)", key, count, windowStart));\n    })\n    .to("windowed-counts");\n'})}),"\n",(0,a.jsx)(n.h3,{id:"\u8fde\u63a5\u64cd\u4f5c",children:"\u8fde\u63a5\u64cd\u4f5c"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-java",children:'// KStream-KStream \u8fde\u63a5\uff08\u9700\u8981\u7a97\u53e3\uff09\nKStream<String, Order> orders = builder.stream("orders");\nKStream<String, Payment> payments = builder.stream("payments");\n\nKStream<String, OrderPayment> joined = orders.join(\n    payments,\n    (order, payment) -> new OrderPayment(order, payment),\n    JoinWindows.ofTimeDifferenceWithNoGrace(Duration.ofMinutes(5)),\n    StreamJoined.with(Serdes.String(), orderSerde, paymentSerde)\n);\n\n// KStream-KTable \u8fde\u63a5\nKTable<String, User> users = builder.table("users");\n\nKStream<String, EnrichedOrder> enriched = orders.join(\n    users,\n    (order, user) -> new EnrichedOrder(order, user)\n);\n\n// \u5de6\u8fde\u63a5\nKStream<String, EnrichedOrder> leftJoined = orders.leftJoin(\n    users,\n    (order, user) -> new EnrichedOrder(order, user != null ? user : User.UNKNOWN)\n);\n'})}),"\n",(0,a.jsx)(n.h2,{id:"\u72b6\u6001\u5b58\u50a8",children:"\u72b6\u6001\u5b58\u50a8"}),"\n",(0,a.jsx)(n.h3,{id:"\u5185\u7f6e\u72b6\u6001\u5b58\u50a8",children:"\u5185\u7f6e\u72b6\u6001\u5b58\u50a8"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-java",children:'// \u4f7f\u7528\u547d\u540d\u72b6\u6001\u5b58\u50a8\nKTable<String, Long> counts = orders\n    .groupByKey()\n    .count(Materialized.<String, Long, KeyValueStore<Bytes, byte[]>>as("order-counts-store")\n        .withKeySerde(Serdes.String())\n        .withValueSerde(Serdes.Long()));\n\n// \u67e5\u8be2\u72b6\u6001\u5b58\u50a8\nReadOnlyKeyValueStore<String, Long> store =\n    streams.store(StoreQueryParameters.fromNameAndType(\n        "order-counts-store",\n        QueryableStoreTypes.keyValueStore()\n    ));\n\nLong count = store.get("user-123");\n'})}),"\n",(0,a.jsx)(n.h3,{id:"\u4ea4\u4e92\u5f0f\u67e5\u8be2",children:"\u4ea4\u4e92\u5f0f\u67e5\u8be2"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-java",children:'// \u542f\u7528\u4ea4\u4e92\u5f0f\u67e5\u8be2\nprops.put(StreamsConfig.APPLICATION_SERVER_CONFIG, "localhost:8080");\n\n// \u83b7\u53d6\u6240\u6709\u5b9e\u4f8b\u7684\u5143\u6570\u636e\nCollection<StreamsMetadata> metadata = streams.metadataForAllStreamsClients();\n\n// \u67e5\u8be2\u672c\u5730\u6216\u8fdc\u7a0b\u72b6\u6001\nfor (StreamsMetadata meta : metadata) {\n    if (meta.stateStoreNames().contains("my-store")) {\n        String host = meta.hostInfo().host();\n        int port = meta.hostInfo().port();\n        // \u53d1\u9001\u8bf7\u6c42\u5230\u5bf9\u5e94\u5b9e\u4f8b\n    }\n}\n'})}),"\n",(0,a.jsx)(n.h2,{id:"processor-api",children:"Processor API"}),"\n",(0,a.jsx)(n.h3,{id:"\u81ea\u5b9a\u4e49\u5904\u7406\u5668",children:"\u81ea\u5b9a\u4e49\u5904\u7406\u5668"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-java",children:'public class MyProcessor implements Processor<String, String, String, String> {\n    private ProcessorContext<String, String> context;\n    private KeyValueStore<String, Long> store;\n\n    @Override\n    public void init(ProcessorContext<String, String> context) {\n        this.context = context;\n        this.store = context.getStateStore("my-store");\n\n        // \u5b9a\u65f6\u4efb\u52a1\n        this.context.schedule(\n            Duration.ofSeconds(60),\n            PunctuationType.WALL_CLOCK_TIME,\n            this::punctuate\n        );\n    }\n\n    @Override\n    public void process(Record<String, String> record) {\n        Long count = store.get(record.key());\n        store.put(record.key(), count == null ? 1L : count + 1);\n\n        // \u8f6c\u53d1\u5230\u4e0b\u6e38\n        context.forward(new Record<>(\n            record.key(),\n            String.valueOf(count),\n            record.timestamp()\n        ));\n    }\n\n    private void punctuate(long timestamp) {\n        // \u5b9a\u671f\u5904\u7406\u903b\u8f91\n        try (KeyValueIterator<String, Long> iter = store.all()) {\n            while (iter.hasNext()) {\n                KeyValue<String, Long> kv = iter.next();\n                context.forward(new Record<>(kv.key, String.valueOf(kv.value), timestamp));\n            }\n        }\n    }\n\n    @Override\n    public void close() {\n        // \u6e05\u7406\u8d44\u6e90\n    }\n}\n'})}),"\n",(0,a.jsx)(n.h3,{id:"\u4f7f\u7528-processor",children:"\u4f7f\u7528 Processor"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-java",children:'Topology topology = new Topology();\n\ntopology.addSource("source", "input-topic")\n    .addProcessor("processor", MyProcessor::new, "source")\n    .addStateStore(\n        Stores.keyValueStoreBuilder(\n            Stores.persistentKeyValueStore("my-store"),\n            Serdes.String(),\n            Serdes.Long()\n        ),\n        "processor"\n    )\n    .addSink("sink", "output-topic", "processor");\n\nKafkaStreams streams = new KafkaStreams(topology, props);\n'})}),"\n",(0,a.jsx)(n.h2,{id:"\u7cbe\u786e\u4e00\u6b21\u8bed\u4e49",children:"\u7cbe\u786e\u4e00\u6b21\u8bed\u4e49"}),"\n",(0,a.jsx)(n.h3,{id:"\u914d\u7f6e",children:"\u914d\u7f6e"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-java",children:"// Kafka Streams 2.6+\nprops.put(StreamsConfig.PROCESSING_GUARANTEE_CONFIG, StreamsConfig.EXACTLY_ONCE_V2);\n\n// \u6216\u65e7\u7248\u672c\nprops.put(StreamsConfig.PROCESSING_GUARANTEE_CONFIG, StreamsConfig.EXACTLY_ONCE);\n"})}),"\n",(0,a.jsx)(n.h3,{id:"\u5de5\u4f5c\u539f\u7406",children:"\u5de5\u4f5c\u539f\u7406"}),"\n",(0,a.jsxs)(n.ol,{children:["\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"\u4e8b\u52a1\u751f\u4ea7\u8005"}),"\uff1a\u8f93\u51fa\u6d88\u606f\u4f7f\u7528\u4e8b\u52a1"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"\u6d88\u8d39\u8005\u9694\u79bb"}),"\uff1a\u53ea\u8bfb\u53d6\u5df2\u63d0\u4ea4\u7684\u6d88\u606f"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"\u72b6\u6001\u68c0\u67e5\u70b9"}),"\uff1a\u72b6\u6001\u53d8\u66f4\u4e0e\u8f93\u51fa\u539f\u5b50\u63d0\u4ea4"]}),"\n"]}),"\n",(0,a.jsx)(n.h2,{id:"\u9519\u8bef\u5904\u7406",children:"\u9519\u8bef\u5904\u7406"}),"\n",(0,a.jsx)(n.h3,{id:"\u53cd\u5e8f\u5217\u5316\u9519\u8bef",children:"\u53cd\u5e8f\u5217\u5316\u9519\u8bef"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-java",children:'// \u914d\u7f6e\u9519\u8bef\u5904\u7406\nprops.put(StreamsConfig.DEFAULT_DESERIALIZATION_EXCEPTION_HANDLER_CLASS_CONFIG,\n    LogAndContinueExceptionHandler.class);\n\n// \u81ea\u5b9a\u4e49\u5904\u7406\u5668\npublic class MyDeserializationHandler implements DeserializationExceptionHandler {\n    @Override\n    public DeserializationHandlerResponse handle(ProcessorContext context,\n                                                   ConsumerRecord<byte[], byte[]> record,\n                                                   Exception exception) {\n        log.error("Deserialization error for record: {}", record, exception);\n        // \u53d1\u9001\u5230\u6b7b\u4fe1\u961f\u5217\n        sendToDLQ(record);\n        return DeserializationHandlerResponse.CONTINUE;\n    }\n}\n'})}),"\n",(0,a.jsx)(n.h3,{id:"\u751f\u4ea7\u9519\u8bef",children:"\u751f\u4ea7\u9519\u8bef"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-java",children:'props.put(StreamsConfig.DEFAULT_PRODUCTION_EXCEPTION_HANDLER_CLASS_CONFIG,\n    DefaultProductionExceptionHandler.class);\n\npublic class MyProductionHandler implements ProductionExceptionHandler {\n    @Override\n    public ProductionExceptionHandlerResponse handle(ProducerRecord<byte[], byte[]> record,\n                                                      Exception exception) {\n        log.error("Production error", exception);\n        return ProductionExceptionHandlerResponse.CONTINUE;\n    }\n}\n'})}),"\n",(0,a.jsx)(n.h2,{id:"\u6d4b\u8bd5",children:"\u6d4b\u8bd5"}),"\n",(0,a.jsx)(n.h3,{id:"topologytestdriver",children:"TopologyTestDriver"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-java",children:'@Test\nvoid testTopology() {\n    // \u521b\u5efa\u6d4b\u8bd5\u9a71\u52a8\n    TopologyTestDriver testDriver = new TopologyTestDriver(topology, props);\n\n    // \u521b\u5efa\u6d4b\u8bd5\u8f93\u5165 Topic\n    TestInputTopic<String, String> inputTopic = testDriver.createInputTopic(\n        "input-topic",\n        new StringSerializer(),\n        new StringSerializer()\n    );\n\n    // \u521b\u5efa\u6d4b\u8bd5\u8f93\u51fa Topic\n    TestOutputTopic<String, String> outputTopic = testDriver.createOutputTopic(\n        "output-topic",\n        new StringDeserializer(),\n        new StringDeserializer()\n    );\n\n    // \u53d1\u9001\u6d4b\u8bd5\u6570\u636e\n    inputTopic.pipeInput("key1", "value1");\n\n    // \u9a8c\u8bc1\u8f93\u51fa\n    assertThat(outputTopic.readValue()).isEqualTo("VALUE1");\n\n    testDriver.close();\n}\n'})}),"\n",(0,a.jsx)(n.h2,{id:"\u76d1\u63a7",children:"\u76d1\u63a7"}),"\n",(0,a.jsx)(n.h3,{id:"\u5173\u952e\u6307\u6807",children:"\u5173\u952e\u6307\u6807"}),"\n",(0,a.jsxs)(n.table,{children:[(0,a.jsx)(n.thead,{children:(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.th,{children:"\u6307\u6807"}),(0,a.jsx)(n.th,{children:"\u8bf4\u660e"})]})}),(0,a.jsxs)(n.tbody,{children:[(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:(0,a.jsx)(n.code,{children:"process-rate"})}),(0,a.jsx)(n.td,{children:"\u5904\u7406\u901f\u7387"})]}),(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:(0,a.jsx)(n.code,{children:"process-latency-avg"})}),(0,a.jsx)(n.td,{children:"\u5e73\u5747\u5904\u7406\u5ef6\u8fdf"})]}),(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:(0,a.jsx)(n.code,{children:"commit-rate"})}),(0,a.jsx)(n.td,{children:"\u63d0\u4ea4\u901f\u7387"})]}),(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:(0,a.jsx)(n.code,{children:"poll-rate"})}),(0,a.jsx)(n.td,{children:"\u62c9\u53d6\u901f\u7387"})]})]})]}),"\n",(0,a.jsx)(n.h3,{id:"jmx-\u76d1\u63a7",children:"JMX \u76d1\u63a7"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-java",children:'// \u83b7\u53d6\u6307\u6807\nMetrics metrics = streams.metrics();\nfor (Metric metric : metrics.values()) {\n    log.info("{}: {}", metric.metricName(), metric.metricValue());\n}\n'})}),"\n",(0,a.jsx)(n.h2,{id:"\u6700\u4f73\u5b9e\u8df5",children:"\u6700\u4f73\u5b9e\u8df5"}),"\n",(0,a.jsx)(n.h3,{id:"\u914d\u7f6e\u4f18\u5316",children:"\u914d\u7f6e\u4f18\u5316"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-java",children:'// \u5e76\u884c\u5ea6\nprops.put(StreamsConfig.NUM_STREAM_THREADS_CONFIG, 4);\n\n// \u7f13\u5b58\u5927\u5c0f\nprops.put(StreamsConfig.CACHE_MAX_BYTES_BUFFERING_CONFIG, 10 * 1024 * 1024);\n\n// \u63d0\u4ea4\u95f4\u9694\nprops.put(StreamsConfig.COMMIT_INTERVAL_MS_CONFIG, 100);\n\n// \u72b6\u6001\u76ee\u5f55\nprops.put(StreamsConfig.STATE_DIR_CONFIG, "/var/kafka-streams");\n'})}),"\n",(0,a.jsx)(n.h3,{id:"\u5bb9\u9519\u4e0e\u6062\u590d",children:"\u5bb9\u9519\u4e0e\u6062\u590d"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-java",children:'// \u8bbe\u7f6e\u72b6\u6001\u76d1\u542c\u5668\nstreams.setStateListener((newState, oldState) -> {\n    if (newState == KafkaStreams.State.ERROR) {\n        log.error("Stream entered error state");\n        // \u89e6\u53d1\u544a\u8b66\n    }\n});\n\n// \u8bbe\u7f6e\u672a\u6355\u83b7\u5f02\u5e38\u5904\u7406\u5668\nstreams.setUncaughtExceptionHandler((thread, exception) -> {\n    log.error("Uncaught exception in thread {}", thread, exception);\n    return StreamsUncaughtExceptionHandler.StreamThreadExceptionResponse.REPLACE_THREAD;\n});\n'})}),"\n",(0,a.jsx)(n.h2,{id:"\u53c2\u8003\u8d44\u6599",children:"\u53c2\u8003\u8d44\u6599"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.a,{href:"https://kafka.apache.org/documentation/streams/",children:"Kafka Streams \u5b98\u65b9\u6587\u6863"})}),"\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.a,{href:"https://kafka.apache.org/documentation/streams/developer-guide/dsl-api.html",children:"Kafka Streams DSL"})}),"\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.a,{href:"https://github.com/apache/kafka/tree/trunk/streams/examples",children:"Kafka Streams \u793a\u4f8b"})}),"\n"]})]})}function u(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(c,{...e})}):c(e)}}}]);