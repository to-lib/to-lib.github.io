"use strict";(globalThis.webpackChunkto_lib_github_io=globalThis.webpackChunkto_lib_github_io||[]).push([[37427],{48885:(n,e,s)=>{s.d(e,{R:()=>i,x:()=>o});var t=s(99378);const r={},E=t.createContext(r);function i(n){const e=t.useContext(E);return t.useMemo(function(){return"function"==typeof n?n(e):{...e,...n}},[e,n])}function o(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(r):n.components||r:i(n.components),t.createElement(E.Provider,{value:e},n.children)}},93119:(n,e,s)=>{s.r(e),s.d(e,{assets:()=>a,contentTitle:()=>o,default:()=>T,frontMatter:()=>i,metadata:()=>t,toc:()=>d});const t=JSON.parse('{"id":"postgres/practical-examples","title":"\u5b9e\u6218\u6848\u4f8b","description":"[!TIP] > \u5b9e\u6218\u6f14\u7ec3\uff1a\u672c\u6587\u6863\u901a\u8fc7\u5b9e\u9645\u9879\u76ee\u6848\u4f8b\uff0c\u5c55\u793a PostgreSQL \u5728\u4e0d\u540c\u4e1a\u52a1\u573a\u666f\u4e0b\u7684\u5e94\u7528\u548c\u6700\u4f73\u5b9e\u8df5\uff0c\u5145\u5206\u5229\u7528 PostgreSQL \u7684\u9ad8\u7ea7\u7279\u6027\u3002","source":"@site/docs/postgres/practical-examples.md","sourceDirName":"postgres","slug":"/postgres/practical-examples","permalink":"/docs/postgres/practical-examples","draft":false,"unlisted":false,"editUrl":"https://github.com/to-lib/to-lib.github.io/tree/main/docs/postgres/practical-examples.md","tags":[],"version":"current","sidebarPosition":11,"frontMatter":{"sidebar_position":11,"title":"\u5b9e\u6218\u6848\u4f8b"}}');var r=s(22714),E=s(48885);const i={sidebar_position:11,title:"\u5b9e\u6218\u6848\u4f8b"},o="PostgreSQL \u5b9e\u6218\u6848\u4f8b",a={},d=[{value:"\u7528\u6237\u7cfb\u7edf\u8bbe\u8ba1",id:"\u7528\u6237\u7cfb\u7edf\u8bbe\u8ba1",level:2},{value:"\u9700\u6c42\u5206\u6790",id:"\u9700\u6c42\u5206\u6790",level:3},{value:"\u6570\u636e\u5e93\u8bbe\u8ba1",id:"\u6570\u636e\u5e93\u8bbe\u8ba1",level:3},{value:"\u5e38\u7528\u67e5\u8be2",id:"\u5e38\u7528\u67e5\u8be2",level:3},{value:"\u7535\u5546\u8ba2\u5355\u7cfb\u7edf",id:"\u7535\u5546\u8ba2\u5355\u7cfb\u7edf",level:2},{value:"\u9700\u6c42\u5206\u6790",id:"\u9700\u6c42\u5206\u6790-1",level:3},{value:"\u6570\u636e\u5e93\u8bbe\u8ba1",id:"\u6570\u636e\u5e93\u8bbe\u8ba1-1",level:3},{value:"\u521b\u5efa\u8ba2\u5355\uff08\u4f7f\u7528\u4e8b\u52a1\u548c\u5b58\u50a8\u8fc7\u7a0b\uff09",id:"\u521b\u5efa\u8ba2\u5355\u4f7f\u7528\u4e8b\u52a1\u548c\u5b58\u50a8\u8fc7\u7a0b",level:3},{value:"\u8ba2\u5355\u7edf\u8ba1\u67e5\u8be2",id:"\u8ba2\u5355\u7edf\u8ba1\u67e5\u8be2",level:3},{value:"\u535a\u5ba2\u7cfb\u7edf\u8bbe\u8ba1",id:"\u535a\u5ba2\u7cfb\u7edf\u8bbe\u8ba1",level:2},{value:"\u6570\u636e\u5e93\u8bbe\u8ba1\uff08\u4f7f\u7528\u5168\u6587\u641c\u7d22\uff09",id:"\u6570\u636e\u5e93\u8bbe\u8ba1\u4f7f\u7528\u5168\u6587\u641c\u7d22",level:3},{value:"\u5168\u6587\u641c\u7d22\u67e5\u8be2",id:"\u5168\u6587\u641c\u7d22\u67e5\u8be2",level:3},{value:"\u8bc4\u8bba\u6811\u67e5\u8be2",id:"\u8bc4\u8bba\u6811\u67e5\u8be2",level:3},{value:"\u5730\u7406\u4f4d\u7f6e\u5e94\u7528\uff08PostGIS\uff09",id:"\u5730\u7406\u4f4d\u7f6e\u5e94\u7528postgis",level:2},{value:"\u542f\u7528 PostGIS \u6269\u5c55",id:"\u542f\u7528-postgis-\u6269\u5c55",level:3},{value:"\u5730\u7406\u4f4d\u7f6e\u67e5\u8be2",id:"\u5730\u7406\u4f4d\u7f6e\u67e5\u8be2",level:3},{value:"\u65f6\u5e8f\u6570\u636e\u5206\u6790",id:"\u65f6\u5e8f\u6570\u636e\u5206\u6790",level:2},{value:"\u7269\u8054\u7f51\u4f20\u611f\u5668\u6570\u636e",id:"\u7269\u8054\u7f51\u4f20\u611f\u5668\u6570\u636e",level:3},{value:"\u5206\u533a\u8868\u5b9e\u6218",id:"\u5206\u533a\u8868\u5b9e\u6218",level:2},{value:"\u6309\u65f6\u95f4\u8303\u56f4\u5206\u533a",id:"\u6309\u65f6\u95f4\u8303\u56f4\u5206\u533a",level:3},{value:"\u603b\u7ed3",id:"\u603b\u7ed3",level:2}];function N(n){const e={a:"a",blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,E.R)(),...n.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(e.header,{children:(0,r.jsx)(e.h1,{id:"postgresql-\u5b9e\u6218\u6848\u4f8b",children:"PostgreSQL \u5b9e\u6218\u6848\u4f8b"})}),"\n",(0,r.jsxs)(e.blockquote,{children:["\n",(0,r.jsxs)(e.p,{children:["[!TIP] > ",(0,r.jsx)(e.strong,{children:"\u5b9e\u6218\u6f14\u7ec3"}),"\uff1a\u672c\u6587\u6863\u901a\u8fc7\u5b9e\u9645\u9879\u76ee\u6848\u4f8b\uff0c\u5c55\u793a PostgreSQL \u5728\u4e0d\u540c\u4e1a\u52a1\u573a\u666f\u4e0b\u7684\u5e94\u7528\u548c\u6700\u4f73\u5b9e\u8df5\uff0c\u5145\u5206\u5229\u7528 PostgreSQL \u7684\u9ad8\u7ea7\u7279\u6027\u3002"]}),"\n"]}),"\n",(0,r.jsx)(e.h2,{id:"\u7528\u6237\u7cfb\u7edf\u8bbe\u8ba1",children:"\u7528\u6237\u7cfb\u7edf\u8bbe\u8ba1"}),"\n",(0,r.jsx)(e.h3,{id:"\u9700\u6c42\u5206\u6790",children:"\u9700\u6c42\u5206\u6790"}),"\n",(0,r.jsx)(e.p,{children:"\u8bbe\u8ba1\u4e00\u4e2a\u652f\u6301\u7528\u6237\u6ce8\u518c\u3001\u767b\u5f55\u3001\u6743\u9650\u7ba1\u7406\u7684\u7528\u6237\u7cfb\u7edf\uff0c\u4f7f\u7528 PostgreSQL \u7684 JSONB \u548c\u6570\u7ec4\u7279\u6027\u3002"}),"\n",(0,r.jsx)(e.h3,{id:"\u6570\u636e\u5e93\u8bbe\u8ba1",children:"\u6570\u636e\u5e93\u8bbe\u8ba1"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-sql",children:"-- \u7528\u6237\u8868\nCREATE TABLE users (\n    id BIGSERIAL PRIMARY KEY,\n    username VARCHAR(50) NOT NULL UNIQUE,\n    email VARCHAR(100) NOT NULL UNIQUE,\n    password_hash VARCHAR(255) NOT NULL,\n    phone VARCHAR(20),\n    avatar_url VARCHAR(255),\n    -- \u4f7f\u7528 JSONB \u5b58\u50a8\u989d\u5916\u5c5e\u6027\n    metadata JSONB DEFAULT '{}',\n    -- \u4f7f\u7528\u6570\u7ec4\u5b58\u50a8\u89d2\u8272\n    roles TEXT[] DEFAULT '{}',\n    status SMALLINT NOT NULL DEFAULT 1,  -- 1-\u6b63\u5e38 2-\u7981\u7528\n    last_login_at TIMESTAMPTZ,\n    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),\n    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()\n);\n\n-- \u521b\u5efa\u7d22\u5f15\nCREATE INDEX idx_users_email ON users(email);\nCREATE INDEX idx_users_status ON users(status);\nCREATE INDEX idx_users_metadata ON users USING GIN(metadata);\nCREATE INDEX idx_users_roles ON users USING GIN(roles);\n\n-- \u6dfb\u52a0\u6ce8\u91ca\nCOMMENT ON TABLE users IS '\u7528\u6237\u8868';\nCOMMENT ON COLUMN users.metadata IS 'JSON\u683c\u5f0f\u7684\u7528\u6237\u989d\u5916\u4fe1\u606f';\nCOMMENT ON COLUMN users.roles IS '\u7528\u6237\u89d2\u8272\u6570\u7ec4';\n\n-- \u89d2\u8272\u6743\u9650\u8868\nCREATE TABLE role_permissions (\n    id SERIAL PRIMARY KEY,\n    role_name VARCHAR(50) NOT NULL UNIQUE,\n    permissions JSONB NOT NULL DEFAULT '[]',\n    description TEXT,\n    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()\n);\n\nCREATE INDEX idx_role_permissions_jsonb ON role_permissions USING GIN(permissions);\n\n-- \u63d2\u5165\u793a\u4f8b\u89d2\u8272\nINSERT INTO role_permissions (role_name, permissions, description) VALUES\n('admin', '[\"user:create\", \"user:read\", \"user:update\", \"user:delete\", \"post:*\"]', '\u7ba1\u7406\u5458'),\n('editor', '[\"post:create\", \"post:read\", \"post:update\", \"comment:*\"]', '\u7f16\u8f91'),\n('viewer', '[\"post:read\", \"comment:read\"]', '\u8bbf\u5ba2');\n"})}),"\n",(0,r.jsx)(e.h3,{id:"\u5e38\u7528\u67e5\u8be2",children:"\u5e38\u7528\u67e5\u8be2"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-sql",children:"-- \u7528\u6237\u6ce8\u518c\nINSERT INTO users (username, email, password_hash, phone, metadata, roles)\nVALUES (\n    'zhangsan',\n    'zhangsan@example.com',\n    '$2a$10$...',\n    '13800138000',\n    '{\"city\": \"Beijing\", \"age\": 25}',\n    ARRAY['viewer']\n);\n\n-- \u7528\u6237\u767b\u5f55\u9a8c\u8bc1\nSELECT id, username, password_hash, status, roles\nFROM users\nWHERE email = 'zhangsan@example.com' AND status = 1;\n\n-- \u5206\u914d\u89d2\u8272\uff08\u6dfb\u52a0\u5230\u6570\u7ec4\uff09\nUPDATE users\nSET roles = array_append(roles, 'editor')\nWHERE id = 1 AND NOT ('editor' = ANY(roles));\n\n-- \u79fb\u9664\u89d2\u8272\nUPDATE users\nSET roles = array_remove(roles, 'viewer')\nWHERE id = 1;\n\n-- \u68c0\u67e5\u7528\u6237\u662f\u5426\u6709\u7279\u5b9a\u89d2\u8272\nSELECT * FROM users\nWHERE id = 1 AND 'admin' = ANY(roles);\n\n-- \u67e5\u8be2\u7528\u6237\u7684\u6240\u6709\u6743\u9650\nSELECT DISTINCT jsonb_array_elements_text(rp.permissions) AS permission\nFROM users u\nCROSS JOIN LATERAL unnest(u.roles) AS role_name\nINNER JOIN role_permissions rp ON role_name = rp.role_name\nWHERE u.id = 1;\n\n-- \u4f7f\u7528 JSONB \u67e5\u8be2\u7528\u6237\nSELECT * FROM users\nWHERE metadata->>'city' = 'Beijing';\n\nSELECT * FROM users\nWHERE (metadata->>'age')::int > 20;\n"})}),"\n",(0,r.jsx)(e.h2,{id:"\u7535\u5546\u8ba2\u5355\u7cfb\u7edf",children:"\u7535\u5546\u8ba2\u5355\u7cfb\u7edf"}),"\n",(0,r.jsx)(e.h3,{id:"\u9700\u6c42\u5206\u6790-1",children:"\u9700\u6c42\u5206\u6790"}),"\n",(0,r.jsx)(e.p,{children:"\u8bbe\u8ba1\u4e00\u4e2a\u652f\u6301\u5546\u54c1\u3001\u8ba2\u5355\u3001\u652f\u4ed8\u7684\u7535\u5546\u7cfb\u7edf\uff0c\u4f7f\u7528 PostgreSQL \u4e8b\u52a1\u548c\u89e6\u53d1\u5668\u3002"}),"\n",(0,r.jsx)(e.h3,{id:"\u6570\u636e\u5e93\u8bbe\u8ba1-1",children:"\u6570\u636e\u5e93\u8bbe\u8ba1"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-sql",children:"-- \u5546\u54c1\u8868\nCREATE TABLE products (\n    id BIGSERIAL PRIMARY KEY,\n    name VARCHAR(200) NOT NULL,\n    description TEXT,\n    price NUMERIC(10,2) NOT NULL CHECK (price > 0),\n    stock INT NOT NULL DEFAULT 0 CHECK (stock >= 0),\n    category_id INT,\n    -- \u4f7f\u7528 JSONB \u5b58\u50a8\u89c4\u683c\n    specifications JSONB DEFAULT '{}',\n    status SMALLINT NOT NULL DEFAULT 1,  -- 1-\u4e0a\u67b6 2-\u4e0b\u67b6\n    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),\n    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()\n);\n\nCREATE INDEX idx_products_category ON products(category_id);\nCREATE INDEX idx_products_status ON products(status);\nCREATE INDEX idx_products_name ON products USING GIN(to_tsvector('english', name));\n\n-- \u8ba2\u5355\u8868\nCREATE TABLE orders (\n    id BIGSERIAL PRIMARY KEY,\n    order_no VARCHAR(32) NOT NULL UNIQUE,\n    user_id BIGINT NOT NULL,\n    total_amount NUMERIC(10,2) NOT NULL,\n    status SMALLINT NOT NULL DEFAULT 1,  -- 1-\u5f85\u652f\u4ed8 2-\u5df2\u652f\u4ed8 3-\u5df2\u53d1\u8d27 4-\u5df2\u5b8c\u6210 5-\u5df2\u53d6\u6d88\n    payment_method SMALLINT,\n    -- \u4f7f\u7528 JSONB \u5b58\u50a8\u6536\u8d27\u5730\u5740\n    shipping_address JSONB,\n    paid_at TIMESTAMPTZ,\n    shipped_at TIMESTAMPTZ,\n    completed_at TIMESTAMPTZ,\n    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),\n    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()\n);\n\nCREATE INDEX idx_orders_user_id ON orders(user_id);\nCREATE INDEX idx_orders_status ON orders(status);\nCREATE INDEX idx_orders_created_at ON orders(created_at);\n\n-- \u8ba2\u5355\u660e\u7ec6\u8868\nCREATE TABLE order_items (\n    id BIGSERIAL PRIMARY KEY,\n    order_id BIGINT NOT NULL REFERENCES orders(id) ON DELETE CASCADE,\n    product_id BIGINT NOT NULL,\n    product_name VARCHAR(200) NOT NULL,\n    product_snapshot JSONB,  -- \u5546\u54c1\u5feb\u7167\uff08\u4ef7\u683c\u3001\u89c4\u683c\u7b49\uff09\n    price NUMERIC(10,2) NOT NULL,\n    quantity INT NOT NULL CHECK (quantity > 0),\n    subtotal NUMERIC(10,2) NOT NULL,\n    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()\n);\n\nCREATE INDEX idx_order_items_order_id ON order_items(order_id);\nCREATE INDEX idx_order_items_product_id ON order_items(product_id);\n"})}),"\n",(0,r.jsx)(e.h3,{id:"\u521b\u5efa\u8ba2\u5355\u4f7f\u7528\u4e8b\u52a1\u548c\u5b58\u50a8\u8fc7\u7a0b",children:"\u521b\u5efa\u8ba2\u5355\uff08\u4f7f\u7528\u4e8b\u52a1\u548c\u5b58\u50a8\u8fc7\u7a0b\uff09"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-sql",children:'CREATE OR REPLACE FUNCTION create_order(\n    p_user_id BIGINT,\n    p_items JSONB,  -- \u683c\u5f0f: [{"product_id": 1, "quantity": 2}, ...]\n    p_shipping_address JSONB\n)\nRETURNS TABLE(order_id BIGINT, order_no VARCHAR)\nLANGUAGE plpgsql\nAS $$\nDECLARE\n    v_order_id BIGINT;\n    v_order_no VARCHAR(32);\n    v_total NUMERIC(10,2) := 0;\n    v_item JSONB;\n    v_product_id BIGINT;\n    v_quantity INT;\n    v_price NUMERIC(10,2);\n    v_stock INT;\nBEGIN\n    -- \u751f\u6210\u8ba2\u5355\u53f7\n    v_order_no := \'ORD\' || to_char(NOW(), \'YYYYMMDD\') || LPAD(nextval(\'orders_id_seq\')::TEXT, 6, \'0\');\n\n    -- \u521b\u5efa\u8ba2\u5355\n    INSERT INTO orders (order_no, user_id, total_amount, shipping_address, status)\n    VALUES (v_order_no, p_user_id, 0, p_shipping_address, 1)\n    RETURNING id INTO v_order_id;\n\n    -- \u5904\u7406\u6bcf\u4e2a\u5546\u54c1\n    FOR v_item IN SELECT * FROM jsonb_array_elements(p_items)\n    LOOP\n        v_product_id := (v_item->>\'product_id\')::BIGINT;\n        v_quantity := (v_item->>\'quantity\')::INT;\n\n        -- \u83b7\u53d6\u5546\u54c1\u4fe1\u606f\u5e76\u9501\u5b9a\u884c\n        SELECT price, stock INTO v_price, v_stock\n        FROM products\n        WHERE id = v_product_id AND status = 1\n        FOR UPDATE;\n\n        -- \u68c0\u67e5\u5e93\u5b58\n        IF v_stock < v_quantity THEN\n            RAISE EXCEPTION \'\u5546\u54c1 % \u5e93\u5b58\u4e0d\u8db3\uff0c\u5f53\u524d\u5e93\u5b58\uff1a%\', v_product_id, v_stock;\n        END IF;\n\n        -- \u6263\u51cf\u5e93\u5b58\n        UPDATE products\n        SET stock = stock - v_quantity\n        WHERE id = v_product_id;\n\n        -- \u6dfb\u52a0\u8ba2\u5355\u660e\u7ec6\n        INSERT INTO order_items (\n            order_id, product_id, product_name, price, quantity, subtotal,\n            product_snapshot\n        )\n        SELECT\n            v_order_id,\n            p.id,\n            p.name,\n            v_price,\n            v_quantity,\n            v_price * v_quantity,\n            jsonb_build_object(\'price\', p.price, \'specifications\', p.specifications)\n        FROM products p\n        WHERE p.id = v_product_id;\n\n        -- \u7d2f\u52a0\u603b\u91d1\u989d\n        v_total := v_total + (v_price * v_quantity);\n    END LOOP;\n\n    -- \u66f4\u65b0\u8ba2\u5355\u603b\u91d1\u989d\n    UPDATE orders SET total_amount = v_total WHERE id = v_order_id;\n\n    RETURN QUERY SELECT v_order_id, v_order_no;\nEND;\n$$;\n\n-- \u4f7f\u7528\u793a\u4f8b\nSELECT * FROM create_order(\n    1,\n    \'[{"product_id": 101, "quantity": 2}, {"product_id": 102, "quantity": 1}]\'::jsonb,\n    \'{"name": "\u5f20\u4e09", "phone": "13800138000", "address": "\u5317\u4eac\u5e02\u671d\u9633\u533axxx"}\'::jsonb\n);\n'})}),"\n",(0,r.jsx)(e.h3,{id:"\u8ba2\u5355\u7edf\u8ba1\u67e5\u8be2",children:"\u8ba2\u5355\u7edf\u8ba1\u67e5\u8be2"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-sql",children:"-- \u6bcf\u65e5\u8ba2\u5355\u7edf\u8ba1\uff08\u4f7f\u7528\u7a97\u53e3\u51fd\u6570\uff09\nSELECT\n    DATE(created_at) AS order_date,\n    COUNT(*) AS order_count,\n    SUM(total_amount) AS total_sales,\n    AVG(total_amount) AS avg_order_value,\n    -- \u7d2f\u8ba1\u9500\u552e\u989d\n    SUM(SUM(total_amount)) OVER (ORDER BY DATE(created_at)) AS cumulative_sales\nFROM orders\nWHERE status IN (2, 3, 4)  -- \u5df2\u652f\u4ed8\u3001\u5df2\u53d1\u8d27\u3001\u5df2\u5b8c\u6210\n  AND created_at >= NOW() - INTERVAL '30 days'\nGROUP BY DATE(created_at)\nORDER BY order_date DESC;\n\n-- \u70ed\u9500\u5546\u54c1 TOP 10\nWITH product_sales AS (\n    SELECT\n        oi.product_id,\n        oi.product_name,\n        SUM(oi.quantity) AS total_sold,\n        SUM(oi.subtotal) AS total_revenue,\n        COUNT(DISTINCT oi.order_id) AS order_count\n    FROM order_items oi\n    INNER JOIN orders o ON oi.order_id = o.id\n    WHERE o.status IN (2, 3, 4)\n      AND o.created_at >= NOW() - INTERVAL '30 days'\n    GROUP BY oi.product_id, oi.product_name\n)\nSELECT\n    ps.*,\n    RANK() OVER (ORDER BY ps.total_sold DESC) AS rank\nFROM product_sales ps\nORDER BY ps.total_sold DESC\nLIMIT 10;\n"})}),"\n",(0,r.jsx)(e.h2,{id:"\u535a\u5ba2\u7cfb\u7edf\u8bbe\u8ba1",children:"\u535a\u5ba2\u7cfb\u7edf\u8bbe\u8ba1"}),"\n",(0,r.jsx)(e.h3,{id:"\u6570\u636e\u5e93\u8bbe\u8ba1\u4f7f\u7528\u5168\u6587\u641c\u7d22",children:"\u6570\u636e\u5e93\u8bbe\u8ba1\uff08\u4f7f\u7528\u5168\u6587\u641c\u7d22\uff09"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-sql",children:"-- \u6587\u7ae0\u8868\nCREATE TABLE posts (\n    id BIGSERIAL PRIMARY KEY,\n    user_id BIGINT NOT NULL,\n    title VARCHAR(200) NOT NULL,\n    content TEXT NOT NULL,\n    summary VARCHAR(500),\n    cover_image VARCHAR(255),\n    tags TEXT[] DEFAULT '{}',  -- \u4f7f\u7528\u6570\u7ec4\u5b58\u50a8\u6807\u7b7e\n    view_count INT NOT NULL DEFAULT 0,\n    like_count INT NOT NULL DEFAULT 0,\n    comment_count INT NOT NULL DEFAULT 0,\n    status SMALLINT NOT NULL DEFAULT 1,  -- 1-\u8349\u7a3f 2-\u5df2\u53d1\u5e03 3-\u5df2\u5220\u9664\n    -- \u5168\u6587\u641c\u7d22\u5411\u91cf\n    search_vector tsvector,\n    published_at TIMESTAMPTZ,\n    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),\n    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()\n);\n\n-- \u521b\u5efa\u5168\u6587\u641c\u7d22\u7d22\u5f15\nCREATE INDEX idx_posts_search ON posts USING GIN(search_vector);\nCREATE INDEX idx_posts_tags ON posts USING GIN(tags);\nCREATE INDEX idx_posts_published_at ON posts(published_at);\n\n-- \u81ea\u52a8\u66f4\u65b0\u641c\u7d22\u5411\u91cf\u7684\u89e6\u53d1\u5668\nCREATE OR REPLACE FUNCTION update_post_search_vector()\nRETURNS TRIGGER AS $$\nBEGIN\n    NEW.search_vector := to_tsvector('english', COALESCE(NEW.title, '') || ' ' || COALESCE(NEW.content, ''));\n    RETURN NEW;\nEND;\n$$ LANGUAGE plpgsql;\n\nCREATE TRIGGER trigger_update_post_search\nBEFORE INSERT OR UPDATE OF title, content ON posts\nFOR EACH ROW\nEXECUTE FUNCTION update_post_search_vector();\n\n-- \u8bc4\u8bba\u8868\uff08\u652f\u6301\u6811\u5f62\u7ed3\u6784\uff09\nCREATE TABLE comments (\n    id BIGSERIAL PRIMARY KEY,\n    post_id BIGINT NOT NULL REFERENCES posts(id) ON DELETE CASCADE,\n    user_id BIGINT NOT NULL,\n    parent_id BIGINT REFERENCES comments(id) ON DELETE CASCADE,\n    -- \u5b58\u50a8\u5b8c\u6574\u8def\u5f84\uff0c\u4fbf\u4e8e\u67e5\u8be2\u6574\u4e2a\u8bc4\u8bba\u6811\n    path TEXT,\n    content TEXT NOT NULL,\n    like_count INT NOT NULL DEFAULT 0,\n    status SMALLINT NOT NULL DEFAULT 1,  -- 1-\u6b63\u5e38 2-\u5df2\u5220\u9664\n    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()\n);\n\nCREATE INDEX idx_comments_post_id ON comments(post_id);\nCREATE INDEX idx_comments_path ON comments(path);\n\n-- \u81ea\u52a8\u66f4\u65b0\u8bc4\u8bba\u8def\u5f84\u7684\u89e6\u53d1\u5668\nCREATE OR REPLACE FUNCTION update_comment_path()\nRETURNS TRIGGER AS $$\nBEGIN\n    IF NEW.parent_id IS NULL THEN\n        NEW.path := NEW.id::TEXT;\n    ELSE\n        SELECT path || '.' || NEW.id INTO NEW.path\n        FROM comments WHERE id = NEW.parent_id;\n    END IF;\n    RETURN NEW;\nEND;\n$$ LANGUAGE plpgsql;\n\nCREATE TRIGGER trigger_update_comment_path\nBEFORE INSERT ON comments\nFOR EACH ROW\nEXECUTE FUNCTION update_comment_path();\n"})}),"\n",(0,r.jsx)(e.h3,{id:"\u5168\u6587\u641c\u7d22\u67e5\u8be2",children:"\u5168\u6587\u641c\u7d22\u67e5\u8be2"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-sql",children:"-- \u57fa\u672c\u5168\u6587\u641c\u7d22\nSELECT\n    id,\n    title,\n    summary,\n    ts_rank(search_vector, query) AS rank\nFROM posts, to_tsquery('english', 'postgresql & database') AS query\nWHERE search_vector @@ query AND status = 2\nORDER BY rank DESC\nLIMIT 20;\n\n-- \u9ad8\u7ea7\u5168\u6587\u641c\u7d22\uff08\u5e26\u9ad8\u4eae\uff09\nSELECT\n    id,\n    title,\n    ts_headline('english', content, query, 'MaxWords=50, MinWords=25') AS snippet,\n    ts_rank(search_vector, query) AS rank\nFROM posts, to_tsquery('english', 'postgresql <-> optimization') AS query\nWHERE search_vector @@ query AND status = 2\nORDER BY rank DESC\nLIMIT 20;\n\n-- \u6807\u7b7e\u641c\u7d22\uff08\u4f7f\u7528\u6570\u7ec4\uff09\nSELECT * FROM posts\nWHERE 'postgresql' = ANY(tags) AND status = 2\nORDER BY published_at DESC;\n\n-- \u591a\u6807\u7b7e\u641c\u7d22\nSELECT * FROM posts\nWHERE tags @> ARRAY['postgresql', 'optimization'] AND status = 2;\n"})}),"\n",(0,r.jsx)(e.h3,{id:"\u8bc4\u8bba\u6811\u67e5\u8be2",children:"\u8bc4\u8bba\u6811\u67e5\u8be2"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-sql",children:"-- \u83b7\u53d6\u6587\u7ae0\u7684\u6240\u6709\u8bc4\u8bba\uff08\u6811\u5f62\u7ed3\u6784\uff09\nWITH RECURSIVE comment_tree AS (\n    -- \u6839\u8bc4\u8bba\n    SELECT\n        c.*,\n        u.username,\n        0 AS depth\n    FROM comments c\n    INNER JOIN users u ON c.user_id = u.id\n    WHERE c.post_id = 1 AND c.parent_id IS NULL\n\n    UNION ALL\n\n    -- \u5b50\u8bc4\u8bba\n    SELECT\n        c.*,\n        u.username,\n        ct.depth + 1\n    FROM comments c\n    INNER JOIN users u ON c.user_id = u.id\n    INNER JOIN comment_tree ct ON c.parent_id = ct.id\n)\nSELECT * FROM comment_tree\nORDER BY path;\n"})}),"\n",(0,r.jsx)(e.h2,{id:"\u5730\u7406\u4f4d\u7f6e\u5e94\u7528postgis",children:"\u5730\u7406\u4f4d\u7f6e\u5e94\u7528\uff08PostGIS\uff09"}),"\n",(0,r.jsx)(e.h3,{id:"\u542f\u7528-postgis-\u6269\u5c55",children:"\u542f\u7528 PostGIS \u6269\u5c55"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-sql",children:"-- \u542f\u7528 PostGIS\nCREATE EXTENSION IF NOT EXISTS postgis;\n\n-- \u521b\u5efa\u5730\u70b9\u8868\nCREATE TABLE locations (\n    id BIGSERIAL PRIMARY KEY,\n    name VARCHAR(100) NOT NULL,\n    address TEXT,\n    -- \u5730\u7406\u5750\u6807\u70b9\uff08\u7ecf\u5ea6\uff0c\u7eac\u5ea6\uff09\n    geom GEOMETRY(Point, 4326),\n    category VARCHAR(50),\n    rating NUMERIC(2,1),\n    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()\n);\n\n-- \u521b\u5efa\u7a7a\u95f4\u7d22\u5f15\nCREATE INDEX idx_locations_geom ON locations USING GIST(geom);\n"})}),"\n",(0,r.jsx)(e.h3,{id:"\u5730\u7406\u4f4d\u7f6e\u67e5\u8be2",children:"\u5730\u7406\u4f4d\u7f6e\u67e5\u8be2"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-sql",children:"-- \u63d2\u5165\u5730\u70b9\uff08\u5317\u4eac\u5929\u5b89\u95e8\uff09\nINSERT INTO locations (name, address, geom, category)\nVALUES (\n    '\u5929\u5b89\u95e8',\n    '\u5317\u4eac\u5e02\u4e1c\u57ce\u533a',\n    ST_SetSRID(ST_MakePoint(116.397428, 39.909187), 4326),\n    'landmark'\n);\n\n-- \u67e5\u627e\u9644\u8fd1\u7684\u5730\u70b9\uff085\u516c\u91cc\u5185\uff09\nSELECT\n    name,\n    address,\n    ST_Distance(\n        geom::geography,\n        ST_SetSRID(ST_MakePoint(116.404, 39.915), 4326)::geography\n    ) / 1000 AS distance_km\nFROM locations\nWHERE ST_DWithin(\n    geom::geography,\n    ST_SetSRID(ST_MakePoint(116.404, 39.915), 4326)::geography,\n    5000  -- 5000\u7c73\n)\nORDER BY geom <-> ST_SetSRID(ST_MakePoint(116.404, 39.915), 4326)\nLIMIT 10;\n\n-- \u5728\u591a\u8fb9\u5f62\u533a\u57df\u5185\u67e5\u627e\nSELECT name, address\nFROM locations\nWHERE ST_Within(\n    geom,\n    ST_GeomFromText('POLYGON((\n        116.3 39.8,\n        116.5 39.8,\n        116.5 40.0,\n        116.3 40.0,\n        116.3 39.8\n    ))', 4326)\n);\n"})}),"\n",(0,r.jsx)(e.h2,{id:"\u65f6\u5e8f\u6570\u636e\u5206\u6790",children:"\u65f6\u5e8f\u6570\u636e\u5206\u6790"}),"\n",(0,r.jsx)(e.h3,{id:"\u7269\u8054\u7f51\u4f20\u611f\u5668\u6570\u636e",children:"\u7269\u8054\u7f51\u4f20\u611f\u5668\u6570\u636e"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-sql",children:"-- \u4f20\u611f\u5668\u6570\u636e\u8868\uff08\u4f7f\u7528 TimescaleDB \u6269\u5c55\u4f1a\u66f4\u597d\uff09\nCREATE TABLE sensor_data (\n    time TIMESTAMPTZ NOT NULL,\n    sensor_id INT NOT NULL,\n    temperature NUMERIC(5,2),\n    humidity NUMERIC(5,2),\n    pressure NUMERIC(7,2)\n);\n\n-- \u521b\u5efa\u8d85\u8868\uff08\u9700\u8981 TimescaleDB\uff09\n-- SELECT create_hypertable('sensor_data', 'time');\n\n-- \u521b\u5efa\u7d22\u5f15\nCREATE INDEX idx_sensor_data_time ON sensor_data(time DESC);\nCREATE INDEX idx_sensor_data_sensor_id ON sensor_data(sensor_id, time DESC);\n\n-- \u65f6\u95f4\u8303\u56f4\u805a\u5408\u67e5\u8be2\nSELECT\n    time_bucket('1 hour', time) AS hour,\n    sensor_id,\n    AVG(temperature) AS avg_temp,\n    MAX(temperature) AS max_temp,\n    MIN(temperature) AS min_temp\nFROM sensor_data\nWHERE time >= NOW() - INTERVAL '24 hours'\nGROUP BY hour, sensor_id\nORDER BY hour DESC;\n\n-- \u79fb\u52a8\u5e73\u5747\nSELECT\n    time,\n    sensor_id,\n    temperature,\n    AVG(temperature) OVER (\n        PARTITION BY sensor_id\n        ORDER BY time\n        ROWS BETWEEN 5 PRECEDING AND CURRENT ROW\n    ) AS moving_avg\nFROM sensor_data\nWHERE sensor_id = 1 AND time >= NOW() - INTERVAL '24 hours'\nORDER BY time DESC;\n"})}),"\n",(0,r.jsx)(e.h2,{id:"\u5206\u533a\u8868\u5b9e\u6218",children:"\u5206\u533a\u8868\u5b9e\u6218"}),"\n",(0,r.jsx)(e.h3,{id:"\u6309\u65f6\u95f4\u8303\u56f4\u5206\u533a",children:"\u6309\u65f6\u95f4\u8303\u56f4\u5206\u533a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-sql",children:"-- \u521b\u5efa\u5206\u533a\u4e3b\u8868\nCREATE TABLE orders_partitioned (\n    id BIGSERIAL,\n    order_no VARCHAR(32) NOT NULL,\n    user_id BIGINT NOT NULL,\n    total_amount NUMERIC(10,2) NOT NULL,\n    created_at TIMESTAMPTZ NOT NULL\n) PARTITION BY RANGE (created_at);\n\n-- \u521b\u5efa\u5206\u533a\nCREATE TABLE orders_2024_q1 PARTITION OF orders_partitioned\nFOR VALUES FROM ('2024-01-01') TO ('2024-04-01');\n\nCREATE TABLE orders_2024_q2 PARTITION OF orders_partitioned\nFOR VALUES FROM ('2024-04-01') TO ('2024-07-01');\n\nCREATE TABLE orders_2024_q3 PARTITION OF orders_partitioned\nFOR VALUES FROM ('2024-07-01') TO ('2024-10-01');\n\nCREATE TABLE orders_2024_q4 PARTITION OF orders_partitioned\nFOR VALUES FROM ('2024-10-01') TO ('2025-01-01');\n\n-- \u4e3a\u6bcf\u4e2a\u5206\u533a\u521b\u5efa\u7d22\u5f15\nCREATE INDEX idx_orders_2024_q1_created ON orders_2024_q1(created_at);\nCREATE INDEX idx_orders_2024_q2_created ON orders_2024_q2(created_at);\n\n-- \u67e5\u8be2\u4f1a\u81ea\u52a8\u8def\u7531\u5230\u5bf9\u5e94\u5206\u533a\nSELECT * FROM orders_partitioned\nWHERE created_at >= '2024-03-01' AND created_at < '2024-04-01';\n"})}),"\n",(0,r.jsx)(e.h2,{id:"\u603b\u7ed3",children:"\u603b\u7ed3"}),"\n",(0,r.jsx)(e.p,{children:"\u672c\u6587\u6863\u901a\u8fc7\u5b9e\u9645\u6848\u4f8b\u5c55\u793a\u4e86 PostgreSQL \u7684\u5f3a\u5927\u7279\u6027\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u2705 JSONB \u548c\u6570\u7ec4\u7c7b\u578b\u7684\u7075\u6d3b\u5e94\u7528"}),"\n",(0,r.jsx)(e.li,{children:"\u2705 \u5168\u6587\u641c\u7d22\u548c GIN \u7d22\u5f15"}),"\n",(0,r.jsx)(e.li,{children:"\u2705 \u9012\u5f52\u67e5\u8be2\u5904\u7406\u6811\u5f62\u7ed3\u6784"}),"\n",(0,r.jsx)(e.li,{children:"\u2705 PostGIS \u5730\u7406\u4f4d\u7f6e\u67e5\u8be2"}),"\n",(0,r.jsx)(e.li,{children:"\u2705 \u7a97\u53e3\u51fd\u6570\u548c\u65f6\u5e8f\u6570\u636e\u5206\u6790"}),"\n",(0,r.jsx)(e.li,{children:"\u2705 \u5206\u533a\u8868\u4f18\u5316\u5927\u6570\u636e\u91cf\u573a\u666f"}),"\n",(0,r.jsx)(e.li,{children:"\u2705 \u5b58\u50a8\u8fc7\u7a0b\u548c\u89e6\u53d1\u5668\u5b9e\u73b0\u4e1a\u52a1\u903b\u8f91"}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"\u8fd9\u4e9b\u6848\u4f8b\u5145\u5206\u5c55\u793a\u4e86 PostgreSQL \u76f8\u6bd4\u4f20\u7edf\u5173\u7cfb\u6570\u636e\u5e93\u7684\u4f18\u52bf\uff0c\u53ef\u4ee5\u76f4\u63a5\u5e94\u7528\u5230\u5b9e\u9645\u9879\u76ee\u4e2d\u3002"}),"\n",(0,r.jsxs)(e.p,{children:["\u7ee7\u7eed\u5b66\u4e60 ",(0,r.jsx)(e.a,{href:"/docs/postgres/performance-optimization",children:"\u6027\u80fd\u4f18\u5316"})," \u548c ",(0,r.jsx)(e.a,{href:"/docs/postgres/best-practices",children:"\u6700\u4f73\u5b9e\u8df5"}),"\uff01"]})]})}function T(n={}){const{wrapper:e}={...(0,E.R)(),...n.components};return e?(0,r.jsx)(e,{...n,children:(0,r.jsx)(N,{...n})}):N(n)}}}]);