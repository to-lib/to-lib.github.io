"use strict";(globalThis.webpackChunkto_lib_github_io=globalThis.webpackChunkto_lib_github_io||[]).push([[66619],{27570:(n,e,s)=>{s.r(e),s.d(e,{assets:()=>l,contentTitle:()=>o,default:()=>h,frontMatter:()=>c,metadata:()=>i,toc:()=>d});const i=JSON.parse('{"id":"docker/signing","title":"\u955c\u50cf\u7b7e\u540d","description":"Docker Content Trust\u3001Notary \u4e0e Cosign \u955c\u50cf\u7b7e\u540d\u9a8c\u8bc1","source":"@site/docs/docker/signing.md","sourceDirName":"docker","slug":"/docker/signing","permalink":"/docs/docker/signing","draft":false,"unlisted":false,"editUrl":"https://github.com/to-lib/to-lib.github.io/tree/main/docs/docker/signing.md","tags":[],"version":"current","sidebarPosition":36,"frontMatter":{"sidebar_position":36,"title":"\u955c\u50cf\u7b7e\u540d","description":"Docker Content Trust\u3001Notary \u4e0e Cosign \u955c\u50cf\u7b7e\u540d\u9a8c\u8bc1"},"sidebar":"docker","previous":{"title":"Rootless Docker","permalink":"/docs/docker/rootless"},"next":{"title":"Docker Scout","permalink":"/docs/docker/scout"}}');var r=s(22714),t=s(48885);const c={sidebar_position:36,title:"\u955c\u50cf\u7b7e\u540d",description:"Docker Content Trust\u3001Notary \u4e0e Cosign \u955c\u50cf\u7b7e\u540d\u9a8c\u8bc1"},o="\u955c\u50cf\u7b7e\u540d",l={},d=[{value:"Docker Content Trust (DCT)",id:"docker-content-trust-dct",level:2},{value:"\u542f\u7528 DCT",id:"\u542f\u7528-dct",level:3},{value:"\u7b7e\u540d\u548c\u63a8\u9001",id:"\u7b7e\u540d\u548c\u63a8\u9001",level:3},{value:"\u62c9\u53d6\u9a8c\u8bc1",id:"\u62c9\u53d6\u9a8c\u8bc1",level:3},{value:"\u5bc6\u94a5\u7ba1\u7406",id:"\u5bc6\u94a5\u7ba1\u7406",level:3},{value:"Cosign\uff08\u63a8\u8350\uff09",id:"cosign\u63a8\u8350",level:2},{value:"\u5b89\u88c5",id:"\u5b89\u88c5",level:3},{value:"\u751f\u6210\u5bc6\u94a5\u5bf9",id:"\u751f\u6210\u5bc6\u94a5\u5bf9",level:3},{value:"\u7b7e\u540d\u955c\u50cf",id:"\u7b7e\u540d\u955c\u50cf",level:3},{value:"\u9a8c\u8bc1\u7b7e\u540d",id:"\u9a8c\u8bc1\u7b7e\u540d",level:3},{value:"\u9644\u52a0\u8bc1\u660e (Attestations)",id:"\u9644\u52a0\u8bc1\u660e-attestations",level:3},{value:"CI/CD \u96c6\u6210",id:"cicd-\u96c6\u6210",level:2},{value:"GitHub Actions + Cosign",id:"github-actions--cosign",level:3},{value:"\u4f7f\u7528\u79c1\u94a5\u7b7e\u540d",id:"\u4f7f\u7528\u79c1\u94a5\u7b7e\u540d",level:3},{value:"Kubernetes \u7b56\u7565",id:"kubernetes-\u7b56\u7565",level:2},{value:"\u4f7f\u7528 Kyverno \u9a8c\u8bc1\u7b7e\u540d",id:"\u4f7f\u7528-kyverno-\u9a8c\u8bc1\u7b7e\u540d",level:3},{value:"\u4f7f\u7528 Sigstore Policy Controller",id:"\u4f7f\u7528-sigstore-policy-controller",level:3},{value:"\u5bf9\u6bd4",id:"\u5bf9\u6bd4",level:2},{value:"\u6700\u4f73\u5b9e\u8df5",id:"\u6700\u4f73\u5b9e\u8df5",level:2}];function a(n){const e={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",p:"p",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",...(0,t.R)(),...n.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(e.header,{children:(0,r.jsx)(e.h1,{id:"\u955c\u50cf\u7b7e\u540d",children:"\u955c\u50cf\u7b7e\u540d"})}),"\n",(0,r.jsx)(e.p,{children:"\u955c\u50cf\u7b7e\u540d\u7528\u4e8e\u9a8c\u8bc1\u955c\u50cf\u7684\u6765\u6e90\u548c\u5b8c\u6574\u6027\uff0c\u786e\u4fdd\u4f9b\u5e94\u94fe\u5b89\u5168\u3002"}),"\n",(0,r.jsx)(e.h2,{id:"docker-content-trust-dct",children:"Docker Content Trust (DCT)"}),"\n",(0,r.jsx)(e.p,{children:"Docker \u5185\u7f6e\u7684\u955c\u50cf\u7b7e\u540d\u673a\u5236\uff0c\u57fa\u4e8e Notary\u3002"}),"\n",(0,r.jsx)(e.h3,{id:"\u542f\u7528-dct",children:"\u542f\u7528 DCT"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-bash",children:"# \u4e34\u65f6\u542f\u7528\nexport DOCKER_CONTENT_TRUST=1\n\n# \u6c38\u4e45\u542f\u7528\uff08\u6dfb\u52a0\u5230 ~/.bashrc\uff09\necho 'export DOCKER_CONTENT_TRUST=1' >> ~/.bashrc\n"})}),"\n",(0,r.jsx)(e.h3,{id:"\u7b7e\u540d\u548c\u63a8\u9001",children:"\u7b7e\u540d\u548c\u63a8\u9001"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-bash",children:"# \u542f\u7528 DCT \u540e\uff0cpush \u81ea\u52a8\u7b7e\u540d\nexport DOCKER_CONTENT_TRUST=1\ndocker push myregistry/myapp:v1.0\n\n# \u9996\u6b21\u63a8\u9001\u4f1a\u751f\u6210\u5bc6\u94a5\n# - Root key: \u79bb\u7ebf\u4fdd\u5b58\uff0c\u7528\u4e8e\u521b\u5efa\u5176\u4ed6\u5bc6\u94a5\n# - Repository key: \u7528\u4e8e\u7b7e\u540d\u7279\u5b9a\u4ed3\u5e93\n"})}),"\n",(0,r.jsx)(e.h3,{id:"\u62c9\u53d6\u9a8c\u8bc1",children:"\u62c9\u53d6\u9a8c\u8bc1"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-bash",children:"# \u542f\u7528 DCT \u540e\uff0c\u53ea\u80fd\u62c9\u53d6\u5df2\u7b7e\u540d\u955c\u50cf\nexport DOCKER_CONTENT_TRUST=1\ndocker pull myregistry/myapp:v1.0\n\n# \u672a\u7b7e\u540d\u955c\u50cf\u4f1a\u62a5\u9519\n# Error: remote trust data does not exist\n"})}),"\n",(0,r.jsx)(e.h3,{id:"\u5bc6\u94a5\u7ba1\u7406",children:"\u5bc6\u94a5\u7ba1\u7406"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-bash",children:"# \u67e5\u770b\u5bc6\u94a5\ndocker trust key list\n\n# \u751f\u6210\u65b0\u5bc6\u94a5\ndocker trust key generate mykey\n\n# \u6dfb\u52a0\u7b7e\u540d\u8005\ndocker trust signer add --key mykey.pub myname myregistry/myapp\n\n# \u67e5\u770b\u7b7e\u540d\u4fe1\u606f\ndocker trust inspect myregistry/myapp\n\n# \u64a4\u9500\u7b7e\u540d\ndocker trust revoke myregistry/myapp:v1.0\n"})}),"\n",(0,r.jsx)(e.h2,{id:"cosign\u63a8\u8350",children:"Cosign\uff08\u63a8\u8350\uff09"}),"\n",(0,r.jsx)(e.p,{children:"Sigstore \u9879\u76ee\u7684\u955c\u50cf\u7b7e\u540d\u5de5\u5177\uff0c\u66f4\u73b0\u4ee3\u3001\u66f4\u6613\u7528\u3002"}),"\n",(0,r.jsx)(e.h3,{id:"\u5b89\u88c5",children:"\u5b89\u88c5"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-bash",children:"# macOS\nbrew install cosign\n\n# Linux\ncurl -LO https://github.com/sigstore/cosign/releases/latest/download/cosign-linux-amd64\nchmod +x cosign-linux-amd64\nsudo mv cosign-linux-amd64 /usr/local/bin/cosign\n"})}),"\n",(0,r.jsx)(e.h3,{id:"\u751f\u6210\u5bc6\u94a5\u5bf9",children:"\u751f\u6210\u5bc6\u94a5\u5bf9"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-bash",children:"# \u751f\u6210\u5bc6\u94a5\u5bf9\ncosign generate-key-pair\n\n# \u8f93\u51fa\uff1a\n# - cosign.key (\u79c1\u94a5\uff0c\u9700\u8981\u5bc6\u7801\u4fdd\u62a4)\n# - cosign.pub (\u516c\u94a5)\n"})}),"\n",(0,r.jsx)(e.h3,{id:"\u7b7e\u540d\u955c\u50cf",children:"\u7b7e\u540d\u955c\u50cf"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-bash",children:"# \u4f7f\u7528\u672c\u5730\u5bc6\u94a5\u7b7e\u540d\ncosign sign --key cosign.key myregistry/myapp:v1.0\n\n# \u4f7f\u7528 Keyless \u7b7e\u540d\uff08\u63a8\u8350\uff0c\u65e0\u9700\u7ba1\u7406\u5bc6\u94a5\uff09\ncosign sign myregistry/myapp:v1.0\n# \u4f1a\u6253\u5f00\u6d4f\u89c8\u5668\u8fdb\u884c OIDC \u8ba4\u8bc1\n"})}),"\n",(0,r.jsx)(e.h3,{id:"\u9a8c\u8bc1\u7b7e\u540d",children:"\u9a8c\u8bc1\u7b7e\u540d"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-bash",children:"# \u4f7f\u7528\u516c\u94a5\u9a8c\u8bc1\ncosign verify --key cosign.pub myregistry/myapp:v1.0\n\n# Keyless \u9a8c\u8bc1\ncosign verify \\\n  --certificate-identity=user@example.com \\\n  --certificate-oidc-issuer=https://accounts.google.com \\\n  myregistry/myapp:v1.0\n"})}),"\n",(0,r.jsx)(e.h3,{id:"\u9644\u52a0\u8bc1\u660e-attestations",children:"\u9644\u52a0\u8bc1\u660e (Attestations)"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-bash",children:"# \u9644\u52a0 SBOM\ncosign attest --key cosign.key --predicate sbom.json myregistry/myapp:v1.0\n\n# \u9644\u52a0\u6f0f\u6d1e\u626b\u63cf\u7ed3\u679c\ncosign attest --key cosign.key --predicate vuln-scan.json myregistry/myapp:v1.0\n\n# \u9a8c\u8bc1\u8bc1\u660e\ncosign verify-attestation --key cosign.pub myregistry/myapp:v1.0\n"})}),"\n",(0,r.jsx)(e.h2,{id:"cicd-\u96c6\u6210",children:"CI/CD \u96c6\u6210"}),"\n",(0,r.jsx)(e.h3,{id:"github-actions--cosign",children:"GitHub Actions + Cosign"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-yaml",children:"name: Build and Sign\n\non:\n  push:\n    tags: ['v*']\n\njobs:\n  build:\n    runs-on: ubuntu-latest\n    permissions:\n      contents: read\n      packages: write\n      id-token: write  # Keyless \u7b7e\u540d\u9700\u8981\n\n    steps:\n      - uses: actions/checkout@v4\n\n      - name: Install Cosign\n        uses: sigstore/cosign-installer@v3\n\n      - name: Login to GHCR\n        uses: docker/login-action@v3\n        with:\n          registry: ghcr.io\n          username: ${{ github.actor }}\n          password: ${{ secrets.GITHUB_TOKEN }}\n\n      - name: Build and Push\n        id: build\n        uses: docker/build-push-action@v5\n        with:\n          push: true\n          tags: ghcr.io/${{ github.repository }}:${{ github.ref_name }}\n\n      - name: Sign Image (Keyless)\n        run: |\n          cosign sign --yes ghcr.io/${{ github.repository }}@${{ steps.build.outputs.digest }}\n"})}),"\n",(0,r.jsx)(e.h3,{id:"\u4f7f\u7528\u79c1\u94a5\u7b7e\u540d",children:"\u4f7f\u7528\u79c1\u94a5\u7b7e\u540d"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-yaml",children:'- name: Sign Image\n  env:\n    COSIGN_KEY: ${{ secrets.COSIGN_KEY }}\n    COSIGN_PASSWORD: ${{ secrets.COSIGN_PASSWORD }}\n  run: |\n    echo "$COSIGN_KEY" > cosign.key\n    cosign sign --key cosign.key ghcr.io/${{ github.repository }}:${{ github.ref_name }}\n'})}),"\n",(0,r.jsx)(e.h2,{id:"kubernetes-\u7b56\u7565",children:"Kubernetes \u7b56\u7565"}),"\n",(0,r.jsx)(e.h3,{id:"\u4f7f\u7528-kyverno-\u9a8c\u8bc1\u7b7e\u540d",children:"\u4f7f\u7528 Kyverno \u9a8c\u8bc1\u7b7e\u540d"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-yaml",children:'apiVersion: kyverno.io/v1\nkind: ClusterPolicy\nmetadata:\n  name: verify-image-signature\nspec:\n  validationFailureAction: Enforce\n  rules:\n    - name: verify-signature\n      match:\n        resources:\n          kinds:\n            - Pod\n      verifyImages:\n        - imageReferences:\n            - "ghcr.io/myorg/*"\n          attestors:\n            - entries:\n                - keyless:\n                    subject: "user@example.com"\n                    issuer: "https://accounts.google.com"\n'})}),"\n",(0,r.jsx)(e.h3,{id:"\u4f7f\u7528-sigstore-policy-controller",children:"\u4f7f\u7528 Sigstore Policy Controller"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-yaml",children:'apiVersion: policy.sigstore.dev/v1alpha1\nkind: ClusterImagePolicy\nmetadata:\n  name: require-signature\nspec:\n  images:\n    - glob: "ghcr.io/myorg/**"\n  authorities:\n    - keyless:\n        identities:\n          - issuer: https://accounts.google.com\n            subject: user@example.com\n'})}),"\n",(0,r.jsx)(e.h2,{id:"\u5bf9\u6bd4",children:"\u5bf9\u6bd4"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,r.jsxs)(e.table,{children:[(0,r.jsx)(e.thead,{children:(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.th,{children:"\u7279\u6027"}),(0,r.jsx)(e.th,{children:"DCT/Notary"}),(0,r.jsx)(e.th,{children:"Cosign"})]})}),(0,r.jsxs)(e.tbody,{children:[(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"\u6613\u7528\u6027"}),(0,r.jsx)(e.td,{children:"\u590d\u6742"}),(0,r.jsx)(e.td,{children:"\u7b80\u5355"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"Keyless"}),(0,r.jsx)(e.td,{children:"\u4e0d\u652f\u6301"}),(0,r.jsx)(e.td,{children:"\u652f\u6301"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"\u900f\u660e\u65e5\u5fd7"}),(0,r.jsx)(e.td,{children:"\u65e0"}),(0,r.jsx)(e.td,{children:"Rekor"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"SBOM \u652f\u6301"}),(0,r.jsx)(e.td,{children:"\u65e0"}),(0,r.jsx)(e.td,{children:"\u652f\u6301"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"\u793e\u533a\u6d3b\u8dc3\u5ea6"}),(0,r.jsx)(e.td,{children:"\u4f4e"}),(0,r.jsx)(e.td,{children:"\u9ad8"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"\u63a8\u8350\u7a0b\u5ea6"}),(0,r.jsx)(e.td,{children:"\u9057\u7559\u7cfb\u7edf"}),(0,r.jsx)(e.td,{children:"\u65b0\u9879\u76ee\u9996\u9009"})]})]})]}),"\n",(0,r.jsx)(e.h2,{id:"\u6700\u4f73\u5b9e\u8df5",children:"\u6700\u4f73\u5b9e\u8df5"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-bash",children:"# 1. \u4f7f\u7528 Keyless \u7b7e\u540d\uff08\u65e0\u9700\u7ba1\u7406\u5bc6\u94a5\uff09\ncosign sign myregistry/myapp:v1.0\n\n# 2. \u7b7e\u540d\u65f6\u9644\u52a0 SBOM\nsyft myregistry/myapp:v1.0 -o spdx-json > sbom.json\ncosign attest --predicate sbom.json myregistry/myapp:v1.0\n\n# 3. \u5728 CI/CD \u4e2d\u81ea\u52a8\u7b7e\u540d\n# 4. \u5728 Kubernetes \u4e2d\u5f3a\u5236\u9a8c\u8bc1\u7b7e\u540d\n# 5. \u5b9a\u671f\u8f6e\u6362\u5bc6\u94a5\uff08\u5982\u4f7f\u7528\u672c\u5730\u5bc6\u94a5\uff09\n"})})]})}function h(n={}){const{wrapper:e}={...(0,t.R)(),...n.components};return e?(0,r.jsx)(e,{...n,children:(0,r.jsx)(a,{...n})}):a(n)}},48885:(n,e,s)=>{s.d(e,{R:()=>c,x:()=>o});var i=s(99378);const r={},t=i.createContext(r);function c(n){const e=i.useContext(t);return i.useMemo(function(){return"function"==typeof n?n(e):{...e,...n}},[e,n])}function o(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(r):n.components||r:c(n.components),i.createElement(t.Provider,{value:e},n.children)}}}]);