"use strict";(globalThis.webpackChunkto_lib_github_io=globalThis.webpackChunkto_lib_github_io||[]).push([[1662],{48885:(e,n,s)=>{s.d(n,{R:()=>a,x:()=>i});var t=s(99378);const r={},o=t.createContext(r);function a(e){const n=t.useContext(o);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function i(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:a(e.components),t.createElement(o.Provider,{value:n},e.children)}},76566:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>l,contentTitle:()=>i,default:()=>c,frontMatter:()=>a,metadata:()=>t,toc:()=>d});const t=JSON.parse('{"id":"rust/web-development","title":"Web \u540e\u7aef\u5f00\u53d1","description":"\u672c\u6587\u4ecb\u7ecd\u4f7f\u7528 Rust \u6784\u5efa Web \u540e\u7aef\u670d\u52a1\uff0c\u91cd\u70b9\u8bb2\u89e3 Axum \u6846\u67b6\u53ca\u5176\u751f\u6001\u7cfb\u7edf\u3002","source":"@site/docs/rust/web-development.md","sourceDirName":"rust","slug":"/rust/web-development","permalink":"/docs/rust/web-development","draft":false,"unlisted":false,"editUrl":"https://github.com/to-lib/to-lib.github.io/tree/main/docs/rust/web-development.md","tags":[],"version":"current","sidebarPosition":14,"frontMatter":{"sidebar_position":14,"title":"Web \u540e\u7aef\u5f00\u53d1"},"sidebar":"rust","previous":{"title":"\u5de5\u7a0b\u5316\u5b9e\u8df5","permalink":"/docs/rust/engineering"},"next":{"title":"\u6d4b\u8bd5","permalink":"/docs/rust/testing"}}');var r=s(22714),o=s(48885);const a={sidebar_position:14,title:"Web \u540e\u7aef\u5f00\u53d1"},i="Web \u540e\u7aef\u5f00\u53d1",l={},d=[{value:"Axum \u7b80\u4ecb",id:"axum-\u7b80\u4ecb",level:2},{value:"\u5feb\u901f\u5f00\u59cb",id:"\u5feb\u901f\u5f00\u59cb",level:2},{value:"\u8def\u7531",id:"\u8def\u7531",level:2},{value:"\u63d0\u53d6\u5668",id:"\u63d0\u53d6\u5668",level:2},{value:"\u81ea\u5b9a\u4e49\u63d0\u53d6\u5668",id:"\u81ea\u5b9a\u4e49\u63d0\u53d6\u5668",level:3},{value:"\u4e2d\u95f4\u4ef6",id:"\u4e2d\u95f4\u4ef6",level:2},{value:"\u81ea\u5b9a\u4e49\u4e2d\u95f4\u4ef6",id:"\u81ea\u5b9a\u4e49\u4e2d\u95f4\u4ef6",level:3},{value:"SQLx \u6570\u636e\u5e93",id:"sqlx-\u6570\u636e\u5e93",level:2},{value:"Redis \u96c6\u6210",id:"redis-\u96c6\u6210",level:2},{value:"JWT \u8ba4\u8bc1",id:"jwt-\u8ba4\u8bc1",level:2},{value:"\u9519\u8bef\u5904\u7406",id:"\u9519\u8bef\u5904\u7406",level:2},{value:"\u9879\u76ee\u7ed3\u6784",id:"\u9879\u76ee\u7ed3\u6784",level:2},{value:"\u6700\u4f73\u5b9e\u8df5",id:"\u6700\u4f73\u5b9e\u8df5",level:2}];function u(e){const n={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,o.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"web-\u540e\u7aef\u5f00\u53d1",children:"Web \u540e\u7aef\u5f00\u53d1"})}),"\n",(0,r.jsx)(n.p,{children:"\u672c\u6587\u4ecb\u7ecd\u4f7f\u7528 Rust \u6784\u5efa Web \u540e\u7aef\u670d\u52a1\uff0c\u91cd\u70b9\u8bb2\u89e3 Axum \u6846\u67b6\u53ca\u5176\u751f\u6001\u7cfb\u7edf\u3002"}),"\n",(0,r.jsx)(n.h2,{id:"axum-\u7b80\u4ecb",children:"Axum \u7b80\u4ecb"}),"\n",(0,r.jsx)(n.p,{children:"Axum \u662f\u7531 Tokio \u56e2\u961f\u5f00\u53d1\u7684 Web \u6846\u67b6\uff0c\u7279\u70b9\uff1a"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"\u65e0\u5b8f\u8def\u7531"}),"\uff1a\u7c7b\u578b\u5b89\u5168\u7684\u8def\u7531\u5b9a\u4e49"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Tower \u751f\u6001"}),"\uff1a\u590d\u7528\u4e30\u5bcc\u7684\u4e2d\u95f4\u4ef6"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"\u63d0\u53d6\u5668\u6a21\u5f0f"}),"\uff1a\u58f0\u660e\u5f0f\u8bf7\u6c42\u89e3\u6790"]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-toml",children:'[dependencies]\naxum = "0.7"\ntokio = { version = "1", features = ["full"] }\nserde = { version = "1", features = ["derive"] }\ntower-http = { version = "0.5", features = ["cors", "trace"] }\n'})}),"\n",(0,r.jsx)(n.h2,{id:"\u5feb\u901f\u5f00\u59cb",children:"\u5feb\u901f\u5f00\u59cb"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-rust",children:'use axum::{routing::get, Router};\n\n#[tokio::main]\nasync fn main() {\n    let app = Router::new()\n        .route("/", get(|| async { "Hello, World!" }));\n\n    let listener = tokio::net::TcpListener::bind("0.0.0.0:3000").await.unwrap();\n    axum::serve(listener, app).await.unwrap();\n}\n'})}),"\n",(0,r.jsx)(n.h2,{id:"\u8def\u7531",children:"\u8def\u7531"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-rust",children:'use axum::{routing::{get, post}, Router};\n\n// \u57fa\u7840\u8def\u7531\nlet app = Router::new()\n    .route("/users", get(list_users).post(create_user))\n    .route("/users/:id", get(get_user));\n\n// \u8def\u7531\u5d4c\u5957\nlet api_routes = Router::new()\n    .nest("/users", user_routes)\n    .nest("/posts", post_routes);\n\nlet app = Router::new().nest("/api/v1", api_routes);\n'})}),"\n",(0,r.jsx)(n.h2,{id:"\u63d0\u53d6\u5668",children:"\u63d0\u53d6\u5668"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-rust",children:'use axum::extract::{Path, Query, State, Json};\nuse serde::Deserialize;\n\n// \u8def\u5f84\u53c2\u6570\nasync fn get_user(Path(id): Path<u64>) -> String {\n    format!("User {}", id)\n}\n\n// \u67e5\u8be2\u53c2\u6570\n#[derive(Deserialize)]\nstruct Pagination {\n    page: Option<u32>,\n}\n\nasync fn list_items(Query(pagination): Query<Pagination>) -> String {\n    format!("Page {}", pagination.page.unwrap_or(1))\n}\n\n// JSON \u8bf7\u6c42\u4f53\nasync fn create_item(Json(payload): Json<CreateItem>) -> Json<Item> {\n    // ...\n}\n'})}),"\n",(0,r.jsx)(n.h3,{id:"\u81ea\u5b9a\u4e49\u63d0\u53d6\u5668",children:"\u81ea\u5b9a\u4e49\u63d0\u53d6\u5668"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-rust",children:'use axum::{async_trait, extract::FromRequestParts, http::{request::Parts, StatusCode}};\n\nstruct AuthUser { user_id: u64 }\n\n#[async_trait]\nimpl<S: Send + Sync> FromRequestParts<S> for AuthUser {\n    type Rejection = StatusCode;\n\n    async fn from_request_parts(parts: &mut Parts, _: &S) -> Result<Self, Self::Rejection> {\n        let header = parts.headers.get("Authorization")\n            .and_then(|v| v.to_str().ok())\n            .ok_or(StatusCode::UNAUTHORIZED)?;\n\n        let user_id = validate_token(header).map_err(|_| StatusCode::UNAUTHORIZED)?;\n        Ok(AuthUser { user_id })\n    }\n}\n'})}),"\n",(0,r.jsx)(n.h2,{id:"\u4e2d\u95f4\u4ef6",children:"\u4e2d\u95f4\u4ef6"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-rust",children:'use tower_http::{cors::CorsLayer, trace::TraceLayer, timeout::TimeoutLayer};\nuse std::time::Duration;\n\nlet app = Router::new()\n    .route("/", get(handler))\n    .layer(TraceLayer::new_for_http())\n    .layer(CorsLayer::permissive())\n    .layer(TimeoutLayer::new(Duration::from_secs(30)));\n'})}),"\n",(0,r.jsx)(n.h3,{id:"\u81ea\u5b9a\u4e49\u4e2d\u95f4\u4ef6",children:"\u81ea\u5b9a\u4e49\u4e2d\u95f4\u4ef6"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-rust",children:"use axum::{middleware::{self, Next}, extract::Request, response::Response};\n\nasync fn logging_middleware(request: Request, next: Next) -> Response {\n    let method = request.method().clone();\n    let uri = request.uri().clone();\n    let start = std::time::Instant::now();\n\n    let response = next.run(request).await;\n\n    tracing::info!(%method, %uri, status = %response.status(), duration = ?start.elapsed());\n    response\n}\n\nlet app = Router::new()\n    .layer(middleware::from_fn(logging_middleware));\n"})}),"\n",(0,r.jsx)(n.h2,{id:"sqlx-\u6570\u636e\u5e93",children:"SQLx \u6570\u636e\u5e93"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-toml",children:'[dependencies]\nsqlx = { version = "0.7", features = ["runtime-tokio", "postgres"] }\n'})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-rust",children:'use sqlx::{PgPool, FromRow};\n\n#[derive(FromRow, Serialize)]\nstruct User { id: i64, name: String, email: String }\n\nasync fn list_users(State(pool): State<PgPool>) -> Result<Json<Vec<User>>, StatusCode> {\n    let users = sqlx::query_as::<_, User>("SELECT * FROM users")\n        .fetch_all(&pool)\n        .await\n        .map_err(|_| StatusCode::INTERNAL_SERVER_ERROR)?;\n    Ok(Json(users))\n}\n\nasync fn create_user(State(pool): State<PgPool>, Json(payload): Json<CreateUser>) -> Result<Json<User>, StatusCode> {\n    let user = sqlx::query_as::<_, User>(\n        "INSERT INTO users (name, email) VALUES ($1, $2) RETURNING *"\n    )\n    .bind(&payload.name)\n    .bind(&payload.email)\n    .fetch_one(&pool)\n    .await\n    .map_err(|_| StatusCode::INTERNAL_SERVER_ERROR)?;\n    Ok(Json(user))\n}\n'})}),"\n",(0,r.jsx)(n.h2,{id:"redis-\u96c6\u6210",children:"Redis \u96c6\u6210"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-rust",children:'use deadpool_redis::{Config, Runtime, Pool};\nuse redis::AsyncCommands;\n\nasync fn cache_user(State(pool): State<Pool>, Path(id): Path<u64>, Json(user): Json<User>) -> Result<StatusCode, StatusCode> {\n    let mut conn = pool.get().await.map_err(|_| StatusCode::INTERNAL_SERVER_ERROR)?;\n    let key = format!("user:{}", id);\n    let value = serde_json::to_string(&user).unwrap();\n    conn.set_ex::<_, _, ()>(&key, &value, 3600).await.map_err(|_| StatusCode::INTERNAL_SERVER_ERROR)?;\n    Ok(StatusCode::OK)\n}\n'})}),"\n",(0,r.jsx)(n.h2,{id:"jwt-\u8ba4\u8bc1",children:"JWT \u8ba4\u8bc1"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-rust",children:'use jsonwebtoken::{encode, decode, Header, EncodingKey, DecodingKey, Validation};\n\n#[derive(Serialize, Deserialize)]\nstruct Claims { sub: String, exp: usize }\n\nfn create_token(user_id: &str) -> Result<String, jsonwebtoken::errors::Error> {\n    let claims = Claims {\n        sub: user_id.to_string(),\n        exp: (chrono::Utc::now() + chrono::Duration::hours(24)).timestamp() as usize,\n    };\n    encode(&Header::default(), &claims, &EncodingKey::from_secret(b"secret"))\n}\n\nfn verify_token(token: &str) -> Result<Claims, jsonwebtoken::errors::Error> {\n    let data = decode::<Claims>(token, &DecodingKey::from_secret(b"secret"), &Validation::default())?;\n    Ok(data.claims)\n}\n'})}),"\n",(0,r.jsx)(n.h2,{id:"\u9519\u8bef\u5904\u7406",children:"\u9519\u8bef\u5904\u7406"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-rust",children:'use axum::{response::{IntoResponse, Response}, http::StatusCode, Json};\n\nenum AppError {\n    NotFound,\n    BadRequest(String),\n    InternalError(anyhow::Error),\n}\n\nimpl IntoResponse for AppError {\n    fn into_response(self) -> Response {\n        let (status, message) = match self {\n            AppError::NotFound => (StatusCode::NOT_FOUND, "Not found"),\n            AppError::BadRequest(msg) => (StatusCode::BAD_REQUEST, msg.as_str()),\n            AppError::InternalError(_) => (StatusCode::INTERNAL_SERVER_ERROR, "Internal error"),\n        };\n        (status, Json(serde_json::json!({"error": message}))).into_response()\n    }\n}\n'})}),"\n",(0,r.jsx)(n.h2,{id:"\u9879\u76ee\u7ed3\u6784",children:"\u9879\u76ee\u7ed3\u6784"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"web-api/\n\u251c\u2500\u2500 src/\n\u2502   \u251c\u2500\u2500 main.rs\n\u2502   \u251c\u2500\u2500 config.rs\n\u2502   \u251c\u2500\u2500 error.rs\n\u2502   \u251c\u2500\u2500 routes/\n\u2502   \u2502   \u251c\u2500\u2500 mod.rs\n\u2502   \u2502   \u2514\u2500\u2500 users.rs\n\u2502   \u251c\u2500\u2500 middleware/\n\u2502   \u251c\u2500\u2500 models/\n\u2502   \u2514\u2500\u2500 db/\n\u251c\u2500\u2500 migrations/\n\u2514\u2500\u2500 tests/\n"})}),"\n",(0,r.jsx)(n.h2,{id:"\u6700\u4f73\u5b9e\u8df5",children:"\u6700\u4f73\u5b9e\u8df5"}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"\u65b9\u9762"}),(0,r.jsx)(n.th,{children:"\u5efa\u8bae"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"\u67b6\u6784"}),(0,r.jsx)(n.td,{children:"routes \u2192 services \u2192 repositories"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"\u72b6\u6001"}),(0,r.jsxs)(n.td,{children:[(0,r.jsx)(n.code,{children:"Arc<RwLock<T>>"})," \u6216\u8fde\u63a5\u6c60"]})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"\u9519\u8bef"}),(0,r.jsxs)(n.td,{children:["\u81ea\u5b9a\u4e49\u9519\u8bef\u5b9e\u73b0 ",(0,r.jsx)(n.code,{children:"IntoResponse"})]})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"\u8ba4\u8bc1"}),(0,r.jsx)(n.td,{children:"\u81ea\u5b9a\u4e49\u63d0\u53d6\u5668 + \u4e2d\u95f4\u4ef6"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"\u6570\u636e\u5e93"}),(0,r.jsx)(n.td,{children:"SQLx \u7f16\u8bd1\u65f6\u68c0\u67e5"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"\u65e5\u5fd7"}),(0,r.jsx)(n.td,{children:"tracing + TraceLayer"})]})]})]})]})}function c(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(u,{...e})}):u(e)}}}]);