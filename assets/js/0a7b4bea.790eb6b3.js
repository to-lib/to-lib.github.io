"use strict";(globalThis.webpackChunkto_lib_github_io=globalThis.webpackChunkto_lib_github_io||[]).push([[6093],{27825:(n,e,s)=>{s.r(e),s.d(e,{assets:()=>o,contentTitle:()=>a,default:()=>h,frontMatter:()=>l,metadata:()=>t,toc:()=>d});const t=JSON.parse('{"id":"postgres/high-availability","title":"\u9ad8\u53ef\u7528\u67b6\u6784","description":"\u9ad8\u53ef\u7528\uff08High Availability\uff09\u786e\u4fdd\u6570\u636e\u5e93\u670d\u52a1\u5728\u6545\u969c\u65f6\u80fd\u591f\u5feb\u901f\u6062\u590d\uff0c\u6700\u5927\u9650\u5ea6\u51cf\u5c11\u505c\u673a\u65f6\u95f4\u3002","source":"@site/docs/postgres/high-availability.md","sourceDirName":"postgres","slug":"/postgres/high-availability","permalink":"/docs/postgres/high-availability","draft":false,"unlisted":false,"editUrl":"https://github.com/to-lib/to-lib.github.io/tree/main/docs/postgres/high-availability.md","tags":[],"version":"current","sidebarPosition":13,"frontMatter":{"sidebar_position":13,"title":"\u9ad8\u53ef\u7528\u67b6\u6784"},"sidebar":"postgres","previous":{"title":"\u4e3b\u4ece\u590d\u5236","permalink":"/docs/postgres/replication"},"next":{"title":"\u5907\u4efd\u4e0e\u6062\u590d","permalink":"/docs/postgres/backup-recovery"}}');var r=s(22714),i=s(48885);const l={sidebar_position:13,title:"\u9ad8\u53ef\u7528\u67b6\u6784"},a="PostgreSQL \u9ad8\u53ef\u7528\u67b6\u6784",o={},d=[{value:"\ud83d\udcda \u9ad8\u53ef\u7528\u65b9\u6848\u5bf9\u6bd4",id:"-\u9ad8\u53ef\u7528\u65b9\u6848\u5bf9\u6bd4",level:2},{value:"\ud83c\udfc6 Patroni + etcd\uff08\u63a8\u8350\u65b9\u6848\uff09",id:"-patroni--etcd\u63a8\u8350\u65b9\u6848",level:2},{value:"\u67b6\u6784\u56fe",id:"\u67b6\u6784\u56fe",level:3},{value:"1. \u5b89\u88c5 etcd",id:"1-\u5b89\u88c5-etcd",level:3},{value:"2. \u5b89\u88c5 Patroni",id:"2-\u5b89\u88c5-patroni",level:3},{value:"3. \u914d\u7f6e Patroni",id:"3-\u914d\u7f6e-patroni",level:3},{value:"4. \u542f\u52a8 Patroni",id:"4-\u542f\u52a8-patroni",level:3},{value:"5. Patroni \u5e38\u7528\u547d\u4ee4",id:"5-patroni-\u5e38\u7528\u547d\u4ee4",level:3},{value:"\ud83d\udd04 HAProxy \u914d\u7f6e",id:"-haproxy-\u914d\u7f6e",level:2},{value:"haproxy.cfg",id:"haproxycfg",level:3},{value:"\u5e94\u7528\u8fde\u63a5\u914d\u7f6e",id:"\u5e94\u7528\u8fde\u63a5\u914d\u7f6e",level:3},{value:"\ud83d\udd0c PgBouncer \u8fde\u63a5\u6c60",id:"-pgbouncer-\u8fde\u63a5\u6c60",level:2},{value:"pgbouncer.ini",id:"pgbouncerini",level:3},{value:"userlist.txt",id:"userlisttxt",level:3},{value:"\ud83d\udee1\ufe0f pg_auto_failover",id:"\ufe0f-pg_auto_failover",level:2},{value:"1. \u5b89\u88c5",id:"1-\u5b89\u88c5",level:3},{value:"2. \u521b\u5efa Monitor \u8282\u70b9",id:"2-\u521b\u5efa-monitor-\u8282\u70b9",level:3},{value:"3. \u521b\u5efa\u6570\u636e\u8282\u70b9",id:"3-\u521b\u5efa\u6570\u636e\u8282\u70b9",level:3},{value:"4. \u67e5\u770b\u72b6\u6001",id:"4-\u67e5\u770b\u72b6\u6001",level:3},{value:"\u2601\ufe0f \u4e91\u670d\u52a1\u9ad8\u53ef\u7528",id:"\ufe0f-\u4e91\u670d\u52a1\u9ad8\u53ef\u7528",level:2},{value:"AWS RDS",id:"aws-rds",level:3},{value:"Google Cloud SQL",id:"google-cloud-sql",level:3},{value:"Azure Database",id:"azure-database",level:3},{value:"\ud83d\udcca \u76d1\u63a7\u9ad8\u53ef\u7528",id:"-\u76d1\u63a7\u9ad8\u53ef\u7528",level:2},{value:"\u5173\u952e\u6307\u6807",id:"\u5173\u952e\u6307\u6807",level:3},{value:"\u544a\u8b66\u914d\u7f6e",id:"\u544a\u8b66\u914d\u7f6e",level:3},{value:"\ud83d\udca1 \u6700\u4f73\u5b9e\u8df5",id:"-\u6700\u4f73\u5b9e\u8df5",level:2},{value:"\ud83d\udcda \u76f8\u5173\u8d44\u6e90",id:"-\u76f8\u5173\u8d44\u6e90",level:2}];function c(n){const e={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,i.R)(),...n.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(e.header,{children:(0,r.jsx)(e.h1,{id:"postgresql-\u9ad8\u53ef\u7528\u67b6\u6784",children:"PostgreSQL \u9ad8\u53ef\u7528\u67b6\u6784"})}),"\n",(0,r.jsx)(e.p,{children:"\u9ad8\u53ef\u7528\uff08High Availability\uff09\u786e\u4fdd\u6570\u636e\u5e93\u670d\u52a1\u5728\u6545\u969c\u65f6\u80fd\u591f\u5feb\u901f\u6062\u590d\uff0c\u6700\u5927\u9650\u5ea6\u51cf\u5c11\u505c\u673a\u65f6\u95f4\u3002"}),"\n",(0,r.jsx)(e.h2,{id:"-\u9ad8\u53ef\u7528\u65b9\u6848\u5bf9\u6bd4",children:"\ud83d\udcda \u9ad8\u53ef\u7528\u65b9\u6848\u5bf9\u6bd4"}),"\n",(0,r.jsxs)(e.table,{children:[(0,r.jsx)(e.thead,{children:(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.th,{children:"\u65b9\u6848"}),(0,r.jsx)(e.th,{children:"\u81ea\u52a8\u6545\u969c\u8f6c\u79fb"}),(0,r.jsx)(e.th,{children:"\u590d\u6742\u5ea6"}),(0,r.jsx)(e.th,{children:"\u9002\u7528\u573a\u666f"})]})}),(0,r.jsxs)(e.tbody,{children:[(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:(0,r.jsx)(e.strong,{children:"Patroni + etcd"})}),(0,r.jsx)(e.td,{children:"\u2705"}),(0,r.jsx)(e.td,{children:"\u4e2d"}),(0,r.jsx)(e.td,{children:"\u751f\u4ea7\u73af\u5883\u9996\u9009"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:(0,r.jsx)(e.strong,{children:"Repmgr"})}),(0,r.jsx)(e.td,{children:"\u2705"}),(0,r.jsx)(e.td,{children:"\u4e2d"}),(0,r.jsx)(e.td,{children:"\u4f20\u7edf\u65b9\u6848"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:(0,r.jsx)(e.strong,{children:"pg_auto_failover"})}),(0,r.jsx)(e.td,{children:"\u2705"}),(0,r.jsx)(e.td,{children:"\u4f4e"}),(0,r.jsx)(e.td,{children:"\u7b80\u5355\u573a\u666f"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:(0,r.jsx)(e.strong,{children:"PgPool-II"})}),(0,r.jsx)(e.td,{children:"\u2705"}),(0,r.jsx)(e.td,{children:"\u9ad8"}),(0,r.jsx)(e.td,{children:"\u9700\u8981\u8fde\u63a5\u6c60"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:(0,r.jsx)(e.strong,{children:"Cloud Managed"})}),(0,r.jsx)(e.td,{children:"\u2705"}),(0,r.jsx)(e.td,{children:"\u4f4e"}),(0,r.jsx)(e.td,{children:"\u4e91\u73af\u5883"})]})]})]}),"\n",(0,r.jsx)(e.h2,{id:"-patroni--etcd\u63a8\u8350\u65b9\u6848",children:"\ud83c\udfc6 Patroni + etcd\uff08\u63a8\u8350\u65b9\u6848\uff09"}),"\n",(0,r.jsx)(e.p,{children:"Patroni \u662f\u76ee\u524d\u6700\u6d41\u884c\u7684 PostgreSQL \u9ad8\u53ef\u7528\u65b9\u6848\uff0c\u7531 Zalando \u5f00\u53d1\u3002"}),"\n",(0,r.jsx)(e.h3,{id:"\u67b6\u6784\u56fe",children:"\u67b6\u6784\u56fe"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{children:"                    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n                    \u2502   HAProxy   \u2502\n                    \u2502 (\u8d1f\u8f7d\u5747\u8861)   \u2502\n                    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                           \u2502\n         \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n         \u2502                 \u2502                 \u2502\n    \u250c\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2510       \u250c\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2510       \u250c\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2510\n    \u2502 Patroni \u2502       \u2502 Patroni \u2502       \u2502 Patroni \u2502\n    \u2502  Node1  \u2502       \u2502  Node2  \u2502       \u2502  Node3  \u2502\n    \u2502 (Leader)\u2502       \u2502(Replica)\u2502       \u2502(Replica)\u2502\n    \u2514\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2518       \u2514\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2518       \u2514\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2518\n         \u2502                 \u2502                 \u2502\n         \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                           \u2502\n                    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n                    \u2502    etcd     \u2502\n                    \u2502  (\u5206\u5e03\u5f0fKV) \u2502\n                    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"})}),"\n",(0,r.jsx)(e.h3,{id:"1-\u5b89\u88c5-etcd",children:"1. \u5b89\u88c5 etcd"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-bash",children:"# Ubuntu/Debian\nsudo apt-get install etcd\n\n# \u914d\u7f6e etcd \u96c6\u7fa4\ncat > /etc/etcd/etcd.conf.yml << EOF\nname: etcd1\ndata-dir: /var/lib/etcd\nlisten-peer-urls: http://10.0.0.1:2380\nlisten-client-urls: http://10.0.0.1:2379,http://127.0.0.1:2379\nadvertise-client-urls: http://10.0.0.1:2379\ninitial-advertise-peer-urls: http://10.0.0.1:2380\ninitial-cluster: etcd1=http://10.0.0.1:2380,etcd2=http://10.0.0.2:2380,etcd3=http://10.0.0.3:2380\ninitial-cluster-token: etcd-cluster-1\ninitial-cluster-state: new\nEOF\n\nsudo systemctl start etcd\n"})}),"\n",(0,r.jsx)(e.h3,{id:"2-\u5b89\u88c5-patroni",children:"2. \u5b89\u88c5 Patroni"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-bash",children:"# \u5b89\u88c5\npip3 install patroni[etcd]\n\n# \u6216\u4f7f\u7528\u7cfb\u7edf\u5305\nsudo apt-get install patroni\n"})}),"\n",(0,r.jsx)(e.h3,{id:"3-\u914d\u7f6e-patroni",children:"3. \u914d\u7f6e Patroni"}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"patroni.yml\uff1a"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-yaml",children:'scope: postgres-cluster\nname: node1\n\nrestapi:\n  listen: 0.0.0.0:8008\n  connect_address: 10.0.0.1:8008\n\netcd:\n  hosts:\n    - 10.0.0.1:2379\n    - 10.0.0.2:2379\n    - 10.0.0.3:2379\n\nbootstrap:\n  dcs:\n    ttl: 30\n    loop_wait: 10\n    retry_timeout: 10\n    maximum_lag_on_failover: 1048576\n    postgresql:\n      use_pg_rewind: true\n      use_slots: true\n      parameters:\n        wal_level: replica\n        hot_standby: on\n        max_connections: 200\n        max_wal_senders: 10\n        max_replication_slots: 10\n        wal_keep_size: 1024\n\n  initdb:\n    - encoding: UTF8\n    - data-checksums\n\n  pg_hba:\n    - host replication replicator 10.0.0.0/24 md5\n    - host all all 10.0.0.0/24 md5\n\n  users:\n    admin:\n      password: admin_password\n      options:\n        - createrole\n        - createdb\n    replicator:\n      password: replicator_password\n      options:\n        - replication\n\npostgresql:\n  listen: 0.0.0.0:5432\n  connect_address: 10.0.0.1:5432\n  data_dir: /var/lib/postgresql/16/main\n  bin_dir: /usr/lib/postgresql/16/bin\n\n  authentication:\n    replication:\n      username: replicator\n      password: replicator_password\n    superuser:\n      username: postgres\n      password: postgres_password\n    rewind:\n      username: postgres\n      password: postgres_password\n\n  parameters:\n    unix_socket_directories: "/var/run/postgresql"\n\ntags:\n  nofailover: false\n  noloadbalance: false\n  clonefrom: false\n  nosync: false\n'})}),"\n",(0,r.jsx)(e.h3,{id:"4-\u542f\u52a8-patroni",children:"4. \u542f\u52a8 Patroni"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-bash",children:"# \u4f7f\u7528 systemd\nsudo systemctl start patroni\n\n# \u67e5\u770b\u96c6\u7fa4\u72b6\u6001\npatronictl -c /etc/patroni/patroni.yml list\n"})}),"\n",(0,r.jsx)(e.h3,{id:"5-patroni-\u5e38\u7528\u547d\u4ee4",children:"5. Patroni \u5e38\u7528\u547d\u4ee4"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-bash",children:"# \u67e5\u770b\u96c6\u7fa4\u72b6\u6001\npatronictl -c patroni.yml list\n\n# \u624b\u52a8\u5207\u6362\u4e3b\u5e93\npatronictl -c patroni.yml switchover\n\n# \u5f3a\u5236\u6545\u969c\u8f6c\u79fb\npatronictl -c patroni.yml failover\n\n# \u91cd\u65b0\u521d\u59cb\u5316\u8282\u70b9\npatronictl -c patroni.yml reinit node2\n\n# \u6682\u505c\u81ea\u52a8\u6545\u969c\u8f6c\u79fb\npatronictl -c patroni.yml pause\n\n# \u6062\u590d\u81ea\u52a8\u6545\u969c\u8f6c\u79fb\npatronictl -c patroni.yml resume\n"})}),"\n",(0,r.jsx)(e.h2,{id:"-haproxy-\u914d\u7f6e",children:"\ud83d\udd04 HAProxy \u914d\u7f6e"}),"\n",(0,r.jsx)(e.p,{children:"HAProxy \u63d0\u4f9b\u8d1f\u8f7d\u5747\u8861\u548c\u81ea\u52a8\u8def\u7531\u3002"}),"\n",(0,r.jsx)(e.h3,{id:"haproxycfg",children:"haproxy.cfg"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-conf",children:"global\n    maxconn 1000\n\ndefaults\n    mode tcp\n    timeout connect 10s\n    timeout client 30s\n    timeout server 30s\n\nlisten stats\n    bind *:7000\n    mode http\n    stats enable\n    stats uri /\n\n# \u4e3b\u5e93\uff08\u5199\u64cd\u4f5c\uff09\nlisten postgres-primary\n    bind *:5000\n    option httpchk GET /master\n    http-check expect status 200\n    default-server inter 3s fall 3 rise 2\n    server node1 10.0.0.1:5432 check port 8008\n    server node2 10.0.0.2:5432 check port 8008\n    server node3 10.0.0.3:5432 check port 8008\n\n# \u4ece\u5e93\uff08\u8bfb\u64cd\u4f5c\uff09\nlisten postgres-replica\n    bind *:5001\n    balance roundrobin\n    option httpchk GET /replica\n    http-check expect status 200\n    default-server inter 3s fall 3 rise 2\n    server node1 10.0.0.1:5432 check port 8008\n    server node2 10.0.0.2:5432 check port 8008\n    server node3 10.0.0.3:5432 check port 8008\n"})}),"\n",(0,r.jsx)(e.h3,{id:"\u5e94\u7528\u8fde\u63a5\u914d\u7f6e",children:"\u5e94\u7528\u8fde\u63a5\u914d\u7f6e"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{children:"# \u5199\u64cd\u4f5c\u8fde\u63a5\u4e3b\u5e93\npostgresql://user:pass@haproxy:5000/dbname\n\n# \u8bfb\u64cd\u4f5c\u8fde\u63a5\u4ece\u5e93\npostgresql://user:pass@haproxy:5001/dbname\n"})}),"\n",(0,r.jsx)(e.h2,{id:"-pgbouncer-\u8fde\u63a5\u6c60",children:"\ud83d\udd0c PgBouncer \u8fde\u63a5\u6c60"}),"\n",(0,r.jsx)(e.p,{children:"PgBouncer \u51cf\u5c11\u6570\u636e\u5e93\u8fde\u63a5\u5f00\u9500\u3002"}),"\n",(0,r.jsx)(e.h3,{id:"pgbouncerini",children:"pgbouncer.ini"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-ini",children:"[databases]\nmydb = host=127.0.0.1 port=5432 dbname=mydb\n\n[pgbouncer]\nlisten_addr = 0.0.0.0\nlisten_port = 6432\nauth_type = md5\nauth_file = /etc/pgbouncer/userlist.txt\npool_mode = transaction\nmax_client_conn = 1000\ndefault_pool_size = 25\nmin_pool_size = 5\nreserve_pool_size = 5\n"})}),"\n",(0,r.jsx)(e.h3,{id:"userlisttxt",children:"userlist.txt"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{children:'"postgres" "md5password_hash"\n"myuser" "md5password_hash"\n'})}),"\n",(0,r.jsx)(e.p,{children:"\u751f\u6210\u5bc6\u7801\u54c8\u5e0c\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-bash",children:'echo -n "passwordusername" | md5sum | awk \'{print "md5" $1}\'\n'})}),"\n",(0,r.jsx)(e.h2,{id:"\ufe0f-pg_auto_failover",children:"\ud83d\udee1\ufe0f pg_auto_failover"}),"\n",(0,r.jsx)(e.p,{children:"Citus \u63d0\u4f9b\u7684\u7b80\u5355\u9ad8\u53ef\u7528\u65b9\u6848\u3002"}),"\n",(0,r.jsx)(e.h3,{id:"1-\u5b89\u88c5",children:"1. \u5b89\u88c5"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-bash",children:"# \u6dfb\u52a0\u4ed3\u5e93\ncurl https://install.citusdata.com/community/deb.sh | sudo bash\n\n# \u5b89\u88c5\nsudo apt-get install postgresql-16-auto-failover\n"})}),"\n",(0,r.jsx)(e.h3,{id:"2-\u521b\u5efa-monitor-\u8282\u70b9",children:"2. \u521b\u5efa Monitor \u8282\u70b9"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-bash",children:"pg_autoctl create monitor \\\n    --pgdata /var/lib/postgresql/monitor \\\n    --hostname monitor.example.com\n"})}),"\n",(0,r.jsx)(e.h3,{id:"3-\u521b\u5efa\u6570\u636e\u8282\u70b9",children:"3. \u521b\u5efa\u6570\u636e\u8282\u70b9"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-bash",children:"# \u4e3b\u8282\u70b9\npg_autoctl create postgres \\\n    --pgdata /var/lib/postgresql/data \\\n    --hostname node1.example.com \\\n    --monitor postgres://autoctl_node@monitor.example.com/pg_auto_failover\n\n# \u4ece\u8282\u70b9\npg_autoctl create postgres \\\n    --pgdata /var/lib/postgresql/data \\\n    --hostname node2.example.com \\\n    --monitor postgres://autoctl_node@monitor.example.com/pg_auto_failover\n"})}),"\n",(0,r.jsx)(e.h3,{id:"4-\u67e5\u770b\u72b6\u6001",children:"4. \u67e5\u770b\u72b6\u6001"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-bash",children:"pg_autoctl show state\npg_autoctl show events\n"})}),"\n",(0,r.jsx)(e.h2,{id:"\ufe0f-\u4e91\u670d\u52a1\u9ad8\u53ef\u7528",children:"\u2601\ufe0f \u4e91\u670d\u52a1\u9ad8\u53ef\u7528"}),"\n",(0,r.jsx)(e.h3,{id:"aws-rds",children:"AWS RDS"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.strong,{children:"Multi-AZ \u90e8\u7f72"}),"\uff1a\u81ea\u52a8\u6545\u969c\u8f6c\u79fb"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.strong,{children:"Read Replicas"}),"\uff1a\u8bfb\u5199\u5206\u79bb"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.strong,{children:"\u81ea\u52a8\u5907\u4efd"}),"\uff1a\u65f6\u95f4\u70b9\u6062\u590d"]}),"\n"]}),"\n",(0,r.jsx)(e.h3,{id:"google-cloud-sql",children:"Google Cloud SQL"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.strong,{children:"\u9ad8\u53ef\u7528\u914d\u7f6e"}),"\uff1a\u81ea\u52a8\u6545\u969c\u8f6c\u79fb"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.strong,{children:"\u8bfb\u53d6\u526f\u672c"}),"\uff1a\u8de8\u533a\u57df\u590d\u5236"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.strong,{children:"\u81ea\u52a8\u5907\u4efd"}),"\uff1a7 \u5929\u4fdd\u7559"]}),"\n"]}),"\n",(0,r.jsx)(e.h3,{id:"azure-database",children:"Azure Database"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.strong,{children:"\u533a\u57df\u5197\u4f59"}),"\uff1a\u9ad8\u53ef\u7528"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.strong,{children:"\u53ea\u8bfb\u526f\u672c"}),"\uff1a\u6700\u591a 5 \u4e2a"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.strong,{children:"\u81ea\u52a8\u5907\u4efd"}),"\uff1a35 \u5929\u4fdd\u7559"]}),"\n"]}),"\n",(0,r.jsx)(e.h2,{id:"-\u76d1\u63a7\u9ad8\u53ef\u7528",children:"\ud83d\udcca \u76d1\u63a7\u9ad8\u53ef\u7528"}),"\n",(0,r.jsx)(e.h3,{id:"\u5173\u952e\u6307\u6807",children:"\u5173\u952e\u6307\u6807"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-sql",children:"-- \u590d\u5236\u5ef6\u8fdf\nSELECT client_addr,\n       pg_wal_lsn_diff(sent_lsn, replay_lsn) AS lag_bytes,\n       EXTRACT(EPOCH FROM (now() - replay_lag)) AS lag_seconds\nFROM pg_stat_replication;\n\n-- \u8fde\u63a5\u6570\nSELECT count(*) FROM pg_stat_activity;\n\n-- \u957f\u4e8b\u52a1\nSELECT pid, now() - xact_start AS duration, query\nFROM pg_stat_activity\nWHERE state = 'active'\n  AND xact_start < now() - interval '5 minutes';\n"})}),"\n",(0,r.jsx)(e.h3,{id:"\u544a\u8b66\u914d\u7f6e",children:"\u544a\u8b66\u914d\u7f6e"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u590d\u5236\u5ef6\u8fdf > 30 \u79d2"}),"\n",(0,r.jsx)(e.li,{children:"\u8fde\u63a5\u6570 > 80%"}),"\n",(0,r.jsx)(e.li,{children:"\u4e3b\u5e93\u4e0d\u53ef\u7528"}),"\n",(0,r.jsx)(e.li,{children:"\u4ece\u5e93\u6570\u91cf\u51cf\u5c11"}),"\n"]}),"\n",(0,r.jsx)(e.h2,{id:"-\u6700\u4f73\u5b9e\u8df5",children:"\ud83d\udca1 \u6700\u4f73\u5b9e\u8df5"}),"\n",(0,r.jsxs)(e.ol,{children:["\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.strong,{children:"\u81f3\u5c11 3 \u4e2a\u8282\u70b9"}),"\uff1a\u907f\u514d\u8111\u88c2"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.strong,{children:"\u8de8\u53ef\u7528\u533a\u90e8\u7f72"}),"\uff1a\u63d0\u9ad8\u5bb9\u707e\u80fd\u529b"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.strong,{children:"\u5b9a\u671f\u6545\u969c\u8f6c\u79fb\u6f14\u7ec3"}),"\uff1a\u786e\u4fdd\u6d41\u7a0b\u6709\u6548"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.strong,{children:"\u76d1\u63a7\u590d\u5236\u5ef6\u8fdf"}),"\uff1a\u53ca\u65f6\u53d1\u73b0\u95ee\u9898"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.strong,{children:"\u4f7f\u7528\u8fde\u63a5\u6c60"}),"\uff1a\u51cf\u5c11\u8fde\u63a5\u5f00\u9500"]}),"\n"]}),"\n",(0,r.jsx)(e.h2,{id:"-\u76f8\u5173\u8d44\u6e90",children:"\ud83d\udcda \u76f8\u5173\u8d44\u6e90"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.a,{href:"/docs/postgres/replication",children:"\u4e3b\u4ece\u590d\u5236"})," - \u590d\u5236\u914d\u7f6e\u8be6\u89e3"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.a,{href:"/docs/postgres/backup-recovery",children:"\u5907\u4efd\u6062\u590d"})," - \u6570\u636e\u5907\u4efd\u7b56\u7565"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.a,{href:"/docs/postgres/performance-optimization",children:"\u6027\u80fd\u4f18\u5316"})," - \u6027\u80fd\u8c03\u4f18"]}),"\n"]})]})}function h(n={}){const{wrapper:e}={...(0,i.R)(),...n.components};return e?(0,r.jsx)(e,{...n,children:(0,r.jsx)(c,{...n})}):c(n)}},48885:(n,e,s)=>{s.d(e,{R:()=>l,x:()=>a});var t=s(99378);const r={},i=t.createContext(r);function l(n){const e=t.useContext(i);return t.useMemo(function(){return"function"==typeof n?n(e):{...e,...n}},[e,n])}function a(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(r):n.components||r:l(n.components),t.createElement(i.Provider,{value:e},n.children)}}}]);