"use strict";(globalThis.webpackChunkto_lib_github_io=globalThis.webpackChunkto_lib_github_io||[]).push([[7993],{1266:(e,n,t)=>{t.d(n,{R:()=>a,x:()=>i});var r=t(9378);const l={},d=r.createContext(l);function a(e){const n=r.useContext(d);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function i(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(l):e.components||l:a(e.components),r.createElement(d.Provider,{value:n},e.children)}},8347:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>s,contentTitle:()=>i,default:()=>o,frontMatter:()=>a,metadata:()=>r,toc:()=>u});const r=JSON.parse('{"id":"netty/bytebuf","title":"ByteBuf \u8be6\u89e3","description":"ByteBuf \u6982\u8ff0","source":"@site/docs/netty/bytebuf.md","sourceDirName":"netty","slug":"/netty/bytebuf","permalink":"/docs/netty/bytebuf","draft":false,"unlisted":false,"editUrl":"https://github.com/to-lib/to-lib.github.io/tree/main/docs/netty/bytebuf.md","tags":[],"version":"current","sidebarPosition":4,"frontMatter":{"sidebar_position":4},"sidebar":"netty","previous":{"title":"\u6838\u5fc3\u7ec4\u4ef6\u8be6\u89e3","permalink":"/docs/netty/core-components"},"next":{"title":"\u7f16\u7801\u4e0e\u89e3\u7801","permalink":"/docs/netty/codec"}}');var l=t(2714),d=t(1266);const a={sidebar_position:4},i="ByteBuf \u8be6\u89e3",s={},u=[{value:"ByteBuf \u6982\u8ff0",id:"bytebuf-\u6982\u8ff0",level:2},{value:"ByteBuf vs ByteBuffer",id:"bytebuf-vs-bytebuffer",level:3},{value:"ByteBuf \u7ed3\u6784",id:"bytebuf-\u7ed3\u6784",level:2},{value:"\u521b\u5efa ByteBuf",id:"\u521b\u5efa-bytebuf",level:3},{value:"\u8bfb\u5199\u64cd\u4f5c",id:"\u8bfb\u5199\u64cd\u4f5c",level:2},{value:"\u57fa\u672c\u8bfb\u5199",id:"\u57fa\u672c\u8bfb\u5199",level:3},{value:"\u8bfb\u53d6\u65b9\u5f0f\u5bf9\u6bd4",id:"\u8bfb\u53d6\u65b9\u5f0f\u5bf9\u6bd4",level:3},{value:"\u5185\u5b58\u5206\u914d\u65b9\u5f0f",id:"\u5185\u5b58\u5206\u914d\u65b9\u5f0f",level:2},{value:"Heap Buffer\uff08\u5806\u5185\u5b58\uff09",id:"heap-buffer\u5806\u5185\u5b58",level:3},{value:"Direct Buffer\uff08\u76f4\u63a5\u5185\u5b58\uff09",id:"direct-buffer\u76f4\u63a5\u5185\u5b58",level:3},{value:"\u5f15\u7528\u8ba1\u6570\u548c\u8d44\u6e90\u91ca\u653e",id:"\u5f15\u7528\u8ba1\u6570\u548c\u8d44\u6e90\u91ca\u653e",level:2},{value:"Handler \u4e2d\u7684\u8d44\u6e90\u7ba1\u7406",id:"handler-\u4e2d\u7684\u8d44\u6e90\u7ba1\u7406",level:3},{value:"\u96f6\u62f7\u8d1d\u64cd\u4f5c",id:"\u96f6\u62f7\u8d1d\u64cd\u4f5c",level:2},{value:"CompositeByteBuf",id:"compositebytebuf",level:3},{value:"Slice\uff08\u5207\u7247\uff09",id:"slice\u5207\u7247",level:3},{value:"Duplicate\uff08\u590d\u5236\u5f15\u7528\uff09",id:"duplicate\u590d\u5236\u5f15\u7528",level:3},{value:"ByteBuf \u5206\u914d\u5668",id:"bytebuf-\u5206\u914d\u5668",level:2},{value:"PooledByteBufAllocator\uff08\u63a8\u8350\uff09",id:"pooledbytebufallocator\u63a8\u8350",level:3},{value:"UnpooledByteBufAllocator",id:"unpooledbytebufallocator",level:3},{value:"\u6700\u4f73\u5b9e\u8df5",id:"\u6700\u4f73\u5b9e\u8df5",level:2},{value:"\u5e38\u7528\u5de5\u5177\u7c7b",id:"\u5e38\u7528\u5de5\u5177\u7c7b",level:2}];function c(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",...(0,d.R)(),...e.components};return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(n.header,{children:(0,l.jsx)(n.h1,{id:"bytebuf-\u8be6\u89e3",children:"ByteBuf \u8be6\u89e3"})}),"\n",(0,l.jsx)(n.h2,{id:"bytebuf-\u6982\u8ff0",children:"ByteBuf \u6982\u8ff0"}),"\n",(0,l.jsx)(n.p,{children:"ByteBuf \u662f Netty \u7684\u6838\u5fc3\u6570\u636e\u7ed3\u6784\uff0c\u7528\u4e8e\u66ff\u4ee3 Java NIO \u7684 ByteBuffer\uff0c\u63d0\u4f9b\u66f4\u9ad8\u6548\u548c\u6613\u7528\u7684\u5b57\u8282\u7f13\u51b2\u533a\u3002"}),"\n",(0,l.jsx)(n.h3,{id:"bytebuf-vs-bytebuffer",children:"ByteBuf vs ByteBuffer"}),"\n",(0,l.jsxs)(n.table,{children:[(0,l.jsx)(n.thead,{children:(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.th,{children:"\u7279\u6027"}),(0,l.jsx)(n.th,{children:"ByteBuffer"}),(0,l.jsx)(n.th,{children:"ByteBuf"})]})}),(0,l.jsxs)(n.tbody,{children:[(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:(0,l.jsx)(n.strong,{children:"API \u590d\u6742\u5ea6"})}),(0,l.jsx)(n.td,{children:"\u590d\u6742"}),(0,l.jsx)(n.td,{children:"\u7b80\u5355\u6613\u7528"})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:(0,l.jsx)(n.strong,{children:"\u8bfb\u5199\u6307\u9488"})}),(0,l.jsx)(n.td,{children:"\u5171\u4eab\u4e00\u4e2a\u6307\u9488"}),(0,l.jsx)(n.td,{children:"\u72ec\u7acb\u7684\u8bfb\u5199\u6307\u9488"})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:(0,l.jsx)(n.strong,{children:"\u52a8\u6001\u5927\u5c0f"})}),(0,l.jsx)(n.td,{children:"\u56fa\u5b9a\u5927\u5c0f"}),(0,l.jsx)(n.td,{children:"\u53ef\u52a8\u6001\u6269\u5c55"})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:(0,l.jsx)(n.strong,{children:"\u5185\u5b58\u7ba1\u7406"})}),(0,l.jsx)(n.td,{children:"\u9700\u624b\u52a8\u7ba1\u7406"}),(0,l.jsx)(n.td,{children:"\u81ea\u52a8\u5f15\u7528\u8ba1\u6570"})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:(0,l.jsx)(n.strong,{children:"\u96f6\u62f7\u8d1d"})}),(0,l.jsx)(n.td,{children:"\u4e0d\u652f\u6301"}),(0,l.jsx)(n.td,{children:"\u652f\u6301"})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:(0,l.jsx)(n.strong,{children:"\u7ebf\u7a0b\u5b89\u5168"})}),(0,l.jsx)(n.td,{children:"\u975e\u7ebf\u7a0b\u5b89\u5168"}),(0,l.jsx)(n.td,{children:"\u975e\u7ebf\u7a0b\u5b89\u5168"})]})]})]}),"\n",(0,l.jsx)(n.h2,{id:"bytebuf-\u7ed3\u6784",children:"ByteBuf \u7ed3\u6784"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{children:"\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502  \u8bfb\u53d6\u533a\u57df\uff08Readable\uff09\u2502 \u5199\u5165\u533a\u57df\uff08Writable\uff09 \u2502\u9884\u7559 \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502                                                 \u2502\n0          readerIndex                 writerIndex  capacity\n          \u25c4\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 \u53ef\u8bfb\u5b57\u8282\u6570 \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25ba\n                                  \u25c4\u2500\u2500 \u53ef\u5199\u5b57\u8282\u6570 \u2500\u2500\u25ba\n"})}),"\n",(0,l.jsx)(n.h3,{id:"\u521b\u5efa-bytebuf",children:"\u521b\u5efa ByteBuf"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:'// \u65b9\u5f0f1\uff1a\u975e\u6c60\u5316 ByteBuf\uff08\u4e0d\u63a8\u8350\u7528\u4e8e\u751f\u4ea7\uff09\nByteBuf buf = Unpooled.buffer(10);\nByteBuf buf2 = Unpooled.directBuffer(10);\n\n// \u65b9\u5f0f2\uff1a\u6c60\u5316 ByteBuf\uff08\u63a8\u8350\uff0c\u9ad8\u6027\u80fd\uff09\nByteBufAllocator allocator = PooledByteBufAllocator.DEFAULT;\nByteBuf buf3 = allocator.buffer(1024);\nByteBuf buf4 = allocator.directBuffer(1024);\n\n// \u65b9\u5f0f3\uff1a\u5305\u88c5\u73b0\u6709\u5b57\u8282\u6570\u7ec4\nbyte[] array = {1, 2, 3, 4, 5};\nByteBuf buf5 = Unpooled.wrappedBuffer(array);\n\n// \u65b9\u5f0f4\uff1a\u62f7\u8d1d\u5b57\u8282\u6570\u7ec4\nByteBuf buf6 = Unpooled.copiedBuffer(array);\n\n// \u65b9\u5f0f5\uff1a\u4ece\u5b57\u7b26\u4e32\u521b\u5efa\nByteBuf buf7 = Unpooled.copiedBuffer("Hello", CharsetUtil.UTF_8);\n\n// \u65b9\u5f0f6\uff1a\u5728 Handler \u4e2d\u83b7\u53d6\n@Override\npublic void channelRead(ChannelHandlerContext ctx, Object msg) {\n    ByteBuf in = (ByteBuf) msg;\n    // \u76f4\u63a5\u4f7f\u7528\n}\n'})}),"\n",(0,l.jsx)(n.h2,{id:"\u8bfb\u5199\u64cd\u4f5c",children:"\u8bfb\u5199\u64cd\u4f5c"}),"\n",(0,l.jsx)(n.h3,{id:"\u57fa\u672c\u8bfb\u5199",children:"\u57fa\u672c\u8bfb\u5199"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:'ByteBuf buf = Unpooled.buffer(10);\n\n// ========== \u5199\u5165 ==========\nbuf.writeInt(100);           // \u5199\u5165 4 \u5b57\u8282\u6574\u6570\nbuf.writeByte(10);           // \u5199\u5165 1 \u5b57\u8282\nbuf.writeBytes(new byte[]{1, 2, 3});  // \u5199\u5165\u5b57\u8282\u6570\u7ec4\nbuf.writeCharSequence("Hello", CharsetUtil.UTF_8);  // \u5199\u5165\u5b57\u7b26\u4e32\n\nSystem.out.println("Writable: " + buf.writableBytes()); // \u53ef\u5199\u5b57\u8282\u6570\n\n// ========== \u8bfb\u53d6 ==========\nint value = buf.readInt();   // \u8bfb\u53d6 4 \u5b57\u8282\u6574\u6570\nbyte b = buf.readByte();     // \u8bfb\u53d6 1 \u5b57\u8282\nbyte[] data = new byte[3];\nbuf.readBytes(data);         // \u8bfb\u53d6\u5b57\u8282\u6570\u7ec4\nString str = buf.readCharSequence(5, CharsetUtil.UTF_8);\n\nSystem.out.println("Readable: " + buf.readableBytes()); // \u53ef\u8bfb\u5b57\u8282\u6570\n'})}),"\n",(0,l.jsx)(n.h3,{id:"\u8bfb\u53d6\u65b9\u5f0f\u5bf9\u6bd4",children:"\u8bfb\u53d6\u65b9\u5f0f\u5bf9\u6bd4"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:'ByteBuf buf = Unpooled.copiedBuffer("Hello", CharsetUtil.UTF_8);\n\n// \u65b9\u5f0f1\uff1a\u76f4\u63a5\u8bfb\u53d6\uff08\u4f1a\u79fb\u52a8 readerIndex\uff09\nbyte b = buf.readByte();\nSystem.out.println("\u8bfb\u53d6\u540e readerIndex: " + buf.readerIndex());\n\n// \u65b9\u5f0f2\uff1a\u83b7\u53d6\u6307\u5b9a\u4f4d\u7f6e\u6570\u636e\uff08\u4e0d\u79fb\u52a8 readerIndex\uff09\nbyte b2 = buf.getByte(0);\nSystem.out.println("getByte \u540e readerIndex: " + buf.readerIndex());\n\n// \u65b9\u5f0f3\uff1a\u83b7\u53d6\u6570\u636e\u800c\u4e0d\u79fb\u52a8\u6307\u9488\nString str = buf.getCharSequence(0, 5, CharsetUtil.UTF_8);\n'})}),"\n",(0,l.jsx)(n.h2,{id:"\u5185\u5b58\u5206\u914d\u65b9\u5f0f",children:"\u5185\u5b58\u5206\u914d\u65b9\u5f0f"}),"\n",(0,l.jsx)(n.h3,{id:"heap-buffer\u5806\u5185\u5b58",children:"Heap Buffer\uff08\u5806\u5185\u5b58\uff09"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"// \u5b58\u50a8\u5728 JVM \u5806\u5185\u5b58\u4e2d\nByteBuf heapBuf = Unpooled.buffer(1024);\n\n// \u4f18\u70b9\uff1a\n// - GC \u81ea\u52a8\u7ba1\u7406\n// - \u6613\u4e8e\u4f7f\u7528\n// - \u5feb\u901f\u5206\u914d\u548c\u9500\u6bc1\n\n// \u7f3a\u70b9\uff1a\n// - \u6027\u80fd\u4e0d\u5982\u76f4\u63a5\u5185\u5b58\n// - \u9700\u8981\u989d\u5916\u7684 copy \u64cd\u4f5c\u8fdb\u884c I/O\n"})}),"\n",(0,l.jsx)(n.h3,{id:"direct-buffer\u76f4\u63a5\u5185\u5b58",children:"Direct Buffer\uff08\u76f4\u63a5\u5185\u5b58\uff09"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"// \u5b58\u50a8\u5728\u5806\u5916\u5185\u5b58\uff08native memory\uff09\nByteBuf directBuf = Unpooled.directBuffer(1024);\n\n// \u4f18\u70b9\uff1a\n// - \u6027\u80fd\u9ad8\uff0c\u51cf\u5c11 GC \u538b\u529b\n// - \u76f4\u63a5 I/O\uff0c\u65e0\u9700 copy\n\n// \u7f3a\u70b9\uff1a\n// - \u5206\u914d\u548c\u91ca\u653e\u66f4\u6162\n// - \u9700\u8981\u624b\u52a8\u7ba1\u7406\u5185\u5b58\n// - \u53ef\u80fd\u5f15\u8d77 OutOfMemory\n"})}),"\n",(0,l.jsx)(n.h2,{id:"\u5f15\u7528\u8ba1\u6570\u548c\u8d44\u6e90\u91ca\u653e",children:"\u5f15\u7528\u8ba1\u6570\u548c\u8d44\u6e90\u91ca\u653e"}),"\n",(0,l.jsx)(n.p,{children:"Netty \u4f7f\u7528\u5f15\u7528\u8ba1\u6570\u6765\u7ba1\u7406 ByteBuf \u7684\u751f\u547d\u5468\u671f\u3002"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:'// \u65b0\u521b\u5efa\u7684 ByteBuf\uff0c\u5f15\u7528\u8ba1\u6570\u4e3a 1\nByteBuf buf = allocator.buffer(1024);\nSystem.out.println("\u521b\u5efa\u540e\uff0c\u5f15\u7528\u8ba1\u6570: " + buf.refCnt()); // 1\n\n// \u589e\u52a0\u5f15\u7528\u8ba1\u6570\nbuf.retain();\nSystem.out.println("retain \u540e: " + buf.refCnt()); // 2\n\n// \u51cf\u5c11\u5f15\u7528\u8ba1\u6570\nbuf.release();\nSystem.out.println("release \u540e: " + buf.refCnt()); // 1\n\n// \u6700\u540e\u4e00\u6b21 release\uff0cByteBuf \u88ab\u56de\u6536\nbuf.release();\nSystem.out.println("release \u540e: " + buf.refCnt()); // 0\n\n// \u5c1d\u8bd5\u518d\u6b21\u4f7f\u7528\u4f1a\u629b\u5f02\u5e38\n// buf.writeInt(100); // IllegalReferenceCountException\n'})}),"\n",(0,l.jsx)(n.h3,{id:"handler-\u4e2d\u7684\u8d44\u6e90\u7ba1\u7406",children:"Handler \u4e2d\u7684\u8d44\u6e90\u7ba1\u7406"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:'public class ByteBufHandler extends ChannelInboundHandlerAdapter {\n    @Override\n    public void channelRead(ChannelHandlerContext ctx, Object msg) {\n        ByteBuf in = (ByteBuf) msg;\n        try {\n            // \u5904\u7406 ByteBuf\n            byte[] data = new byte[in.readableBytes()];\n            in.readBytes(data);\n            System.out.println("\u6570\u636e: " + Arrays.toString(data));\n        } finally {\n            // Netty \u4f1a\u81ea\u52a8\u91ca\u653e\u8f93\u5165\u7684 ByteBuf\n            ReferenceCountUtil.release(msg);\n        }\n    }\n\n    @Override\n    public void write(ChannelHandlerContext ctx, Object msg, ChannelPromise promise) {\n        // \u5982\u679c\u5199\u5165 ByteBuf\uff0c\u9700\u8981\u4f20\u9012\u7ed9\u4e0b\u4e00\u4e2a Handler\n        ByteBuf response = ctx.alloc().buffer(128);\n        response.writeCharSequence("OK", CharsetUtil.UTF_8);\n        ctx.writeAndFlush(response); // Netty \u4f1a\u81ea\u52a8\u91ca\u653e\n    }\n}\n'})}),"\n",(0,l.jsx)(n.h2,{id:"\u96f6\u62f7\u8d1d\u64cd\u4f5c",children:"\u96f6\u62f7\u8d1d\u64cd\u4f5c"}),"\n",(0,l.jsx)(n.h3,{id:"compositebytebuf",children:"CompositeByteBuf"}),"\n",(0,l.jsx)(n.p,{children:"\u591a\u4e2a ByteBuf \u7ec4\u5408\u6210\u4e00\u4e2a\uff0c\u907f\u514d\u590d\u5236\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:'ByteBuf buf1 = Unpooled.wrappedBuffer(new byte[]{1, 2, 3});\nByteBuf buf2 = Unpooled.wrappedBuffer(new byte[]{4, 5, 6});\n\n// \u7ec4\u5408\u591a\u4e2a ByteBuf\uff0c\u4e0d\u8fdb\u884c\u590d\u5236\nCompositeByteBuf composite = Unpooled.compositeBuffer();\ncomposite.addComponents(true, buf1, buf2); // true \u8868\u793a\u81ea\u52a8\u589e\u957f\n\n// \u8bfb\u53d6\u7ec4\u5408\u7684\u6570\u636e\nbyte[] data = new byte[composite.readableBytes()];\ncomposite.readBytes(data);\nSystem.out.println("\u7ec4\u5408\u6570\u636e: " + Arrays.toString(data)); // [1,2,3,4,5,6]\n'})}),"\n",(0,l.jsx)(n.h3,{id:"slice\u5207\u7247",children:"Slice\uff08\u5207\u7247\uff09"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:'ByteBuf buf = Unpooled.wrappedBuffer(new byte[]{1, 2, 3, 4, 5});\n\n// \u521b\u5efa slice\uff0c\u5171\u4eab\u5e95\u5c42\u6570\u636e\uff0c\u4e0d\u590d\u5236\nByteBuf slice = buf.slice(1, 3); // \u4ece\u4f4d\u7f6e 1 \u5f00\u59cb\uff0c\u957f\u5ea6 3\n\n// \u4fee\u6539 slice \u4f1a\u5f71\u54cd\u539f ByteBuf\nslice.setByte(0, 10);\nSystem.out.println("\u539f buf: " + buf.getByte(1)); // 10\n\n// \u4f46 slice \u6709\u72ec\u7acb\u7684\u8bfb\u5199\u6307\u9488\nslice.readByte();\nSystem.out.println("slice readerIndex: " + slice.readerIndex()); // 1\nSystem.out.println("\u539f buf readerIndex: " + buf.readerIndex()); // 0\n'})}),"\n",(0,l.jsx)(n.h3,{id:"duplicate\u590d\u5236\u5f15\u7528",children:"Duplicate\uff08\u590d\u5236\u5f15\u7528\uff09"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:'ByteBuf buf = Unpooled.wrappedBuffer(new byte[]{1, 2, 3, 4, 5});\n\n// \u521b\u5efa duplicate\uff0c\u72ec\u7acb\u7684\u8bfb\u5199\u6307\u9488\uff0c\u4f46\u5171\u4eab\u6570\u636e\nByteBuf dup = buf.duplicate();\n\nbuf.readByte();\nSystem.out.println("\u539f buf readerIndex: " + buf.readerIndex()); // 1\nSystem.out.println("dup readerIndex: " + dup.readerIndex()); // 0\n\n// \u4fee\u6539 dup \u4f1a\u5f71\u54cd\u539f ByteBuf\ndup.setByte(0, 10);\nSystem.out.println("\u539f buf \u7b2c 0 \u4f4d: " + buf.getByte(0)); // 10\n'})}),"\n",(0,l.jsx)(n.h2,{id:"bytebuf-\u5206\u914d\u5668",children:"ByteBuf \u5206\u914d\u5668"}),"\n",(0,l.jsx)(n.h3,{id:"pooledbytebufallocator\u63a8\u8350",children:"PooledByteBufAllocator\uff08\u63a8\u8350\uff09"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"// \u9ed8\u8ba4\u4f7f\u7528 PooledByteBufAllocator\nChannelConfig config = channel.config();\nconfig.setOption(ChannelOption.ALLOCATOR, PooledByteBufAllocator.DEFAULT);\n\n// \u4f18\u52bf\uff1a\n// - \u91cd\u7528\u5df2\u5206\u914d\u7684\u5185\u5b58\uff0c\u51cf\u5c11 GC\n// - \u6027\u80fd\u9ad8\n// - \u9002\u5408\u957f\u8fde\u63a5\u573a\u666f\n"})}),"\n",(0,l.jsx)(n.h3,{id:"unpooledbytebufallocator",children:"UnpooledByteBufAllocator"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"// \u4e0d\u4f7f\u7528\u5185\u5b58\u6c60\uff0c\u6bcf\u6b21\u521b\u5efa\u65b0\u7684 ByteBuf\nByteBufAllocator allocator = UnpooledByteBufAllocator.DEFAULT;\nByteBuf buf = allocator.buffer(1024);\n\n// \u9002\u5408\uff1a\n// - \u4e00\u6b21\u6027\u64cd\u4f5c\n// - \u5185\u5b58\u9700\u6c42\u4e0d\u9891\u7e41\n"})}),"\n",(0,l.jsx)(n.h2,{id:"\u6700\u4f73\u5b9e\u8df5",children:"\u6700\u4f73\u5b9e\u8df5"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:'public class ByteBufBestPractices extends ChannelInboundHandlerAdapter {\n    \n    // \u2713 \u6b63\u786e\uff1a\u5904\u7406\u63a5\u6536\u7684\u6d88\u606f\n    @Override\n    public void channelRead(ChannelHandlerContext ctx, Object msg) {\n        ByteBuf in = (ByteBuf) msg;\n        try {\n            // \u5904\u7406\u6d88\u606f\n            processMessage(in);\n        } finally {\n            // \u91ca\u653e\u5f15\u7528\n            ReferenceCountUtil.release(msg);\n        }\n    }\n\n    // \u2713 \u6b63\u786e\uff1a\u5199\u5165\u54cd\u5e94\n    private void sendResponse(ChannelHandlerContext ctx, String response) {\n        ByteBuf buf = ctx.alloc().buffer();\n        buf.writeCharSequence(response, CharsetUtil.UTF_8);\n        ctx.writeAndFlush(buf); // Netty \u81ea\u52a8\u91ca\u653e\n    }\n\n    // \u2717 \u9519\u8bef\uff1a\u5185\u5b58\u6cc4\u6f0f\n    @Override\n    public void channelRead2(ChannelHandlerContext ctx, Object msg) {\n        ByteBuf in = (ByteBuf) msg;\n        // \u6ca1\u6709\u91ca\u653e\uff0c\u5bfc\u81f4\u5185\u5b58\u6cc4\u6f0f\uff01\n        processMessage(in);\n    }\n\n    // \u2717 \u9519\u8bef\uff1a\u672a\u6b63\u786e\u91ca\u653e\n    private void badWrite(ChannelHandlerContext ctx, String msg) {\n        ByteBuf buf = ctx.alloc().buffer();\n        buf.writeCharSequence(msg, CharsetUtil.UTF_8);\n        ctx.channel().writeAndFlush(buf.copy()); // \u8fd9\u6837\u4f1a\u5bfc\u81f4\u6cc4\u6f0f\n    }\n\n    private void processMessage(ByteBuf in) {\n        byte[] data = new byte[in.readableBytes()];\n        in.readBytes(data);\n        System.out.println("\u5904\u7406\u6570\u636e: " + Arrays.toString(data));\n    }\n}\n'})}),"\n",(0,l.jsx)(n.h2,{id:"\u5e38\u7528\u5de5\u5177\u7c7b",children:"\u5e38\u7528\u5de5\u5177\u7c7b"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"// ReferenceCountUtil - \u5b89\u5168\u91ca\u653e\u5bf9\u8c61\nObject msg = ...;\nReferenceCountUtil.release(msg);\n\n// ByteBufUtil - ByteBuf \u5de5\u5177\u65b9\u6cd5\nString hex = ByteBufUtil.hexDump(buf);\nByteBufUtil.appendPrettyHexDump(sb, buf);\n\n// PooledByteBufAllocator.DEFAULT - \u83b7\u53d6\u9ed8\u8ba4\u5206\u914d\u5668\nByteBuf buf = PooledByteBufAllocator.DEFAULT.buffer(256);\n"})}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.a,{href:"/docs/netty/codec",children:"\u4e0b\u4e00\u7ae0\uff1a\u7f16\u7801\u4e0e\u89e3\u7801"})})]})}function o(e={}){const{wrapper:n}={...(0,d.R)(),...e.components};return n?(0,l.jsx)(n,{...e,children:(0,l.jsx)(c,{...e})}):c(e)}}}]);