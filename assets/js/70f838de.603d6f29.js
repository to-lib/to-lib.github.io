"use strict";(globalThis.webpackChunkto_lib_github_io=globalThis.webpackChunkto_lib_github_io||[]).push([[51844],{48885:(e,n,r)=>{r.d(n,{R:()=>d,x:()=>i});var a=r(99378);const l={},t=a.createContext(l);function d(e){const n=a.useContext(t);return a.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function i(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(l):e.components||l:d(e.components),a.createElement(t.Provider,{value:n},e.children)}},87668:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>s,contentTitle:()=>i,default:()=>h,frontMatter:()=>d,metadata:()=>a,toc:()=>o});const a=JSON.parse('{"id":"ml/distributed-training","title":"\u26a1 \u5206\u5e03\u5f0f\u8bad\u7ec3","description":"\u5206\u5e03\u5f0f\u8bad\u7ec3\u5728\u591a GPU/\u591a\u673a\u5668\u4e0a\u5e76\u884c\u8bad\u7ec3\u5927\u6a21\u578b\u3002","source":"@site/docs/ml/distributed-training.md","sourceDirName":"ml","slug":"/ml/distributed-training","permalink":"/docs/ml/distributed-training","draft":false,"unlisted":false,"editUrl":"https://github.com/to-lib/to-lib.github.io/tree/main/docs/ml/distributed-training.md","tags":[],"version":"current","sidebarPosition":41,"frontMatter":{"sidebar_position":41,"title":"\u26a1 \u5206\u5e03\u5f0f\u8bad\u7ec3"},"sidebar":"ml","previous":{"title":"\ud83d\udd27 \u7279\u5f81\u5de5\u7a0b\u8fdb\u9636","permalink":"/docs/ml/advanced-feature-engineering"},"next":{"title":"\ud83d\udd27 MLOps \u5de5\u5177\u94fe","permalink":"/docs/ml/mlops-tools"}}');var l=r(22714),t=r(48885);const d={sidebar_position:41,title:"\u26a1 \u5206\u5e03\u5f0f\u8bad\u7ec3"},i="\u5206\u5e03\u5f0f\u8bad\u7ec3",s={},o=[{value:"\u5e76\u884c\u7b56\u7565",id:"\u5e76\u884c\u7b56\u7565",level:2},{value:"\u6570\u636e\u5e76\u884c (Data Parallel)",id:"\u6570\u636e\u5e76\u884c-data-parallel",level:2},{value:"PyTorch DataParallel",id:"pytorch-dataparallel",level:3},{value:"PyTorch DDP (\u63a8\u8350)",id:"pytorch-ddp-\u63a8\u8350",level:3},{value:"torchrun \u542f\u52a8",id:"torchrun-\u542f\u52a8",level:3},{value:"\u6a21\u578b\u5e76\u884c",id:"\u6a21\u578b\u5e76\u884c",level:2},{value:"FSDP (Fully Sharded Data Parallel)",id:"fsdp-fully-sharded-data-parallel",level:2},{value:"DeepSpeed",id:"deepspeed",level:2},{value:"Hugging Face Accelerate",id:"hugging-face-accelerate",level:2},{value:"\u6df7\u5408\u7cbe\u5ea6\u8bad\u7ec3",id:"\u6df7\u5408\u7cbe\u5ea6\u8bad\u7ec3",level:2},{value:"\u7b56\u7565\u5bf9\u6bd4",id:"\u7b56\u7565\u5bf9\u6bd4",level:2}];function c(e){const n={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",mermaid:"mermaid",p:"p",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",...(0,t.R)(),...e.components};return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(n.header,{children:(0,l.jsx)(n.h1,{id:"\u5206\u5e03\u5f0f\u8bad\u7ec3",children:"\u5206\u5e03\u5f0f\u8bad\u7ec3"})}),"\n",(0,l.jsx)(n.p,{children:"\u5206\u5e03\u5f0f\u8bad\u7ec3\u5728\u591a GPU/\u591a\u673a\u5668\u4e0a\u5e76\u884c\u8bad\u7ec3\u5927\u6a21\u578b\u3002"}),"\n",(0,l.jsx)(n.h2,{id:"\u5e76\u884c\u7b56\u7565",children:"\u5e76\u884c\u7b56\u7565"}),"\n",(0,l.jsx)(n.mermaid,{value:"graph TB\n    A[\u5206\u5e03\u5f0f\u8bad\u7ec3] --\x3e B[\u6570\u636e\u5e76\u884c]\n    A --\x3e C[\u6a21\u578b\u5e76\u884c]\n    A --\x3e D[\u6d41\u6c34\u7ebf\u5e76\u884c]\n    A --\x3e E[\u6df7\u5408\u5e76\u884c]"}),"\n",(0,l.jsx)(n.h2,{id:"\u6570\u636e\u5e76\u884c-data-parallel",children:"\u6570\u636e\u5e76\u884c (Data Parallel)"}),"\n",(0,l.jsx)(n.h3,{id:"pytorch-dataparallel",children:"PyTorch DataParallel"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-python",children:"import torch.nn as nn\n\n# \u5355\u673a\u591a\u5361\uff08\u7b80\u5355\u4f46\u6548\u7387\u4f4e\uff09\nmodel = nn.DataParallel(model)\nmodel = model.cuda()\n"})}),"\n",(0,l.jsx)(n.h3,{id:"pytorch-ddp-\u63a8\u8350",children:"PyTorch DDP (\u63a8\u8350)"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-python",children:'import torch.distributed as dist\nfrom torch.nn.parallel import DistributedDataParallel as DDP\n\ndef setup(rank, world_size):\n    dist.init_process_group("nccl", rank=rank, world_size=world_size)\n\ndef train(rank, world_size):\n    setup(rank, world_size)\n\n    model = MyModel().to(rank)\n    model = DDP(model, device_ids=[rank])\n\n    sampler = DistributedSampler(dataset, num_replicas=world_size, rank=rank)\n    dataloader = DataLoader(dataset, sampler=sampler, batch_size=32)\n\n    for epoch in range(epochs):\n        sampler.set_epoch(epoch)\n        for batch in dataloader:\n            # \u8bad\u7ec3\n            pass\n\n# \u542f\u52a8\ntorch.multiprocessing.spawn(train, args=(world_size,), nprocs=world_size)\n'})}),"\n",(0,l.jsx)(n.h3,{id:"torchrun-\u542f\u52a8",children:"torchrun \u542f\u52a8"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"torchrun --nproc_per_node=4 train.py\n# \u591a\u673a\ntorchrun --nnodes=2 --nproc_per_node=4 --node_rank=0 --master_addr=xxx train.py\n"})}),"\n",(0,l.jsx)(n.h2,{id:"\u6a21\u578b\u5e76\u884c",children:"\u6a21\u578b\u5e76\u884c"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-python",children:"class ModelParallel(nn.Module):\n    def __init__(self):\n        super().__init__()\n        self.layer1 = nn.Linear(1024, 1024).to('cuda:0')\n        self.layer2 = nn.Linear(1024, 1024).to('cuda:1')\n\n    def forward(self, x):\n        x = self.layer1(x.to('cuda:0'))\n        x = self.layer2(x.to('cuda:1'))\n        return x\n"})}),"\n",(0,l.jsx)(n.h2,{id:"fsdp-fully-sharded-data-parallel",children:"FSDP (Fully Sharded Data Parallel)"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-python",children:"from torch.distributed.fsdp import FullyShardedDataParallel as FSDP\n\nmodel = FSDP(\n    model,\n    sharding_strategy=ShardingStrategy.FULL_SHARD,\n    cpu_offload=CPUOffload(offload_params=True)\n)\n"})}),"\n",(0,l.jsx)(n.h2,{id:"deepspeed",children:"DeepSpeed"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-python",children:'import deepspeed\n\nmodel, optimizer, _, _ = deepspeed.initialize(\n    model=model,\n    model_parameters=model.parameters(),\n    config={\n        "train_batch_size": 32,\n        "fp16": {"enabled": True},\n        "zero_optimization": {"stage": 2}\n    }\n)\n'})}),"\n",(0,l.jsx)(n.h2,{id:"hugging-face-accelerate",children:"Hugging Face Accelerate"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-python",children:"from accelerate import Accelerator\n\naccelerator = Accelerator()\nmodel, optimizer, dataloader = accelerator.prepare(model, optimizer, dataloader)\n\nfor batch in dataloader:\n    outputs = model(**batch)\n    loss = outputs.loss\n    accelerator.backward(loss)\n    optimizer.step()\n"})}),"\n",(0,l.jsx)(n.h2,{id:"\u6df7\u5408\u7cbe\u5ea6\u8bad\u7ec3",children:"\u6df7\u5408\u7cbe\u5ea6\u8bad\u7ec3"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-python",children:"from torch.cuda.amp import autocast, GradScaler\n\nscaler = GradScaler()\n\nfor batch in dataloader:\n    with autocast():\n        output = model(batch)\n        loss = criterion(output, target)\n\n    scaler.scale(loss).backward()\n    scaler.step(optimizer)\n    scaler.update()\n"})}),"\n",(0,l.jsx)(n.h2,{id:"\u7b56\u7565\u5bf9\u6bd4",children:"\u7b56\u7565\u5bf9\u6bd4"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,l.jsxs)(n.table,{children:[(0,l.jsx)(n.thead,{children:(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.th,{children:"\u7b56\u7565"}),(0,l.jsx)(n.th,{children:"\u9002\u7528\u573a\u666f"}),(0,l.jsx)(n.th,{children:"\u901a\u4fe1\u5f00\u9500"})]})}),(0,l.jsxs)(n.tbody,{children:[(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:"\u6570\u636e\u5e76\u884c"}),(0,l.jsx)(n.td,{children:"\u6a21\u578b\u80fd\u653e\u5165\u5355\u5361"}),(0,l.jsx)(n.td,{children:"\u4f4e"})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:"\u6a21\u578b\u5e76\u884c"}),(0,l.jsx)(n.td,{children:"\u5355\u6a21\u578b\u592a\u5927"}),(0,l.jsx)(n.td,{children:"\u9ad8"})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:"FSDP/ZeRO"}),(0,l.jsx)(n.td,{children:"\u5927\u6a21\u578b\u8bad\u7ec3"}),(0,l.jsx)(n.td,{children:"\u4e2d"})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:"\u6d41\u6c34\u7ebf\u5e76\u884c"}),(0,l.jsx)(n.td,{children:"\u8d85\u5927\u6a21\u578b"}),(0,l.jsx)(n.td,{children:"\u4e2d"})]})]})]})]})}function h(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,l.jsx)(n,{...e,children:(0,l.jsx)(c,{...e})}):c(e)}}}]);