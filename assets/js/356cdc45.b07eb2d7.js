"use strict";(globalThis.webpackChunkto_lib_github_io=globalThis.webpackChunkto_lib_github_io||[]).push([[2796],{35046:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>d,contentTitle:()=>c,default:()=>h,frontMatter:()=>a,metadata:()=>l,toc:()=>t});const l=JSON.parse('{"id":"rabbitmq/queues","title":"\u961f\u5217\u7ba1\u7406","description":"RabbitMQ Queue \u53c2\u6570\u3001TTL\u3001DLX\u3001\u961f\u5217\u7c7b\u578b\u4e0e\u5b9e\u8df5","source":"@site/docs/rabbitmq/queues.md","sourceDirName":"rabbitmq","slug":"/rabbitmq/queues","permalink":"/docs/rabbitmq/queues","draft":false,"unlisted":false,"editUrl":"https://github.com/to-lib/to-lib.github.io/tree/main/docs/rabbitmq/queues.md","tags":[],"version":"current","sidebarPosition":5,"frontMatter":{"sidebar_position":5,"title":"\u961f\u5217\u7ba1\u7406","description":"RabbitMQ Queue \u53c2\u6570\u3001TTL\u3001DLX\u3001\u961f\u5217\u7c7b\u578b\u4e0e\u5b9e\u8df5"},"sidebar":"rabbitmq","previous":{"title":"\u4ea4\u6362\u673a\u8be6\u89e3","permalink":"/docs/rabbitmq/exchanges"},"next":{"title":"\u5feb\u901f\u5f00\u59cb","permalink":"/docs/rabbitmq/quick-start"}}');var r=s(22714),i=s(48885);const a={sidebar_position:5,title:"\u961f\u5217\u7ba1\u7406",description:"RabbitMQ Queue \u53c2\u6570\u3001TTL\u3001DLX\u3001\u961f\u5217\u7c7b\u578b\u4e0e\u5b9e\u8df5"},c="\u961f\u5217\u7ba1\u7406",d={},t=[{value:"\u961f\u5217\u7684\u57fa\u7840\u5c5e\u6027",id:"\u961f\u5217\u7684\u57fa\u7840\u5c5e\u6027",level:2},{value:"\u5e38\u7528\u961f\u5217 arguments\uff08\u6838\u5fc3\u53c2\u6570\uff09",id:"\u5e38\u7528\u961f\u5217-arguments\u6838\u5fc3\u53c2\u6570",level:2},{value:"TTL\uff08\u8fc7\u671f\uff09",id:"ttl\u8fc7\u671f",level:2},{value:"\u6d88\u606f TTL\uff08per-message\uff09",id:"\u6d88\u606f-ttlper-message",level:2},{value:"\u961f\u5217 TTL\uff08per-queue\uff09",id:"\u961f\u5217-ttlper-queue",level:2},{value:"DLX\uff08Dead Letter Exchange\uff0c\u6b7b\u4fe1\u4ea4\u6362\u673a\uff09",id:"dlxdead-letter-exchange\u6b7b\u4fe1\u4ea4\u6362\u673a",level:2},{value:"\u961f\u5217\u957f\u5ea6\u9650\u5236\u4e0e\u6ea2\u51fa\u7b56\u7565",id:"\u961f\u5217\u957f\u5ea6\u9650\u5236\u4e0e\u6ea2\u51fa\u7b56\u7565",level:2},{value:"Lazy Queue\uff08\u5ef6\u8fdf\u52a0\u8f7d\u961f\u5217\uff09",id:"lazy-queue\u5ef6\u8fdf\u52a0\u8f7d\u961f\u5217",level:2},{value:"\u4f18\u5148\u7ea7\u961f\u5217",id:"\u4f18\u5148\u7ea7\u961f\u5217",level:2},{value:"\u961f\u5217\u7c7b\u578b\uff1aClassic vs Quorum vs Stream",id:"\u961f\u5217\u7c7b\u578bclassic-vs-quorum-vs-stream",level:2},{value:"Classic\uff08\u7ecf\u5178\u961f\u5217\uff09",id:"classic\u7ecf\u5178\u961f\u5217",level:2},{value:"Quorum\uff08\u4ef2\u88c1\u961f\u5217\uff0c\u63a8\u8350\u65b0\u9879\u76ee\u4f18\u5148\uff09",id:"quorum\u4ef2\u88c1\u961f\u5217\u63a8\u8350\u65b0\u9879\u76ee\u4f18\u5148",level:2},{value:"Stream\uff08\u6d41\u961f\u5217\uff09",id:"stream\u6d41\u961f\u5217",level:2},{value:"\u4e0e\u6d88\u8d39\u786e\u8ba4\uff08ack\uff09\u8054\u52a8\u7684\u8981\u70b9",id:"\u4e0e\u6d88\u8d39\u786e\u8ba4ack\u8054\u52a8\u7684\u8981\u70b9",level:2},{value:"\u4e0b\u4e00\u6b65",id:"\u4e0b\u4e00\u6b65",level:2}];function u(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"\u961f\u5217\u7ba1\u7406",children:"\u961f\u5217\u7ba1\u7406"})}),"\n",(0,r.jsx)(n.p,{children:"\u961f\u5217\uff08Queue\uff09\u662f\u6d88\u606f\u6700\u7ec8\u5b58\u50a8\u4e0e\u6d88\u8d39\u7684\u4f4d\u7f6e\u3002\u961f\u5217\u7684\u914d\u7f6e\u51b3\u5b9a\u4e86\uff1a\u6d88\u606f\u662f\u5426\u6301\u4e45\u5316\u3001\u662f\u5426\u4f1a\u8fc7\u671f\u3001\u662f\u5426\u4f1a\u8fdb\u5165\u6b7b\u4fe1\u3001\u961f\u5217\u6ee1\u4e86\u5982\u4f55\u5904\u7406\u3001\u4ee5\u53ca\u961f\u5217\u9ad8\u53ef\u7528\u65b9\u6848\u7b49\u3002"}),"\n",(0,r.jsx)(n.h2,{id:"\u961f\u5217\u7684\u57fa\u7840\u5c5e\u6027",children:"\u961f\u5217\u7684\u57fa\u7840\u5c5e\u6027"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"name"}),"\uff1a\u961f\u5217\u540d"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"durable"}),"\uff1a\u662f\u5426\u6301\u4e45\u5316\uff08Broker \u91cd\u542f\u540e\u4ecd\u5b58\u5728\uff09"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"exclusive"}),"\uff1a\u6392\u4ed6\u961f\u5217\uff08\u4ec5\u5f53\u524d\u8fde\u63a5\u53ef\u7528\uff0c\u8fde\u63a5\u65ad\u5f00\u5373\u5220\u9664\uff09"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"autoDelete"}),"\uff1a\u6700\u540e\u4e00\u4e2a\u6d88\u8d39\u8005\u53d6\u6d88\u8ba2\u9605\u540e\u81ea\u52a8\u5220\u9664"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"Java \u58f0\u660e\u793a\u4f8b\uff1a"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:'channel.queueDeclare("order.queue", true, false, false, null);\n'})}),"\n",(0,r.jsx)(n.h2,{id:"\u5e38\u7528\u961f\u5217-arguments\u6838\u5fc3\u53c2\u6570",children:"\u5e38\u7528\u961f\u5217 arguments\uff08\u6838\u5fc3\u53c2\u6570\uff09"}),"\n",(0,r.jsxs)(n.p,{children:["\u901a\u8fc7 ",(0,r.jsx)(n.code,{children:"arguments"})," \u6269\u5c55\u961f\u5217\u884c\u4e3a\u3002"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:'Map<String, Object> args = new HashMap<>();\nargs.put("x-message-ttl", 60000);\nargs.put("x-dead-letter-exchange", "dlx.exchange");\nargs.put("x-dead-letter-routing-key", "dlx.order");\nchannel.queueDeclare("order.queue", true, false, false, args);\n'})}),"\n",(0,r.jsx)(n.h2,{id:"ttl\u8fc7\u671f",children:"TTL\uff08\u8fc7\u671f\uff09"}),"\n",(0,r.jsx)(n.p,{children:"RabbitMQ \u652f\u6301\uff1a"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"\u6d88\u606f TTL"}),"\uff1a\u6bcf\u6761\u6d88\u606f\u7684\u8fc7\u671f\u65f6\u95f4\uff08message property ",(0,r.jsx)(n.code,{children:"expiration"}),"\uff09"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"\u961f\u5217 TTL"}),"\uff1a\u961f\u5217\u7ea7\u522b\u5bf9\u6240\u6709\u6d88\u606f\u7edf\u4e00\u8bbe\u7f6e\uff08",(0,r.jsx)(n.code,{children:"x-message-ttl"}),"\uff09"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"\u961f\u5217\u8fc7\u671f"}),"\uff1a\u961f\u5217\u65e0\u4eba\u4f7f\u7528\u65f6\u81ea\u52a8\u8fc7\u671f\uff08",(0,r.jsx)(n.code,{children:"x-expires"}),"\uff09"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"\u6d88\u606f-ttlper-message",children:"\u6d88\u606f TTL\uff08per-message\uff09"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:'AMQP.BasicProperties props = new AMQP.BasicProperties.Builder()\n    .expiration("30000")\n    .build();\nchannel.basicPublish("", "q", props, body);\n'})}),"\n",(0,r.jsx)(n.h2,{id:"\u961f\u5217-ttlper-queue",children:"\u961f\u5217 TTL\uff08per-queue\uff09"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:'args.put("x-message-ttl", 30000);\n'})}),"\n",(0,r.jsx)(n.admonition,{title:"\u6ce8\u610f",type:"warning",children:(0,r.jsx)(n.p,{children:"\u6d88\u606f TTL \u7684\u8fc7\u671f\u68c0\u67e5\u4ee5\u961f\u5217\u5934\u90e8\u4e3a\u4e3b\uff1a\u5982\u679c\u961f\u5934\u6d88\u606f TTL \u66f4\u957f\uff0c\u540e\u7eed\u77ed TTL \u6d88\u606f\u53ef\u80fd\u65e0\u6cd5\u53ca\u65f6\u8fc7\u671f\u5904\u7406\u3002"})}),"\n",(0,r.jsx)(n.h2,{id:"dlxdead-letter-exchange\u6b7b\u4fe1\u4ea4\u6362\u673a",children:"DLX\uff08Dead Letter Exchange\uff0c\u6b7b\u4fe1\u4ea4\u6362\u673a\uff09"}),"\n",(0,r.jsx)(n.p,{children:"\u6d88\u606f\u8fdb\u5165\u6b7b\u4fe1\u7684\u5178\u578b\u60c5\u51b5\uff1a"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\u88ab ",(0,r.jsx)(n.code,{children:"basicReject/basicNack"})," \u4e14 ",(0,r.jsx)(n.code,{children:"requeue=false"})]}),"\n",(0,r.jsx)(n.li,{children:"\u6d88\u606f\u8fc7\u671f\uff08TTL\uff09"}),"\n",(0,r.jsxs)(n.li,{children:["\u961f\u5217\u8fbe\u5230\u6700\u5927\u957f\u5ea6\uff08",(0,r.jsx)(n.code,{children:"x-max-length"})," / ",(0,r.jsx)(n.code,{children:"x-max-length-bytes"}),"\uff09"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"\u914d\u7f6e\u65b9\u5f0f\uff08\u4e1a\u52a1\u961f\u5217\u58f0\u660e\u65f6\u8bbe\u7f6e DLX\uff09\uff1a"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:'args.put("x-dead-letter-exchange", "dlx.exchange");\nargs.put("x-dead-letter-routing-key", "dlx.order");\n'})}),"\n",(0,r.jsx)(n.p,{children:"\u5e76\u51c6\u5907 DLX \u4fa7\u7684\u961f\u5217\uff1a"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:'channel.exchangeDeclare("dlx.exchange", "direct", true);\nchannel.queueDeclare("dlx.queue", true, false, false, null);\nchannel.queueBind("dlx.queue", "dlx.exchange", "dlx.order");\n'})}),"\n",(0,r.jsx)(n.h2,{id:"\u961f\u5217\u957f\u5ea6\u9650\u5236\u4e0e\u6ea2\u51fa\u7b56\u7565",children:"\u961f\u5217\u957f\u5ea6\u9650\u5236\u4e0e\u6ea2\u51fa\u7b56\u7565"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"x-max-length"}),"\uff1a\u6700\u5927\u6d88\u606f\u6570"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"x-max-length-bytes"}),"\uff1a\u6700\u5927\u5b57\u8282\u6570"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"x-overflow"}),"\uff1a\u6ea2\u51fa\u7b56\u7565","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"reject-publish"}),"\uff1a\u62d2\u7edd\u53d1\u5e03\uff08\u63a8\u8350\u66f4\u5b89\u5168\uff09"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"drop-head"}),"\uff1a\u4e22\u5f03\u961f\u5934\u6d88\u606f"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:'args.put("x-max-length", 100000);\nargs.put("x-overflow", "reject-publish");\n'})}),"\n",(0,r.jsx)(n.h2,{id:"lazy-queue\u5ef6\u8fdf\u52a0\u8f7d\u961f\u5217",children:"Lazy Queue\uff08\u5ef6\u8fdf\u52a0\u8f7d\u961f\u5217\uff09"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"x-queue-mode=lazy"})," \u5c06\u5c3d\u91cf\u628a\u6d88\u606f\u653e\u78c1\u76d8\uff0c\u9002\u5408\u201c\u6d88\u606f\u5806\u79ef\u5927\u4f46\u5141\u8bb8\u8f83\u9ad8\u5ef6\u8fdf\u201d\u7684\u573a\u666f\u3002"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:'args.put("x-queue-mode", "lazy");\n'})}),"\n",(0,r.jsx)(n.h2,{id:"\u4f18\u5148\u7ea7\u961f\u5217",children:"\u4f18\u5148\u7ea7\u961f\u5217"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:'args.put("x-max-priority", 10);\n'})}),"\n",(0,r.jsx)(n.p,{children:"\u53ea\u6709\u5728\u79ef\u538b\u65f6\u4f18\u5148\u7ea7\u66f4\u660e\u663e\uff0c\u4e14\u4f1a\u589e\u52a0\u8d44\u6e90\u5f00\u9500\u3002"}),"\n",(0,r.jsx)(n.h2,{id:"\u961f\u5217\u7c7b\u578bclassic-vs-quorum-vs-stream",children:"\u961f\u5217\u7c7b\u578b\uff1aClassic vs Quorum vs Stream"}),"\n",(0,r.jsx)(n.h2,{id:"classic\u7ecf\u5178\u961f\u5217",children:"Classic\uff08\u7ecf\u5178\u961f\u5217\uff09"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"\u9ed8\u8ba4\u7c7b\u578b"}),"\n",(0,r.jsx)(n.li,{children:"\u6027\u80fd\u597d\uff0c\u529f\u80fd\u6210\u719f"}),"\n",(0,r.jsx)(n.li,{children:"\u9002\u5408\u591a\u6570\u573a\u666f"}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"quorum\u4ef2\u88c1\u961f\u5217\u63a8\u8350\u65b0\u9879\u76ee\u4f18\u5148",children:"Quorum\uff08\u4ef2\u88c1\u961f\u5217\uff0c\u63a8\u8350\u65b0\u9879\u76ee\u4f18\u5148\uff09"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"\u57fa\u4e8e Raft"}),"\n",(0,r.jsx)(n.li,{children:"\u66f4\u5f3a\u4e00\u81f4\u6027\u4e0e\u66f4\u7a33\u5b9a\u7684\u6545\u969c\u6062\u590d"}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:'args.put("x-queue-type", "quorum");\n'})}),"\n",(0,r.jsx)(n.h2,{id:"stream\u6d41\u961f\u5217",children:"Stream\uff08\u6d41\u961f\u5217\uff09"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"\u9002\u5408\u5927\u541e\u5410\u3001\u4fdd\u7559\u8f83\u957f\u5386\u53f2\u3001\u4ee5\u53ca\u201c\u53ef\u56de\u6eaf\u6d88\u8d39\u201d\u7684\u573a\u666f"}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:'args.put("x-queue-type", "stream");\nargs.put("x-max-length-bytes", 20_000_000_000L);\n'})}),"\n",(0,r.jsx)(n.h2,{id:"\u4e0e\u6d88\u8d39\u786e\u8ba4ack\u8054\u52a8\u7684\u8981\u70b9",children:"\u4e0e\u6d88\u8d39\u786e\u8ba4\uff08ack\uff09\u8054\u52a8\u7684\u8981\u70b9"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\u4f7f\u7528\u624b\u52a8 ack \u65f6\uff0c",(0,r.jsx)(n.code,{children:"messages_unacknowledged"})," \u4f1a\u589e\u957f\uff1b\u9884\u53d6\u503c\u8fc7\u5927\u53ef\u80fd\u5bfc\u81f4\u5927\u91cf unacked \u5360\u7528\u5185\u5b58"]}),"\n",(0,r.jsxs)(n.li,{children:["\u5904\u7406\u5931\u8d25\u65f6\uff1a","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"requeue=true"})," \u53ef\u80fd\u5bfc\u81f4\u201c\u6bd2\u4e38\u6d88\u606f\u201d\u53cd\u590d\u91cd\u8bd5"]}),"\n",(0,r.jsxs)(n.li,{children:["\u66f4\u7a33\u59a5\u7684\u662f\u7ed3\u5408 DLX/\u91cd\u8bd5\u961f\u5217/\u5ef6\u8fdf\u91cd\u8bd5\uff08\u89c1 ",(0,r.jsx)(n.code,{children:"message-types"})," \u4e0e ",(0,r.jsx)(n.code,{children:"consumer"}),"\uff09"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"\u4e0b\u4e00\u6b65",children:"\u4e0b\u4e00\u6b65"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\ud83d\udcbb ",(0,r.jsx)(n.a,{href:"/docs/rabbitmq/exchanges",children:"\u4ea4\u6362\u673a\u8be6\u89e3"})," - \u5148\u641e\u61c2\u8def\u7531\uff0c\u518d\u914d\u7f6e\u961f\u5217"]}),"\n",(0,r.jsxs)(n.li,{children:["\ud83c\udfaf ",(0,r.jsx)(n.a,{href:"/docs/rabbitmq/message-types",children:"\u6d88\u606f\u7c7b\u578b\u8be6\u89e3"})," - TTL+DLX \u5ef6\u8fdf\u3001\u4f18\u5148\u7ea7\u3001\u5e42\u7b49\u7b49"]}),"\n",(0,r.jsxs)(n.li,{children:["\ud83d\udcca ",(0,r.jsx)(n.a,{href:"/docs/rabbitmq/consumer",children:"\u6d88\u8d39\u8005\u6307\u5357"})," - \u624b\u52a8 ack\u3001nack/requeue \u4e0e\u91cd\u8bd5\u7b56\u7565"]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(u,{...e})}):u(e)}},48885:(e,n,s)=>{s.d(n,{R:()=>a,x:()=>c});var l=s(99378);const r={},i=l.createContext(r);function a(e){const n=l.useContext(i);return l.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:a(e.components),l.createElement(i.Provider,{value:n},e.children)}}}]);