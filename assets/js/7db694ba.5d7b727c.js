"use strict";(globalThis.webpackChunkto_lib_github_io=globalThis.webpackChunkto_lib_github_io||[]).push([[4130],{37133:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>t,contentTitle:()=>d,default:()=>R,frontMatter:()=>E,metadata:()=>r,toc:()=>a});const r=JSON.parse('{"id":"postgres/views-triggers","title":"\u89c6\u56fe\u4e0e\u89e6\u53d1\u5668","description":"\u89c6\u56fe\uff08View\uff09","source":"@site/docs/postgres/views-triggers.md","sourceDirName":"postgres","slug":"/postgres/views-triggers","permalink":"/docs/postgres/views-triggers","draft":false,"unlisted":false,"editUrl":"https://github.com/to-lib/to-lib.github.io/tree/main/docs/postgres/views-triggers.md","tags":[],"version":"current","sidebarPosition":8,"frontMatter":{"sidebar_position":8,"title":"\u89c6\u56fe\u4e0e\u89e6\u53d1\u5668"},"sidebar":"postgres","previous":{"title":"\u5b58\u50a8\u8fc7\u7a0b\u4e0e\u51fd\u6570","permalink":"/docs/postgres/stored-procedures"},"next":{"title":"\u6027\u80fd\u4f18\u5316","permalink":"/docs/postgres/performance-optimization"}}');var i=s(22714),l=s(48885);const E={sidebar_position:8,title:"\u89c6\u56fe\u4e0e\u89e6\u53d1\u5668"},d="PostgreSQL \u89c6\u56fe\u4e0e\u89e6\u53d1\u5668",t={},a=[{value:"\u89c6\u56fe\uff08View\uff09",id:"\u89c6\u56feview",level:2},{value:"\u4ec0\u4e48\u662f\u89c6\u56fe",id:"\u4ec0\u4e48\u662f\u89c6\u56fe",level:3},{value:"\u521b\u5efa\u89c6\u56fe",id:"\u521b\u5efa\u89c6\u56fe",level:3},{value:"\u89c6\u56fe\u7684\u4f18\u52bf",id:"\u89c6\u56fe\u7684\u4f18\u52bf",level:3},{value:"\u590d\u6742\u89c6\u56fe\u793a\u4f8b",id:"\u590d\u6742\u89c6\u56fe\u793a\u4f8b",level:3},{value:"\u53ef\u66f4\u65b0\u89c6\u56fe",id:"\u53ef\u66f4\u65b0\u89c6\u56fe",level:3},{value:"\u4f7f\u7528\u89c4\u5219\u4f7f\u89c6\u56fe\u53ef\u66f4\u65b0",id:"\u4f7f\u7528\u89c4\u5219\u4f7f\u89c6\u56fe\u53ef\u66f4\u65b0",level:3},{value:"\u7ba1\u7406\u89c6\u56fe",id:"\u7ba1\u7406\u89c6\u56fe",level:3},{value:"\u7269\u5316\u89c6\u56fe\uff08Materialized View\uff09",id:"\u7269\u5316\u89c6\u56fematerialized-view",level:2},{value:"\u4ec0\u4e48\u662f\u7269\u5316\u89c6\u56fe",id:"\u4ec0\u4e48\u662f\u7269\u5316\u89c6\u56fe",level:3},{value:"\u521b\u5efa\u7269\u5316\u89c6\u56fe",id:"\u521b\u5efa\u7269\u5316\u89c6\u56fe",level:3},{value:"\u89c6\u56fe vs \u7269\u5316\u89c6\u56fe",id:"\u89c6\u56fe-vs-\u7269\u5316\u89c6\u56fe",level:3},{value:"\u89e6\u53d1\u5668\uff08Trigger\uff09",id:"\u89e6\u53d1\u5668trigger",level:2},{value:"\u4ec0\u4e48\u662f\u89e6\u53d1\u5668",id:"\u4ec0\u4e48\u662f\u89e6\u53d1\u5668",level:3},{value:"\u89e6\u53d1\u5668\u7c7b\u578b",id:"\u89e6\u53d1\u5668\u7c7b\u578b",level:3},{value:"\u521b\u5efa\u89e6\u53d1\u5668",id:"\u521b\u5efa\u89e6\u53d1\u5668",level:3},{value:"BEFORE INSERT \u89e6\u53d1\u5668",id:"before-insert-\u89e6\u53d1\u5668",level:3},{value:"AFTER INSERT \u89e6\u53d1\u5668",id:"after-insert-\u89e6\u53d1\u5668",level:3},{value:"BEFORE UPDATE \u89e6\u53d1\u5668",id:"before-update-\u89e6\u53d1\u5668",level:3},{value:"AFTER DELETE \u89e6\u53d1\u5668",id:"after-delete-\u89e6\u53d1\u5668",level:3},{value:"NEW \u548c OLD \u53d8\u91cf",id:"new-\u548c-old-\u53d8\u91cf",level:3},{value:"\u6761\u4ef6\u89e6\u53d1\u5668",id:"\u6761\u4ef6\u89e6\u53d1\u5668",level:3},{value:"INSTEAD OF \u89e6\u53d1\u5668\uff08\u89c6\u56fe\uff09",id:"instead-of-\u89e6\u53d1\u5668\u89c6\u56fe",level:3},{value:"\u7ba1\u7406\u89e6\u53d1\u5668",id:"\u7ba1\u7406\u89e6\u53d1\u5668",level:3},{value:"\u5b9e\u7528\u793a\u4f8b",id:"\u5b9e\u7528\u793a\u4f8b",level:2},{value:"\u5ba1\u8ba1\u65e5\u5fd7\u7cfb\u7edf",id:"\u5ba1\u8ba1\u65e5\u5fd7\u7cfb\u7edf",level:3},{value:"\u6570\u636e\u9a8c\u8bc1\u89e6\u53d1\u5668",id:"\u6570\u636e\u9a8c\u8bc1\u89e6\u53d1\u5668",level:3},{value:"\u81ea\u52a8\u7f13\u5b58\u5931\u6548",id:"\u81ea\u52a8\u7f13\u5b58\u5931\u6548",level:3},{value:"\u6700\u4f73\u5b9e\u8df5",id:"\u6700\u4f73\u5b9e\u8df5",level:2},{value:"\u6027\u80fd\u8003\u8651",id:"\u6027\u80fd\u8003\u8651",level:2},{value:"\u89c6\u56fe\u6027\u80fd\u4f18\u5316",id:"\u89c6\u56fe\u6027\u80fd\u4f18\u5316",level:3},{value:"\u89e6\u53d1\u5668\u6027\u80fd\u4f18\u5316",id:"\u89e6\u53d1\u5668\u6027\u80fd\u4f18\u5316",level:3},{value:"\u603b\u7ed3",id:"\u603b\u7ed3",level:2}];function c(e){const n={a:"a",blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,l.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"postgresql-\u89c6\u56fe\u4e0e\u89e6\u53d1\u5668",children:"PostgreSQL \u89c6\u56fe\u4e0e\u89e6\u53d1\u5668"})}),"\n",(0,i.jsx)(n.h2,{id:"\u89c6\u56feview",children:"\u89c6\u56fe\uff08View\uff09"}),"\n",(0,i.jsx)(n.h3,{id:"\u4ec0\u4e48\u662f\u89c6\u56fe",children:"\u4ec0\u4e48\u662f\u89c6\u56fe"}),"\n",(0,i.jsx)(n.p,{children:"\u89c6\u56fe\u662f\u57fa\u4e8e SQL \u67e5\u8be2\u7ed3\u679c\u7684\u865a\u62df\u8868\u3002\u89c6\u56fe\u4e0d\u5b58\u50a8\u6570\u636e\uff0c\u6570\u636e\u6765\u81ea\u57fa\u8868\u3002"}),"\n",(0,i.jsx)(n.h3,{id:"\u521b\u5efa\u89c6\u56fe",children:"\u521b\u5efa\u89c6\u56fe"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:"-- \u57fa\u672c\u8bed\u6cd5\nCREATE VIEW view_name AS\nSELECT column1, column2\nFROM table_name\nWHERE condition;\n\n-- \u793a\u4f8b\uff1a\u521b\u5efa\u6d3b\u8dc3\u7528\u6237\u89c6\u56fe\nCREATE VIEW v_active_users AS\nSELECT id, username, email, created_at\nFROM users\nWHERE is_active = true;\n\n-- \u4f7f\u7528\u89c6\u56fe\nSELECT * FROM v_active_users;\n"})}),"\n",(0,i.jsx)(n.h3,{id:"\u89c6\u56fe\u7684\u4f18\u52bf",children:"\u89c6\u56fe\u7684\u4f18\u52bf"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\u2705 ",(0,i.jsx)(n.strong,{children:"\u7b80\u5316\u590d\u6742\u67e5\u8be2"}),"\uff1a\u5c06\u590d\u6742\u7684 JOIN \u548c\u5b50\u67e5\u8be2\u5c01\u88c5"]}),"\n",(0,i.jsxs)(n.li,{children:["\u2705 ",(0,i.jsx)(n.strong,{children:"\u63d0\u9ad8\u5b89\u5168\u6027"}),"\uff1a\u9690\u85cf\u654f\u611f\u5217\uff0c\u53ea\u66b4\u9732\u5fc5\u8981\u6570\u636e"]}),"\n",(0,i.jsxs)(n.li,{children:["\u2705 ",(0,i.jsx)(n.strong,{children:"\u6570\u636e\u72ec\u7acb\u6027"}),"\uff1a\u4fee\u6539\u5e95\u5c42\u8868\u7ed3\u6784\u65f6\uff0c\u89c6\u56fe\u53ef\u4fdd\u6301\u63a5\u53e3\u7a33\u5b9a"]}),"\n",(0,i.jsxs)(n.li,{children:["\u2705 ",(0,i.jsx)(n.strong,{children:"\u4ee3\u7801\u590d\u7528"}),"\uff1a\u907f\u514d\u91cd\u590d\u7f16\u5199\u76f8\u540c\u7684\u67e5\u8be2\u903b\u8f91"]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"\u590d\u6742\u89c6\u56fe\u793a\u4f8b",children:"\u590d\u6742\u89c6\u56fe\u793a\u4f8b"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:"-- \u8ba2\u5355\u7edf\u8ba1\u89c6\u56fe\nCREATE VIEW v_order_statistics AS\nSELECT\n    u.id AS user_id,\n    u.username,\n    COUNT(o.id) AS total_orders,\n    COALESCE(SUM(o.total), 0) AS total_amount,\n    COALESCE(AVG(o.total), 0) AS avg_amount,\n    MAX(o.created_at) AS last_order_date\nFROM users u\nLEFT JOIN orders o ON u.id = o.user_id\nGROUP BY u.id, u.username;\n\n-- \u4f7f\u7528\u89c6\u56fe\nSELECT * FROM v_order_statistics\nWHERE total_orders > 10\nORDER BY total_amount DESC;\n"})}),"\n",(0,i.jsx)(n.h3,{id:"\u53ef\u66f4\u65b0\u89c6\u56fe",children:"\u53ef\u66f4\u65b0\u89c6\u56fe"}),"\n",(0,i.jsx)(n.p,{children:"PostgreSQL \u652f\u6301\u81ea\u52a8\u53ef\u66f4\u65b0\u7684\u89c6\u56fe\uff1a"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:"-- \u7b80\u5355\u89c6\u56fe\uff08\u53ef\u66f4\u65b0\uff09\nCREATE VIEW v_user_contact AS\nSELECT id, username, email, phone\nFROM users;\n\n-- \u53ef\u4ee5\u76f4\u63a5\u66f4\u65b0\u89c6\u56fe\nUPDATE v_user_contact\nSET email = 'newemail@example.com'\nWHERE id = 1;\n\n-- \u53ef\u4ee5\u63d2\u5165\nINSERT INTO v_user_contact (username, email, phone)\nVALUES ('john_doe', 'john@example.com', '1234567890');\n\n-- \u53ef\u4ee5\u5220\u9664\nDELETE FROM v_user_contact WHERE id = 1;\n"})}),"\n",(0,i.jsxs)(n.blockquote,{children:["\n",(0,i.jsxs)(n.p,{children:["[!WARNING] > ",(0,i.jsx)(n.strong,{children:"\u4e0d\u53ef\u81ea\u52a8\u66f4\u65b0\u7684\u89c6\u56fe"}),"\u5305\u542b\uff1a"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"\u805a\u5408\u51fd\u6570\uff08SUM, COUNT, AVG \u7b49\uff09"}),"\n",(0,i.jsx)(n.li,{children:"DISTINCT\u3001GROUP BY\u3001HAVING"}),"\n",(0,i.jsx)(n.li,{children:"UNION\u3001INTERSECT\u3001EXCEPT"}),"\n",(0,i.jsx)(n.li,{children:"\u7a97\u53e3\u51fd\u6570"}),"\n",(0,i.jsx)(n.li,{children:"\u591a\u8868 JOIN\uff08\u67d0\u4e9b\u60c5\u51b5\uff09"}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"\u4f7f\u7528\u89c4\u5219\u4f7f\u89c6\u56fe\u53ef\u66f4\u65b0",children:"\u4f7f\u7528\u89c4\u5219\u4f7f\u89c6\u56fe\u53ef\u66f4\u65b0"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:"-- \u521b\u5efa\u590d\u6742\u89c6\u56fe\nCREATE VIEW v_user_orders AS\nSELECT u.id, u.username, o.order_number, o.total\nFROM users u\nJOIN orders o ON u.id = o.user_id;\n\n-- \u521b\u5efa INSTEAD OF \u89c4\u5219\u4f7f\u5176\u53ef\u63d2\u5165\nCREATE RULE insert_user_order AS\nON INSERT TO v_user_orders\nDO INSTEAD\nINSERT INTO orders (user_id, order_number, total)\nVALUES (NEW.id, NEW.order_number, NEW.total);\n"})}),"\n",(0,i.jsx)(n.h3,{id:"\u7ba1\u7406\u89c6\u56fe",children:"\u7ba1\u7406\u89c6\u56fe"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:"-- \u67e5\u770b\u6240\u6709\u89c6\u56fe\nSELECT table_name, view_definition\nFROM information_schema.views\nWHERE table_schema = 'public';\n\n-- \u6216\u4f7f\u7528 psql \u547d\u4ee4\n\\dv\n\n-- \u67e5\u770b\u89c6\u56fe\u5b9a\u4e49\n\\d+ view_name\n\n-- \u4fee\u6539\u89c6\u56fe\uff08CREATE OR REPLACE\uff09\nCREATE OR REPLACE VIEW v_active_users AS\nSELECT id, username, email, phone, created_at\nFROM users\nWHERE is_active = true AND last_login > NOW() - INTERVAL '30 days';\n\n-- \u5220\u9664\u89c6\u56fe\nDROP VIEW IF EXISTS v_active_users;\n\n-- \u7ea7\u8054\u5220\u9664\u4f9d\u8d56\u8be5\u89c6\u56fe\u7684\u5bf9\u8c61\nDROP VIEW v_active_users CASCADE;\n"})}),"\n",(0,i.jsx)(n.h2,{id:"\u7269\u5316\u89c6\u56fematerialized-view",children:"\u7269\u5316\u89c6\u56fe\uff08Materialized View\uff09"}),"\n",(0,i.jsx)(n.h3,{id:"\u4ec0\u4e48\u662f\u7269\u5316\u89c6\u56fe",children:"\u4ec0\u4e48\u662f\u7269\u5316\u89c6\u56fe"}),"\n",(0,i.jsx)(n.p,{children:"\u7269\u5316\u89c6\u56fe\u4f1a\u5b9e\u9645\u5b58\u50a8\u67e5\u8be2\u7ed3\u679c\uff0c\u9700\u8981\u624b\u52a8\u5237\u65b0\u6570\u636e\u3002"}),"\n",(0,i.jsx)(n.h3,{id:"\u521b\u5efa\u7269\u5316\u89c6\u56fe",children:"\u521b\u5efa\u7269\u5316\u89c6\u56fe"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:"-- \u521b\u5efa\u7269\u5316\u89c6\u56fe\nCREATE MATERIALIZED VIEW mv_daily_sales AS\nSELECT\n    DATE(created_at) AS sale_date,\n    COUNT(*) AS order_count,\n    SUM(total) AS total_sales,\n    AVG(total) AS avg_sales\nFROM orders\nGROUP BY DATE(created_at);\n\n-- \u5237\u65b0\u7269\u5316\u89c6\u56fe\nREFRESH MATERIALIZED VIEW mv_daily_sales;\n\n-- \u5e76\u53d1\u5237\u65b0\uff08\u4e0d\u9501\u5b9a\u89c6\u56fe\uff09\nREFRESH MATERIALIZED VIEW CONCURRENTLY mv_daily_sales;\n\n-- \u4e3a\u7269\u5316\u89c6\u56fe\u521b\u5efa\u7d22\u5f15\nCREATE UNIQUE INDEX idx_mv_daily_sales_date ON mv_daily_sales(sale_date);\n"})}),"\n",(0,i.jsx)(n.h3,{id:"\u89c6\u56fe-vs-\u7269\u5316\u89c6\u56fe",children:"\u89c6\u56fe vs \u7269\u5316\u89c6\u56fe"}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"\u7279\u6027"}),(0,i.jsx)(n.th,{children:"\u666e\u901a\u89c6\u56fe"}),(0,i.jsx)(n.th,{children:"\u7269\u5316\u89c6\u56fe"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"\u6570\u636e\u5b58\u50a8"}),(0,i.jsx)(n.td,{children:"\u4e0d\u5b58\u50a8"}),(0,i.jsx)(n.td,{children:"\u5b58\u50a8\u67e5\u8be2\u7ed3\u679c"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"\u67e5\u8be2\u6027\u80fd"}),(0,i.jsx)(n.td,{children:"\u6bcf\u6b21\u6267\u884c\u67e5\u8be2"}),(0,i.jsx)(n.td,{children:"\u76f4\u63a5\u8bfb\u53d6\u5b58\u50a8\u7684\u6570\u636e"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"\u6570\u636e\u5b9e\u65f6\u6027"}),(0,i.jsx)(n.td,{children:"\u5b9e\u65f6"}),(0,i.jsx)(n.td,{children:"\u9700\u8981\u624b\u52a8\u5237\u65b0"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"\u78c1\u76d8\u7a7a\u95f4"}),(0,i.jsx)(n.td,{children:"\u4e0d\u5360\u7528"}),(0,i.jsx)(n.td,{children:"\u5360\u7528\u7a7a\u95f4"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"\u7d22\u5f15\u652f\u6301"}),(0,i.jsx)(n.td,{children:"\u4e0d\u652f\u6301"}),(0,i.jsx)(n.td,{children:"\u652f\u6301"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"\u4f7f\u7528\u573a\u666f"}),(0,i.jsx)(n.td,{children:"\u7b80\u5316\u67e5\u8be2\u8bed\u6cd5"}),(0,i.jsx)(n.td,{children:"\u590d\u6742\u805a\u5408\u7edf\u8ba1"})]})]})]}),"\n",(0,i.jsx)(n.h2,{id:"\u89e6\u53d1\u5668trigger",children:"\u89e6\u53d1\u5668\uff08Trigger\uff09"}),"\n",(0,i.jsx)(n.h3,{id:"\u4ec0\u4e48\u662f\u89e6\u53d1\u5668",children:"\u4ec0\u4e48\u662f\u89e6\u53d1\u5668"}),"\n",(0,i.jsx)(n.p,{children:"\u89e6\u53d1\u5668\u662f\u5728\u7279\u5b9a\u6570\u636e\u5e93\u4e8b\u4ef6\uff08INSERT\u3001UPDATE\u3001DELETE\uff09\u53d1\u751f\u65f6\u81ea\u52a8\u6267\u884c\u7684\u51fd\u6570\u3002"}),"\n",(0,i.jsx)(n.h3,{id:"\u89e6\u53d1\u5668\u7c7b\u578b",children:"\u89e6\u53d1\u5668\u7c7b\u578b"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"\u6309\u65f6\u673a\u5206\u7c7b\uff1a"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"BEFORE"}),"\uff1a\u5728\u64cd\u4f5c\u6267\u884c\u524d\u89e6\u53d1"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"AFTER"}),"\uff1a\u5728\u64cd\u4f5c\u6267\u884c\u540e\u89e6\u53d1"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"INSTEAD OF"}),"\uff1a\u66ff\u4ee3\u64cd\u4f5c\u6267\u884c\uff08\u4ec5\u7528\u4e8e\u89c6\u56fe\uff09"]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"\u6309\u7ea7\u522b\u5206\u7c7b\uff1a"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\u884c\u7ea7\u89e6\u53d1\u5668\uff08",(0,i.jsx)(n.code,{children:"FOR EACH ROW"}),"\uff09\uff1a\u6bcf\u884c\u89e6\u53d1\u4e00\u6b21"]}),"\n",(0,i.jsxs)(n.li,{children:["\u8bed\u53e5\u7ea7\u89e6\u53d1\u5668\uff08",(0,i.jsx)(n.code,{children:"FOR EACH STATEMENT"}),"\uff09\uff1a\u6bcf\u4e2a\u8bed\u53e5\u89e6\u53d1\u4e00\u6b21"]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"\u521b\u5efa\u89e6\u53d1\u5668",children:"\u521b\u5efa\u89e6\u53d1\u5668"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:"-- 1. \u5148\u521b\u5efa\u89e6\u53d1\u5668\u51fd\u6570\nCREATE OR REPLACE FUNCTION update_modified_time()\nRETURNS TRIGGER AS $$\nBEGIN\n    NEW.updated_at = NOW();\n    RETURN NEW;\nEND;\n$$ LANGUAGE plpgsql;\n\n-- 2. \u521b\u5efa\u89e6\u53d1\u5668\nCREATE TRIGGER trigger_update_user_time\nBEFORE UPDATE ON users\nFOR EACH ROW\nEXECUTE FUNCTION update_modified_time();\n"})}),"\n",(0,i.jsx)(n.h3,{id:"before-insert-\u89e6\u53d1\u5668",children:"BEFORE INSERT \u89e6\u53d1\u5668"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:"-- \u81ea\u52a8\u751f\u6210 UUID\nCREATE OR REPLACE FUNCTION generate_uuid()\nRETURNS TRIGGER AS $$\nBEGIN\n    IF NEW.id IS NULL THEN\n        NEW.id = gen_random_uuid();\n    END IF;\n    RETURN NEW;\nEND;\n$$ LANGUAGE plpgsql;\n\nCREATE TRIGGER trigger_generate_user_uuid\nBEFORE INSERT ON users\nFOR EACH ROW\nEXECUTE FUNCTION generate_uuid();\n"})}),"\n",(0,i.jsx)(n.h3,{id:"after-insert-\u89e6\u53d1\u5668",children:"AFTER INSERT \u89e6\u53d1\u5668"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:"-- \u63d2\u5165\u8ba2\u5355\u540e\u66f4\u65b0\u7edf\u8ba1\nCREATE OR REPLACE FUNCTION update_user_order_stats()\nRETURNS TRIGGER AS $$\nBEGIN\n    UPDATE users\n    SET total_orders = total_orders + 1,\n        total_spent = total_spent + NEW.total\n    WHERE id = NEW.user_id;\n    RETURN NEW;\nEND;\n$$ LANGUAGE plpgsql;\n\nCREATE TRIGGER trigger_after_order_insert\nAFTER INSERT ON orders\nFOR EACH ROW\nEXECUTE FUNCTION update_user_order_stats();\n"})}),"\n",(0,i.jsx)(n.h3,{id:"before-update-\u89e6\u53d1\u5668",children:"BEFORE UPDATE \u89e6\u53d1\u5668"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:"-- \u8bb0\u5f55\u4fee\u6539\u524d\u7684\u6570\u636e\nCREATE OR REPLACE FUNCTION log_price_change()\nRETURNS TRIGGER AS $$\nBEGIN\n    IF OLD.price != NEW.price THEN\n        INSERT INTO price_history (product_id, old_price, new_price, changed_at)\n        VALUES (NEW.id, OLD.price, NEW.price, NOW());\n    END IF;\n    RETURN NEW;\nEND;\n$$ LANGUAGE plpgsql;\n\nCREATE TRIGGER trigger_log_price_change\nBEFORE UPDATE ON products\nFOR EACH ROW\nEXECUTE FUNCTION log_price_change();\n"})}),"\n",(0,i.jsx)(n.h3,{id:"after-delete-\u89e6\u53d1\u5668",children:"AFTER DELETE \u89e6\u53d1\u5668"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:"-- \u5220\u9664\u7528\u6237\u540e\u6e05\u7406\u76f8\u5173\u6570\u636e\nCREATE OR REPLACE FUNCTION cleanup_user_data()\nRETURNS TRIGGER AS $$\nBEGIN\n    DELETE FROM user_sessions WHERE user_id = OLD.id;\n    DELETE FROM user_preferences WHERE user_id = OLD.id;\n\n    -- \u8bb0\u5f55\u5220\u9664\u65e5\u5fd7\n    INSERT INTO deletion_log (table_name, record_id, deleted_at)\n    VALUES ('users', OLD.id, NOW());\n\n    RETURN OLD;\nEND;\n$$ LANGUAGE plpgsql;\n\nCREATE TRIGGER trigger_cleanup_after_user_delete\nAFTER DELETE ON users\nFOR EACH ROW\nEXECUTE FUNCTION cleanup_user_data();\n"})}),"\n",(0,i.jsx)(n.h3,{id:"new-\u548c-old-\u53d8\u91cf",children:"NEW \u548c OLD \u53d8\u91cf"}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"\u89e6\u53d1\u5668\u7c7b\u578b"}),(0,i.jsx)(n.th,{children:"NEW"}),(0,i.jsx)(n.th,{children:"OLD"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"INSERT"}),(0,i.jsx)(n.td,{children:"\u2705 \u53ef\u7528"}),(0,i.jsx)(n.td,{children:"\u274c \u4e0d\u53ef\u7528"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"UPDATE"}),(0,i.jsx)(n.td,{children:"\u2705 \u53ef\u7528"}),(0,i.jsx)(n.td,{children:"\u2705 \u53ef\u7528"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"DELETE"}),(0,i.jsx)(n.td,{children:"\u274c \u4e0d\u53ef\u7528"}),(0,i.jsx)(n.td,{children:"\u2705 \u53ef\u7528"})]})]})]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:"-- \u4f7f\u7528 NEW \u548c OLD\nCREATE OR REPLACE FUNCTION audit_user_changes()\nRETURNS TRIGGER AS $$\nBEGIN\n    IF TG_OP = 'INSERT' THEN\n        INSERT INTO audit_log (operation, table_name, new_data)\n        VALUES ('INSERT', 'users', row_to_json(NEW));\n    ELSIF TG_OP = 'UPDATE' THEN\n        INSERT INTO audit_log (operation, table_name, old_data, new_data)\n        VALUES ('UPDATE', 'users', row_to_json(OLD), row_to_json(NEW));\n    ELSIF TG_OP = 'DELETE' THEN\n        INSERT INTO audit_log (operation, table_name, old_data)\n        VALUES ('DELETE', 'users', row_to_json(OLD));\n    END IF;\n    RETURN NULL;\nEND;\n$$ LANGUAGE plpgsql;\n\nCREATE TRIGGER trigger_audit_users\nAFTER INSERT OR UPDATE OR DELETE ON users\nFOR EACH ROW\nEXECUTE FUNCTION audit_user_changes();\n"})}),"\n",(0,i.jsx)(n.h3,{id:"\u6761\u4ef6\u89e6\u53d1\u5668",children:"\u6761\u4ef6\u89e6\u53d1\u5668"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:"-- \u4ec5\u5728\u7279\u5b9a\u6761\u4ef6\u4e0b\u89e6\u53d1\nCREATE TRIGGER trigger_high_value_order\nAFTER INSERT ON orders\nFOR EACH ROW\nWHEN (NEW.total > 1000)\nEXECUTE FUNCTION notify_high_value_order();\n"})}),"\n",(0,i.jsx)(n.h3,{id:"instead-of-\u89e6\u53d1\u5668\u89c6\u56fe",children:"INSTEAD OF \u89e6\u53d1\u5668\uff08\u89c6\u56fe\uff09"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:"-- \u4e3a\u89c6\u56fe\u521b\u5efa INSTEAD OF \u89e6\u53d1\u5668\nCREATE VIEW v_user_summary AS\nSELECT u.id, u.username, COUNT(o.id) AS order_count\nFROM users u\nLEFT JOIN orders o ON u.id = o.user_id\nGROUP BY u.id, u.username;\n\nCREATE OR REPLACE FUNCTION insert_user_via_view()\nRETURNS TRIGGER AS $$\nBEGIN\n    INSERT INTO users (username, email)\n    VALUES (NEW.username, NEW.username || '@example.com');\n    RETURN NEW;\nEND;\n$$ LANGUAGE plpgsql;\n\nCREATE TRIGGER trigger_insert_user_view\nINSTEAD OF INSERT ON v_user_summary\nFOR EACH ROW\nEXECUTE FUNCTION insert_user_via_view();\n"})}),"\n",(0,i.jsx)(n.h3,{id:"\u7ba1\u7406\u89e6\u53d1\u5668",children:"\u7ba1\u7406\u89e6\u53d1\u5668"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:"-- \u67e5\u770b\u8868\u7684\u6240\u6709\u89e6\u53d1\u5668\nSELECT\n    trigger_name,\n    event_manipulation,\n    event_object_table,\n    action_timing\nFROM information_schema.triggers\nWHERE event_object_schema = 'public';\n\n-- \u6216\u4f7f\u7528 psql \u547d\u4ee4\n\\dft\n\n-- \u67e5\u770b\u89e6\u53d1\u5668\u8be6\u7ec6\u4fe1\u606f\n\\d+ table_name\n\n-- \u7981\u7528\u89e6\u53d1\u5668\nALTER TABLE users DISABLE TRIGGER trigger_name;\n\n-- \u542f\u7528\u89e6\u53d1\u5668\nALTER TABLE users ENABLE TRIGGER trigger_name;\n\n-- \u5220\u9664\u89e6\u53d1\u5668\nDROP TRIGGER IF EXISTS trigger_name ON table_name;\n"})}),"\n",(0,i.jsx)(n.h2,{id:"\u5b9e\u7528\u793a\u4f8b",children:"\u5b9e\u7528\u793a\u4f8b"}),"\n",(0,i.jsx)(n.h3,{id:"\u5ba1\u8ba1\u65e5\u5fd7\u7cfb\u7edf",children:"\u5ba1\u8ba1\u65e5\u5fd7\u7cfb\u7edf"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:"-- \u521b\u5efa\u5ba1\u8ba1\u65e5\u5fd7\u8868\nCREATE TABLE audit_log (\n    id SERIAL PRIMARY KEY,\n    table_name VARCHAR(50),\n    operation VARCHAR(10),\n    user_name VARCHAR(50),\n    old_data JSONB,\n    new_data JSONB,\n    created_at TIMESTAMP DEFAULT NOW()\n);\n\n-- \u901a\u7528\u5ba1\u8ba1\u89e6\u53d1\u5668\u51fd\u6570\nCREATE OR REPLACE FUNCTION audit_trigger_func()\nRETURNS TRIGGER AS $$\nBEGIN\n    INSERT INTO audit_log (\n        table_name,\n        operation,\n        user_name,\n        old_data,\n        new_data\n    )\n    VALUES (\n        TG_TABLE_NAME,\n        TG_OP,\n        current_user,\n        CASE WHEN TG_OP IN ('UPDATE', 'DELETE') THEN row_to_json(OLD) END,\n        CASE WHEN TG_OP IN ('INSERT', 'UPDATE') THEN row_to_json(NEW) END\n    );\n    RETURN NULL;\nEND;\n$$ LANGUAGE plpgsql;\n\n-- \u4e3a\u591a\u4e2a\u8868\u6dfb\u52a0\u5ba1\u8ba1\nCREATE TRIGGER audit_users\nAFTER INSERT OR UPDATE OR DELETE ON users\nFOR EACH ROW EXECUTE FUNCTION audit_trigger_func();\n\nCREATE TRIGGER audit_orders\nAFTER INSERT OR UPDATE OR DELETE ON orders\nFOR EACH ROW EXECUTE FUNCTION audit_trigger_func();\n"})}),"\n",(0,i.jsx)(n.h3,{id:"\u6570\u636e\u9a8c\u8bc1\u89e6\u53d1\u5668",children:"\u6570\u636e\u9a8c\u8bc1\u89e6\u53d1\u5668"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:"CREATE OR REPLACE FUNCTION validate_user_email()\nRETURNS TRIGGER AS $$\nBEGIN\n    -- \u9a8c\u8bc1\u90ae\u7bb1\u683c\u5f0f\n    IF NEW.email !~ '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\\.[A-Z|a-z]{2,}$' THEN\n        RAISE EXCEPTION 'Invalid email format: %', NEW.email;\n    END IF;\n\n    -- \u9a8c\u8bc1\u5e74\u9f84\u8303\u56f4\n    IF NEW.age IS NOT NULL AND (NEW.age < 0 OR NEW.age > 150) THEN\n        RAISE EXCEPTION 'Invalid age: %', NEW.age;\n    END IF;\n\n    RETURN NEW;\nEND;\n$$ LANGUAGE plpgsql;\n\nCREATE TRIGGER validate_user_data\nBEFORE INSERT OR UPDATE ON users\nFOR EACH ROW\nEXECUTE FUNCTION validate_user_email();\n"})}),"\n",(0,i.jsx)(n.h3,{id:"\u81ea\u52a8\u7f13\u5b58\u5931\u6548",children:"\u81ea\u52a8\u7f13\u5b58\u5931\u6548"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:"-- \u5f53\u6570\u636e\u53d8\u5316\u65f6\u901a\u77e5\u5e94\u7528\u5c42\nCREATE OR REPLACE FUNCTION notify_cache_invalidation()\nRETURNS TRIGGER AS $$\nBEGIN\n    PERFORM pg_notify('cache_invalidate', TG_TABLE_NAME || ':' || NEW.id::TEXT);\n    RETURN NEW;\nEND;\n$$ LANGUAGE plpgsql;\n\nCREATE TRIGGER notify_user_changes\nAFTER INSERT OR UPDATE OR DELETE ON users\nFOR EACH ROW\nEXECUTE FUNCTION notify_cache_invalidation();\n"})}),"\n",(0,i.jsx)(n.h2,{id:"\u6700\u4f73\u5b9e\u8df5",children:"\u6700\u4f73\u5b9e\u8df5"}),"\n",(0,i.jsxs)(n.blockquote,{children:["\n",(0,i.jsxs)(n.p,{children:["[!IMPORTANT] > ",(0,i.jsx)(n.strong,{children:"\u89c6\u56fe\u6700\u4f73\u5b9e\u8df5\uff1a"})]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"\u2705 \u7528\u89c6\u56fe\u7b80\u5316\u590d\u6742\u67e5\u8be2\u548c\u9690\u85cf\u654f\u611f\u6570\u636e"}),"\n",(0,i.jsx)(n.li,{children:"\u2705 \u4f7f\u7528\u7269\u5316\u89c6\u56fe\u4f18\u5316\u590d\u6742\u7edf\u8ba1\u67e5\u8be2"}),"\n",(0,i.jsx)(n.li,{children:"\u2705 \u4e3a\u7269\u5316\u89c6\u56fe\u521b\u5efa\u7d22\u5f15\u63d0\u5347\u6027\u80fd"}),"\n",(0,i.jsx)(n.li,{children:"\u2705 \u5b9a\u671f\u5237\u65b0\u7269\u5316\u89c6\u56fe\u4fdd\u6301\u6570\u636e\u65b0\u9c9c"}),"\n",(0,i.jsx)(n.li,{children:"\u274c \u907f\u514d\u89c6\u56fe\u5d4c\u5957\u8fc7\u6df1\uff08\u5f71\u54cd\u6027\u80fd\uff09"}),"\n",(0,i.jsx)(n.li,{children:"\u274c \u4e0d\u8981\u5728\u9ad8\u9891\u67e5\u8be2\u4e2d\u4f7f\u7528\u5305\u542b\u590d\u6742 JOIN \u7684\u89c6\u56fe"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.blockquote,{children:["\n",(0,i.jsxs)(n.p,{children:["[!IMPORTANT] > ",(0,i.jsx)(n.strong,{children:"\u89e6\u53d1\u5668\u6700\u4f73\u5b9e\u8df5\uff1a"})]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"\u2705 \u4fdd\u6301\u89e6\u53d1\u5668\u51fd\u6570\u7b80\u5355\u5feb\u901f"}),"\n",(0,i.jsx)(n.li,{children:"\u2705 \u4f7f\u7528\u6761\u4ef6\u89e6\u53d1\uff08WHEN \u5b50\u53e5\uff09\u51cf\u5c11\u4e0d\u5fc5\u8981\u7684\u6267\u884c"}),"\n",(0,i.jsx)(n.li,{children:"\u2705 \u5728\u89e6\u53d1\u5668\u4e2d\u6dfb\u52a0\u9002\u5f53\u7684\u9519\u8bef\u5904\u7406"}),"\n",(0,i.jsx)(n.li,{children:"\u2705 \u8bb0\u5f55\u89e6\u53d1\u5668\u903b\u8f91\uff0c\u4fbf\u4e8e\u7ef4\u62a4"}),"\n",(0,i.jsx)(n.li,{children:"\u274c \u907f\u514d\u89e6\u53d1\u5668\u4e2d\u7684\u5faa\u73af\u4f9d\u8d56"}),"\n",(0,i.jsx)(n.li,{children:"\u274c \u4e0d\u8981\u5728\u89e6\u53d1\u5668\u4e2d\u6267\u884c\u8017\u65f6\u64cd\u4f5c"}),"\n",(0,i.jsx)(n.li,{children:"\u274c \u614e\u7528 BEFORE \u89e6\u53d1\u5668\u4fee\u6539\u6570\u636e"}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"\u6027\u80fd\u8003\u8651",children:"\u6027\u80fd\u8003\u8651"}),"\n",(0,i.jsx)(n.h3,{id:"\u89c6\u56fe\u6027\u80fd\u4f18\u5316",children:"\u89c6\u56fe\u6027\u80fd\u4f18\u5316"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:"-- \u4e3a\u5e38\u7528\u8fc7\u6ee4\u6761\u4ef6\u521b\u5efa\u7d22\u5f15\nCREATE INDEX idx_users_active ON users(is_active)\nWHERE is_active = true;\n\n-- \u4f7f\u7528 EXPLAIN \u5206\u6790\u89c6\u56fe\u67e5\u8be2\nEXPLAIN ANALYZE SELECT * FROM v_active_users WHERE created_at > '2024-01-01';\n"})}),"\n",(0,i.jsx)(n.h3,{id:"\u89e6\u53d1\u5668\u6027\u80fd\u4f18\u5316",children:"\u89e6\u53d1\u5668\u6027\u80fd\u4f18\u5316"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:"-- \u4f7f\u7528\u8bed\u53e5\u7ea7\u89e6\u53d1\u5668\u800c\u975e\u884c\u7ea7\u89e6\u53d1\u5668\uff08\u9002\u7528\u573a\u666f\uff09\nCREATE TRIGGER trigger_statement_level\nAFTER INSERT ON orders\nFOR EACH STATEMENT\nEXECUTE FUNCTION update_statistics();\n\n-- \u4f7f\u7528\u6761\u4ef6\u51cf\u5c11\u89e6\u53d1\u6b21\u6570\nCREATE TRIGGER trigger_conditional\nAFTER UPDATE ON products\nFOR EACH ROW\nWHEN (OLD.price IS DISTINCT FROM NEW.price)\nEXECUTE FUNCTION log_price_change();\n"})}),"\n",(0,i.jsx)(n.h2,{id:"\u603b\u7ed3",children:"\u603b\u7ed3"}),"\n",(0,i.jsx)(n.p,{children:"PostgreSQL \u7684\u89c6\u56fe\u548c\u89e6\u53d1\u5668\u529f\u80fd\u5f3a\u5927\uff1a"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"\u2705 \u89c6\u56fe\u63d0\u4f9b\u6570\u636e\u62bd\u8c61\u548c\u5b89\u5168\u6027"}),"\n",(0,i.jsx)(n.li,{children:"\u2705 \u7269\u5316\u89c6\u56fe\u4f18\u5316\u590d\u6742\u67e5\u8be2\u6027\u80fd"}),"\n",(0,i.jsx)(n.li,{children:"\u2705 \u89e6\u53d1\u5668\u5b9e\u73b0\u81ea\u52a8\u5316\u4e1a\u52a1\u903b\u8f91"}),"\n",(0,i.jsx)(n.li,{children:"\u2705 \u652f\u6301\u884c\u7ea7\u548c\u8bed\u53e5\u7ea7\u89e6\u53d1\u5668"}),"\n",(0,i.jsx)(n.li,{children:"\u2705 \u4e30\u5bcc\u7684\u89e6\u53d1\u5668\u65f6\u673a\u9009\u62e9"}),"\n",(0,i.jsx)(n.li,{children:"\u2705 \u5b8c\u5584\u7684\u5ba1\u8ba1\u548c\u9a8c\u8bc1\u80fd\u529b"}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["\u7ee7\u7eed\u5b66\u4e60 ",(0,i.jsx)(n.a,{href:"/docs/postgres/stored-procedures",children:"\u5b58\u50a8\u8fc7\u7a0b\u4e0e\u51fd\u6570"})," \u548c ",(0,i.jsx)(n.a,{href:"/docs/postgres/best-practices",children:"\u6700\u4f73\u5b9e\u8df5"}),"\uff01"]})]})}function R(e={}){const{wrapper:n}={...(0,l.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(c,{...e})}):c(e)}},48885:(e,n,s)=>{s.d(n,{R:()=>E,x:()=>d});var r=s(99378);const i={},l=r.createContext(i);function E(e){const n=r.useContext(l);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function d(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:E(e.components),r.createElement(l.Provider,{value:n},e.children)}}}]);