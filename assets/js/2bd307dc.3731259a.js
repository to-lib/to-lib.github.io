"use strict";(globalThis.webpackChunkto_lib_github_io=globalThis.webpackChunkto_lib_github_io||[]).push([[74320],{14469:(n,e,s)=>{s.r(e),s.d(e,{assets:()=>a,contentTitle:()=>d,default:()=>N,frontMatter:()=>r,metadata:()=>l,toc:()=>c});const l=JSON.parse('{"id":"postgres/stored-procedures","title":"\u5b58\u50a8\u8fc7\u7a0b\u4e0e\u51fd\u6570","description":"[!TIP] > \u5b58\u50a8\u8fc7\u7a0b\u4e0e\u51fd\u6570\u4f18\u52bf\uff1a\u63d0\u9ad8\u6027\u80fd\u3001\u51cf\u5c11\u7f51\u7edc\u4f20\u8f93\u3001\u589e\u5f3a\u5b89\u5168\u6027\u3001\u4ee3\u7801\u590d\u7528\u3002PostgreSQL \u652f\u6301\u591a\u79cd\u8fc7\u7a0b\u8bed\u8a00\uff0c\u5176\u4e2d PL/pgSQL \u6700\u4e3a\u5e38\u7528\u3002","source":"@site/docs/postgres/stored-procedures.md","sourceDirName":"postgres","slug":"/postgres/stored-procedures","permalink":"/docs/postgres/stored-procedures","draft":false,"unlisted":false,"editUrl":"https://github.com/to-lib/to-lib.github.io/tree/main/docs/postgres/stored-procedures.md","tags":[],"version":"current","sidebarPosition":7,"frontMatter":{"sidebar_position":7,"title":"\u5b58\u50a8\u8fc7\u7a0b\u4e0e\u51fd\u6570"},"sidebar":"postgres","previous":{"title":"\u89c6\u56fe\u4e0e\u89e6\u53d1\u5668","permalink":"/docs/postgres/views-triggers"},"next":{"title":"\u6027\u80fd\u4f18\u5316","permalink":"/docs/postgres/performance-optimization"}}');var i=s(22714),E=s(48885);const r={sidebar_position:7,title:"\u5b58\u50a8\u8fc7\u7a0b\u4e0e\u51fd\u6570"},d="PostgreSQL \u5b58\u50a8\u8fc7\u7a0b\u4e0e\u51fd\u6570",a={},c=[{value:"\u51fd\u6570\u57fa\u7840",id:"\u51fd\u6570\u57fa\u7840",level:2},{value:"\u4ec0\u4e48\u662f\u51fd\u6570",id:"\u4ec0\u4e48\u662f\u51fd\u6570",level:3},{value:"\u521b\u5efa\u7b80\u5355\u51fd\u6570",id:"\u521b\u5efa\u7b80\u5355\u51fd\u6570",level:3},{value:"\u51fd\u6570\u8fd4\u56de\u7c7b\u578b",id:"\u51fd\u6570\u8fd4\u56de\u7c7b\u578b",level:3},{value:"PL/pgSQL \u8bed\u8a00",id:"plpgsql-\u8bed\u8a00",level:2},{value:"\u53d8\u91cf\u58f0\u660e",id:"\u53d8\u91cf\u58f0\u660e",level:3},{value:"\u53c2\u6570\u6a21\u5f0f",id:"\u53c2\u6570\u6a21\u5f0f",level:3},{value:"\u6d41\u7a0b\u63a7\u5236",id:"\u6d41\u7a0b\u63a7\u5236",level:2},{value:"IF \u6761\u4ef6\u8bed\u53e5",id:"if-\u6761\u4ef6\u8bed\u53e5",level:3},{value:"CASE \u8868\u8fbe\u5f0f",id:"case-\u8868\u8fbe\u5f0f",level:3},{value:"\u5faa\u73af",id:"\u5faa\u73af",level:3},{value:"\u5b58\u50a8\u8fc7\u7a0b\uff08PROCEDURE\uff09",id:"\u5b58\u50a8\u8fc7\u7a0bprocedure",level:2},{value:"\u521b\u5efa\u5b58\u50a8\u8fc7\u7a0b",id:"\u521b\u5efa\u5b58\u50a8\u8fc7\u7a0b",level:3},{value:"\u51fd\u6570 vs \u5b58\u50a8\u8fc7\u7a0b",id:"\u51fd\u6570-vs-\u5b58\u50a8\u8fc7\u7a0b",level:3},{value:"\u89e6\u53d1\u5668\u51fd\u6570",id:"\u89e6\u53d1\u5668\u51fd\u6570",level:2},{value:"\u521b\u5efa\u89e6\u53d1\u5668\u51fd\u6570",id:"\u521b\u5efa\u89e6\u53d1\u5668\u51fd\u6570",level:3},{value:"\u89e6\u53d1\u5668\u7279\u6b8a\u53d8\u91cf",id:"\u89e6\u53d1\u5668\u7279\u6b8a\u53d8\u91cf",level:3},{value:"\u9519\u8bef\u5904\u7406",id:"\u9519\u8bef\u5904\u7406",level:2},{value:"\u5f02\u5e38\u5904\u7406",id:"\u5f02\u5e38\u5904\u7406",level:3},{value:"\u81ea\u5b9a\u4e49\u5f02\u5e38",id:"\u81ea\u5b9a\u4e49\u5f02\u5e38",level:3},{value:"\u52a8\u6001 SQL",id:"\u52a8\u6001-sql",level:2},{value:"EXECUTE \u8bed\u53e5",id:"execute-\u8bed\u53e5",level:3},{value:"\u5b9e\u7528\u793a\u4f8b",id:"\u5b9e\u7528\u793a\u4f8b",level:2},{value:"\u6279\u91cf\u6570\u636e\u5904\u7406",id:"\u6279\u91cf\u6570\u636e\u5904\u7406",level:3},{value:"\u6570\u636e\u7edf\u8ba1\u51fd\u6570",id:"\u6570\u636e\u7edf\u8ba1\u51fd\u6570",level:3},{value:"\u51fd\u6570\u7ba1\u7406",id:"\u51fd\u6570\u7ba1\u7406",level:2},{value:"\u67e5\u770b\u51fd\u6570",id:"\u67e5\u770b\u51fd\u6570",level:3},{value:"\u5220\u9664\u548c\u4fee\u6539",id:"\u5220\u9664\u548c\u4fee\u6539",level:3},{value:"\u51fd\u6570\u5c5e\u6027",id:"\u51fd\u6570\u5c5e\u6027",level:3},{value:"\u6700\u4f73\u5b9e\u8df5",id:"\u6700\u4f73\u5b9e\u8df5",level:2},{value:"\u6027\u80fd\u4f18\u5316",id:"\u6027\u80fd\u4f18\u5316",level:2},{value:"\u4f7f\u7528 STABLE/IMMUTABLE",id:"\u4f7f\u7528-stableimmutable",level:3},{value:"\u4f7f\u7528 SQL \u51fd\u6570",id:"\u4f7f\u7528-sql-\u51fd\u6570",level:3},{value:"\u603b\u7ed3",id:"\u603b\u7ed3",level:2}];function t(n){const e={a:"a",blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,E.R)(),...n.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(e.header,{children:(0,i.jsx)(e.h1,{id:"postgresql-\u5b58\u50a8\u8fc7\u7a0b\u4e0e\u51fd\u6570",children:"PostgreSQL \u5b58\u50a8\u8fc7\u7a0b\u4e0e\u51fd\u6570"})}),"\n",(0,i.jsxs)(e.blockquote,{children:["\n",(0,i.jsxs)(e.p,{children:["[!TIP] > ",(0,i.jsx)(e.strong,{children:"\u5b58\u50a8\u8fc7\u7a0b\u4e0e\u51fd\u6570\u4f18\u52bf"}),"\uff1a\u63d0\u9ad8\u6027\u80fd\u3001\u51cf\u5c11\u7f51\u7edc\u4f20\u8f93\u3001\u589e\u5f3a\u5b89\u5168\u6027\u3001\u4ee3\u7801\u590d\u7528\u3002PostgreSQL \u652f\u6301\u591a\u79cd\u8fc7\u7a0b\u8bed\u8a00\uff0c\u5176\u4e2d PL/pgSQL \u6700\u4e3a\u5e38\u7528\u3002"]}),"\n"]}),"\n",(0,i.jsx)(e.h2,{id:"\u51fd\u6570\u57fa\u7840",children:"\u51fd\u6570\u57fa\u7840"}),"\n",(0,i.jsx)(e.h3,{id:"\u4ec0\u4e48\u662f\u51fd\u6570",children:"\u4ec0\u4e48\u662f\u51fd\u6570"}),"\n",(0,i.jsx)(e.p,{children:"PostgreSQL \u4e2d\u7684\u51fd\u6570\u662f\u53ef\u91cd\u7528\u7684\u4ee3\u7801\u5757\uff0c\u53ef\u4ee5\u63a5\u53d7\u53c2\u6570\u5e76\u8fd4\u56de\u503c\u3002"}),"\n",(0,i.jsx)(e.h3,{id:"\u521b\u5efa\u7b80\u5355\u51fd\u6570",children:"\u521b\u5efa\u7b80\u5355\u51fd\u6570"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-sql",children:"-- \u521b\u5efa\u8fd4\u56de\u6574\u6570\u7684\u51fd\u6570\nCREATE FUNCTION add_numbers(a INTEGER, b INTEGER)\nRETURNS INTEGER\nAS $$\nBEGIN\n    RETURN a + b;\nEND;\n$$ LANGUAGE plpgsql;\n\n-- \u8c03\u7528\u51fd\u6570\nSELECT add_numbers(3, 5);  -- 8\n"})}),"\n",(0,i.jsx)(e.h3,{id:"\u51fd\u6570\u8fd4\u56de\u7c7b\u578b",children:"\u51fd\u6570\u8fd4\u56de\u7c7b\u578b"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-sql",children:"-- \u8fd4\u56de\u5355\u4e2a\u503c\nCREATE FUNCTION get_user_count()\nRETURNS BIGINT\nAS $$\nBEGIN\n    RETURN (SELECT COUNT(*) FROM users);\nEND;\n$$ LANGUAGE plpgsql;\n\n-- \u8fd4\u56de\u8868\nCREATE FUNCTION get_active_users()\nRETURNS TABLE(id INT, username VARCHAR, email VARCHAR)\nAS $$\nBEGIN\n    RETURN QUERY\n    SELECT id, username, email FROM users WHERE is_active = true;\nEND;\n$$ LANGUAGE plpgsql;\n\n-- \u8c03\u7528\u8fd4\u56de\u8868\u7684\u51fd\u6570\nSELECT * FROM get_active_users();\n"})}),"\n",(0,i.jsx)(e.h2,{id:"plpgsql-\u8bed\u8a00",children:"PL/pgSQL \u8bed\u8a00"}),"\n",(0,i.jsx)(e.h3,{id:"\u53d8\u91cf\u58f0\u660e",children:"\u53d8\u91cf\u58f0\u660e"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-sql",children:"CREATE FUNCTION calculate_discount(\n    original_price NUMERIC,\n    discount_rate NUMERIC\n)\nRETURNS NUMERIC\nAS $$\nDECLARE\n    final_price NUMERIC;\n    tax_rate NUMERIC := 0.08;\nBEGIN\n    final_price := original_price * (1 - discount_rate);\n    final_price := final_price * (1 + tax_rate);\n    RETURN final_price;\nEND;\n$$ LANGUAGE plpgsql;\n"})}),"\n",(0,i.jsx)(e.h3,{id:"\u53c2\u6570\u6a21\u5f0f",children:"\u53c2\u6570\u6a21\u5f0f"}),"\n",(0,i.jsx)(e.p,{children:"PostgreSQL \u652f\u6301 IN\u3001OUT\u3001INOUT \u53c2\u6570\uff1a"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-sql",children:"-- OUT \u53c2\u6570\nCREATE FUNCTION get_user_info(\n    user_id INT,\n    OUT username VARCHAR,\n    OUT email VARCHAR,\n    OUT age INT\n)\nAS $$\nBEGIN\n    SELECT u.username, u.email, EXTRACT(YEAR FROM AGE(u.birth_date))\n    INTO username, email, age\n    FROM users u\n    WHERE u.id = user_id;\nEND;\n$$ LANGUAGE plpgsql;\n\n-- \u8c03\u7528\nSELECT * FROM get_user_info(1);\n\n-- INOUT \u53c2\u6570\nCREATE FUNCTION square_number(INOUT num INTEGER)\nAS $$\nBEGIN\n    num := num * num;\nEND;\n$$ LANGUAGE plpgsql;\n\n-- \u8c03\u7528\nSELECT square_number(5);  -- 25\n"})}),"\n",(0,i.jsx)(e.h2,{id:"\u6d41\u7a0b\u63a7\u5236",children:"\u6d41\u7a0b\u63a7\u5236"}),"\n",(0,i.jsx)(e.h3,{id:"if-\u6761\u4ef6\u8bed\u53e5",children:"IF \u6761\u4ef6\u8bed\u53e5"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-sql",children:"CREATE FUNCTION check_age_category(age INT)\nRETURNS VARCHAR\nAS $$\nBEGIN\n    IF age < 18 THEN\n        RETURN '\u672a\u6210\u5e74';\n    ELSIF age >= 18 AND age < 60 THEN\n        RETURN '\u6210\u5e74';\n    ELSE\n        RETURN '\u8001\u5e74';\n    END IF;\nEND;\n$$ LANGUAGE plpgsql;\n"})}),"\n",(0,i.jsx)(e.h3,{id:"case-\u8868\u8fbe\u5f0f",children:"CASE \u8868\u8fbe\u5f0f"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-sql",children:"CREATE FUNCTION get_grade(score INT)\nRETURNS CHAR\nAS $$\nBEGIN\n    RETURN CASE\n        WHEN score >= 90 THEN 'A'\n        WHEN score >= 80 THEN 'B'\n        WHEN score >= 70 THEN 'C'\n        WHEN score >= 60 THEN 'D'\n        ELSE 'F'\n    END;\nEND;\n$$ LANGUAGE plpgsql;\n"})}),"\n",(0,i.jsx)(e.h3,{id:"\u5faa\u73af",children:"\u5faa\u73af"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-sql",children:"-- LOOP\nCREATE FUNCTION sum_to_n(n INT)\nRETURNS INT\nAS $$\nDECLARE\n    i INT := 1;\n    total INT := 0;\nBEGIN\n    LOOP\n        EXIT WHEN i > n;\n        total := total + i;\n        i := i + 1;\n    END LOOP;\n    RETURN total;\nEND;\n$$ LANGUAGE plpgsql;\n\n-- WHILE\nCREATE FUNCTION factorial(n INT)\nRETURNS BIGINT\nAS $$\nDECLARE\n    result BIGINT := 1;\n    i INT := 1;\nBEGIN\n    WHILE i <= n LOOP\n        result := result * i;\n        i := i + 1;\n    END LOOP;\n    RETURN result;\nEND;\n$$ LANGUAGE plpgsql;\n\n-- FOR\nCREATE FUNCTION fibonacci(n INT)\nRETURNS INT[]\nAS $$\nDECLARE\n    fib INT[] := ARRAY[0, 1];\n    i INT;\nBEGIN\n    FOR i IN 3..n LOOP\n        fib := fib || (fib[i-1] + fib[i-2]);\n    END LOOP;\n    RETURN fib;\nEND;\n$$ LANGUAGE plpgsql;\n"})}),"\n",(0,i.jsx)(e.h2,{id:"\u5b58\u50a8\u8fc7\u7a0bprocedure",children:"\u5b58\u50a8\u8fc7\u7a0b\uff08PROCEDURE\uff09"}),"\n",(0,i.jsx)(e.p,{children:"PostgreSQL 11+ \u652f\u6301\u771f\u6b63\u7684\u5b58\u50a8\u8fc7\u7a0b\u3002"}),"\n",(0,i.jsx)(e.h3,{id:"\u521b\u5efa\u5b58\u50a8\u8fc7\u7a0b",children:"\u521b\u5efa\u5b58\u50a8\u8fc7\u7a0b"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-sql",children:"-- \u5b58\u50a8\u8fc7\u7a0b\u53ef\u4ee5\u5305\u542b\u4e8b\u52a1\u63a7\u5236\nCREATE PROCEDURE transfer_money(\n    from_account INT,\n    to_account INT,\n    amount NUMERIC\n)\nLANGUAGE plpgsql\nAS $$\nBEGIN\n    -- \u51cf\u5c11\u8f6c\u51fa\u8d26\u6237\u4f59\u989d\n    UPDATE accounts SET balance = balance - amount\n    WHERE account_id = from_account;\n\n    -- \u589e\u52a0\u8f6c\u5165\u8d26\u6237\u4f59\u989d\n    UPDATE accounts SET balance = balance + amount\n    WHERE account_id = to_account;\n\n    COMMIT;\nEND;\n$$;\n\n-- \u8c03\u7528\u5b58\u50a8\u8fc7\u7a0b\nCALL transfer_money(1, 2, 100.00);\n"})}),"\n",(0,i.jsx)(e.h3,{id:"\u51fd\u6570-vs-\u5b58\u50a8\u8fc7\u7a0b",children:"\u51fd\u6570 vs \u5b58\u50a8\u8fc7\u7a0b"}),"\n",(0,i.jsxs)(e.table,{children:[(0,i.jsx)(e.thead,{children:(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.th,{children:"\u7279\u6027"}),(0,i.jsx)(e.th,{children:"\u51fd\u6570\uff08FUNCTION\uff09"}),(0,i.jsx)(e.th,{children:"\u5b58\u50a8\u8fc7\u7a0b\uff08PROCEDURE\uff09"})]})}),(0,i.jsxs)(e.tbody,{children:[(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:"\u8fd4\u56de\u503c"}),(0,i.jsx)(e.td,{children:"\u5fc5\u987b\u8fd4\u56de\u503c"}),(0,i.jsx)(e.td,{children:"\u4e0d\u8fd4\u56de\u503c\uff08\u53ef\u7528 OUT \u53c2\u6570\uff09"})]}),(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:"\u8c03\u7528\u65b9\u5f0f"}),(0,i.jsx)(e.td,{children:"SELECT \u6216\u8868\u8fbe\u5f0f\u4e2d"}),(0,i.jsx)(e.td,{children:"CALL \u8bed\u53e5"})]}),(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:"\u4e8b\u52a1\u63a7\u5236"}),(0,i.jsx)(e.td,{children:"\u4e0d\u80fd\u4f7f\u7528 COMMIT/ROLLBACK"}),(0,i.jsx)(e.td,{children:"\u53ef\u4ee5\u4f7f\u7528 COMMIT/ROLLBACK"})]}),(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:"\u53c2\u6570"}),(0,i.jsx)(e.td,{children:"IN, OUT, INOUT"}),(0,i.jsx)(e.td,{children:"IN, OUT, INOUT"})]}),(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:"\u4f7f\u7528\u573a\u666f"}),(0,i.jsx)(e.td,{children:"\u8ba1\u7b97\u3001\u67e5\u8be2"}),(0,i.jsx)(e.td,{children:"\u590d\u6742\u4e1a\u52a1\u903b\u8f91\u3001\u6279\u91cf\u5904\u7406"})]})]})]}),"\n",(0,i.jsx)(e.h2,{id:"\u89e6\u53d1\u5668\u51fd\u6570",children:"\u89e6\u53d1\u5668\u51fd\u6570"}),"\n",(0,i.jsx)(e.h3,{id:"\u521b\u5efa\u89e6\u53d1\u5668\u51fd\u6570",children:"\u521b\u5efa\u89e6\u53d1\u5668\u51fd\u6570"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-sql",children:"-- \u521b\u5efa\u5ba1\u8ba1\u65e5\u5fd7\u89e6\u53d1\u5668\u51fd\u6570\nCREATE OR REPLACE FUNCTION audit_user_changes()\nRETURNS TRIGGER\nAS $$\nBEGIN\n    IF TG_OP = 'INSERT' THEN\n        INSERT INTO audit_log (table_name, operation, user_id, timestamp)\n        VALUES ('users', 'INSERT', NEW.id, NOW());\n        RETURN NEW;\n    ELSIF TG_OP = 'UPDATE' THEN\n        INSERT INTO audit_log (table_name, operation, user_id, old_data, new_data, timestamp)\n        VALUES ('users', 'UPDATE', NEW.id, row_to_json(OLD), row_to_json(NEW), NOW());\n        RETURN NEW;\n    ELSIF TG_OP = 'DELETE' THEN\n        INSERT INTO audit_log (table_name, operation, user_id, old_data, timestamp)\n        VALUES ('users', 'DELETE', OLD.id, row_to_json(OLD), NOW());\n        RETURN OLD;\n    END IF;\nEND;\n$$ LANGUAGE plpgsql;\n\n-- \u521b\u5efa\u89e6\u53d1\u5668\nCREATE TRIGGER user_audit_trigger\nAFTER INSERT OR UPDATE OR DELETE ON users\nFOR EACH ROW\nEXECUTE FUNCTION audit_user_changes();\n"})}),"\n",(0,i.jsx)(e.h3,{id:"\u89e6\u53d1\u5668\u7279\u6b8a\u53d8\u91cf",children:"\u89e6\u53d1\u5668\u7279\u6b8a\u53d8\u91cf"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.code,{children:"NEW"}),"\uff1aINSERT/UPDATE \u64cd\u4f5c\u4e2d\u7684\u65b0\u884c"]}),"\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.code,{children:"OLD"}),"\uff1aUPDATE/DELETE \u64cd\u4f5c\u4e2d\u7684\u8001\u884c"]}),"\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.code,{children:"TG_OP"}),"\uff1a\u64cd\u4f5c\u7c7b\u578b\uff08INSERT\u3001UPDATE\u3001DELETE\uff09"]}),"\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.code,{children:"TG_TABLE_NAME"}),"\uff1a\u89e6\u53d1\u5668\u6240\u5728\u7684\u8868\u540d"]}),"\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.code,{children:"TG_WHEN"}),"\uff1aBEFORE \u6216 AFTER"]}),"\n"]}),"\n",(0,i.jsx)(e.h2,{id:"\u9519\u8bef\u5904\u7406",children:"\u9519\u8bef\u5904\u7406"}),"\n",(0,i.jsx)(e.h3,{id:"\u5f02\u5e38\u5904\u7406",children:"\u5f02\u5e38\u5904\u7406"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-sql",children:"CREATE FUNCTION safe_divide(a NUMERIC, b NUMERIC)\nRETURNS NUMERIC\nAS $$\nBEGIN\n    RETURN a / b;\nEXCEPTION\n    WHEN division_by_zero THEN\n        RAISE NOTICE 'Division by zero detected';\n        RETURN NULL;\n    WHEN OTHERS THEN\n        RAISE NOTICE 'An error occurred: %', SQLERRM;\n        RETURN NULL;\nEND;\n$$ LANGUAGE plpgsql;\n"})}),"\n",(0,i.jsx)(e.h3,{id:"\u81ea\u5b9a\u4e49\u5f02\u5e38",children:"\u81ea\u5b9a\u4e49\u5f02\u5e38"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-sql",children:"CREATE FUNCTION check_balance(account_id INT, withdraw_amount NUMERIC)\nRETURNS VOID\nAS $$\nDECLARE\n    current_balance NUMERIC;\nBEGIN\n    SELECT balance INTO current_balance\n    FROM accounts\n    WHERE id = account_id;\n\n    IF current_balance < withdraw_amount THEN\n        RAISE EXCEPTION 'Insufficient funds. Balance: %, Withdraw: %',\n            current_balance, withdraw_amount;\n    END IF;\nEND;\n$$ LANGUAGE plpgsql;\n"})}),"\n",(0,i.jsx)(e.h2,{id:"\u52a8\u6001-sql",children:"\u52a8\u6001 SQL"}),"\n",(0,i.jsx)(e.h3,{id:"execute-\u8bed\u53e5",children:"EXECUTE \u8bed\u53e5"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-sql",children:"CREATE FUNCTION create_user_table(table_name TEXT)\nRETURNS VOID\nAS $$\nBEGIN\n    EXECUTE format('\n        CREATE TABLE %I (\n            id SERIAL PRIMARY KEY,\n            username VARCHAR(50),\n            created_at TIMESTAMP DEFAULT NOW()\n        )', table_name);\nEND;\n$$ LANGUAGE plpgsql;\n\n-- \u52a8\u6001\u67e5\u8be2\nCREATE FUNCTION get_table_count(table_name TEXT)\nRETURNS BIGINT\nAS $$\nDECLARE\n    row_count BIGINT;\nBEGIN\n    EXECUTE format('SELECT COUNT(*) FROM %I', table_name)\n    INTO row_count;\n    RETURN row_count;\nEND;\n$$ LANGUAGE plpgsql;\n"})}),"\n",(0,i.jsx)(e.h2,{id:"\u5b9e\u7528\u793a\u4f8b",children:"\u5b9e\u7528\u793a\u4f8b"}),"\n",(0,i.jsx)(e.h3,{id:"\u6279\u91cf\u6570\u636e\u5904\u7406",children:"\u6279\u91cf\u6570\u636e\u5904\u7406"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-sql",children:"CREATE PROCEDURE batch_update_user_status()\nLANGUAGE plpgsql\nAS $$\nDECLARE\n    batch_size INT := 1000;\n    processed INT := 0;\n    total INT;\nBEGIN\n    SELECT COUNT(*) INTO total\n    FROM users\n    WHERE last_login < NOW() - INTERVAL '1 year';\n\n    WHILE processed < total LOOP\n        UPDATE users\n        SET is_active = false\n        WHERE id IN (\n            SELECT id FROM users\n            WHERE last_login < NOW() - INTERVAL '1 year'\n            AND is_active = true\n            LIMIT batch_size\n        );\n\n        processed := processed + batch_size;\n        RAISE NOTICE 'Processed % of % users', processed, total;\n        COMMIT;\n    END LOOP;\nEND;\n$$;\n"})}),"\n",(0,i.jsx)(e.h3,{id:"\u6570\u636e\u7edf\u8ba1\u51fd\u6570",children:"\u6570\u636e\u7edf\u8ba1\u51fd\u6570"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-sql",children:"CREATE FUNCTION user_statistics()\nRETURNS TABLE(\n    total_users BIGINT,\n    active_users BIGINT,\n    inactive_users BIGINT,\n    avg_age NUMERIC\n)\nAS $$\nBEGIN\n    RETURN QUERY\n    SELECT\n        COUNT(*) as total,\n        COUNT(*) FILTER (WHERE is_active = true) as active,\n        COUNT(*) FILTER (WHERE is_active = false) as inactive,\n        AVG(EXTRACT(YEAR FROM AGE(birth_date))) as avg_age\n    FROM users;\nEND;\n$$ LANGUAGE plpgsql;\n\n-- \u8c03\u7528\nSELECT * FROM user_statistics();\n"})}),"\n",(0,i.jsx)(e.h2,{id:"\u51fd\u6570\u7ba1\u7406",children:"\u51fd\u6570\u7ba1\u7406"}),"\n",(0,i.jsx)(e.h3,{id:"\u67e5\u770b\u51fd\u6570",children:"\u67e5\u770b\u51fd\u6570"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-sql",children:"-- \u67e5\u770b\u6240\u6709\u51fd\u6570\nSELECT\n    n.nspname as schema,\n    p.proname as name,\n    pg_get_function_arguments(p.oid) as arguments,\n    pg_get_function_result(p.oid) as result_type\nFROM pg_proc p\nJOIN pg_namespace n ON p.pronamespace = n.oid\nWHERE n.nspname = 'public';\n\n-- \u67e5\u770b\u51fd\u6570\u5b9a\u4e49\n\\df+ function_name\n\n-- \u67e5\u770b\u51fd\u6570\u6e90\u7801\nSELECT pg_get_functiondef(oid)\nFROM pg_proc\nWHERE proname = 'function_name';\n"})}),"\n",(0,i.jsx)(e.h3,{id:"\u5220\u9664\u548c\u4fee\u6539",children:"\u5220\u9664\u548c\u4fee\u6539"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-sql",children:"-- \u5220\u9664\u51fd\u6570\nDROP FUNCTION IF EXISTS function_name;\nDROP FUNCTION IF EXISTS function_name(INT, VARCHAR);  -- \u6307\u5b9a\u53c2\u6570\n\n-- \u66ff\u6362\u51fd\u6570\uff08CREATE OR REPLACE\uff09\nCREATE OR REPLACE FUNCTION add_numbers(a INT, b INT)\nRETURNS INT\nAS $$\nBEGIN\n    RETURN a + b;\nEND;\n$$ LANGUAGE plpgsql;\n"})}),"\n",(0,i.jsx)(e.h3,{id:"\u51fd\u6570\u5c5e\u6027",children:"\u51fd\u6570\u5c5e\u6027"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-sql",children:"CREATE FUNCTION expensive_calculation(n INT)\nRETURNS INT\nPARALLEL SAFE          -- \u53ef\u5e76\u884c\u6267\u884c\nIMMUTABLE             -- \u76f8\u540c\u8f93\u5165\u603b\u8fd4\u56de\u76f8\u540c\u7ed3\u679c\nSTRICT                -- NULL \u8f93\u5165\u8fd4\u56de NULL\nAS $$\nBEGIN\n    RETURN n * n;\nEND;\n$$ LANGUAGE plpgsql;\n"})}),"\n",(0,i.jsx)(e.h2,{id:"\u6700\u4f73\u5b9e\u8df5",children:"\u6700\u4f73\u5b9e\u8df5"}),"\n",(0,i.jsxs)(e.blockquote,{children:["\n",(0,i.jsxs)(e.p,{children:["[!IMPORTANT] > ",(0,i.jsx)(e.strong,{children:"\u5b58\u50a8\u8fc7\u7a0b\u4e0e\u51fd\u6570\u6700\u4f73\u5b9e\u8df5\uff1a"})]}),"\n",(0,i.jsxs)(e.ol,{children:["\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.strong,{children:"\u547d\u540d\u89c4\u8303"}),"\uff1a\u4f7f\u7528\u63cf\u8ff0\u6027\u540d\u79f0\uff0c\u5982 ",(0,i.jsx)(e.code,{children:"get_user_by_id"})]}),"\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.strong,{children:"\u53c2\u6570\u9a8c\u8bc1"}),"\uff1a\u5728\u51fd\u6570\u5f00\u59cb\u5904\u9a8c\u8bc1\u53c2\u6570"]}),"\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.strong,{children:"\u9519\u8bef\u5904\u7406"}),"\uff1a\u4f7f\u7528 EXCEPTION \u5904\u7406\u53ef\u80fd\u7684\u9519\u8bef"]}),"\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.strong,{children:"\u907f\u514d\u8fc7\u5ea6\u4f7f\u7528"}),"\uff1a\u590d\u6742\u4e1a\u52a1\u903b\u8f91\u53ef\u80fd\u66f4\u9002\u5408\u5e94\u7528\u5c42"]}),"\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.strong,{children:"\u6027\u80fd\u8003\u8651"}),"\uff1a\u4f7f\u7528 ",(0,i.jsx)(e.code,{children:"IMMUTABLE"}),"\u3001",(0,i.jsx)(e.code,{children:"STABLE"}),"\u3001",(0,i.jsx)(e.code,{children:"VOLATILE"})," \u6b63\u786e\u6807\u8bb0"]}),"\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.strong,{children:"\u5b89\u5168\u6027"}),"\uff1a\u4f7f\u7528 ",(0,i.jsx)(e.code,{children:"SECURITY DEFINER"})," \u65f6\u8981\u7279\u522b\u5c0f\u5fc3"]}),"\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.strong,{children:"\u6587\u6863\u6ce8\u91ca"}),"\uff1a\u4f7f\u7528 ",(0,i.jsx)(e.code,{children:"COMMENT ON FUNCTION"})," \u6dfb\u52a0\u8bf4\u660e"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-sql",children:"-- \u6dfb\u52a0\u51fd\u6570\u6ce8\u91ca\nCOMMENT ON FUNCTION add_numbers(INT, INT) IS '\u8ba1\u7b97\u4e24\u4e2a\u6574\u6570\u7684\u548c';\n"})}),"\n",(0,i.jsx)(e.h2,{id:"\u6027\u80fd\u4f18\u5316",children:"\u6027\u80fd\u4f18\u5316"}),"\n",(0,i.jsx)(e.h3,{id:"\u4f7f\u7528-stableimmutable",children:"\u4f7f\u7528 STABLE/IMMUTABLE"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-sql",children:"-- IMMUTABLE\uff1a\u76f8\u540c\u8f93\u5165\u59cb\u7ec8\u8fd4\u56de\u76f8\u540c\u7ed3\u679c\nCREATE FUNCTION circle_area(radius NUMERIC)\nRETURNS NUMERIC\nIMMUTABLE\nAS $$\nBEGIN\n    RETURN 3.14159 * radius * radius;\nEND;\n$$ LANGUAGE plpgsql;\n\n-- STABLE\uff1a\u540c\u4e00\u4e8b\u52a1\u5185\u76f8\u540c\u8f93\u5165\u8fd4\u56de\u76f8\u540c\u7ed3\u679c\nCREATE FUNCTION get_current_date_formatted()\nRETURNS TEXT\nSTABLE\nAS $$\nBEGIN\n    RETURN TO_CHAR(CURRENT_DATE, 'YYYY-MM-DD');\nEND;\n$$ LANGUAGE plpgsql;\n"})}),"\n",(0,i.jsx)(e.h3,{id:"\u4f7f\u7528-sql-\u51fd\u6570",children:"\u4f7f\u7528 SQL \u51fd\u6570"}),"\n",(0,i.jsx)(e.p,{children:"\u5bf9\u4e8e\u7b80\u5355\u903b\u8f91\uff0cSQL \u51fd\u6570\u6bd4 PL/pgSQL \u66f4\u5feb\uff1a"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-sql",children:"-- SQL \u51fd\u6570\uff08\u66f4\u5feb\uff09\nCREATE FUNCTION get_user_email(user_id INT)\nRETURNS VARCHAR\nAS $$\n    SELECT email FROM users WHERE id = user_id;\n$$ LANGUAGE sql;\n\n-- PL/pgSQL \u51fd\u6570\uff08\u7075\u6d3b\u4f46\u7a0d\u6162\uff09\nCREATE FUNCTION get_user_email_plpgsql(user_id INT)\nRETURNS VARCHAR\nAS $$\nDECLARE\n    user_email VARCHAR;\nBEGIN\n    SELECT email INTO user_email FROM users WHERE id = user_id;\n    RETURN user_email;\nEND;\n$$ LANGUAGE plpgsql;\n"})}),"\n",(0,i.jsx)(e.h2,{id:"\u603b\u7ed3",children:"\u603b\u7ed3"}),"\n",(0,i.jsx)(e.p,{children:"PostgreSQL \u7684\u51fd\u6570\u548c\u5b58\u50a8\u8fc7\u7a0b\u529f\u80fd\u5f3a\u5927\uff1a"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"\u2705 \u652f\u6301\u591a\u79cd\u8fc7\u7a0b\u8bed\u8a00\uff08PL/pgSQL\u3001PL/Python\u3001PL/Perl \u7b49\uff09"}),"\n",(0,i.jsx)(e.li,{children:"\u2705 \u51fd\u6570\u53ef\u8fd4\u56de\u6807\u91cf\u503c\u3001\u8bb0\u5f55\u6216\u8868"}),"\n",(0,i.jsx)(e.li,{children:"\u2705 \u5b58\u50a8\u8fc7\u7a0b\u652f\u6301\u4e8b\u52a1\u63a7\u5236"}),"\n",(0,i.jsx)(e.li,{children:"\u2705 \u89e6\u53d1\u5668\u51fd\u6570\u5b9e\u73b0\u81ea\u52a8\u5316\u64cd\u4f5c"}),"\n",(0,i.jsx)(e.li,{children:"\u2705 \u5f02\u5e38\u5904\u7406\u548c\u52a8\u6001 SQL"}),"\n",(0,i.jsx)(e.li,{children:"\u2705 \u4e30\u5bcc\u7684\u6027\u80fd\u4f18\u5316\u9009\u9879"}),"\n"]}),"\n",(0,i.jsxs)(e.p,{children:["\u7ee7\u7eed\u5b66\u4e60 ",(0,i.jsx)(e.a,{href:"/docs/postgres/views-triggers",children:"\u89c6\u56fe\u4e0e\u89e6\u53d1\u5668"})," \u548c ",(0,i.jsx)(e.a,{href:"/docs/postgres/best-practices",children:"\u6700\u4f73\u5b9e\u8df5"}),"\uff01"]})]})}function N(n={}){const{wrapper:e}={...(0,E.R)(),...n.components};return e?(0,i.jsx)(e,{...n,children:(0,i.jsx)(t,{...n})}):t(n)}},48885:(n,e,s)=>{s.d(e,{R:()=>r,x:()=>d});var l=s(99378);const i={},E=l.createContext(i);function r(n){const e=l.useContext(E);return l.useMemo(function(){return"function"==typeof n?n(e):{...e,...n}},[e,n])}function d(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(i):n.components||i:r(n.components),l.createElement(E.Provider,{value:e},n.children)}}}]);