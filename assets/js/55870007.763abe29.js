"use strict";(globalThis.webpackChunkto_lib_github_io=globalThis.webpackChunkto_lib_github_io||[]).push([[25005],{15090:(e,n,l)=>{l.r(n),l.d(n,{assets:()=>o,contentTitle:()=>c,default:()=>p,frontMatter:()=>a,metadata:()=>i,toc:()=>s});const i=JSON.parse('{"id":"docker/dockerfile","title":"Dockerfile \u7f16\u5199","description":"Dockerfile \u6307\u4ee4\u8be6\u89e3\u4e0e\u6700\u4f73\u5b9e\u8df5","source":"@site/docs/docker/dockerfile.md","sourceDirName":"docker","slug":"/docker/dockerfile","permalink":"/docs/docker/dockerfile","draft":false,"unlisted":false,"editUrl":"https://github.com/to-lib/to-lib.github.io/tree/main/docs/docker/dockerfile.md","tags":[],"version":"current","sidebarPosition":4,"frontMatter":{"sidebar_position":4,"title":"Dockerfile \u7f16\u5199","description":"Dockerfile \u6307\u4ee4\u8be6\u89e3\u4e0e\u6700\u4f73\u5b9e\u8df5"},"sidebar":"docker","previous":{"title":"\u57fa\u7840\u547d\u4ee4","permalink":"/docs/docker/basic-commands"},"next":{"title":"BuildKit \u4e0e buildx","permalink":"/docs/docker/buildkit"}}');var d=l(22714),r=l(48885);const a={sidebar_position:4,title:"Dockerfile \u7f16\u5199",description:"Dockerfile \u6307\u4ee4\u8be6\u89e3\u4e0e\u6700\u4f73\u5b9e\u8df5"},c="Dockerfile \u7f16\u5199",o={},s=[{value:"\u57fa\u672c\u7ed3\u6784",id:"\u57fa\u672c\u7ed3\u6784",level:2},{value:"\u6838\u5fc3\u6307\u4ee4",id:"\u6838\u5fc3\u6307\u4ee4",level:2},{value:"FROM - \u57fa\u7840\u955c\u50cf",id:"from---\u57fa\u7840\u955c\u50cf",level:3},{value:"RUN - \u6267\u884c\u547d\u4ee4",id:"run---\u6267\u884c\u547d\u4ee4",level:3},{value:"COPY \u548c ADD",id:"copy-\u548c-add",level:3},{value:"WORKDIR - \u5de5\u4f5c\u76ee\u5f55",id:"workdir---\u5de5\u4f5c\u76ee\u5f55",level:3},{value:"ENV - \u73af\u5883\u53d8\u91cf",id:"env---\u73af\u5883\u53d8\u91cf",level:3},{value:"ARG - \u6784\u5efa\u53c2\u6570",id:"arg---\u6784\u5efa\u53c2\u6570",level:3},{value:"EXPOSE - \u66b4\u9732\u7aef\u53e3",id:"expose---\u66b4\u9732\u7aef\u53e3",level:3},{value:"CMD \u548c ENTRYPOINT",id:"cmd-\u548c-entrypoint",level:3},{value:"VOLUME - \u6570\u636e\u5377",id:"volume---\u6570\u636e\u5377",level:3},{value:"USER - \u8fd0\u884c\u7528\u6237",id:"user---\u8fd0\u884c\u7528\u6237",level:3},{value:"HEALTHCHECK - \u5065\u5eb7\u68c0\u67e5",id:"healthcheck---\u5065\u5eb7\u68c0\u67e5",level:3},{value:"\u591a\u9636\u6bb5\u6784\u5efa",id:"\u591a\u9636\u6bb5\u6784\u5efa",level:2},{value:"Go \u5e94\u7528\u793a\u4f8b",id:"go-\u5e94\u7528\u793a\u4f8b",level:3},{value:"Node.js \u5e94\u7528\u793a\u4f8b",id:"nodejs-\u5e94\u7528\u793a\u4f8b",level:3},{value:"Java \u5e94\u7528\u793a\u4f8b",id:"java-\u5e94\u7528\u793a\u4f8b",level:3},{value:"\u6700\u4f73\u5b9e\u8df5",id:"\u6700\u4f73\u5b9e\u8df5",level:2},{value:"1. \u4f7f\u7528 .dockerignore",id:"1-\u4f7f\u7528-dockerignore",level:3},{value:"2. \u5408\u5e76 RUN \u6307\u4ee4",id:"2-\u5408\u5e76-run-\u6307\u4ee4",level:3},{value:"3. \u5229\u7528\u6784\u5efa\u7f13\u5b58",id:"3-\u5229\u7528\u6784\u5efa\u7f13\u5b58",level:3},{value:"4. \u4f7f\u7528\u975e root \u7528\u6237",id:"4-\u4f7f\u7528\u975e-root-\u7528\u6237",level:3},{value:"5. \u6307\u5b9a\u786e\u5207\u7248\u672c",id:"5-\u6307\u5b9a\u786e\u5207\u7248\u672c",level:3},{value:"6. \u6e05\u7406\u7f13\u5b58",id:"6-\u6e05\u7406\u7f13\u5b58",level:3},{value:"\u6784\u5efa\u955c\u50cf",id:"\u6784\u5efa\u955c\u50cf",level:2}];function t(e){const n={admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",p:"p",pre:"pre",...(0,r.R)(),...e.components};return(0,d.jsxs)(d.Fragment,{children:[(0,d.jsx)(n.header,{children:(0,d.jsx)(n.h1,{id:"dockerfile-\u7f16\u5199",children:"Dockerfile \u7f16\u5199"})}),"\n",(0,d.jsx)(n.p,{children:"Dockerfile \u662f\u4e00\u4e2a\u6587\u672c\u6587\u4ef6\uff0c\u5305\u542b\u4e86\u6784\u5efa Docker \u955c\u50cf\u6240\u9700\u7684\u6240\u6709\u6307\u4ee4\u3002"}),"\n",(0,d.jsx)(n.h2,{id:"\u57fa\u672c\u7ed3\u6784",children:"\u57fa\u672c\u7ed3\u6784"}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-dockerfile",children:'# \u57fa\u7840\u955c\u50cf\nFROM ubuntu:22.04\n\n# \u7ef4\u62a4\u8005\u4fe1\u606f\nLABEL maintainer="developer@example.com"\n\n# \u8bbe\u7f6e\u73af\u5883\u53d8\u91cf\nENV APP_HOME=/app\n\n# \u8bbe\u7f6e\u5de5\u4f5c\u76ee\u5f55\nWORKDIR $APP_HOME\n\n# \u590d\u5236\u6587\u4ef6\nCOPY . .\n\n# \u8fd0\u884c\u547d\u4ee4\nRUN apt-get update && apt-get install -y nginx\n\n# \u66b4\u9732\u7aef\u53e3\nEXPOSE 80\n\n# \u542f\u52a8\u547d\u4ee4\nCMD ["nginx", "-g", "daemon off;"]\n'})}),"\n",(0,d.jsx)(n.h2,{id:"\u6838\u5fc3\u6307\u4ee4",children:"\u6838\u5fc3\u6307\u4ee4"}),"\n",(0,d.jsx)(n.h3,{id:"from---\u57fa\u7840\u955c\u50cf",children:"FROM - \u57fa\u7840\u955c\u50cf"}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-dockerfile",children:"# \u4f7f\u7528\u5b98\u65b9\u955c\u50cf\nFROM nginx:latest\n\n# \u4f7f\u7528\u7279\u5b9a\u7248\u672c\nFROM node:18-alpine\n\n# \u4f7f\u7528\u591a\u9636\u6bb5\u6784\u5efa\nFROM golang:1.21 AS builder\nFROM alpine:latest\n"})}),"\n",(0,d.jsx)(n.h3,{id:"run---\u6267\u884c\u547d\u4ee4",children:"RUN - \u6267\u884c\u547d\u4ee4"}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-dockerfile",children:'# Shell \u5f62\u5f0f\nRUN apt-get update && apt-get install -y curl\n\n# Exec \u5f62\u5f0f\nRUN ["apt-get", "update"]\n\n# \u591a\u884c\u547d\u4ee4\uff08\u63a8\u8350\uff09\nRUN apt-get update && \\\n    apt-get install -y \\\n        curl \\\n        wget \\\n        vim && \\\n    rm -rf /var/lib/apt/lists/*\n'})}),"\n",(0,d.jsx)(n.h3,{id:"copy-\u548c-add",children:"COPY \u548c ADD"}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-dockerfile",children:"# COPY - \u7b80\u5355\u590d\u5236\nCOPY src/ /app/src/\nCOPY package.json /app/\n\n# COPY \u4f7f\u7528 --chown\nCOPY --chown=user:group files* /app/\n\n# ADD - \u652f\u6301 URL \u548c\u89e3\u538b\nADD https://example.com/file.tar.gz /app/\nADD archive.tar.gz /app/\n"})}),"\n",(0,d.jsx)(n.admonition,{type:"tip",children:(0,d.jsxs)(n.p,{children:["\u4f18\u5148\u4f7f\u7528 ",(0,d.jsx)(n.code,{children:"COPY"}),"\uff0c\u53ea\u6709\u5728\u9700\u8981\u89e3\u538b\u6216\u4ece URL \u4e0b\u8f7d\u65f6\u624d\u4f7f\u7528 ",(0,d.jsx)(n.code,{children:"ADD"}),"\u3002"]})}),"\n",(0,d.jsx)(n.h3,{id:"workdir---\u5de5\u4f5c\u76ee\u5f55",children:"WORKDIR - \u5de5\u4f5c\u76ee\u5f55"}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-dockerfile",children:"WORKDIR /app\nWORKDIR src  # \u76f8\u5bf9\u8def\u5f84\uff0c\u7ed3\u679c\u4e3a /app/src\n"})}),"\n",(0,d.jsx)(n.h3,{id:"env---\u73af\u5883\u53d8\u91cf",children:"ENV - \u73af\u5883\u53d8\u91cf"}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-dockerfile",children:"# \u5355\u4e2a\u53d8\u91cf\nENV NODE_ENV=production\n\n# \u591a\u4e2a\u53d8\u91cf\nENV NODE_ENV=production \\\n    PORT=3000 \\\n    DB_HOST=localhost\n"})}),"\n",(0,d.jsx)(n.h3,{id:"arg---\u6784\u5efa\u53c2\u6570",children:"ARG - \u6784\u5efa\u53c2\u6570"}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-dockerfile",children:'ARG VERSION=latest\nARG BUILD_DATE\n\nFROM node:${VERSION}\n\n# \u4f7f\u7528\u6784\u5efa\u53c2\u6570\nRUN echo "Build date: ${BUILD_DATE}"\n'})}),"\n",(0,d.jsx)(n.p,{children:"\u6784\u5efa\u65f6\u4f20\u9012\u53c2\u6570\uff1a"}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-bash",children:"docker build --build-arg VERSION=18 --build-arg BUILD_DATE=$(date +%Y%m%d) .\n"})}),"\n",(0,d.jsx)(n.h3,{id:"expose---\u66b4\u9732\u7aef\u53e3",children:"EXPOSE - \u66b4\u9732\u7aef\u53e3"}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-dockerfile",children:"EXPOSE 80\nEXPOSE 80/tcp\nEXPOSE 443/tcp 8080/tcp\n"})}),"\n",(0,d.jsx)(n.h3,{id:"cmd-\u548c-entrypoint",children:"CMD \u548c ENTRYPOINT"}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-dockerfile",children:'# CMD - \u9ed8\u8ba4\u547d\u4ee4\uff08\u53ef\u88ab\u8986\u76d6\uff09\nCMD ["nginx", "-g", "daemon off;"]\nCMD nginx -g "daemon off;"\n\n# ENTRYPOINT - \u5165\u53e3\u70b9\uff08\u4e0d\u6613\u88ab\u8986\u76d6\uff09\nENTRYPOINT ["docker-entrypoint.sh"]\nCMD ["nginx", "-g", "daemon off;"]\n'})}),"\n",(0,d.jsx)(n.p,{children:"\u7ec4\u5408\u4f7f\u7528\uff1a"}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-dockerfile",children:'ENTRYPOINT ["python", "app.py"]\nCMD ["--port", "8080"]  # \u53ef\u88ab\u8986\u76d6\u7684\u9ed8\u8ba4\u53c2\u6570\n'})}),"\n",(0,d.jsx)(n.h3,{id:"volume---\u6570\u636e\u5377",children:"VOLUME - \u6570\u636e\u5377"}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-dockerfile",children:'VOLUME /data\nVOLUME ["/data", "/logs"]\n'})}),"\n",(0,d.jsx)(n.h3,{id:"user---\u8fd0\u884c\u7528\u6237",children:"USER - \u8fd0\u884c\u7528\u6237"}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-dockerfile",children:"# \u521b\u5efa\u7528\u6237\u5e76\u5207\u6362\nRUN groupadd -r appgroup && useradd -r -g appgroup appuser\nUSER appuser\n\n# \u4f7f\u7528 UID\nUSER 1000\n"})}),"\n",(0,d.jsx)(n.h3,{id:"healthcheck---\u5065\u5eb7\u68c0\u67e5",children:"HEALTHCHECK - \u5065\u5eb7\u68c0\u67e5"}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-dockerfile",children:"HEALTHCHECK --interval=30s --timeout=10s --retries=3 \\\n    CMD curl -f http://localhost/ || exit 1\n\n# \u7981\u7528\u5065\u5eb7\u68c0\u67e5\nHEALTHCHECK NONE\n"})}),"\n",(0,d.jsx)(n.h2,{id:"\u591a\u9636\u6bb5\u6784\u5efa",children:"\u591a\u9636\u6bb5\u6784\u5efa"}),"\n",(0,d.jsx)(n.h3,{id:"go-\u5e94\u7528\u793a\u4f8b",children:"Go \u5e94\u7528\u793a\u4f8b"}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-dockerfile",children:'# \u6784\u5efa\u9636\u6bb5\nFROM golang:1.21 AS builder\nWORKDIR /app\nCOPY go.mod go.sum ./\nRUN go mod download\nCOPY . .\nRUN CGO_ENABLED=0 GOOS=linux go build -o main .\n\n# \u8fd0\u884c\u9636\u6bb5\nFROM alpine:latest\nRUN apk --no-cache add ca-certificates\nWORKDIR /root/\nCOPY --from=builder /app/main .\nCMD ["./main"]\n'})}),"\n",(0,d.jsx)(n.h3,{id:"nodejs-\u5e94\u7528\u793a\u4f8b",children:"Node.js \u5e94\u7528\u793a\u4f8b"}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-dockerfile",children:'# \u6784\u5efa\u9636\u6bb5\nFROM node:18-alpine AS builder\nWORKDIR /app\nCOPY package*.json ./\nRUN npm ci\nCOPY . .\nRUN npm run build\n\n# \u8fd0\u884c\u9636\u6bb5\nFROM node:18-alpine\nWORKDIR /app\nCOPY --from=builder /app/dist ./dist\nCOPY --from=builder /app/node_modules ./node_modules\nEXPOSE 3000\nCMD ["node", "dist/main.js"]\n'})}),"\n",(0,d.jsx)(n.h3,{id:"java-\u5e94\u7528\u793a\u4f8b",children:"Java \u5e94\u7528\u793a\u4f8b"}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-dockerfile",children:'# \u6784\u5efa\u9636\u6bb5\nFROM maven:3.9-eclipse-temurin-17 AS builder\nWORKDIR /app\nCOPY pom.xml .\nRUN mvn dependency:go-offline\nCOPY src ./src\nRUN mvn package -DskipTests\n\n# \u8fd0\u884c\u9636\u6bb5\nFROM eclipse-temurin:17-jre-alpine\nWORKDIR /app\nCOPY --from=builder /app/target/*.jar app.jar\nEXPOSE 8080\nENTRYPOINT ["java", "-jar", "app.jar"]\n'})}),"\n",(0,d.jsx)(n.h2,{id:"\u6700\u4f73\u5b9e\u8df5",children:"\u6700\u4f73\u5b9e\u8df5"}),"\n",(0,d.jsx)(n.h3,{id:"1-\u4f7f\u7528-dockerignore",children:"1. \u4f7f\u7528 .dockerignore"}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-plaintext",children:"# .dockerignore\nnode_modules\nnpm-debug.log\n.git\n.gitignore\n*.md\nDockerfile\n.dockerignore\n.env\n"})}),"\n",(0,d.jsx)(n.h3,{id:"2-\u5408\u5e76-run-\u6307\u4ee4",children:"2. \u5408\u5e76 RUN \u6307\u4ee4"}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-dockerfile",children:"# \u274c \u4e0d\u63a8\u8350\nRUN apt-get update\nRUN apt-get install -y curl\nRUN apt-get install -y wget\n\n# \u2705 \u63a8\u8350\nRUN apt-get update && \\\n    apt-get install -y curl wget && \\\n    rm -rf /var/lib/apt/lists/*\n"})}),"\n",(0,d.jsx)(n.h3,{id:"3-\u5229\u7528\u6784\u5efa\u7f13\u5b58",children:"3. \u5229\u7528\u6784\u5efa\u7f13\u5b58"}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-dockerfile",children:"# \u2705 \u5148\u590d\u5236\u4f9d\u8d56\u6587\u4ef6\nCOPY package.json package-lock.json ./\nRUN npm ci\n\n# \u518d\u590d\u5236\u6e90\u4ee3\u7801\uff08\u53d8\u5316\u9891\u7e41\uff09\nCOPY . .\n"})}),"\n",(0,d.jsx)(n.h3,{id:"4-\u4f7f\u7528\u975e-root-\u7528\u6237",children:"4. \u4f7f\u7528\u975e root \u7528\u6237"}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-dockerfile",children:"RUN groupadd -r app && useradd -r -g app app\nUSER app\n"})}),"\n",(0,d.jsx)(n.h3,{id:"5-\u6307\u5b9a\u786e\u5207\u7248\u672c",children:"5. \u6307\u5b9a\u786e\u5207\u7248\u672c"}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-dockerfile",children:"# \u274c \u4e0d\u63a8\u8350\nFROM node:latest\n\n# \u2705 \u63a8\u8350\nFROM node:18.19.0-alpine3.19\n"})}),"\n",(0,d.jsx)(n.h3,{id:"6-\u6e05\u7406\u7f13\u5b58",children:"6. \u6e05\u7406\u7f13\u5b58"}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-dockerfile",children:"RUN apt-get update && \\\n    apt-get install -y nginx && \\\n    apt-get clean && \\\n    rm -rf /var/lib/apt/lists/*\n"})}),"\n",(0,d.jsx)(n.h2,{id:"\u6784\u5efa\u955c\u50cf",children:"\u6784\u5efa\u955c\u50cf"}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-bash",children:"# \u57fa\u672c\u6784\u5efa\ndocker build -t myapp:v1 .\n\n# \u6307\u5b9a Dockerfile\ndocker build -f Dockerfile.prod -t myapp:prod .\n\n# \u4e0d\u4f7f\u7528\u7f13\u5b58\ndocker build --no-cache -t myapp:v1 .\n\n# \u591a\u5e73\u53f0\u6784\u5efa\ndocker buildx build --platform linux/amd64,linux/arm64 -t myapp:v1 .\n"})})]})}function p(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,d.jsx)(n,{...e,children:(0,d.jsx)(t,{...e})}):t(e)}},48885:(e,n,l)=>{l.d(n,{R:()=>a,x:()=>c});var i=l(99378);const d={},r=i.createContext(d);function a(e){const n=i.useContext(r);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(d):e.components||d:a(e.components),i.createElement(r.Provider,{value:n},e.children)}}}]);