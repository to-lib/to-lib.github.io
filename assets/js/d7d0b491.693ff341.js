"use strict";(globalThis.webpackChunkto_lib_github_io=globalThis.webpackChunkto_lib_github_io||[]).push([[57684],{48885:(n,e,r)=>{r.d(e,{R:()=>l,x:()=>d});var i=r(99378);const t={},s=i.createContext(t);function l(n){const e=i.useContext(s);return i.useMemo(function(){return"function"==typeof n?n(e):{...e,...n}},[e,n])}function d(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(t):n.components||t:l(n.components),i.createElement(s.Provider,{value:e},n.children)}},86151:(n,e,r)=>{r.r(e),r.d(e,{assets:()=>o,contentTitle:()=>d,default:()=>u,frontMatter:()=>l,metadata:()=>i,toc:()=>a});const i=JSON.parse('{"id":"redis/practical-examples","title":"\u5b9e\u6218\u6848\u4f8b","description":"\u5206\u5e03\u5f0f\u9501","source":"@site/docs/redis/practical-examples.md","sourceDirName":"redis","slug":"/redis/practical-examples","permalink":"/docs/redis/practical-examples","draft":false,"unlisted":false,"editUrl":"https://github.com/to-lib/to-lib.github.io/tree/main/docs/redis/practical-examples.md","tags":[],"version":"current","sidebarPosition":23,"frontMatter":{"sidebar_position":23,"title":"\u5b9e\u6218\u6848\u4f8b"},"sidebar":"redis","previous":{"title":"\u5e38\u89c1\u4e1a\u52a1\u573a\u666f","permalink":"/docs/redis/common-scenarios"},"next":{"title":"\u914d\u7f6e\u4e0e\u90e8\u7f72","permalink":"/docs/redis/configuration"}}');var t=r(22714),s=r(48885);const l={sidebar_position:23,title:"\u5b9e\u6218\u6848\u4f8b"},d="Redis \u5b9e\u6218\u6848\u4f8b",o={},a=[{value:"\u5206\u5e03\u5f0f\u9501",id:"\u5206\u5e03\u5f0f\u9501",level:2},{value:"\u57fa\u7840\u5b9e\u73b0",id:"\u57fa\u7840\u5b9e\u73b0",level:3},{value:"Redisson \u5b9e\u73b0",id:"redisson-\u5b9e\u73b0",level:3},{value:"\u9650\u6d41\u5668",id:"\u9650\u6d41\u5668",level:2},{value:"\u56fa\u5b9a\u7a97\u53e3\u9650\u6d41",id:"\u56fa\u5b9a\u7a97\u53e3\u9650\u6d41",level:3},{value:"\u6ed1\u52a8\u7a97\u53e3\u9650\u6d41",id:"\u6ed1\u52a8\u7a97\u53e3\u9650\u6d41",level:3},{value:"\u4ee4\u724c\u6876\u9650\u6d41",id:"\u4ee4\u724c\u6876\u9650\u6d41",level:3},{value:"\u6392\u884c\u699c\u7cfb\u7edf",id:"\u6392\u884c\u699c\u7cfb\u7edf",level:2},{value:"\u57fa\u672c\u5b9e\u73b0",id:"\u57fa\u672c\u5b9e\u73b0",level:3},{value:"\u793e\u4ea4\u5173\u7cfb",id:"\u793e\u4ea4\u5173\u7cfb",level:2},{value:"\u5173\u6ce8/\u7c89\u4e1d",id:"\u5173\u6ce8\u7c89\u4e1d",level:3},{value:"\u670b\u53cb\u5708",id:"\u670b\u53cb\u5708",level:3},{value:"\u6d88\u606f\u961f\u5217",id:"\u6d88\u606f\u961f\u5217",level:2},{value:"List \u5b9e\u73b0",id:"list-\u5b9e\u73b0",level:3},{value:"Stream \u5b9e\u73b0",id:"stream-\u5b9e\u73b0",level:3},{value:"\u5e93\u5b58\u6263\u51cf",id:"\u5e93\u5b58\u6263\u51cf",level:2},{value:"\u57fa\u7840\u5b9e\u73b0",id:"\u57fa\u7840\u5b9e\u73b0-1",level:3},{value:"\u9884\u51cf\u5e93\u5b58",id:"\u9884\u51cf\u5e93\u5b58",level:3},{value:"\u7b7e\u5230\u7cfb\u7edf",id:"\u7b7e\u5230\u7cfb\u7edf",level:2},{value:"\u603b\u7ed3",id:"\u603b\u7ed3",level:2}];function c(n){const e={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",ul:"ul",...(0,s.R)(),...n.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(e.header,{children:(0,t.jsx)(e.h1,{id:"redis-\u5b9e\u6218\u6848\u4f8b",children:"Redis \u5b9e\u6218\u6848\u4f8b"})}),"\n",(0,t.jsx)(e.h2,{id:"\u5206\u5e03\u5f0f\u9501",children:"\u5206\u5e03\u5f0f\u9501"}),"\n",(0,t.jsx)(e.h3,{id:"\u57fa\u7840\u5b9e\u73b0",children:"\u57fa\u7840\u5b9e\u73b0"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-java",children:'public class RedisLock {\n    private Jedis jedis;\n    private String lockKey;\n    private String requestId;\n\n    public boolean tryLock(int expireTime) {\n        requestId = UUID.randomUUID().toString();\n        String result = jedis.set(\n            lockKey,\n            requestId,\n            "NX",\n            "EX",\n            expireTime\n        );\n        return "OK".equals(result);\n    }\n\n    public void unlock() {\n        String script =\n            "if redis.call(\'GET\', KEYS[1]) == ARGV[1] then " +\n            "  return redis.call(\'DEL\', KEYS[1]) " +\n            "else " +\n            "  return 0 " +\n            "end";\n\n        jedis.eval(script,\n            Collections.singletonList(lockKey),\n            Collections.singletonList(requestId)\n        );\n    }\n}\n'})}),"\n",(0,t.jsx)(e.h3,{id:"redisson-\u5b9e\u73b0",children:"Redisson \u5b9e\u73b0"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-java",children:'@Autowired\nprivate RedissonClient redissonClient;\n\npublic void demo() {\n    RLock lock = redissonClient.getLock("myLock");\n\n    try {\n        // \u5c1d\u8bd5\u52a0\u9501\uff0c\u6700\u591a\u7b49\u5f8510\u79d2\uff0c\u950130\u79d2\u540e\u81ea\u52a8\u91ca\u653e\n        if (lock.tryLock(10, 30, TimeUnit.SECONDS)) {\n            try {\n                // \u4e1a\u52a1\u903b\u8f91\n                doSomething();\n            } finally {\n                lock.unlock();\n            }\n        }\n    } catch (InterruptedException e) {\n        Thread.currentThread().interrupt();\n    }\n}\n'})}),"\n",(0,t.jsx)(e.h2,{id:"\u9650\u6d41\u5668",children:"\u9650\u6d41\u5668"}),"\n",(0,t.jsx)(e.h3,{id:"\u56fa\u5b9a\u7a97\u53e3\u9650\u6d41",children:"\u56fa\u5b9a\u7a97\u53e3\u9650\u6d41"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-java",children:'public boolean isAllowed(String userId, int limit, int window) {\n    String key = "rate:limit:" + userId;\n    Long current = jedis.incr(key);\n\n    if (current == 1) {\n        jedis.expire(key, window);\n    }\n\n    return current <= limit;\n}\n'})}),"\n",(0,t.jsx)(e.h3,{id:"\u6ed1\u52a8\u7a97\u53e3\u9650\u6d41",children:"\u6ed1\u52a8\u7a97\u53e3\u9650\u6d41"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-java",children:'public boolean isAllowed(String userId, int limit, int window) {\n    String key = "rate:limit:" + userId;\n    long now = System.currentTimeMillis();\n\n    // \u5220\u9664window\u4e4b\u5916\u7684\u8bb0\u5f55\n    jedis.zremrangeByScore(key, 0, now - window * 1000);\n\n    // \u7edf\u8ba1window\u5185\u7684\u8bf7\u6c42\u6570\n    long count = jedis.zcard(key);\n\n    if (count < limit) {\n        jedis.zadd(key, now, String.valueOf(now));\n        jedis.expire(key, window + 1);\n        return true;\n    }\n\n    return false;\n}\n'})}),"\n",(0,t.jsx)(e.h3,{id:"\u4ee4\u724c\u6876\u9650\u6d41",children:"\u4ee4\u724c\u6876\u9650\u6d41"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-lua",children:"local key = KEYS[1]\nlocal capacity = tonumber(ARGV[1])\nlocal rate = tonumber(ARGV[2])\nlocal requested = tonumber(ARGV[3])\nlocal now = tonumber(ARGV[4])\n\nlocal tokens_key = key .. ':tokens'\nlocal timestamp_key = key .. ':timestamp'\n\nlocal last_tokens = tonumber(redis.call('GET', tokens_key)) or capacity\nlocal last_time = tonumber(redis.call('GET', timestamp_key)) or now\n\nlocal delta = math.max(0, now - last_time)\nlocal filled_tokens = math.min(capacity, last_tokens + (delta * rate))\n\nif filled_tokens >= requested then\n    local new_tokens = filled_tokens - requested\n    redis.call('SET', tokens_key, new_tokens)\n    redis.call('SET', timestamp_key, now)\n    return 1\nelse\n    return 0\nend\n"})}),"\n",(0,t.jsx)(e.h2,{id:"\u6392\u884c\u699c\u7cfb\u7edf",children:"\u6392\u884c\u699c\u7cfb\u7edf"}),"\n",(0,t.jsx)(e.h3,{id:"\u57fa\u672c\u5b9e\u73b0",children:"\u57fa\u672c\u5b9e\u73b0"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-java",children:'public class Leaderboard {\n    private Jedis jedis;\n    private String key = "leaderboard";\n\n    // \u66f4\u65b0\u5206\u6570\n    public void updateScore(String playerId, double score) {\n        jedis.zadd(key, score, playerId);\n    }\n\n    // \u83b7\u53d6\u6392\u540d\uff08\u4ece1\u5f00\u59cb\uff09\n    public long getRank(String playerId) {\n        Long rank = jedis.zrevrank(key, playerId);\n        return rank == null ? -1 : rank + 1;\n    }\n\n    // \u83b7\u53d6\u5206\u6570\n    public Double getScore(String playerId) {\n        return jedis.zscore(key, playerId);\n    }\n\n    // \u83b7\u53d6Top N\n    public List<Tuple> getTopN(int n) {\n        return jedis.zrevrangeWithScores(key, 0, n - 1);\n    }\n\n    // \u83b7\u53d6\u6392\u540d\u8303\u56f4\n    public List<Tuple> getRangeByRank(long start, long end) {\n        return jedis.zrevrangeWithScores(key, start - 1, end - 1);\n    }\n\n    // \u83b7\u53d6\u6211\u524d\u540e\u7684\u6392\u540d\n    public List<Tuple> getAroundMe(String playerId, int count) {\n        Long rank = jedis.zrevrank(key, playerId);\n        if (rank == null) return Collections.emptyList();\n\n        long start = Math.max(0, rank - count);\n        long end = rank + count;\n\n        return jedis.zrevrangeWithScores(key, start, end);\n    }\n}\n'})}),"\n",(0,t.jsx)(e.h2,{id:"\u793e\u4ea4\u5173\u7cfb",children:"\u793e\u4ea4\u5173\u7cfb"}),"\n",(0,t.jsx)(e.h3,{id:"\u5173\u6ce8\u7c89\u4e1d",children:"\u5173\u6ce8/\u7c89\u4e1d"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-java",children:'public class SocialGraph {\n    private Jedis jedis;\n\n    // \u5173\u6ce8\n    public void follow(String userId, String targetId) {\n        // userId \u5173\u6ce8\u4e86 targetId\n        jedis.sadd("following:" + userId, targetId);\n        // targetId \u7684\u7c89\u4e1d\u589e\u52a0 userId\n        jedis.sadd("followers:" + targetId, userId);\n    }\n\n    // \u53d6\u6d88\u5173\u6ce8\n    public void unfollow(String userId, String targetId) {\n        jedis.srem("following:" + userId, targetId);\n        jedis.srem("followers:" + targetId, userId);\n    }\n\n    // \u5171\u540c\u5173\u6ce8\n    public Set<String> commonFollowing(String userId1, String userId2) {\n        return jedis.sinter(\n            "following:" + userId1,\n            "following:" + userId2\n        );\n    }\n\n    // \u662f\u5426\u4e92\u76f8\u5173\u6ce8\n    public boolean isMutualFollow(String userId1, String userId2) {\n        return jedis.sismember("following:" + userId1, userId2)\n            && jedis.sismember("following:" + userId2, userId1);\n    }\n}\n'})}),"\n",(0,t.jsx)(e.h3,{id:"\u670b\u53cb\u5708",children:"\u670b\u53cb\u5708"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-java",children:'public class Timeline {\n    private Jedis jedis;\n\n    // \u53d1\u5e03\u52a8\u6001\n    public void publish(String userId, String content) {\n        long postId = jedis.incr("post:id");\n\n        // \u4fdd\u5b58\u52a8\u6001\u5185\u5bb9\n        jedis.hmset("post:" + postId, Map.of(\n            "userId", userId,\n            "content", content,\n            "timestamp", String.valueOf(System.currentTimeMillis())\n        ));\n\n        // \u63a8\u9001\u5230\u6240\u6709\u7c89\u4e1d\u7684\u65f6\u95f4\u7ebf\n        Set<String> followers = jedis.smembers("followers:" + userId);\n        for (String follower : followers) {\n            jedis.zadd("timeline:" + follower, postId, String.valueOf(postId));\n        }\n\n        // \u63a8\u9001\u5230\u81ea\u5df1\u7684\u65f6\u95f4\u7ebf\n        jedis.zadd("timeline:" + userId, postId, String.valueOf(postId));\n    }\n\n    // \u83b7\u53d6\u65f6\u95f4\u7ebf\n    public List<Map<String, String>> getTimeline(String userId, int count) {\n        Set<String> postIds = jedis.zrevrange("timeline:" + userId, 0, count - 1);\n\n        List<Map<String, String>> posts = new ArrayList<>();\n        for (String postId : postIds) {\n            Map<String, String> post = jedis.hgetAll("post:" + postId);\n            posts.add(post);\n        }\n\n        return posts;\n    }\n}\n'})}),"\n",(0,t.jsx)(e.h2,{id:"\u6d88\u606f\u961f\u5217",children:"\u6d88\u606f\u961f\u5217"}),"\n",(0,t.jsx)(e.h3,{id:"list-\u5b9e\u73b0",children:"List \u5b9e\u73b0"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-java",children:'// \u751f\u4ea7\u8005\njedis.lpush("queue:tasks", task);\n\n// \u6d88\u8d39\u8005\nwhile (true) {\n    List<String> result = jedis.brpop(5, "queue:tasks");\n    if (result != null) {\n        String task = result.get(1);\n        processTask(task);\n    }\n}\n'})}),"\n",(0,t.jsx)(e.h3,{id:"stream-\u5b9e\u73b0",children:"Stream \u5b9e\u73b0"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-java",children:'// \u751f\u4ea7\u8005\njedis.xadd("stream:tasks", "*", Map.of(\n    "type", "email",\n    "to", "user@example.com",\n    "subject", "Welcome"\n));\n\n// \u6d88\u8d39\u7ec4\njedis.xgroupCreate("stream:tasks", "workers", "0", true);\n\n// \u6d88\u8d39\u8005\nwhile (true) {\n    List<Map.Entry<String, List<StreamEntry>>> result =\n        jedis.xreadGroup(\n            "workers",\n            "worker-1",\n            XReadGroupParams.xReadGroupParams().count(10).block(5000),\n            Map.of("stream:tasks", ">")\n        );\n\n    if (result != null && !result.isEmpty()) {\n        for (Map.Entry<String, List<StreamEntry>> entry : result) {\n            for (StreamEntry msg : entry.getValue()) {\n                processMessage(msg);\n                jedis.xack("stream:tasks", "workers", msg.getID());\n            }\n        }\n    }\n}\n'})}),"\n",(0,t.jsx)(e.h2,{id:"\u5e93\u5b58\u6263\u51cf",children:"\u5e93\u5b58\u6263\u51cf"}),"\n",(0,t.jsx)(e.h3,{id:"\u57fa\u7840\u5b9e\u73b0-1",children:"\u57fa\u7840\u5b9e\u73b0"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-java",children:'public boolean deductStock(String productId, int quantity) {\n    String key = "stock:" + productId;\n\n    String script =\n        "local stock = redis.call(\'GET\', KEYS[1]) " +\n        "if not stock or tonumber(stock) < tonumber(ARGV[1]) then " +\n        "  return 0 " +\n        "end " +\n        "redis.call(\'DECRBY\', KEYS[1], ARGV[1]) " +\n        "return 1";\n\n    Long result = (Long) jedis.eval(\n        script,\n        Collections.singletonList(key),\n        Collections.singletonList(String.valueOf(quantity))\n    );\n\n    return result == 1;\n}\n'})}),"\n",(0,t.jsx)(e.h3,{id:"\u9884\u51cf\u5e93\u5b58",children:"\u9884\u51cf\u5e93\u5b58"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-java",children:'// \u9884\u51cf\u5e93\u5b58\npublic boolean preDeductStock(String orderId, String productId, int quantity) {\n    String stockKey = "stock:" + productId;\n    String orderKey = "order:" + orderId;\n\n    String script =\n        "local stock = redis.call(\'GET\', KEYS[1]) " +\n        "if not stock or tonumber(stock) < tonumber(ARGV[1]) then " +\n        "  return 0 " +\n        "end " +\n        "redis.call(\'DECRBY\', KEYS[1], ARGV[1]) " +\n        "redis.call(\'SET\', KEYS[2], ARGV[1]) " +\n        "redis.call(\'EXPIRE\', KEYS[2], 600) " +  // 10\u5206\u949f\u8fc7\u671f\n        "return 1";\n\n    return (Long) jedis.eval(script,\n        Arrays.asList(stockKey, orderKey),\n        Collections.singletonList(String.valueOf(quantity))\n    ) == 1;\n}\n\n// \u6062\u590d\u5e93\u5b58\uff08\u8ba2\u5355\u53d6\u6d88\uff09\npublic void restoreStock(String orderId, String productId) {\n    String orderKey = "order:" + orderId;\n    String stockKey = "stock:" + productId;\n\n    String quantity = jedis.get(orderKey);\n    if (quantity != null) {\n        jedis.incrby(stockKey, Long.parseLong(quantity));\n        jedis.del(orderKey);\n    }\n}\n'})}),"\n",(0,t.jsx)(e.h2,{id:"\u7b7e\u5230\u7cfb\u7edf",children:"\u7b7e\u5230\u7cfb\u7edf"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-java",children:'public class CheckIn {\n    private Jedis jedis;\n\n    // \u7b7e\u5230\n    public boolean checkIn(String userId, int year, int month, int day) {\n        String key = String.format("checkin:%d%02d:%s", year, month, userId);\n        jedis.setbit(key, day - 1, true);\n        jedis.expire(key, 60 * 60 * 24 * 31);  // 31\u5929\u8fc7\u671f\n        return true;\n    }\n\n    // \u67e5\u8be2\u67d0\u5929\u662f\u5426\u7b7e\u5230\n    public boolean isCheckedIn(String userId, int year, int month, int day) {\n        String key = String.format("checkin:%d%02d:%s", year, month, userId);\n        return jedis.getbit(key, day - 1);\n    }\n\n    // \u7edf\u8ba1\u7b7e\u5230\u5929\u6570\n    public long countCheckIn(String userId, int year, int month) {\n        String key = String.format("checkin:%d%02d:%s", year, month, userId);\n        return jedis.bitcount(key);\n    }\n\n    // \u83b7\u53d6\u8fde\u7eed\u7b7e\u5230\u5929\u6570\n    public int getContinuousDays(String userId, int year, int month, int today) {\n        String key = String.format("checkin:%d%02d:%s", year, month, userId);\n        int continuous = 0;\n\n        for (int day = today; day >= 1; day--) {\n            if (jedis.getbit(key, day - 1)) {\n                continuous++;\n            } else {\n                break;\n            }\n        }\n\n        return continuous;\n    }\n}\n'})}),"\n",(0,t.jsx)(e.h2,{id:"\u603b\u7ed3",children:"\u603b\u7ed3"}),"\n",(0,t.jsx)(e.p,{children:"\u8fd9\u4e9b\u5b9e\u6218\u6848\u4f8b\u6db5\u76d6\u4e86\uff1a"}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"\u2705 \u5206\u5e03\u5f0f\u9501"}),"\n",(0,t.jsx)(e.li,{children:"\u2705 \u9650\u6d41\u5668"}),"\n",(0,t.jsx)(e.li,{children:"\u2705 \u6392\u884c\u699c"}),"\n",(0,t.jsx)(e.li,{children:"\u2705 \u793e\u4ea4\u5173\u7cfb"}),"\n",(0,t.jsx)(e.li,{children:"\u2705 \u6d88\u606f\u961f\u5217"}),"\n",(0,t.jsx)(e.li,{children:"\u2705 \u5e93\u5b58\u6263\u51cf"}),"\n",(0,t.jsx)(e.li,{children:"\u2705 \u7b7e\u5230\u7cfb\u7edf"}),"\n"]}),"\n",(0,t.jsx)(e.p,{children:"\u7ed3\u5408\u5b9e\u9645\u573a\u666f\uff0c\u7075\u6d3b\u8fd0\u7528 Redis\uff01"})]})}function u(n={}){const{wrapper:e}={...(0,s.R)(),...n.components};return e?(0,t.jsx)(e,{...n,children:(0,t.jsx)(c,{...n})}):c(n)}}}]);