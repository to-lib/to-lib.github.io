"use strict";(globalThis.webpackChunkto_lib_github_io=globalThis.webpackChunkto_lib_github_io||[]).push([[9556],{14362:(n,e,i)=>{i.r(e),i.d(e,{assets:()=>r,contentTitle:()=>s,default:()=>p,frontMatter:()=>o,metadata:()=>l,toc:()=>d});const l=JSON.parse('{"id":"nginx/static-files","title":"\u9759\u6001\u6587\u4ef6\u670d\u52a1","description":"\u4f7f\u7528 Nginx \u63d0\u4f9b\u9759\u6001\u6587\u4ef6\u670d\u52a1\u7684\u914d\u7f6e\u6307\u5357","source":"@site/docs/nginx/static-files.md","sourceDirName":"nginx","slug":"/nginx/static-files","permalink":"/docs/nginx/static-files","draft":false,"unlisted":false,"editUrl":"https://github.com/to-lib/to-lib.github.io/tree/main/docs/nginx/static-files.md","tags":[],"version":"current","sidebarPosition":4,"frontMatter":{"sidebar_position":4,"title":"\u9759\u6001\u6587\u4ef6\u670d\u52a1","description":"\u4f7f\u7528 Nginx \u63d0\u4f9b\u9759\u6001\u6587\u4ef6\u670d\u52a1\u7684\u914d\u7f6e\u6307\u5357"},"sidebar":"nginx","previous":{"title":"\u57fa\u7840\u914d\u7f6e","permalink":"/docs/nginx/basic-config"},"next":{"title":"\u53cd\u5411\u4ee3\u7406","permalink":"/docs/nginx/reverse-proxy"}}');var a=i(22714),t=i(48885);const o={sidebar_position:4,title:"\u9759\u6001\u6587\u4ef6\u670d\u52a1",description:"\u4f7f\u7528 Nginx \u63d0\u4f9b\u9759\u6001\u6587\u4ef6\u670d\u52a1\u7684\u914d\u7f6e\u6307\u5357"},s="\u9759\u6001\u6587\u4ef6\u670d\u52a1",r={},d=[{value:"\u57fa\u672c\u914d\u7f6e",id:"\u57fa\u672c\u914d\u7f6e",level:2},{value:"\u9759\u6001\u8d44\u6e90\u4f18\u5316",id:"\u9759\u6001\u8d44\u6e90\u4f18\u5316",level:2},{value:"Gzip \u538b\u7f29",id:"gzip-\u538b\u7f29",level:3},{value:"\u9884\u538b\u7f29\uff08Gzip Static\uff09",id:"\u9884\u538b\u7f29gzip-static",level:3},{value:"Brotli \u538b\u7f29",id:"brotli-\u538b\u7f29",level:3},{value:"\u7f13\u5b58\u63a7\u5236",id:"\u7f13\u5b58\u63a7\u5236",level:2},{value:"\u6d4f\u89c8\u5668\u7f13\u5b58",id:"\u6d4f\u89c8\u5668\u7f13\u5b58",level:3},{value:"\u4f7f\u7528 ETag \u548c Last-Modified",id:"\u4f7f\u7528-etag-\u548c-last-modified",level:3},{value:"\u7248\u672c\u5316\u8d44\u6e90\uff08\u957f\u671f\u7f13\u5b58\uff09",id:"\u7248\u672c\u5316\u8d44\u6e90\u957f\u671f\u7f13\u5b58",level:3},{value:"Sendfile \u4f18\u5316",id:"sendfile-\u4f18\u5316",level:2},{value:"\u76ee\u5f55\u6d4f\u89c8",id:"\u76ee\u5f55\u6d4f\u89c8",level:2},{value:"\u7f8e\u5316\u76ee\u5f55\u5217\u8868",id:"\u7f8e\u5316\u76ee\u5f55\u5217\u8868",level:3},{value:"\u6587\u4ef6\u4e0b\u8f7d",id:"\u6587\u4ef6\u4e0b\u8f7d",level:2},{value:"\u9632\u76d7\u94fe",id:"\u9632\u76d7\u94fe",level:2},{value:"\u8de8\u57df\u8d44\u6e90\u5171\u4eab\uff08CORS\uff09",id:"\u8de8\u57df\u8d44\u6e90\u5171\u4eabcors",level:2},{value:"SPA \u5e94\u7528\u914d\u7f6e",id:"spa-\u5e94\u7528\u914d\u7f6e",level:2},{value:"\u591a\u7f51\u7ad9\u914d\u7f6e",id:"\u591a\u7f51\u7ad9\u914d\u7f6e",level:2},{value:"\u5a92\u4f53\u6587\u4ef6\u5904\u7406",id:"\u5a92\u4f53\u6587\u4ef6\u5904\u7406",level:2},{value:"\u56fe\u7247\u5904\u7406",id:"\u56fe\u7247\u5904\u7406",level:3},{value:"\u89c6\u9891\u6d41\uff08MP4\uff09",id:"\u89c6\u9891\u6d41mp4",level:3},{value:"\u5b89\u5168\u914d\u7f6e",id:"\u5b89\u5168\u914d\u7f6e",level:2}];function c(n){const e={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",pre:"pre",...(0,t.R)(),...n.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(e.header,{children:(0,a.jsx)(e.h1,{id:"\u9759\u6001\u6587\u4ef6\u670d\u52a1",children:"\u9759\u6001\u6587\u4ef6\u670d\u52a1"})}),"\n",(0,a.jsx)(e.h2,{id:"\u57fa\u672c\u914d\u7f6e",children:"\u57fa\u672c\u914d\u7f6e"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-nginx",children:"server {\n    listen 80;\n    server_name static.example.com;\n\n    # \u7f51\u7ad9\u6839\u76ee\u5f55\n    root /var/www/static;\n\n    # \u9ed8\u8ba4\u9996\u9875\n    index index.html index.htm;\n\n    location / {\n        try_files $uri $uri/ =404;\n    }\n}\n"})}),"\n",(0,a.jsx)(e.h2,{id:"\u9759\u6001\u8d44\u6e90\u4f18\u5316",children:"\u9759\u6001\u8d44\u6e90\u4f18\u5316"}),"\n",(0,a.jsx)(e.h3,{id:"gzip-\u538b\u7f29",children:"Gzip \u538b\u7f29"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-nginx",children:'http {\n    # \u5f00\u542f Gzip\n    gzip on;\n\n    # \u6700\u5c0f\u538b\u7f29\u6587\u4ef6\u5927\u5c0f\n    gzip_min_length 1k;\n\n    # \u538b\u7f29\u7ea7\u522b 1-9\uff0c\u5efa\u8bae 4-6\n    gzip_comp_level 5;\n\n    # \u538b\u7f29\u7f13\u51b2\u533a\n    gzip_buffers 16 8k;\n\n    # \u538b\u7f29\u7684 MIME \u7c7b\u578b\n    gzip_types\n        text/plain\n        text/css\n        text/javascript\n        text/xml\n        application/json\n        application/javascript\n        application/xml\n        application/xml+rss\n        application/x-javascript\n        image/svg+xml;\n\n    # \u4ee3\u7406\u8bf7\u6c42\u4e5f\u538b\u7f29\n    gzip_proxied any;\n\n    # \u6dfb\u52a0 Vary \u5934\n    gzip_vary on;\n\n    # \u7981\u7528 IE6 Gzip\n    gzip_disable "msie6";\n}\n'})}),"\n",(0,a.jsx)(e.h3,{id:"\u9884\u538b\u7f29gzip-static",children:"\u9884\u538b\u7f29\uff08Gzip Static\uff09"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-nginx",children:"# \u9700\u8981\u7f16\u8bd1\u65f6 --with-http_gzip_static_module\nlocation / {\n    gzip_static on;\n    # \u4f1a\u4f18\u5148\u67e5\u627e .gz \u6587\u4ef6\n    # \u5982 /style.css \u4f1a\u5148\u627e /style.css.gz\n}\n"})}),"\n",(0,a.jsx)(e.h3,{id:"brotli-\u538b\u7f29",children:"Brotli \u538b\u7f29"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-nginx",children:"# \u9700\u8981\u7b2c\u4e09\u65b9\u6a21\u5757\nload_module modules/ngx_http_brotli_filter_module.so;\nload_module modules/ngx_http_brotli_static_module.so;\n\nhttp {\n    brotli on;\n    brotli_comp_level 6;\n    brotli_types text/plain text/css application/json application/javascript\n                 text/xml application/xml application/xml+rss text/javascript\n                 image/svg+xml;\n\n    # \u9884\u538b\u7f29\n    brotli_static on;\n}\n"})}),"\n",(0,a.jsx)(e.h2,{id:"\u7f13\u5b58\u63a7\u5236",children:"\u7f13\u5b58\u63a7\u5236"}),"\n",(0,a.jsx)(e.h3,{id:"\u6d4f\u89c8\u5668\u7f13\u5b58",children:"\u6d4f\u89c8\u5668\u7f13\u5b58"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-nginx",children:'# \u56fe\u7247\u7f13\u5b58 30 \u5929\nlocation ~* \\.(jpg|jpeg|png|gif|ico|webp|svg)$ {\n    expires 30d;\n    add_header Cache-Control "public, no-transform";\n    access_log off;\n}\n\n# CSS/JS \u7f13\u5b58 7 \u5929\nlocation ~* \\.(css|js)$ {\n    expires 7d;\n    add_header Cache-Control "public, no-transform";\n}\n\n# \u5b57\u4f53\u6587\u4ef6\u7f13\u5b58 1 \u5e74\nlocation ~* \\.(woff|woff2|ttf|otf|eot)$ {\n    expires 1y;\n    add_header Cache-Control "public, immutable";\n    access_log off;\n}\n\n# HTML \u4e0d\u7f13\u5b58\u6216\u77ed\u7f13\u5b58\nlocation ~* \\.html$ {\n    expires -1;\n    add_header Cache-Control "no-cache, no-store, must-revalidate";\n}\n'})}),"\n",(0,a.jsx)(e.h3,{id:"\u4f7f\u7528-etag-\u548c-last-modified",children:"\u4f7f\u7528 ETag \u548c Last-Modified"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-nginx",children:"location /static/ {\n    # \u9ed8\u8ba4\u5f00\u542f\n    etag on;\n\n    # \u5982\u679c\u6587\u4ef6\u672a\u4fee\u6539\uff0c\u8fd4\u56de 304\n    if_modified_since before;\n}\n"})}),"\n",(0,a.jsx)(e.h3,{id:"\u7248\u672c\u5316\u8d44\u6e90\u957f\u671f\u7f13\u5b58",children:"\u7248\u672c\u5316\u8d44\u6e90\uff08\u957f\u671f\u7f13\u5b58\uff09"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-nginx",children:'# \u5e26 hash \u7684\u8d44\u6e90\uff0c\u7f13\u5b58\u4e00\u5e74\nlocation ~* \\.[a-f0-9]{8,}\\.(css|js)$ {\n    expires 1y;\n    add_header Cache-Control "public, immutable";\n}\n\n# \u6216\u4f7f\u7528\u67e5\u8be2\u53c2\u6570\u7248\u672c\nlocation ~* ^.+\\.(css|js)$ {\n    if ($args ~* "v=") {\n        expires 1y;\n    }\n}\n'})}),"\n",(0,a.jsx)(e.h2,{id:"sendfile-\u4f18\u5316",children:"Sendfile \u4f18\u5316"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-nginx",children:"http {\n    # \u5f00\u542f sendfile\n    sendfile on;\n\n    # \u914d\u5408 sendfile \u4f7f\u7528\n    tcp_nopush on;    # \u5728\u4e00\u4e2a\u6570\u636e\u5305\u4e2d\u53d1\u9001 HTTP \u5934\n    tcp_nodelay on;   # \u7981\u7528 Nagle \u7b97\u6cd5\n\n    # \u76f4\u63a5 IO\uff08\u5927\u6587\u4ef6\u573a\u666f\uff09\n    # directio 4m;\n\n    # AIO\uff08\u5f02\u6b65 IO\uff0c\u9700\u8981\u7cfb\u7edf\u652f\u6301\uff09\n    # aio on;\n}\n"})}),"\n",(0,a.jsx)(e.h2,{id:"\u76ee\u5f55\u6d4f\u89c8",children:"\u76ee\u5f55\u6d4f\u89c8"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-nginx",children:"location /files/ {\n    root /var/www;\n\n    # \u5f00\u542f\u76ee\u5f55\u6d4f\u89c8\n    autoindex on;\n\n    # \u663e\u793a\u786e\u5207\u6587\u4ef6\u5927\u5c0f\n    autoindex_exact_size off;\n\n    # \u663e\u793a\u672c\u5730\u65f6\u95f4\n    autoindex_localtime on;\n\n    # JSON \u683c\u5f0f\uff08\u7528\u4e8e API\uff09\n    # autoindex_format json;\n}\n"})}),"\n",(0,a.jsx)(e.h3,{id:"\u7f8e\u5316\u76ee\u5f55\u5217\u8868",children:"\u7f8e\u5316\u76ee\u5f55\u5217\u8868"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-nginx",children:"location /files/ {\n    autoindex on;\n    autoindex_exact_size off;\n    autoindex_localtime on;\n\n    # \u6dfb\u52a0\u81ea\u5b9a\u4e49\u6837\u5f0f\n    add_before_body /autoindex-header.html;\n    add_after_body /autoindex-footer.html;\n}\n"})}),"\n",(0,a.jsx)(e.h2,{id:"\u6587\u4ef6\u4e0b\u8f7d",children:"\u6587\u4ef6\u4e0b\u8f7d"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-nginx",children:"location /download/ {\n    root /var/www;\n\n    # \u5f3a\u5236\u4e0b\u8f7d\u800c\u975e\u9884\u89c8\n    add_header Content-Disposition 'attachment';\n\n    # \u6216\u6839\u636e\u6587\u4ef6\u7c7b\u578b\n    if ($request_filename ~* \\.(pdf|zip|rar)$) {\n        add_header Content-Disposition 'attachment';\n    }\n}\n\n# \u9650\u5236\u4e0b\u8f7d\u901f\u5ea6\nlocation /download/ {\n    root /var/www;\n    limit_rate 1m;           # \u9650\u901f 1MB/s\n    limit_rate_after 10m;    # \u524d 10MB \u4e0d\u9650\u901f\n}\n"})}),"\n",(0,a.jsx)(e.h2,{id:"\u9632\u76d7\u94fe",children:"\u9632\u76d7\u94fe"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-nginx",children:"location ~* \\.(jpg|jpeg|png|gif|webp|svg)$ {\n    # \u5408\u6cd5\u6765\u6e90\n    valid_referers none blocked server_names\n        *.example.com\n        example.com\n        ~\\.google\\.\n        ~\\.baidu\\.;\n\n    # \u975e\u6cd5\u6765\u6e90\u8fd4\u56de 403 \u6216\u66ff\u6362\u56fe\u7247\n    if ($invalid_referer) {\n        return 403;\n        # \u6216 rewrite ^ /images/forbidden.png break;\n    }\n}\n"})}),"\n",(0,a.jsx)(e.h2,{id:"\u8de8\u57df\u8d44\u6e90\u5171\u4eabcors",children:"\u8de8\u57df\u8d44\u6e90\u5171\u4eab\uff08CORS\uff09"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-nginx",children:'location /api/ {\n    # \u5141\u8bb8\u7684\u6e90\n    add_header Access-Control-Allow-Origin "*";\n    # \u6216\u6307\u5b9a\u57df\u540d\n    # add_header Access-Control-Allow-Origin "https://example.com";\n\n    add_header Access-Control-Allow-Methods "GET, POST, OPTIONS";\n    add_header Access-Control-Allow-Headers "Origin, Content-Type, Accept";\n    add_header Access-Control-Max-Age 3600;\n\n    # \u5904\u7406\u9884\u68c0\u8bf7\u6c42\n    if ($request_method = OPTIONS) {\n        return 204;\n    }\n}\n\n# \u52a8\u6001 CORS\nmap $http_origin $cors_origin {\n    default "";\n    "~^https?://(.+\\.)?example\\.com$" $http_origin;\n    "~^https?://localhost(:\\d+)?$" $http_origin;\n}\n\nserver {\n    location /api/ {\n        add_header Access-Control-Allow-Origin $cors_origin always;\n        add_header Access-Control-Allow-Credentials true always;\n    }\n}\n'})}),"\n",(0,a.jsx)(e.h2,{id:"spa-\u5e94\u7528\u914d\u7f6e",children:"SPA \u5e94\u7528\u914d\u7f6e"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-nginx",children:'server {\n    listen 80;\n    server_name app.example.com;\n    root /var/www/spa;\n\n    # \u9759\u6001\u8d44\u6e90\n    location ~* \\.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2)$ {\n        expires 1y;\n        add_header Cache-Control "public, immutable";\n        access_log off;\n    }\n\n    # HTML \u4e0d\u7f13\u5b58\n    location ~* \\.html$ {\n        expires -1;\n        add_header Cache-Control "no-cache, no-store, must-revalidate";\n    }\n\n    # \u6240\u6709\u8def\u7531\u56de\u9000\u5230 index.html\n    location / {\n        try_files $uri $uri/ /index.html;\n    }\n}\n'})}),"\n",(0,a.jsx)(e.h2,{id:"\u591a\u7f51\u7ad9\u914d\u7f6e",children:"\u591a\u7f51\u7ad9\u914d\u7f6e"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-nginx",children:"# \u7f51\u7ad9 1\nserver {\n    listen 80;\n    server_name site1.example.com;\n    root /var/www/site1;\n\n    location / {\n        try_files $uri $uri/ =404;\n    }\n}\n\n# \u7f51\u7ad9 2\nserver {\n    listen 80;\n    server_name site2.example.com;\n    root /var/www/site2;\n\n    location / {\n        try_files $uri $uri/ =404;\n    }\n}\n\n# \u9ed8\u8ba4\u670d\u52a1\u5668\nserver {\n    listen 80 default_server;\n    server_name _;\n    return 444;  # \u5173\u95ed\u8fde\u63a5\n}\n"})}),"\n",(0,a.jsx)(e.h2,{id:"\u5a92\u4f53\u6587\u4ef6\u5904\u7406",children:"\u5a92\u4f53\u6587\u4ef6\u5904\u7406"}),"\n",(0,a.jsx)(e.h3,{id:"\u56fe\u7247\u5904\u7406",children:"\u56fe\u7247\u5904\u7406"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-nginx",children:"# \u9700\u8981 ngx_http_image_filter_module\nload_module modules/ngx_http_image_filter_module.so;\n\nlocation ~* ^/images/(.+)_(\\d+)x(\\d+)\\.(jpg|png|gif)$ {\n    set $image_path /images/$1.$4;\n    set $width $2;\n    set $height $3;\n\n    image_filter resize $width $height;\n    image_filter_jpeg_quality 85;\n    image_filter_buffer 10M;\n\n    try_files $image_path =404;\n}\n"})}),"\n",(0,a.jsx)(e.h3,{id:"\u89c6\u9891\u6d41mp4",children:"\u89c6\u9891\u6d41\uff08MP4\uff09"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-nginx",children:"# \u9700\u8981 --with-http_mp4_module\nlocation ~* \\.mp4$ {\n    mp4;\n    mp4_buffer_size 1m;\n    mp4_max_buffer_size 5m;\n}\n\n# FLV\nlocation ~* \\.flv$ {\n    flv;\n}\n"})}),"\n",(0,a.jsx)(e.h2,{id:"\u5b89\u5168\u914d\u7f6e",children:"\u5b89\u5168\u914d\u7f6e"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-nginx",children:"location /static/ {\n    root /var/www;\n\n    # \u7981\u6b62\u8bbf\u95ee\u9690\u85cf\u6587\u4ef6\n    location ~ /\\. {\n        deny all;\n    }\n\n    # \u7981\u6b62\u8bbf\u95ee\u5907\u4efd\u6587\u4ef6\n    location ~* \\.(bak|swp|~)$ {\n        deny all;\n    }\n\n    # \u7981\u6b62\u6267\u884c\u811a\u672c\n    location ~* \\.(php|pl|py|cgi)$ {\n        deny all;\n    }\n}\n"})})]})}function p(n={}){const{wrapper:e}={...(0,t.R)(),...n.components};return e?(0,a.jsx)(e,{...n,children:(0,a.jsx)(c,{...n})}):c(n)}},48885:(n,e,i)=>{i.d(e,{R:()=>o,x:()=>s});var l=i(99378);const a={},t=l.createContext(a);function o(n){const e=l.useContext(t);return l.useMemo(function(){return"function"==typeof n?n(e):{...e,...n}},[e,n])}function s(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(a):n.components||a:o(n.components),l.createElement(t.Provider,{value:e},n.children)}}}]);