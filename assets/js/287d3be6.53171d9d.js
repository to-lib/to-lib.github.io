"use strict";(globalThis.webpackChunkto_lib_github_io=globalThis.webpackChunkto_lib_github_io||[]).push([[95070],{36732:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>o,contentTitle:()=>r,default:()=>h,frontMatter:()=>s,metadata:()=>l,toc:()=>c});const l=JSON.parse('{"id":"netty/advanced","title":"\u6027\u80fd\u4f18\u5316\u4e0e\u8fdb\u9636","description":"[!IMPORTANT]","source":"@site/docs/netty/advanced.md","sourceDirName":"netty","slug":"/netty/advanced","permalink":"/docs/netty/advanced","draft":false,"unlisted":false,"editUrl":"https://github.com/to-lib/to-lib.github.io/tree/main/docs/netty/advanced.md","tags":[],"version":"current","sidebarPosition":7,"frontMatter":{"sidebar_position":7},"sidebar":"netty","previous":{"title":"Netty \u6d4b\u8bd5\uff08EmbeddedChannel\uff09","permalink":"/docs/netty/testing"},"next":{"title":"\u6700\u4f73\u5b9e\u8df5\u4e0e\u96c6\u6210\u6307\u5357","permalink":"/docs/netty/best-practices"}}');var a=t(22714),i=t(48885);const s={sidebar_position:7},r="\u6027\u80fd\u4f18\u5316\u4e0e\u8fdb\u9636",o={},c=[{value:"\u5185\u5b58\u4f18\u5316",id:"\u5185\u5b58\u4f18\u5316",level:2},{value:"ByteBuf \u5185\u5b58\u6c60",id:"bytebuf-\u5185\u5b58\u6c60",level:3},{value:"\u4f7f\u7528 ObjectPool \u91cd\u7528\u5bf9\u8c61",id:"\u4f7f\u7528-objectpool-\u91cd\u7528\u5bf9\u8c61",level:3},{value:"\u8fde\u63a5\u7ba1\u7406",id:"\u8fde\u63a5\u7ba1\u7406",level:2},{value:"\u5fc3\u8df3\u68c0\u6d4b",id:"\u5fc3\u8df3\u68c0\u6d4b",level:3},{value:"\u8fde\u63a5\u9650\u5236",id:"\u8fde\u63a5\u9650\u5236",level:3},{value:"\u8fde\u63a5\u7a7a\u95f2\u68c0\u6d4b",id:"\u8fde\u63a5\u7a7a\u95f2\u68c0\u6d4b",level:3},{value:"\u541e\u5410\u91cf\u4f18\u5316",id:"\u541e\u5410\u91cf\u4f18\u5316",level:2},{value:"\u5199\u7f13\u51b2\u533a\u4f18\u5316",id:"\u5199\u7f13\u51b2\u533a\u4f18\u5316",level:3},{value:"\u6279\u91cf\u5199\u5165",id:"\u6279\u91cf\u5199\u5165",level:3},{value:"\u5173\u95ed Nagle \u7b97\u6cd5",id:"\u5173\u95ed-nagle-\u7b97\u6cd5",level:3},{value:"\u7ebf\u7a0b\u4f18\u5316",id:"\u7ebf\u7a0b\u4f18\u5316",level:2},{value:"\u7ebf\u7a0b\u6c60\u5927\u5c0f\u914d\u7f6e",id:"\u7ebf\u7a0b\u6c60\u5927\u5c0f\u914d\u7f6e",level:3},{value:"\u4efb\u52a1\u6267\u884c\u5668\u4f18\u5316",id:"\u4efb\u52a1\u6267\u884c\u5668\u4f18\u5316",level:3},{value:"\u76d1\u63a7\u4e0e\u8c03\u8bd5",id:"\u76d1\u63a7\u4e0e\u8c03\u8bd5",level:2},{value:"Netty \u76d1\u63a7",id:"netty-\u76d1\u63a7",level:3},{value:"\u8fde\u63a5\u7edf\u8ba1",id:"\u8fde\u63a5\u7edf\u8ba1",level:3},{value:"\u5b9a\u671f\u8f93\u51fa\u7edf\u8ba1\u4fe1\u606f",id:"\u5b9a\u671f\u8f93\u51fa\u7edf\u8ba1\u4fe1\u606f",level:3},{value:"SSL/TLS \u5b89\u5168\u901a\u4fe1",id:"ssltls-\u5b89\u5168\u901a\u4fe1",level:2},{value:"\u914d\u7f6e SSL \u4e0a\u4e0b\u6587",id:"\u914d\u7f6e-ssl-\u4e0a\u4e0b\u6587",level:3},{value:"\u5ba2\u6237\u7aef SSL \u914d\u7f6e",id:"\u5ba2\u6237\u7aef-ssl-\u914d\u7f6e",level:3},{value:"\u4f7f\u7528\u771f\u5b9e\u8bc1\u4e66",id:"\u4f7f\u7528\u771f\u5b9e\u8bc1\u4e66",level:3},{value:"SSL \u6027\u80fd\u4f18\u5316",id:"ssl-\u6027\u80fd\u4f18\u5316",level:3},{value:"\u6700\u4f73\u5b9e\u8df5\u68c0\u67e5\u6e05\u5355",id:"\u6700\u4f73\u5b9e\u8df5\u68c0\u67e5\u6e05\u5355",level:2},{value:"\u5185\u5b58",id:"\u5185\u5b58",level:3},{value:"\u8fde\u63a5",id:"\u8fde\u63a5",level:3},{value:"\u6027\u80fd",id:"\u6027\u80fd",level:3},{value:"\u76d1\u63a7",id:"\u76d1\u63a7",level:3},{value:"\u5b89\u5168",id:"\u5b89\u5168",level:3},{value:"\u6027\u80fd\u6d4b\u8bd5",id:"\u6027\u80fd\u6d4b\u8bd5",level:2},{value:"\u6700\u4f73\u5b9e\u8df5\u6c47\u603b",id:"\u6700\u4f73\u5b9e\u8df5\u6c47\u603b",level:2},{value:"\u5de5\u7a0b\u89c4\u8303",id:"\u5de5\u7a0b\u89c4\u8303",level:3},{value:"1. \u5f02\u5e38\u5904\u7406",id:"1-\u5f02\u5e38\u5904\u7406",level:4},{value:"2. \u8d44\u6e90\u7ba1\u7406",id:"2-\u8d44\u6e90\u7ba1\u7406",level:4},{value:"3. \u65e5\u5fd7\u8bb0\u5f55",id:"3-\u65e5\u5fd7\u8bb0\u5f55",level:4},{value:"\u4ee3\u7801\u7ec4\u7ec7",id:"\u4ee3\u7801\u7ec4\u7ec7",level:3},{value:"1. Handler \u804c\u8d23\u5206\u79bb",id:"1-handler-\u804c\u8d23\u5206\u79bb",level:4},{value:"2. \u907f\u514d Handler \u4e2d\u7684\u963b\u585e\u64cd\u4f5c",id:"2-\u907f\u514d-handler-\u4e2d\u7684\u963b\u585e\u64cd\u4f5c",level:4},{value:"3. Handler \u91cd\u7528\u6ce8\u610f\u4e8b\u9879",id:"3-handler-\u91cd\u7528\u6ce8\u610f\u4e8b\u9879",level:4},{value:"\u5e38\u89c1\u9677\u9631",id:"\u5e38\u89c1\u9677\u9631",level:3},{value:"1. ChannelFuture \u5f02\u6b65\u5904\u7406",id:"1-channelfuture-\u5f02\u6b65\u5904\u7406",level:4},{value:"2. \u4e8b\u4ef6\u4f20\u64ad",id:"2-\u4e8b\u4ef6\u4f20\u64ad",level:4},{value:"3. \u5185\u5b58\u7ba1\u7406",id:"3-\u5185\u5b58\u7ba1\u7406",level:4},{value:"4. \u8fde\u63a5\u6cc4\u6f0f",id:"4-\u8fde\u63a5\u6cc4\u6f0f",level:4}];function d(e){const n={a:"a",blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",hr:"hr",input:"input",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.header,{children:(0,a.jsx)(n.h1,{id:"\u6027\u80fd\u4f18\u5316\u4e0e\u8fdb\u9636",children:"\u6027\u80fd\u4f18\u5316\u4e0e\u8fdb\u9636"})}),"\n",(0,a.jsxs)(n.blockquote,{children:["\n",(0,a.jsx)(n.p,{children:"[!IMPORTANT]\n\u6027\u80fd\u4f18\u5316\u662f\u4e00\u4e2a\u7cfb\u7edf\u5de5\u7a0b,\u9700\u8981\u4ece\u5185\u5b58\u3001\u8fde\u63a5\u3001\u541e\u5410\u91cf\u3001\u7ebf\u7a0b\u7b49\u591a\u4e2a\u7ef4\u5ea6\u7efc\u5408\u8003\u8651\u3002\u5728\u4f18\u5316\u524d\u52a1\u5fc5\u5148\u505a\u6027\u80fd\u6d4b\u8bd5,\u5efa\u7acb\u57fa\u51c6,\u7136\u540e\u9488\u5bf9\u6027\u4f18\u5316\u3002"}),"\n"]}),"\n",(0,a.jsx)(n.h2,{id:"\u5185\u5b58\u4f18\u5316",children:"\u5185\u5b58\u4f18\u5316"}),"\n",(0,a.jsx)(n.h3,{id:"bytebuf-\u5185\u5b58\u6c60",children:"ByteBuf \u5185\u5b58\u6c60"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-java",children:'// \u4f7f\u7528\u6c60\u5316\u5206\u914d\u5668\uff08\u9ed8\u8ba4\uff09\nChannelConfig config = channel.config();\nByteBufAllocator allocator = config.getAllocator();\n\n// \u786e\u8ba4\u4f7f\u7528\u4e86 PooledByteBufAllocator\nif (allocator instanceof PooledByteBufAllocator) {\n    System.out.println("\u4f7f\u7528\u6c60\u5316\u5206\u914d\u5668");\n}\n\n// \u624b\u52a8\u914d\u7f6e\nServerBootstrap bootstrap = new ServerBootstrap();\nbootstrap.childOption(ChannelOption.ALLOCATOR, PooledByteBufAllocator.DEFAULT);\n\n// \u6c60\u5316\u5206\u914d\u5668\u53c2\u6570\u8c03\u4f18\nSystem.setProperty("io.netty.allocator.numHeapArenas", "16");\nSystem.setProperty("io.netty.allocator.numDirectArenas", "16");\nSystem.setProperty("io.netty.allocator.pageSize", "8192");\nSystem.setProperty("io.netty.allocator.maxOrder", "11");\n'})}),"\n",(0,a.jsx)(n.h3,{id:"\u4f7f\u7528-objectpool-\u91cd\u7528\u5bf9\u8c61",children:"\u4f7f\u7528 ObjectPool \u91cd\u7528\u5bf9\u8c61"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-java",children:'import io.netty.util.Recycler;\n\npublic class MyMessage {\n    private static final Recycler<MyMessage> RECYCLER = \n        new Recycler<MyMessage>() {\n            @Override\n            protected MyMessage newObject(Handle<MyMessage> handle) {\n                return new MyMessage(handle);\n            }\n        };\n\n    private final Recycler.Handle<MyMessage> handle;\n    private byte type;\n    private String data;\n\n    private MyMessage(Recycler.Handle<MyMessage> handle) {\n        this.handle = handle;\n    }\n\n    public static MyMessage newInstance() {\n        return RECYCLER.get();\n    }\n\n    public void set(byte type, String data) {\n        this.type = type;\n        this.data = data;\n    }\n\n    public void recycle() {\n        this.type = 0;\n        this.data = null;\n        handle.recycle(this);\n    }\n\n    // getters...\n}\n\n// \u4f7f\u7528\nMyMessage msg = MyMessage.newInstance();\nmsg.set((byte) 1, "hello");\ntry {\n    // \u4f7f\u7528 msg\n} finally {\n    msg.recycle(); // \u56de\u6536\u5bf9\u8c61\n}\n'})}),"\n",(0,a.jsx)(n.h2,{id:"\u8fde\u63a5\u7ba1\u7406",children:"\u8fde\u63a5\u7ba1\u7406"}),"\n",(0,a.jsx)(n.h3,{id:"\u5fc3\u8df3\u68c0\u6d4b",children:"\u5fc3\u8df3\u68c0\u6d4b"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-java",children:'public class HeartbeatHandler extends ChannelInboundHandlerAdapter {\n    private static final long HEARTBEAT_INTERVAL = 30; // \u79d2\n\n    @Override\n    public void userEventTriggered(ChannelHandlerContext ctx, Object evt) \n            throws Exception {\n        if (evt instanceof IdleStateEvent) {\n            IdleStateEvent event = (IdleStateEvent) evt;\n            \n            if (event.state() == IdleState.WRITER_IDLE) {\n                // 30 \u79d2\u6ca1\u6709\u5199\uff0c\u53d1\u9001\u5fc3\u8df3\n                ctx.writeAndFlush(new HeartbeatMessage());\n            } else if (event.state() == IdleState.READER_IDLE) {\n                // 30 \u79d2\u6ca1\u6709\u8bfb\uff0c\u65ad\u5f00\u8fde\u63a5\n                System.out.println("\u8fde\u63a5\u8d85\u65f6\uff0c\u65ad\u5f00\u8fde\u63a5");\n                ctx.close();\n            }\n        }\n        super.userEventTriggered(ctx, evt);\n    }\n}\n\n// \u5728 Pipeline \u4e2d\u6dfb\u52a0\npipeline.addLast(\n    new IdleStateHandler(30, 30, 0, TimeUnit.SECONDS)\n);\npipeline.addLast(new HeartbeatHandler());\n'})}),"\n",(0,a.jsx)(n.h3,{id:"\u8fde\u63a5\u9650\u5236",children:"\u8fde\u63a5\u9650\u5236"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-java",children:'public class ConnectionLimitHandler extends ChannelInboundHandlerAdapter {\n    private static final int MAX_CONNECTIONS = 10000;\n    private static final AtomicInteger activeConnections = new AtomicInteger(0);\n\n    @Override\n    public void channelActive(ChannelHandlerContext ctx) throws Exception {\n        int count = activeConnections.incrementAndGet();\n        \n        if (count > MAX_CONNECTIONS) {\n            System.out.println("\u8fde\u63a5\u6570\u8fbe\u5230\u4e0a\u9650\uff0c\u62d2\u7edd\u65b0\u8fde\u63a5");\n            ctx.close();\n            activeConnections.decrementAndGet();\n        } else {\n            System.out.println("\u5f53\u524d\u8fde\u63a5\u6570: " + count);\n            ctx.fireChannelActive();\n        }\n    }\n\n    @Override\n    public void channelInactive(ChannelHandlerContext ctx) throws Exception {\n        activeConnections.decrementAndGet();\n        ctx.fireChannelInactive();\n    }\n}\n'})}),"\n",(0,a.jsx)(n.h3,{id:"\u8fde\u63a5\u7a7a\u95f2\u68c0\u6d4b",children:"\u8fde\u63a5\u7a7a\u95f2\u68c0\u6d4b"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-java",children:'// \u5728 Pipeline \u4e2d\u6dfb\u52a0\nChannelInitializer<SocketChannel> initializer = \n    new ChannelInitializer<SocketChannel>() {\n    @Override\n    protected void initChannel(SocketChannel ch) {\n        ChannelPipeline pipeline = ch.pipeline();\n        \n        // IdleStateHandler \u4f1a\u89e6\u53d1 IdleStateEvent\n        // \u53c2\u6570\uff1a\u8bfb\u7a7a\u95f2\u8d85\u65f6\u3001\u5199\u7a7a\u95f2\u8d85\u65f6\u3001\u8bfb\u5199\u90fd\u7a7a\u95f2\u8d85\u65f6\uff08\u79d2\uff09\n        pipeline.addLast(new IdleStateHandler(60, 30, 0));\n        pipeline.addLast(new ConnectionIdleHandler());\n    }\n};\n\npublic class ConnectionIdleHandler extends ChannelInboundHandlerAdapter {\n    @Override\n    public void userEventTriggered(ChannelHandlerContext ctx, Object evt) \n            throws Exception {\n        if (evt instanceof IdleStateEvent) {\n            IdleStateEvent event = (IdleStateEvent) evt;\n            \n            switch (event.state()) {\n                case READER_IDLE:\n                    System.out.println("\u8bfb\u7a7a\u95f2");\n                    break;\n                case WRITER_IDLE:\n                    System.out.println("\u5199\u7a7a\u95f2");\n                    break;\n                case ALL_IDLE:\n                    System.out.println("\u8bfb\u5199\u7a7a\u95f2");\n                    break;\n            }\n        }\n        super.userEventTriggered(ctx, evt);\n    }\n}\n'})}),"\n",(0,a.jsx)(n.h2,{id:"\u541e\u5410\u91cf\u4f18\u5316",children:"\u541e\u5410\u91cf\u4f18\u5316"}),"\n",(0,a.jsx)(n.h3,{id:"\u5199\u7f13\u51b2\u533a\u4f18\u5316",children:"\u5199\u7f13\u51b2\u533a\u4f18\u5316"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-java",children:"// \u914d\u7f6e\u5199\u7f13\u51b2\u533a\u5927\u5c0f\nServerBootstrap bootstrap = new ServerBootstrap();\nbootstrap.childOption(\n    ChannelOption.SO_SNDBUF, \n    256 * 1024  // 256KB \u53d1\u9001\u7f13\u51b2\n);\n\nbootstrap.childOption(\n    ChannelOption.SO_RCVBUF,\n    256 * 1024  // 256KB \u63a5\u6536\u7f13\u51b2\n);\n\n// \u914d\u7f6e\u5199\u6c34\u4f4d\u7ebf\nbootstrap.childOption(\n    ChannelOption.WRITE_BUFFER_WATER_MARK,\n    new WriteBufferWaterMark(32 * 1024, 1024 * 1024) // \u4f4e\u4f4d 32KB\uff0c\u9ad8\u4f4d 1MB\n);\n"})}),"\n",(0,a.jsx)(n.h3,{id:"\u6279\u91cf\u5199\u5165",children:"\u6279\u91cf\u5199\u5165"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-java",children:"public class BatchWriteHandler extends ChannelInboundHandlerAdapter {\n    private static final int BATCH_SIZE = 100;\n    private Queue<Object> queue = new LinkedList<>();\n\n    @Override\n    public void channelRead(ChannelHandlerContext ctx, Object msg) {\n        queue.offer(msg);\n        \n        if (queue.size() >= BATCH_SIZE) {\n            flushBatch(ctx);\n        }\n    }\n\n    private void flushBatch(ChannelHandlerContext ctx) {\n        while (!queue.isEmpty()) {\n            ctx.write(queue.poll());\n        }\n        ctx.flush();\n    }\n\n    @Override\n    public void channelReadComplete(ChannelHandlerContext ctx) {\n        flushBatch(ctx);\n    }\n}\n"})}),"\n",(0,a.jsx)(n.h3,{id:"\u5173\u95ed-nagle-\u7b97\u6cd5",children:"\u5173\u95ed Nagle \u7b97\u6cd5"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-java",children:"// Nagle \u7b97\u6cd5\u4f1a\u5ef6\u8fdf\u5c0f\u5305\u53d1\u9001\uff0c\u5173\u95ed\u5b83\u53ef\u4ee5\u964d\u4f4e\u5ef6\u8fdf\nServerBootstrap bootstrap = new ServerBootstrap();\nbootstrap.childOption(ChannelOption.TCP_NODELAY, true);\n"})}),"\n",(0,a.jsx)(n.h2,{id:"\u7ebf\u7a0b\u4f18\u5316",children:"\u7ebf\u7a0b\u4f18\u5316"}),"\n",(0,a.jsx)(n.h3,{id:"\u7ebf\u7a0b\u6c60\u5927\u5c0f\u914d\u7f6e",children:"\u7ebf\u7a0b\u6c60\u5927\u5c0f\u914d\u7f6e"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-java",children:"// \u6839\u636e CPU \u6838\u5fc3\u6570\u914d\u7f6e EventLoop \u6570\u91cf\nint cpuCores = Runtime.getRuntime().availableProcessors();\n\n// Boss EventLoop\uff1a\u901a\u5e38\u53ea\u9700 1 \u4e2a\nEventLoopGroup bossGroup = new NioEventLoopGroup(1);\n\n// Worker EventLoop\uff1a\u901a\u5e38\u662f CPU \u6838\u5fc3\u6570\u7684 1-2 \u500d\nEventLoopGroup workerGroup = new NioEventLoopGroup(cpuCores * 2);\n\n// \u5bf9\u4e8e\u5b58\u5728\u5927\u91cf\u6570\u636e\u5e93\u64cd\u4f5c\u7684\u5e94\u7528\uff0c\u53ef\u4ee5\u589e\u52a0\u66f4\u591a\u7ebf\u7a0b\n// EventLoopGroup workerGroup = new NioEventLoopGroup(cpuCores * 4);\n"})}),"\n",(0,a.jsx)(n.h3,{id:"\u4efb\u52a1\u6267\u884c\u5668\u4f18\u5316",children:"\u4efb\u52a1\u6267\u884c\u5668\u4f18\u5316"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-java",children:'// \u5bf9\u4e8e\u8017\u65f6\u64cd\u4f5c\uff0c\u4f7f\u7528\u72ec\u7acb\u7684\u4e1a\u52a1\u7ebf\u7a0b\u6c60\nExecutorService businessPool = new ThreadPoolExecutor(\n    cpuCores,\n    cpuCores * 2,\n    60,\n    TimeUnit.SECONDS,\n    new LinkedBlockingQueue<>(1000),\n    new ThreadFactory() {\n        private AtomicInteger counter = new AtomicInteger();\n        \n        @Override\n        public Thread newThread(Runnable r) {\n            Thread t = new Thread(r);\n            t.setName("business-" + counter.incrementAndGet());\n            return t;\n        }\n    },\n    new ThreadPoolExecutor.CallerRunsPolicy()\n);\n\n// \u5728 Handler \u4e2d\u4f7f\u7528\npublic class BusinessHandler extends SimpleChannelInboundHandler<MyMessage> {\n    private ExecutorService businessPool;\n\n    @Override\n    protected void channelRead0(ChannelHandlerContext ctx, MyMessage msg) {\n        // \u63d0\u4ea4\u5230\u4e1a\u52a1\u7ebf\u7a0b\u6c60\n        businessPool.execute(() -> {\n            try {\n                Object result = handleMessage(msg);\n                ctx.writeAndFlush(result);\n            } catch (Exception e) {\n                ctx.fireExceptionCaught(e);\n            }\n        });\n    }\n\n    private Object handleMessage(MyMessage msg) {\n        // \u8017\u65f6\u64cd\u4f5c\n        return null;\n    }\n}\n'})}),"\n",(0,a.jsx)(n.h2,{id:"\u76d1\u63a7\u4e0e\u8c03\u8bd5",children:"\u76d1\u63a7\u4e0e\u8c03\u8bd5"}),"\n",(0,a.jsx)(n.h3,{id:"netty-\u76d1\u63a7",children:"Netty \u76d1\u63a7"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-java",children:'// \u542f\u7528\u8c03\u8bd5\u65e5\u5fd7\nimport io.netty.handler.logging.LogLevel;\nimport io.netty.handler.logging.LoggingHandler;\n\nServerBootstrap bootstrap = new ServerBootstrap();\nbootstrap.handler(new LoggingHandler(LogLevel.DEBUG));\nbootstrap.childHandler(new ChannelInitializer<SocketChannel>() {\n    @Override\n    protected void initChannel(SocketChannel ch) {\n        ch.pipeline().addFirst("logging", \n            new LoggingHandler(LogLevel.DEBUG));\n    }\n});\n'})}),"\n",(0,a.jsx)(n.h3,{id:"\u8fde\u63a5\u7edf\u8ba1",children:"\u8fde\u63a5\u7edf\u8ba1"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-java",children:'public class ConnectionStatsHandler extends ChannelDuplexHandler {\n    private static final AtomicLong totalConnections = new AtomicLong();\n    private static final AtomicLong activeConnections = new AtomicLong();\n    private static final AtomicLong totalBytesRead = new AtomicLong();\n    private static final AtomicLong totalBytesWritten = new AtomicLong();\n\n    @Override\n    public void channelActive(ChannelHandlerContext ctx) throws Exception {\n        totalConnections.incrementAndGet();\n        activeConnections.incrementAndGet();\n        ctx.fireChannelActive();\n    }\n\n    @Override\n    public void channelInactive(ChannelHandlerContext ctx) throws Exception {\n        activeConnections.decrementAndGet();\n        ctx.fireChannelInactive();\n    }\n\n    @Override\n    public void channelRead(ChannelHandlerContext ctx, Object msg) throws Exception {\n        if (msg instanceof ByteBuf) {\n            ByteBuf buf = (ByteBuf) msg;\n            totalBytesRead.addAndGet(buf.readableBytes());\n        }\n        ctx.fireChannelRead(msg);\n    }\n\n    @Override\n    public void write(ChannelHandlerContext ctx, Object msg, \n                      ChannelPromise promise) throws Exception {\n        if (msg instanceof ByteBuf) {\n            ByteBuf buf = (ByteBuf) msg;\n            totalBytesWritten.addAndGet(buf.readableBytes());\n        }\n        ctx.write(msg, promise);\n    }\n\n    public static void printStats() {\n        System.out.println("=== Netty \u8fde\u63a5\u7edf\u8ba1 ===");\n        System.out.println("\u603b\u8fde\u63a5\u6570: " + totalConnections.get());\n        System.out.println("\u6d3b\u8dc3\u8fde\u63a5\u6570: " + activeConnections.get());\n        System.out.println("\u603b\u63a5\u6536\u5b57\u8282\u6570: " + totalBytesRead.get());\n        System.out.println("\u603b\u53d1\u9001\u5b57\u8282\u6570: " + totalBytesWritten.get());\n    }\n}\n'})}),"\n",(0,a.jsx)(n.h3,{id:"\u5b9a\u671f\u8f93\u51fa\u7edf\u8ba1\u4fe1\u606f",children:"\u5b9a\u671f\u8f93\u51fa\u7edf\u8ba1\u4fe1\u606f"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-java",children:"// \u5728 EventLoop \u4e2d\u5b9a\u671f\u8f93\u51fa\u7edf\u8ba1\npublic class StatsServerHandler extends ChannelInboundHandlerAdapter {\n    @Override\n    public void channelActive(ChannelHandlerContext ctx) throws Exception {\n        // \u6bcf 30 \u79d2\u8f93\u51fa\u4e00\u6b21\u7edf\u8ba1\u4fe1\u606f\n        ctx.executor().scheduleAtFixedRate(\n            ConnectionStatsHandler::printStats,\n            30,\n            30,\n            TimeUnit.SECONDS\n        );\n        ctx.fireChannelActive();\n    }\n}\n"})}),"\n",(0,a.jsx)(n.h2,{id:"ssltls-\u5b89\u5168\u901a\u4fe1",children:"SSL/TLS \u5b89\u5168\u901a\u4fe1"}),"\n",(0,a.jsx)(n.p,{children:"Netty \u63d0\u4f9b\u4e86\u5b8c\u6574\u7684 SSL/TLS \u652f\u6301\uff0c\u53ef\u4ee5\u8f7b\u677e\u5b9e\u73b0\u52a0\u5bc6\u901a\u4fe1\u3002"}),"\n",(0,a.jsx)(n.h3,{id:"\u914d\u7f6e-ssl-\u4e0a\u4e0b\u6587",children:"\u914d\u7f6e SSL \u4e0a\u4e0b\u6587"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-java",children:"import io.netty.handler.ssl.SslContextBuilder;\nimport io.netty.handler.ssl.SslContext;\nimport io.netty.handler.ssl.util.SelfSignedCertificate;\n\n// \u670d\u52a1\u5668\u7aef\uff1a\u4f7f\u7528\u8bc1\u4e66\u548c\u79c1\u94a5\npublic class SslServerInitializer {\n    public static void main(String[] args) throws Exception {\n        // \u751f\u6210\u81ea\u7b7e\u540d\u8bc1\u4e66\uff08\u4ec5\u7528\u4e8e\u6d4b\u8bd5\uff09\n        SelfSignedCertificate ssc = new SelfSignedCertificate();\n        \n        SslContext sslCtx = SslContextBuilder.forServer(ssc.certificate(), ssc.privateKey())\n            .build();\n        \n        EventLoopGroup bossGroup = new NioEventLoopGroup(1);\n        EventLoopGroup workerGroup = new NioEventLoopGroup();\n        \n        try {\n            ServerBootstrap bootstrap = new ServerBootstrap();\n            bootstrap.group(bossGroup, workerGroup)\n                .channel(NioServerSocketChannel.class)\n                .childHandler(new ChannelInitializer<SocketChannel>() {\n                    @Override\n                    protected void initChannel(SocketChannel ch) {\n                        ChannelPipeline pipeline = ch.pipeline();\n                        // \u6dfb\u52a0 SSL Handler\n                        pipeline.addLast(sslCtx.newHandler(ch.alloc()));\n                        pipeline.addLast(new YourHandler());\n                    }\n                });\n            \n            ChannelFuture future = bootstrap.bind(8443).sync();\n            future.channel().closeFuture().sync();\n        } finally {\n            bossGroup.shutdownGracefully();\n            workerGroup.shutdownGracefully();\n        }\n    }\n}\n"})}),"\n",(0,a.jsx)(n.h3,{id:"\u5ba2\u6237\u7aef-ssl-\u914d\u7f6e",children:"\u5ba2\u6237\u7aef SSL \u914d\u7f6e"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-java",children:'public class SslClientInitializer {\n    public static void main(String[] args) throws Exception {\n        // \u4fe1\u4efb\u6240\u6709\u8bc1\u4e66\uff08\u4ec5\u7528\u4e8e\u6d4b\u8bd5\uff0c\u751f\u4ea7\u73af\u5883\u9700\u8981\u6b63\u786e\u7684\u8bc1\u4e66\u94fe\uff09\n        SslContext sslCtx = SslContextBuilder.forClient()\n            .trustManager(InsecureTrustManagerFactory.INSTANCE)\n            .build();\n        \n        EventLoopGroup group = new NioEventLoopGroup();\n        \n        try {\n            Bootstrap bootstrap = new Bootstrap();\n            bootstrap.group(group)\n                .channel(NioSocketChannel.class)\n                .handler(new ChannelInitializer<SocketChannel>() {\n                    @Override\n                    protected void initChannel(SocketChannel ch) {\n                        ChannelPipeline pipeline = ch.pipeline();\n                        // \u6dfb\u52a0 SSL Handler\n                        pipeline.addLast(sslCtx.newHandler(ch.alloc(), "localhost", 8443));\n                        pipeline.addLast(new YourHandler());\n                    }\n                });\n            \n            ChannelFuture future = bootstrap.connect("localhost", 8443).sync();\n            future.channel().closeFuture().sync();\n        } finally {\n            group.shutdownGracefully();\n        }\n    }\n}\n'})}),"\n",(0,a.jsx)(n.h3,{id:"\u4f7f\u7528\u771f\u5b9e\u8bc1\u4e66",children:"\u4f7f\u7528\u771f\u5b9e\u8bc1\u4e66"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-java",children:'// \u4f7f\u7528 JKS \u683c\u5f0f\u7684\u5bc6\u94a5\u5e93\nSslContext sslCtx = SslContextBuilder.forServer(\n    new FileInputStream("server.jks"),\n    "password", // \u5bc6\u94a5\u5e93\u5bc6\u7801\n    "password"  // \u5bc6\u94a5\u5bc6\u7801\n).build();\n\n// \u4f7f\u7528 PEM \u683c\u5f0f\u7684\u8bc1\u4e66\u548c\u79c1\u94a5\uff08\u63a8\u8350\uff09\nSslContext sslCtx = SslContextBuilder.forServer(\n    new File("path/to/server.crt"),    // \u8bc1\u4e66\u6587\u4ef6\n    new File("path/to/server.key")     // \u79c1\u94a5\u6587\u4ef6\n).build();\n'})}),"\n",(0,a.jsx)(n.h3,{id:"ssl-\u6027\u80fd\u4f18\u5316",children:"SSL \u6027\u80fd\u4f18\u5316"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-java",children:"// \u542f\u7528\u4f1a\u8bdd\u7f13\u5b58\uff0c\u63d0\u9ad8\u63e1\u624b\u6027\u80fd\nSslContext sslCtx = SslContextBuilder.forServer(cert, key)\n    .sessionCacheSize(64 * 1024)  // 64KB \u4f1a\u8bdd\u7f13\u5b58\n    .sessionTimeout(86400)        // 86400 \u79d2\uff0824\u5c0f\u65f6\uff09\n    .build();\n\n// \u914d\u7f6e HTTP/2 \u652f\u6301\uff08\u5982\u679c\u4f7f\u7528 OpenSSL \u5f15\u64ce\uff09\nSslContext sslCtx = SslContextBuilder.forServer(cert, key)\n    .applicationProtocolConfig(\n        new ApplicationProtocolConfig(\n            ApplicationProtocolConfig.Protocol.H2_HTTP_1_1,\n            ApplicationProtocolConfig.SelectorFailureBehavior.NO_ADVERTISE,\n            ApplicationProtocolConfig.SelectedListenerFailureBehavior.ACCEPT\n        )\n    )\n    .build();\n"})}),"\n",(0,a.jsx)(n.h2,{id:"\u6700\u4f73\u5b9e\u8df5\u68c0\u67e5\u6e05\u5355",children:"\u6700\u4f73\u5b9e\u8df5\u68c0\u67e5\u6e05\u5355"}),"\n",(0,a.jsx)(n.h3,{id:"\u5185\u5b58",children:"\u5185\u5b58"}),"\n",(0,a.jsxs)(n.ul,{className:"contains-task-list",children:["\n",(0,a.jsxs)(n.li,{className:"task-list-item",children:[(0,a.jsx)(n.input,{type:"checkbox",disabled:!0})," \u4f7f\u7528 ",(0,a.jsx)(n.a,{href:"/docs/netty/bytebuf#pooledbytebufallocator%E6%8E%A8%E8%8D%90",children:"PooledByteBufAllocator"})]}),"\n",(0,a.jsxs)(n.li,{className:"task-list-item",children:[(0,a.jsx)(n.input,{type:"checkbox",disabled:!0})," \u53ca\u65f6\u91ca\u653e ByteBuf"]}),"\n",(0,a.jsxs)(n.li,{className:"task-list-item",children:[(0,a.jsx)(n.input,{type:"checkbox",disabled:!0})," \u91cd\u7528\u5bf9\u8c61\u907f\u514d\u9891\u7e41\u521b\u5efa"]}),"\n",(0,a.jsxs)(n.li,{className:"task-list-item",children:[(0,a.jsx)(n.input,{type:"checkbox",disabled:!0})," \u76d1\u63a7\u5185\u5b58\u4f7f\u7528\u60c5\u51b5"]}),"\n"]}),"\n",(0,a.jsx)(n.h3,{id:"\u8fde\u63a5",children:"\u8fde\u63a5"}),"\n",(0,a.jsxs)(n.ul,{className:"contains-task-list",children:["\n",(0,a.jsxs)(n.li,{className:"task-list-item",children:[(0,a.jsx)(n.input,{type:"checkbox",disabled:!0})," \u914d\u7f6e\u5fc3\u8df3\u68c0\u6d4b"]}),"\n",(0,a.jsxs)(n.li,{className:"task-list-item",children:[(0,a.jsx)(n.input,{type:"checkbox",disabled:!0})," \u8bbe\u7f6e\u8fde\u63a5\u8d85\u65f6"]}),"\n",(0,a.jsxs)(n.li,{className:"task-list-item",children:[(0,a.jsx)(n.input,{type:"checkbox",disabled:!0})," \u9650\u5236\u6700\u5927\u8fde\u63a5\u6570"]}),"\n",(0,a.jsxs)(n.li,{className:"task-list-item",children:[(0,a.jsx)(n.input,{type:"checkbox",disabled:!0})," \u4f18\u96c5\u5173\u95ed\u8fde\u63a5"]}),"\n"]}),"\n",(0,a.jsx)(n.h3,{id:"\u6027\u80fd",children:"\u6027\u80fd"}),"\n",(0,a.jsxs)(n.ul,{className:"contains-task-list",children:["\n",(0,a.jsxs)(n.li,{className:"task-list-item",children:[(0,a.jsx)(n.input,{type:"checkbox",disabled:!0})," \u5173\u95ed Nagle \u7b97\u6cd5\uff08TCP_NODELAY\uff09"]}),"\n",(0,a.jsxs)(n.li,{className:"task-list-item",children:[(0,a.jsx)(n.input,{type:"checkbox",disabled:!0})," \u914d\u7f6e\u5408\u7406\u7684\u7f13\u51b2\u533a\u5927\u5c0f"]}),"\n",(0,a.jsxs)(n.li,{className:"task-list-item",children:[(0,a.jsx)(n.input,{type:"checkbox",disabled:!0})," \u907f\u514d\u963b\u585e EventLoop"]}),"\n",(0,a.jsxs)(n.li,{className:"task-list-item",children:[(0,a.jsx)(n.input,{type:"checkbox",disabled:!0})," \u4f7f\u7528\u72ec\u7acb\u7ebf\u7a0b\u6c60\u5904\u7406\u4e1a\u52a1\u903b\u8f91"]}),"\n"]}),"\n",(0,a.jsx)(n.h3,{id:"\u76d1\u63a7",children:"\u76d1\u63a7"}),"\n",(0,a.jsxs)(n.ul,{className:"contains-task-list",children:["\n",(0,a.jsxs)(n.li,{className:"task-list-item",children:[(0,a.jsx)(n.input,{type:"checkbox",disabled:!0})," \u8bb0\u5f55\u5173\u952e\u4e1a\u52a1\u6307\u6807"]}),"\n",(0,a.jsxs)(n.li,{className:"task-list-item",children:[(0,a.jsx)(n.input,{type:"checkbox",disabled:!0})," \u76d1\u63a7\u8fde\u63a5\u6570\u548c\u6d41\u91cf"]}),"\n",(0,a.jsxs)(n.li,{className:"task-list-item",children:[(0,a.jsx)(n.input,{type:"checkbox",disabled:!0})," \u5b9a\u671f\u68c0\u67e5\u5185\u5b58\u4f7f\u7528"]}),"\n",(0,a.jsxs)(n.li,{className:"task-list-item",children:[(0,a.jsx)(n.input,{type:"checkbox",disabled:!0})," \u8bbe\u7f6e\u544a\u8b66\u9608\u503c"]}),"\n"]}),"\n",(0,a.jsx)(n.h3,{id:"\u5b89\u5168",children:"\u5b89\u5168"}),"\n",(0,a.jsxs)(n.ul,{className:"contains-task-list",children:["\n",(0,a.jsxs)(n.li,{className:"task-list-item",children:[(0,a.jsx)(n.input,{type:"checkbox",disabled:!0})," \u9a8c\u8bc1\u8bf7\u6c42\u6570\u636e"]}),"\n",(0,a.jsxs)(n.li,{className:"task-list-item",children:[(0,a.jsx)(n.input,{type:"checkbox",disabled:!0})," \u9650\u5236\u6d88\u606f\u5927\u5c0f"]}),"\n",(0,a.jsxs)(n.li,{className:"task-list-item",children:[(0,a.jsx)(n.input,{type:"checkbox",disabled:!0})," \u5b9e\u73b0 DDoS \u9632\u62a4"]}),"\n",(0,a.jsxs)(n.li,{className:"task-list-item",children:[(0,a.jsx)(n.input,{type:"checkbox",disabled:!0})," \u4f7f\u7528 SSL/TLS \u52a0\u5bc6"]}),"\n"]}),"\n",(0,a.jsx)(n.h2,{id:"\u6027\u80fd\u6d4b\u8bd5",children:"\u6027\u80fd\u6d4b\u8bd5"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-java",children:'public class PerformanceTest {\n    public static void main(String[] args) throws InterruptedException {\n        int threads = 100;\n        int messagesPerThread = 1000;\n        int totalMessages = threads * messagesPerThread;\n\n        CountDownLatch latch = new CountDownLatch(threads);\n        long startTime = System.currentTimeMillis();\n\n        for (int i = 0; i < threads; i++) {\n            new Thread(() -> {\n                try {\n                    for (int j = 0; j < messagesPerThread; j++) {\n                        // \u53d1\u9001\u6d88\u606f\n                    }\n                } finally {\n                    latch.countDown();\n                }\n            }).start();\n        }\n\n        latch.await();\n        long endTime = System.currentTimeMillis();\n        \n        long duration = endTime - startTime;\n        double throughput = (double) totalMessages / (duration / 1000.0);\n\n        System.out.println("\u603b\u6d88\u606f\u6570: " + totalMessages);\n        System.out.println("\u603b\u8017\u65f6: " + duration + " ms");\n        System.out.println("\u541e\u5410\u91cf: " + throughput + " msg/s");\n    }\n}\n'})}),"\n",(0,a.jsx)(n.h2,{id:"\u6700\u4f73\u5b9e\u8df5\u6c47\u603b",children:"\u6700\u4f73\u5b9e\u8df5\u6c47\u603b"}),"\n",(0,a.jsx)(n.h3,{id:"\u5de5\u7a0b\u89c4\u8303",children:"\u5de5\u7a0b\u89c4\u8303"}),"\n",(0,a.jsx)(n.h4,{id:"1-\u5f02\u5e38\u5904\u7406",children:"1. \u5f02\u5e38\u5904\u7406"}),"\n",(0,a.jsxs)(n.p,{children:["\u603b\u662f\u5728 Handler \u4e2d\u5b9e\u73b0 ",(0,a.jsx)(n.code,{children:"exceptionCaught"})," \u65b9\u6cd5\uff0c\u786e\u4fdd\u5f02\u5e38\u88ab\u6b63\u786e\u5904\u7406\uff1a"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-java",children:'public class MyHandler extends ChannelInboundHandlerAdapter {\n    @Override\n    public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause) {\n        // \u8bb0\u5f55\u5f02\u5e38\n        logger.error("\u5f02\u5e38\u53d1\u751f", cause);\n        \n        // \u5206\u7c7b\u5904\u7406\n        if (cause instanceof IOException) {\n            logger.warn("\u8fde\u63a5\u5f02\u5e38: " + cause.getMessage());\n        } else if (cause instanceof DecoderException) {\n            logger.error("\u89e3\u7801\u5931\u8d25: " + cause.getMessage());\n        }\n        \n        // \u5173\u95ed\u8fde\u63a5\n        ctx.close();\n    }\n}\n'})}),"\n",(0,a.jsx)(n.h4,{id:"2-\u8d44\u6e90\u7ba1\u7406",children:"2. \u8d44\u6e90\u7ba1\u7406"}),"\n",(0,a.jsx)(n.p,{children:"\u4f7f\u7528 try-finally \u6216 try-with-resources \u786e\u4fdd\u8d44\u6e90\u91ca\u653e\uff1a"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-java",children:"// \u670d\u52a1\u5668\u542f\u52a8\nEventLoopGroup bossGroup = new NioEventLoopGroup(1);\nEventLoopGroup workerGroup = new NioEventLoopGroup();\n\ntry {\n    ServerBootstrap bootstrap = new ServerBootstrap();\n    // ... \u914d\u7f6e\n    ChannelFuture future = bootstrap.bind(port).sync();\n    future.channel().closeFuture().sync();\n} finally {\n    // \u5fc5\u987b\u91ca\u653e\u8d44\u6e90\n    bossGroup.shutdownGracefully();\n    workerGroup.shutdownGracefully();\n}\n"})}),"\n",(0,a.jsx)(n.h4,{id:"3-\u65e5\u5fd7\u8bb0\u5f55",children:"3. \u65e5\u5fd7\u8bb0\u5f55"}),"\n",(0,a.jsx)(n.p,{children:"\u4f7f\u7528 SLF4J \u6216 Logback \u8fdb\u884c\u65e5\u5fd7\u8bb0\u5f55\uff0c\u4fbf\u4e8e\u8c03\u8bd5\u548c\u76d1\u63a7\uff1a"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-java",children:'import org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\n\npublic class MyHandler extends ChannelInboundHandlerAdapter {\n    private static final Logger logger = LoggerFactory.getLogger(MyHandler.class);\n    \n    @Override\n    public void channelActive(ChannelHandlerContext ctx) {\n        logger.info("\u65b0\u8fde\u63a5: {}", ctx.channel().remoteAddress());\n    }\n    \n    @Override\n    protected void channelRead0(ChannelHandlerContext ctx, Object msg) {\n        logger.debug("\u63a5\u6536\u5230\u6d88\u606f: {}", msg);\n    }\n}\n'})}),"\n",(0,a.jsx)(n.h3,{id:"\u4ee3\u7801\u7ec4\u7ec7",children:"\u4ee3\u7801\u7ec4\u7ec7"}),"\n",(0,a.jsx)(n.h4,{id:"1-handler-\u804c\u8d23\u5206\u79bb",children:"1. Handler \u804c\u8d23\u5206\u79bb"}),"\n",(0,a.jsx)(n.p,{children:"\u4e3a\u4e0d\u540c\u7684\u529f\u80fd\u521b\u5efa\u4e13\u95e8\u7684 Handler\uff1a"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-java",children:"// \u89e3\u7801 Handler\npipeline.addLast(new StringDecoder(CharsetUtil.UTF_8));\n\n// \u4e1a\u52a1\u903b\u8f91 Handler\npipeline.addLast(new BusinessLogicHandler());\n\n// \u7f16\u7801 Handler\npipeline.addLast(new StringEncoder(CharsetUtil.UTF_8));\n\n// \u5f02\u5e38\u5904\u7406 Handler\uff08\u653e\u5728\u6700\u540e\uff09\npipeline.addLast(new ExceptionHandler());\n"})}),"\n",(0,a.jsx)(n.h4,{id:"2-\u907f\u514d-handler-\u4e2d\u7684\u963b\u585e\u64cd\u4f5c",children:"2. \u907f\u514d Handler \u4e2d\u7684\u963b\u585e\u64cd\u4f5c"}),"\n",(0,a.jsx)(n.p,{children:"\u8017\u65f6\u64cd\u4f5c\u5e94\u63d0\u4ea4\u5230\u72ec\u7acb\u7ebf\u7a0b\u6c60\uff1a"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-java",children:"public class MyHandler extends ChannelInboundHandlerAdapter {\n    private static final ExecutorService executor = Executors.newFixedThreadPool(10);\n    \n    @Override\n    public void channelRead(ChannelHandlerContext ctx, Object msg) {\n        // \u4e0d\u963b\u585e EventLoop\uff0c\u63d0\u4ea4\u5230\u7ebf\u7a0b\u6c60\n        executor.execute(() -> {\n            // \u8017\u65f6\u4e1a\u52a1\u903b\u8f91\n            processData(msg);\n            ctx.fireChannelRead(msg);\n        });\n    }\n}\n"})}),"\n",(0,a.jsx)(n.h4,{id:"3-handler-\u91cd\u7528\u6ce8\u610f\u4e8b\u9879",children:"3. Handler \u91cd\u7528\u6ce8\u610f\u4e8b\u9879"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-java",children:'// \u2717 \u9519\u8bef\uff1aHandler \u5305\u542b\u53ef\u53d8\u72b6\u6001\uff0c\u4e0d\u80fd\u91cd\u7528\npublic class BadHandler extends ChannelInboundHandlerAdapter {\n    private int counter = 0; // \u53ef\u53d8\u72b6\u6001\n    \n    @Override\n    public void channelRead(ChannelHandlerContext ctx, Object msg) {\n        counter++;\n    }\n}\n\n// \u2713 \u6b63\u786e\uff1aHandler \u65e0\u72b6\u6001\uff0c\u53ef\u4ee5\u91cd\u7528\npublic class GoodHandler extends ChannelInboundHandlerAdapter {\n    @Override\n    public void channelRead(ChannelHandlerContext ctx, Object msg) {\n        // \u4f7f\u7528 Channel \u7684 Attribute \u5b58\u50a8\u72b6\u6001\n        AttributeKey<Integer> key = AttributeKey.valueOf("counter");\n        Integer counter = ctx.channel().attr(key).getAndSet(0);\n    }\n}\n'})}),"\n",(0,a.jsx)(n.h3,{id:"\u5e38\u89c1\u9677\u9631",children:"\u5e38\u89c1\u9677\u9631"}),"\n",(0,a.jsx)(n.h4,{id:"1-channelfuture-\u5f02\u6b65\u5904\u7406",children:"1. ChannelFuture \u5f02\u6b65\u5904\u7406"}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.strong,{children:"\u9677\u9631\uff1a"})," \u540c\u6b65\u7b49\u5f85 ChannelFuture"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-java",children:'// \u2717 \u9519\u8bef\uff1a\u963b\u585e\u7ebf\u7a0b\nChannelFuture future = ctx.writeAndFlush(msg);\nfuture.sync(); // \u8fd9\u4f1a\u963b\u585e\u5f53\u524d\u7ebf\u7a0b\n\n// \u2713 \u6b63\u786e\uff1a\u5f02\u6b65\u5904\u7406\nChannelFuture future = ctx.writeAndFlush(msg);\nfuture.addListener((ChannelFutureListener) f -> {\n    if (f.isSuccess()) {\n        logger.info("\u6570\u636e\u5199\u5165\u6210\u529f");\n    } else {\n        logger.error("\u6570\u636e\u5199\u5165\u5931\u8d25", f.cause());\n    }\n});\n'})}),"\n",(0,a.jsx)(n.h4,{id:"2-\u4e8b\u4ef6\u4f20\u64ad",children:"2. \u4e8b\u4ef6\u4f20\u64ad"}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.strong,{children:"\u9677\u9631\uff1a"})," \u5fd8\u8bb0\u8c03\u7528 ",(0,a.jsx)(n.code,{children:"fireChannelRead"})," \u6216 ",(0,a.jsx)(n.code,{children:"ctx.close()"})]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-java",children:"// \u2717 \u9519\u8bef\uff1a\u4e8b\u4ef6\u6ca1\u6709\u4f20\u64ad\uff0c\u4e0b\u4e00\u4e2a Handler \u6536\u4e0d\u5230\n@Override\npublic void channelRead(ChannelHandlerContext ctx, Object msg) {\n    // \u5904\u7406\u6d88\u606f\u540e\u6ca1\u6709\u4f20\u64ad\n}\n\n// \u2713 \u6b63\u786e\uff1a\u4f20\u64ad\u4e8b\u4ef6\n@Override\npublic void channelRead(ChannelHandlerContext ctx, Object msg) {\n    processData(msg);\n    ctx.fireChannelRead(msg); // \u4f20\u64ad\u7ed9\u4e0b\u4e00\u4e2a Handler\n}\n"})}),"\n",(0,a.jsx)(n.h4,{id:"3-\u5185\u5b58\u7ba1\u7406",children:"3. \u5185\u5b58\u7ba1\u7406"}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.strong,{children:"\u9677\u9631\uff1a"})," \u5728\u81ea\u5b9a\u4e49 Codec \u4e2d\u5fd8\u8bb0\u91ca\u653e ByteBuf"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-java",children:"// \u2713 \u6b63\u786e\uff1a\u53ca\u65f6\u91ca\u653e\npublic class MyDecoder extends ByteToMessageDecoder {\n    @Override\n    protected void decode(ChannelHandlerContext ctx, ByteBuf in, List<Object> out) {\n        if (in.readableBytes() < 4) {\n            return;\n        }\n        \n        int length = in.readInt();\n        if (in.readableBytes() < length) {\n            in.readerIndex(in.readerIndex() - 4);\n            return;\n        }\n        \n        ByteBuf msg = in.readSlice(length);\n        msg.retain(); // \u4fdd\u6301\u5f15\u7528\n        out.add(msg); // \u6dfb\u52a0\u5230 out\uff0c\u7531\u4e0b\u4e00\u4e2a Handler \u91ca\u653e\n    }\n}\n"})}),"\n",(0,a.jsx)(n.h4,{id:"4-\u8fde\u63a5\u6cc4\u6f0f",children:"4. \u8fde\u63a5\u6cc4\u6f0f"}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.strong,{children:"\u9677\u9631\uff1a"})," \u6ca1\u6709\u6b63\u786e\u5904\u7406\u8fde\u63a5\u7684\u5173\u95ed"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-java",children:"// \u2717 \u9519\u8bef\uff1a\u8fde\u63a5\u53ef\u80fd\u4e0d\u4f1a\u6b63\u786e\u5173\u95ed\nif (error) {\n    return; // \u6ca1\u6709\u5173\u95ed\u8fde\u63a5\n}\n\n// \u2713 \u6b63\u786e\uff1a\u786e\u4fdd\u8fde\u63a5\u5173\u95ed\nif (error) {\n    ctx.close(); // \u5173\u95ed\u8fde\u63a5\n    return;\n}\n"})}),"\n",(0,a.jsx)(n.hr,{}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.a,{href:"/docs/netty/troubleshooting",children:"\u4e0b\u4e00\u7ae0\uff1a\u5e38\u89c1\u95ee\u9898\u4e0e\u6392\u67e5"})})]})}function h(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(d,{...e})}):d(e)}},48885:(e,n,t)=>{t.d(n,{R:()=>s,x:()=>r});var l=t(99378);const a={},i=l.createContext(a);function s(e){const n=l.useContext(i);return l.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:s(e.components),l.createElement(i.Provider,{value:n},e.children)}}}]);