"use strict";(globalThis.webpackChunkto_lib_github_io=globalThis.webpackChunkto_lib_github_io||[]).push([[91496],{25839:(n,e,t)=>{t.r(e),t.d(e,{assets:()=>d,contentTitle:()=>l,default:()=>c,frontMatter:()=>a,metadata:()=>i,toc:()=>o});const i=JSON.parse('{"id":"redis/common-scenarios","title":"\u5e38\u89c1\u4e1a\u52a1\u573a\u666f","description":"\u672c\u6587\u4ecb\u7ecd Redis \u5728\u5b9e\u9645\u9879\u76ee\u4e2d\u7684\u5e38\u89c1\u4f7f\u7528\u573a\u666f\u548c\u5b9e\u73b0\u65b9\u6848\uff0c\u5305\u542b\u5b8c\u6574\u7684\u4ee3\u7801\u793a\u4f8b\u3002","source":"@site/docs/redis/common-scenarios.md","sourceDirName":"redis","slug":"/redis/common-scenarios","permalink":"/docs/redis/common-scenarios","draft":false,"unlisted":false,"editUrl":"https://github.com/to-lib/to-lib.github.io/tree/main/docs/redis/common-scenarios.md","tags":[],"version":"current","sidebarPosition":22,"frontMatter":{"sidebar_position":22,"title":"\u5e38\u89c1\u4e1a\u52a1\u573a\u666f"},"sidebar":"redis","previous":{"title":"Spring Boot \u96c6\u6210","permalink":"/docs/redis/spring-integration"},"next":{"title":"\u5b9e\u6218\u6848\u4f8b","permalink":"/docs/redis/practical-examples"}}');var r=t(22714),s=t(48885);const a={sidebar_position:22,title:"\u5e38\u89c1\u4e1a\u52a1\u573a\u666f"},l="Redis \u5e38\u89c1\u4e1a\u52a1\u573a\u666f\u5b9e\u73b0",d={},o=[{value:"\u5206\u5e03\u5f0f Session",id:"\u5206\u5e03\u5f0f-session",level:2},{value:"\u95ee\u9898\u80cc\u666f",id:"\u95ee\u9898\u80cc\u666f",level:3},{value:"\u5b9e\u73b0\u65b9\u6848",id:"\u5b9e\u73b0\u65b9\u6848",level:3},{value:"Session \u64cd\u4f5c",id:"session-\u64cd\u4f5c",level:3},{value:"\u5168\u5c40\u552f\u4e00 ID \u751f\u6210\u5668",id:"\u5168\u5c40\u552f\u4e00-id-\u751f\u6210\u5668",level:2},{value:"\u65b9\u6848\u4e00\uff1aINCR \u81ea\u589e",id:"\u65b9\u6848\u4e00incr-\u81ea\u589e",level:3},{value:"\u65b9\u6848\u4e8c\uff1a\u96ea\u82b1\u7b97\u6cd5 + Redis \u5206\u914d\u673a\u5668 ID",id:"\u65b9\u6848\u4e8c\u96ea\u82b1\u7b97\u6cd5--redis-\u5206\u914d\u673a\u5668-id",level:3},{value:"\u5ef6\u8fdf\u961f\u5217",id:"\u5ef6\u8fdf\u961f\u5217",level:2},{value:"\u57fa\u4e8e Sorted Set \u5b9e\u73b0",id:"\u57fa\u4e8e-sorted-set-\u5b9e\u73b0",level:3},{value:"\u6d88\u8d39\u8005\u793a\u4f8b",id:"\u6d88\u8d39\u8005\u793a\u4f8b",level:3},{value:"\u4f7f\u7528\u793a\u4f8b",id:"\u4f7f\u7528\u793a\u4f8b",level:3},{value:"\u6ed1\u52a8\u7a97\u53e3\u9650\u6d41",id:"\u6ed1\u52a8\u7a97\u53e3\u9650\u6d41",level:2},{value:"\u5b9e\u73b0",id:"\u5b9e\u73b0",level:3},{value:"\u4f7f\u7528\u793a\u4f8b",id:"\u4f7f\u7528\u793a\u4f8b-1",level:3},{value:"AOP \u6ce8\u89e3\u65b9\u5f0f",id:"aop-\u6ce8\u89e3\u65b9\u5f0f",level:3},{value:"\u6392\u884c\u699c",id:"\u6392\u884c\u699c",level:2},{value:"\u5b9e\u73b0",id:"\u5b9e\u73b0-1",level:3},{value:"\u4f7f\u7528\u793a\u4f8b",id:"\u4f7f\u7528\u793a\u4f8b-2",level:3},{value:"\u62a2\u7ea2\u5305",id:"\u62a2\u7ea2\u5305",level:2},{value:"\u5b9e\u73b0",id:"\u5b9e\u73b0-2",level:3},{value:"\u8d2d\u7269\u8f66",id:"\u8d2d\u7269\u8f66",level:2},{value:"\u5b9e\u73b0",id:"\u5b9e\u73b0-3",level:3},{value:"\u70b9\u8d5e\u529f\u80fd",id:"\u70b9\u8d5e\u529f\u80fd",level:2},{value:"\u5b9e\u73b0",id:"\u5b9e\u73b0-4",level:3},{value:"\u5728\u7ebf\u7528\u6237\u7edf\u8ba1",id:"\u5728\u7ebf\u7528\u6237\u7edf\u8ba1",level:2},{value:"\u4f7f\u7528 Bitmap \u5b9e\u73b0",id:"\u4f7f\u7528-bitmap-\u5b9e\u73b0",level:3},{value:"\u5c0f\u7ed3",id:"\u5c0f\u7ed3",level:2}];function u(n){const e={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,s.R)(),...n.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(e.header,{children:(0,r.jsx)(e.h1,{id:"redis-\u5e38\u89c1\u4e1a\u52a1\u573a\u666f\u5b9e\u73b0",children:"Redis \u5e38\u89c1\u4e1a\u52a1\u573a\u666f\u5b9e\u73b0"})}),"\n",(0,r.jsx)(e.p,{children:"\u672c\u6587\u4ecb\u7ecd Redis \u5728\u5b9e\u9645\u9879\u76ee\u4e2d\u7684\u5e38\u89c1\u4f7f\u7528\u573a\u666f\u548c\u5b9e\u73b0\u65b9\u6848\uff0c\u5305\u542b\u5b8c\u6574\u7684\u4ee3\u7801\u793a\u4f8b\u3002"}),"\n",(0,r.jsx)(e.h2,{id:"\u5206\u5e03\u5f0f-session",children:"\u5206\u5e03\u5f0f Session"}),"\n",(0,r.jsx)(e.h3,{id:"\u95ee\u9898\u80cc\u666f",children:"\u95ee\u9898\u80cc\u666f"}),"\n",(0,r.jsx)(e.p,{children:"\u5728\u5fae\u670d\u52a1\u67b6\u6784\u4e2d\uff0c\u591a\u4e2a\u670d\u52a1\u5b9e\u4f8b\u9700\u8981\u5171\u4eab\u7528\u6237 Session \u6570\u636e\u3002"}),"\n",(0,r.jsx)(e.h3,{id:"\u5b9e\u73b0\u65b9\u6848",children:"\u5b9e\u73b0\u65b9\u6848"}),"\n",(0,r.jsx)(e.p,{children:"\u4f7f\u7528 Spring Session + Redis\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-yaml",children:"# application.yml\nspring:\n  session:\n    store-type: redis\n    timeout: 30m\n  redis:\n    host: localhost\n    port: 6379\n"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"@Configuration\n@EnableRedisHttpSession(maxInactiveIntervalInSeconds = 1800)\npublic class SessionConfig {\n    \n    @Bean\n    public RedisSerializer<Object> springSessionDefaultRedisSerializer() {\n        return new GenericJackson2JsonRedisSerializer();\n    }\n}\n"})}),"\n",(0,r.jsx)(e.h3,{id:"session-\u64cd\u4f5c",children:"Session \u64cd\u4f5c"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'@RestController\npublic class SessionController {\n    \n    @PostMapping("/login")\n    public Result login(@RequestBody LoginRequest request, HttpSession session) {\n        // \u9a8c\u8bc1\u7528\u6237\n        User user = userService.login(request.getUsername(), request.getPassword());\n        if (user != null) {\n            session.setAttribute("user", user);\n            session.setAttribute("loginTime", System.currentTimeMillis());\n            return Result.success("\u767b\u5f55\u6210\u529f");\n        }\n        return Result.fail("\u7528\u6237\u540d\u6216\u5bc6\u7801\u9519\u8bef");\n    }\n    \n    @GetMapping("/user/info")\n    public Result getUserInfo(HttpSession session) {\n        User user = (User) session.getAttribute("user");\n        if (user == null) {\n            return Result.fail("\u672a\u767b\u5f55");\n        }\n        return Result.success(user);\n    }\n    \n    @PostMapping("/logout")\n    public Result logout(HttpSession session) {\n        session.invalidate();\n        return Result.success("\u9000\u51fa\u6210\u529f");\n    }\n}\n'})}),"\n",(0,r.jsx)(e.h2,{id:"\u5168\u5c40\u552f\u4e00-id-\u751f\u6210\u5668",children:"\u5168\u5c40\u552f\u4e00 ID \u751f\u6210\u5668"}),"\n",(0,r.jsx)(e.h3,{id:"\u65b9\u6848\u4e00incr-\u81ea\u589e",children:"\u65b9\u6848\u4e00\uff1aINCR \u81ea\u589e"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'@Component\npublic class RedisIdGenerator {\n    \n    @Autowired\n    private StringRedisTemplate redisTemplate;\n    \n    private static final String ID_KEY = "id:generator:";\n    \n    /**\n     * \u751f\u6210\u552f\u4e00 ID\n     * \u683c\u5f0f: \u65f6\u95f4\u6233(10\u4f4d) + \u5e8f\u5217\u53f7(5\u4f4d)\n     */\n    public long nextId(String bizType) {\n        // \u83b7\u53d6\u5f53\u5929\u65e5\u671f\u4f5c\u4e3a key \u7684\u4e00\u90e8\u5206\n        String today = LocalDate.now().format(DateTimeFormatter.BASIC_ISO_DATE);\n        String key = ID_KEY + bizType + ":" + today;\n        \n        // \u81ea\u589e\n        Long increment = redisTemplate.opsForValue().increment(key);\n        \n        // \u8bbe\u7f6e\u8fc7\u671f\u65f6\u95f4\uff08\u7b2c\u4e8c\u5929\u8fc7\u671f\uff09\n        if (increment == 1) {\n            redisTemplate.expire(key, Duration.ofDays(2));\n        }\n        \n        // \u7ec4\u5408 ID: \u65f6\u95f4\u6233 + \u5e8f\u5217\u53f7\n        long timestamp = LocalDate.now().atStartOfDay()\n            .toEpochSecond(ZoneOffset.of("+8"));\n        return timestamp * 100000 + increment;\n    }\n}\n'})}),"\n",(0,r.jsx)(e.h3,{id:"\u65b9\u6848\u4e8c\u96ea\u82b1\u7b97\u6cd5--redis-\u5206\u914d\u673a\u5668-id",children:"\u65b9\u6848\u4e8c\uff1a\u96ea\u82b1\u7b97\u6cd5 + Redis \u5206\u914d\u673a\u5668 ID"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'@Component\npublic class SnowflakeIdGenerator {\n    \n    private static final long EPOCH = 1704067200000L; // 2024-01-01\n    private static final long WORKER_ID_BITS = 10L;\n    private static final long SEQUENCE_BITS = 12L;\n    \n    private final long workerId;\n    private long sequence = 0L;\n    private long lastTimestamp = -1L;\n    \n    @Autowired\n    public SnowflakeIdGenerator(StringRedisTemplate redisTemplate) {\n        // \u4ece Redis \u83b7\u53d6\u673a\u5668 ID\n        Long id = redisTemplate.opsForValue().increment("snowflake:worker:id");\n        this.workerId = id % (1 << WORKER_ID_BITS);\n    }\n    \n    public synchronized long nextId() {\n        long timestamp = System.currentTimeMillis();\n        \n        if (timestamp < lastTimestamp) {\n            throw new RuntimeException("\u65f6\u949f\u56de\u62e8");\n        }\n        \n        if (timestamp == lastTimestamp) {\n            sequence = (sequence + 1) & ((1 << SEQUENCE_BITS) - 1);\n            if (sequence == 0) {\n                timestamp = waitNextMillis(lastTimestamp);\n            }\n        } else {\n            sequence = 0L;\n        }\n        \n        lastTimestamp = timestamp;\n        \n        return ((timestamp - EPOCH) << (WORKER_ID_BITS + SEQUENCE_BITS))\n                | (workerId << SEQUENCE_BITS)\n                | sequence;\n    }\n    \n    private long waitNextMillis(long lastTimestamp) {\n        long timestamp = System.currentTimeMillis();\n        while (timestamp <= lastTimestamp) {\n            timestamp = System.currentTimeMillis();\n        }\n        return timestamp;\n    }\n}\n'})}),"\n",(0,r.jsx)(e.h2,{id:"\u5ef6\u8fdf\u961f\u5217",children:"\u5ef6\u8fdf\u961f\u5217"}),"\n",(0,r.jsx)(e.h3,{id:"\u57fa\u4e8e-sorted-set-\u5b9e\u73b0",children:"\u57fa\u4e8e Sorted Set \u5b9e\u73b0"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'@Component\npublic class DelayQueue {\n    \n    @Autowired\n    private StringRedisTemplate redisTemplate;\n    \n    private static final String DELAY_QUEUE_KEY = "delay:queue:";\n    \n    /**\n     * \u6dfb\u52a0\u5ef6\u8fdf\u4efb\u52a1\n     */\n    public void addTask(String queueName, String taskId, long delaySeconds) {\n        long executeTime = System.currentTimeMillis() + delaySeconds * 1000;\n        redisTemplate.opsForZSet().add(\n            DELAY_QUEUE_KEY + queueName,\n            taskId,\n            executeTime\n        );\n    }\n    \n    /**\n     * \u83b7\u53d6\u5230\u671f\u7684\u4efb\u52a1\n     */\n    public Set<String> pollTasks(String queueName, int count) {\n        long now = System.currentTimeMillis();\n        String key = DELAY_QUEUE_KEY + queueName;\n        \n        // \u83b7\u53d6\u5230\u671f\u7684\u4efb\u52a1\n        Set<String> tasks = redisTemplate.opsForZSet()\n            .rangeByScore(key, 0, now, 0, count);\n        \n        if (tasks != null && !tasks.isEmpty()) {\n            // \u79fb\u9664\u5df2\u83b7\u53d6\u7684\u4efb\u52a1\n            for (String task : tasks) {\n                redisTemplate.opsForZSet().remove(key, task);\n            }\n        }\n        \n        return tasks;\n    }\n    \n    /**\n     * \u53d6\u6d88\u4efb\u52a1\n     */\n    public void cancelTask(String queueName, String taskId) {\n        redisTemplate.opsForZSet().remove(DELAY_QUEUE_KEY + queueName, taskId);\n    }\n}\n'})}),"\n",(0,r.jsx)(e.h3,{id:"\u6d88\u8d39\u8005\u793a\u4f8b",children:"\u6d88\u8d39\u8005\u793a\u4f8b"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'@Component\npublic class DelayQueueConsumer {\n    \n    @Autowired\n    private DelayQueue delayQueue;\n    \n    @Scheduled(fixedDelay = 1000)  // \u6bcf\u79d2\u6267\u884c\n    public void consume() {\n        Set<String> tasks = delayQueue.pollTasks("order:timeout", 10);\n        if (tasks != null) {\n            for (String taskId : tasks) {\n                // \u5904\u7406\u4efb\u52a1\n                handleOrderTimeout(taskId);\n            }\n        }\n    }\n    \n    private void handleOrderTimeout(String orderId) {\n        // \u8ba2\u5355\u8d85\u65f6\u5904\u7406\u903b\u8f91\n        log.info("\u5904\u7406\u8d85\u65f6\u8ba2\u5355: {}", orderId);\n    }\n}\n'})}),"\n",(0,r.jsx)(e.h3,{id:"\u4f7f\u7528\u793a\u4f8b",children:"\u4f7f\u7528\u793a\u4f8b"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'// \u8ba2\u5355\u521b\u5efa\u540e\uff0c30 \u5206\u949f\u672a\u652f\u4ed8\u81ea\u52a8\u53d6\u6d88\ndelayQueue.addTask("order:timeout", orderId, 30 * 60);\n\n// \u7528\u6237\u652f\u4ed8\u6210\u529f\u540e\uff0c\u53d6\u6d88\u5ef6\u8fdf\u4efb\u52a1\ndelayQueue.cancelTask("order:timeout", orderId);\n'})}),"\n",(0,r.jsx)(e.h2,{id:"\u6ed1\u52a8\u7a97\u53e3\u9650\u6d41",children:"\u6ed1\u52a8\u7a97\u53e3\u9650\u6d41"}),"\n",(0,r.jsx)(e.h3,{id:"\u5b9e\u73b0",children:"\u5b9e\u73b0"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"@Component\npublic class SlidingWindowRateLimiter {\n    \n    @Autowired\n    private StringRedisTemplate redisTemplate;\n    \n    /**\n     * \u6ed1\u52a8\u7a97\u53e3\u9650\u6d41\n     * @param key \u9650\u6d41 key\n     * @param limit \u9650\u5236\u6b21\u6570\n     * @param windowSeconds \u7a97\u53e3\u65f6\u95f4\uff08\u79d2\uff09\n     * @return true-\u5141\u8bb8, false-\u9650\u6d41\n     */\n    public boolean isAllowed(String key, int limit, int windowSeconds) {\n        long now = System.currentTimeMillis();\n        long windowStart = now - windowSeconds * 1000L;\n        \n        String rateLimitKey = \"ratelimit:\" + key;\n        \n        // \u4f7f\u7528 Lua \u811a\u672c\u4fdd\u8bc1\u539f\u5b50\u6027\n        String script = \"\"\"\n            -- \u79fb\u9664\u7a97\u53e3\u5916\u7684\u8bf7\u6c42\n            redis.call('ZREMRANGEBYSCORE', KEYS[1], 0, ARGV[1])\n            \n            -- \u83b7\u53d6\u5f53\u524d\u7a97\u53e3\u5185\u7684\u8bf7\u6c42\u6570\n            local count = redis.call('ZCARD', KEYS[1])\n            \n            if count < tonumber(ARGV[2]) then\n                -- \u672a\u8d85\u8fc7\u9650\u5236\uff0c\u6dfb\u52a0\u5f53\u524d\u8bf7\u6c42\n                redis.call('ZADD', KEYS[1], ARGV[3], ARGV[3])\n                redis.call('EXPIRE', KEYS[1], ARGV[4])\n                return 1\n            else\n                return 0\n            end\n            \"\"\";\n        \n        Long result = redisTemplate.execute(\n            new DefaultRedisScript<>(script, Long.class),\n            Collections.singletonList(rateLimitKey),\n            String.valueOf(windowStart),\n            String.valueOf(limit),\n            String.valueOf(now),\n            String.valueOf(windowSeconds)\n        );\n        \n        return Long.valueOf(1).equals(result);\n    }\n}\n"})}),"\n",(0,r.jsx)(e.h3,{id:"\u4f7f\u7528\u793a\u4f8b-1",children:"\u4f7f\u7528\u793a\u4f8b"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'@RestController\npublic class ApiController {\n    \n    @Autowired\n    private SlidingWindowRateLimiter rateLimiter;\n    \n    @GetMapping("/api/data")\n    public Result getData(HttpServletRequest request) {\n        String clientIp = request.getRemoteAddr();\n        \n        // \u6bcf\u4e2a IP \u6bcf\u5206\u949f\u6700\u591a 100 \u6b21\u8bf7\u6c42\n        if (!rateLimiter.isAllowed(clientIp, 100, 60)) {\n            return Result.fail("\u8bf7\u6c42\u8fc7\u4e8e\u9891\u7e41\uff0c\u8bf7\u7a0d\u540e\u518d\u8bd5");\n        }\n        \n        // \u6b63\u5e38\u5904\u7406\n        return Result.success(dataService.getData());\n    }\n}\n'})}),"\n",(0,r.jsx)(e.h3,{id:"aop-\u6ce8\u89e3\u65b9\u5f0f",children:"AOP \u6ce8\u89e3\u65b9\u5f0f"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'@Target(ElementType.METHOD)\n@Retention(RetentionPolicy.RUNTIME)\npublic @interface RateLimit {\n    int limit() default 100;\n    int window() default 60;\n    String key() default "";\n}\n\n@Aspect\n@Component\npublic class RateLimitAspect {\n    \n    @Autowired\n    private SlidingWindowRateLimiter rateLimiter;\n    \n    @Around("@annotation(rateLimit)")\n    public Object around(ProceedingJoinPoint point, RateLimit rateLimit) throws Throwable {\n        String key = rateLimit.key();\n        if (key.isEmpty()) {\n            key = point.getSignature().toShortString();\n        }\n        \n        if (!rateLimiter.isAllowed(key, rateLimit.limit(), rateLimit.window())) {\n            throw new RuntimeException("\u8bf7\u6c42\u8fc7\u4e8e\u9891\u7e41");\n        }\n        \n        return point.proceed();\n    }\n}\n\n// \u4f7f\u7528\n@RateLimit(limit = 10, window = 60, key = "api:sendSms")\npublic void sendSms(String phone) {\n    // ...\n}\n'})}),"\n",(0,r.jsx)(e.h2,{id:"\u6392\u884c\u699c",children:"\u6392\u884c\u699c"}),"\n",(0,r.jsx)(e.h3,{id:"\u5b9e\u73b0-1",children:"\u5b9e\u73b0"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'@Service\npublic class LeaderboardService {\n    \n    @Autowired\n    private StringRedisTemplate redisTemplate;\n    \n    private static final String LEADERBOARD_KEY = "leaderboard:";\n    \n    /**\n     * \u66f4\u65b0\u5206\u6570\n     */\n    public void updateScore(String boardName, String userId, double score) {\n        redisTemplate.opsForZSet().add(LEADERBOARD_KEY + boardName, userId, score);\n    }\n    \n    /**\n     * \u589e\u52a0\u5206\u6570\n     */\n    public Double incrementScore(String boardName, String userId, double delta) {\n        return redisTemplate.opsForZSet()\n            .incrementScore(LEADERBOARD_KEY + boardName, userId, delta);\n    }\n    \n    /**\n     * \u83b7\u53d6\u7528\u6237\u6392\u540d\uff08\u4ece 0 \u5f00\u59cb\uff09\n     */\n    public Long getRank(String boardName, String userId) {\n        return redisTemplate.opsForZSet()\n            .reverseRank(LEADERBOARD_KEY + boardName, userId);\n    }\n    \n    /**\n     * \u83b7\u53d6\u7528\u6237\u5206\u6570\n     */\n    public Double getScore(String boardName, String userId) {\n        return redisTemplate.opsForZSet()\n            .score(LEADERBOARD_KEY + boardName, userId);\n    }\n    \n    /**\n     * \u83b7\u53d6\u6392\u884c\u699c\uff08Top N\uff09\n     */\n    public List<UserRank> getTopN(String boardName, int n) {\n        Set<ZSetOperations.TypedTuple<String>> tuples = redisTemplate.opsForZSet()\n            .reverseRangeWithScores(LEADERBOARD_KEY + boardName, 0, n - 1);\n        \n        List<UserRank> result = new ArrayList<>();\n        if (tuples != null) {\n            int rank = 1;\n            for (ZSetOperations.TypedTuple<String> tuple : tuples) {\n                result.add(new UserRank(rank++, tuple.getValue(), tuple.getScore()));\n            }\n        }\n        return result;\n    }\n    \n    /**\n     * \u83b7\u53d6\u7528\u6237\u5468\u56f4\u7684\u6392\u540d\n     */\n    public List<UserRank> getAroundRank(String boardName, String userId, int range) {\n        Long rank = getRank(boardName, userId);\n        if (rank == null) {\n            return Collections.emptyList();\n        }\n        \n        long start = Math.max(0, rank - range);\n        long end = rank + range;\n        \n        Set<ZSetOperations.TypedTuple<String>> tuples = redisTemplate.opsForZSet()\n            .reverseRangeWithScores(LEADERBOARD_KEY + boardName, start, end);\n        \n        List<UserRank> result = new ArrayList<>();\n        if (tuples != null) {\n            int currentRank = (int) start + 1;\n            for (ZSetOperations.TypedTuple<String> tuple : tuples) {\n                result.add(new UserRank(currentRank++, tuple.getValue(), tuple.getScore()));\n            }\n        }\n        return result;\n    }\n}\n\n@Data\n@AllArgsConstructor\npublic class UserRank {\n    private int rank;\n    private String userId;\n    private Double score;\n}\n'})}),"\n",(0,r.jsx)(e.h3,{id:"\u4f7f\u7528\u793a\u4f8b-2",children:"\u4f7f\u7528\u793a\u4f8b"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'// \u6e38\u620f\u7ed3\u675f\u540e\u66f4\u65b0\u5206\u6570\nleaderboardService.incrementScore("game:daily", "user:1001", 100);\n\n// \u83b7\u53d6\u6392\u884c\u699c Top 10\nList<UserRank> top10 = leaderboardService.getTopN("game:daily", 10);\n\n// \u83b7\u53d6\u7528\u6237\u6392\u540d\nLong rank = leaderboardService.getRank("game:daily", "user:1001");\n\n// \u83b7\u53d6\u7528\u6237\u5468\u56f4\u7684\u6392\u540d\nList<UserRank> around = leaderboardService.getAroundRank("game:daily", "user:1001", 5);\n'})}),"\n",(0,r.jsx)(e.h2,{id:"\u62a2\u7ea2\u5305",children:"\u62a2\u7ea2\u5305"}),"\n",(0,r.jsx)(e.h3,{id:"\u5b9e\u73b0-2",children:"\u5b9e\u73b0"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'@Service\npublic class RedPacketService {\n    \n    @Autowired\n    private StringRedisTemplate redisTemplate;\n    \n    private static final String RED_PACKET_KEY = "redpacket:";\n    private static final String RED_PACKET_RECORD = "redpacket:record:";\n    \n    /**\n     * \u521b\u5efa\u7ea2\u5305\n     */\n    public void createRedPacket(String packetId, double totalAmount, int count) {\n        // \u4f7f\u7528\u4e8c\u500d\u5747\u503c\u6cd5\u5206\u914d\u7ea2\u5305\n        List<Double> amounts = divideRedPacket(totalAmount, count);\n        \n        // \u5b58\u5165 Redis List\n        String key = RED_PACKET_KEY + packetId;\n        for (Double amount : amounts) {\n            redisTemplate.opsForList().rightPush(key, String.format("%.2f", amount));\n        }\n        \n        // \u8bbe\u7f6e\u8fc7\u671f\u65f6\u95f4\uff0824 \u5c0f\u65f6\uff09\n        redisTemplate.expire(key, Duration.ofHours(24));\n    }\n    \n    /**\n     * \u62a2\u7ea2\u5305\n     */\n    public Double grabRedPacket(String packetId, String userId) {\n        String recordKey = RED_PACKET_RECORD + packetId;\n        \n        // \u68c0\u67e5\u662f\u5426\u5df2\u62a2\u8fc7\n        if (redisTemplate.opsForSet().isMember(recordKey, userId)) {\n            throw new RuntimeException("\u60a8\u5df2\u7ecf\u62a2\u8fc7\u8fd9\u4e2a\u7ea2\u5305\u4e86");\n        }\n        \n        // \u62a2\u7ea2\u5305\uff08\u539f\u5b50\u64cd\u4f5c\uff09\n        String key = RED_PACKET_KEY + packetId;\n        String amount = redisTemplate.opsForList().leftPop(key);\n        \n        if (amount == null) {\n            throw new RuntimeException("\u7ea2\u5305\u5df2\u88ab\u62a2\u5b8c");\n        }\n        \n        // \u8bb0\u5f55\u62a2\u7ea2\u5305\n        redisTemplate.opsForSet().add(recordKey, userId);\n        redisTemplate.expire(recordKey, Duration.ofHours(24));\n        \n        return Double.parseDouble(amount);\n    }\n    \n    /**\n     * \u4e8c\u500d\u5747\u503c\u6cd5\u5206\u914d\u7ea2\u5305\n     */\n    private List<Double> divideRedPacket(double totalAmount, int count) {\n        List<Double> amounts = new ArrayList<>();\n        Random random = new Random();\n        double remaining = totalAmount;\n        \n        for (int i = 0; i < count - 1; i++) {\n            // \u6700\u5c0f 0.01\uff0c\u6700\u5927\u662f\u5269\u4f59\u5e73\u5747\u503c\u7684 2 \u500d\n            double max = remaining / (count - i) * 2;\n            double amount = Math.max(0.01, random.nextDouble() * max);\n            amount = Math.round(amount * 100) / 100.0;\n            amounts.add(amount);\n            remaining -= amount;\n        }\n        \n        // \u6700\u540e\u4e00\u4e2a\u7ea2\u5305\n        amounts.add(Math.round(remaining * 100) / 100.0);\n        return amounts;\n    }\n}\n'})}),"\n",(0,r.jsx)(e.h2,{id:"\u8d2d\u7269\u8f66",children:"\u8d2d\u7269\u8f66"}),"\n",(0,r.jsx)(e.h3,{id:"\u5b9e\u73b0-3",children:"\u5b9e\u73b0"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'@Service\npublic class CartService {\n    \n    @Autowired\n    private StringRedisTemplate redisTemplate;\n    \n    private static final String CART_KEY = "cart:";\n    \n    /**\n     * \u6dfb\u52a0\u5546\u54c1\u5230\u8d2d\u7269\u8f66\n     */\n    public void addItem(String userId, String productId, int quantity) {\n        String key = CART_KEY + userId;\n        \n        // \u5982\u679c\u5546\u54c1\u5df2\u5b58\u5728\uff0c\u589e\u52a0\u6570\u91cf\n        Object existing = redisTemplate.opsForHash().get(key, productId);\n        if (existing != null) {\n            quantity += Integer.parseInt(existing.toString());\n        }\n        \n        redisTemplate.opsForHash().put(key, productId, String.valueOf(quantity));\n    }\n    \n    /**\n     * \u4fee\u6539\u5546\u54c1\u6570\u91cf\n     */\n    public void updateQuantity(String userId, String productId, int quantity) {\n        String key = CART_KEY + userId;\n        if (quantity <= 0) {\n            redisTemplate.opsForHash().delete(key, productId);\n        } else {\n            redisTemplate.opsForHash().put(key, productId, String.valueOf(quantity));\n        }\n    }\n    \n    /**\n     * \u79fb\u9664\u5546\u54c1\n     */\n    public void removeItem(String userId, String productId) {\n        redisTemplate.opsForHash().delete(CART_KEY + userId, productId);\n    }\n    \n    /**\n     * \u83b7\u53d6\u8d2d\u7269\u8f66\n     */\n    public Map<String, Integer> getCart(String userId) {\n        Map<Object, Object> entries = redisTemplate.opsForHash()\n            .entries(CART_KEY + userId);\n        \n        Map<String, Integer> cart = new HashMap<>();\n        entries.forEach((k, v) -> cart.put(k.toString(), Integer.parseInt(v.toString())));\n        return cart;\n    }\n    \n    /**\n     * \u6e05\u7a7a\u8d2d\u7269\u8f66\n     */\n    public void clearCart(String userId) {\n        redisTemplate.delete(CART_KEY + userId);\n    }\n    \n    /**\n     * \u83b7\u53d6\u8d2d\u7269\u8f66\u5546\u54c1\u6570\u91cf\n     */\n    public Long getItemCount(String userId) {\n        return redisTemplate.opsForHash().size(CART_KEY + userId);\n    }\n}\n'})}),"\n",(0,r.jsx)(e.h2,{id:"\u70b9\u8d5e\u529f\u80fd",children:"\u70b9\u8d5e\u529f\u80fd"}),"\n",(0,r.jsx)(e.h3,{id:"\u5b9e\u73b0-4",children:"\u5b9e\u73b0"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'@Service\npublic class LikeService {\n    \n    @Autowired\n    private StringRedisTemplate redisTemplate;\n    \n    private static final String LIKE_KEY = "like:";\n    private static final String LIKE_COUNT_KEY = "like:count:";\n    \n    /**\n     * \u70b9\u8d5e\n     */\n    public boolean like(String targetId, String userId) {\n        String key = LIKE_KEY + targetId;\n        Long added = redisTemplate.opsForSet().add(key, userId);\n        \n        if (added != null && added > 0) {\n            // \u589e\u52a0\u70b9\u8d5e\u8ba1\u6570\n            redisTemplate.opsForValue().increment(LIKE_COUNT_KEY + targetId);\n            return true;\n        }\n        return false;\n    }\n    \n    /**\n     * \u53d6\u6d88\u70b9\u8d5e\n     */\n    public boolean unlike(String targetId, String userId) {\n        String key = LIKE_KEY + targetId;\n        Long removed = redisTemplate.opsForSet().remove(key, userId);\n        \n        if (removed != null && removed > 0) {\n            redisTemplate.opsForValue().decrement(LIKE_COUNT_KEY + targetId);\n            return true;\n        }\n        return false;\n    }\n    \n    /**\n     * \u662f\u5426\u5df2\u70b9\u8d5e\n     */\n    public boolean isLiked(String targetId, String userId) {\n        return Boolean.TRUE.equals(\n            redisTemplate.opsForSet().isMember(LIKE_KEY + targetId, userId)\n        );\n    }\n    \n    /**\n     * \u83b7\u53d6\u70b9\u8d5e\u6570\n     */\n    public long getLikeCount(String targetId) {\n        String count = redisTemplate.opsForValue().get(LIKE_COUNT_KEY + targetId);\n        return count == null ? 0 : Long.parseLong(count);\n    }\n    \n    /**\n     * \u83b7\u53d6\u70b9\u8d5e\u7528\u6237\u5217\u8868\n     */\n    public Set<String> getLikeUsers(String targetId) {\n        return redisTemplate.opsForSet().members(LIKE_KEY + targetId);\n    }\n}\n'})}),"\n",(0,r.jsx)(e.h2,{id:"\u5728\u7ebf\u7528\u6237\u7edf\u8ba1",children:"\u5728\u7ebf\u7528\u6237\u7edf\u8ba1"}),"\n",(0,r.jsx)(e.h3,{id:"\u4f7f\u7528-bitmap-\u5b9e\u73b0",children:"\u4f7f\u7528 Bitmap \u5b9e\u73b0"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'@Service\npublic class OnlineUserService {\n    \n    @Autowired\n    private StringRedisTemplate redisTemplate;\n    \n    private static final String ONLINE_KEY = "online:users:";\n    \n    /**\n     * \u7528\u6237\u4e0a\u7ebf\n     */\n    public void online(String date, long userId) {\n        redisTemplate.opsForValue().setBit(ONLINE_KEY + date, userId, true);\n    }\n    \n    /**\n     * \u7528\u6237\u4e0b\u7ebf\n     */\n    public void offline(String date, long userId) {\n        redisTemplate.opsForValue().setBit(ONLINE_KEY + date, userId, false);\n    }\n    \n    /**\n     * \u68c0\u67e5\u7528\u6237\u662f\u5426\u5728\u7ebf\n     */\n    public boolean isOnline(String date, long userId) {\n        return Boolean.TRUE.equals(\n            redisTemplate.opsForValue().getBit(ONLINE_KEY + date, userId)\n        );\n    }\n    \n    /**\n     * \u7edf\u8ba1\u5728\u7ebf\u7528\u6237\u6570\n     */\n    public long countOnlineUsers(String date) {\n        // \u4f7f\u7528 BITCOUNT \u547d\u4ee4\n        return redisTemplate.execute((RedisCallback<Long>) connection -> \n            connection.bitCount(\n                (ONLINE_KEY + date).getBytes()\n            )\n        );\n    }\n    \n    /**\n     * \u7edf\u8ba1\u8fde\u7eed\u767b\u5f55\u7528\u6237\n     */\n    public long countContinuousUsers(String... dates) {\n        // \u8ba1\u7b97\u591a\u5929\u7684 AND \u7ed3\u679c\n        byte[][] keys = Arrays.stream(dates)\n            .map(d -> (ONLINE_KEY + d).getBytes())\n            .toArray(byte[][]::new);\n        \n        String resultKey = "online:continuous";\n        redisTemplate.execute((RedisCallback<Long>) connection -> {\n            connection.bitOp(RedisStringCommands.BitOperation.AND, \n                resultKey.getBytes(), keys);\n            return null;\n        });\n        \n        return redisTemplate.execute((RedisCallback<Long>) connection ->\n            connection.bitCount(resultKey.getBytes())\n        );\n    }\n}\n'})}),"\n",(0,r.jsx)(e.h2,{id:"\u5c0f\u7ed3",children:"\u5c0f\u7ed3"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,r.jsxs)(e.table,{children:[(0,r.jsx)(e.thead,{children:(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.th,{children:"\u573a\u666f"}),(0,r.jsx)(e.th,{children:"Redis \u6570\u636e\u7ed3\u6784"}),(0,r.jsx)(e.th,{children:"\u6838\u5fc3\u547d\u4ee4"})]})}),(0,r.jsxs)(e.tbody,{children:[(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"\u5206\u5e03\u5f0f Session"}),(0,r.jsx)(e.td,{children:"Hash"}),(0,r.jsx)(e.td,{children:"HSET, HGETALL"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"\u552f\u4e00 ID"}),(0,r.jsx)(e.td,{children:"String"}),(0,r.jsx)(e.td,{children:"INCR"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"\u5ef6\u8fdf\u961f\u5217"}),(0,r.jsx)(e.td,{children:"Sorted Set"}),(0,r.jsx)(e.td,{children:"ZADD, ZRANGEBYSCORE"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"\u6ed1\u52a8\u7a97\u53e3\u9650\u6d41"}),(0,r.jsx)(e.td,{children:"Sorted Set"}),(0,r.jsx)(e.td,{children:"ZADD, ZREMRANGEBYSCORE, ZCARD"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"\u6392\u884c\u699c"}),(0,r.jsx)(e.td,{children:"Sorted Set"}),(0,r.jsx)(e.td,{children:"ZADD, ZREVRANGE, ZRANK"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"\u62a2\u7ea2\u5305"}),(0,r.jsx)(e.td,{children:"List"}),(0,r.jsx)(e.td,{children:"LPOP"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"\u8d2d\u7269\u8f66"}),(0,r.jsx)(e.td,{children:"Hash"}),(0,r.jsx)(e.td,{children:"HSET, HGETALL"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"\u70b9\u8d5e"}),(0,r.jsx)(e.td,{children:"Set"}),(0,r.jsx)(e.td,{children:"SADD, SISMEMBER"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"\u5728\u7ebf\u7edf\u8ba1"}),(0,r.jsx)(e.td,{children:"Bitmap"}),(0,r.jsx)(e.td,{children:"SETBIT, BITCOUNT"})]})]})]}),"\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.strong,{children:"\u6700\u4f73\u5b9e\u8df5"}),"\uff1a"]}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u2705 \u9009\u62e9\u5408\u9002\u7684\u6570\u636e\u7ed3\u6784"}),"\n",(0,r.jsx)(e.li,{children:"\u2705 \u4f7f\u7528 Lua \u811a\u672c\u4fdd\u8bc1\u539f\u5b50\u6027"}),"\n",(0,r.jsx)(e.li,{children:"\u2705 \u8bbe\u7f6e\u5408\u7406\u7684\u8fc7\u671f\u65f6\u95f4"}),"\n",(0,r.jsx)(e.li,{children:"\u2705 \u8003\u8651\u5f02\u5e38\u5904\u7406\u548c\u8fb9\u754c\u60c5\u51b5"}),"\n"]})]})}function c(n={}){const{wrapper:e}={...(0,s.R)(),...n.components};return e?(0,r.jsx)(e,{...n,children:(0,r.jsx)(u,{...n})}):u(n)}},48885:(n,e,t)=>{t.d(e,{R:()=>a,x:()=>l});var i=t(99378);const r={},s=i.createContext(r);function a(n){const e=i.useContext(s);return i.useMemo(function(){return"function"==typeof n?n(e):{...e,...n}},[e,n])}function l(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(r):n.components||r:a(n.components),i.createElement(s.Provider,{value:e},n.children)}}}]);