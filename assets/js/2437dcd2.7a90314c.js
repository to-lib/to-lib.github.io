"use strict";(globalThis.webpackChunkto_lib_github_io=globalThis.webpackChunkto_lib_github_io||[]).push([[1662],{48885:(e,n,t)=>{t.d(n,{R:()=>i,x:()=>o});var r=t(99378);const s={},a=r.createContext(s);function i(e){const n=r.useContext(a);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:i(e.components),r.createElement(a.Provider,{value:n},e.children)}},76566:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>o,default:()=>c,frontMatter:()=>i,metadata:()=>r,toc:()=>u});const r=JSON.parse('{"id":"rust/web-development","title":"Web \u540e\u7aef\u5f00\u53d1","description":"\u672c\u6587\u4ecb\u7ecd\u4f7f\u7528 Rust \u6784\u5efa Web \u540e\u7aef\u670d\u52a1\uff0c\u91cd\u70b9\u8bb2\u89e3 Axum \u6846\u67b6\u53ca\u5176\u751f\u6001\u7cfb\u7edf\u3002","source":"@site/docs/rust/web-development.md","sourceDirName":"rust","slug":"/rust/web-development","permalink":"/docs/rust/web-development","draft":false,"unlisted":false,"editUrl":"https://github.com/to-lib/to-lib.github.io/tree/main/docs/rust/web-development.md","tags":[],"version":"current","sidebarPosition":14,"frontMatter":{"sidebar_position":14,"title":"Web \u540e\u7aef\u5f00\u53d1"},"sidebar":"rust","previous":{"title":"\u5de5\u7a0b\u5316\u5b9e\u8df5","permalink":"/docs/rust/engineering"},"next":{"title":"\u6d4b\u8bd5","permalink":"/docs/rust/testing"}}');var s=t(22714),a=t(48885);const i={sidebar_position:14,title:"Web \u540e\u7aef\u5f00\u53d1"},o="Web \u540e\u7aef\u5f00\u53d1",l={},u=[{value:"Axum \u7b80\u4ecb",id:"axum-\u7b80\u4ecb",level:2},{value:"\u5feb\u901f\u5f00\u59cb",id:"\u5feb\u901f\u5f00\u59cb",level:2},{value:"\u8def\u7531",id:"\u8def\u7531",level:2},{value:"\u63d0\u53d6\u5668",id:"\u63d0\u53d6\u5668",level:2},{value:"\u81ea\u5b9a\u4e49\u63d0\u53d6\u5668",id:"\u81ea\u5b9a\u4e49\u63d0\u53d6\u5668",level:3},{value:"\u4e2d\u95f4\u4ef6",id:"\u4e2d\u95f4\u4ef6",level:2},{value:"\u81ea\u5b9a\u4e49\u4e2d\u95f4\u4ef6",id:"\u81ea\u5b9a\u4e49\u4e2d\u95f4\u4ef6",level:3},{value:"SQLx \u6570\u636e\u5e93",id:"sqlx-\u6570\u636e\u5e93",level:2},{value:"Redis \u96c6\u6210",id:"redis-\u96c6\u6210",level:2},{value:"JWT \u8ba4\u8bc1",id:"jwt-\u8ba4\u8bc1",level:2},{value:"\u9519\u8bef\u5904\u7406",id:"\u9519\u8bef\u5904\u7406",level:2},{value:"\u9879\u76ee\u7ed3\u6784",id:"\u9879\u76ee\u7ed3\u6784",level:2},{value:"Tower \u670d\u52a1\u6808",id:"tower-\u670d\u52a1\u6808",level:2},{value:"Tower Service Trait",id:"tower-service-trait",level:3},{value:"\u5e38\u7528 Tower \u4e2d\u95f4\u4ef6",id:"\u5e38\u7528-tower-\u4e2d\u95f4\u4ef6",level:3},{value:"\u81ea\u5b9a\u4e49 Tower Layer",id:"\u81ea\u5b9a\u4e49-tower-layer",level:3},{value:"OAuth2 \u8ba4\u8bc1",id:"oauth2-\u8ba4\u8bc1",level:2},{value:"OAuth2 \u6388\u6743\u7801\u6d41\u7a0b",id:"oauth2-\u6388\u6743\u7801\u6d41\u7a0b",level:3},{value:"SeaORM \u6570\u636e\u5e93\u64cd\u4f5c",id:"seaorm-\u6570\u636e\u5e93\u64cd\u4f5c",level:2},{value:"\u5b9a\u4e49\u5b9e\u4f53",id:"\u5b9a\u4e49\u5b9e\u4f53",level:3},{value:"CRUD \u64cd\u4f5c",id:"crud-\u64cd\u4f5c",level:3},{value:"\u9ad8\u5e76\u53d1\u4f18\u5316",id:"\u9ad8\u5e76\u53d1\u4f18\u5316",level:2},{value:"\u8fde\u63a5\u6c60\u914d\u7f6e",id:"\u8fde\u63a5\u6c60\u914d\u7f6e",level:3},{value:"\u8bf7\u6c42\u9650\u6d41",id:"\u8bf7\u6c42\u9650\u6d41",level:3},{value:"\u7f13\u5b58\u7b56\u7565",id:"\u7f13\u5b58\u7b56\u7565",level:3},{value:"\u5f02\u6b65\u6279\u5904\u7406",id:"\u5f02\u6b65\u6279\u5904\u7406",level:3},{value:"\u6700\u4f73\u5b9e\u8df5",id:"\u6700\u4f73\u5b9e\u8df5",level:2}];function d(e){const n={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,a.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"web-\u540e\u7aef\u5f00\u53d1",children:"Web \u540e\u7aef\u5f00\u53d1"})}),"\n",(0,s.jsx)(n.p,{children:"\u672c\u6587\u4ecb\u7ecd\u4f7f\u7528 Rust \u6784\u5efa Web \u540e\u7aef\u670d\u52a1\uff0c\u91cd\u70b9\u8bb2\u89e3 Axum \u6846\u67b6\u53ca\u5176\u751f\u6001\u7cfb\u7edf\u3002"}),"\n",(0,s.jsx)(n.h2,{id:"axum-\u7b80\u4ecb",children:"Axum \u7b80\u4ecb"}),"\n",(0,s.jsx)(n.p,{children:"Axum \u662f\u7531 Tokio \u56e2\u961f\u5f00\u53d1\u7684 Web \u6846\u67b6\uff0c\u7279\u70b9\uff1a"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"\u65e0\u5b8f\u8def\u7531"}),"\uff1a\u7c7b\u578b\u5b89\u5168\u7684\u8def\u7531\u5b9a\u4e49"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Tower \u751f\u6001"}),"\uff1a\u590d\u7528\u4e30\u5bcc\u7684\u4e2d\u95f4\u4ef6"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"\u63d0\u53d6\u5668\u6a21\u5f0f"}),"\uff1a\u58f0\u660e\u5f0f\u8bf7\u6c42\u89e3\u6790"]}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-toml",children:'[dependencies]\naxum = "0.7"\ntokio = { version = "1", features = ["full"] }\nserde = { version = "1", features = ["derive"] }\ntower-http = { version = "0.5", features = ["cors", "trace"] }\n'})}),"\n",(0,s.jsx)(n.h2,{id:"\u5feb\u901f\u5f00\u59cb",children:"\u5feb\u901f\u5f00\u59cb"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-rust",children:'use axum::{routing::get, Router};\n\n#[tokio::main]\nasync fn main() {\n    let app = Router::new()\n        .route("/", get(|| async { "Hello, World!" }));\n\n    let listener = tokio::net::TcpListener::bind("0.0.0.0:3000").await.unwrap();\n    axum::serve(listener, app).await.unwrap();\n}\n'})}),"\n",(0,s.jsx)(n.h2,{id:"\u8def\u7531",children:"\u8def\u7531"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-rust",children:'use axum::{routing::{get, post}, Router};\n\n// \u57fa\u7840\u8def\u7531\nlet app = Router::new()\n    .route("/users", get(list_users).post(create_user))\n    .route("/users/:id", get(get_user));\n\n// \u8def\u7531\u5d4c\u5957\nlet api_routes = Router::new()\n    .nest("/users", user_routes)\n    .nest("/posts", post_routes);\n\nlet app = Router::new().nest("/api/v1", api_routes);\n'})}),"\n",(0,s.jsx)(n.h2,{id:"\u63d0\u53d6\u5668",children:"\u63d0\u53d6\u5668"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-rust",children:'use axum::extract::{Path, Query, State, Json};\nuse serde::Deserialize;\n\n// \u8def\u5f84\u53c2\u6570\nasync fn get_user(Path(id): Path<u64>) -> String {\n    format!("User {}", id)\n}\n\n// \u67e5\u8be2\u53c2\u6570\n#[derive(Deserialize)]\nstruct Pagination {\n    page: Option<u32>,\n}\n\nasync fn list_items(Query(pagination): Query<Pagination>) -> String {\n    format!("Page {}", pagination.page.unwrap_or(1))\n}\n\n// JSON \u8bf7\u6c42\u4f53\nasync fn create_item(Json(payload): Json<CreateItem>) -> Json<Item> {\n    // ...\n}\n'})}),"\n",(0,s.jsx)(n.h3,{id:"\u81ea\u5b9a\u4e49\u63d0\u53d6\u5668",children:"\u81ea\u5b9a\u4e49\u63d0\u53d6\u5668"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-rust",children:'use axum::{async_trait, extract::FromRequestParts, http::{request::Parts, StatusCode}};\n\nstruct AuthUser { user_id: u64 }\n\n#[async_trait]\nimpl<S: Send + Sync> FromRequestParts<S> for AuthUser {\n    type Rejection = StatusCode;\n\n    async fn from_request_parts(parts: &mut Parts, _: &S) -> Result<Self, Self::Rejection> {\n        let header = parts.headers.get("Authorization")\n            .and_then(|v| v.to_str().ok())\n            .ok_or(StatusCode::UNAUTHORIZED)?;\n\n        let user_id = validate_token(header).map_err(|_| StatusCode::UNAUTHORIZED)?;\n        Ok(AuthUser { user_id })\n    }\n}\n'})}),"\n",(0,s.jsx)(n.h2,{id:"\u4e2d\u95f4\u4ef6",children:"\u4e2d\u95f4\u4ef6"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-rust",children:'use tower_http::{cors::CorsLayer, trace::TraceLayer, timeout::TimeoutLayer};\nuse std::time::Duration;\n\nlet app = Router::new()\n    .route("/", get(handler))\n    .layer(TraceLayer::new_for_http())\n    .layer(CorsLayer::permissive())\n    .layer(TimeoutLayer::new(Duration::from_secs(30)));\n'})}),"\n",(0,s.jsx)(n.h3,{id:"\u81ea\u5b9a\u4e49\u4e2d\u95f4\u4ef6",children:"\u81ea\u5b9a\u4e49\u4e2d\u95f4\u4ef6"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-rust",children:"use axum::{middleware::{self, Next}, extract::Request, response::Response};\n\nasync fn logging_middleware(request: Request, next: Next) -> Response {\n    let method = request.method().clone();\n    let uri = request.uri().clone();\n    let start = std::time::Instant::now();\n\n    let response = next.run(request).await;\n\n    tracing::info!(%method, %uri, status = %response.status(), duration = ?start.elapsed());\n    response\n}\n\nlet app = Router::new()\n    .layer(middleware::from_fn(logging_middleware));\n"})}),"\n",(0,s.jsx)(n.h2,{id:"sqlx-\u6570\u636e\u5e93",children:"SQLx \u6570\u636e\u5e93"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-toml",children:'[dependencies]\nsqlx = { version = "0.7", features = ["runtime-tokio", "postgres"] }\n'})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-rust",children:'use sqlx::{PgPool, FromRow};\n\n#[derive(FromRow, Serialize)]\nstruct User { id: i64, name: String, email: String }\n\nasync fn list_users(State(pool): State<PgPool>) -> Result<Json<Vec<User>>, StatusCode> {\n    let users = sqlx::query_as::<_, User>("SELECT * FROM users")\n        .fetch_all(&pool)\n        .await\n        .map_err(|_| StatusCode::INTERNAL_SERVER_ERROR)?;\n    Ok(Json(users))\n}\n\nasync fn create_user(State(pool): State<PgPool>, Json(payload): Json<CreateUser>) -> Result<Json<User>, StatusCode> {\n    let user = sqlx::query_as::<_, User>(\n        "INSERT INTO users (name, email) VALUES ($1, $2) RETURNING *"\n    )\n    .bind(&payload.name)\n    .bind(&payload.email)\n    .fetch_one(&pool)\n    .await\n    .map_err(|_| StatusCode::INTERNAL_SERVER_ERROR)?;\n    Ok(Json(user))\n}\n'})}),"\n",(0,s.jsx)(n.h2,{id:"redis-\u96c6\u6210",children:"Redis \u96c6\u6210"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-rust",children:'use deadpool_redis::{Config, Runtime, Pool};\nuse redis::AsyncCommands;\n\nasync fn cache_user(State(pool): State<Pool>, Path(id): Path<u64>, Json(user): Json<User>) -> Result<StatusCode, StatusCode> {\n    let mut conn = pool.get().await.map_err(|_| StatusCode::INTERNAL_SERVER_ERROR)?;\n    let key = format!("user:{}", id);\n    let value = serde_json::to_string(&user).unwrap();\n    conn.set_ex::<_, _, ()>(&key, &value, 3600).await.map_err(|_| StatusCode::INTERNAL_SERVER_ERROR)?;\n    Ok(StatusCode::OK)\n}\n'})}),"\n",(0,s.jsx)(n.h2,{id:"jwt-\u8ba4\u8bc1",children:"JWT \u8ba4\u8bc1"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-rust",children:'use jsonwebtoken::{encode, decode, Header, EncodingKey, DecodingKey, Validation};\n\n#[derive(Serialize, Deserialize)]\nstruct Claims { sub: String, exp: usize }\n\nfn create_token(user_id: &str) -> Result<String, jsonwebtoken::errors::Error> {\n    let claims = Claims {\n        sub: user_id.to_string(),\n        exp: (chrono::Utc::now() + chrono::Duration::hours(24)).timestamp() as usize,\n    };\n    encode(&Header::default(), &claims, &EncodingKey::from_secret(b"secret"))\n}\n\nfn verify_token(token: &str) -> Result<Claims, jsonwebtoken::errors::Error> {\n    let data = decode::<Claims>(token, &DecodingKey::from_secret(b"secret"), &Validation::default())?;\n    Ok(data.claims)\n}\n'})}),"\n",(0,s.jsx)(n.h2,{id:"\u9519\u8bef\u5904\u7406",children:"\u9519\u8bef\u5904\u7406"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-rust",children:'use axum::{response::{IntoResponse, Response}, http::StatusCode, Json};\n\nenum AppError {\n    NotFound,\n    BadRequest(String),\n    InternalError(anyhow::Error),\n}\n\nimpl IntoResponse for AppError {\n    fn into_response(self) -> Response {\n        let (status, message) = match self {\n            AppError::NotFound => (StatusCode::NOT_FOUND, "Not found"),\n            AppError::BadRequest(msg) => (StatusCode::BAD_REQUEST, msg.as_str()),\n            AppError::InternalError(_) => (StatusCode::INTERNAL_SERVER_ERROR, "Internal error"),\n        };\n        (status, Json(serde_json::json!({"error": message}))).into_response()\n    }\n}\n'})}),"\n",(0,s.jsx)(n.h2,{id:"\u9879\u76ee\u7ed3\u6784",children:"\u9879\u76ee\u7ed3\u6784"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"web-api/\n\u251c\u2500\u2500 src/\n\u2502   \u251c\u2500\u2500 main.rs\n\u2502   \u251c\u2500\u2500 config.rs\n\u2502   \u251c\u2500\u2500 error.rs\n\u2502   \u251c\u2500\u2500 routes/\n\u2502   \u2502   \u251c\u2500\u2500 mod.rs\n\u2502   \u2502   \u2514\u2500\u2500 users.rs\n\u2502   \u251c\u2500\u2500 middleware/\n\u2502   \u251c\u2500\u2500 models/\n\u2502   \u2514\u2500\u2500 db/\n\u251c\u2500\u2500 migrations/\n\u2514\u2500\u2500 tests/\n"})}),"\n",(0,s.jsx)(n.h2,{id:"tower-\u670d\u52a1\u6808",children:"Tower \u670d\u52a1\u6808"}),"\n",(0,s.jsx)(n.p,{children:"Tower \u662f Rust \u5f02\u6b65\u670d\u52a1\u62bd\u8c61\u7684\u6838\u5fc3\uff0cAxum \u5b8c\u5168\u57fa\u4e8e Tower \u6784\u5efa\u3002"}),"\n",(0,s.jsx)(n.h3,{id:"tower-service-trait",children:"Tower Service Trait"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-rust",children:"use std::task::{Context, Poll};\nuse std::future::Future;\nuse std::pin::Pin;\n\n// Tower Service trait \u7684\u6838\u5fc3\npub trait Service<Request> {\n    type Response;\n    type Error;\n    type Future: Future<Output = Result<Self::Response, Self::Error>>;\n\n    fn poll_ready(&mut self, cx: &mut Context<'_>) -> Poll<Result<(), Self::Error>>;\n    fn call(&mut self, req: Request) -> Self::Future;\n}\n"})}),"\n",(0,s.jsx)(n.h3,{id:"\u5e38\u7528-tower-\u4e2d\u95f4\u4ef6",children:"\u5e38\u7528 Tower \u4e2d\u95f4\u4ef6"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-rust",children:'use axum::{Router, routing::get};\nuse tower::ServiceBuilder;\nuse tower_http::{\n    cors::CorsLayer,\n    trace::TraceLayer,\n    timeout::TimeoutLayer,\n    compression::CompressionLayer,\n    limit::RequestBodyLimitLayer,\n    request_id::{MakeRequestId, RequestId, SetRequestIdLayer, PropagateRequestIdLayer},\n};\nuse std::time::Duration;\n\n#[derive(Clone)]\nstruct MyMakeRequestId;\n\nimpl MakeRequestId for MyMakeRequestId {\n    fn make_request_id<B>(&mut self, _: &http::Request<B>) -> Option<RequestId> {\n        Some(RequestId::new(uuid::Uuid::new_v4().to_string().parse().unwrap()))\n    }\n}\n\nfn create_app() -> Router {\n    Router::new()\n        .route("/", get(|| async { "Hello" }))\n        .layer(\n            ServiceBuilder::new()\n                // \u4ece\u5185\u5230\u5916\u6267\u884c\n                .layer(SetRequestIdLayer::x_request_id(MyMakeRequestId))\n                .layer(PropagateRequestIdLayer::x_request_id())\n                .layer(TraceLayer::new_for_http())\n                .layer(CompressionLayer::new())\n                .layer(TimeoutLayer::new(Duration::from_secs(30)))\n                .layer(RequestBodyLimitLayer::new(1024 * 1024))  // 1MB\n                .layer(CorsLayer::permissive())\n        )\n}\n'})}),"\n",(0,s.jsx)(n.h3,{id:"\u81ea\u5b9a\u4e49-tower-layer",children:"\u81ea\u5b9a\u4e49 Tower Layer"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-rust",children:"use axum::{body::Body, http::Request, response::Response};\nuse std::task::{Context, Poll};\nuse tower::{Layer, Service};\nuse std::future::Future;\nuse std::pin::Pin;\n\n#[derive(Clone)]\npub struct TimingLayer;\n\nimpl<S> Layer<S> for TimingLayer {\n    type Service = TimingService<S>;\n\n    fn layer(&self, inner: S) -> Self::Service {\n        TimingService { inner }\n    }\n}\n\n#[derive(Clone)]\npub struct TimingService<S> {\n    inner: S,\n}\n\nimpl<S> Service<Request<Body>> for TimingService<S>\nwhere\n    S: Service<Request<Body>, Response = Response> + Clone + Send + 'static,\n    S::Future: Send,\n{\n    type Response = S::Response;\n    type Error = S::Error;\n    type Future = Pin<Box<dyn Future<Output = Result<Self::Response, Self::Error>> + Send>>;\n\n    fn poll_ready(&mut self, cx: &mut Context<'_>) -> Poll<Result<(), Self::Error>> {\n        self.inner.poll_ready(cx)\n    }\n\n    fn call(&mut self, req: Request<Body>) -> Self::Future {\n        let start = std::time::Instant::now();\n        let method = req.method().clone();\n        let uri = req.uri().clone();\n        let future = self.inner.call(req);\n\n        Box::pin(async move {\n            let response = future.await;\n            let elapsed = start.elapsed();\n            tracing::info!(%method, %uri, ?elapsed, \"\u8bf7\u6c42\u5b8c\u6210\");\n            response\n        })\n    }\n}\n"})}),"\n",(0,s.jsx)(n.h2,{id:"oauth2-\u8ba4\u8bc1",children:"OAuth2 \u8ba4\u8bc1"}),"\n",(0,s.jsx)(n.h3,{id:"oauth2-\u6388\u6743\u7801\u6d41\u7a0b",children:"OAuth2 \u6388\u6743\u7801\u6d41\u7a0b"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-rust",children:'use axum::{\n    extract::{Query, State},\n    response::Redirect,\n    routing::get,\n    Router,\n};\nuse oauth2::{\n    AuthorizationCode, AuthUrl, ClientId, ClientSecret, CsrfToken,\n    PkceCodeChallenge, RedirectUrl, Scope, TokenResponse, TokenUrl,\n    basic::BasicClient,\n};\nuse serde::Deserialize;\n\n#[derive(Clone)]\nstruct AppState {\n    oauth_client: BasicClient,\n}\n\nfn create_oauth_client() -> BasicClient {\n    BasicClient::new(\n        ClientId::new("your-client-id".to_string()),\n        Some(ClientSecret::new("your-client-secret".to_string())),\n        AuthUrl::new("https://provider.com/oauth/authorize".to_string()).unwrap(),\n        Some(TokenUrl::new("https://provider.com/oauth/token".to_string()).unwrap()),\n    )\n    .set_redirect_uri(RedirectUrl::new("http://localhost:3000/callback".to_string()).unwrap())\n}\n\n// \u6b65\u9aa4 1: \u91cd\u5b9a\u5411\u5230 OAuth \u63d0\u4f9b\u5546\nasync fn login(State(state): State<AppState>) -> Redirect {\n    let (pkce_challenge, pkce_verifier) = PkceCodeChallenge::new_random_sha256();\n\n    let (auth_url, csrf_token) = state.oauth_client\n        .authorize_url(CsrfToken::new_random)\n        .add_scope(Scope::new("read:user".to_string()))\n        .set_pkce_challenge(pkce_challenge)\n        .url();\n\n    // \u5b58\u50a8 csrf_token \u548c pkce_verifier\uff08\u5b9e\u9645\u5e94\u7528\u4e2d\u7528 session/redis\uff09\n\n    Redirect::to(auth_url.as_str())\n}\n\n#[derive(Deserialize)]\nstruct CallbackParams {\n    code: String,\n    state: String,\n}\n\n// \u6b65\u9aa4 2: \u5904\u7406\u56de\u8c03\uff0c\u4ea4\u6362 token\nasync fn callback(\n    State(state): State<AppState>,\n    Query(params): Query<CallbackParams>,\n) -> Result<String, String> {\n    // \u9a8c\u8bc1 CSRF token\n    // \u83b7\u53d6\u4e4b\u524d\u5b58\u50a8\u7684 pkce_verifier\n\n    let token_result = state.oauth_client\n        .exchange_code(AuthorizationCode::new(params.code))\n        // .set_pkce_verifier(pkce_verifier)\n        .request_async(oauth2::reqwest::async_http_client)\n        .await\n        .map_err(|e| format!("Token exchange failed: {}", e))?;\n\n    let access_token = token_result.access_token().secret();\n    Ok(format!("\u767b\u5f55\u6210\u529f\uff01Token: {}...", &access_token[..20]))\n}\n'})}),"\n",(0,s.jsx)(n.h2,{id:"seaorm-\u6570\u636e\u5e93\u64cd\u4f5c",children:"SeaORM \u6570\u636e\u5e93\u64cd\u4f5c"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-toml",children:'[dependencies]\nsea-orm = { version = "0.12", features = ["sqlx-postgres", "runtime-tokio-native-tls"] }\n'})}),"\n",(0,s.jsx)(n.h3,{id:"\u5b9a\u4e49\u5b9e\u4f53",children:"\u5b9a\u4e49\u5b9e\u4f53"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-rust",children:'use sea_orm::entity::prelude::*;\n\n#[derive(Clone, Debug, PartialEq, DeriveEntityModel)]\n#[sea_orm(table_name = "users")]\npub struct Model {\n    #[sea_orm(primary_key)]\n    pub id: i64,\n    pub username: String,\n    pub email: String,\n    pub created_at: DateTimeWithTimeZone,\n}\n\n#[derive(Copy, Clone, Debug, EnumIter, DeriveRelation)]\npub enum Relation {\n    #[sea_orm(has_many = "super::post::Entity")]\n    Posts,\n}\n\nimpl Related<super::post::Entity> for Entity {\n    fn to() -> RelationDef {\n        Relation::Posts.def()\n    }\n}\n\nimpl ActiveModelBehavior for ActiveModel {}\n'})}),"\n",(0,s.jsx)(n.h3,{id:"crud-\u64cd\u4f5c",children:"CRUD \u64cd\u4f5c"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-rust",children:'use sea_orm::{Database, DatabaseConnection, EntityTrait, ActiveModelTrait, Set, QueryFilter, ColumnTrait};\n\nasync fn crud_examples(db: &DatabaseConnection) -> Result<(), sea_orm::DbErr> {\n    // \u521b\u5efa\n    let user = user::ActiveModel {\n        username: Set("alice".to_string()),\n        email: Set("alice@example.com".to_string()),\n        ..Default::default()\n    };\n    let user = user.insert(db).await?;\n\n    // \u67e5\u8be2\n    let found = User::find_by_id(user.id).one(db).await?;\n    let all_users = User::find().all(db).await?;\n    let filtered = User::find()\n        .filter(user::Column::Username.contains("ali"))\n        .all(db).await?;\n\n    // \u66f4\u65b0\n    let mut active: user::ActiveModel = found.unwrap().into();\n    active.email = Set("newemail@example.com".to_string());\n    active.update(db).await?;\n\n    // \u5220\u9664\n    User::delete_by_id(user.id).exec(db).await?;\n\n    Ok(())\n}\n'})}),"\n",(0,s.jsx)(n.h2,{id:"\u9ad8\u5e76\u53d1\u4f18\u5316",children:"\u9ad8\u5e76\u53d1\u4f18\u5316"}),"\n",(0,s.jsx)(n.h3,{id:"\u8fde\u63a5\u6c60\u914d\u7f6e",children:"\u8fde\u63a5\u6c60\u914d\u7f6e"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-rust",children:'use sqlx::postgres::PgPoolOptions;\nuse deadpool_redis::{Config as RedisConfig, Runtime};\n\nasync fn setup_pools() {\n    // PostgreSQL \u8fde\u63a5\u6c60\n    let pg_pool = PgPoolOptions::new()\n        .max_connections(100)\n        .min_connections(10)\n        .acquire_timeout(std::time::Duration::from_secs(3))\n        .idle_timeout(std::time::Duration::from_secs(600))\n        .connect("postgres://user:pass@localhost/db")\n        .await\n        .unwrap();\n\n    // Redis \u8fde\u63a5\u6c60\n    let redis_cfg = RedisConfig::from_url("redis://localhost:6379");\n    let redis_pool = redis_cfg.create_pool(Some(Runtime::Tokio1)).unwrap();\n}\n'})}),"\n",(0,s.jsx)(n.h3,{id:"\u8bf7\u6c42\u9650\u6d41",children:"\u8bf7\u6c42\u9650\u6d41"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-rust",children:"use axum::{\n    extract::State,\n    http::StatusCode,\n    middleware::{self, Next},\n    response::Response,\n};\nuse std::sync::Arc;\nuse tokio::sync::Semaphore;\n\n#[derive(Clone)]\nstruct RateLimiter {\n    semaphore: Arc<Semaphore>,\n}\n\nimpl RateLimiter {\n    fn new(max_concurrent: usize) -> Self {\n        Self {\n            semaphore: Arc::new(Semaphore::new(max_concurrent)),\n        }\n    }\n}\n\nasync fn rate_limit_middleware(\n    State(limiter): State<RateLimiter>,\n    request: axum::http::Request<axum::body::Body>,\n    next: Next,\n) -> Result<Response, StatusCode> {\n    let _permit = limiter.semaphore\n        .try_acquire()\n        .map_err(|_| StatusCode::TOO_MANY_REQUESTS)?;\n\n    Ok(next.run(request).await)\n}\n"})}),"\n",(0,s.jsx)(n.h3,{id:"\u7f13\u5b58\u7b56\u7565",children:"\u7f13\u5b58\u7b56\u7565"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-rust",children:"use std::sync::Arc;\nuse tokio::sync::RwLock;\nuse std::collections::HashMap;\nuse std::time::{Duration, Instant};\n\nstruct CacheEntry<T> {\n    value: T,\n    expires_at: Instant,\n}\n\nstruct Cache<T> {\n    data: RwLock<HashMap<String, CacheEntry<T>>>,\n    ttl: Duration,\n}\n\nimpl<T: Clone> Cache<T> {\n    fn new(ttl: Duration) -> Self {\n        Self {\n            data: RwLock::new(HashMap::new()),\n            ttl,\n        }\n    }\n\n    async fn get(&self, key: &str) -> Option<T> {\n        let data = self.data.read().await;\n        data.get(key)\n            .filter(|entry| entry.expires_at > Instant::now())\n            .map(|entry| entry.value.clone())\n    }\n\n    async fn set(&self, key: String, value: T) {\n        let mut data = self.data.write().await;\n        data.insert(key, CacheEntry {\n            value,\n            expires_at: Instant::now() + self.ttl,\n        });\n    }\n}\n"})}),"\n",(0,s.jsx)(n.h3,{id:"\u5f02\u6b65\u6279\u5904\u7406",children:"\u5f02\u6b65\u6279\u5904\u7406"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-rust",children:"use tokio::sync::mpsc;\nuse std::time::Duration;\n\nstruct BatchProcessor<T> {\n    sender: mpsc::Sender<T>,\n}\n\nimpl<T: Send + 'static> BatchProcessor<T> {\n    fn new<F>(batch_size: usize, timeout: Duration, handler: F) -> Self\n    where\n        F: Fn(Vec<T>) + Send + 'static,\n    {\n        let (tx, mut rx) = mpsc::channel::<T>(1000);\n\n        tokio::spawn(async move {\n            let mut batch = Vec::with_capacity(batch_size);\n            let mut interval = tokio::time::interval(timeout);\n\n            loop {\n                tokio::select! {\n                    Some(item) = rx.recv() => {\n                        batch.push(item);\n                        if batch.len() >= batch_size {\n                            handler(std::mem::take(&mut batch));\n                        }\n                    }\n                    _ = interval.tick() => {\n                        if !batch.is_empty() {\n                            handler(std::mem::take(&mut batch));\n                        }\n                    }\n                }\n            }\n        });\n\n        Self { sender: tx }\n    }\n\n    async fn submit(&self, item: T) -> Result<(), mpsc::error::SendError<T>> {\n        self.sender.send(item).await\n    }\n}\n"})}),"\n",(0,s.jsx)(n.h2,{id:"\u6700\u4f73\u5b9e\u8df5",children:"\u6700\u4f73\u5b9e\u8df5"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"\u65b9\u9762"}),(0,s.jsx)(n.th,{children:"\u5efa\u8bae"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"\u67b6\u6784"}),(0,s.jsx)(n.td,{children:"routes \u2192 services \u2192 repositories"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"\u72b6\u6001"}),(0,s.jsxs)(n.td,{children:[(0,s.jsx)(n.code,{children:"Arc<RwLock<T>>"})," \u6216\u8fde\u63a5\u6c60"]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"\u9519\u8bef"}),(0,s.jsxs)(n.td,{children:["\u81ea\u5b9a\u4e49\u9519\u8bef\u5b9e\u73b0 ",(0,s.jsx)(n.code,{children:"IntoResponse"})]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"\u8ba4\u8bc1"}),(0,s.jsx)(n.td,{children:"\u81ea\u5b9a\u4e49\u63d0\u53d6\u5668 + \u4e2d\u95f4\u4ef6"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"\u6570\u636e\u5e93"}),(0,s.jsx)(n.td,{children:"SQLx \u7f16\u8bd1\u65f6\u68c0\u67e5"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"\u65e5\u5fd7"}),(0,s.jsx)(n.td,{children:"tracing + TraceLayer"})]})]})]})]})}function c(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}}}]);