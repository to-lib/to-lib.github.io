"use strict";(globalThis.webpackChunkto_lib_github_io=globalThis.webpackChunkto_lib_github_io||[]).push([[79484],{48885:(n,e,t)=>{t.d(e,{R:()=>l,x:()=>d});var i=t(99378);const r={},s=i.createContext(r);function l(n){const e=i.useContext(s);return i.useMemo(function(){return"function"==typeof n?n(e):{...e,...n}},[e,n])}function d(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(r):n.components||r:l(n.components),i.createElement(s.Provider,{value:e},n.children)}},72748:(n,e,t)=>{t.r(e),t.d(e,{assets:()=>o,contentTitle:()=>d,default:()=>h,frontMatter:()=>l,metadata:()=>i,toc:()=>a});const i=JSON.parse('{"id":"ml/model-compression","title":"\ud83d\udce6 \u6a21\u578b\u538b\u7f29","description":"\u6a21\u578b\u538b\u7f29\u51cf\u5c11\u6a21\u578b\u5927\u5c0f\u548c\u63a8\u7406\u5ef6\u8fdf\uff0c\u4fbf\u4e8e\u8fb9\u7f18\u90e8\u7f72\u3002","source":"@site/docs/ml/model-compression.md","sourceDirName":"ml","slug":"/ml/model-compression","permalink":"/docs/ml/model-compression","draft":false,"unlisted":false,"editUrl":"https://github.com/to-lib/to-lib.github.io/tree/main/docs/ml/model-compression.md","tags":[],"version":"current","sidebarPosition":35,"frontMatter":{"sidebar_position":35,"title":"\ud83d\udce6 \u6a21\u578b\u538b\u7f29"},"sidebar":"ml","previous":{"title":"\ud83e\udde0 \u6301\u7eed\u5b66\u4e60","permalink":"/docs/ml/continual-learning"},"next":{"title":"\ud83d\udee1\ufe0f \u5bf9\u6297\u9c81\u68d2\u6027","permalink":"/docs/ml/adversarial-robustness"}}');var r=t(22714),s=t(48885);const l={sidebar_position:35,title:"\ud83d\udce6 \u6a21\u578b\u538b\u7f29"},d="\u6a21\u578b\u538b\u7f29",o={},a=[{value:"\u6280\u672f\u6982\u89c8",id:"\u6280\u672f\u6982\u89c8",level:2},{value:"\u91cf\u5316",id:"\u91cf\u5316",level:2},{value:"\u8bad\u7ec3\u540e\u91cf\u5316 (PTQ)",id:"\u8bad\u7ec3\u540e\u91cf\u5316-ptq",level:3},{value:"\u91cf\u5316\u611f\u77e5\u8bad\u7ec3 (QAT)",id:"\u91cf\u5316\u611f\u77e5\u8bad\u7ec3-qat",level:3},{value:"\u526a\u679d",id:"\u526a\u679d",level:2},{value:"\u975e\u7ed3\u6784\u5316\u526a\u679d",id:"\u975e\u7ed3\u6784\u5316\u526a\u679d",level:3},{value:"\u7ed3\u6784\u5316\u526a\u679d",id:"\u7ed3\u6784\u5316\u526a\u679d",level:3},{value:"\u8fed\u4ee3\u526a\u679d",id:"\u8fed\u4ee3\u526a\u679d",level:3},{value:"\u77e5\u8bc6\u84b8\u998f",id:"\u77e5\u8bc6\u84b8\u998f",level:2},{value:"\u6548\u679c\u5bf9\u6bd4",id:"\u6548\u679c\u5bf9\u6bd4",level:2}];function c(n){const e={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",mermaid:"mermaid",p:"p",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",...(0,s.R)(),...n.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(e.header,{children:(0,r.jsx)(e.h1,{id:"\u6a21\u578b\u538b\u7f29",children:"\u6a21\u578b\u538b\u7f29"})}),"\n",(0,r.jsx)(e.p,{children:"\u6a21\u578b\u538b\u7f29\u51cf\u5c11\u6a21\u578b\u5927\u5c0f\u548c\u63a8\u7406\u5ef6\u8fdf\uff0c\u4fbf\u4e8e\u8fb9\u7f18\u90e8\u7f72\u3002"}),"\n",(0,r.jsx)(e.h2,{id:"\u6280\u672f\u6982\u89c8",children:"\u6280\u672f\u6982\u89c8"}),"\n",(0,r.jsx)(e.mermaid,{value:"graph TB\n    A[\u6a21\u578b\u538b\u7f29] --\x3e B[\u91cf\u5316]\n    A --\x3e C[\u526a\u679d]\n    A --\x3e D[\u77e5\u8bc6\u84b8\u998f]\n    A --\x3e E[\u4f4e\u79e9\u5206\u89e3]"}),"\n",(0,r.jsx)(e.h2,{id:"\u91cf\u5316",children:"\u91cf\u5316"}),"\n",(0,r.jsx)(e.h3,{id:"\u8bad\u7ec3\u540e\u91cf\u5316-ptq",children:"\u8bad\u7ec3\u540e\u91cf\u5316 (PTQ)"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-python",children:"import torch\n\n# \u52a8\u6001\u91cf\u5316\nquantized_model = torch.quantization.quantize_dynamic(\n    model, {torch.nn.Linear}, dtype=torch.qint8\n)\n\n# \u9759\u6001\u91cf\u5316\nmodel.qconfig = torch.quantization.get_default_qconfig('fbgemm')\ntorch.quantization.prepare(model, inplace=True)\n# \u6821\u51c6\nwith torch.no_grad():\n    for x in calibration_data:\n        model(x)\ntorch.quantization.convert(model, inplace=True)\n"})}),"\n",(0,r.jsx)(e.h3,{id:"\u91cf\u5316\u611f\u77e5\u8bad\u7ec3-qat",children:"\u91cf\u5316\u611f\u77e5\u8bad\u7ec3 (QAT)"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-python",children:"model.qconfig = torch.quantization.get_default_qat_qconfig('fbgemm')\nmodel_prepared = torch.quantization.prepare_qat(model)\n\n# \u6b63\u5e38\u8bad\u7ec3\nfor epoch in range(epochs):\n    train(model_prepared)\n\n# \u8f6c\u6362\u4e3a\u91cf\u5316\u6a21\u578b\nquantized = torch.quantization.convert(model_prepared)\n"})}),"\n",(0,r.jsx)(e.h2,{id:"\u526a\u679d",children:"\u526a\u679d"}),"\n",(0,r.jsx)(e.h3,{id:"\u975e\u7ed3\u6784\u5316\u526a\u679d",children:"\u975e\u7ed3\u6784\u5316\u526a\u679d"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-python",children:"import torch.nn.utils.prune as prune\n\n# \u526a\u6389 30% \u6743\u91cd\nprune.l1_unstructured(model.fc, name='weight', amount=0.3)\n\n# \u6c38\u4e45\u5316\nprune.remove(model.fc, 'weight')\n"})}),"\n",(0,r.jsx)(e.h3,{id:"\u7ed3\u6784\u5316\u526a\u679d",children:"\u7ed3\u6784\u5316\u526a\u679d"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-python",children:"# \u526a\u6389\u6574\u4e2a\u901a\u9053\nprune.ln_structured(model.conv, name='weight', amount=0.3, n=2, dim=0)\n"})}),"\n",(0,r.jsx)(e.h3,{id:"\u8fed\u4ee3\u526a\u679d",children:"\u8fed\u4ee3\u526a\u679d"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-python",children:"def iterative_pruning(model, target_sparsity, steps=5):\n    current_sparsity = 0\n    step_sparsity = target_sparsity / steps\n\n    for step in range(steps):\n        current_sparsity += step_sparsity\n        for name, module in model.named_modules():\n            if isinstance(module, nn.Linear):\n                prune.l1_unstructured(module, 'weight', amount=step_sparsity)\n\n        # \u5fae\u8c03\n        finetune(model)\n"})}),"\n",(0,r.jsx)(e.h2,{id:"\u77e5\u8bc6\u84b8\u998f",children:"\u77e5\u8bc6\u84b8\u998f"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-python",children:"def distillation_loss(student_logits, teacher_logits, labels, T=4, alpha=0.5):\n    # \u8f6f\u6807\u7b7e\u635f\u5931\n    soft_loss = nn.KLDivLoss(reduction='batchmean')(\n        nn.functional.log_softmax(student_logits / T, dim=1),\n        nn.functional.softmax(teacher_logits / T, dim=1)\n    ) * T * T\n\n    # \u786c\u6807\u7b7e\u635f\u5931\n    hard_loss = nn.functional.cross_entropy(student_logits, labels)\n\n    return alpha * soft_loss + (1 - alpha) * hard_loss\n\n# \u8bad\u7ec3\u5b66\u751f\u6a21\u578b\nfor x, y in dataloader:\n    with torch.no_grad():\n        teacher_logits = teacher_model(x)\n    student_logits = student_model(x)\n    loss = distillation_loss(student_logits, teacher_logits, y)\n"})}),"\n",(0,r.jsx)(e.h2,{id:"\u6548\u679c\u5bf9\u6bd4",children:"\u6548\u679c\u5bf9\u6bd4"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,r.jsxs)(e.table,{children:[(0,r.jsx)(e.thead,{children:(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.th,{children:"\u65b9\u6cd5"}),(0,r.jsx)(e.th,{children:"\u538b\u7f29\u6bd4"}),(0,r.jsx)(e.th,{children:"\u7cbe\u5ea6\u635f\u5931"}),(0,r.jsx)(e.th,{children:"\u9700\u8981\u91cd\u8bad\u7ec3"})]})}),(0,r.jsxs)(e.tbody,{children:[(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"INT8 \u91cf\u5316"}),(0,r.jsx)(e.td,{children:"4x"}),(0,r.jsx)(e.td,{children:"< 1%"}),(0,r.jsx)(e.td,{children:"\u5426/\u53ef\u9009"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"\u526a\u679d 50%"}),(0,r.jsx)(e.td,{children:"2x"}),(0,r.jsx)(e.td,{children:"1-2%"}),(0,r.jsx)(e.td,{children:"\u662f"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"\u84b8\u998f"}),(0,r.jsx)(e.td,{children:"\u53ef\u53d8"}),(0,r.jsx)(e.td,{children:"1-3%"}),(0,r.jsx)(e.td,{children:"\u662f"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"\u7ec4\u5408"}),(0,r.jsx)(e.td,{children:"10x+"}),(0,r.jsx)(e.td,{children:"2-5%"}),(0,r.jsx)(e.td,{children:"\u662f"})]})]})]})]})}function h(n={}){const{wrapper:e}={...(0,s.R)(),...n.components};return e?(0,r.jsx)(e,{...n,children:(0,r.jsx)(c,{...n})}):c(n)}}}]);