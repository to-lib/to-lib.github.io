"use strict";(globalThis.webpackChunkto_lib_github_io=globalThis.webpackChunkto_lib_github_io||[]).push([[8399],{48885:(n,e,l)=>{l.d(e,{R:()=>d,x:()=>c});var i=l(99378);const r={},s=i.createContext(r);function d(n){const e=i.useContext(s);return i.useMemo(function(){return"function"==typeof n?n(e):{...e,...n}},[e,n])}function c(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(r):n.components||r:d(n.components),i.createElement(s.Provider,{value:e},n.children)}},85939:(n,e,l)=>{l.r(e),l.d(e,{assets:()=>a,contentTitle:()=>c,default:()=>u,frontMatter:()=>d,metadata:()=>i,toc:()=>t});const i=JSON.parse('{"id":"redis/lua-scripting","title":"Lua \u811a\u672c","description":"Lua \u811a\u672c\u662f Redis \u7684\u5f3a\u5927\u529f\u80fd\uff0c\u5141\u8bb8\u5728\u670d\u52a1\u5668\u7aef\u539f\u5b50\u6027\u6267\u884c\u590d\u6742\u903b\u8f91\u3002","source":"@site/docs/redis/lua-scripting.md","sourceDirName":"redis","slug":"/redis/lua-scripting","permalink":"/docs/redis/lua-scripting","draft":false,"unlisted":false,"editUrl":"https://github.com/to-lib/to-lib.github.io/tree/main/docs/redis/lua-scripting.md","tags":[],"version":"current","sidebarPosition":14,"frontMatter":{"sidebar_position":14,"title":"Lua \u811a\u672c"},"sidebar":"redis","previous":{"title":"\u7ba1\u9053\u548c\u6279\u91cf\u64cd\u4f5c","permalink":"/docs/redis/pipeline"},"next":{"title":"\u5730\u7406\u4f4d\u7f6e","permalink":"/docs/redis/geo"}}');var r=l(22714),s=l(48885);const d={sidebar_position:14,title:"Lua \u811a\u672c"},c="Redis Lua \u811a\u672c",a={},t=[{value:"\u4e3a\u4ec0\u4e48\u4f7f\u7528 Lua \u811a\u672c",id:"\u4e3a\u4ec0\u4e48\u4f7f\u7528-lua-\u811a\u672c",level:2},{value:"\u4f18\u52bf",id:"\u4f18\u52bf",level:3},{value:"\u9002\u7528\u573a\u666f",id:"\u9002\u7528\u573a\u666f",level:3},{value:"\u57fa\u672c\u8bed\u6cd5",id:"\u57fa\u672c\u8bed\u6cd5",level:2},{value:"EVAL \u547d\u4ee4",id:"eval-\u547d\u4ee4",level:3},{value:"EVALSHA \u547d\u4ee4",id:"evalsha-\u547d\u4ee4",level:3},{value:"Redis Lua API",id:"redis-lua-api",level:2},{value:"redis.call()",id:"rediscall",level:3},{value:"redis.pcall()",id:"redispcall",level:3},{value:"\u8fd4\u56de\u503c",id:"\u8fd4\u56de\u503c",level:3},{value:"Lua \u57fa\u7840\u8bed\u6cd5",id:"lua-\u57fa\u7840\u8bed\u6cd5",level:2},{value:"\u53d8\u91cf\u548c\u6570\u636e\u7c7b\u578b",id:"\u53d8\u91cf\u548c\u6570\u636e\u7c7b\u578b",level:3},{value:"\u6761\u4ef6\u5224\u65ad",id:"\u6761\u4ef6\u5224\u65ad",level:3},{value:"\u5faa\u73af",id:"\u5faa\u73af",level:3},{value:"\u51fd\u6570",id:"\u51fd\u6570",level:3},{value:"\u5b57\u7b26\u4e32\u64cd\u4f5c",id:"\u5b57\u7b26\u4e32\u64cd\u4f5c",level:3},{value:"\u5b9e\u6218\u6848\u4f8b",id:"\u5b9e\u6218\u6848\u4f8b",level:2},{value:"1. \u5206\u5e03\u5f0f\u9501",id:"1-\u5206\u5e03\u5f0f\u9501",level:3},{value:"2. \u9650\u6d41\u5668\uff08\u6ed1\u52a8\u7a97\u53e3\uff09",id:"2-\u9650\u6d41\u5668\u6ed1\u52a8\u7a97\u53e3",level:3},{value:"3. \u5e93\u5b58\u6263\u51cf",id:"3-\u5e93\u5b58\u6263\u51cf",level:3},{value:"4. \u539f\u5b50\u6027\u8ba1\u6570\u5668\uff08\u5e26\u4e0a\u9650\uff09",id:"4-\u539f\u5b50\u6027\u8ba1\u6570\u5668\u5e26\u4e0a\u9650",level:3},{value:"5. \u5ef6\u8fdf\u961f\u5217\uff08\u53d6\u51fa\u5230\u671f\u4efb\u52a1\uff09",id:"5-\u5ef6\u8fdf\u961f\u5217\u53d6\u51fa\u5230\u671f\u4efb\u52a1",level:3},{value:"\u811a\u672c\u7ba1\u7406",id:"\u811a\u672c\u7ba1\u7406",level:2},{value:"\u811a\u672c\u52a0\u8f7d\u548c\u7f13\u5b58",id:"\u811a\u672c\u52a0\u8f7d\u548c\u7f13\u5b58",level:3},{value:"Java \u5c01\u88c5",id:"java-\u5c01\u88c5",level:3},{value:"\u8c03\u8bd5\u548c\u4f18\u5316",id:"\u8c03\u8bd5\u548c\u4f18\u5316",level:2},{value:"\u8c03\u8bd5\u811a\u672c",id:"\u8c03\u8bd5\u811a\u672c",level:3},{value:"\u6027\u80fd\u4f18\u5316",id:"\u6027\u80fd\u4f18\u5316",level:3},{value:"\u8d85\u65f6\u5904\u7406",id:"\u8d85\u65f6\u5904\u7406",level:3},{value:"\u6700\u4f73\u5b9e\u8df5",id:"\u6700\u4f73\u5b9e\u8df5",level:2},{value:"1. \u4f7f\u7528 KEYS \u548c ARGV",id:"1-\u4f7f\u7528-keys-\u548c-argv",level:3},{value:"2. \u5904\u7406 nil \u503c",id:"2-\u5904\u7406-nil-\u503c",level:3},{value:"3. \u7c7b\u578b\u8f6c\u6362",id:"3-\u7c7b\u578b\u8f6c\u6362",level:3},{value:"4. \u9519\u8bef\u5904\u7406",id:"4-\u9519\u8bef\u5904\u7406",level:3},{value:"5. \u96c6\u7fa4\u6a21\u5f0f\u6ce8\u610f\u4e8b\u9879",id:"5-\u96c6\u7fa4\u6a21\u5f0f\u6ce8\u610f\u4e8b\u9879",level:3},{value:"\u5e38\u89c1\u95ee\u9898",id:"\u5e38\u89c1\u95ee\u9898",level:2},{value:"Q: \u811a\u672c\u6267\u884c\u8d85\u65f6\u600e\u4e48\u529e\uff1f",id:"q-\u811a\u672c\u6267\u884c\u8d85\u65f6\u600e\u4e48\u529e",level:3},{value:"Q: \u811a\u672c\u548c\u4e8b\u52a1\u6709\u4ec0\u4e48\u533a\u522b\uff1f",id:"q-\u811a\u672c\u548c\u4e8b\u52a1\u6709\u4ec0\u4e48\u533a\u522b",level:3},{value:"Q: \u5982\u4f55\u5728\u96c6\u7fa4\u6a21\u5f0f\u4f7f\u7528\u811a\u672c\uff1f",id:"q-\u5982\u4f55\u5728\u96c6\u7fa4\u6a21\u5f0f\u4f7f\u7528\u811a\u672c",level:3},{value:"\u5c0f\u7ed3",id:"\u5c0f\u7ed3",level:2}];function h(n){const e={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,s.R)(),...n.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(e.header,{children:(0,r.jsx)(e.h1,{id:"redis-lua-\u811a\u672c",children:"Redis Lua \u811a\u672c"})}),"\n",(0,r.jsx)(e.p,{children:"Lua \u811a\u672c\u662f Redis \u7684\u5f3a\u5927\u529f\u80fd\uff0c\u5141\u8bb8\u5728\u670d\u52a1\u5668\u7aef\u539f\u5b50\u6027\u6267\u884c\u590d\u6742\u903b\u8f91\u3002"}),"\n",(0,r.jsx)(e.h2,{id:"\u4e3a\u4ec0\u4e48\u4f7f\u7528-lua-\u811a\u672c",children:"\u4e3a\u4ec0\u4e48\u4f7f\u7528 Lua \u811a\u672c"}),"\n",(0,r.jsx)(e.h3,{id:"\u4f18\u52bf",children:"\u4f18\u52bf"}),"\n",(0,r.jsxs)(e.ol,{children:["\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.strong,{children:"\u539f\u5b50\u6027"})," - \u811a\u672c\u6267\u884c\u671f\u95f4\u4e0d\u4f1a\u88ab\u5176\u4ed6\u547d\u4ee4\u6253\u65ad"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.strong,{children:"\u51cf\u5c11\u7f51\u7edc\u5f80\u8fd4"})," - \u4e00\u6b21\u53d1\u9001\uff0c\u670d\u52a1\u5668\u7aef\u6267\u884c"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.strong,{children:"\u590d\u6742\u903b\u8f91"})," - \u652f\u6301\u6761\u4ef6\u5224\u65ad\u3001\u5faa\u73af\u3001\u51fd\u6570"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.strong,{children:"\u53ef\u590d\u7528"})," - \u811a\u672c\u53ef\u7f13\u5b58\uff0c\u4f7f\u7528 SHA1 \u8c03\u7528"]}),"\n"]}),"\n",(0,r.jsx)(e.h3,{id:"\u9002\u7528\u573a\u666f",children:"\u9002\u7528\u573a\u666f"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u5206\u5e03\u5f0f\u9501"}),"\n",(0,r.jsx)(e.li,{children:"\u9650\u6d41\u5668"}),"\n",(0,r.jsx)(e.li,{children:"\u5e93\u5b58\u6263\u51cf"}),"\n",(0,r.jsx)(e.li,{children:"\u539f\u5b50\u6027\u8ba1\u6570\u5668"}),"\n",(0,r.jsx)(e.li,{children:"\u6761\u4ef6\u66f4\u65b0"}),"\n"]}),"\n",(0,r.jsx)(e.h2,{id:"\u57fa\u672c\u8bed\u6cd5",children:"\u57fa\u672c\u8bed\u6cd5"}),"\n",(0,r.jsx)(e.h3,{id:"eval-\u547d\u4ee4",children:"EVAL \u547d\u4ee4"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-bash",children:'# \u8bed\u6cd5\nEVAL script numkeys key [key ...] arg [arg ...]\n\n# \u793a\u4f8b\uff1a\u7b80\u5355\u811a\u672c\nEVAL "return \'Hello, Redis!\'" 0\n\n# \u5e26\u53c2\u6570\u7684\u811a\u672c\nEVAL "return {KEYS[1], KEYS[2], ARGV[1], ARGV[2]}" 2 key1 key2 arg1 arg2\n'})}),"\n",(0,r.jsx)(e.p,{children:"\u53c2\u6570\u8bf4\u660e\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"script"})," - Lua \u811a\u672c\u5185\u5bb9"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"numkeys"})," - \u952e\u7684\u6570\u91cf"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"key [key ...]"})," - \u952e\u5217\u8868\uff0c\u5728\u811a\u672c\u4e2d\u901a\u8fc7 ",(0,r.jsx)(e.code,{children:"KEYS[n]"})," \u8bbf\u95ee"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"arg [arg ...]"})," - \u53c2\u6570\u5217\u8868\uff0c\u5728\u811a\u672c\u4e2d\u901a\u8fc7 ",(0,r.jsx)(e.code,{children:"ARGV[n]"})," \u8bbf\u95ee"]}),"\n"]}),"\n",(0,r.jsx)(e.h3,{id:"evalsha-\u547d\u4ee4",children:"EVALSHA \u547d\u4ee4"}),"\n",(0,r.jsx)(e.p,{children:"\u4f7f\u7528\u811a\u672c\u7684 SHA1 \u54c8\u5e0c\u503c\u8c03\u7528\uff08\u6027\u80fd\u66f4\u597d\uff09\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-bash",children:'# 1. \u52a0\u8f7d\u811a\u672c\uff0c\u83b7\u53d6 SHA1\nSCRIPT LOAD "return \'Hello\'"\n# "6b1bf486c81ceb7edf3c093f4a7fc83b6cd2"\n\n# 2. \u4f7f\u7528 SHA1 \u6267\u884c\u811a\u672c\nEVALSHA "6b1bf486c81ceb7edf3c093f4a7fc83b6c" 0\n'})}),"\n",(0,r.jsx)(e.h2,{id:"redis-lua-api",children:"Redis Lua API"}),"\n",(0,r.jsx)(e.h3,{id:"rediscall",children:"redis.call()"}),"\n",(0,r.jsx)(e.p,{children:"\u6267\u884c Redis \u547d\u4ee4\uff0c\u9519\u8bef\u65f6\u629b\u51fa\u5f02\u5e38\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-lua",children:"local value = redis.call('GET', KEYS[1])\nredis.call('SET', KEYS[1], 'new_value')\nredis.call('INCR', KEYS[2])\n"})}),"\n",(0,r.jsx)(e.h3,{id:"redispcall",children:"redis.pcall()"}),"\n",(0,r.jsx)(e.p,{children:"\u6267\u884c Redis \u547d\u4ee4\uff0c\u9519\u8bef\u65f6\u8fd4\u56de\u9519\u8bef\u5bf9\u8c61\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-lua",children:"local result = redis.pcall('GET', KEYS[1])\nif result.err then\n    -- \u5904\u7406\u9519\u8bef\n    return result.err\nend\n"})}),"\n",(0,r.jsx)(e.h3,{id:"\u8fd4\u56de\u503c",children:"\u8fd4\u56de\u503c"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-lua",children:'-- \u8fd4\u56de\u5b57\u7b26\u4e32\nreturn "Hello"\n\n-- \u8fd4\u56de\u6570\u5b57\nreturn 42\n\n-- \u8fd4\u56de\u6570\u7ec4\uff08table\uff09\nreturn {1, 2, 3}\n\n-- \u8fd4\u56de\u591a\u4e2a\u503c\nreturn {KEYS[1], ARGV[1]}\n\n-- \u8fd4\u56de nil\nreturn nil\n-- \u6216\nreturn false\n'})}),"\n",(0,r.jsx)(e.h2,{id:"lua-\u57fa\u7840\u8bed\u6cd5",children:"Lua \u57fa\u7840\u8bed\u6cd5"}),"\n",(0,r.jsx)(e.h3,{id:"\u53d8\u91cf\u548c\u6570\u636e\u7c7b\u578b",children:"\u53d8\u91cf\u548c\u6570\u636e\u7c7b\u578b"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-lua",children:'-- \u53d8\u91cf\nlocal name = "Redis"\nlocal count = 10\nlocal flag = true\n\n-- \u8868\uff08\u6570\u7ec4/\u5b57\u5178\uff09\nlocal arr = {1, 2, 3}\nlocal dict = {name = "Redis", version = "7.0"}\n\n-- \u8bbf\u95ee\u8868\u5143\u7d20\nprint(arr[1])       -- 1\uff08Lua \u6570\u7ec4\u4ece 1 \u5f00\u59cb\uff09\nprint(dict.name)    -- Redis\nprint(dict["name"]) -- Redis\n'})}),"\n",(0,r.jsx)(e.h3,{id:"\u6761\u4ef6\u5224\u65ad",children:"\u6761\u4ef6\u5224\u65ad"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-lua",children:'local value = redis.call(\'GET\', KEYS[1])\n\nif value == false then\n    -- \u952e\u4e0d\u5b58\u5728\n    return nil\nelseif tonumber(value) > 100 then\n    -- \u503c\u5927\u4e8e 100\n    return "large"\nelse\n    -- \u5176\u4ed6\u60c5\u51b5\n    return "small"\nend\n'})}),"\n",(0,r.jsx)(e.h3,{id:"\u5faa\u73af",children:"\u5faa\u73af"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-lua",children:"-- for \u5faa\u73af\nfor i = 1, 10 do\n    redis.call('SET', 'key' .. i, i)\nend\n\n-- \u904d\u5386\u6570\u7ec4\nfor i, key in ipairs(KEYS) do\n    redis.call('DEL', key)\nend\n\n-- \u904d\u5386\u5b57\u5178\nlocal data = {a = 1, b = 2, c = 3}\nfor k, v in pairs(data) do\n    print(k, v)\nend\n\n-- while \u5faa\u73af\nlocal i = 1\nwhile i <= 10 do\n    redis.call('SET', 'key' .. i, i)\n    i = i + 1\nend\n"})}),"\n",(0,r.jsx)(e.h3,{id:"\u51fd\u6570",children:"\u51fd\u6570"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-lua",children:"-- \u5b9a\u4e49\u51fd\u6570\nlocal function add(a, b)\n    return a + b\nend\n\n-- \u8c03\u7528\u51fd\u6570\nlocal result = add(10, 20)\n"})}),"\n",(0,r.jsx)(e.h3,{id:"\u5b57\u7b26\u4e32\u64cd\u4f5c",children:"\u5b57\u7b26\u4e32\u64cd\u4f5c"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-lua",children:'-- \u62fc\u63a5\nlocal str = "Hello" .. " " .. "World"\n\n-- \u957f\u5ea6\nlocal len = #str\n\n-- \u8f6c\u6362\nlocal num = tonumber("42")\nlocal str = tostring(42)\n'})}),"\n",(0,r.jsx)(e.h2,{id:"\u5b9e\u6218\u6848\u4f8b",children:"\u5b9e\u6218\u6848\u4f8b"}),"\n",(0,r.jsx)(e.h3,{id:"1-\u5206\u5e03\u5f0f\u9501",children:"1. \u5206\u5e03\u5f0f\u9501"}),"\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.strong,{children:"\u83b7\u53d6\u9501"}),"\uff1a"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-lua",children:"-- lock.lua\n-- KEYS[1]: \u9501\u7684\u952e\u540d\n-- ARGV[1]: \u9501\u7684\u552f\u4e00\u6807\u8bc6\uff08UUID\uff09\n-- ARGV[2]: \u8fc7\u671f\u65f6\u95f4\uff08\u79d2\uff09\n\nif redis.call('SETNX', KEYS[1], ARGV[1]) == 1 then\n    redis.call('EXPIRE', KEYS[1], ARGV[2])\n    return 1\nelse\n    return 0\nend\n"})}),"\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.strong,{children:"\u91ca\u653e\u9501"}),"\uff08\u539f\u5b50\u6027\u5224\u65ad\uff09\uff1a"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-lua",children:"-- unlock.lua\n-- KEYS[1]: \u9501\u7684\u952e\u540d\n-- ARGV[1]: \u9501\u7684\u552f\u4e00\u6807\u8bc6\n\nif redis.call('GET', KEYS[1]) == ARGV[1] then\n    return redis.call('DEL', KEYS[1])\nelse\n    return 0\nend\n"})}),"\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.strong,{children:"Java \u8c03\u7528"}),"\uff1a"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'// \u83b7\u53d6\u9501\nString lockScript =\n    "if redis.call(\'SETNX\', KEYS[1], ARGV[1]) == 1 then " +\n    "    redis.call(\'EXPIRE\', KEYS[1], ARGV[2]) " +\n    "    return 1 " +\n    "else " +\n    "    return 0 " +\n    "end";\n\nString lockKey = "lock:resource:1001";\nString lockValue = UUID.randomUUID().toString();\nint expireSeconds = 30;\n\nLong result = (Long) jedis.eval(\n    lockScript,\n    Collections.singletonList(lockKey),\n    Arrays.asList(lockValue, String.valueOf(expireSeconds))\n);\n\nif (result == 1) {\n    try {\n        // \u83b7\u53d6\u9501\u6210\u529f\uff0c\u6267\u884c\u4e1a\u52a1\u903b\u8f91\n        doSomething();\n    } finally {\n        // \u91ca\u653e\u9501\n        String unlockScript =\n            "if redis.call(\'GET\', KEYS[1]) == ARGV[1] then " +\n            "    return redis.call(\'DEL\', KEYS[1]) " +\n            "else " +\n            "    return 0 " +\n            "end";\n\n        jedis.eval(unlockScript,\n            Collections.singletonList(lockKey),\n            Collections.singletonList(lockValue));\n    }\n}\n'})}),"\n",(0,r.jsx)(e.h3,{id:"2-\u9650\u6d41\u5668\u6ed1\u52a8\u7a97\u53e3",children:"2. \u9650\u6d41\u5668\uff08\u6ed1\u52a8\u7a97\u53e3\uff09"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-lua",children:"-- rate_limit.lua\n-- KEYS[1]: \u9650\u6d41\u952e\n-- ARGV[1]: \u7a97\u53e3\u5927\u5c0f\uff08\u79d2\uff09\n-- ARGV[2]: \u6700\u5927\u8bf7\u6c42\u6570\n-- ARGV[3]: \u5f53\u524d\u65f6\u95f4\u6233\uff08\u6beb\u79d2\uff09\n\nlocal key = KEYS[1]\nlocal window = tonumber(ARGV[1]) * 1000  -- \u8f6c\u4e3a\u6beb\u79d2\nlocal limit = tonumber(ARGV[2])\nlocal now = tonumber(ARGV[3])\n\n-- \u5220\u9664\u7a97\u53e3\u5916\u7684\u8bb0\u5f55\nredis.call('ZREMRANGEBYSCORE', key, 0, now - window)\n\n-- \u7edf\u8ba1\u5f53\u524d\u7a97\u53e3\u5185\u7684\u8bf7\u6c42\u6570\nlocal count = redis.call('ZCARD', key)\n\nif count < limit then\n    -- \u672a\u8d85\u8fc7\u9650\u5236\uff0c\u6dfb\u52a0\u5f53\u524d\u8bf7\u6c42\n    redis.call('ZADD', key, now, now)\n    redis.call('EXPIRE', key, ARGV[1])\n    return 1  -- \u5141\u8bb8\nelse\n    return 0  -- \u62d2\u7edd\nend\n"})}),"\n",(0,r.jsx)(e.h3,{id:"3-\u5e93\u5b58\u6263\u51cf",children:"3. \u5e93\u5b58\u6263\u51cf"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-lua",children:"-- deduct_stock.lua\n-- KEYS[1]: \u5e93\u5b58\u952e\n-- ARGV[1]: \u6263\u51cf\u6570\u91cf\n\nlocal stock = redis.call('GET', KEYS[1])\n\nif stock == false then\n    return -1  -- \u5e93\u5b58\u4e0d\u5b58\u5728\nend\n\nstock = tonumber(stock)\nlocal quantity = tonumber(ARGV[1])\n\nif stock < quantity then\n    return 0  -- \u5e93\u5b58\u4e0d\u8db3\nend\n\nredis.call('DECRBY', KEYS[1], quantity)\nreturn 1  -- \u6263\u51cf\u6210\u529f\n"})}),"\n",(0,r.jsx)(e.h3,{id:"4-\u539f\u5b50\u6027\u8ba1\u6570\u5668\u5e26\u4e0a\u9650",children:"4. \u539f\u5b50\u6027\u8ba1\u6570\u5668\uff08\u5e26\u4e0a\u9650\uff09"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-lua",children:"-- counter_with_limit.lua\n-- KEYS[1]: \u8ba1\u6570\u5668\u952e\n-- ARGV[1]: \u589e\u52a0\u503c\n-- ARGV[2]: \u4e0a\u9650\u503c\n\nlocal current = redis.call('GET', KEYS[1])\n\nif current == false then\n    current = 0\nelse\n    current = tonumber(current)\nend\n\nlocal increment = tonumber(ARGV[1])\nlocal limit = tonumber(ARGV[2])\n\nlocal new_value = current + increment\n\nif new_value > limit then\n    new_value = limit\nend\n\nredis.call('SET', KEYS[1], new_value)\nreturn new_value\n"})}),"\n",(0,r.jsx)(e.h3,{id:"5-\u5ef6\u8fdf\u961f\u5217\u53d6\u51fa\u5230\u671f\u4efb\u52a1",children:"5. \u5ef6\u8fdf\u961f\u5217\uff08\u53d6\u51fa\u5230\u671f\u4efb\u52a1\uff09"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-lua",children:"-- fetch_delayed_tasks.lua\n-- KEYS[1]: \u5ef6\u8fdf\u961f\u5217\u952e\n-- ARGV[1]: \u5f53\u524d\u65f6\u95f4\u6233\n-- ARGV[2]: \u6279\u91cf\u5927\u5c0f\n\nlocal key = KEYS[1]\nlocal now = tonumber(ARGV[1])\nlocal batch_size = tonumber(ARGV[2])\n\n-- \u83b7\u53d6\u5230\u671f\u7684\u4efb\u52a1\nlocal tasks = redis.call('ZRANGEBYSCORE', key, 0, now, 'LIMIT', 0, batch_size)\n\nif #tasks > 0 then\n    -- \u5220\u9664\u8fd9\u4e9b\u4efb\u52a1\n    redis.call('ZREM', key, unpack(tasks))\nend\n\nreturn tasks\n"})}),"\n",(0,r.jsx)(e.h2,{id:"\u811a\u672c\u7ba1\u7406",children:"\u811a\u672c\u7ba1\u7406"}),"\n",(0,r.jsx)(e.h3,{id:"\u811a\u672c\u52a0\u8f7d\u548c\u7f13\u5b58",children:"\u811a\u672c\u52a0\u8f7d\u548c\u7f13\u5b58"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-bash",children:'# \u52a0\u8f7d\u811a\u672c\u5230\u7f13\u5b58\nSCRIPT LOAD "return \'Hello\'"\n# \u8fd4\u56de SHA1: "6b1bf486c81ceb7edf3c093f4a7fc83b6cd2"\n\n# \u4f7f\u7528 SHA1 \u6267\u884c\nEVALSHA "6b1bf486c81ceb7edf3c093f4a7fc83b6cd2" 0\n\n# \u68c0\u67e5\u811a\u672c\u662f\u5426\u5b58\u5728\nSCRIPT EXISTS "6b1bf486c81ceb7edf3c093f4a7fc83b6cd2"\n\n# \u6e05\u7a7a\u811a\u672c\u7f13\u5b58\nSCRIPT FLUSH\n\n# \u6740\u6b7b\u6b63\u5728\u6267\u884c\u7684\u811a\u672c\uff08\u4ec5\u9650\u53ea\u8bfb\u811a\u672c\uff09\nSCRIPT KILL\n'})}),"\n",(0,r.jsx)(e.h3,{id:"java-\u5c01\u88c5",children:"Java \u5c01\u88c5"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'public class RedisScript {\n    private final Jedis jedis;\n    private final String sha;\n\n    public RedisScript(Jedis jedis, String script) {\n        this.jedis = jedis;\n        this.sha = jedis.scriptLoad(script);\n    }\n\n    public Object execute(List<String> keys, List<String> args) {\n        try {\n            return jedis.evalsha(sha, keys, args);\n        } catch (JedisNoScriptException e) {\n            // \u811a\u672c\u4e0d\u5b58\u5728\uff0c\u91cd\u65b0\u52a0\u8f7d\n            return jedis.eval(script, keys, args);\n        }\n    }\n}\n\n// \u4f7f\u7528\nRedisScript lockScript = new RedisScript(jedis,\n    "if redis.call(\'SETNX\', KEYS[1], ARGV[1]) == 1 then " +\n    "    redis.call(\'EXPIRE\', KEYS[1], ARGV[2]) " +\n    "    return 1 " +\n    "else return 0 end"\n);\n\nObject result = lockScript.execute(\n    Collections.singletonList("lock:key"),\n    Arrays.asList("uuid", "30")\n);\n'})}),"\n",(0,r.jsx)(e.h2,{id:"\u8c03\u8bd5\u548c\u4f18\u5316",children:"\u8c03\u8bd5\u548c\u4f18\u5316"}),"\n",(0,r.jsx)(e.h3,{id:"\u8c03\u8bd5\u811a\u672c",children:"\u8c03\u8bd5\u811a\u672c"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-bash",children:"# \u4f7f\u7528 redis.log() \u8f93\u51fa\u65e5\u5fd7\nEVAL \"redis.log(redis.LOG_WARNING, 'Debug: ' .. KEYS[1])\" 1 mykey\n\n# \u67e5\u770b Redis \u65e5\u5fd7\ntail -f /var/log/redis/redis.log\n"})}),"\n",(0,r.jsx)(e.h3,{id:"\u6027\u80fd\u4f18\u5316",children:"\u6027\u80fd\u4f18\u5316"}),"\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.strong,{children:"1. \u907f\u514d\u5927\u5faa\u73af"}),"\uff1a"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-lua",children:"-- \u274c \u4e0d\u597d\uff1a\u5faa\u73af 100 \u4e07\u6b21\nfor i = 1, 1000000 do\n    redis.call('SET', 'key' .. i, 'value')\nend\n\n-- \u2705 \u597d\uff1a\u5206\u6279\u5904\u7406\nfor i = 1, 1000 do\n    redis.call('SET', 'key' .. i, 'value')\nend\n"})}),"\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.strong,{children:"2. \u4f7f\u7528\u6279\u91cf\u547d\u4ee4"}),"\uff1a"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-lua",children:"-- \u274c \u4e0d\u597d\uff1a\u591a\u6b21\u8c03\u7528\nfor i, key in ipairs(KEYS) do\n    redis.call('DEL', key)\nend\n\n-- \u2705 \u597d\uff1a\u4e00\u6b21\u8c03\u7528\nredis.call('DEL', unpack(KEYS))\n"})}),"\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.strong,{children:"3. \u9884\u52a0\u8f7d\u811a\u672c"}),"\uff1a"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"// \u5e94\u7528\u542f\u52a8\u65f6\u52a0\u8f7d\nString sha = jedis.scriptLoad(script);\n\n// \u8fd0\u884c\u65f6\u4f7f\u7528 EVALSHA\njedis.evalsha(sha, keys, args);\n"})}),"\n",(0,r.jsx)(e.h3,{id:"\u8d85\u65f6\u5904\u7406",children:"\u8d85\u65f6\u5904\u7406"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-conf",children:"# redis.conf\n# Lua \u811a\u672c\u8d85\u65f6\u65f6\u95f4\uff08\u6beb\u79d2\uff09\nlua-time-limit 5000\n"})}),"\n",(0,r.jsx)(e.p,{children:"\u811a\u672c\u8d85\u65f6\u540e\uff1a"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\u53ea\u8bfb\u811a\u672c\u53ef\u88ab ",(0,r.jsx)(e.code,{children:"SCRIPT KILL"})," \u7ec8\u6b62"]}),"\n",(0,r.jsxs)(e.li,{children:["\u5199\u811a\u672c\u53ea\u80fd\u901a\u8fc7 ",(0,r.jsx)(e.code,{children:"SHUTDOWN NOSAVE"})," \u7ec8\u6b62"]}),"\n"]}),"\n",(0,r.jsx)(e.h2,{id:"\u6700\u4f73\u5b9e\u8df5",children:"\u6700\u4f73\u5b9e\u8df5"}),"\n",(0,r.jsx)(e.h3,{id:"1-\u4f7f\u7528-keys-\u548c-argv",children:"1. \u4f7f\u7528 KEYS \u548c ARGV"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-lua",children:"-- \u2705 \u597d\uff1a\u4f7f\u7528 KEYS \u548c ARGV\nlocal key = KEYS[1]\nlocal value = ARGV[1]\nredis.call('SET', key, value)\n\n-- \u274c \u4e0d\u597d\uff1a\u786c\u7f16\u7801\u952e\u540d\uff08\u5f71\u54cd\u96c6\u7fa4\u6a21\u5f0f\uff09\nredis.call('SET', 'fixed_key', 'value')\n"})}),"\n",(0,r.jsx)(e.h3,{id:"2-\u5904\u7406-nil-\u503c",children:"2. \u5904\u7406 nil \u503c"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-lua",children:"local value = redis.call('GET', KEYS[1])\n\n-- \u6ce8\u610f\uff1aGET \u8fd4\u56de nil \u65f6\uff0cLua \u4e2d\u662f false\nif value == false then\n    return nil\nend\n"})}),"\n",(0,r.jsx)(e.h3,{id:"3-\u7c7b\u578b\u8f6c\u6362",children:"3. \u7c7b\u578b\u8f6c\u6362"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-lua",children:"-- \u5b57\u7b26\u4e32\u8f6c\u6570\u5b57\nlocal num = tonumber(ARGV[1])\n\n-- \u6570\u5b57\u8f6c\u5b57\u7b26\u4e32\nlocal str = tostring(42)\n"})}),"\n",(0,r.jsx)(e.h3,{id:"4-\u9519\u8bef\u5904\u7406",children:"4. \u9519\u8bef\u5904\u7406"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-lua",children:"-- \u4f7f\u7528 pcall \u5b89\u5168\u8c03\u7528\nlocal ok, result = pcall(function()\n    return redis.call('INCR', KEYS[1])\nend)\n\nif not ok then\n    return {err = result}\nend\n\nreturn result\n"})}),"\n",(0,r.jsx)(e.h3,{id:"5-\u96c6\u7fa4\u6a21\u5f0f\u6ce8\u610f\u4e8b\u9879",children:"5. \u96c6\u7fa4\u6a21\u5f0f\u6ce8\u610f\u4e8b\u9879"}),"\n",(0,r.jsx)(e.p,{children:"\u5728 Redis Cluster \u4e2d\uff0c\u6240\u6709\u952e\u5fc5\u987b\u5728\u540c\u4e00\u4e2a\u69fd\u4f4d\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-lua",children:"-- \u2705 \u4f7f\u7528\u54c8\u5e0c\u6807\u7b7e\u786e\u4fdd\u540c\u4e00\u69fd\u4f4d\n-- KEYS: {user}:1001, {user}:1002\nredis.call('MGET', KEYS[1], KEYS[2])\n\n-- \u274c \u4e0d\u540c\u69fd\u4f4d\u4f1a\u62a5\u9519\n-- KEYS: user:1001, order:1001\nredis.call('MGET', KEYS[1], KEYS[2])  -- \u53ef\u80fd\u5931\u8d25\n"})}),"\n",(0,r.jsx)(e.h2,{id:"\u5e38\u89c1\u95ee\u9898",children:"\u5e38\u89c1\u95ee\u9898"}),"\n",(0,r.jsx)(e.h3,{id:"q-\u811a\u672c\u6267\u884c\u8d85\u65f6\u600e\u4e48\u529e",children:"Q: \u811a\u672c\u6267\u884c\u8d85\u65f6\u600e\u4e48\u529e\uff1f"}),"\n",(0,r.jsxs)(e.p,{children:["\u914d\u7f6e ",(0,r.jsx)(e.code,{children:"lua-time-limit"}),"\uff0c\u4f7f\u7528 ",(0,r.jsx)(e.code,{children:"SCRIPT KILL"})," \u7ec8\u6b62\u3002"]}),"\n",(0,r.jsx)(e.h3,{id:"q-\u811a\u672c\u548c\u4e8b\u52a1\u6709\u4ec0\u4e48\u533a\u522b",children:"Q: \u811a\u672c\u548c\u4e8b\u52a1\u6709\u4ec0\u4e48\u533a\u522b\uff1f"}),"\n",(0,r.jsxs)(e.table,{children:[(0,r.jsx)(e.thead,{children:(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.th,{children:"\u7279\u6027"}),(0,r.jsx)(e.th,{children:"\u811a\u672c"}),(0,r.jsx)(e.th,{children:"\u4e8b\u52a1"})]})}),(0,r.jsxs)(e.tbody,{children:[(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"\u539f\u5b50\u6027"}),(0,r.jsx)(e.td,{children:"\u2705"}),(0,r.jsx)(e.td,{children:"\u2705"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"\u6761\u4ef6\u5224\u65ad"}),(0,r.jsx)(e.td,{children:"\u2705"}),(0,r.jsx)(e.td,{children:"\u274c"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"\u56de\u6eda"}),(0,r.jsx)(e.td,{children:"\u274c"}),(0,r.jsx)(e.td,{children:"\u274c"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"\u6027\u80fd"}),(0,r.jsx)(e.td,{children:"\u2b50\u2b50\u2b50"}),(0,r.jsx)(e.td,{children:"\u2b50\u2b50"})]})]})]}),"\n",(0,r.jsx)(e.h3,{id:"q-\u5982\u4f55\u5728\u96c6\u7fa4\u6a21\u5f0f\u4f7f\u7528\u811a\u672c",children:"Q: \u5982\u4f55\u5728\u96c6\u7fa4\u6a21\u5f0f\u4f7f\u7528\u811a\u672c\uff1f"}),"\n",(0,r.jsxs)(e.p,{children:["\u786e\u4fdd\u6240\u6709 KEYS \u4f7f\u7528\u76f8\u540c\u7684\u54c8\u5e0c\u6807\u7b7e\uff1a",(0,r.jsx)(e.code,{children:"{tag}:key1"}),"\u3001",(0,r.jsx)(e.code,{children:"{tag}:key2"}),"\u3002"]}),"\n",(0,r.jsx)(e.h2,{id:"\u5c0f\u7ed3",children:"\u5c0f\u7ed3"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u2705 Lua \u811a\u672c\u4fdd\u8bc1\u539f\u5b50\u6027\uff0c\u9002\u5408\u590d\u6742\u903b\u8f91"}),"\n",(0,r.jsx)(e.li,{children:"\u2705 \u4f7f\u7528 EVALSHA \u63d0\u9ad8\u6027\u80fd"}),"\n",(0,r.jsx)(e.li,{children:"\u2705 \u901a\u8fc7 KEYS \u548c ARGV \u4f20\u9012\u53c2\u6570"}),"\n",(0,r.jsx)(e.li,{children:"\u2705 \u6ce8\u610f\u811a\u672c\u8d85\u65f6\u548c\u96c6\u7fa4\u6a21\u5f0f\u9650\u5236"}),"\n",(0,r.jsx)(e.li,{children:"\u2705 \u5e38\u89c1\u573a\u666f\uff1a\u5206\u5e03\u5f0f\u9501\u3001\u9650\u6d41\u3001\u5e93\u5b58\u6263\u51cf"}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"\u638c\u63e1 Lua \u811a\u672c\uff0c\u89e3\u9501 Redis \u7684\u5168\u90e8\u80fd\u529b\uff01"})]})}function u(n={}){const{wrapper:e}={...(0,s.R)(),...n.components};return e?(0,r.jsx)(e,{...n,children:(0,r.jsx)(h,{...n})}):h(n)}}}]);